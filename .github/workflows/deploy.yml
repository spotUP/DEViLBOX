name: Deploy to GitHub Pages & Custom Server

on:
  push:
    branches: ['main']
  workflow_dispatch:

permissions:
  contents: write
  pages: write
  id-token: write

concurrency:
  group: 'deploy'
  cancel-in-progress: true

jobs:
  # Build for GitHub Pages with /DEViLBOX/ base
  build-gh-pages:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build for GitHub Pages
        run: VITE_BASE_URL=/DEViLBOX/ npm run build

      - name: Setup Pages
        uses: actions/configure-pages@v4

      - name: Upload Pages artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: './dist'

  deploy-gh-pages:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: build-gh-pages
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

  # Build for custom server with / base
  build-server:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build for custom server
        run: npm run build

      - name: Upload server artifact
        uses: actions/upload-artifact@v4
        with:
          name: server-build
          path: dist/

  # Deploy to custom server via SSH
  deploy-server:
    runs-on: ubuntu-latest
    needs: build-server
    if: github.event_name == 'push' || github.event_name == 'workflow_dispatch'
    steps:
      - name: Download server artifact
        uses: actions/download-artifact@v4
        with:
          name: server-build
          path: dist/

      - name: Deploy to server via rsync
        uses: burnett01/rsync-deployments@6.0.0
        with:
          switches: -avzr --delete
          path: dist/
          remote_path: ${{ secrets.DEPLOY_PATH }}
          remote_host: ${{ secrets.DEPLOY_HOST }}
          remote_user: ${{ secrets.DEPLOY_USER }}
          remote_key: ${{ secrets.DEPLOY_KEY }}

  # Build Electron desktop apps for all platforms
  electron:
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: macos-latest
            platform: mac
          - os: ubuntu-latest
            platform: linux
          - os: windows-latest
            platform: win

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build web app
        run: npm run build

      - name: Build Electron App
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: npx electron-builder build --${{ matrix.platform }} --publish never

      - name: Upload Electron artifacts
        uses: actions/upload-artifact@v4
        with:
          name: electron-${{ matrix.platform }}
          path: |
            dist_electron/*.dmg
            dist_electron/*.zip
            dist_electron/*.exe
            dist_electron/*.AppImage
            dist_electron/*.deb
            dist_electron/*.tar.gz
          if-no-files-found: warn

  # Create a GitHub Release with all desktop app binaries
  release:
    needs: [electron, deploy]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Get version from package.json
        id: version
        run: echo "version=$(node -p 'require("./package.json").version')" >> $GITHUB_OUTPUT

      - name: Download all Electron artifacts
        uses: actions/download-artifact@v4
        with:
          path: release-assets
          pattern: electron-*
          merge-multiple: true

      - name: List release assets
        run: ls -la release-assets/ || echo "No assets found"

      - name: Delete existing latest release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: gh release delete latest --yes --cleanup-tag || true

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: latest
          name: "DEViLBOX v${{ steps.version.outputs.version }} (Latest Build)"
          body: |
            **Automatically built from the latest `main` branch.**

            This release is updated on every deploy. Download the installer for your platform below.

            | Platform | Files |
            |----------|-------|
            | Windows | `.exe` (installer) or `.zip` (portable) |
            | macOS | `.dmg` (disk image) or `.zip` |
            | Linux | `.AppImage`, `.deb`, or `.tar.gz` |

            ---
            Built from commit ${{ github.sha }}
          files: release-assets/*
          prerelease: false
          make_latest: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
