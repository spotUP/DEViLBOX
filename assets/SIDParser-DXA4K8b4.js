import{aU as n}from"./index-zx6LJBPK.js";import{C as t}from"./Cpu6502-B9laXm8V.js";import"./vendor-react-DkDaD07v.js";import"./vendor-utils-XMmR-oGw.js";import"./vendor-tone-CADp_hfL.js";import"./vendor-ui-uomqNFY-.js";function e(){return{note:0,instrument:0,volume:0,effTyp:0,eff:0,effTyp2:0,eff2:0}}function r(n,t,e){let r="";for(let o=0;o<e&&0!==n[t+o];o++)r+=String.fromCharCode(n[t+o]);return r.trim()}function o(n,t){return 2===(n>>t&3)?"FurnaceSID8580":"FurnaceSID6581"}function l(n,t=985248){if(0===n)return 0;const e=n*t/16777216;if(e<20||e>2e4)return 0;const r=Math.round(12*Math.log2(e/440)+69);return r>=1&&r<=96?r:0}function a(n){const t=new Uint8Array(n);return t.length>=4&&(80===t[0]&&83===t[1]&&73===t[2]&&68===t[3]||82===t[0]&&83===t[1]&&73===t[2]&&68===t[3])}async function i(i,s){if(!a(i))throw new Error("Not a valid SID file");const u=new Uint8Array(i),c=new DataView(i),m=c.getUint16(4,!1),h=c.getUint16(6,!1),f=c.getUint16(8,!1),g=c.getUint16(10,!1),p=c.getUint16(12,!1),d=r(u,22,32),y=r(u,54,32),w=m>=2&&u.length>119?c.getUint16(118,!1):0,A=m>=2&&u.length>120&&0!==u[120],S=m>=3&&u.length>121&&0!==u[121];let I=f;0===I&&u.length>h+1&&(I=u[h]|u[h+1]<<8);const U=o(w,2),$=A?o(w,6):U,v=[],D=1+(A?1:0)+(S?1:0);let M=1;for(let t=0;t<D;t++){const e=0===t?U:$,r=t>0?`SID${t+1}`:"SID";for(let t=1;t<=3;t++)v.push({id:M++,name:`${r} Voice ${t}`,type:"synth",synthType:e,furnace:{...n,chipType:3,ops:2},effects:[],volume:0,pan:0})}const j=v.length,P=0===f?h+2:h;let C;if(I>0&&g>0&&p>0)try{const n=function(n,e,r,o,a,i,s){const u=new Uint8Array(65536),c=n.subarray(a),m=Math.min(c.length,65536-e);u.set(c.subarray(0,m),e);const h=new Uint8Array(32),f=new t({read:n=>n>=54272&&n<54304?h[n-54272]:u[65535&n],write(n,t){u[65535&n]=t,n>=54272&&n<54304&&(h[n-54272]=t)}});f.reset(r),f.setA(0),f.callSubroutine(r);const g=[];for(let t=0;t<900;t++){f.callSubroutine(o);const n=new Array(i).fill(null);for(let t=0;t<Math.min(i,3);t++){const e=7*t,r=h[e+0],o=h[e+1],a=!!(1&h[e+4]),i=o<<8|r;n[t]=a&&i>0?l(i,s):null}g.push({notes:n})}return g}(u,I,g,p,P,j,985248);C=function(n,t,r){const o=Math.max(1,Math.ceil(n.length/256)),l=Math.min(256,Math.ceil(n.length/o)),a=Array.from({length:r},(n,r)=>({id:`ch${r}`,name:t[r]?.name||`SID ${r+1}`,muted:!1,solo:!1,collapsed:!1,volume:100,pan:0,instrumentId:null,color:null,rows:Array.from({length:l},e)})),i=new Array(r).fill(0);for(let e=0;e<l;e++){const t=n[Math.min(e*o,n.length-1)];for(let n=0;n<r&&n<t.notes.length;n++){const r=t.notes[n],o=a[n].rows[e];null!==r&&r!==i[n]?(o.note=r,o.instrument=n+1,i[n]=r):null===r&&i[n]>0&&(o.note=97,i[n]=0)}}return{id:"p0",name:"Pattern 1",length:l,channels:a}}(n,v,j)}catch{C={id:"p0",name:"Pattern 1",length:16,channels:Array.from({length:j},(n,t)=>({id:`ch${t}`,name:v[t]?.name||`SID ${t+1}`,muted:!1,solo:!1,collapsed:!1,volume:100,pan:0,instrumentId:null,color:null,rows:Array.from({length:16},e)}))}}else C={id:"p0",name:"Pattern 1",length:16,channels:Array.from({length:j},(n,t)=>({id:`ch${t}`,name:v[t]?.name||`SID ${t+1}`,muted:!1,solo:!1,collapsed:!1,volume:100,pan:0,instrumentId:null,color:null,rows:Array.from({length:16},e)}))};return{name:(d||s.replace(/\.sid$/i,""))+(y?` â€” ${y}`:""),format:"SID",patterns:[C],instruments:v,songPositions:[0],songLength:1,restartPosition:0,numChannels:j,initialSpeed:1,initialBPM:50}}export{a as isSIDFormat,i as parseSIDFile};
