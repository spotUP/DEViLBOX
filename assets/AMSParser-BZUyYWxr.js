function t(t,e){return t[e]??0}function e(t,e){return((t[e]??0)|(t[e+1]??0)<<8)>>>0}function n(t,e){return((t[e]??0)|(t[e+1]??0)<<8|(t[e+2]??0)<<16|(t[e+3]??0)<<24)>>>0}function r(t,e){const n=t[e]??0;return n<128?n:n-256}function o(t){return t<128?t:t-256}function s(t,e){if(e>=t.length)return{str:"",nextOff:e};const n=t[e]??0;let r="";for(let o=1;o<=n&&e+o<t.length;o++){const n=t[e+o]??0;0!==n&&(r+=String.fromCharCode(n))}return{str:r.trim(),nextOff:e+1+n}}function l(t,e,n,r,s,l,a,u,f,i,c,h,p){let m;if(s){const t=a*(r?2:1);m=0===t?new Uint8Array(0):function(t,e,n){const r=new Int8Array(n);let s=n;{let l=0,a=0;for(;l<t.length&&a<n;){const s=o(t[l++]);if(l<t.length&&s===o(e)){let s=t[l++];if(s=Math.min(s,n-a),l<t.length&&s>0){const e=o(t[l++]);for(let t=0;t<s;t++)r[a++]=e}else r[a++]=o(e)}else r[a++]=s}s=a}const l=new Uint8Array(n);{let t=128,e=0;for(let o=0;o<s;o++){const s=r[o];let a=0;for(let r=0;r<8;r++){let o=s&t&255;o=(65535&(o|o<<8))>>(a+8-r&7)&255,t=(65535&(t|t<<8))>>1&255,l[e]|=255&o,e++,e>=n&&(e=0,a++)}t=(65535&(t|t<<8))>>a&255}}{let t=0;for(let e=0;e<s;e++){let n=l[e];128!==n&&128&n&&(n=-(127&n)),t=t-n&255,l[e]=t}}return l}(n,l,t)}else m=n;const g=Math.min(127,h),d=g>0?g/127:0,y=d>0?20*Math.log10(d):-60;let M=0;if(0!==p&&(M=Math.round((p-128)/128*50)),0===m.length)return{id:t,name:e||`Sample ${t}`,type:"sample",synthType:"Sampler",effects:[],volume:y,pan:M};const S=i&&f>u;let v;v=r?function(t,e){const n=Math.floor(t.length/2),r=2*n,o=44+r,s=new ArrayBuffer(o),l=new DataView(s),a=(t,e)=>{for(let n=0;n<e.length;n++)l.setUint8(t+n,e.charCodeAt(n))};return a(0,"RIFF"),l.setUint32(4,o-8,!0),a(8,"WAVE"),a(12,"fmt "),l.setUint32(16,16,!0),l.setUint16(20,1,!0),l.setUint16(22,1,!0),l.setUint32(24,e,!0),l.setUint32(28,2*e,!0),l.setUint16(32,2,!0),l.setUint16(34,16,!0),a(36,"data"),l.setUint32(40,r,!0),new Uint8Array(s,44).set(t.subarray(0,2*n)),s}(m,c):function(t,e){const n=t.length,r=2*n,o=44+r,s=new ArrayBuffer(o),l=new DataView(s),a=(t,e)=>{for(let n=0;n<e.length;n++)l.setUint8(t+n,e.charCodeAt(n))};a(0,"RIFF"),l.setUint32(4,o-8,!0),a(8,"WAVE"),a(12,"fmt "),l.setUint32(16,16,!0),l.setUint16(20,1,!0),l.setUint16(22,1,!0),l.setUint32(24,e,!0),l.setUint32(28,2*e,!0),l.setUint16(32,2,!0),l.setUint16(34,16,!0),a(36,"data"),l.setUint32(40,r,!0);let u=44;for(let f=0;f<n;f++){const e=t[f]<128?t[f]:t[f]-256;l.setInt16(u,256*e,!0),u+=2}return s}(m,c);const T=function(t){const e=new Uint8Array(t);let n="";for(let r=0;r<e.length;r+=8192)n+=String.fromCharCode(...Array.from(e.subarray(r,Math.min(r+8192,e.length))));return`data:audio/wav;base64,${btoa(n)}`}(v),A=r?Math.floor(m.length/2):m.length,w=S?Math.min(f,A):A;return{id:t,name:e||`Sample ${t}`,type:"sample",synthType:"Sampler",effects:[],volume:y,pan:M,sample:{audioBuffer:v,url:T,baseNote:"C3",detune:0,loop:S,loopType:S?"forward":"off",loopStart:S?u:0,loopEnd:S?w:A,sampleRate:c,reverse:!1,playbackRate:1}}}function a(t,e){switch(t){case 0:return 0!==e?[0,e]:[0,0];case 1:return[1,e];case 2:return[2,e];case 3:return[3,e];case 4:return[4,e];case 5:return[5,e];case 6:return[6,e];case 7:return[7,e];case 8:return[8,17*(15&e)];case 9:return[9,e];case 10:return[10,e];case 11:return[11,e];case 12:return[12,Math.min(64,Math.floor((e+1)/2))];case 13:return[13,e];case 14:return 128===e?[0,0]:[14,e];case 15:return[15,e];default:return[0,0]}}function u(t,e){switch(t-16){case 0:return e<=1?[14,158|e]:[0,0];case 1:return[1,224|Math.min(15,e)];case 2:return[2,224|Math.min(15,e)];case 3:return[14,144|15&e];case 4:return[0,0];case 5:return[5,e];case 6:return[6,e];case 7:return[0,0];case 8:return[8,e];case 9:return[0,0];case 10:return[10,e];case 11:return[0,0];case 12:return[12,Math.min(64,Math.floor((e+1)/2))];case 13:return[13,e];case 14:{const t=15&e;switch(e>>4){case 1:return[1,240|Math.floor((t+1)/2)];case 2:return[2,240|Math.floor((t+1)/2)];case 10:return[10,Math.floor((t+1)/2)<<4|15];case 11:return[10,240|Math.floor((t+1)/2)];default:return[0,0]}}case 15:return[0,0];case 16:return[20,e];case 17:return[1,e];case 18:return[2,e];case 26:return[17,e];case 28:return[16,Math.min(64,Math.floor((e+1)/2))];default:return[0,0]}}function f(t,e,n,r){const o=()=>({note:0,instr:0,volume:0,effTyp:0,eff:0,effTyp2:0,eff2:0}),s=Array.from({length:e},()=>Array.from({length:n},o));let l=0;const f=()=>l<t.length?t[l++]??0:0,i=()=>l<t.length;for(let c=0;c<e;c++){const t=s[c];for(;i();){const e=f();if(255===e)break;const s=31&e,l=s<n?t[s]:o();let i=!0;if(!(64&e)){const t=f();i=!!(128&t);const e=127&t;1===e?l.note=97:r&&e>=2&&e<=121?l.note=e-2+1:!r&&e>=12&&e<=108&&(l.note=e+12+1),l.instr=f()}let c=!0;for(;i;){const t=f(),e=63&t;if(i=!!(128&t),64&t)l.volume=e+1;else{const t=f();let n=0,r=0;[n,r]=e<16?a(e,t):u(e,t),0===n&&0===r||(c?(l.effTyp=n,l.eff=r,c=!1):0===l.effTyp2&&(l.effTyp2=n,l.eff2=r))}}if(128&e)break}}return s}function i(t){const e=15&t;return 12.5*(e>7?e-16:e)}function c(t){if(t.length<8)return!1;if(69===t[0]&&120===t[1]&&116===t[2]&&114===t[3]&&101===t[4]&&109===t[5]&&101===t[6])return t.length>=9&&1===(t[8]??0);if(65===t[0]&&77===t[1]&&83===t[2]&&104===t[3]&&100===t[4]&&114===t[5]&&26===t[6]){if(t.length<8)return!1;const e=8+(t[7]??0);if(t.length<e+2)return!1;const n=t[e]??0;return 2===(t[e+1]??0)&&n<=2}return!1}function h(o,a){try{return c(o)?69===o[0]&&120===o[1]&&116===o[2]?function(r,o){if(r.length<18)return null;const a=t(r,7),u=t(r,8);if(1!==u)return null;const c=1+(31&t(r,9)),h=t(r,10),p=e(r,11),m=e(r,13);let g=18;if(g+=e(r,16),g>r.length)return null;const d=[],y=[];for(let s=0;s<h;s++){if(g+17>r.length)return null;const o=n(r,g),s=n(r,g+4),l=n(r,g+8),a=t(r,g+12),u=e(r,g+13),f=t(r,g+15),i=t(r,g+16),c=!!(3&i),h=!!(128&i)||!!(4&i);d.push({length:o,loopStart:s,loopEnd:l,panFinetune:a,sampleRate:u,volume:f,flags:i,packed:c,is16bit:h}),g+=17}const M=s(r,g),S=M.str||o.replace(/\.[^/.]+$/,"");g=M.nextOff;const v=[];for(let t=0;t<h;t++){const t=s(r,g);v.push(t.str),g=t.nextOff}for(let t=0;t<c;t++)g=s(r,g).nextOff;const T=[];for(let t=0;t<p;t++){const t=s(r,g);T.push(t.str),g=t.nextOff}if(g+2>r.length)return null;const A=e(r,g);if(g+=2,g+=A,g+2*m>r.length)return null;const w=[];for(let t=0;t<m;t++)w.push(e(r,g)),g+=2;const U=[];for(let t=0;t<p;t++){if(g+4>r.length){U.push(null);continue}const t=n(r,g);if(g+=4,g+t>r.length||0===t){g+=t,U.push(null);continue}const e=r.subarray(g,g+t);g+=t;const o=f(e,64,c,!1);U.push(o)}const $=[];for(let t=0;t<h;t++){const e=d[t],n=e.is16bit?2:1,o=e.length*n;let s=0;e.packed&&g<r.length&&(s=r[g++]??0),y.push(s),o>0&&g+o<=r.length?($.push(r.slice(g,g+o)),g+=o):($.push(null),o>0&&(g=Math.min(g+o,r.length)))}const b=[];for(let t=0;t<h;t++){const e=d[t],n=v[t]||`Sample ${t+1}`,r=$[t],o=y[t]??0;let s=e.sampleRate>0?2*e.sampleRate:16726;const a=i(15&e.panFinetune),u=240&e.panFinetune,f=e.loopStart<e.loopEnd,c=Math.min(e.loopStart,e.length),h=Math.min(e.loopEnd,e.length);if(!r||0===r.length||0===e.length){b.push({id:t+1,name:n,type:"sample",synthType:"Sampler",effects:[],volume:e.volume>0?20*Math.log10(e.volume/127):-60,pan:0!==u?Math.round((u-128)/128*50):0});continue}const p=l(t+1,n,r,e.is16bit,e.packed,o,e.length,c,h,f,s,e.volume,u);0!==a&&p.sample&&(p.sample.detune=a),b.push(p)}const x=[];for(let t=0;t<p;t++){const e=U[t],n=T[t]||`Pattern ${t}`,r=64,s=Array.from({length:c},(t,n)=>{const o=Array.from({length:r},(t,r)=>{const o=e?.[r],s=o?.[n];return s?{note:s.note,instrument:s.instr,volume:s.volume>0?s.volume-1:0,effTyp:s.effTyp,eff:s.eff,effTyp2:s.effTyp2,eff2:s.eff2}:{note:0,instrument:0,volume:0,effTyp:0,eff:0,effTyp2:0,eff2:0}});return{id:`channel-${n}`,name:`Channel ${n+1}`,muted:!1,solo:!1,collapsed:!1,volume:100,pan:0,instrumentId:null,color:null,rows:o}});x.push({id:`pattern-${t}`,name:n,length:r,channels:s,importMetadata:{sourceFormat:"AMS",sourceFile:o,importedAt:(new Date).toISOString(),originalChannelCount:c,originalPatternCount:p,originalInstrumentCount:h}})}return{name:S,format:"IT",patterns:x,instruments:b,songPositions:w,songLength:w.length,restartPosition:0,numChannels:c,initialSpeed:6,initialBPM:125,linearPeriods:!1,metadata:{tracker:`Extreme's Tracker ${u}.${a}`,format:"AMS"}}}(o,a):function(o,a){let u=7;const c=t(o,u++);let h="";for(let e=0;e<c;e++){const n=t(o,u+e);0!==n&&(h+=String.fromCharCode(n))}if(h=h.trim()||a.replace(/\.[^/.]+$/,""),u+=c,u+7>o.length)return null;const p=t(o,u++),m=t(o,u++);if(2!==m||p>2)return null;const g=t(o,u++),d=e(o,u);u+=2;const y=e(o,u);u+=2;let M=125,S=6,v=!1;if(p>=2){if(u+7>o.length)return null;const n=e(o,u);u+=2;const r=Math.max(8192,n);M=Math.max(32,r>>8),S=Math.max(1,t(o,u++)),u+=3;const s=e(o,u);u+=2,v=!!(64&s)}else{if(u+3>o.length)return null;M=Math.max(32,t(o,u++)),S=Math.max(1,t(o,u++)),v=!!(64&t(o,u++))}const T=[];let A=0;const w=[];for(let l=0;l<g&&!(u>=o.length);l++){const l=s(o,u);u=l.nextOff;const a=l.str;if(u>=o.length)break;const f=t(o,u++);if(0===f)continue;const i=new Array(120).fill(0);if(p>0){if(u+120>o.length)break;for(let e=0;e<120;e++)i[e]=t(o,u+e);u+=120}else{if(u+96>o.length)break;for(let e=0;e<96;e++)i[12+e]=t(o,u+e);u+=96}for(let e=0;e<3&&!(u+5>o.length);e++){const e=t(o,u+4);u+=5,u+=3*e}if(u+5>o.length)break;const c=t(o,u),h=e(o,u+1),m=e(o,u+3);u+=5;const g={shadowInstr:c,vibampFadeout:h,envFlags:m},d=[],y=[],M=A;for(let p=0;p<f;p++){const l=s(o,u);if(u=l.nextOff,d.push(l.str),u+20>o.length)break;const a=n(o,u),f=n(o,u+4),i=n(o,u+8),c=t(o,u+14),h=e(o,u+15),m=r(o,u+17),M=t(o,u+18),S=t(o,u+19),v=!!(3&S),T=!!(4&S),U=!!(8&S),$=!!(16&S),b=!!(64&S);u+=20,y.push({length:a,loopStart:f,loopEnd:i,panFinetune:c,c4speed:h,relativeTone:m,volume:M,flags:S,packed:v,is16bit:T,smpLoop:U,smpBidi:$,smpReverse:b});const x=255&g.shadowInstr|p<<8&32512|(v?32768:0);w.push(x),A++}T.push({name:a,numSamples:f,sampleAssign:i,instrInfo:g,sampleNames:d,sampleHdrs:y,firstSampleIdx:M})}const U=A;u=s(o,u).nextOff;for(let t=0;t<32&&!(u>=o.length);t++)u=s(o,u).nextOff;if(u+11>o.length);else{const t=n(o,u);if(u+=11,t>11){const e=t-11;u+=Math.min(e,o.length-u)}}if(u+2*y>o.length)return null;const $=[];for(let t=0;t<y;t++)$.push(e(o,u)),u+=2;const b=[],x=[],C=[];for(let e=0;e<d;e++){if(u+4>o.length){b.push(null),x.push(64),C.push(`Pattern ${e}`);continue}const r=n(o,u);if(u+=4,r<2||u+r>o.length){u+=Math.min(r,o.length-u),b.push(null),x.push(64),C.push(`Pattern ${e}`);continue}const l=u,a=t(o,u)+1;u++,u++,x.push(a);const i=s(o,u);C.push(i.str||`Pattern ${e}`),u=i.nextOff;const c=l+r,h=c-u;if(h<=0){b.push(null),u=c;continue}const p=o.subarray(u,u+h);u=c;const m=f(p,a,32,!0);b.push(m)}const I=new Array(U).fill(null),k=new Array(U).fill(0);for(let t=0;t<U;t++){if(255&(w[t]??0))continue;let e=null;for(const o of T){const n=t-o.firstSampleIdx;if(n>=0&&n<o.numSamples){e=o.sampleHdrs[n]??null;break}}if(!e)continue;const n=e.is16bit?2:1,r=e.length*n;let s=0;e.packed&&u<o.length&&(s=o[u++]??0),k[t]=s,r>0&&u+r<=o.length?(I[t]=o.slice(u,u+r),u+=r):r>0&&(u=Math.min(u+r,o.length))}for(let t=0;t<U;t++){const e=w[t]??0;let n=255&e;if(0===n)continue;if(n--,n>=T.length)continue;const r=e>>8&127,o=T[n].firstSampleIdx+r;o<U&&I[o]&&(I[t]=I[o],k[t]=k[o]??0)}const F=[];let P=1;for(const t of T){if(0===t.numSamples){F.push({id:P++,name:t.name||`Instrument ${P}`,type:"sample",synthType:"Sampler",effects:[],volume:-60,pan:0});continue}const e=t.firstSampleIdx,n=t.sampleHdrs[0],r=t.sampleNames[0]||t.name||`Sample ${e+1}`;if(!n){F.push({id:P++,name:t.name||`Instrument ${P}`,type:"sample",synthType:"Sampler",effects:[],volume:-60,pan:0});continue}const o=I[e];let s=n.c4speed>0?2*n.c4speed:16726;const a=i(15&n.panFinetune),u=100*n.relativeTone,f=240&n.panFinetune,c=n.smpLoop&&n.loopStart<n.loopEnd,h=Math.min(n.loopStart,n.length),p=Math.min(n.loopEnd,n.length),m=k[e]??0;if(!o||0===o.length||0===n.length){F.push({id:P,name:t.name||r,type:"sample",synthType:"Sampler",effects:[],volume:n.volume>0?20*Math.log10(n.volume/127):-60,pan:0!==f?Math.round((f-128)/128*50):0}),P++;continue}const g=l(P,t.name||r,o,n.is16bit,n.packed,m,n.length,h,p,c,s,n.volume,f),d=a+u;0!==d&&g.sample&&(g.sample.detune=d),F.push(g),P++}const O=[];for(let t=0;t<d;t++){const e=b[t],n=x[t]??64,r=C[t]??`Pattern ${t}`,o=Array.from({length:32},(t,r)=>{const o=Array.from({length:n},(t,n)=>{const o=e?.[n],s=o?.[r];return s?{note:s.note,instrument:s.instr,volume:s.volume>0?s.volume-1:0,effTyp:s.effTyp,eff:s.eff,effTyp2:s.effTyp2,eff2:s.eff2}:{note:0,instrument:0,volume:0,effTyp:0,eff:0,effTyp2:0,eff2:0}});return{id:`channel-${r}`,name:`Channel ${r+1}`,muted:!1,solo:!1,collapsed:!1,volume:100,pan:0,instrumentId:null,color:null,rows:o}});O.push({id:`pattern-${t}`,name:r,length:n,channels:o,importMetadata:{sourceFormat:"AMS",sourceFile:a,importedAt:(new Date).toISOString(),originalChannelCount:32,originalPatternCount:d,originalInstrumentCount:g}})}return{name:h,format:"IT",patterns:O,instruments:F,songPositions:$,songLength:$.length,restartPosition:0,numChannels:32,initialSpeed:S,initialBPM:M,linearPeriods:v,metadata:{tracker:`Velvet Studio ${m}.${String(p).padStart(2,"0")}`,format:"AMS"}}}(o,a):null}catch{return null}}export{c as isAMSFormat,h as parseAMSFile};
