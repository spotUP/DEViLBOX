import{aB as t}from"./index-zx6LJBPK.js";import"./vendor-react-DkDaD07v.js";import"./vendor-utils-XMmR-oGw.js";import"./vendor-tone-CADp_hfL.js";import"./vendor-ui-uomqNFY-.js";const n=32,e="RON_KLAREN_SOUNDMODULE!",r=[6848,6464,6096,5760,5424,5120,4832,4560,4304,4064,3840,3616,3424,3232,3048,2880,2712,2560,2416,2280,2152,2032,1920,1808,1712,1616,1524,1440,1356,1280,1208,1140,1076,1016,960,904,856,808,762,720,678,640,604,570,538,508,480,452,428,404,381,360,339,320,302,285,269,254,240,226,214,202,190,180,170,160,151,143,135,127];function o(t,n){return t[n]<<8|t[n+1]}function s(t,n){return(t[n]<<24|t[n+1]<<16|t[n+2]<<8|t[n+3])>>>0}function l(t,n){const e=s(t,n);return e>=2147483648?e-4294967296:e}function f(t,n){const e=o(t,n);return e>=32768?e-65536:e}function i(t){return t<128?t:t-256}function a(t){return Math.round(3546895/(2*t))}function u(t){if(t<0||t>=r.length)return 0;const n=t-36+37;return Math.max(1,Math.min(96,n))}function h(t){if(t.length<2624)return!1;if(1011!==s(t,0))return!1;let n="";for(let e=0;e<23;e++)n+=String.fromCharCode(t[40+e]);return n===e}function c(e,c){if(!h(e))return null;try{return function(e,h){const c=e.length,p=function(t){const e=t.length,r=Math.min(2624,e-n);if(r<64)return null;const o=t.subarray(n,n+r),s=o.length;let l=0;for(l=0;l+6<=s&&78===o[l]&&249===o[l+1];)l+=6;if(l>=s-6)return null;let f=0;for(;l+8<=s&&48===o[l]&&60===o[l+1];)f++,l+=8;if(0===f)return null;l=0;let i=0,a=0,u=0,h=0,c=!1;for(let n=0;n<2&&!c&&!(l+6>s||78!==o[l]||249!==o[l+1]);n++){const t=o[l+2]<<24|o[l+3]<<16|o[l+4]<<8|o[l+5];t<0||t>=s||(97===o[t]&&0===o[t+1]||51===o[t]&&252===o[t+1])&&(h=t,c=!0),l+=6}if(c){let t=h;for(;t+10<=s&&(78!==o[t]||117!==o[t+1]);){if(19===o[t]&&252===o[t+1]){const n=o[t+3],e=o[t+4]<<24|o[t+5]<<16|o[t+6]<<8|o[t+7];t+=6,e>>>0==12571648?i=n:e>>>0==12571904&&(a=n)}else if(35===o[t]&&252===o[t+1]){const n=o[t+2]<<24|o[t+3]<<16|o[t+4]<<8|o[t+5],e=o[t+6]<<24|o[t+7]<<16|o[t+8]<<8|o[t+9];t+=8,e>>>0==120&&(u=n)}t+=2}}else if(l=6,l+6<=s&&78===o[l]&&249===o[l+1]){const t=o[l+2]<<24|o[l+3]<<16|o[l+4]<<8|o[l+5];t>=0&&t<s&&65===o[t]&&250===o[t+1]&&(u=t,i=107,a=55)}const p=a<<8|i;for(l=u>=0&&u<s?u:0;l+2<=s&&(65!==o[l]||250!==o[l+1]);)l+=2;if(l+4>s)return null;let m=(o[l+2]<<8|o[l+3])+l+2;if(l+=4,m+n>=e)return null;let g=0;for(;l+12<=s&&(78!==o[l]||115!==o[l+1]&&117!==o[l+1]);){if(2===o[l]&&64===o[l+1]&&0===o[l+2]&&15===o[l+3]&&83===o[l+4]&&64===o[l+5]&&233===o[l+6]&&72===o[l+7]&&71===o[l+8]&&240===o[l+9]){g=m+(o[l+10]<<8|o[l+11])+n;break}l+=2}(0===g||g>=e)&&(g=96);let b=0,d=0;for(let S=0;S+4<=s;S+=2){if(12===o[S]&&18===o[S+1]&&0===o[S+2]){if(130===o[S+3])for(let t=S;t+4<=s;t+=2)if(73===o[t]&&250===o[t+1]){b=(o[t+2]<<8|o[t+3])+t+2+n;break}if(128===o[S+3])for(let t=S;t+4<=s;t+=2)if(73===o[t]&&250===o[t+1]){d=(o[t+2]<<8|o[t+3])+t+2+n;break}}if(0!==b&&0!==d)break}if(0===b||0===d)return null;if(b>=e||d>=e)return null;let y=!1;for(let n=0;n+10<=s;n+=2)if(12===o[n]&&18===o[n+1]&&0===o[n+2]&&129===o[n+3]&&n+10<=s&&66===o[n+8]&&104===o[n+9]){y=!0;break}return{numberOfSubSongs:f,ciaValue:p,subSongInfoOffset:g,instrumentOffset:b,arpeggioOffset:d,clearAdsrStateOnPortamento:y}}(e);if(!p)return null;const{numberOfSubSongs:m,ciaValue:g,subSongInfoOffset:b,instrumentOffset:d,arpeggioOffset:y}=p,S=[];for(let t=0;t<m;t++){const r=b+16*t;if(r+16>c)break;const o=[];for(let t=0;t<4;t++){const l=s(e,r+4*t)+n;if(l>=c)break;o.push(l)}if(o.length<4)break;S.push(o)}if(0===S.length)return null;const k=[];function I(t){const r=[];let s=t;for(;;){if(s+4>c)return null;const t=l(e,s);if(t<0)break;if(s+12>c)return null;const i=f(e,s+6),a=o(e,s+10),u=t+n;u>=0&&u<c&&r.push({trackNumber:u,transpose:i,repeatTimes:a}),s+=12}return r.length>0?r:null}for(let t=0;t<S.length;t++){const n=[];let e=!0;for(let r=0;r<4;r++){const o=I(S[t][r]);if(!o){e=!1;break}n.push(o)}e&&k.push({positions:n})}if(0===k.length)return null;const M=new Map,O=[];function v(t){if(M.has(t))return M.get(t);const n=O.length;M.set(t,n);const r=[];let o=t;for(;o<c;){const t=e[o];if(r.push(t),o++,255===t)break;if(t<128)o<c&&r.push(e[o++]);else if(128===t)o<c&&r.push(e[o++]);else if(129===t)for(let n=0;n<3&&o<c;n++)r.push(e[o++]);else 130===t?o<c&&r.push(e[o++]):131===t||133===t||132===t&&o<c&&r.push(e[o++]);if(131===t||133===t)break}return O.push(new Uint8Array(r)),n}for(const t of k)for(const n of t.positions)for(const t of n){const n=v(t.trackNumber);t.trackNumber=n}let N=0,x=0;for(const t of O)for(let n=0;n<t.length;n++){const e=t[n];130===e&&n+1<t.length?(N=Math.max(N,t[n+1]+1),n++):128===e&&n+1<t.length?(x=Math.max(x,t[n+1]+1),n++):e<128?n++:129===e?n+=3:132===e&&n++}for(let t=0;t<x;t++){const n=y+12*t;if(n+12>c)break;const r=new Int8Array(12);for(let t=0;t<12;t++)r[t]=i(e[n+t])}const C=[];for(let t=0;t<N;t++){const r=d+32*t;if(r+32>c)break;const o=l(e,r),s=l(e,r+4),f=e[r+8],a=e[r+9],u=e[r+10],h=e[r+11],p=e[r+12],m=e[r+13],g=[];for(let t=0;t<4;t++)g.push({point:e[r+14+t],increment:e[r+18+t]});const b=i(e[r+22]),y=i(e[r+23])<0,S=e[r+24],k=o+n,I=s+n;C.push({sampleOffset:k,vibratoOffset:h>0?I:-1,isSample:0!==f,phaseSpeed:a,phaseLengthInWords:u,vibratoSpeed:h,vibratoDepth:p,vibratoDelay:m,adsr:g,phaseValue:b,phaseDirection:y,phasePosition:S,sampleNumber:-1,vibratoNumber:-1})}const w=new Map,A=[],P=new Map;for(const t of C){const r=t.sampleOffset;if(!(r<0||r+8>c)){if(!w.has(r)){const t=l(e,r),s=o(e,r+4),f=o(e,r+6),a=t+n,u=A.length;if(w.set(r,u),A.push({sampleDataOffset:a,lengthInWords:s,phaseIndex:f}),!P.has(a)&&a>=0&&a+2*s<=c){const t=2*s,n=new Int8Array(t);for(let r=0;r<t;r++)n[r]=i(e[a+r]);P.set(a,n)}}t.sampleNumber=w.get(r)??-1}}const T=[];for(let n=0;n<C.length;n++){const e=C[n],o=n+1;if(e.sampleNumber<0||e.sampleNumber>=A.length){T.push({id:o,name:`Instrument ${n+1}`,type:"synth",synthType:"Synth",effects:[],volume:0,pan:0});continue}const s=A[e.sampleNumber],l=P.get(s.sampleDataOffset);if(l&&s.lengthInWords>0){const s=new Uint8Array(l.buffer),f=a(r[36]),i=(e.isSample,0),u=!e.isSample&&s.length>0?s.length:0;T.push(t(o,`Sample ${n+1}`,s,64,f,i,u))}else T.push({id:o,name:`Instrument ${n+1}`,type:"synth",synthType:"Synth",effects:[],volume:0,pan:0})}0!==T.length&&1===T[0].id||T.unshift({id:0,name:"Empty",type:"synth",synthType:"Synth",effects:[],volume:0,pan:0});function $(t,n,e){const o=[];let s=0,l=0,f=0;function i(t,n){o.push({noteIdx:t,instrNum:n})}for(;s<t.length&&o.length<n;){if(f>0){i(0,0),f--;continue}const n=t[s++];if(255===n)break;if(128!==n){if(129!==n)if(130!==n){if(131===n||133===n)break;if(132!==n){if(n<128){const o=n,a=s<t.length?t[s++]:0,u=Math.min(o+e,r.length-1),h=Math.max(0,u);0===a?i(h,l):(i(h,l),f=4*a-2,f<0&&(f=0));continue}}else s<t.length&&s++}else s<t.length&&(l=t[s++]);else if(s+2<t.length){const n=t[s];t[s+1];const o=t[s+2];s+=3;const a=Math.min(n+e,r.length-1);o>0&&(i(a,l),f=4*o-2,f<0&&(f=0))}}else s<t.length&&s++}for(;o.length<n;)o.push({noteIdx:0,instrNum:0});return o.slice(0,n)}const D=k[0],j=64,R=Math.max(...D.positions.map(t=>t.length)),F=[];for(let t=0;t<R;t++){const n=Array.from({length:4},()=>[]);for(let e=0;e<4;e++){const r=D.positions[e],o=t<r.length?r[t]:null;if(!o||o.trackNumber>=O.length){for(let t=0;t<j;t++)n[e].push({note:0,instrument:0,volume:0,effTyp:0,eff:0,effTyp2:0,eff2:0});continue}const s=$(O[o.trackNumber],j,o.transpose);for(const t of s){const r=0===t.noteIdx?0:u(t.noteIdx),o=t.instrNum;n[e].push({note:r,instrument:o,volume:0,effTyp:0,eff:0,effTyp2:0,eff2:0})}}F.push({id:`pattern-${t}`,name:`Position ${t}`,length:j,channels:n.map((t,n)=>({id:`channel-${n}`,name:`Channel ${n+1}`,muted:!1,solo:!1,collapsed:!1,volume:100,pan:[-50,50,50,-50][n]??0,instrumentId:null,color:null,rows:t})),importMetadata:{sourceFormat:"RK",sourceFile:h,importedAt:(new Date).toISOString(),originalChannelCount:4,originalPatternCount:O.length,originalInstrumentCount:C.length}})}0===F.length&&F.push({id:"pattern-0",name:"Pattern 0",length:j,channels:Array.from({length:4},(t,n)=>({id:`channel-${n}`,name:`Channel ${n+1}`,muted:!1,solo:!1,collapsed:!1,volume:100,pan:[-50,50,50,-50][n]??0,instrumentId:null,color:null,rows:Array.from({length:j},()=>({note:0,instrument:0,volume:0,effTyp:0,eff:0,effTyp2:0,eff2:0}))})),importMetadata:{sourceFormat:"RK",sourceFile:h,importedAt:(new Date).toISOString(),originalChannelCount:4,originalPatternCount:0,originalInstrumentCount:0}});const K=h.replace(/\.[^/.]+$/,""),L=g>0?Math.round(709379/g):125;return{name:K,format:"RK",patterns:F,instruments:T,songPositions:F.map((t,n)=>n),songLength:F.length,restartPosition:0,numChannels:4,initialSpeed:6,initialBPM:Math.max(32,Math.min(255,L)),linearPeriods:!1}}(e,c)}catch(p){return null}}export{h as isRonKlarenFormat,c as parseRonKlarenFile};
