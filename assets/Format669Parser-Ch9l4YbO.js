import{aB as e}from"./index-zx6LJBPK.js";import"./vendor-react-DkDaD07v.js";import"./vendor-utils-XMmR-oGw.js";import"./vendor-tone-CADp_hfL.js";import"./vendor-ui-uomqNFY-.js";function t(e,t){return e.getUint8(t)}function n(e,t){return e.getUint32(t,!0)}function r(e,t,n){const r=[];for(let f=0;f<n;f++){const n=e.getUint8(t+f);if(0===n)break;r.push(n)}return String.fromCharCode(...r).replace(/[\x00-\x1F]/g," ").trim()}const f=497,o=1536,s=[-60,60,60,-60,-60,60,60,-60];function i(e){if(e.byteLength<f)return!1;const n=new DataView(e),r=t(n,0),s=t(n,1);if(!(105===r&&102===s)&&!(74===r&&78===s))return!1;const i=t(n,110),a=t(n,111),l=t(n,112);if(i>64)return!1;if(a>128)return!1;if(l>=128)return!1;let u=0;for(let f=0;f<108;f++){const e=t(n,2+f);if(e>0&&e<=31&&++u>40)return!1}for(let f=0;f<128;f++){const e=t(n,113+f),r=t(n,241+f),o=t(n,369+f);if(e>=128&&e<254)return!1;if(e<128&&0===r)return!1;if(r>15)return!1;if(o>=64)return!1}const p=f+25*i+a*o;return!(e.byteLength<p)}function a(e,t){switch(e){case 0:return{effTyp:1,eff:t};case 1:return{effTyp:2,eff:t};case 2:return{effTyp:3,eff:t};case 3:return{effTyp:1,eff:240|t};case 4:return{effTyp:4,eff:t<<4|t};case 5:return{effTyp:15,eff:t};case 6:switch(t){case 0:return{effTyp:14,eff:4};case 1:return{effTyp:14,eff:20};default:return{effTyp:0,eff:0}}case 7:return{effTyp:14,eff:144|t};default:return{effTyp:0,eff:0}}}async function l(i,l){const u=new DataView(i),p=new Uint8Array(i),c=t(u,110),h=t(u,111),m=t(u,112),g=r(u,2,36),y=[];let d=f;for(let e=0;e<c;e++)y.push({filename:r(u,d,13),length:n(u,d+13),loopStart:n(u,d+17),loopEnd:n(u,d+21)}),d+=25;const T=[];for(let e=0;e<128;e++){const n=t(u,113+e);if(255===n||254===n)break;T.push(n)}0===T.length&&T.push(0);const w=[],S=[];for(let e=0;e<T.length;e++)w.push(t(u,241+e)),S.push(t(u,369+e));const b=f+25*c;function $(e,n,r,f){const p=b+e*o,m=new Uint8Array(8).fill(255),g=Array.from({length:8},()=>[]);for(let o=0;o<64;o++)for(let e=0;e<8;e++){const n=p+3*(8*o+e),s=n<i.byteLength?t(u,n):255,l=n+1<i.byteLength?t(u,n+1):0,c=n+2<i.byteLength?t(u,n+2):255;let h=0,y=0,d=0;if(s<254){y=(3&s)<<4|l>>4,h=(s>>2)+37,h<1&&(h=1),h>96&&(h=96),m[e]=255}if(s<=254){const e=15&l;d=Math.round((64*e+8)/15)}255!==c&&(m[e]=c);let T=0,w=0;if(255!==m[e]){const t=m[e]>>4,n=a(t,15&m[e]);T=n.effTyp,w=n.eff,6!==t&&(m[e]=255)}0===o&&0===e&&r>0&&15!==T&&(T=15,w=r),f<63&&o===f&&0===e&&0===T&&(T=13,w=0),g[e].push({note:h,instrument:s<254?y+1:0,volume:d,effTyp:T,eff:w,effTyp2:0,eff2:0})}const y=g.map((t,r)=>({id:`c${n}-p${e}-ch${r}`,name:`Channel ${r+1}`,muted:!1,solo:!1,collapsed:!1,volume:100,pan:s[r],instrumentId:null,color:null,rows:t}));return{id:`pattern-${n}-${e}`,name:`Pattern ${e}`,length:64,channels:y,importMetadata:{sourceFormat:"669",sourceFile:l,importedAt:(new Date).toISOString(),originalChannelCount:8,originalPatternCount:h,originalInstrumentCount:c}}}const v=[],C=[];for(let e=0;e<T.length;e++){const t=T[e],n=w[e]>0?w[e]:4,r=S[e];v.push($(t,e,n,r)),C.push(e)}const L=b+h*o,P=y.map((t,n)=>{const r=n+1,f=t.filename||`Sample ${r}`;if(0===t.length||t.length>=67108864)return{id:r,name:f,type:"sample",synthType:"Sampler",effects:[],volume:-60,pan:0};let o=L;for(let e=0;e<n;e++)o+=y[e].length;const s=o+t.length;if(s>i.byteLength)return{id:r,name:f,type:"sample",synthType:"Sampler",effects:[],volume:-60,pan:0};let a=0,l=0;t.loopEnd>t.length&&0===t.loopStart||0===t.loopEnd||(a=t.loopStart,l=Math.min(t.loopEnd,t.length));const u=p.subarray(o,s);return e(r,f,u,64,8363,a,l)}),j=m<T.length?m:0;return{name:g||l.replace(/\.[^/.]+$/,""),format:"MOD",patterns:v,instruments:P,songPositions:C,songLength:C.length,restartPosition:j,numChannels:8,initialSpeed:4,initialBPM:125,linearPeriods:!1}}export{i as is669Format,l as parse669File};
