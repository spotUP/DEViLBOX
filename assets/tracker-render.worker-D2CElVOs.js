!function(){"use strict";const t=Array.from(" !\"#$%&'()*+,-./0123456789:;<=>?@ABCDEFGHIJKLMNOPQRSTUVWXYZ[\\]^_`abcdefghijklmnopqrstuvwxyz{|}~");function e(t){const e=t.replace("#","");return 6===e.length?[parseInt(e.slice(0,2),16)/255,parseInt(e.slice(2,4),16)/255,parseInt(e.slice(4,6),16)/255,1]:8===e.length?[parseInt(e.slice(0,2),16)/255,parseInt(e.slice(2,4),16)/255,parseInt(e.slice(4,6),16)/255,parseInt(e.slice(6,8),16)/255]:[.9,.9,.9,1]}function n(t){if(t.startsWith("#"))return e(t);const n=t.match(/rgba?\((\d+),\s*(\d+),\s*(\d+)(?:,\s*([\d.]+))?\)/);return n?[parseInt(n[1])/255,parseInt(n[2])/255,parseInt(n[3])/255,void 0!==n[4]?parseFloat(n[4]):1]:[.5,.5,.5,1]}const r=10;function a(t,e,n){const r=t.createShader(e);if(!r)throw new Error("createShader failed");if(t.shaderSource(r,n),t.compileShader(r),!t.getShaderParameter(r,t.COMPILE_STATUS))throw new Error(`Shader compile error: ${t.getShaderInfoLog(r)}`);return r}function i(t,e,n){const r=t.createProgram();if(!r)throw new Error("createProgram failed");if(t.attachShader(r,a(t,t.VERTEX_SHADER,e)),t.attachShader(r,a(t,t.FRAGMENT_SHADER,n)),t.linkProgram(r),!t.getProgramParameter(r,t.LINK_STATUS))throw new Error(`Program link error: ${t.getProgramInfoLog(r)}`);return r}function s(t){if(0===t)return"---";if(97===t)return"OFF";const e=(t-1)%12,n=Math.floor((t-1)/12);return`${["C-","C#","D-","D#","E-","F-","F#","G-","G#","A-","A#","B-"][e]}${n}`}function o(t){return t.toString(16).toUpperCase().padStart(2,"0")}function l(t){return t.toString(10).padStart(2,"0")}const c=12;class h{gl;rectProg;glyphProg;rectResLoc;glyphResLoc;glyphAtlasLoc;rectVAO;rectCornerBuf;rectInstanceBuf;glyphVAO;glyphCornerBuf;glyphInstanceBuf;atlas=null;rectData;glyphData;rectCount=0;glyphCount=0;width=1;height=1;dpr=1;constructor(t){const e=t.getContext("webgl2",{antialias:!1,alpha:!0,premultipliedAlpha:!1,desynchronized:!0});if(!e)throw new Error("[TrackerGLRenderer] WebGL2 not supported");this.gl=e,this.rectProg=i(e,"#version 300 es\nlayout(location=0) in vec2 aCorner;   // unit quad corner: (0,0)..(1,1)\nlayout(location=1) in vec4 aRect;     // x, y, w, h  (per instance, logical px)\nlayout(location=2) in vec4 aColor;    // r, g, b, a  (per instance)\n\nuniform vec2 uResolution; // logical canvas size (CSS pixels)\n\nout vec4 vColor;\n\nvoid main() {\n  vec2 pixelPos = aCorner * aRect.zw + aRect.xy;\n  vec2 ndc = (pixelPos / uResolution) * 2.0 - 1.0;\n  gl_Position = vec4(ndc.x, -ndc.y, 0.0, 1.0);\n  vColor = aColor;\n}","#version 300 es\nprecision mediump float;\nin vec4 vColor;\nout vec4 fragColor;\n\nvoid main() {\n  fragColor = vColor;\n}"),this.glyphProg=i(e,"#version 300 es\nlayout(location=0) in vec2 aCorner;    // unit quad corner (0,0)..(1,1)\nlayout(location=1) in vec2 aPos;       // screen position (logical px, per instance)\nlayout(location=2) in vec2 aSize;      // glyph logical size (per instance)\nlayout(location=3) in vec4 aAtlasUV;  // u0,v0,u1,v1 (per instance)\nlayout(location=4) in vec4 aColor;    // r,g,b,a (per instance)\n\nuniform vec2 uResolution;\n\nout vec2 vUV;\nout vec4 vColor;\n\nvoid main() {\n  vec2 pixelPos = aPos + aCorner * aSize;\n  vec2 ndc = (pixelPos / uResolution) * 2.0 - 1.0;\n  gl_Position = vec4(ndc.x, -ndc.y, 0.0, 1.0);\n  vUV = aAtlasUV.xy + aCorner * (aAtlasUV.zw - aAtlasUV.xy);\n  vColor = aColor;\n}","#version 300 es\nprecision mediump float;\nin vec2 vUV;\nin vec4 vColor;\nuniform sampler2D uAtlas;\nout vec4 fragColor;\n\nvoid main() {\n  float a = texture(uAtlas, vUV).a; // white text on transparent background\n  fragColor = vec4(vColor.rgb, a * vColor.a);\n}"),this.rectResLoc=e.getUniformLocation(this.rectProg,"uResolution"),this.glyphResLoc=e.getUniformLocation(this.glyphProg,"uResolution"),this.glyphAtlasLoc=e.getUniformLocation(this.glyphProg,"uAtlas");const n=new Float32Array([0,0,1,0,0,1,1,0,1,1,0,1]);this.rectVAO=e.createVertexArray(),e.bindVertexArray(this.rectVAO),this.rectCornerBuf=e.createBuffer(),e.bindBuffer(e.ARRAY_BUFFER,this.rectCornerBuf),e.bufferData(e.ARRAY_BUFFER,n,e.STATIC_DRAW),e.enableVertexAttribArray(0),e.vertexAttribPointer(0,2,e.FLOAT,!1,0,0),this.rectInstanceBuf=e.createBuffer(),e.bindBuffer(e.ARRAY_BUFFER,this.rectInstanceBuf),this.rectData=new Float32Array(32768),e.bufferData(e.ARRAY_BUFFER,this.rectData.byteLength,e.DYNAMIC_DRAW);e.enableVertexAttribArray(1),e.vertexAttribPointer(1,4,e.FLOAT,!1,32,0),e.vertexAttribDivisor(1,1),e.enableVertexAttribArray(2),e.vertexAttribPointer(2,4,e.FLOAT,!1,32,16),e.vertexAttribDivisor(2,1),e.bindVertexArray(null),this.glyphVAO=e.createVertexArray(),e.bindVertexArray(this.glyphVAO),this.glyphCornerBuf=e.createBuffer(),e.bindBuffer(e.ARRAY_BUFFER,this.glyphCornerBuf),e.bufferData(e.ARRAY_BUFFER,n,e.STATIC_DRAW),e.enableVertexAttribArray(0),e.vertexAttribPointer(0,2,e.FLOAT,!1,0,0),this.glyphInstanceBuf=e.createBuffer(),e.bindBuffer(e.ARRAY_BUFFER,this.glyphInstanceBuf),this.glyphData=new Float32Array(786432),e.bufferData(e.ARRAY_BUFFER,this.glyphData.byteLength,e.DYNAMIC_DRAW);e.enableVertexAttribArray(1),e.vertexAttribPointer(1,2,e.FLOAT,!1,48,0),e.vertexAttribDivisor(1,1),e.enableVertexAttribArray(2),e.vertexAttribPointer(2,2,e.FLOAT,!1,48,8),e.vertexAttribDivisor(2,1),e.enableVertexAttribArray(3),e.vertexAttribPointer(3,4,e.FLOAT,!1,48,16),e.vertexAttribDivisor(3,1),e.enableVertexAttribArray(4),e.vertexAttribPointer(4,4,e.FLOAT,!1,48,32),e.vertexAttribDivisor(4,1),e.bindVertexArray(null),e.enable(e.BLEND),e.blendFuncSeparate(e.SRC_ALPHA,e.ONE_MINUS_SRC_ALPHA,e.ONE,e.ONE_MINUS_SRC_ALPHA),e.disable(e.DEPTH_TEST)}resize(t,e,n){this.width=t,this.height=e,this.dpr=n;const r=this.gl.canvas;r.width=Math.ceil(t*n),r.height=Math.ceil(e*n),this.gl.viewport(0,0,r.width,r.height),this.atlas&&this.atlas.dpr===n||this.buildAtlas()}buildAtlas(){const e=this.gl;this.atlas&&e.deleteTexture(this.atlas.texture),this.atlas=function(e,n,r,a,i){const s=r*i,o=Math.ceil(a*i),l=new OffscreenCanvas(64,o).getContext("2d");l.font=`${s}px ${n}`;const c=l.measureText("W"),h=Math.ceil(c.width),f=t.length,u=Math.ceil(f/16),g=16*h,d=u*o,p=new OffscreenCanvas(g,d).getContext("2d");p.clearRect(0,0,g,d),p.font=`${s}px ${n}`,p.textBaseline="middle",p.fillStyle="white";const y=new Map;t.forEach((t,e)=>{const n=e%16,r=Math.floor(e/16),a=n*h,s=r*o;p.fillText(t,a,s+o/2),y.set(t,{u0:a/g,v0:s/d,u1:(a+h)/g,v1:(s+o)/d,logicalWidth:h/i,logicalHeight:o/i})});const x=p.getImageData(0,0,g,d),b=e.createTexture();if(!b)throw new Error("[GlyphAtlas] Failed to create WebGL texture");return e.bindTexture(e.TEXTURE_2D,b),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,g,d,0,e.RGBA,e.UNSIGNED_BYTE,x.data),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.LINEAR),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.LINEAR),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),e.bindTexture(e.TEXTURE_2D,null),{texture:b,lookup:y,glyphLogicalWidth:h/i,glyphLogicalHeight:o/i,atlasPixelWidth:g,atlasPixelHeight:d,dpr:i}}(e,'"JetBrains Mono", "Fira Code", monospace',14,24,this.dpr)}render(t){this.atlas||this.buildAtlas();const a=this.atlas,i=this.gl;this.rectCount=0,this.glyphCount=0;const{patterns:c,currentPatternIndex:h,scrollX:f,cursor:u,selection:g,playback:d,theme:p,ui:y,layout:x,dragOver:b}=t,{isPlaying:A,row:m,smoothOffset:R,patternIndex:v}=d,T=A?v:h,I=c[T],{width:w,height:C}=this,{offsets:E,widths:D}=x,P={bg:e(p.bg),rowNormal:e(p.rowNormal),rowHighlight:e(p.rowHighlight),centerLine:n(p.accentGlow),cursor:e(p.accent),cursorSecondary:e(p.accentSecondary),text:e(p.textNote),textMuted:e(p.textMuted),textNote:e(p.textNote),textNoteActive:e(p.textNoteActive),textInstrument:e(p.textInstrument),textVolume:e(p.textVolume),textEffect:e(p.textEffect),border:e(p.border),lineNumber:e(p.lineNumber),lineNumberHighlight:e(p.lineNumberHighlight),selection:n(p.selection),accent:e(p.accent),flagAccent:[.961,.62,.044,1],flagSlide:[.024,.714,.831,1],flagMute:[.98,.8,.082,1],flagHammer:[.133,.827,.933,1]},S=A?m:u.rowIndex,B=34,L=38+(48+(y.columnVisibility.flag1||y.columnVisibility.flag2?28:0)+(y.columnVisibility.probability?24:0)),M=y.rowHeight??24,_=Math.ceil(C/M)+2,F=Math.floor(_/2),k=S-F,V=k+_,U=Math.floor(C/2)-M/2,G=U-F*M-R;if(y.trackerVisualBg)i.clearColor(0,0,0,0);else{const[t,e,n,r]=P.bg;i.clearColor(t,e,n,r)}if(i.clear(i.COLOR_BUFFER_BIT),!I)return this.flushRects(),void this.flushGlyphs();const O=I.channels.length,N=g,H=N?Math.min(N.startChannel,N.endChannel):-1,X=N?Math.max(N.startChannel,N.endChannel):-1,W=N?Math.min(N.startRow,N.endRow):-1,Y=N?Math.max(N.startRow,N.endRow):-1;for(let n=0;n<O;n++){const t=E[n]-f,r=D[n];if(t+r<0||t>w)continue;const a=I.channels[n];if(n===u.channelIndex&&this.addRect(t,0,r,C,[1,1,1,.02]),a.color){const n=e(a.color);this.addRect(t,0,r,C,[n[0],n[1],n[2],.03])}}for(let e=k;e<V;e++){let t,n=!1,r=null;if(e<0||e>=I.length){if(!y.showGhostPatterns)continue;if(e<0){const n=A?T-1:h-1;if(r=n>=0?c[n]:c[c.length-1]??null,!r)continue;if(t=r.length+e,t<0||t>=r.length)continue}else{const n=A?T+1:h+1;if(r=n<c.length?c[n]:c[0]??null,!r)continue;if(t=e-I.length,t<0||t>=r.length)continue}n=!0}else t=e;const a=G+(e-k)*M;if(!(a+M<0||a>C)&&!y.trackerVisualBg){const e=t%(y.rowHighlightInterval??4)===0?P.rowHighlight:P.rowNormal,r=n?.35*e[3]:e[3];this.addRect(0,a,w,M,[e[0],e[1],e[2],r])}}{const[t,e,n,r]=P.centerLine,a=y.trackerVisualBg?.5*r:r;this.addRect(0,U,w,M,[t,e,n,a])}for(let n=0;n<O;n++){const t=E[n]-f,r=D[n];if(t+r<0||t>w)continue;const a=I.channels[n];if(this.addRect(t+r,0,1,C,P.border),a.color){const n=e(a.color),r=a.collapsed?4:2;this.addRect(t,0,r,C,[n[0],n[1],n[2],.4])}}this.flushRects();for(let n=k;n<V;n++){let t,r=!1,i=I;if(n<0||n>=I.length){if(!y.showGhostPatterns)continue;if(n<0){const e=A?T-1:h-1,r=e>=0?c[e]:c[c.length-1]??null;if(!r)continue;if(t=r.length+n,t<0||t>=r.length)continue;i=r}else{const e=A?T+1:h+1,r=e<c.length?c[e]:c[0]??null;if(!r)continue;if(t=n-I.length,t<0||t>=r.length)continue;i=r}r=!0}else t=n;const u=G+(n-k)*M;if(u+M<0||u>C)continue;const g=r?.35:1,d=y.rowHighlightInterval??4,p=t%d===0;let x;if(y.showBeatLabels){x=`${Math.floor(t/d)+1}.${t%d+1}`}else x=y.useHex?t.toString(16).toUpperCase().padStart(2,"0"):t.toString(10).padStart(2,"0");const m=p?P.lineNumberHighlight:P.lineNumber;this.addGlyphString(x,4,u+(M-a.glyphLogicalHeight)/2,a,[m[0],m[1],m[2],m[3]*g]);for(let n=0;n<O;n++){const c=E[n]-f,h=D[n];if(c+h<0||c>w)continue;const d=i.channels[n];if(!d)continue;const p=d.rows[t];if(!p)continue;const x=d.collapsed,m=c+Math.floor((h-(x?B:L))/2),R=u+(M-a.glyphLogicalHeight)/2;if(x){const t=s(p.note??0),e=0===p.note?P.textMuted:P.textNote;this.addGlyphString(t,m,R,a,[e[0],e[1],e[2],e[3]*g]);continue}const v=A&&!r&&t===S,T=p.note??0;if(!y.blankEmpty||0!==T){const t=0===T?P.textMuted:97===T?P.textEffect:v&&T>0?P.textNoteActive:P.textNote;this.addGlyphString(s(T),m,R,a,[t[0],t[1],t[2],t[3]*g])}let I=m+B+4;const C=d.effectCols??2,_=p.instrument??0;if(0!==_){const t=P.textInstrument;this.addGlyphString(o(_),I,R,a,[t[0],t[1],t[2],t[3]*g])}else if(!y.blankEmpty){const t=P.textMuted;this.addGlyphString("..",I,R,a,[t[0],t[1],t[2],t[3]*g])}I+=24;const F=p.volume??0;if(F>=16&&F<=80){const t=P.textVolume;this.addGlyphString(o(F),I,R,a,[t[0],t[1],t[2],t[3]*g])}else if(!y.blankEmpty){const t=P.textMuted;this.addGlyphString("..",I,R,a,[t[0],t[1],t[2],t[3]*g])}I+=24;for(let t=0;t<C;t++){let e=0,n=0;0===t?(e=p.effTyp??0,n=p.eff??0):1===t&&(e=p.effTyp2??0,n=p.eff2??0);if(0!==e||0!==n){const t=P.textEffect,r=e<10?e.toString():String.fromCharCode(55+e);this.addGlyphString(r+o(n),I,R,a,[t[0],t[1],t[2],t[3]*g])}else if(!y.blankEmpty){const t=P.textMuted;this.addGlyphString("...",I,R,a,[t[0],t[1],t[2],t[3]*g])}I+=34}if(void 0!==p.flag1||void 0!==p.flag2){const t=(t,e)=>{let n=".",r=P.textMuted;1===t?(n="A",r=P.flagAccent):2===t?(n="S",r=P.flagSlide):3===t?(n="M",r=P.flagMute):4===t&&(n="H",r=P.flagHammer),!t&&y.blankEmpty||this.addGlyphString(n,e,R,a,[r[0],r[1],r[2],r[3]*g])};t(p.flag1,I),I+=14,t(p.flag2,I),I+=14}if(void 0!==p.probability&&p.probability>0){const t=Math.min(99,Math.max(0,p.probability)),n=e(t>=75?"#4ade80":t>=50?"#facc15":t>=25?"#fb923c":"#f87171"),r=y.useHex?o(t):l(t);this.addGlyphString(r,I,R,a,[n[0],n[1],n[2],n[3]*g])}if(N&&!r&&n>=H&&n<=X&&t>=W&&t<=Y){const[t,e,n,r]=P.selection;this.addRect(c,u,h,M,[t,e,n,r])}if(b&&!r&&n===b.channelIndex&&t===b.rowIndex){const t=P.accent;this.addRect(c,u,h,M,[t[0],t[1],t[2],.4])}}}if(!I.channels[u.channelIndex]?.collapsed){const t=E[u.channelIndex]-f,e=D[u.channelIndex],n=t+Math.floor((e-L)/2),a=38,i=116,s=i+(void 0!==I.channels[u.channelIndex]?.rows[0]?.flag1||void 0!==I.channels[u.channelIndex]?.rows[0]?.flag2?28:0);let o=0,l=r;switch(u.columnType){case"note":o=0,l=B;break;case"instrument":o=a+u.digitIndex*r;break;case"volume":o=a+24+u.digitIndex*r;break;case"effTyp":default:o=a+40+8;break;case"effParam":o=a+40+8+r+u.digitIndex*r;break;case"effTyp2":o=a+70+12;break;case"effParam2":o=a+70+12+r+u.digitIndex*r;break;case"flag1":o=a+i;break;case"flag2":o=a+i+r+4;break;case"probability":o=a+s+u.digitIndex*r}const c=n+o,h=U;let g=P.cursor;A&&(g=P.cursorSecondary),this.addRect(c,h,l,M,g)}if(this.flushRects(),this.flushGlyphs(),!I.channels[u.channelIndex]?.collapsed){const t=E[u.channelIndex]-f,e=D[u.channelIndex],n=t+Math.floor((e-L)/2),i=38,c=116,h=c+(void 0!==I.channels[u.channelIndex]?.rows[0]?.flag1||void 0!==I.channels[u.channelIndex]?.rows[0]?.flag2?28:0);let g=0;switch(u.columnType){case"note":g=0;break;case"instrument":g=i+u.digitIndex*r;break;case"volume":g=i+20+4+u.digitIndex*r;break;case"effTyp":default:g=i+40+8;break;case"effParam":g=i+40+8+r+u.digitIndex*r;break;case"effTyp2":g=i+70+12;break;case"effParam2":g=i+70+12+r+u.digitIndex*r;break;case"flag1":g=i+c;break;case"flag2":g=i+c+r+4;break;case"probability":g=i+h+u.digitIndex*r}const d=A?S:u.rowIndex,p=I.channels[u.channelIndex]?.rows[d];if(p){const t=u.columnType,e=u.digitIndex;let r="";if("note"===t)r=s(p.note??0);else if("instrument"===t){r=(0===(p.instrument??0)?"..":o(p.instrument??0))[e]??"."}else if("volume"===t){const t=p.volume??0;r=(t>=16&&t<=80?o(t):"..")[e]??"."}else if("effTyp"===t){const t=p.effTyp??0,e=p.eff??0;r=0!==t||0!==e?t.toString(16).toUpperCase():"."}else if("effParam"===t){const t=p.effTyp??0,n=p.eff??0;r=(0!==t||0!==n?o(n):"..")[e]??"."}else if("effTyp2"===t){const t=p.effTyp2??0,e=p.eff2??0;r=0!==t||0!==e?t.toString(16).toUpperCase():"."}else if("effParam2"===t){const t=p.effTyp2??0,n=p.eff2??0;r=(0!==t||0!==n?o(n):"..")[e]??"."}else if("flag1"===t)r=1===p.flag1?"A":2===p.flag1?"S":".";else if("flag2"===t)r=1===p.flag2?"A":2===p.flag2?"S":".";else if("probability"===t){const t=p.probability??0;r=(t>0?y.useHex?o(t):l(t):"..")[e]??"."}const i=n+g,c=U+(M-a.glyphLogicalHeight)/2;this.addGlyphString(r,i,c,a,[1,1,1,1])}}this.flushGlyphs()}ensureRectCapacity(t){if(this.rectCount+t>this.rectData.length/8){const e=Math.max(this.rectData.length/8*2,this.rectCount+t),n=new Float32Array(8*e);n.set(this.rectData),this.rectData=n}}addRect(t,e,n,r,a){this.ensureRectCapacity(1);const i=8*this.rectCount;this.rectData[i+0]=t,this.rectData[i+1]=e,this.rectData[i+2]=n,this.rectData[i+3]=r,this.rectData[i+4]=a[0],this.rectData[i+5]=a[1],this.rectData[i+6]=a[2],this.rectData[i+7]=a[3],this.rectCount++}ensureGlyphCapacity(t){if(this.glyphCount+t>this.glyphData.length/c){const e=Math.max(this.glyphData.length/c*2,this.glyphCount+t),n=new Float32Array(e*c);n.set(this.glyphData),this.glyphData=n}}addGlyph(t,e,n,r){this.ensureGlyphCapacity(1);const a=this.glyphCount*c;this.glyphData[a+0]=t,this.glyphData[a+1]=e,this.glyphData[a+2]=n.logicalWidth,this.glyphData[a+3]=n.logicalHeight,this.glyphData[a+4]=n.u0,this.glyphData[a+5]=n.v0,this.glyphData[a+6]=n.u1,this.glyphData[a+7]=n.v1,this.glyphData[a+8]=r[0],this.glyphData[a+9]=r[1],this.glyphData[a+10]=r[2],this.glyphData[a+11]=r[3],this.glyphCount++}addGlyphString(t,e,n,r,a){let i=e;for(const s of t){const t=r.lookup.get(s);t?(this.addGlyph(i,n,t,a),i+=t.logicalWidth):i+=r.glyphLogicalWidth}}flushRects(){if(0===this.rectCount)return;const t=this.gl;t.useProgram(this.rectProg),t.uniform2f(this.rectResLoc,this.width,this.height),t.bindVertexArray(this.rectVAO),t.bindBuffer(t.ARRAY_BUFFER,this.rectInstanceBuf),t.bufferSubData(t.ARRAY_BUFFER,0,this.rectData,0,8*this.rectCount),t.drawArraysInstanced(t.TRIANGLES,0,6,this.rectCount),t.bindVertexArray(null),this.rectCount=0}flushGlyphs(){if(0===this.glyphCount||!this.atlas)return;const t=this.gl;t.useProgram(this.glyphProg),t.uniform2f(this.glyphResLoc,this.width,this.height),t.uniform1i(this.glyphAtlasLoc,0),t.activeTexture(t.TEXTURE0),t.bindTexture(t.TEXTURE_2D,this.atlas.texture),t.bindVertexArray(this.glyphVAO),t.bindBuffer(t.ARRAY_BUFFER,this.glyphInstanceBuf),t.bufferSubData(t.ARRAY_BUFFER,0,this.glyphData,0,this.glyphCount*c),t.drawArraysInstanced(t.TRIANGLES,0,6,this.glyphCount),t.bindVertexArray(null),t.bindTexture(t.TEXTURE_2D,null),this.glyphCount=0}dispose(){const t=this.gl;t.deleteProgram(this.rectProg),t.deleteProgram(this.glyphProg),t.deleteBuffer(this.rectCornerBuf),t.deleteBuffer(this.rectInstanceBuf),t.deleteBuffer(this.glyphCornerBuf),t.deleteBuffer(this.glyphInstanceBuf),t.deleteVertexArray(this.rectVAO),t.deleteVertexArray(this.glyphVAO),this.atlas&&t.deleteTexture(this.atlas.texture)}}let f=null,u=800,g=600,d=1,p=[],y=0,x=0,b={rowIndex:0,channelIndex:0,columnType:"note",digitIndex:0},A=null,m=null,R={useHex:!0,blankEmpty:!1,showGhostPatterns:!1,columnVisibility:{flag1:!1,flag2:!1,probability:!1},trackerVisualBg:!1,recordMode:!1,rowHeight:24,rowHighlightInterval:4,showBeatLabels:!1},v={offsets:[],widths:[],totalWidth:0},T={row:0,smoothOffset:0,patternIndex:0,isPlaying:!1},I=null;self.onmessage=t=>{const e=t.data;switch(e.type){case"init":{u=e.width,g=e.height,d=e.dpr,m=e.theme,R=e.uiState,p=e.patterns,y=e.currentPatternIndex,b=e.cursor,A=e.selection,v=e.channelLayout;try{f=new h(e.canvas),f.resize(u,g,d)}catch(n){return}!function(){const t=()=>{!function(){if(!f||!m)return;f.render({patterns:p,currentPatternIndex:y,scrollX:x,cursor:b,selection:A,playback:T,theme:m,ui:R,layout:v,dragOver:I})}(),requestAnimationFrame(t)};requestAnimationFrame(t)}();const t={type:"ready"};self.postMessage(t);break}case"patterns":p=e.patterns,y=e.currentPatternIndex;break;case"scroll":x=e.x;break;case"cursor":b=e.cursor;break;case"selection":A=e.selection;break;case"playback":T={row:e.row,smoothOffset:e.smoothOffset,patternIndex:e.patternIndex,isPlaying:e.isPlaying};break;case"resize":u=e.w,g=e.h,d=e.dpr,f?.resize(u,g,d);break;case"theme":m=e.theme;break;case"uiState":R=e.uiState;break;case"channelLayout":v=e.channelLayout;break;case"dragOver":I=e.cell;break;case"hitTest":{const t=function(t,e){const n=t+x,r=p[y];if(!r)return null;const a=Math.floor(g/2)-12,i=Math.floor((e-a)/24),s=(T.isPlaying?T.row:b.rowIndex)+i,o=Math.max(0,Math.min(s,r.length-1));let l=0,c=-1,h=!1;for(let g=0;g<v.offsets.length;g++){const t=v.offsets[g],e=v.widths[g];if(n>=t&&n<t+e){l=g,c=n-t-8,h=!0;break}}if(!h){if(!(n<40))return null;l=0,c=-1}const f=34;let u="note";if(c>=f+4){const t=c-(f+8),e=r.channels[l]?.rows[0];u=t<24?"instrument":t<48?"volume":t<82?"effTyp":t<116?"effTyp2":(void 0!==e?.flag1||void 0!==e?.flag2)&&t<144?t<130?"flag1":"flag2":"probability"}return{row:o,channel:l,columnType:u}}(e.relX,e.relY);if(t){const n={type:"hitTestResult",id:e.id,row:t.row,channel:t.channel,columnType:t.columnType};self.postMessage(n)}else{const t={type:"hitTestMiss",id:e.id};self.postMessage(t)}break}}}}();
