import{aB as e}from"./index-zx6LJBPK.js";import"./vendor-react-DkDaD07v.js";import"./vendor-utils-XMmR-oGw.js";import"./vendor-tone-CADp_hfL.js";import"./vendor-ui-uomqNFY-.js";function t(e,t,n){let o="";for(let a=0;a<n;a++){const n=e[t+a];if(0===n)break;o+=String.fromCharCode(n)}return o}function n(e,t){return e[t]}function o(e,t){const n=e[t];return n<128?n:n-256}function a(e,t){return e[t]<<8|e[t+1]}const r=[6848,6464,6080,5760,5440,5120,4832,4576,4320,4064,3840,3616,3424,3232,3040,2880,2720,2560,2416,2288,2160,2032,1920,1808,1712,1616,1520,1440,1360,1280,1208,1144,1080,1016,960,904,856,808,760,720,680,640,604,572,540,508,480,452,428,404,380,360,340,320,302,286,270,254,240,226,214,202,190,180,170,160,151,143,135,127,120,113,107,101,95,90,85,80,76,72,68,64,60,57],s=[856,808,762,720,678,640,604,570,538,508,480,453,428,404,381,360,339,320,302,285,269,254,240,226,214,202,190,180,170,160,151,143,135,127,120,113,107,101,95,90,85,80,76,72,68,64,60,57];function l(e,t){if(0===e)return 0;const n=e+t+35;if(n<0||n>=r.length)return 0;const o=r[n];if(o<=0)return 0;let a=0,l=1/0;for(let r=0;r<s.length;r++){const e=Math.abs(s[r]-o);e<l&&(l=e,a=r)}const i=a+13;return Math.max(1,Math.min(96,i))}async function i(r,s){const i=new Uint8Array(r);if(i.length<32)throw new Error("File too small to be a SoundMon module");const u=t(i,0,26),f=t(i,26,4);let m,h=0;if("BPSM"===f)m=1;else{const e=f.substring(0,3);if("V.2"===e)m=2;else{if("V.3"!==e)throw new Error(`Not a SoundMon file: id="${f}"`);m=3}h=n(i,29)}let d=30;const g=a(i,d);d+=2;const y=[];for(let e=0;e<15;e++){if(255===n(i,d)){d++;const e=n(i,d);d++;const t=a(i,d)<<1;d+=2;const o=n(i,d);d++;const r=n(i,d)<<6;d++;const s=a(i,d);d+=2;const l=n(i,d);d++;const c=n(i,d);d++;const p=n(i,d)<<6;d++;const u=n(i,d);d++;const f=a(i,d);let h,g,S,M,b,v,C;d+=2;let T,w=0,D=1,$=0,k=0,x=0,P=1,V=0,A=0;m<3?(d++,h=n(i,d),d++,g=n(i,d),d++,S=n(i,d),d++,M=n(i,d)<<6,d++,d++,b=a(i,d),d+=2,d++,v=n(i,d),d++,C=n(i,d),d++,D=1,P=1,T=n(i,d),d++,d+=6):(h=n(i,d),d++,g=n(i,d),d++,S=n(i,d),d++,M=n(i,d)<<6,d++,b=a(i,d),d+=2,v=n(i,d),d++,C=n(i,d),d++,w=n(i,d),d++,D=n(i,d),d++,$=n(i,d),d++,k=n(i,d),d++,x=n(i,d)<<6,d++,P=n(i,d),d++,V=n(i,d),d++,T=n(i,d),d++,A=a(i,d),d+=2),y.push({synth:!0,table:e,length:t,volume:T,adsrControl:o,adsrTable:r,adsrLen:s,adsrSpeed:l,lfoControl:c,lfoTable:p,lfoDepth:u,lfoLen:f,lfoDelay:h,lfoSpeed:g,egControl:S,egTable:M,egLen:b,egDelay:v,egSpeed:C,fxControl:w,fxSpeed:D,fxDelay:$,modControl:k,modTable:x,modLen:A,modDelay:V,modSpeed:P})}else{const e=t(i,d,24);d+=24;const n=a(i,d)<<1;d+=2;let o=0,r=2,s=0;n>0?(o=a(i,d)<<1,d+=2,r=a(i,d)<<1,d+=2,s=a(i,d),d+=2,o+r>=n&&(r=n-o)):(r=2,d+=6),y.push({synth:!1,name:e,length:n,loop:o,repeat:r,volume:s,pointer:-1})}}const S=4*g,M=[];let b=0;for(let e=0;e<S;e++){const e=a(i,d);d+=2;const t=o(i,d);d++;const n=o(i,d);d++,e>b&&(b=e),M.push({pattern:e,soundTranspose:t,transpose:n})}const v=16*b,C=[];for(let e=0;e<v;e++){const e=o(i,d);d++;const t=n(i,d);d++;const a=15&t,r=(240&t)>>4,s=o(i,d);d++,C.push({note:e,sample:r,effect:a,param:s})}const T=new Uint8Array(64*h);if(h>0){const e=Math.min(d+64*h,i.length);T.set(i.subarray(d,e)),d=e}for(let e=0;e<15;e++){const t=y[e];if(t.synth||0===t.length)continue;const n=t;n.pointer=d,d+=n.length}const w=[];for(let t=0;t<15;t++){const n=y[t],o=t+1;if(n.synth){const e=n,a=e.table<<6,r=64;let s;a+r<=T.length?s=T.slice(a,a+r):a<T.length&&(s=new Uint8Array(r),s.set(T.subarray(a)));const l=e.adsrTable,i=l<T.length?Math.abs(T[l]<128?T[l]:T[l]-256):e.volume,c=Math.max(0,Math.min(64,e.volume)),p=e.lfoControl>0&&e.lfoDepth>0,u={type:"synth",waveType:15&e.table,waveSpeed:0,arpTable:new Array(16).fill(0),arpSpeed:0,attackVolume:Math.min(64,Math.max(0,i)),decayVolume:Math.min(64,c),sustainVolume:c,releaseVolume:0,attackSpeed:Math.min(63,e.adsrSpeed>0?e.adsrSpeed:4),decaySpeed:4,sustainLength:0,releaseSpeed:4,vibratoDelay:p?e.lfoDelay:0,vibratoSpeed:p?Math.min(63,e.lfoSpeed):0,vibratoDepth:p?Math.min(63,e.lfoDepth):0,portamentoSpeed:0};w.push({id:o,name:`Synth ${t+1}`,type:"synth",synthType:"SoundMonSynth",soundMon:u,effects:[],volume:-6,pan:0})}else{const a=n;if(a.length>0&&a.pointer>=0&&a.pointer+a.length<=i.length){const n=i.slice(a.pointer,a.pointer+a.length),r=a.repeat>2,s=r?a.loop:0,l=r?a.loop+a.repeat:0;w.push(e(o,a.name||`Sample ${t+1}`,n,a.volume,8287,s,l))}else w.push(p(o,a.name||`Sample ${t+1}`))}}const D=[];for(let e=0;e<g;e++){const t=[[],[],[],[]];for(let n=0;n<16;n++)for(let o=0;o<4;o++){const a=M[4*e+o];if(!a||0===a.pattern){t[o].push(c());continue}const r=16*(a.pattern-1)+n;if(r<0||r>=C.length){t[o].push(c());continue}const s=C[r],i=s.note,p=s.effect,u=s.param;let f=0,h=0;if(0!==i){f=l(i,a.transpose);let e=s.sample;e>0&&(e+=a.soundTranspose,e>=1&&e<=15&&(h=e))}let d=0,g=0;const S=u<0?-u:u;switch(p){case 0:case 9:0!==u&&(d=0,g=255&u);break;case 1:break;case 2:d=15,g=255&S;break;case 3:d=14,g=u?1:0;break;case 4:d=1,g=255&S;break;case 5:d=2,g=255&S;break;case 6:if(3===m){d=4;g=Math.min(S>>4&15,15)<<4|Math.min(15&S,15)}break;case 7:3===m&&(d=11,g=255&S);break;case 8:u>0?(d=2,g=255&S):u<0&&(d=1,g=255&S)}let b=0;if(1===p){b=16+Math.max(0,Math.min(64,S))}else if(0!==i&&h>0&&h<=y.length){const e=y[h-1];b=16+Math.max(0,Math.min(64,e.volume))}t[o].push({note:f,instrument:h,volume:b,effTyp:d,eff:g,effTyp2:0,eff2:0})}D.push({id:`pattern-${e}`,name:`Pattern ${e}`,length:16,channels:t.map((e,t)=>({id:`channel-${t}`,name:`Channel ${t+1}`,muted:!1,solo:!1,collapsed:!1,volume:100,pan:0===t||3===t?-50:50,instrumentId:null,color:null,rows:e})),importMetadata:{sourceFormat:"MOD",sourceFile:s,importedAt:(new Date).toISOString(),originalChannelCount:4,originalPatternCount:b,originalInstrumentCount:15}})}0===D.length&&D.push(function(e){return{id:"pattern-0",name:"Pattern 0",length:16,channels:Array.from({length:4},(e,t)=>({id:`channel-${t}`,name:`Channel ${t+1}`,muted:!1,solo:!1,collapsed:!1,volume:100,pan:0===t||3===t?-50:50,instrumentId:null,color:null,rows:Array.from({length:16},()=>({note:0,instrument:0,volume:0,effTyp:0,eff:0,effTyp2:0,eff2:0}))})),importMetadata:{sourceFormat:"MOD",sourceFile:e,importedAt:(new Date).toISOString(),originalChannelCount:4,originalPatternCount:0,originalInstrumentCount:0}}}(s));return{name:`${u.trim()||s.replace(/\.[^/.]+$/,"")} [SoundMon ${1===m?"V1":2===m?"V2":"V3"}]`,format:"MOD",patterns:D,instruments:w,songPositions:D.map((e,t)=>t),songLength:D.length,restartPosition:0,numChannels:4,initialSpeed:6,initialBPM:125,linearPeriods:!1}}function c(){return{note:0,instrument:0,volume:0,effTyp:0,eff:0,effTyp2:0,eff2:0}}function p(e,t){return{id:e,name:t.replace(/\0/g,"").trim()||`Sample ${e}`,type:"synth",synthType:"Synth",effects:[],volume:-6,pan:0}}export{i as parseSoundMonFile};
