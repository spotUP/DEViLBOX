import{j as e}from"./index-zx6LJBPK.js";import{r}from"./vendor-utils-XMmR-oGw.js";import"./vendor-react-DkDaD07v.js";import"./vendor-tone-CADp_hfL.js";import"./vendor-ui-uomqNFY-.js";const t=0,n=1,a=2,s=3,o=4,i=5,c=6,l=7,u=8,m=9,d=10,f=11,p=12,v=13,h=14,b=15,x=16,w=17,L=18,y=19,g=20,k=21;function E(e){const r=e.performanceList?.entries??[],t=new Uint8Array(22+5*r.length);t[0]=e.volume,t[1]=e.waveLength,t[2]=e.envelope.aFrames,t[3]=e.envelope.aVolume,t[4]=e.envelope.dFrames,t[5]=e.envelope.dVolume,t[6]=e.envelope.sFrames,t[7]=e.envelope.rFrames,t[8]=e.envelope.rVolume,t[9]=e.vibratoDelay,t[10]=e.vibratoDepth,t[11]=e.vibratoSpeed,t[12]=e.squareLowerLimit,t[13]=e.squareUpperLimit,t[14]=e.squareSpeed,t[15]=e.filterLowerLimit,t[16]=e.filterUpperLimit,t[17]=e.filterSpeed,t[18]=e.performanceList?.speed??1,t[19]=r.length,t[20]=e.hardCutReleaseFrames,t[21]=e.hardCutRelease?1:0;for(let n=0;n<r.length;n++){const e=r[n],a=22+5*n;t[a]=e.note,t[a+1]=127&e.waveform|(e.fixed?1:0)<<7,t[a+2]=(15&e.fx[0])<<4|15&e.fx[1],t[a+3]=e.fxParam[0],t[a+4]=e.fxParam[1]}return t}const _=({config:_,onChange:C})=>{const N=r.useRef(_),H=r.useRef(null),V=r.useRef(null),j=r.useRef(null),[D,F]=r.useState(!1),[U,P]=r.useState(null);r.useEffect(()=>{N.current=_},[_]),r.useEffect(()=>{const e=H.current;if(!e||!D)return;const r=E(_),t=e._malloc(r.length);t&&(e.HEAPU8.set(r,t),e._insed_load_from_buffer(t,r.length),e._free(t))},[_,D]);const R=r.useRef(C);return r.useEffect(()=>{R.current=C},[C]),r.useEffect(()=>{let e=!1,r=null;return async function(){try{const _=document.createElement("canvas");_.id="canvas",_.width=800,_.height=480,_.style.width="800px",_.style.height="480px",_.style.display="none",_.tabIndex=0,j.current&&!e&&(j.current.appendChild(_),V.current=_);const C=await new Promise((e,r)=>{const t=document.createElement("script");t.src="/hively/HivelyInsEd.js",t.onload=()=>{const t=window.createHivelyInsEd;"function"==typeof t?e(t):r(new Error("createHivelyInsEd not found after script load"))},t.onerror=()=>r(new Error("Failed to load HivelyInsEd.js")),document.head.appendChild(t)});if(e)return;r=await C({canvas:_}),H.current=r,r.onParamChange=(e,r)=>{const E=function(e,r,E){const _={...e,envelope:{...e.envelope},performanceList:{...e.performanceList}};switch(r){case t:_.volume=E;break;case n:_.waveLength=E;break;case a:_.envelope.aFrames=E;break;case s:_.envelope.aVolume=E;break;case o:_.envelope.dFrames=E;break;case i:_.envelope.dVolume=E;break;case c:_.envelope.sFrames=E;break;case l:_.envelope.rFrames=E;break;case u:_.envelope.rVolume=E;break;case m:_.vibratoDelay=E;break;case d:_.vibratoDepth=E;break;case f:_.vibratoSpeed=E;break;case p:_.squareLowerLimit=E;break;case v:_.squareUpperLimit=E;break;case h:_.squareSpeed=E;break;case b:_.filterLowerLimit=E;break;case x:_.filterUpperLimit=E;break;case w:_.filterSpeed=E;break;case L:_.performanceList.speed=E;break;case y:break;case g:_.hardCutReleaseFrames=E;break;case k:_.hardCutRelease=0!==E}return _}(N.current,e,r);N.current=E,R.current(E)},r.onPlistChange=(e,r,t,n,a,s,o,i)=>{const c=function(e,r,t,n,a,s,o,i,c){const l=[...e.performanceList?.entries??[]];for(;l.length<=r;)l.push({note:0,waveform:0,fixed:!1,fx:[0,0],fxParam:[0,0]});return l[r]={note:t,waveform:n,fixed:0!==a,fx:[s,i],fxParam:[o,c]},{...e,performanceList:{...e.performanceList,entries:l}}}(N.current,e,r,t,n,a,s,o,i);N.current=c,R.current(c)},r.onPlistLengthChange=e=>{const r=[...N.current.performanceList?.entries??[]];for(;r.length>e;)r.pop();for(;r.length<e;)r.push({note:0,waveform:0,fixed:!1,fx:[0,0],fxParam:[0,0]});const t={...N.current,performanceList:{...N.current.performanceList,entries:r}};N.current=t,R.current(t)},r._insed_init(800,480);const D=E(N.current),U=r._malloc(D.length);U&&(r.HEAPU8.set(D,U),r._insed_load_from_buffer(U,D.length),r._free(U)),r._insed_start(),e||(_.style.display="block",F(!0))}catch(_){e||P(String(_))}}(),()=>{if(e=!0,r)try{r._insed_shutdown()}catch{}if(V.current&&j.current){try{j.current.removeChild(V.current)}catch{}V.current=null}H.current=null}},[]),e.jsxDEV("div",{className:"hively-hardware-container flex flex-col items-start",children:[e.jsxDEV("div",{ref:j,className:"relative bg-black overflow-auto",style:{maxWidth:"100%"},onClick:()=>V.current?.focus(),onMouseEnter:()=>V.current?.focus(),children:!D&&!U&&e.jsxDEV("div",{className:"flex items-center justify-center text-gray-400",style:{width:800,height:480},children:"Loading instrument editor..."},void 0,!1,{fileName:"/Users/spot/Code/DEViLBOX/src/components/instruments/hardware/HivelyHardware.tsx",lineNumber:336,columnNumber:11},void 0)},void 0,!1,{fileName:"/Users/spot/Code/DEViLBOX/src/components/instruments/hardware/HivelyHardware.tsx",lineNumber:328,columnNumber:7},void 0),U&&e.jsxDEV("div",{className:"text-red-400 text-sm mt-2 text-center self-center",children:["Failed to load hardware UI: ",U]},void 0,!0,{fileName:"/Users/spot/Code/DEViLBOX/src/components/instruments/hardware/HivelyHardware.tsx",lineNumber:345,columnNumber:9},void 0)]},void 0,!0,{fileName:"/Users/spot/Code/DEViLBOX/src/components/instruments/hardware/HivelyHardware.tsx",lineNumber:326,columnNumber:5},void 0)};export{_ as HivelyHardware};
