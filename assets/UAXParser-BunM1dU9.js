function n(n,t){return n.getUint8(t)}function t(n,t){return n.getUint32(t,!0)}const e=36,o=[193,131,42,158],r=Math.floor(858993459),l=Math.floor(4294967295/8),s=Math.floor(4294967295/4);function u(u){if(u.byteLength<e)return null;if(n(u,0)!==o[0]||n(u,1)!==o[1]||n(u,2)!==o[2]||n(u,3)!==o[3])return null;const a=function(n,t){return n.getUint16(t,!0)}(u,4),i=t(u,12),f=t(u,16),c=t(u,20),g=t(u,24),h=t(u,28),p=t(u,32);return f<e||g<e||p<e||0===i||i>r||0===c||c>l||0===h||h>s||f>4294967295-5*i||g>4294967295-8*c||p>4294967295-4*h?null:{packageVersion:a,nameCount:i,nameOffset:f,exportCount:c,exportOffset:g,importCount:h,importOffset:p}}function a(n,t){if(t>=n.length)return[0,t];const e=n[t++],o=!!(128&e);let r=63&e,l=6;if(64&e){let e=!0;for(;e&&l<32&&t<n.length;){const o=n[t++];e=!!(128&o),r|=(127&o)<<l,l+=7}}return[o?r<=2147483647?-r:-2147483648:r,t]}function i(n,t,e){if(e>=64){const[e,o]=a(n,t);if(t=o,e<=0){for(;t<n.length&&0!==n[t];)t++;return t<n.length&&t++,["",t+=4]}}const o=[];for(;t<n.length&&0!==n[t];){let e=n[t++];e>=65&&e<=90&&(e+=32),o.push(String.fromCharCode(e))}return t<n.length&&t++,t+=4,[o.join(""),t]}function f(n,t,o,r,l){const s=t,[u,i]=a(n,t);t=i;const f=~u>>>0,[,c]=a(n,t);if(t=c,o.packageVersion>=60)t+=4;else{const[,e]=a(n,t);t=e}const[g,h]=a(n,t);if((t=h)+4>n.length)return{sound:null,nextPos:t};t+=4;const[p,m]=a(n,t);t=m;const[d,C]=a(n,t),x=t=C;if(f>=r.length)return{sound:null,nextPos:x};const y=r[f];if(y<0||y>=l.length)return{sound:null,nextPos:x};if("sound"!==l[y])return{sound:null,nextPos:x};if(p<=0||d<=e)return{sound:null,nextPos:x};if(d>=n.length)return{sound:null,nextPos:x};let P=d;o.packageVersion<40&&(P+=8),o.packageVersion<60&&(P+=16);const[,b]=a(n,P);if(P=b,o.packageVersion>=120){const[,t]=a(n,P);P=t+8}else if(o.packageVersion>=100){P+=4;const[,t]=a(n,P);P=t+4}else if(o.packageVersion>=62){const[,t]=a(n,P);P=t+4}else{const[,t]=a(n,P);P=t}if(P>=n.length)return{sound:null,nextPos:x};const[U,V]=a(n,P);if(P=V,U<=0)return{sound:null,nextPos:x};if(P+U>n.length)return{sound:null,nextPos:x};const k=n.subarray(P,P+U);return{sound:{name:g>=0&&g<l.length?l[g]:`sound_${s}`,data:k},nextPos:x}}function c(n){if(n.length<e)return!1;const t=u(new DataView(n.buffer,n.byteOffset,n.byteLength));return!!t&&function(n,t,e){let o=t.nameOffset;const r=Math.min(t.nameCount,65536);for(let l=0;l<r&&o<n.length;l++){if(t.packageVersion>=64){const[t,e]=a(n,o);if(o=e,t<=0){for(;o<n.length&&0!==n[o];)o++;o<n.length&&o++,o+=4;continue}}let r=0,l=!0;for(;o<n.length&&0!==n[o];){let t=n[o++];t>=65&&t<=90&&(t+=32),r<e.length?String.fromCharCode(t)!==e[r]&&(l=!1):l=!1,r++}if(r!==e.length&&(l=!1),o<n.length&&o++,o+=4,l)return!0}return!1}(n,t,"sound")}function g(n,t){try{return function(n,t){if(!c(n))return null;const e=new DataView(n.buffer,n.byteOffset,n.byteLength),o=u(e);if(!o)return null;const r=function(n,t){const e=[];let o=t.nameOffset;const r=Math.min(t.nameCount,65536);for(let l=0;l<r&&o<n.length;l++){const[r,l]=i(n,o,t.packageVersion);e.push(r),o=l}return e}(n,o);if(0===r.length)return null;const l=function(n,t,e){const o=[];let r=t.importOffset;const l=Math.min(t.exportCount,s);for(let s=0;s<l&&r<n.length;s++){const[,l]=a(n,r),[,s]=a(n,l);let u=s;if(t.packageVersion>=60)u+=4;else{const[,t]=a(n,s);u=t}const[i,f]=a(n,u);r=f,i>=0&&i<e.length&&o.push(i)}return o}(n,o,r),g=[];let h=o.exportOffset;for(let s=0;s<o.exportCount&&h<n.length&&g.length<240;s++){const{sound:t,nextPos:e}=f(n,h,o,l,r);h=e,t&&t.data.length>0&&g.push(t)}if(0===g.length)return null;const p=g.map((n,t)=>function(n,t,e){let o;if(function(n){return!(n.length<12)&&82===n[0]&&73===n[1]&&70===n[2]&&70===n[3]&&87===n[8]&&65===n[9]&&86===n[10]&&69===n[11]}(e))o=e;else{const n=22050,t=e.length,r=t,l=44+r,s=new ArrayBuffer(l),u=new DataView(s),a=(n,t)=>{for(let e=0;e<t.length;e++)u.setUint8(n+e,t.charCodeAt(e))};a(0,"RIFF"),u.setUint32(4,l-8,!0),a(8,"WAVE"),a(12,"fmt "),u.setUint32(16,16,!0),u.setUint16(20,1,!0),u.setUint16(22,1,!0),u.setUint32(24,n,!0),u.setUint32(28,n,!0),u.setUint16(32,1,!0),u.setUint16(34,8,!0),a(36,"data"),u.setUint32(40,r,!0);const i=new Uint8Array(s);for(let o=0;o<t;o++)i[44+o]=e[o];o=i}let r="";for(let s=0;s<o.length;s+=8192)r+=String.fromCharCode(...Array.from(o.subarray(s,Math.min(s+8192,o.length))));const l=`data:audio/wav;base64,${btoa(r)}`;return{id:n,name:t||`Sound ${n}`,type:"sample",synthType:"Sampler",effects:[],volume:0,pan:0,sample:{audioBuffer:o.buffer,url:l,baseNote:"C3",detune:0,loop:!1,loopType:"off",loopStart:0,loopEnd:0,sampleRate:22050,reverse:!1,playbackRate:1}}}(t+1,n.name,n.data)),m=4,d=64,C=()=>({note:0,instrument:0,volume:0,effTyp:0,eff:0,effTyp2:0,eff2:0}),x=Array.from({length:m},(n,t)=>({id:`uax-ch${t}`,name:`Channel ${t+1}`,muted:!1,solo:!1,collapsed:!1,volume:100,pan:0,instrumentId:null,color:null,rows:Array.from({length:d},C)})),y={id:"uax-pattern-0",name:"Pattern 0",length:d,channels:x,importMetadata:{sourceFormat:"uax",sourceFile:t,importedAt:(new Date).toISOString(),originalChannelCount:m,originalPatternCount:1,originalInstrumentCount:g.length}},P=t.replace(/\.[^/.]+$/,"");return{name:P,format:"MOD",patterns:[y],instruments:p,songPositions:[0],songLength:1,restartPosition:0,numChannels:m,initialSpeed:6,initialBPM:125,linearPeriods:!1}}(n,t)}catch{return null}}export{c as isUAXFormat,g as parseUAXFile};
