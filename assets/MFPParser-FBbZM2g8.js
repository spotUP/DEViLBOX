import{aC as t,aD as n}from"./index-zx6LJBPK.js";import"./vendor-react-DkDaD07v.js";import"./vendor-utils-XMmR-oGw.js";import"./vendor-tone-CADp_hfL.js";import"./vendor-ui-uomqNFY-.js";function e(t,n){return t[n]}function o(t,n){const e=t[n];return e<128?e:e-256}function r(t,n){return t[n]<<8|t[n+1]}function l(t,n){if(n){const t=n.split("/").pop()??n;if(t.length<4||"."!==t[3])return!1}if(t.byteLength<384)return!1;const e=new Uint8Array(t);if(127!==e[249])return!1;for(let o=0;o<31;o++){const t=8*o,n=r(e,t);if(n>32767)return!1;if(240&e[t+2])return!1;if(e[t+3]>64)return!1;const l=r(e,t+4),i=r(e,t+6);if(l>n)return!1;if(l+i-1>n)return!1;if(n>0&&0===i)return!1}return e[248]===r(e,378)&&r(e,378)===r(e,380)}function i(e,o){const r=e[o],l=e[o+1],i=e[o+2],a=(15&r)<<8|l,s=240&r|i>>4,u=15&i,f=e[o+3],p=a>0?n(a):0;return{note:t(p),instrument:s,volume:0,effTyp:u,eff:f,effTyp2:0,eff2:0}}async function a(t,n){const l=new Uint8Array(t);if(l.length<384)throw new Error("File too small to be a Magnetic Fields Packer module");const a=[];for(let i=0;i<31;i++){const t=8*i,n=r(l,t),s=o(l,t+2)<<4,u=e(l,t+3),f=r(l,t+4),p=r(l,t+6);a.push({length:2*n,finetune:s,volume:u,loopStart:2*f,loopSize:2*p,hasLoop:p>1})}const u=e(l,248),f=[];for(let o=0;o<128;o++)f.push(e(l,250+o));const p=r(l,378);let m=382;const c=[];for(let e=0;e<p;e++){const t=[];for(let n=0;n<4;n++)t.push(r(l,m)),m+=2;c.push(t)}const h=m,d=[];for(let e=0;e<u;e++){const t=[[],[],[],[]];for(let n=0;n<4;n++){const o=h+(c[e]?.[n]??0),r=Math.min(o+1024,l.length),a=r>o?r-o:0,u=new Uint8Array(a);a>0&&u.set(l.subarray(o,o+a));for(let e=0;e<4;e++)for(let o=0;o<4;o++)for(let r=0;r<4;r++){const l=e,f=a>l?u[l]+o:0,p=a>f?u[f]+r:0,m=a>p?2*u[p]:0;a<=l||a<=f||a<=p||m+4>a?t[n].push(s()):t[n].push(i(u,m))}}d.push({id:`pattern-${e}`,name:`Pattern ${e}`,length:64,channels:t.map((t,n)=>({id:`channel-${n}`,name:`Channel ${n+1}`,muted:!1,solo:!1,collapsed:!1,volume:100,pan:0===n||3===n?-50:50,instrumentId:null,color:null,rows:t})),importMetadata:{sourceFormat:"MOD",sourceFile:n,importedAt:(new Date).toISOString(),originalChannelCount:4,originalPatternCount:u,originalInstrumentCount:31}})}0===d.length&&d.push(function(t){return{id:"pattern-0",name:"Pattern 0",length:64,channels:Array.from({length:4},(t,n)=>({id:"channel-"+n,name:"Channel "+(n+1),muted:!1,solo:!1,collapsed:!1,volume:100,pan:0===n||3===n?-50:50,instrumentId:null,color:null,rows:Array.from({length:64},()=>({note:0,instrument:0,volume:0,effTyp:0,eff:0,effTyp2:0,eff2:0}))})),importMetadata:{sourceFormat:"MFP",sourceFile:t,importedAt:(new Date).toISOString(),originalChannelCount:4,originalPatternCount:1,originalInstrumentCount:31}}}(n));const g=f.slice(0,u).map(t=>Math.min(t,d.length-1)),y=a.map((t,n)=>{const e=n+1;return{id:e,name:"Sample "+e,type:"synth",synthType:"Synth",effects:[],volume:t.volume>0?20*Math.log10(t.volume/64):-60,pan:0,metadata:{modPlayback:{usePeriodPlayback:!0,periodMultiplier:3546895,finetune:t.finetune,defaultVolume:t.volume},mfpSample:{lengthBytes:t.length,loopStart:t.loopStart,loopSize:t.loopSize,hasLoop:t.hasLoop}}}}),v=n.split("/").pop()??n;return{name:(v.replace(/\..*$/,"")||v)+" [Magnetic Fields Packer]",format:"MOD",patterns:d,instruments:y,songPositions:g,songLength:g.length,restartPosition:0,numChannels:4,initialSpeed:6,initialBPM:125,linearPeriods:!1}}function s(){return{note:0,instrument:0,volume:0,effTyp:0,eff:0,effTyp2:0,eff2:0}}export{l as isMFPFormat,a as parseMFPFile};
