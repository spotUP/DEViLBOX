import{aB as t}from"./index-zx6LJBPK.js";import"./vendor-react-DkDaD07v.js";import"./vendor-utils-XMmR-oGw.js";import"./vendor-tone-CADp_hfL.js";import"./vendor-ui-uomqNFY-.js";function e(t,e){return t.getUint8(e)}function n(t,e){return t.getUint16(e,!0)}function a(t,e){return t.getUint32(e,!0)}function r(t,e,n){let a="";for(let r=0;r<n;r++){const n=t.getUint8(e+r);if(0===n)break;a+=String.fromCharCode(n)}return a.trim()}const o=f("S","E","Q","U"),l=f("P","A","T","T"),i=f("S","M","P","I"),s=f("S","M","P","D");function f(t,e,n,a){return t.charCodeAt(0)|e.charCodeAt(0)<<8|n.charCodeAt(0)<<16|a.charCodeAt(0)<<24}const c=254;function h(t){if(t.length<66)return!1;if(68!==t[0]||68!==t[1]||77!==t[2]||70!==t[3])return!1;const e=t[4];return e>=1&&e<=10}function u(t,e){try{let n=function(){if(0===i){if(o>=t.length)throw new Error("eof");l=t[o++],i=8}return i--,l>>i&1},a=function(t){let e=0;for(let a=0;a<t;a++)e=e<<1|n();return e},r=function(){if(f>255)return;s[f].value=a(7);const t=0!==n(),e=0!==n(),o=c;f++,c=f,t?(s[o].left=c,r()):s[o].left=-1,c=f,e?(s[o].right=c,r()):s[o].right=-1},o=0,l=0,i=0;const s=Array.from({length:256},()=>({left:-1,right:-1,value:0}));let f=0,c=0;if(r(),s[0].left<0||s[0].right<0)return null;const h=new Uint8Array(e);let u=0,m=0;for(let t=0;t<e;t++){let e=0;const a=0!==n();do{if(e=n()?s[e].right:s[e].left,e>255)break;m=s[e].value}while(s[e].left>=0&&s[e].right>=0);a&&(m^=255),u=u+m&255,h[t]=u}return h}catch{return null}}function m(t,e){const n=t.length>>1,a=2*n,r=44+a,o=new ArrayBuffer(r),l=new DataView(o),i=(t,e)=>{for(let n=0;n<e.length;n++)l.setUint8(t+n,e.charCodeAt(n))};i(0,"RIFF"),l.setUint32(4,r-8,!0),i(8,"WAVE"),i(12,"fmt "),l.setUint32(16,16,!0),l.setUint16(20,1,!0),l.setUint16(22,1,!0),l.setUint32(24,e,!0),l.setUint32(28,2*e,!0),l.setUint16(32,2,!0),l.setUint16(34,16,!0),i(36,"data"),l.setUint32(40,a,!0);return new Uint8Array(o,44).set(t.subarray(0,2*n)),o}function p(t){const e=new Uint8Array(t);let n="";for(let a=0;a<e.length;a+=8192)n+=String.fromCharCode(...Array.from(e.subarray(a,Math.min(a+8192,e.length))));return`data:audio/wav;base64,${btoa(n)}`}function g(t,e,n,a){if(t&&0===a)return{speed:6,bpm:120};const r=t?Math.max(1,e*a*2):30*(n+1);let o=1,l=32;for(let i=255;i>=1;i--){const t=Math.floor(r*i/48);if(t>=32&&t<=255){o=i,l=t;break}}return l=Math.max(32,Math.min(255,l)),o=Math.max(1,o),{speed:o,bpm:l}}function b(t,e){const n=Math.floor(t*e/255);return Math.max(0,Math.min(15,n))}function d(t,e){const n=Math.max(1,t>>4)*e;return Math.max(1,Math.min(15,Math.floor(128/n)))<<4|Math.max(1,15&t)}function M(t,e){let n=t>>4,a=15&t;return n=Math.max(1,Math.min(15,Math.floor(n*e/15))),a=Math.max(1,Math.min(15,Math.floor(a*e/15))),n<<4|a}function k(t,e,n){return 0===t?0:t<=15&&n||e<2?240|t:Math.max(1,Math.floor(t/(e-1)))}function y(t,e,n){const a=(t=Math.max(1,Math.floor(t/4)))<15||e<2;return a||(t=Math.max(1,Math.floor((t+e-2)/(e-1)))),n?(a?15:0)|t<<4:(a?240:0)|15&t}const T=19;function w(t,a,r,o){const l=new DataView(t.buffer,t.byteOffset,t.byteLength);let i,s,f,h=0;if(a<3){if(t.length<9)return null;i=e(l,h),h+=1,h+=2,f=n(l,h),h+=2,h+=4,s=0}else{if(t.length<8)return null;i=e(l,h),h+=1,s=e(l,h),h+=1,f=n(l,h),h+=2,h+=4}a<6&&(s=0),f=Math.max(1,Math.min(f,256)),r.beat=s>>4;const u=Math.min(o-1,i),m=new Array(u+1).fill(0),p=Array.from({length:u+1},()=>Array.from({length:f},()=>({note:0,instrument:0,volume:0,effTyp:0,eff:0,effTyp2:0,eff2:0})));let w,P,B=r.realBPMmode,x=0;for(let n=0;n<f&&!(h>=t.length);n++){if(0===m[0]){if(h>=t.length)break;const n=e(l,h++);if(128&n){if(h>=t.length)break;m[0]=e(l,h++)}const a=63&n;let o=0;if(0!==a){if(h>=t.length)break;o=e(l,h++)}switch(a){case 1:r.realBPMmode=!1,r.tempoTicks=Math.max(1,o),r.tempoBPM=0,B=!0;break;case 2:0!==o&&(r.realBPMmode=!0,r.tempoBPM=o,0!==r.beat&&(r.tempoTicks=o*r.beat*15),B=!0);break;case 3:r.beat=o>>4,0!==r.beat?B=r.realBPMmode:r.realBPMmode=!1;break;case 4:x=o;break;case 5:break;case 6:if(o>0){"bpm"===(r.realBPMmode?"bpm":"ticks")?r.tempoBPM=Math.min(255,r.tempoBPM+o):r.tempoTicks=Math.min(255,r.tempoTicks+o),B=!0}break;case 7:if(o>0){"bpm"===(r.realBPMmode?"bpm":"ticks")?r.tempoBPM=Math.max(1,r.tempoBPM-o):r.tempoTicks=Math.max(1,r.tempoTicks-o),B=!0}}}else m[0]--;let a=0,o=0;if(B)if(r.realBPMmode&&0===r.beat)B=!1;else{const{speed:t,bpm:e}=g(r.realBPMmode,r.tempoBPM,r.tempoTicks,r.beat);a=t,o=e,r.internalTicks=Math.max(1,t),B=!1,0===n&&(w=t,P=e)}if(a>0||o>0){const t=p[0][n];a>0&&(t.effTyp=15,t.eff=a),o>0&&(t.effTyp2=15,t.eff2=o)}if(240&x){const t=p[0][n];0===t.effTyp&&(t.effTyp=T,t.eff=224|x>>4)}if(15&x){const t=Math.max(1,Math.min(15,Math.floor((15&x)*r.internalTicks/15))),e=p[0][n];0===e.effTyp2&&(e.effTyp2=T,e.eff2=96|t)}x=0;for(let i=1;i<=u;i++)if(0===m[i]){if(h>=t.length)break;const a=e(l,h++);if(128&a){if(h>=t.length)break;m[i]=e(l,h++)}const o=p[i][n],s=r.channelStates[i-1];let f=!0;if(64&a){if(h>=t.length)break;o.instrument=e(l,h++),0!==o.instrument&&(f=!1)}if(32&a){if(h>=t.length)break;const n=e(l,h++);n>=1&&n<=108?(o.note=Math.max(1,Math.min(120,n+24)),s.lastNote=o.note):n>=129&&n<=236?(s.noteBuffer=Math.max(1,Math.min(120,24+(127&n))),o.note=0):255===n&&(o.note=c)}0===o.note&&o.instrument>0&&(o.note=s.lastNote,o.instrument=0),o.note>=1&&o.note<=120&&(s.playDir=!1);let u=0,g=0,w=0,P=0,B=0,x=0,v=!1,A=0;if(16&a){if(h>=t.length)break;const n=e(l,h++);A=Math.floor((n+2)/4),v=!0}if(8&a){if(h+1>=t.length)break;const n=e(l,h++);switch(g=e(l,h++),n){case 1:o.note=c,u=0;break;case 2:o.note=253,u=0;break;case 3:o.note=s.lastNote,s.playDir=!1,u=0;break;case 4:{const t=b(g,r.internalTicks);t>0?(u=T,g=208|t):u=0,0===o.note&&(o.note=s.lastNote,s.playDir=!1);break}case 5:u=27,g=Math.max(1,b(g,r.internalTicks)),s.playDir=!1;break;case 6:case 7:case 8:case 9:u=9,s.highOffset=n,0===o.note&&(o.note=s.lastNote),s.playDir=!1;break;case 10:u=T,g=s.playDir?158:159,s.playDir=!s.playDir;break;default:u=0}}if(4&a){if(h+1>=t.length)break;const n=e(l,h++);switch(P=e(l,h++),n){case 1:{const t=P<128?P:P-256,e=Math.round(8*t/128);o.note>=1&&o.note<=120&&(o.note=Math.max(1,Math.min(120,o.note+e))),w=0;break}case 2:{const t=b(P,r.internalTicks);t>0?(w=T,P=208|t):w=0;break}case 3:default:w=0;break;case 4:P=k(P,r.internalTicks,!0),w=1;break;case 5:P=k(P,r.internalTicks,!0),w=2;break;case 6:0===o.note&&(o.note=s.noteBuffer),P=k(P,r.internalTicks,!1),w=3;break;case 7:o.note=Math.max(1,Math.min(120,P+25)),w=3,P=255;break;case 8:case 9:case 10:s.vibratoType=n,w=4,P=d(P,r.internalTicks);break;case 11:P=M(P,r.internalTicks),w=29;break;case 12:{const t=b(P,r.internalTicks);t>0?(w=T,P=192|t):(w=0,o.note=c);break}}}if(2&a){if(h+1>=t.length)break;const n=e(l,h++);switch(x=e(l,h++),n){case 1:x=y(x,r.internalTicks,!0),B=10;break;case 2:x=y(x,r.internalTicks,!1),B=10;break;case 3:x=M(x,r.internalTicks),B=29;break;case 4:case 5:case 6:s.tremoloType=n,B=7,x=d(x,r.internalTicks);break;case 7:B=8;break;case 8:x=y(x,r.internalTicks,!0),B=25;break;case 9:x=y(x,r.internalTicks,!1),B=25;break;case 10:B=26,x=d(x,r.internalTicks);break;default:B=0}}f&&o.note>=1&&o.note<=120&&(0===w?(w=3,P=255):0===B&&3!==w&&(B=3,x=255)),v&&(o.volume=A),o.effTyp=w,o.eff=P,o.effTyp2=B,o.eff2=x,0!==u&&(0===o.effTyp2&&(o.effTyp2=o.effTyp,o.eff2=o.eff),o.effTyp=u,o.eff=g),o.note===c?o.note=254:253===o.note&&(o.note=97)}else m[i]--}return{numRows:f,initialSpeed:w,initialBPM:P,channels:p}}function P(e,f){try{return function(e,f){if(!h(e))return null;const c=new DataView(e.buffer,e.byteOffset,e.byteLength),b=e[4],d=r(c,13,30)||f.replace(/\.[^/.]+$/i,""),M=function(t,e,n){const r=new Map;let l=66;const i=e.length;for(;l+8<=i;){const f=a(t,l);let c=a(t,l+4);if(l+=8,3===n&&f===o){const t=e.subarray(l,Math.min(l+c,i));r.set(f,{id:f,data:t}),l+=c+2;continue}if(4===n&&f===o){const t=e.subarray(l,Math.min(l+c,i));r.set(f,{id:f,data:t}),l+=c+4;continue}n<8&&f===s&&(c=i-l);const h=e.subarray(l,Math.min(l+c,i));r.set(f,{id:f,data:h}),l+=c}return r}(c,e,b),k=M.get(l);if(!k)return null;const y=new DataView(k.data.buffer,k.data.byteOffset,k.data.byteLength);if(k.data.length<3)return null;const T=n(y,0),P=Math.max(1,Math.min(32,k.data[2])),B=b<3?9:8,x=[];{let t=3;for(let e=0;e<T&&!(t+B>k.data.length);e++){const e=B+a(y,t+B-4);if(t+e>k.data.length)break;x.push(k.data.subarray(t,t+e)),t+=e}}const v=M.get(o),A=[];let C=0,D=0,S=!1;if(v){const t=new DataView(v.data.buffer,v.data.byteOffset,v.data.byteLength);let e=0;for(b>=3&&e+2<=v.data.length&&(C=n(t,e),e+=2),b>=4&&e+2<=v.data.length&&(D=n(t,e),e+=2,S=!0,4===b&&0===D&&(S=!1));e+2<=v.data.length;)A.push(n(t,e)),e+=2}const U=M.get(i),O=M.get(s),$=[];if(U&&U.data.length>=1){const t=new DataView(U.data.buffer,U.data.byteOffset,U.data.byteLength),e=U.data[0];let o=1;for(let l=0;l<e;l++){const e=b<2?30:o<U.data.length?U.data[o++]:0;if(o+e>U.data.length)break;const i=r(t,o,e);if(o+=e,o+16>U.data.length)break;const s=a(t,o+0),f=a(t,o+4),c=a(t,o+8),h=n(t,o+10),u=U.data[o+12],m=U.data[o+13];o+=16,b>=8&&(o+=8),o+=b>1?6:2,$.push({name:i||`Sample ${l+1}`,length:s,loopStart:f,loopEnd:c,c3freq:h,volume:u,flags:m})}}const I=[];if(O){const t=new DataView(O.data.buffer,O.data.byteOffset,O.data.byteLength);let e=0;for(let n=0;n<$.length;n++){if(e+4>O.data.length){I.push(null);continue}const r=a(t,e);if(e+=4,e+r>O.data.length){I.push(null),e+=r;continue}const o=O.data.subarray(e,e+r);e+=r;const l=$[n],i=12&l.flags;if(0!==r&&0!==l.length)if(4===i){const t=u(o,!!(2&l.flags)?2*l.length:l.length);I.push(t)}else I.push(o.slice());else I.push(null)}}const F=[];for(let n=0;n<$.length;n++){const e=$[n],a=n+1,r=I[n]??null,o=!!(2&e.flags),l=!!(1&e.flags),i=0===e.volume?64:Math.min(64,Math.floor((e.volume+1)/4)),s=Math.max(1e3,Math.min(45e3,e.c3freq||8363));if(r&&0!==r.length)if(o){let t=0,n=0;if(l){t=Math.floor(e.loopStart/2),n=Math.floor(e.loopEnd/2);const a=Math.floor(r.length/2);n=Math.min(n,a)}const o=l&&n>t,f=m(r,s),c=p(f);F.push({id:a,name:e.name.replace(/\0/g,"").trim()||`Sample ${a}`,type:"sample",synthType:"Sampler",effects:[],volume:i>0?20*Math.log10(i/64):-60,pan:0,sample:{audioBuffer:f,url:c,baseNote:"C3",detune:0,loop:o,loopType:o?"forward":"off",loopStart:t,loopEnd:n>0?n:Math.floor(r.length/2),sampleRate:s,reverse:!1,playbackRate:1}})}else{let n=0,o=0;l&&(n=e.loopStart,o=Math.min(e.loopEnd,r.length));const f=l&&o>n?o:0;F.push(t(a,e.name,r,i,s,n,f))}else F.push({id:a,name:e.name,type:"sample",synthType:"Sampler",effects:[],volume:-60,pan:0})}const V=P+1,E={realBPMmode:!1,beat:0,tempoTicks:32,tempoBPM:120,internalTicks:6,channelStates:Array.from({length:P},()=>({noteBuffer:0,lastNote:0,vibratoType:8,tremoloType:4,highOffset:6,playDir:!1}))},{speed:L,bpm:N}=g(E.realBPMmode,E.tempoBPM,E.tempoTicks,E.beat),R=[];for(const t of x){const e=w(t,b,E,V);R.push(e??{numRows:64,channels:[]})}const j=[],q=[];for(let t=0;t<A.length;t++){const e=A[t],n=e<R.length?R[e]:null,a=n?.numRows??64,r=j.length,o=[];for(let t=0;t<=P;t++){const e=n?.channels[t]??Array.from({length:a},()=>({note:0,instrument:0,volume:0,effTyp:0,eff:0,effTyp2:0,eff2:0}));o.push({id:`channel-${t}`,name:0===t?"Global":`Channel ${t}`,muted:!1,solo:!1,collapsed:!1,volume:100,pan:0,instrumentId:null,color:null,rows:e})}j.push({id:`pattern-${r}`,name:`Pattern ${e}`,length:a,channels:o,importMetadata:{sourceFormat:"DMF",sourceFile:f,importedAt:(new Date).toISOString(),originalChannelCount:P,originalPatternCount:x.length,originalInstrumentCount:$.length}}),q.push(r)}0===j.length&&(j.push({id:"pattern-0",name:"Pattern 0",length:64,channels:Array.from({length:P+1},(t,e)=>({id:`channel-${e}`,name:0===e?"Global":`Channel ${e}`,muted:!1,solo:!1,collapsed:!1,volume:100,pan:0,instrumentId:null,color:null,rows:Array.from({length:64},()=>({note:0,instrument:0,volume:0,effTyp:0,eff:0,effTyp2:0,eff2:0}))})),importMetadata:{sourceFormat:"DMF",sourceFile:f,importedAt:(new Date).toISOString(),originalChannelCount:P,originalPatternCount:0,originalInstrumentCount:$.length}}),q.push(0));const G=S&&C<q.length?C:0;return{name:d,format:"IT",patterns:j,instruments:F,songPositions:q,songLength:q.length,restartPosition:G,numChannels:P+1,initialSpeed:L,initialBPM:N,linearPeriods:!0}}(e,f)}catch{return null}}export{h as isXTrackerFormat,P as parseXTrackerFile};
