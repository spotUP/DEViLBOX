import{bI as e,bG as t,bh as i}from"./index-E5N9QGOx.js";import{M as n,b as a}from"./ModuleRegistry-C5IxiZu0.js";import"./vendor-utils-Cm-70yv0.js";import"./vendor-react-LeNVipsj.js";import"./vendor-tone-CADp_hfL.js";import"./vendor-ui-BzVyJkLI.js";class o{isActive=!1;ctx;modules=new Map;sharedModules;voiceOutput;_currentNote=null;constructor(e,t,i,n=new Map){this.ctx=e,this.voiceOutput=e.createGain(),this.voiceOutput.connect(i),this.sharedModules=n,t.forEach(e=>{this.createModule(e)})}createModule(e){const t=n.get(e.descriptorId);if(t&&"per-voice"===t.voiceMode){const i=t.create(this.ctx);if(Object.entries(e.parameters).forEach(([e,t])=>{i.setParam(e,t)}),this.modules.set(e.id,i),"Output"===t.id){const e=i.ports.get("output");e?.node&&e.node.connect(this.voiceOutput)}}}noteOn(t,i,a){this.isActive=!0,this._currentNote=t;const o=e(t);this.modules.forEach(e=>{const t=n.get(e.descriptorId);e.gateOn&&e.gateOn(i,a),"source"===t?.category&&e.setParam&&e.setParam("frequency",o)})}noteOff(e){this.modules.forEach(t=>{t.gateOff&&t.gateOff(e)}),setTimeout(()=>{this.isActive=!1,this._currentNote=null},2e3)}setParameter(e,t,i){const n=this.modules.get(e);n&&n.setParam(t,i)}addModule(e){this.createModule(e)}removeModule(e){const t=this.modules.get(e);t&&(t.dispose(),this.modules.delete(e))}getModule(e){const t=this.modules.get(e);return t||this.sharedModules.get(e)}getOutput(){return this.voiceOutput}getCurrentNote(){return this._currentNote}dispose(){this.modules.forEach(e=>e.dispose()),this.modules.clear(),this.voiceOutput.disconnect()}}class c{constructor(){}buildConnections(e,t){const i=this.topologicalSort(t);e.forEach(e=>{i.forEach(t=>{this.createConnection(e,t)})})}createConnection(e,t){const i=e.getModule(t.source.moduleId),n=e.getModule(t.target.moduleId);if(!i||!n)return;const a=i.ports.get(t.source.portId),o=n.ports.get(t.target.portId);a&&o&&this.areTypesCompatible(a.signal,o.signal)&&("audio"===a.signal&&"audio"===o.signal?a.node&&o.node&&a.node.connect(o.node):a.node&&o.param&&o.scaleNode&&(a.node.connect(o.scaleNode),o.scaleNode.connect(o.param)))}areTypesCompatible(e,t){return"audio"===e?"audio"===t:"cv"===t||("gate"===e&&"gate"===t||"trigger"===e&&"trigger"===t)}topologicalSort(e){return[...e]}detectAudioCycles(e){return!1}disconnectConnection(e,t){const i=e.getModule(t.source.moduleId),n=e.getModule(t.target.moduleId);if(!i||!n)return;const a=i.ports.get(t.source.portId),o=n.ports.get(t.target.portId);if(a&&o){if(a.node&&o.node)try{a.node.disconnect(o.node)}catch(c){}if(a.node&&o.scaleNode)try{a.node.disconnect(o.scaleNode)}catch(c){}}}}class s{graphBuilder=null;currentConnections=[];updateConnections(e,t){!this.graphBuilder&&e.length>0&&(this.graphBuilder=new c),this.graphBuilder&&(this.currentConnections.forEach(t=>{e.forEach(e=>{this.graphBuilder.disconnectConnection(e,t)})}),this.graphBuilder.buildConnections(e,t),this.currentConnections=[...t])}addConnection(e,t){const i=[...this.currentConnections,t];this.updateConnections(e,i)}removeConnection(e,t){const i=this.currentConnections.filter(e=>e.id!==t);this.updateConnections(e,i)}clear(e){this.updateConnections(e,[])}}const r=[{id:"VCO",name:"VCO (Oscillator)",category:"source",voiceMode:"per-voice",color:"#3b82f6",ports:[{id:"pitch",name:"Pitch",direction:"input",signal:"cv"},{id:"pwm",name:"PWM",direction:"input",signal:"cv"},{id:"fm",name:"FM",direction:"input",signal:"cv"},{id:"output",name:"Output",direction:"output",signal:"audio"}],parameters:[{id:"waveform",name:"Waveform",min:0,max:3,default:0},{id:"detune",name:"Detune",min:-100,max:100,default:0},{id:"octave",name:"Octave",min:-2,max:2,default:0},{id:"pulseWidth",name:"Pulse Width",min:0,max:1,default:.5}],create:e=>{const t=e.createOscillator(),i=e.createConstantSource(),n=e.createGain();t.type="sawtooth",t.frequency.value=440,i.offset.value=440,i.start(),t.start(),i.connect(t.frequency),t.connect(n);const a=new Map([["pitch",{id:"pitch",name:"Pitch",direction:"input",signal:"cv",param:i.offset}],["pwm",{id:"pwm",name:"PWM",direction:"input",signal:"cv"}],["fm",{id:"fm",name:"FM",direction:"input",signal:"cv",param:t.frequency}],["output",{id:"output",name:"Output",direction:"output",signal:"audio",node:n}]]);let o=0,c=0,s=0;return{descriptorId:"VCO",ports:a,setParam:(e,n)=>{switch(e){case"waveform":o=Math.floor(n);const e=["sine","sawtooth","square","triangle"];t.type=e[o]||"sawtooth";break;case"detune":c=n,t.detune.value=n;break;case"octave":s=Math.floor(n);break;case"pulseWidth":break;case"frequency":const a=n*Math.pow(2,s);i.offset.value=a}},getParam:e=>{switch(e){case"waveform":return o;case"detune":return c;case"octave":return s;default:return 0}},dispose:()=>{t.stop(),t.disconnect(),i.stop(),i.disconnect(),n.disconnect()}}}},{id:"Noise",name:"Noise",category:"source",voiceMode:"shared",color:"#6b7280",ports:[{id:"output",name:"Output",direction:"output",signal:"audio"}],parameters:[{id:"type",name:"Type",min:0,max:2,default:0}],create:e=>{const t=2*e.sampleRate,i=e.createBuffer(1,t,e.sampleRate),n=i.getChannelData(0);for(let s=0;s<t;s++)n[s]=2*Math.random()-1;const a=e.createBufferSource();a.buffer=i,a.loop=!0,a.start();const o=e.createGain();o.gain.value=.3,a.connect(o);let c=0;return{descriptorId:"Noise",ports:new Map([["output",{id:"output",name:"Output",direction:"output",signal:"audio",node:o}]]),setParam:(e,t)=>{"type"===e&&(c=Math.floor(t))},getParam:e=>"type"===e?c:0,dispose:()=>{a.stop(),a.disconnect(),o.disconnect()}}}},{id:"VCF",name:"VCF (Filter)",category:"filter",voiceMode:"per-voice",color:"#f59e0b",ports:[{id:"input",name:"Input",direction:"input",signal:"audio"},{id:"cutoff",name:"Cutoff",direction:"input",signal:"cv"},{id:"resonance",name:"Resonance",direction:"input",signal:"cv"},{id:"output",name:"Output",direction:"output",signal:"audio"}],parameters:[{id:"type",name:"Type",min:0,max:3,default:0},{id:"cutoff",name:"Cutoff",min:20,max:2e4,default:1e3,curve:"exponential"},{id:"resonance",name:"Resonance",min:0,max:30,default:1},{id:"keyTracking",name:"Key Tracking",min:0,max:1,default:0}],create:e=>{const t=e.createBiquadFilter(),i=e.createGain(),n=e.createGain();t.type="lowpass",t.frequency.value=1e3,t.Q.value=1,i.gain.value=100,n.gain.value=1;const a=new Map([["input",{id:"input",name:"Input",direction:"input",signal:"audio",node:t}],["cutoff",{id:"cutoff",name:"Cutoff",direction:"input",signal:"cv",param:t.frequency,scaleNode:i}],["resonance",{id:"resonance",name:"Resonance",direction:"input",signal:"cv",param:t.Q,scaleNode:n}],["output",{id:"output",name:"Output",direction:"output",signal:"audio",node:t}]]);let o=0,c=0;return{descriptorId:"VCF",ports:a,setParam:(e,i)=>{switch(e){case"type":o=Math.floor(i);const e=["lowpass","highpass","bandpass","notch"];t.type=e[o]||"lowpass";break;case"cutoff":t.frequency.value=i;break;case"resonance":t.Q.value=i;break;case"keyTracking":c=i}},getParam:e=>{switch(e){case"type":return o;case"cutoff":return t.frequency.value;case"resonance":return t.Q.value;case"keyTracking":return c;default:return 0}},dispose:()=>{t.disconnect(),i.disconnect(),n.disconnect()}}}},{id:"VCA",name:"VCA (Amplifier)",category:"amplifier",voiceMode:"per-voice",color:"#10b981",ports:[{id:"input",name:"Input",direction:"input",signal:"audio"},{id:"cv",name:"CV",direction:"input",signal:"cv"},{id:"output",name:"Output",direction:"output",signal:"audio"}],parameters:[{id:"gain",name:"Gain",min:0,max:2,default:1},{id:"bias",name:"Bias",min:0,max:1,default:0}],create:e=>{const t=e.createGain(),i=e.createGain();t.gain.value=0,i.gain.value=1;const n=new Map([["input",{id:"input",name:"Input",direction:"input",signal:"audio",node:t}],["cv",{id:"cv",name:"CV",direction:"input",signal:"cv",param:t.gain,scaleNode:i}],["output",{id:"output",name:"Output",direction:"output",signal:"audio",node:t}]]);let a=1,o=0;return{descriptorId:"VCA",ports:n,setParam:(e,n)=>{switch(e){case"gain":a=n,i.gain.value=n;break;case"bias":o=n,t.gain.value=Math.max(t.gain.value,n)}},getParam:e=>{switch(e){case"gain":return a;case"bias":return o;default:return 0}},dispose:()=>{t.disconnect(),i.disconnect()}}}},{id:"LFO",name:"LFO",category:"modulator",voiceMode:"shared",color:"#ec4899",ports:[{id:"rate",name:"Rate",direction:"input",signal:"cv"},{id:"sync",name:"Sync",direction:"input",signal:"trigger"},{id:"output",name:"Output",direction:"output",signal:"cv"}],parameters:[{id:"waveform",name:"Waveform",min:0,max:3,default:0},{id:"rate",name:"Rate",min:.01,max:20,default:1,curve:"exponential"},{id:"depth",name:"Depth",min:0,max:1,default:.5},{id:"bipolar",name:"Bipolar",min:0,max:1,default:1}],create:e=>{const t=e.createOscillator(),i=e.createGain();t.type="sine",t.frequency.value=1,i.gain.value=.5,t.start(),t.connect(i);const n=new Map([["rate",{id:"rate",name:"Rate",direction:"input",signal:"cv",param:t.frequency}],["sync",{id:"sync",name:"Sync",direction:"input",signal:"trigger"}],["output",{id:"output",name:"Output",direction:"output",signal:"cv",node:i}]]);let a=0,o=1;return{descriptorId:"LFO",ports:n,setParam:(e,n)=>{switch(e){case"waveform":a=Math.floor(n);const e=["sine","sawtooth","square","triangle"];t.type=e[a]||"sine";break;case"rate":t.frequency.value=n;break;case"depth":i.gain.value=n;break;case"bipolar":o=n}},getParam:e=>{switch(e){case"waveform":return a;case"rate":return t.frequency.value;case"depth":return i.gain.value;case"bipolar":return o;default:return 0}},dispose:()=>{t.stop(),t.disconnect(),i.disconnect()}}}},{id:"ADSR",name:"ADSR (Envelope)",category:"envelope",voiceMode:"per-voice",color:"#8b5cf6",ports:[{id:"gate",name:"Gate",direction:"input",signal:"gate"},{id:"retrigger",name:"Retrigger",direction:"input",signal:"trigger"},{id:"output",name:"Output",direction:"output",signal:"cv"}],parameters:[{id:"attack",name:"Attack",min:.001,max:2,default:.01,curve:"exponential"},{id:"decay",name:"Decay",min:.001,max:2,default:.1,curve:"exponential"},{id:"sustain",name:"Sustain",min:0,max:1,default:.7},{id:"release",name:"Release",min:.001,max:5,default:.3,curve:"exponential"}],create:e=>{const t=e.createConstantSource();t.offset.value=0,t.start();let i=.01,n=.1,a=.7,o=.3;return{descriptorId:"ADSR",ports:new Map([["gate",{id:"gate",name:"Gate",direction:"input",signal:"gate"}],["retrigger",{id:"retrigger",name:"Retrigger",direction:"input",signal:"trigger"}],["output",{id:"output",name:"Output",direction:"output",signal:"cv",node:t}]]),setParam:(e,t)=>{switch(e){case"attack":i=t;break;case"decay":n=t;break;case"sustain":a=t;break;case"release":o=t}},getParam:e=>{switch(e){case"attack":return i;case"decay":return n;case"sustain":return a;case"release":return o;default:return 0}},gateOn:(o,c)=>{const s=t.offset,r=o||e.currentTime;s.cancelScheduledValues(r),s.setValueAtTime(s.value,r),s.linearRampToValueAtTime(c,r+i),s.linearRampToValueAtTime(a*c,r+i+n)},gateOff:i=>{const n=t.offset,a=i||e.currentTime;n.cancelScheduledValues(a),n.setValueAtTime(n.value,a),n.linearRampToValueAtTime(0,a+o)},dispose:()=>{t.stop(),t.disconnect()}}}},{id:"Mixer",name:"Mixer",category:"utility",voiceMode:"per-voice",color:"#14b8a6",ports:[{id:"in1",name:"Input 1",direction:"input",signal:"audio"},{id:"in2",name:"Input 2",direction:"input",signal:"audio"},{id:"in3",name:"Input 3",direction:"input",signal:"audio"},{id:"in4",name:"Input 4",direction:"input",signal:"audio"},{id:"output",name:"Output",direction:"output",signal:"audio"}],parameters:[{id:"level1",name:"Level 1",min:0,max:1,default:1},{id:"level2",name:"Level 2",min:0,max:1,default:1},{id:"level3",name:"Level 3",min:0,max:1,default:1},{id:"level4",name:"Level 4",min:0,max:1,default:1}],create:e=>{const t=e.createGain(),i=[];for(let n=0;n<4;n++){const n=e.createGain();n.gain.value=1,n.connect(t),i.push(n)}return{descriptorId:"Mixer",ports:new Map([["in1",{id:"in1",name:"Input 1",direction:"input",signal:"audio",node:i[0]}],["in2",{id:"in2",name:"Input 2",direction:"input",signal:"audio",node:i[1]}],["in3",{id:"in3",name:"Input 3",direction:"input",signal:"audio",node:i[2]}],["in4",{id:"in4",name:"Input 4",direction:"input",signal:"audio",node:i[3]}],["output",{id:"output",name:"Output",direction:"output",signal:"audio",node:t}]]),setParam:(e,t)=>{const n=e.match(/level(\d+)/);if(n){const e=parseInt(n[1],10)-1;e>=0&&e<4&&(i[e].gain.value=t)}},getParam:e=>{const t=e.match(/level(\d+)/);if(t){const e=parseInt(t[1],10)-1;if(e>=0&&e<4)return i[e].gain.value}return 0},dispose:()=>{i.forEach(e=>e.disconnect()),t.disconnect()}}}},{id:"Delay",name:"Delay",category:"utility",voiceMode:"shared",color:"#06b6d4",ports:[{id:"input",name:"Input",direction:"input",signal:"audio"},{id:"time",name:"Time",direction:"input",signal:"cv"},{id:"feedback",name:"Feedback",direction:"input",signal:"cv"},{id:"output",name:"Output",direction:"output",signal:"audio"}],parameters:[{id:"time",name:"Time",min:.001,max:2,default:.25,curve:"linear"},{id:"feedback",name:"Feedback",min:0,max:.95,default:.3},{id:"mix",name:"Mix",min:0,max:1,default:.5}],create:e=>{const t=e.createDelay(2),i=e.createGain(),n=e.createGain(),a=e.createGain(),o=e.createGain();t.delayTime.value=.25,i.gain.value=.3,n.gain.value=.5,a.gain.value=.5,t.connect(i),i.connect(t),t.connect(n),n.connect(o),a.connect(o);const c=new Map([["input",{id:"input",name:"Input",direction:"input",signal:"audio",node:t}],["time",{id:"time",name:"Time",direction:"input",signal:"cv",param:t.delayTime}],["feedback",{id:"feedback",name:"Feedback",direction:"input",signal:"cv",param:i.gain}],["output",{id:"output",name:"Output",direction:"output",signal:"audio",node:o}]]),s=e.createGain();return s.connect(t),s.connect(a),{descriptorId:"Delay",ports:c,setParam:(e,o)=>{switch(e){case"time":t.delayTime.value=o;break;case"feedback":i.gain.value=o;break;case"mix":n.gain.value=o,a.gain.value=1-o}},getParam:e=>{switch(e){case"time":return t.delayTime.value;case"feedback":return i.gain.value;case"mix":return n.gain.value;default:return 0}},dispose:()=>{t.disconnect(),i.disconnect(),n.disconnect(),a.disconnect(),o.disconnect(),s.disconnect()}}}},{id:"SampleHold",name:"Sample & Hold",category:"utility",voiceMode:"shared",color:"#f97316",ports:[{id:"input",name:"Input",direction:"input",signal:"cv"},{id:"clock",name:"Clock",direction:"input",signal:"trigger"},{id:"output",name:"Output",direction:"output",signal:"cv"}],parameters:[{id:"slew",name:"Slew",min:0,max:.5,default:0}],create:e=>{const t=e.createConstantSource();t.offset.value=0,t.start();let i=0,n=0;return{descriptorId:"SampleHold",ports:new Map([["input",{id:"input",name:"Input",direction:"input",signal:"cv"}],["clock",{id:"clock",name:"Clock",direction:"input",signal:"trigger"}],["output",{id:"output",name:"Output",direction:"output",signal:"cv",node:t}]]),setParam:(e,t)=>{"slew"===e?i=t:"inputValue"===e&&(n=t)},getParam:e=>"slew"===e?i:"inputValue"===e?n:0,gateOn:a=>{const o=a||e.currentTime;i>0?(t.offset.cancelScheduledValues(o),t.offset.setValueAtTime(t.offset.value,o),t.offset.linearRampToValueAtTime(n,o+i)):t.offset.setValueAtTime(n,o)},dispose:()=>{t.stop(),t.disconnect()}}}},{id:"Output",name:"Output",category:"io",voiceMode:"per-voice",color:"#ef4444",ports:[{id:"input",name:"Input",direction:"input",signal:"audio"},{id:"output",name:"Output",direction:"output",signal:"audio"}],parameters:[{id:"level",name:"Level",min:0,max:2,default:1},{id:"pan",name:"Pan",min:-1,max:1,default:0}],create:e=>{const t=e.createGain(),i=e.createStereoPanner();t.gain.value=1,i.pan.value=0,t.connect(i);return{descriptorId:"Output",ports:new Map([["input",{id:"input",name:"Input",direction:"input",signal:"audio",node:t}],["output",{id:"output",name:"Output",direction:"output",signal:"audio",node:i}]]),setParam:(e,n)=>{switch(e){case"level":t.gain.value=n;break;case"pan":i.pan.value=n}},getParam:e=>{switch(e){case"level":return t.gain.value;case"pan":return i.pan.value;default:return 0}},dispose:()=>{t.disconnect(),i.disconnect()}}}},{id:"MIDIIn",name:"MIDI In",category:"io",voiceMode:"shared",color:"#a855f7",ports:[{id:"pitch",name:"Pitch (V/Oct)",direction:"output",signal:"cv"},{id:"gate",name:"Gate",direction:"output",signal:"gate"},{id:"velocity",name:"Velocity",direction:"output",signal:"cv"}],parameters:[],create:e=>{const t=e.createConstantSource(),i=e.createConstantSource(),n=e.createConstantSource();t.offset.value=440,i.offset.value=0,n.offset.value=1,t.start(),i.start(),n.start();return{descriptorId:"MIDIIn",ports:new Map([["pitch",{id:"pitch",name:"Pitch (V/Oct)",direction:"output",signal:"cv",node:t}],["gate",{id:"gate",name:"Gate",direction:"output",signal:"gate",node:i}],["velocity",{id:"velocity",name:"Velocity",direction:"output",signal:"cv",node:n}]]),setParam:()=>{},getParam:()=>0,dispose:()=>{t.stop(),i.stop(),n.stop(),t.disconnect(),i.disconnect(),n.disconnect()}}}}];function u(){r.forEach(e=>{n.register(e)})}u();class d{name="ModularSynth";output;ctx;voices=[];activeVoices=new Map;config;connectionManager;sharedModules=new Map;constructor(e){this.ctx=t(),this.output=this.ctx.createGain(),this.config=e,this.connectionManager=new s,u(),this.initializeVoices()}initializeVoices(){const e=this.config.polyphony||1;this.voices=[],this.sharedModules.clear(),this.config.modules.forEach(e=>{const t=n.get(e.descriptorId);if(t&&"shared"===t.voiceMode){const i=t.create(this.ctx);Object.entries(e.parameters).forEach(([e,t])=>{i.setParam(e,t)}),this.sharedModules.set(e.id,i)}});for(let t=0;t<e;t++){const e=new o(this.ctx,this.config.modules,this.output,this.sharedModules);this.voices.push(e)}this.config.connections.length>0&&this.connectionManager.updateConnections(this.voices,this.config.connections)}triggerAttack(e,t=this.ctx.currentTime,i=1){let n=this.voices.find(e=>!e.isActive);if(!n){const e=Array.from(this.activeVoices.keys())[0];n=this.activeVoices.get(e),n&&this.activeVoices.delete(e)}n&&(n.noteOn(e,t,i),this.activeVoices.set(e,n))}triggerRelease(e,t=this.ctx.currentTime){const i=this.activeVoices.get(e);i&&(i.noteOff(t),this.activeVoices.delete(e))}set(e,t){const[i,n]=e.split(".");if(!i||!n)return;const a=this.config.modules.find(e=>e.id===i);a&&(a.parameters[n]=t),this.voices.forEach(e=>{e.setParameter(i,n,t)})}get(e){const[t,i]=e.split("."),n=this.config.modules.find(e=>e.id===t);return n?.parameters[i]??0}addModule(e){this.config.modules.push(e),this.voices.forEach(t=>{t.addModule(e)})}removeModule(e){this.config.modules=this.config.modules.filter(t=>t.id!==e),this.voices.forEach(t=>{t.removeModule(e)}),this.config.connections=this.config.connections.filter(t=>t.source.moduleId!==e&&t.target.moduleId!==e),this.connectionManager.updateConnections(this.voices,this.config.connections)}addConnection(e){this.config.connections.push(e),this.connectionManager.updateConnections(this.voices,this.config.connections)}removeConnection(e){this.config.connections=this.config.connections.filter(t=>t.id!==e),this.connectionManager.updateConnections(this.voices,this.config.connections)}getConfig(){return{...this.config}}setPolyphony(e){this.voices.forEach(e=>e.dispose()),this.voices=[],this.activeVoices.clear(),this.config.polyphony=e,this.initializeVoices()}dispose(){this.voices.forEach(e=>e.dispose()),this.voices=[],this.activeVoices.clear(),this.output.disconnect()}}const l={id:"ModularSynth",name:"Modular Synth",category:"native",loadMode:"lazy",create:e=>{const t=e.modularSynth||a;return new d(t)},useSynthBus:!0,controlsComponent:"ModularSynthControls"};i.register(l);
