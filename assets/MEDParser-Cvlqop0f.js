import{aB as e}from"./index-zx6LJBPK.js";import"./vendor-react-DkDaD07v.js";import"./vendor-utils-XMmR-oGw.js";import"./vendor-tone-CADp_hfL.js";import"./vendor-ui-uomqNFY-.js";const t=new TextDecoder("iso-8859-1");function n(e,n,o){let r=n;for(;r<n+o&&0!==e[r];)r++;return t.decode(e.subarray(n,r)).replace(/\0/g,"").trim()}function o(e,t){return e[t]<<8|e[t+1]}function r(e,t){return(e[t]<<24|e[t+1]<<16|e[t+2]<<8|e[t+3])>>>0}function f(e,t){const n=e[t];return n>=128?n-256:n}const s=[856,808,762,720,678,640,604,570,538,508,480,453,428,404,381,360,339,320,302,285,269,254,240,226,214,202,190,180,170,160,151,143,135,127,120,113];function l(e){if(0===e)return 0;let t=0,n=1/0;for(let o=0;o<s.length;o++){const r=Math.abs(s[o]-e);r<n&&(n=r,t=o)}return t+13}function a(s,a){const c=new Uint8Array(s),u=function(e,n){return t.decode(e.subarray(n,n+4))}(c,0);if(!["MMD0","MMD1","MMD2","MMD3"].includes(u))throw new Error(`Not a MED file: magic="${u}"`);const p="MMD0"!==u,h=r(c,8),y=r(c,16),m=r(c,24),d=63;let v=h;const w=[];for(let e=0;e<d;e++){const t=v+8*e;if(t+8>c.length)break;const n=r(c,t),s=f(c,t+4),l=c[t+5],a=2*o(c,t+6),i=2*o(c,t+8);w.push({synth:s<0,waveLen:2*n,loopStart:a,loopLength:i,volume:l||64,finetune:0})}v+=504;const g=o(c,v),T=o(c,v+2),M=[];for(let e=0;e<256;e++)M.push(c[v+4+e]);const S=o(c,v+260),b=c[v+264],A=c[v+267],D=[];for(let e=0;e<g;e++){const t=r(c,y+4*e);t>0&&t<c.length&&D.push(t)}let I=4;D.length>0&&(I=o(c,D[0]),I=Math.max(1,Math.min(64,I)));const L=[];for(let e=0;e<D.length;e++){const t=D[e];let n,r,f;p?(n=o(c,t),r=o(c,t+2),f=t+8):(n=c[t],r=c[t+1],f=t+2);const s=p?4:3,u=Array.from({length:n},(e,t)=>{const o=[];for(let a=0;a<=r;a++){const e=f+(a*n+t)*s;if(e+s>c.length){o.push({note:0,instrument:0,volume:0,effTyp:0,eff:0,effTyp2:0,eff2:0});continue}let r=0,u=0,h=0,y=0;if(p){const t=c[e];u=c[e+1],h=c[e+2],y=c[e+3],r=t>0?t+12:0}else{const t=c[e],n=c[e+1],o=c[e+2],f=(15&t)<<8|n;u=t>>4<<4|o>>4;const s=15&o;y=e+3<c.length?c[e+3]:0,r=l(f);const{effTyp:a,eff:p}=i(s,y);h=a,y=p}o.push({note:r,instrument:u,volume:0,effTyp:h,eff:y,effTyp2:0,eff2:0})}return{id:`channel-${t}`,name:`Track ${t+1}`,muted:!1,solo:!1,collapsed:!1,volume:100,pan:t%2==0?-25:25,instrumentId:null,color:null,rows:o}});L.push({id:`pattern-${e}`,name:`Block ${e}`,length:r+1,channels:u,importMetadata:{sourceFormat:"MED",sourceFile:a,importedAt:(new Date).toISOString(),originalChannelCount:n,originalPatternCount:g,originalInstrumentCount:A||d}})}let U=[];if(m>0&&m<c.length){const e=r(c,m+16),t=o(c,m+20),f=o(c,m+22);if(e>0&&e<c.length)for(let o=0;o<t;o++){const t=e+o*f;if(t+40>c.length)break;U.push(n(c,t,40))}}let $=h+504+268+8*A;$=$+1&-2;const k=[];let E=$;for(let t=0;t<Math.min(d,A||d);t++){const n=w[t];if(!n)break;const f=U[t]||`Instrument ${t+1}`;if(n.synth||0===n.waveLen){const e=E,s=r(c,e);if(s>0&&e+s<=c.length){const l=o(c,e+10),a=o(c,e+12),i=o(c,e+14),u=o(c,e+16),p=c[e+18],h=c[e+19],y=o(c,e+20),m=2*l,d=2*a;if(65535===y||0===y||y>64){k.push({id:t+1,name:f,type:"synth",synthType:"OctaMEDSynth",octamed:{volume:63&n.volume,voltblSpeed:0,wfSpeed:0,vibratoSpeed:0,loopStart:0,loopLen:0,voltbl:new Uint8Array(128).fill(255),wftbl:new Uint8Array(128).fill(255),waveforms:[new Int8Array(256)]},effects:[],volume:0,pan:0}),E+=s,1&E&&E++;continue}const v=new Uint8Array(128).fill(255),w=Math.min(i,128);for(let t=0;t<w;t++)v[t]=c[e+22+t];const g=new Uint8Array(128).fill(255),T=Math.min(u,128);for(let t=0;t<T;t++)g[t]=c[e+150+t];const M=[];for(let t=0;t<y;t++){const n=e+278+4*t;if(n+4>c.length)break;const f=e+r(c,n);if(f+2>c.length){M.push(new Int8Array(256));continue}const s=2*o(c,f),l=f+2;if(l+s>c.length||0===s){M.push(new Int8Array(256));continue}const a=new Int8Array(256),i=Math.min(s,256);for(let e=0;e<i;e++){const t=c[l+e];a[e]=t>=128?t-256:t}M.push(a)}0===M.length&&M.push(new Int8Array(256));const S={volume:63&n.volume,voltblSpeed:p,wfSpeed:h,vibratoSpeed:0,loopStart:m,loopLen:d,voltbl:v,wftbl:g,waveforms:M};k.push({id:t+1,name:f,type:"synth",synthType:"OctaMEDSynth",octamed:S,effects:[],volume:0,pan:0}),E+=s,1&E&&E++}else k.push({id:t+1,name:f,type:"synth",synthType:"OctaMEDSynth",octamed:{volume:63&n.volume,voltblSpeed:0,wfSpeed:0,vibratoSpeed:0,loopStart:0,loopLen:0,voltbl:new Uint8Array(128).fill(255),wftbl:new Uint8Array(128).fill(255),waveforms:[new Int8Array(256)]},effects:[],volume:0,pan:0});continue}const s=Math.min(n.waveLen,c.length-E),l=s>0?c.slice(E,E+s):new Uint8Array(0);E+=s,1&E&&E++,k.push(e(t+1,f,l,n.volume,8287,n.loopStart,n.loopStart+n.loopLength))}const j=M.slice(0,Math.max(1,T));return{name:a.replace(/\.[^/.]+$/,""),format:u,patterns:L,instruments:k.length>0?k:[],songPositions:j,songLength:T||1,restartPosition:0,numChannels:I,initialSpeed:b||6,initialBPM:S||125,linearPeriods:!1}}function i(e,t){switch(e){case 0:return{effTyp:0,eff:t};case 1:return{effTyp:1,eff:t};case 2:return{effTyp:2,eff:t};case 3:return{effTyp:3,eff:t};case 4:return{effTyp:4,eff:t};case 5:return{effTyp:5,eff:t};case 6:return{effTyp:6,eff:t};case 7:return{effTyp:7,eff:t};case 8:return{effTyp:8,eff:t};case 9:return{effTyp:9,eff:t};case 10:return{effTyp:10,eff:t};case 11:return{effTyp:11,eff:t};case 12:return{effTyp:12,eff:t};case 13:return{effTyp:13,eff:t};case 14:return{effTyp:14,eff:(t>>4&15)<<4|15&t};case 15:return{effTyp:15,eff:t};default:return{effTyp:0,eff:0}}}export{a as parseMEDFile};
