import{aB as n}from"./index-zx6LJBPK.js";import"./vendor-react-DkDaD07v.js";import"./vendor-utils-XMmR-oGw.js";import"./vendor-tone-CADp_hfL.js";import"./vendor-ui-uomqNFY-.js";function t(n,t){return n[t]??0}function e(n,t){return((n[t]??0)|(n[t+1]??0)<<8|(n[t+2]??0)<<16|(n[t+3]??0)<<24)>>>0}function r(n,t,e){let r="";for(let o=0;o<e;o++){const e=n[t+o]??0;if(0===e)break;r+=String.fromCharCode(e)}return r.trim()}const o=1954,i=2978,u=13,s=32,f=64,l=128,a=[8,16,24,32,40,44,48,52,54,56,58,60,61,62,63,64],c=[64,192,64,192];function m(n){if(n.length<i)return!1;const r=t(n,0);if(r<1||r>15)return!1;for(let e=0;e<256;e++){const r=t(n,1698+e);if(r>=128&&255!==r)return!1}let o=!1;for(let i=0;i<32;i++){if(0!==t(n,2+13*i+12))return!1;const r=418+16*i;if(0!==e(n,r))return!1;const u=e(n,r+4),s=e(n,r+8),f=e(n,r+12);if(u>1048575)return!1;if(0!==t(n,930+13*i+12))return!1;const l=1346+11*i;if(240&t(n,l))return!1;if(252&t(n,l+5))return!1;if(252&t(n,l+10))return!1;if(0!==u&&f<1048575){if(f>u)return!1;if(s>f)return!1}if(!o){if(0!==u){o=!0;continue}let e=!1;for(let r=0;r<11;r++)if(0!==t(n,l+r)){e=!0;break}e&&(o=!0)}}return o}function p(n,t){const e=15&n;return t?a[e]??64:4+4*e}function h(a,h){try{return function(a,h){if(!m(a))return null;const C=t(a,0),y=t(a,1),v=[];for(let n=0;n<256;n++){const e=t(a,1698+n);if(255===e)break;v.push(e)}0===v.length&&v.push(0);const P=[],$=[];for(let n=0;n<l;n++)P.push(e(a,o+4*n)),$.push(e(a,2466+4*n));const M=[];for(let n=0;n<l;n++){const e=i+P[n],r=$[n];if(r<3||r>4096||e+r>a.length){M.push(g(n,h));continue}const o=Array.from({length:u},()=>Array.from({length:f},()=>({note:0,instrument:0,volume:0,effTyp:0,eff:0,effTyp2:0,eff2:0})));let m=0,d=e;const C=e+r;for(;m<f&&d<C;){const n=t(a,d++);if(n<=12){if(d+2>C)break;const e=t(a,d++),r=t(a,d++),i=n>=4,u=o[n]?.[m];if(!u)continue;const f=r>>4&15|(128&e)>>3,l=1+(i?12:36)+(15&e)+12*(e>>4&7),c=i?s:0;u.note=l>=1&&l<=120?l:0,u.instrument=c+f+1,u.volume=p(15&r,i)}else if(n>=32&&n<=44){if(d+1>C)break;const e=t(a,d++),r=n-32,i=r>=4,u=o[r]?.[m];u&&(u.volume=p(15&e,i))}else{if(64!==n){if(96===n){if(m>0){const n=o[0]?.[m-1];n&&(n.effTyp=13,n.eff=0)}break}break}if(d+1>C)break;m+=t(a,d++)}}const y=o.map((n,t)=>({id:`channel-${t}`,name:t<4?`PCM ${t+1}`:"FM "+(t-4+1),muted:!1,solo:!1,collapsed:!1,volume:100,pan:t<4?(c[t]??128)-128:0,instrumentId:null,color:null,rows:n}));M.push({id:`pattern-${n}`,name:`Pattern ${n}`,length:f,channels:y,importMetadata:{sourceFormat:"C67",sourceFile:h,importedAt:(new Date).toISOString(),originalChannelCount:u,originalPatternCount:l,originalInstrumentCount:64}})}const b=[];let k=i;for(let n=0;n<l;n++){const t=i+P[n]+$[n];t>k&&(k=t)}let S=k;for(let t=0;t<s;t++){const o=418+16*t,i=r(a,2+13*t,13)||`PCM ${t+1}`,u=e(a,o+4),s=e(a,o+8),f=e(a,o+12);if(0===u||S+u>a.length){b.push(d(t+1,i)),S+=u;continue}const l=f<=u,c=l?s:0,m=l?f:0,p=a.subarray(S,S+u);S+=u,b.push(n(t+1,i,p,64,8287,c,m))}for(let n=0;n<32;n++){const t=r(a,930+13*n,13)||`FM ${n+1}`;b.push(d(s+n+1,t))}const F=h.replace(/\.[^/.]+$/,"");return{name:F,format:"S3M",patterns:M,instruments:b,songPositions:v,songLength:v.length,restartPosition:y<v.length?y:0,numChannels:u,initialSpeed:C,initialBPM:143,linearPeriods:!1}}(a,h)}catch{return null}}function g(n,t){const e=Array.from({length:u},(n,t)=>({id:`channel-${t}`,name:t<4?`PCM ${t+1}`:"FM "+(t-4+1),muted:!1,solo:!1,collapsed:!1,volume:100,pan:t<4?(c[t]??128)-128:0,instrumentId:null,color:null,rows:Array.from({length:f},()=>({note:0,instrument:0,volume:0,effTyp:0,eff:0,effTyp2:0,eff2:0}))}));return{id:`pattern-${n}`,name:`Pattern ${n}`,length:f,channels:e,importMetadata:{sourceFormat:"C67",sourceFile:t,importedAt:(new Date).toISOString(),originalChannelCount:u,originalPatternCount:l,originalInstrumentCount:64}}}function d(n,t){return{id:n,name:t,type:"sample",synthType:"Sampler",effects:[],volume:0,pan:0}}export{m as isCDFM67Format,h as parseCDFM67File};
