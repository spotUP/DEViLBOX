import{aB as e,aD as t}from"./index-zx6LJBPK.js";import"./vendor-react-DkDaD07v.js";import"./vendor-utils-XMmR-oGw.js";import"./vendor-tone-CADp_hfL.js";import"./vendor-ui-uomqNFY-.js";function n(e,t){return e.getUint16(t,!1)}function r(e,t){return e.getUint32(t,!1)}function a(e,t,n){let r="";for(let a=0;a<n;a++){const n=e.getUint8(t+a);if(0===n)break;r+=String.fromCharCode(n)}return r}const o=20;function s(e){if(0===e)return 0;const n=t(e);return n>0?n+12:0}function f(e,t,r){const a=Array.from({length:64},()=>({note:0,instrument:0,volume:0,effTyp:0,eff:0,effTyp2:0,eff2:0}));let o=t,f=0,i=0,l=!1,c=0,u=0;for(;!l&&o+2<=r;){const t=n(e,o);if(o+=2,32768===t||37120===t)break;if(32768&t){const e=t>>8&127,n=127&t;switch(3!==e&&9!==e&&11!==e&&12!==e&&13!==e&&e<16&&(c=0,u=0),e){case 1:case 14:f<64&&(a[f].effTyp=1,a[f].eff=n);break;case 2:case 15:f<64&&(a[f].effTyp=2,a[f].eff=n);break;case 3:f<64&&(a[f].volume=16+Math.min(n,64));break;case 4:c=0,u=0;break;case 5:f<64&&(a[f].effTyp=14,a[f].eff=0===n?80:96|15&n);break;case 6:f<64&&(a[f].effTyp=14,a[f].eff=0);break;case 7:f<64&&(a[f].effTyp=14,a[f].eff=1);break;case 8:n>0&&f<64&&(a[f].effTyp=15,a[f].eff=Math.max(1,Math.round(100/n)));break;case 9:i=n+1;break;case 10:c=0,u=n;break;case 11:c=3,u=n;break;case 12:c=4,u=n;break;case 13:0!==n?(c=10,u=n):(c=0,u=0);break;case 16:if(0!==c||0!==u)for(let e=0;e<n&&f<64;e++)a[f].effTyp=c,a[f].eff=u,f++;else f+=n;f>=64&&(l=!0);break;case 17:f<64&&(a[f].effTyp=11,a[f].eff=n),l=!0}}else if(16384&t){const c=255&t;if(o+2>r)break;const u=n(e,o);if(o+=2,0===u&&0===c)break;if(0!==u&&f<64){const e=4095&u;a[f].note=s(e),a[f].instrument=i}f+=c,f>=64&&(l=!0)}else{const e=4095&t;0!==e&&f<64&&(a[f].note=s(e),a[f].instrument=i)}}return a}function i(e){if(e.byteLength<32)return!1;const t=new DataView(e);return"AmBk"===a(t,0,4)&&(3===n(t,4)&&"Music   "===a(t,12,8))}async function l(t,s){const l=new DataView(t),c=new Uint8Array(t);if(!i(t))throw new Error("ABK: not an AMOS Music Bank file");const u=r(l,20),m=r(l,24),p=r(l,28);if(u>1048576||m>1048576||p>1048576)throw new Error("ABK: implausible section offsets");const h=o+u,g=o+m,y=o+p;if(h+2>t.byteLength)throw new Error("ABK: instruments section out of range");const b=n(l,h),d=[];for(let e=0;e<b;e++){const o=h+2+32*e;if(o+32>t.byteLength)break;const s=r(l,o+0),f=r(l,o+4),i=n(l,o+8),c=n(l,o+10),u=n(l,o+12),m=n(l,o+14),p=a(l,o+16,16).trim(),g=m>4?m:i;d.push({name:p||`Sample ${e+1}`,sampleOffset:s,repeatOffset:f,sampleLength:g,repeatEnd:c,volume:Math.min(u,64)})}let k=s.replace(/\.[^/.]+$/,""),w=6,M=[];if(g+6<=t.byteLength){if(n(l,g)>=1&&g+6<=t.byteLength){const e=g+r(l,g+2);if(e+28<=t.byteLength){const r=e+n(l,e+0),o=n(l,e+8),s=a(l,e+12,16).trim();s&&(k=s),o>0&&(w=Math.max(1,Math.min(31,Math.round(100/o))));let f=r;for(;f+2<=t.byteLength;){const e=n(l,f);if(f+=2,65535===e||65534===e)break;M.push(e)}}}}if(y+2>t.byteLength)throw new Error("ABK: patterns section out of range");const A=n(l,y),L=[],T=[-50,50,50,-50];for(let e=0;e<A;e++){const r=y+2+8*e;if(r+8>t.byteLength)break;const a=Array.from({length:4},(e,a)=>{const o=n(l,r+2*a),s=y+o,i=s+2<=t.byteLength?f(l,s,t.byteLength):Array.from({length:64},()=>({note:0,instrument:0,volume:0,effTyp:0,eff:0,effTyp2:0,eff2:0}));return{id:`channel-${a}`,name:`Channel ${a+1}`,muted:!1,solo:!1,collapsed:!1,volume:100,pan:T[a],instrumentId:null,color:null,rows:i}});L.push({id:`pattern-${e}`,name:`Pattern ${e}`,length:64,channels:a,importMetadata:{sourceFormat:"AMOSMusicBank",sourceFile:s,importedAt:(new Date).toISOString(),originalChannelCount:4,originalPatternCount:A,originalInstrumentCount:b}})}0===L.length&&L.push({id:"pattern-0",name:"Pattern 0",length:64,channels:Array.from({length:4},(e,t)=>({id:`channel-${t}`,name:`Channel ${t+1}`,muted:!1,solo:!1,collapsed:!1,volume:100,pan:T[t],instrumentId:null,color:null,rows:Array.from({length:64},()=>({note:0,instrument:0,volume:0,effTyp:0,eff:0,effTyp2:0,eff2:0}))})),importMetadata:{sourceFormat:"AMOSMusicBank",sourceFile:s,importedAt:(new Date).toISOString(),originalChannelCount:4,originalPatternCount:0,originalInstrumentCount:0}});const v=d.map((n,r)=>{const a=2*n.sampleLength,o=h+n.sampleOffset;if(a<=2||o+a>t.byteLength)return{id:r+1,name:n.name,type:"sample",synthType:"Sampler",effects:[],volume:-60,pan:0};const s=c.slice(o,o+a),f=n.repeatEnd>2,i=f&&n.repeatOffset>n.sampleOffset?2*(n.repeatOffset-n.sampleOffset):0,l=f?i+2*n.repeatEnd:0;return e(r+1,n.name,s,n.volume,8287,i,l)}),C=M.length>0?M.filter(e=>e<L.length):[0];return 0===C.length&&C.push(0),{name:k,format:"MOD",patterns:L,instruments:v,songPositions:C,songLength:C.length,restartPosition:0,numChannels:4,initialSpeed:w,initialBPM:125,linearPeriods:!1}}export{i as isAMOSMusicBankFormat,l as parseAMOSMusicBankFile};
