function t(t,e){return(127&t[e])<<21|(127&t[e+1])<<14|(127&t[e+2])<<7|127&t[e+3]}function e(t,e){let n=e;for(;n<t.length&&0!==t[n];)n++;return[new TextDecoder("ascii").decode(t.subarray(e,n)),n+1]}function n(t,e){let n=e;for(;n+1<t.length&&(0!==t[n]||0!==t[n+1]);)n+=2;return[new TextDecoder("utf-16be").decode(t.subarray(e,n)),n+2]}function r(t){if(t.length<4)return null;const r=t[0];let o=1;const[a,i]=e(t,o);let l,s;o=i,1===r||2===r?([l,o]=n(t,o),[s,o]=n(t,o)):([l,o]=e(t,o),[s,o]=e(t,o));return{description:s,mimeType:a,fileName:l,data:t.subarray(o)}}function o(e){const n=function(e){const n=new Uint8Array(e);if(n.length<10)return null;if(73!==n[0]||68!==n[1]||51!==n[2])return null;const r=n[3],o=n[4],a=n[5],i=t(n,6);return r<3||r>4?null:{version:r,revision:o,flags:a,size:i}}(e);if(!n)return new Map;const o=new Uint8Array(e),a=new Map,i=10+n.size;let l=10;if(64&n.flags){l+=4===n.version?t(o,l):new DataView(e).getUint32(l,!1)}for(;l+10<=i;){const i=String.fromCharCode(o[l],o[l+1],o[l+2],o[l+3]);if("\0"===i[0])break;const s=4===n.version?t(o,l+4):new DataView(e).getUint32(l+4,!1);if("GEOB"===i&&s>0){const t=r(o.subarray(l+10,l+10+s));t&&a.set(t.description,t)}l+=10+s}return a}const a=["#CC0000","#CC8800","#CCCC00","#00CC00","#00CCCC","#0000CC","#CC00CC","#CC0088"];function i(t){const e={bpm:null,gain:null,key:null,cuePoints:[],loops:[],beatGrid:[]},n=o(t);if(0===n.size)return e;const r=n.get("Serato Autotags");if(r){const t=function(t){let e=0;t.length>=2&&1===t[0]&&1===t[1]&&(e=2);const n=new TextDecoder("ascii").decode(t.subarray(e)).split("\0").filter(Boolean),r=n[0]?parseFloat(n[0]):null,o=n[1]?parseFloat(n[1]):null;return{bpm:null===r||isNaN(r)?null:Math.round(100*r)/100,gain:null===o||isNaN(o)?null:Math.round(1e3*o)/1e3}}(r.data);e.bpm=t.bpm,e.gain=t.gain}const i=n.get("Serato Markers2");if(i){const t=function(t){const e=[],n=[];let r;if(t.length>=2&&1===t[0]&&1===t[1]){const e=t.length>2?t[2]:0;if(e>=32&&e<=126)try{let e=new TextDecoder("ascii").decode(t.subarray(2)).replace(/[\r\n\s]/g,"");e.length%4==1&&(e+="A");const n=atob(e);r=new Uint8Array(n.length);for(let t=0;t<n.length;t++)r[t]=n.charCodeAt(t)}catch{r=t}else r=t}else try{let e=new TextDecoder("ascii").decode(t).replace(/[\r\n\s]/g,"");e.length%4==1&&(e+="A");const n=atob(e);r=new Uint8Array(n.length);for(let t=0;t<n.length;t++)r[t]=n.charCodeAt(t)}catch{r=t}let o=0;for(r.length>=2&&1===r[0]&&1===r[1]&&(o=2);o<r.length;){for(;o<r.length&&0===r[o];)o++;if(o>=r.length)break;let t=o;for(;t<r.length&&0!==r[t];)t++;if(t>=r.length)break;const i=new TextDecoder("ascii").decode(r.subarray(o,t));if(o=t+1,o+4>r.length)break;const l=r[o]<<24|r[o+1]<<16|r[o+2]<<8|r[o+3];if(o+=4,0===l||o+l>r.length)break;const s=r.subarray(o,o+l);if("CUE"===i&&l>=13){const t=s[1],n=s[2]<<24|s[3]<<16|s[4]<<8|s[5],r=s[7],o=s[8],i=s[9],l=`#${r.toString(16).padStart(2,"0")}${o.toString(16).padStart(2,"0")}${i.toString(16).padStart(2,"0")}`;let c=12;for(;c<s.length&&0!==s[c];)c++;const u=c>12?new TextDecoder("utf-8").decode(s.subarray(12,c)):"";e.push({index:t,position:n,color:"#000000"===l?a[t]??"#CC0000":l,name:u})}else if("LOOP"===i&&l>=21){const t=s[1],e=s[2]<<24|s[3]<<16|s[4]<<8|s[5],r=s[6]<<24|s[7]<<16|s[8]<<8|s[9],o=s[15],a=s[16],i=s[17],l=`#${o.toString(16).padStart(2,"0")}${a.toString(16).padStart(2,"0")}${i.toString(16).padStart(2,"0")}`,c=0!==s[21];let u=22;for(;u<s.length&&0!==s[u];)u++;const f=u>22?new TextDecoder("utf-8").decode(s.subarray(22,u)):"";n.push({index:t,startPosition:e,endPosition:r,color:l,name:f,locked:c})}o+=l}return{cuePoints:e,loops:n}}(i.data);e.cuePoints=t.cuePoints,e.loops=t.loops}const l=n.get("Serato BeatGrid");return l&&(e.beatGrid=function(t){if(t.length<14)return[];const e=new ArrayBuffer(t.length);new Uint8Array(e).set(t);const n=new DataView(e),r=[],o=n.getUint32(2,!1);if(0===o)return[];let a=6;const i=o-1;for(let l=0;l<i&&a+8<=t.length;l++){const t=n.getFloat32(a,!1),e=n.getUint32(a+4,!1);a+=8,r.push({position:t,beatsUntilNextMarker:e,bpm:0})}if(a+8<=t.length){const t=n.getFloat32(a,!1),e=n.getFloat32(a+4,!1);a+=8,r.push({position:t,beatsUntilNextMarker:0,bpm:e});for(let n=0;n<r.length-1;n++){const t=r[n],e=r[n+1];if(t.beatsUntilNextMarker>0){const n=e.position-t.position;n>0&&(t.bpm=Math.round(t.beatsUntilNextMarker/n*60*100)/100)}}}return r}(l.data)),e}export{i as readSeratoMetadata};
