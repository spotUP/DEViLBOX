import{aB as t}from"./index-zx6LJBPK.js";import"./vendor-react-DkDaD07v.js";import"./vendor-utils-XMmR-oGw.js";import"./vendor-tone-CADp_hfL.js";import"./vendor-ui-uomqNFY-.js";const e=3546895,n=Math.round(e/1712),o=Math.round(e/428);function r(t,e){return t[e]<<8|t[e+1]}function s(t,e){return(t[e]<<24|t[e+1]<<16|t[e+2]<<8|t[e+3])>>>0}function a(t){return t<128?t:t-256}function l(t){return!(t.length<4058)&&(46===t[3014]&&70===t[3015]&&78===t[3016]&&76===t[3017])}function f(e,f){if(!l(e))return null;const i=[];for(let t=0;t<85;t++)i.push(r(e,2786+2*t));i[37];const u=a(e[3003]),h=Math.max(1,Math.min(15,u>0?u:3)),c=[];for(let t=0;t<64;t++){const n=new Int8Array(16);for(let o=0;o<16;o++)n[o]=a(e[3018+16*t+o]);c.push(n)}const m=[],p=[];for(let t=0;t<4;t++)p.push(r(e,4042+4*t)),m.push(r(e,4042+4*t+2));const g=[];let d=4058;for(let t=0;t<4;t++){const n=m[t]/2,o=[];for(let t=0;t<n;t++)o.push({blockNumber:e[d],transpose:a(e[d+1])}),d+=2;g.push({loopPosition:p[t],entries:o})}if(d+4>e.length)return null;const y=s(e,d);d+=4;const M=Math.floor(y/64),b=[];for(let t=0;t<M;t++){const t=[];for(let n=0;n<16;n++)t.push({note:e[d],instrument:e[d+1],effect:e[d+2],effectArg:e[d+3]}),d+=4;b.push(t)}if(d+256>e.length)return null;const A=new Array(128).fill(0);for(let t=1;t<=127;t++)A[t]=r(e,d+2*(t-1));const S=r(e,d+254);d+=256;const v=d,w=[];for(let t=0;t<128&&A[t]!==S;t++){const n=v+A[t];if(n+88>e.length)break;let o=n;const s=2*r(e,o);o+=2;const a=r(e,o);o+=2;let l=2*r(e,o);o+=2,a+l>=s&&s>0&&(l=s>a?s-a:0),o+=15,o+=15;const f=r(e,o);o+=2;const i=e[o];o++;const u=7&e[o];o++;const h=new Uint8Array(e.buffer,e.byteOffset+o,48);w.push({sampleLength:s,repeatStart:a,repeatLength:l,pitchBend:f,isSample:255===i,sampleNumber:u,table:h})}if(d=v+S,d+4>e.length)return null;const L=s(e,d);d+=4;const C=Math.floor(L/256),P=[];for(let t=0;t<C&&!(d+256>e.length);t++){const t=new Int8Array(256);for(let n=0;n<256;n++)t[n]=a(e[d+n]);P.push(t),d+=256}if(d+=64,d+32>e.length);else{const t=[];for(let o=0;o<8;o++)t.push(s(e,d+4*o));d+=32;const n=d;for(const o of w){if(!o||!o.isSample)continue;const r=o.sampleNumber;if(r>=8)continue;const s=n+t[r];s+o.sampleLength>e.length||(o.sampleData=new Int8Array(e.buffer,e.byteOffset+s,o.sampleLength))}}const T=w.filter(t=>null!==t),k=[];for(let r=0;r<T.length;r++){const e=T[r],s=r+1;if(e.isSample&&e.sampleData&&e.sampleLength>0){const n=new Uint8Array(e.sampleLength);for(let t=0;t<e.sampleLength;t++)n[t]=255&e.sampleData[t];const a=e.repeatLength>2,l=a?e.repeatStart:0,f=a?e.repeatStart+e.repeatLength:0;k.push(t(s,`Sample ${r}`,n,64,o,l,f))}else if(!e.isSample&&e.sampleLength>0&&P.length>0){const o=void 0!==e.table[0]&&255!==e.table[0]?e.table[0]:0,a=P[Math.max(0,Math.min(o,P.length-1))],l=Math.min(e.sampleLength,256),f=new Uint8Array(l);for(let t=0;t<l;t++)f[t]=255&a[t%256];k.push(t(s,`Synth ${r}`,f,64,n,0,l))}else k.push({id:s,name:`Instrument ${r}`,type:"synth",synthType:"Synth",effects:[],volume:-6,pan:0})}const I=Math.max(...g.map(t=>t.entries.length),1),$=[];for(let t=0;t<I;t++){const e=[[],[],[],[]];for(let n=0;n<4;n++){const o=g[n].entries,r=o.length;let s=t;if(0===r){for(let t=0;t<16;t++)e[n].push({note:0,instrument:0,volume:0,effTyp:0,eff:0,effTyp2:0,eff2:0});continue}if(s>=r){const e=g[n].loopPosition<r?g[n].loopPosition:0,o=r-e;s=o>0?e+(t-e)%o:r-1}const a=o[s],l=a.blockNumber,f=a.transpose,i=l<b.length?b[l]:null;for(let t=0;t<16;t++){if(!i){e[n].push({note:0,instrument:0,volume:0,effTyp:0,eff:0,effTyp2:0,eff2:0});continue}const o=i[t];let r=0;if(o.note>0){const t=o.note+f;r=Math.max(1,Math.min(96,t))}const s=o.instrument<T.length?o.instrument+1:0;let a=0,l=0,u=0,h=0;switch(o.effect){case 1:a=15,l=Math.max(1,15&o.effectArg);break;case 2:break;case 3:a=1,l=255&o.effectArg;break;case 4:a=2,l=255&o.effectArg;break;case 5:a=3,l=o.effectArg;break;case 6:{const t=Math.round((63&o.effectArg)/63*64);e[n].push({note:r,instrument:s,volume:16+Math.min(64,t),effTyp:0,eff:0,effTyp2:0,eff2:0});continue}case 7:a=16,l=Math.min(64,Math.round((63&o.effectArg)/63*64));break;case 8:{const t=63&o.effectArg,e=t<c.length?c[t]:null;if(e){a=0,l=Math.max(0,Math.min(15,e[1]>0?e[1]:0))<<4|Math.max(0,Math.min(15,e[2]>0?e[2]:0))}break}}e[n].push({note:r,instrument:s,volume:0,effTyp:a,eff:l,effTyp2:u,eff2:h})}}$.push({id:`pattern-${t}`,name:`Position ${t}`,length:16,channels:e.map((t,e)=>({id:`channel-${e}`,name:`Channel ${e+1}`,muted:!1,solo:!1,collapsed:!1,volume:100,pan:0===e||3===e?-50:50,instrumentId:null,color:null,rows:t})),importMetadata:{sourceFormat:"DM2",sourceFile:f,importedAt:(new Date).toISOString(),originalChannelCount:4,originalPatternCount:M,originalInstrumentCount:T.length}})}0===$.length&&$.push({id:"pattern-0",name:"Pattern 0",length:16,channels:Array.from({length:4},(t,e)=>({id:`channel-${e}`,name:`Channel ${e+1}`,muted:!1,solo:!1,collapsed:!1,volume:100,pan:0===e||3===e?-50:50,instrumentId:null,color:null,rows:Array.from({length:16},()=>({note:0,instrument:0,volume:0,effTyp:0,eff:0,effTyp2:0,eff2:0}))})),importMetadata:{sourceFormat:"DM2",sourceFile:f,importedAt:(new Date).toISOString(),originalChannelCount:4,originalPatternCount:0,originalInstrumentCount:0}});return{name:f.replace(/\.[^/.]+$/,""),format:"DM2",patterns:$,instruments:k,songPositions:$.map((t,e)=>e),songLength:$.length,restartPosition:0,numChannels:4,initialSpeed:h,initialBPM:125,linearPeriods:!1}}export{l as isDeltaMusic2Format,f as parseDeltaMusic2File};
