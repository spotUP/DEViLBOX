import{aB as n,aD as e,aC as t}from"./index-zx6LJBPK.js";import"./vendor-react-DkDaD07v.js";import"./vendor-utils-XMmR-oGw.js";import"./vendor-tone-CADp_hfL.js";import"./vendor-ui-uomqNFY-.js";const r=31,o=64,s=1084,a=[-50,50,50,-50],i=new TextDecoder("iso-8859-1");function l(n,e,t){let r=e;for(;r<e+t&&0!==n[r];)r++;return i.decode(n.subarray(e,r)).trim()}function u(n,e){return n[e]<<8|n[e+1]}function f(n,e){return(n[e]<<24|n[e+1]<<16|n[e+2]<<8|n[e+3])>>>0}function c(n,e){return String.fromCharCode(n[e],n[e+1],n[e+2],n[e+3])}function m(n){if(n.byteLength<12)return!1;const e=new Uint8Array(n);return"FORM"===c(e,0)&&"MODL"===c(e,8)||80===e[0]&&82===e[1]&&84===e[2]&&0!==e[3]}async function p(i,c){const p=new Uint8Array(i);if(!m(i))throw new Error("PT36Parser: not a valid ProTracker 3.6 / PreTracker file");if(80===p[0]&&82===p[1]&&84===p[2]&&0!==p[3])return function(n,e){const t=l(n,20,16)||e.replace(/\.[^/.]+$/,""),r=[{id:1,name:"Sample 1",type:"sample",synthType:"Sampler",effects:[],volume:-60,pan:0}],o=Array.from({length:64},()=>({note:0,instrument:0,volume:0,effTyp:0,eff:0,effTyp2:0,eff2:0})),s={id:"pattern-0",name:"Pattern 0",length:64,channels:Array.from({length:4},(n,e)=>({id:`channel-${e}`,name:`Channel ${e+1}`,muted:!1,solo:!1,collapsed:!1,volume:100,pan:a[e],instrumentId:null,color:null,rows:o})),importMetadata:{sourceFormat:"MOD",sourceFile:e,importedAt:(new Date).toISOString(),originalChannelCount:4,originalPatternCount:1,originalInstrumentCount:0}};return{name:`${t} [PreTracker]`,format:"MOD",patterns:[s],instruments:r,songPositions:[0],songLength:1,restartPosition:0,numChannels:4,initialSpeed:6,initialBPM:125,linearPeriods:!1}}(p,c);let h=null,d=null,g=null,y="3.6",P=12,b=!0;for(;P+8<=p.byteLength;){const n=f(p,P);let e=f(p,P+4);b&&(e=e>4?e-4:0,b=!1);const t=e>8?e-8:0,r=P+8,o=Math.min(r+t,p.byteLength);switch(n){case 1447383635:if(t>6){const n=r+4;if(80===p[n]&&84===p[n+1]){const e=l(p,n+2,o-(n+2));e.length>0&&(y=e)}}break;case 1229866575:o-r>=64&&(d=p.subarray(r,o));break;case 1129139796:g=p.subarray(r,o);break;case 1347699796:h=p.subarray(r,p.byteLength)}P+=e>0?e:8}if(!h)throw new Error("PT36Parser: PTDT chunk not found");let T="",L=0,C=0,M=0;d&&d.byteLength>=64&&(T=l(d,0,32),L=u(d,38),C=u(d,40),M=u(d,42));const v=!!(256&M);if(g&&g.byteLength>0){const n=l(g,0,Math.min(32,g.byteLength));n.length}const w=function(i,f,c,m,p,h){if(i.byteLength<s)throw new Error("PT36Parser: PTDT chunk too small to be a valid MOD");const d=l(i,0,20),g=c||d||f.replace(/\.[^/.]+$/,""),y=[];for(let n=0;n<r;n++){const e=20+30*n,t=l(i,e,22),r=u(i,e+22),o=15&i[e+24],s=o>7?o-16:o,a=Math.min(i[e+25],64),f=u(i,e+26),c=u(i,e+28);y.push({name:t,lengthWords:r,finetune:s,volume:a,loopStartWords:f,loopLenWords:c})}const P=i[950],b=i[951],T=[];let L=0;for(let n=0;n<128;n++){const e=i[952+n];T.push(e),n<P&&e>L&&(L=e)}const C=L+1;l(i,1080,4);const M=[];for(let n=0;n<C;n++){const r=s+n*o*4*4,a=[];for(let n=0;n<o;n++){const o=[];for(let s=0;s<4;s++){const a=r+4*(4*n+s);if(a+3>=i.byteLength){o.push({note:0,instrument:0,effTyp:0,eff:0});continue}const l=i[a],u=i[a+1],f=i[a+2],c=(15&l)<<8|u,m=240&l|f>>4,p=15&f,h=i[a+3],d=c>0?e(c):0,g=t(d);o.push({note:g,instrument:m,effTyp:p,eff:h})}a.push(o)}M.push(a)}let v=6,w=125;if(p>0&&h)w=p;else{const n=function(n,e){let t=6,r=125,o=!1,s=!1;const a=e[0]??0,i=n[a];if(!i)return{speed:t,bpm:r};const l=Math.min(16,i.length);for(let u=0;u<l&&(!o||!s);u++)for(const n of i[u])15===n.effTyp&&0!==n.eff&&(n.eff<32?o||(t=n.eff,o=!0):s||(r=n.eff,s=!0));return{speed:t,bpm:r}}(M,T);v=n.speed,w=n.bpm}const S=M.map((n,e)=>{const t=Array.from({length:4},(e,t)=>{const r=n.map(n=>{const e=n[t];return{note:e.note,instrument:e.instrument,volume:0,effTyp:e.effTyp,eff:e.eff,effTyp2:0,eff2:0}});return{id:`channel-${t}`,name:`Channel ${t+1}`,muted:!1,solo:!1,collapsed:!1,volume:100,pan:a[t],instrumentId:null,color:null,rows:r}});return{id:`pattern-${e}`,name:`Pattern ${e}`,length:o,channels:t,importMetadata:{sourceFormat:"PT36",sourceFile:f,importedAt:(new Date).toISOString(),originalChannelCount:4,originalPatternCount:C,originalInstrumentCount:r}}});let D=s+C*o*4*4;const $=[];for(let e=0;e<r;e++){const t=y[e],r=e+1,o=2*t.lengthWords;if(0===o){$.push({id:r,name:t.name||`Sample ${r}`,type:"sample",synthType:"Sampler",effects:[],volume:-60,pan:0});continue}const s=Math.min(D+o,i.byteLength),a=i.subarray(D,s);D+=o;const l=2*t.loopStartWords,u=2*t.loopLenWords,f=t.loopLenWords>1,c=f?l:0,m=f?l+u:0;$.push(n(r,t.name||`Sample ${r}`,a,t.volume,8287,c,m))}const k=T.slice(0,P);return{name:g,format:"MOD",patterns:S,instruments:$,songPositions:k,songLength:P,restartPosition:b,numChannels:4,initialSpeed:v,initialBPM:w,linearPeriods:!1}}(h,c,T,0,C,v);return w}export{m as isPT36Format,p as parsePT36File};
