import{aB as e}from"./index-zx6LJBPK.js";import"./vendor-react-DkDaD07v.js";import"./vendor-utils-XMmR-oGw.js";import"./vendor-tone-CADp_hfL.js";import"./vendor-ui-uomqNFY-.js";function t(e,t){return e.getUint8(t)}function n(e,t){return e.getUint16(t,!0)}function r(e,t){return e.getUint32(t,!0)}function o(e,t,n){let r="";for(let o=0;o<n;o++){const n=e.getUint8(t+o);if(0===n)break;r+=String.fromCharCode(n)}return r.trim()}const f=[13,10,26],a=16,i=256,s=[0,1,2,3,4,5,5,10,10,5,0,14,14,0,0,15];function l(e){if(e.byteLength<98)return!1;const r=new DataView(e);for(let n=0;n<4;n++)if(t(r,n)!=="FARÃ¾".charCodeAt(n))return!1;for(let n=0;n<3;n++)if(t(r,44+n)!==f[n])return!1;return!(n(r,47)<98)}function c(e){const t=e>>4&15;let n=15&e;switch(t){case 0:case 13:case 14:default:return{effTyp:0,eff:0};case 1:case 2:return n|=240,{effTyp:s[t],eff:n};case 3:return 0!==n&&(n=Math.min(255,Math.floor(60/n))),{effTyp:s[t],eff:n};case 4:return n=Math.floor(6/(1+(15&n)))+1,{effTyp:s[t],eff:n};case 5:case 8:case 9:case 15:return{effTyp:s[t],eff:n};case 6:return n=Math.min(255,8*n),{effTyp:s[t],eff:n};case 7:return n=Math.min(15,Math.floor(8*n/16)),{effTyp:s[t],eff:Math.min(255,8*(15&e))};case 10:return{effTyp:0,eff:0,volColOverride:Math.min(255,4+(n<<2)),skipEffect:!0};case 11:return n|=128,{effTyp:s[t],eff:n};case 12:return n=Math.floor(6/(1+n))+1,n=208|15&n,{effTyp:s[t],eff:n}}}async function u(f,s){if(!l(f))throw new Error("FARParser: file does not pass FAR format validation");const u=new DataView(f),p=new Uint8Array(f),m=o(u,4,40)||s.replace(/\.[^/.]+$/,""),y=n(u,47),d=t(u,75),g=n(u,96),M=d>0?d:6,w=[],T=[];for(let e=0;e<a;e++){w.push(0===t(u,50+e));const n=8+((15&t(u,76+e))<<4);T.push(Math.round((n-128)/128*100))}const v=98+g;if(f.byteLength<v+771)throw new Error("FARParser: file truncated reading order header");const A=t(u,v+257),C=t(u,v+258),b=[];for(let e=0;e<A;e++){const n=t(u,v+e);if(255===n)break;b.push(n)}const P=[];for(let e=0;e<i;e++)P.push(n(u,v+259+2*e));let F=y;const L=new Array(i).fill(null);for(let e=0;e<i;e++){const n=P[e];if(0===n)continue;if(F+n>f.byteLength){F+=n;continue}const r=Math.floor((n-2)/64);if(r<=0){F+=n;continue}const o=t(u,F);F+=2;let l=-1;o>0&&o<r-2&&(l=o+1);const h=Array.from({length:a},(e,t)=>({id:`channel-${t}`,name:`Channel ${t+1}`,muted:w[t],solo:!1,collapsed:!1,volume:100,pan:T[t],instrumentId:null,color:null,rows:[]}));for(let e=0;e<r;e++)for(let n=0;n<a;n++){const r=F+4*(e*a+n),o=t(u,r),f=t(u,r+1),i=t(u,r+2),s=t(u,r+3);let p=0,m=0;o>0&&o<=72&&(p=o+36,m=f+1);let y=0;if(i>0&&i<=16){y=16+Math.round(64*(i-1)/15)}const d=c(s);let g=y,M=d.effTyp,w=d.eff;if(d.skipEffect&&void 0!==d.volColOverride){g=16+Math.min(64,d.volColOverride),M=0,w=0}const T={note:p,instrument:m,volume:g,effTyp:M,eff:w,effTyp2:0,eff2:0};e===l&&(0===T.effTyp&&0===T.eff?(T.effTyp=13,T.eff=0):(T.effTyp2=13,T.eff2=0)),h[n].rows.push(T)}F+=r*a*4,L[e]={id:`pattern-${e}`,name:`Pattern ${e}`,length:r,channels:h,importMetadata:{sourceFormat:"FAR",sourceFile:s,importedAt:(new Date).toISOString(),originalChannelCount:a,originalPatternCount:i,originalInstrumentCount:64}}}if(F+8>f.byteLength)return h(m,b,C,L,[],M,a);const U=new Uint8Array(8);for(let e=0;e<8;e++)U[e]=t(u,F+e);F+=8;const S=[],$=new Array(65).fill(null);for(let n=0;n<64;n++){if(!!!(U[n>>3]&1<<(7&n)))continue;if(F+48>f.byteLength)break;const a=F,i=o(u,a,32)||`Sample ${n+1}`,s=r(u,a+32),l=t(u,a+37);let c=r(u,a+38),h=r(u,a+42);F+=48;const m=!!(1&t(u,a+46)),y=!!(8&t(u,a+47))&&h>c,d=4*l,g=s;if(0===g||F+g>f.byteLength)$[n+1]={id:n+1,name:i,type:"sample",synthType:"Sampler",effects:[],volume:-60,pan:0},F+=g;else{if(m){const t=Math.floor(g/2),r=y?Math.floor(c/2):0,o=y?Math.min(t,Math.floor(h/2)):0,f=new Uint8Array(t);for(let e=0;e<t;e++){const t=p[F+2*e],n=p[F+2*e+1]<<8|t,r=n<32768?n:n-65536,o=Math.round(r/256);f[e]=o<0?o+256:o}$[n+1]=e(n+1,i,f,d,16726,y?r:0,y?o:0)}else{const t=p.subarray(F,F+g);$[n+1]=e(n+1,i,t,d,16726,y?c:0,y?Math.min(g,h):0)}F+=g}}for(let e=1;e<=64;e++){const t=$[e];null!==t&&S.push(t)}return h(m,b,C,L,S,M,a)}function h(e,t,n,r,o,f,a){return{name:e,format:"MOD",patterns:r.filter(e=>null!==e),instruments:o,songPositions:t.length>0?t:[0],songLength:t.length,restartPosition:n,numChannels:a,initialSpeed:f,initialBPM:80,linearPeriods:!1}}export{l as isFARFormat,u as parseFARFile};
