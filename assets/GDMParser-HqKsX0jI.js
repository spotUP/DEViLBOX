import{aB as t}from"./index-zx6LJBPK.js";import"./vendor-react-DkDaD07v.js";import"./vendor-utils-XMmR-oGw.js";import"./vendor-tone-CADp_hfL.js";import"./vendor-ui-uomqNFY-.js";function e(t,e){return t.getUint8(e)}function n(t,e){return t.getUint16(e,!0)}function o(t,e){return t.getUint32(e,!0)}function r(t,e,n){let o="";for(let r=0;r<n;r++){const n=t.getUint8(e+r);if(0===n)break;o+=String.fromCharCode(n)}return o.trim()}const a=[0,1,2,3,4,5,6,7,29,9,10,11,12,13,14,15,0,0,27,16,21,0,0,0,0,0,0,0,0,0,30,31];function s(t){if(t.byteLength<157)return!1;const o=new DataView(t);if(71!==e(o,0)||68!==e(o,1)||77!==e(o,2)||254!==e(o,3))return!1;if(13!==e(o,68)||10!==e(o,69)||26!==e(o,70))return!1;if(71!==e(o,71)||77!==e(o,72)||70!==e(o,73)||83!==e(o,74))return!1;if(1!==e(o,75)||0!==e(o,76))return!1;const r=n(o,116);if(r<1||r>9)return!1;let a=0;for(let n=0;n<32;n++){if(255===e(o,81+n)){a=n;break}31===n&&(a=32)}return 0!==a}class i{pos=0;data;constructor(t){this.data=t}canRead(t){return this.pos+t<=this.data.length}readU8(){return this.pos>=this.data.length?0:this.data[this.pos++]}}function l(t){if(t>15)return 0;const e=Math.min(16*t+8,255);return Math.round(100*(e-128)/128)}function f(t,e){const n=31&t;let o=e,r=0,s=0,i=n<a.length?a[n]:0;switch(n){case 1:case 2:o>=224&&(o=223);break;case 5:case 6:240&o&&(o&=240);break;case 12:o=Math.min(o,64),r=1,s=o,i=0,o=0;break;case 14:switch(e>>4){case 8:i=1,o=224|15&e;break;case 9:i=2,o=224|15&e}break;case 18:i=14,o=144|15&e;break;case 30:1===e?o=145:128==(240&e)||(i=0,o=0)}return{effTyp:i,eff:o,volcmd:r,vol:s}}async function c(a,c){if(!s(a))throw new Error("GDMParser: file does not pass GDM format validation");const h=new DataView(a),p=new Uint8Array(a),m=r(h,4,32)||c.replace(/\.[^/.]+$/,"");r(h,36,32),e(h,79),e(h,80),e(h,113);const d=e(h,114),g=e(h,115),y=n(h,116),M=o(h,118),b=e(h,122),v=o(h,123),w=e(h,127),D=o(h,128),U=o(h,132),C=b+1,T=w+1,k=e(h,136)+1;let O=32;for(let t=0;t<32;t++)if(255===e(h,81+t)){O=t;break}const S=[];for(let t=0;t<O;t++)S.push(l(e(h,81+t)));n(h,77);const $=[];if(M+C<=a.byteLength)for(let t=0;t<C;t++){const n=e(h,M+t);if(255===n)break;$.push(254===n?254:n)}const P=$.filter(t=>254!==t),A=[];let I=D;for(let t=0;t<k&&!(I+62>a.byteLength);t++)A.push({name:r(h,I+0,32)||`Sample ${t+1}`,fileName:r(h,I+32,12),length:o(h,I+45),loopBegin:o(h,I+49),loopEnd:o(h,I+53),flags:e(h,I+57),c4Hertz:n(h,I+58),volume:e(h,I+60),panning:e(h,I+61)}),I+=62;let L=U;const B=[];for(let t=0;t<A.length;t++){const e=A[t],n=e.length;if(0===n||L+n>a.byteLength){B.push(null),L+=n;continue}const o=p.subarray(L,L+n);if(2&e.flags){const t=Math.floor(n/2),e=new Uint8Array(t);for(let n=0;n<t;n++){const t=o[2*n+1];e[n]=128^t}B.push(e)}else{const t=new Uint8Array(n);for(let e=0;e<n;e++)t[e]=128^o[e];B.push(t)}L+=n}const E=[];for(let e=0;e<A.length;e++){const n=A[e],o=e+1,r=B[e];if(!r||0===r.length){E.push({id:o,name:n.name,type:"sample",synthType:"Sampler",effects:[],volume:-60,pan:0});continue}const a=!!(1&n.flags)&&n.loopEnd>n.loopBegin,s=!!(2&n.flags);let i=s?Math.floor(n.loopBegin/2):n.loopBegin,l=s?Math.floor((n.loopEnd-1)/2):n.loopEnd-1;l=Math.min(l,r.length);const f=4&n.flags?Math.min(n.volume,64):64,c=n.c4Hertz>0?n.c4Hertz:8363;E.push(t(o,n.name,r,f,c,a?i:0,a?l:0))}const j=[];let F=v;for(let t=0;t<T&&!(F+2>a.byteLength);t++){const e=n(h,F);F+=2;const o=e>2?e-2:0;if(0===o||F+o>a.byteLength){F+=o,j.push(u(t,O,c,T,A.length));continue}const r=p.subarray(F,F+o);F+=o;const s=new i(r),l=Array.from({length:O},()=>[]);for(let t=0;t<64;t++){const t=new Map;for(;s.canRead(1);){const e=s.readU8();if(0===e)break;const n=31&e;if(n>=O){if(32&e&&(s.readU8(),s.readU8()),64&e){let t=!0;for(;t&&s.canRead(2);){const e=s.readU8();s.readU8(),t=!!(32&e)}}continue}let o=t.get(n)??{note:0,instrument:0,volume:0,effTyp:0,eff:0,effTyp2:0,eff2:0};if(32&e){const t=s.readU8(),e=s.readU8();if(0!==t){const e=(127&t)-1,n=(15&e)+12*(e>>4)+12+1;o={...o,note:n}}0!==e&&(o={...o,instrument:e})}if(64&e){let t=!0,e=!0;for(;t&&s.canRead(2);){const n=s.readU8(),r=s.readU8();t=!!(32&n);const{effTyp:a,eff:i,volcmd:l,vol:c}=f(n,r);e?(o=0!==l?{...o,volume:c}:{...o,effTyp:a,eff:i},e=!1):0!==l?o={...o,volume:c}:0===o.effTyp2&&(o={...o,effTyp2:a,eff2:i})}}t.set(n,o)}for(let e=0;e<O;e++)l[e].push(t.get(e)??{note:0,instrument:0,volume:0,effTyp:0,eff:0,effTyp2:0,eff2:0})}const m=l.map((t,e)=>({id:`channel-${e}`,name:`Channel ${e+1}`,muted:!1,solo:!1,collapsed:!1,volume:100,pan:S[e]??0,instrumentId:null,color:null,rows:t}));j.push({id:`pattern-${t}`,name:`Pattern ${t}`,length:64,channels:m,importMetadata:{sourceFormat:"GDM",sourceFile:c,importedAt:(new Date).toISOString(),originalChannelCount:O,originalPatternCount:T,originalInstrumentCount:A.length}})}const G={1:"MOD",2:"MOD",3:"S3M",4:"MOD",5:"MOD",6:"MOD",7:"MOD",8:"MED",9:"MOD"}[y]??"MOD",R="S3M"===G||"IT"===G;return{name:m,format:G,patterns:j,instruments:E,songPositions:P,songLength:P.length,restartPosition:0,numChannels:O,initialSpeed:d>0?d:6,initialBPM:g>0?g:125,linearPeriods:R}}function u(t,e,n,o,r){const a={note:0,instrument:0,volume:0,effTyp:0,eff:0,effTyp2:0,eff2:0};return{id:`pattern-${t}`,name:`Pattern ${t}`,length:64,channels:Array.from({length:e},(t,e)=>({id:`channel-${e}`,name:`Channel ${e+1}`,muted:!1,solo:!1,collapsed:!1,volume:100,pan:0,instrumentId:null,color:null,rows:Array.from({length:64},()=>({...a}))})),importMetadata:{sourceFormat:"GDM",sourceFile:n,importedAt:(new Date).toISOString(),originalChannelCount:e,originalPatternCount:o,originalInstrumentCount:r}}}export{s as isGDMFormat,c as parseGDMFile};
