function t(t,e){const n=[],r=t[e]<<4|15&t[e+1],o=(t[e+2]<<4|15&t[e+3])<<8|r;for(let i=0;i<16;i++)n.push(!!(o>>i&1));return n}async function e(e){const n=new DataView(e),r=new Uint8Array(e),o=n.getUint32(0,!1),i=597185654===o;if(!i&&!(2269352194===o))throw new Error(`Invalid TD-3 file: bad magic bytes (0x${o.toString(16).toUpperCase()})`);let l="";for(let t=8;t<20;t+=2){const e=n.getUint16(t,!1);if(0===e)break;l+=String.fromCharCode(e)}let a="";for(let t=20;t<32;t+=2){const e=n.getUint16(t,!1);if(0===e)break;a+=String.fromCharCode(e)}const s=[];if(i){let n=32;for(;n<=e.byteLength-114;){const e=n+4,o=[],i=e,l=e+32,a=e+64,f=!!(r[e+96]<<4|15&r[e+97]),c=r[e+98]<<4|15&r[e+99],h=t(r,e+102),p=t(r,e+106);let u=0,g=null;for(let t=0;t<16;t++){if(h[t]){const e=i+2*u,n=r[e]<<4|15&r[e+1],s=Math.floor(n/12),f=n%12,c=60===n,h={note:p[t]?null:{value:f,octave:Math.max(0,Math.min(2,s-2)),upperC:c},accent:0!==r[l+2*u+1],slide:0!==r[a+2*u+1],tie:!1};o.push(h),g=h,u++}else g&&g.note?o.push({...g,tie:!0}):o.push({note:null,accent:!1,slide:!1,tie:!1})}s.push({index:s.length,name:`Pattern ${s.length+1}`,steps:o,length:c||16,tempo:120,triplet:f}),n+=114}}else{let t=32;for(;t<e.byteLength-100;)0===r[t+2]&&112===r[t+3]?t+=126:t++}return{name:l,version:a,patterns:s}}export{e as parseTD3File};
