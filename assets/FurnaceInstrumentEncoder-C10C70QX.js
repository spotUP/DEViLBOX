const t=new Set([0,1,13,14,19,32,33,55]);class i{buffer=[];writeUint8(t){this.buffer.push(255&t)}writeUint16(t){this.buffer.push(255&t),this.buffer.push(t>>8&255)}writeUint32(t){this.buffer.push(255&t),this.buffer.push(t>>8&255),this.buffer.push(t>>16&255),this.buffer.push(t>>24&255)}writeInt32(t){this.writeUint32(t)}writeInt8(t){this.writeUint8(t<0?t+256:t)}getPosition(){return this.buffer.length}patchUint32(t,i){this.buffer[t]=255&i,this.buffer[t+1]=i>>8&255,this.buffer[t+2]=i>>16&255,this.buffer[t+3]=i>>24&255}toUint8Array(){return new Uint8Array(this.buffer)}}function e(t){return void 0===t?0:"number"==typeof t?255&t:t?1:0}function n(n,r="Instrument"){const w=new i;w.writeUint8(240),w.writeUint8(177),w.writeUint8(1),w.writeUint8(n.chipType);const s=w.getPosition();w.writeUint32(0),w.writeUint32(0),w.writeUint32(0),w.writeUint32(0),w.writeUint32(0),w.writeUint32(0);const o=(new TextEncoder).encode(r);w.writeUint32(o.length);for(const t of o)w.writeUint8(t);let U=0;if(t.has(n.chipType)&&n.operators&&n.operators.length>0){U=w.getPosition(),w.writeUint8(n.algorithm||0),w.writeUint8(n.feedback||0),w.writeUint8(n.fms||0),w.writeUint8(n.ams||0),w.writeUint8(n.fms2||0),w.writeUint8(n.ams2||0),w.writeUint8(n.ops||4),w.writeUint8(n.opllPreset||0);for(let t=0;t<4;t++)if(t<n.operators.length){const i=n.operators[t];w.writeUint8(i.enabled?1:0),w.writeUint8(e(i.am)),w.writeUint8(i.ar||0),w.writeUint8(i.dr||0),w.writeUint8(i.mult||0),w.writeUint8(i.rr||0),w.writeUint8(i.sl||0),w.writeUint8(i.tl||0),w.writeUint8(i.dt2||0),w.writeUint8(i.rs||0),w.writeInt8(i.dt||0),w.writeUint8(i.d2r||0),w.writeUint8(i.ssg||0),w.writeUint8(e(i.dam)),w.writeUint8(e(i.dvb)),w.writeUint8(e(i.egt)),w.writeUint8(i.ksl||0),w.writeUint8(e(i.sus)),w.writeUint8(e(i.vib)),w.writeUint8(i.ws||0),w.writeUint8(e(i.ksr)),w.writeUint8(i.kvs||0),w.writeUint8(0),w.writeUint8(0)}else for(let i=0;i<24;i++)w.writeUint8(0)}let f=0;if(n.macros&&n.macros.length>0){f=w.getPosition();const t=new Array(15).fill(null);for(const i of n.macros){const e=i.code??i.type;void 0!==e&&e>=0&&e<15&&(t[e]=i)}for(let i=0;i<15;i++){const e=t[i];if(e&&e.data&&e.data.length>0){w.writeUint8(e.data.length),w.writeUint8(e.delay??0),w.writeUint8(e.speed??1),w.writeUint8(void 0!==e.loop?e.loop:255),w.writeUint8(void 0!==e.release?e.release:255),w.writeUint8(e.mode??0),w.writeUint8(e.open?1:0);for(const t of e.data)w.writeInt32(t)}else for(let t=0;t<7;t++)w.writeUint8(0)}}let a=0;if(2===n.chipType&&n.gb){a=w.getPosition();const t=n.gb;w.writeUint8(t.envVol||0),w.writeUint8(t.envDir||0),w.writeUint8(t.envLen||0),w.writeUint8(t.soundLen||0),w.writeUint8(t.softEnv?1:0),w.writeUint8(t.alwaysInit?1:0),w.writeUint8(0);const i=t.hwSeq?.length??0;if(w.writeUint8(i),t.hwSeq)for(const e of t.hwSeq)w.writeUint8(e.cmd),w.writeUint16(e.data)}if(3===n.chipType&&n.c64){a=w.getPosition();const t=n.c64;let i=0;t.triOn&&(i|=1),t.sawOn&&(i|=2),t.pulseOn&&(i|=4),t.noiseOn&&(i|=8),w.writeUint8(i),w.writeUint8(t.a||0),w.writeUint8(t.d||0),w.writeUint8(t.s||0),w.writeUint8(t.r||0),w.writeUint16(t.duty||0),w.writeUint8(t.ringMod?1:0),w.writeUint8(t.oscSync?1:0);let e=0;t.toFilter&&(e|=1),t.initFilter&&(e|=2);"dutyIsAbs"in t&&t.dutyIsAbs&&(e|=4);(t.filterIsAbs??!1)&&(e|=8);(t.noTest??!1)&&(e|=16),w.writeUint8(e),w.writeUint8(t.filterResonance??t.filterRes??0),w.writeUint16(t.filterCutoff??0);let r=0;t.filterHP&&(r|=1),t.filterLP&&(r|=2),t.filterBP&&(r|=4),t.filterCh3Off&&(r|=8),w.writeUint8(r)}if(17===n.chipType&&n.n163){a=w.getPosition();const t=n.n163;w.writeUint32(t.wave||0),w.writeUint32(t.wavePos||0),w.writeUint32(t.waveLen||0),w.writeUint8(t.waveMode||0),w.writeUint8(t.perChPos?1:0)}if(15===n.chipType&&n.fds){a=w.getPosition();const t=n.fds;w.writeUint32(t.modSpeed||0),w.writeUint32(t.modDepth||0),w.writeUint8(t.initModTableWithFirstWave?1:0);const i=t.modTable||[];for(let e=0;e<32;e++)w.writeInt8(e<i.length?i[e]:0)}if(29===n.chipType&&n.snes){a=w.getPosition();const t=n.snes;w.writeUint8(t.useEnv?1:0),w.writeUint8(t.sus??0),w.writeUint8("number"==typeof t.gainMode?t.gainMode:0),w.writeUint8(t.gain||0),w.writeUint8(t.a||0),w.writeUint8(t.d||0),w.writeUint8(t.s||0),w.writeUint8(t.r||0),w.writeUint8(t.d2??0)}let l=0;if(n.amiga){l=w.getPosition();const t=n.amiga;w.writeUint16(t.initSample??-1);let i=0;if(t.useNoteMap&&(i|=1),t.useSample&&(i|=2),t.useWave&&(i|=4),w.writeUint8(i),w.writeUint8(t.waveLen||0),t.useNoteMap&&t.noteMap)for(let e=0;e<120;e++)if(e<t.noteMap.length){const i=t.noteMap[e];w.writeUint32(i.frequency||0),w.writeUint16(i.sample??-1),w.writeInt8(0),w.writeInt8(0)}else for(let t=0;t<8;t++)w.writeUint8(0)}const h=w.getPosition();return w.patchUint32(s,h),w.patchUint32(s+4,U),w.patchUint32(s+8,f),w.patchUint32(s+12,a),w.patchUint32(s+16,l),w.toUint8Array()}function r(t,i,e){return n(t,i)}export{n as encodeFurnaceInstrument,r as updateFurnaceInstrument};
