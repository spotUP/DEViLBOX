import{aB as e}from"./index-zx6LJBPK.js";import"./vendor-react-DkDaD07v.js";import"./vendor-utils-XMmR-oGw.js";import"./vendor-tone-CADp_hfL.js";import"./vendor-ui-uomqNFY-.js";function t(e,t){return e.getUint8(t)}function n(e,t){return e.getUint16(t,!1)}function o(e,t){return e.getUint32(t,!1)}const r=15,s=[856,808,762,720,678,640,604,570,538,508,480,453,428,404,381,360,339,320,302,285,269,254,240,226,214,202,190,180,170,160,151,143,135,127,120,113];function f(e){if(0===e)return 0;let t=0,n=1/0;for(let o=0;o<s.length;o++){const r=Math.abs(s[o]-e);r<n&&(n=r,t=o)}return t+13}function a(e){if(e.byteLength<444)return!1;const s=new DataView(e.buffer,e.byteOffset,e.byteLength);for(let i=0;i<r;i++){const e=16*i,r=o(s,e),f=n(s,e+4),a=t(s,e+6),l=t(s,e+7),u=o(s,e+8),c=n(s,e+12),h=n(s,e+14);if(r>2097151||1&r)return!1;if(u>2097151||1&u)return!1;if(f>32767)return!1;if(h>32767||1&h)return!1;if(c>2&&c>f)return!1;if(l>64)return!1;if(0!==a)return!1}const f=240;if(0!==t(s,f)||0!==t(s,241)||0!==t(s,242))return!1;const a=t(s,243);if(!a||a>100)return!1;for(let t=0;t<100;t++){if(n(s,244+2*t)%1024!=0)return!1}return!0}function i(s,i){if(!a(s))return null;const l=new DataView(s.buffer,s.byteOffset,s.byteLength),u=[];for(let e=0;e<r;e++){const r=16*e,s=n(l,r+4),f=t(l,r+7),a=o(l,r),i=n(l,r+12);u.push({offset:a,lengthBytes:2*s,volume:f,loopLengthBytes:2*i})}const c=t(l,243),h=[];let m=0;for(let e=0;e<c;e++){const t=n(l,244+2*e)/1024;h.push(t),63!==t&&(m=Math.max(m,t+1))}let p=444;const g=[];for(let e=0;e<m;e++){const e=[];for(let n=0;n<64;n++){const n=[];for(let e=0;e<4;e++){if(p+4>s.byteLength){n.push({note:0,instrument:0,volume:0,effTyp:0,eff:0,effTyp2:0,eff2:0});continue}const e=t(l,p),o=t(l,p+1),r=15&t(l,p+2),a=t(l,p+3);p+=4;const i=255===e&&254===o;if(!i&&240&e){n.push({note:0,instrument:0,volume:0,effTyp:0,eff:0,effTyp2:0,eff2:0});continue}const u=(15&(i?0:e))<<8|o,c=(240&(i?0:e))>>4;let h=0;i?h=97:u>0&&(h=f(u));let m=0,g=a;switch(r){case 0:default:m=0,g=0;break;case 1:m=1;break;case 2:m=2;break;case 3:m=12,g=127&a;break;case 4:m=13;break;case 5:m=11;break;case 6:m=14,g=0;break;case 7:m=14,g=1;break;case 8:m=15}n.push({note:h,instrument:c,volume:0,effTyp:m,eff:g,effTyp2:0,eff2:0})}e.push(n)}g.push(e)}const y=[];for(let t=0;t<r;t++){const n=u[t],o=t+1,r=`Sample ${o}`;if(0===n.lengthBytes||0===n.offset||n.offset>=s.byteLength){y.push({id:o,name:r,type:"sample",synthType:"Sampler",effects:[],volume:0,pan:0});continue}const f=Math.min(n.lengthBytes,s.byteLength-n.offset),a=s.slice(n.offset,n.offset+f);let i=0,l=0;n.loopLengthBytes>4&&(i=Math.max(0,n.lengthBytes-n.loopLengthBytes),l=n.lengthBytes),y.push(e(o,r,a,n.volume,8287,i,l))}const d=[-50,50,50,-50],b=new Map;for(const e of h){if(b.has(e))continue;if(e>=g.length)continue;const t=g[e],n=Array.from({length:4},(e,n)=>{const o=t.map(e=>e[n]);return{id:`channel-${n}`,name:`Channel ${n+1}`,muted:!1,solo:!1,collapsed:!1,volume:100,pan:d[n],instrumentId:null,color:null,rows:o}});b.set(e,{id:`pattern-${e}`,name:`Pattern ${e}`,length:64,channels:n,importMetadata:{sourceFormat:"GameMusicCreator",sourceFile:i,importedAt:(new Date).toISOString(),originalChannelCount:4,originalPatternCount:m,originalInstrumentCount:r}})}const v=[],C=[],M=new Map;for(const e of h){!M.has(e)&&b.has(e)&&(M.set(e,C.length),C.push(b.get(e)));const t=M.get(e);void 0!==t&&v.push(t)}if(0===C.length){const e={id:"pattern-0",name:"Pattern 0",length:64,channels:Array.from({length:4},(e,t)=>({id:`channel-${t}`,name:`Channel ${t+1}`,muted:!1,solo:!1,collapsed:!1,volume:100,pan:d[t],instrumentId:null,color:null,rows:Array.from({length:64},()=>({note:0,instrument:0,volume:0,effTyp:0,eff:0,effTyp2:0,eff2:0}))})),importMetadata:{sourceFormat:"GameMusicCreator",sourceFile:i,importedAt:(new Date).toISOString(),originalChannelCount:4,originalPatternCount:0,originalInstrumentCount:r}};C.push(e),v.push(0)}return{name:i.replace(/\.[^/.]+$/,""),format:"MOD",patterns:C,instruments:y,songPositions:v,songLength:v.length,restartPosition:0,numChannels:4,initialSpeed:6,initialBPM:125,linearPeriods:!1}}export{a as isGameMusicCreatorFormat,i as parseGameMusicCreatorFile};
