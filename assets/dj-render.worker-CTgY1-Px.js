!function(){"use strict";const e=new Set(["mod","aam","abk","adpcm","adsc","ahx","amc","aon","aon4","aon8","aps","ash","ast","bd","bds","bp","bp3","bss","bye","cin","cm","core","cus","cust","custom","dh","digi","dl","dl_deli","dln","dlm1","dlm2","dm","dm1","dm2","dmu","dmu2","dsr","dw","dwold","dz","ea","ems","emsv6","fc","fc13","fc14","fp","fred","fw","gmc","gv","hd","hipc","hot","hvl","iff","in","is","is20","jam","jcb","jd","jmf","jo","jpo","jpold","kh","kim","kris","lme","ma","mc","mcr","mdat","med","mii","mk2","mkiio","ml","mm4","mm8","mmdc","mms","mp","mp_id","mso","mtp2","mug","mug2","np","np1","np2","np3","okt","okta","pap","pha","pn","ps","psf","pt","pt36","ptm","puma","rh","riff","rjp","sa","sb","sc","scn","scr","sct","sfx","sfx13","sid","sid1","sid2","smn","smp","smus","sndmon","snk","soc","spm","ss","sun","syn","synmod","tcb","tf","tfx","thm","thn","tits","tme","tro","tronic","tw","uds","vss","wb","ym","zen","ac1","ac1d","aval","chan","cp","cplx","crb","di","eu","fc-m","fcm","ft","fuz","fuzz","ice","it1","kef","kef7","krs","ksm","lax","mexxmp","mpro","nr","nru","ntpk","p10","p21","p30","p40a","p40b","p41a","p4x","p50a","p5a","p5x","p60","p60a","p61","p61a","p6x","pin","pm","pm0","pm01","pm1","pm10c","pm18a","pm2","pm20","pm4","pm40","pmz","polk","pp10","pp20","pp21","pp30","ppk","pr1","pr2","prom","pru","pru1","pru2","prun","prun1","prun2","pwr","pyg","pygm","pygmy","skt","skyt","snt","st2","st26","st30","star","stpk","tp","tp1","tp2","tp3","un2","unic","unic2","wn","xan","xann"]),t=new Set(["ahx","hvl"]);let r=!1,a=null;async function s(e,t,s,n){r=!1,a=null,await async function(){if(r)return;const e=self.location.origin,[t,s]=await Promise.all([fetch(`${e}/uade/UADE.wasm`),fetch(`${e}/uade/UADE.js`)]),n=await t.arrayBuffer();let o=await s.text();o=o.replace(/import\.meta\.url/g,`"${e}/uade/UADE.js"`),o=o.replace(/export\s+default\s+/g,"var createUADE = "),o=o.replace(/export\s*\{[^}]*\}/g,""),o=o.replace(/ENVIRONMENT_IS_WEB\s*=\s*!0/g,"ENVIRONMENT_IS_WEB=false"),o=o.replace(/ENVIRONMENT_IS_WORKER\s*=\s*!1/g,"ENVIRONMENT_IS_WORKER=true"),o='var document = { currentScript: { src: "'+e+'/uade/UADE.js" }, title: "" };\n'+o;const l=new Function(o+'\n;return typeof createUADE !== "undefined" ? createUADE : Module;')();a=await l({wasmBinary:n,print:e=>{},printErr:e=>{}});const i=a._uade_wasm_init(44100);if(0!==i)throw new Error(`uade_wasm_init failed with code ${i}`);await WebAssembly.compile(n),r=!0}();const o=a,l=t.split(/[\\/]/).pop()||t,i=l.lastIndexOf("."),p=-1!==i?l.slice(i+1):"mod",c=`${(-1!==i?l.slice(0,i):l).replace(/[^a-zA-Z0-9]/g,"_").slice(0,20)}.${p}`,m=e.byteLength,_=o._malloc(m),u=new Uint8Array(e);o.HEAPU8.set(u,_);const d=3*c.length+1,h=o._malloc(d);o.stringToUTF8(c,h,d);let w=o._uade_wasm_load(_,m,h);if(0!==w){o._uade_wasm_stop&&o._uade_wasm_stop();const e=o._malloc(4096),t=o._malloc(4096);for(let r=0;r<3;r++)o._uade_wasm_render(e,t,1024);o._free(e),o._free(t),w=o._uade_wasm_load(_,m,h)}if(o._free(_),o._free(h),0!==w)throw new Error(`UADE failed to load ${c} (error: ${w})`);s>0&&o._uade_wasm_set_subsong(s),o._uade_wasm_set_looping(0),await new Promise(e=>setTimeout(e,350)),f(n,10);const y=44100,g=4096,E=2646e4,b=o._malloc(16384),A=o._malloc(16384),k=[];let v=0,M=0;const F=1e-4;for(;v<E;){const e=o._uade_wasm_render(b,A,g);if(0===e)break;if(e<0)break;const t=new Float32Array(g),r=new Float32Array(g),a=new Float32Array(o.HEAPF32.buffer,b,g),s=new Float32Array(o.HEAPF32.buffer,A,g);t.set(a),r.set(s);let l=!0;for(let n=0;n<g;n++)if(Math.abs(t[n])>F||Math.abs(r[n])>F){l=!1;break}if(l&&v>0){if(M+=g,v>44100&&M>176400)break}else M=0;if(k.push({left:t,right:r}),v+=g,v%220500<g){f(n,Math.min(80,10+v/E*70))}}if(o._free(b),o._free(A),0===v)throw new Error(`UADE rendered 0 frames for ${c}`);const x=new Float32Array(v),N=new Float32Array(v);let R=0;for(const r of k)x.set(r.left,R),N.set(r.right,R),R+=r.left.length;f(n,85);let H=0;for(let r=0;r<Math.min(x.length,44100);r++){const e=Math.abs(x[r])+Math.abs(N[r]);e>1e-4&&0,e>H&&(H=e)}return{left:x,right:N,sampleRate:y}}let n=null,o=!1;async function l(e,t,r,a){await async function(){if(o)return;const e=self.location.origin,[t,r]=await Promise.all([fetch(`${e}/hively/Hively.wasm`),fetch(`${e}/hively/Hively.js`)]),a=await t.arrayBuffer();let s=await r.text();s=s.replace(/import\.meta\.url/g,`"${e}/hively/Hively.js"`),s=s.replace(/export\s+default\s+/g,"var createHively = "),s=s.replace(/export\s*\{[^}]*\}/g,""),s=s.replace(/ENVIRONMENT_IS_WEB\s*=\s*!0/g,"ENVIRONMENT_IS_WEB=false"),s=s.replace(/ENVIRONMENT_IS_WORKER\s*=\s*!1/g,"ENVIRONMENT_IS_WORKER=true"),s='var document = { currentScript: { src: "'+e+'/hively/Hively.js" }, title: "" };\n'+s;const l=new Function(s+'\n;return typeof createHively !== "undefined" ? createHively : Module;')();n=await l({wasmBinary:a,print:e=>{},printErr:e=>{}}),n._hively_init(44100),o=!0}();const s=n,l=44100,i=new Uint8Array(e),p=s._malloc(i.length);s.HEAPU8.set(i,p);const c=s._hively_load_tune(p,i.length,2);if(s._free(p),!c)throw new Error(`Hively failed to load ${t}`);r>0&&s._hively_init_subsong(r),f(a,10);const m=4*Math.floor(882),_=s._malloc(m),u=s._malloc(m),d=[];let h=0;const w=s._hively_get_positions();let y=10;for(;h<2646e4&&!s._hively_is_song_end();){const e=s._hively_decode_frame(_,u);if(e<=0)break;const t=s.HEAPF32,r=_>>2,n=u>>2,o=new Float32Array(e),l=new Float32Array(e);for(let a=0;a<e;a++)o[a]=t[r+a],l[a]=t[n+a];if(d.push({left:o,right:l}),h+=e,w>0){const e=s._hively_get_position(),t=Math.round(10+e/w*75);t>y&&(f(a,t),y=t)}}s._free(_),s._free(u),s._hively_free_tune();const g=new Float32Array(h),E=new Float32Array(h);let b=0;for(const n of d)g.set(n.left,b),E.set(n.right,b),b+=n.left.length;return f(a,85),{left:g,right:E,sampleRate:l}}let i=null,p=!1;function c(e,t){const r=e.stackAlloc(t.length+1);for(let a=0;a<t.length;a++)e.HEAPU8[r+a]=t.charCodeAt(a);return e.HEAPU8[r+t.length]=0,r}async function m(e,t,r){await async function(){if(p)return;const e=self.location.origin,t=await fetch(`${e}/chiptune3/libopenmpt.worklet.js`);let r=await t.text();r=r.replace(/export\s+default\s+/g,"var createLibopenmpt = "),r=r.replace(/export\s*\{[^}]*\}/g,""),r=r.replace(/import\.meta\.url/g,`"${e}/chiptune3/libopenmpt.worklet.js"`);const a=new Function(r+'\n;return typeof createLibopenmpt !== "undefined" ? createLibopenmpt : Module;')();i=await a(),p=!0}();const a=i;f(r,10);const s=new Uint8Array(e),n=a._malloc(s.length);a.HEAPU8.set(s,n);const o=a._openmpt_module_create_from_memory(n,s.length,0,0,0);if(a._free(n),!o)throw new Error(`libopenmpt failed to load ${t}`);const l=44100;a._openmpt_module_set_repeat_count(o,0);const m=t.split(".").pop()?.toLowerCase()??"";if("mod"===m||"nst"===m||"stk"===m||"m15"===m){const e=a.stackSave();a._openmpt_module_ctl_set(o,c(a,"render.resampler.emulate_amiga"),c(a,"1")),a._openmpt_module_ctl_set(o,c(a,"render.resampler.emulate_amiga_type"),c(a,"a1200")),a.stackRestore(e)}a._openmpt_module_set_render_param(o,2,100),f(r,15);const _=4096,u=a._malloc(16384),d=a._malloc(16384),h=[];let w=0;const y=2646e4;for(;w<y;){const e=a._openmpt_module_read_float_stereo(o,l,_,u,d);if(e<=0)break;const t=new Float32Array(e),s=new Float32Array(e);if(t.set(new Float32Array(a.HEAPF32.buffer,u,e)),s.set(new Float32Array(a.HEAPF32.buffer,d,e)),h.push({left:t,right:s}),w+=e,w%220500<_){f(r,Math.min(80,15+w/y*65))}}if(a._free(u),a._free(d),a._openmpt_module_destroy(o),0===w)throw new Error(`libopenmpt rendered 0 frames for ${t}`);const g=new Float32Array(w),E=new Float32Array(w);let b=0;for(const i of h)g.set(i.left,b),E.set(i.right,b),b+=i.left.length;return f(r,85),{left:g,right:E,sampleRate:l}}function f(e,t){self.postMessage({type:"renderProgress",id:e,progress:Math.round(t)})}self.onmessage=async r=>{const a=r.data;switch(a.type){case"init":self.postMessage({type:"ready"});break;case"render":{const{id:r,fileBuffer:o,filename:i,subsong:p=0}=a;try{let a;a=function(e){const r=e.split(".").pop()?.toLowerCase()??"";return t.has(r)}(i)?await l(o,i,p,r):function(r){const a=r.split(".").pop()?.toLowerCase()??"";return!t.has(a)&&e.has(a)}(i)?await s(o,i,p,r):await m(o,i,r);const n=a.left.length/a.sampleRate;f(r,95),self.postMessage({type:"renderComplete",id:r,left:a.left,right:a.right,sampleRate:a.sampleRate,duration:n},[a.left.buffer,a.right.buffer])}catch(n){const e=n instanceof Error?n.message:String(n);self.postMessage({type:"renderError",id:r,error:e})}break}}},self.postMessage({type:"ready"})}();
