import{aB as e}from"./index-zx6LJBPK.js";import"./vendor-react-DkDaD07v.js";import"./vendor-utils-XMmR-oGw.js";import"./vendor-tone-CADp_hfL.js";import"./vendor-ui-uomqNFY-.js";function t(e,t){return e.getUint8(t)}function n(e,t){return e.getInt8(t)}function r(e,t){return e.getUint16(t,!1)}function o(e,t){return e.getUint32(t,!1)}function a(e,t){let n="";for(let r=0;r<4;r++)n+=String.fromCharCode(e.getUint8(t+r));return n}function i(e,t,n){let r="";for(let o=0;o<n;o++){const n=e.getUint8(t+o);if(0===n)break;r+=String.fromCharCode(n)}return r.trim()}function s(e){if(0===e)return 0;const t=e-36;return t>=1?t:0}function l(e){if(e.byteLength<8)return!1;const t=new DataView(e);let n="";for(let a=0;a<8;a++)n+=String.fromCharCode(t.getUint8(a));if("SOARV1.0"===n)return!0;if(e.byteLength<50)return!1;if(20218!==t.getUint16(0,!1))return!1;const r=t.getUint16(2,!1);if(0===r)return!1;if(32768&r)return!1;if(1&r)return!1;const o=6+r;return!(o+2>e.byteLength)&&16890===t.getUint16(o,!1)}async function f(l,f){const u=new DataView(l),m=new Uint8Array(l);if(l.byteLength<8)throw new Error("SonicArranger: file too small");let h="";for(let e=0;e<8;e++)h+=String.fromCharCode(u.getUint8(e));if("SOARV1.0"!==h){if(20218!==u.getUint16(0,!1))throw new Error(`SonicArranger: unrecognised format (magic="${h}")`);const e=f.replace(/\.[^/.]+$/,""),t=Array.from({length:64},()=>({note:0,instrument:0,volume:0,effTyp:0,eff:0,effTyp2:0,eff2:0}));return{name:e,format:"MOD",patterns:[{id:"pattern-0",name:"Pattern 0",length:64,channels:Array.from({length:4},(e,n)=>({id:`channel-${n}`,name:`Channel ${n+1}`,muted:!1,solo:!1,collapsed:!1,volume:100,pan:[-50,50,50,-50][n],instrumentId:null,color:null,rows:t})),importMetadata:{sourceFormat:"SonicArranger",sourceFile:f,importedAt:(new Date).toISOString(),originalChannelCount:4,originalPatternCount:1,originalInstrumentCount:0}}],instruments:[{id:1,name:"Sample 1",type:"synth",synthType:"Synth",effects:[],volume:0,pan:0}],songPositions:[0],songLength:1,restartPosition:0,numChannels:4,initialSpeed:6,initialBPM:125,linearPeriods:!1}}if(l.byteLength<16)throw new Error("SonicArranger: file too small");let c=8;if("STBL"!==a(u,c))throw new Error("SonicArranger: missing STBL chunk");c+=4;const g=o(u,c);c+=4;const p=[];for(let e=0;e<g;e++){const e={startSpeed:r(u,c),rowsPerTrack:r(u,c+2),firstPosition:r(u,c+4),lastPosition:r(u,c+6),restartPosition:r(u,c+8),tempo:r(u,c+10)};c+=12,65535!==e.lastPosition&&65535!==e.restartPosition&&p.push(e)}const d=p[0]??{startSpeed:6,rowsPerTrack:64,firstPosition:0,lastPosition:0,restartPosition:0,tempo:50};if("OVTB"!==a(u,c))throw new Error("SonicArranger: missing OVTB chunk");c+=4;const w=o(u,c);c+=4;const S=[];for(let e=0;e<w;e++){const e=[];for(let t=0;t<4;t++)e.push({startTrackRow:r(u,c),soundTranspose:n(u,c+2),noteTranspose:n(u,c+3)}),c+=4;S.push(e)}if("NTBL"!==a(u,c))throw new Error("SonicArranger: missing NTBL chunk");c+=4;const y=o(u,c);c+=4;const T=[];for(let e=0;e<y;e++){const e=t(u,c),n=t(u,c+1),r=t(u,c+2),o=t(u,c+3);T.push({note:e,instr:n,disableSoundTranspose:!!(128&r),disableNoteTranspose:!!(64&r),arpeggioTable:(48&r)>>4,effect:15&r,effArg:o}),c+=4}if("INST"!==a(u,c))throw new Error("SonicArranger: missing INST chunk");c+=4;const b=o(u,c);c+=4;const v=[];for(let e=0;e<b;e++){const t=c,n=0!==r(u,t),o=r(u,t+2),a=r(u,t+4),s=r(u,t+6),l=255&r(u,t+16),f=i(u,t+122,30)||`Instrument ${e+1}`;v.push({isSynth:n,waveformNumber:o,waveformLength:a,repeatLength:s,volume:Math.min(l,64),name:f}),c+=152}if("SD8B"!==a(u,c))throw new Error("SonicArranger: missing SD8B chunk");c+=4;const P=function(e,t){return e.getInt32(t,!1)}(u,c);c+=4;const C=[];if(P>0){c+=38*P;const e=[];for(let t=0;t<P;t++)e.push(o(u,c)),c+=4;for(let t=0;t<P;t++){const n=e[t];n>0&&c+n<=l.byteLength?(C.push(m.slice(c,c+n)),c+=n):(C.push(null),c+=n)}}const A=[];if(c+4<=l.byteLength&&"SYWT"===a(u,c)){c+=4;const e=o(u,c);c+=4;for(let t=0;t<e;t++)c+128<=l.byteLength?(A.push(m.slice(c,c+128)),c+=128):(A.push(null),c+=128)}const L=[];for(let t=0;t<b;t++){const n=v[t],r=t+1;if(n.isSynth){const t=n.waveformNumber<A.length?A[n.waveformNumber]:null;t&&0!==t.length?L.push(e(r,n.name,t,n.volume,8287,0,t.length)):L.push({id:r,name:n.name,type:"synth",synthType:"Sampler",effects:[],volume:-60,pan:0})}else{const t=n.waveformNumber<C.length?C[n.waveformNumber]:null;if(t&&0!==t.length){let o=0,a=0;1!==n.repeatLength&&0!==n.waveformLength&&(0===n.repeatLength?(o=0,a=t.length):(o=2*n.waveformLength,a=2*n.waveformLength+2*n.repeatLength,a=Math.min(a,t.length))),L.push(e(r,n.name,t,n.volume,8287,o,a))}else L.push({id:r,name:n.name,type:"sample",synthType:"Sampler",effects:[],volume:-60,pan:0})}}function M(e,t){let n=0,r=0,o=0;switch(e){case 0:0!==t&&(n=0,r=t);break;case 1:240&t?(n=2,r=t>>4):15&t&&(n=1,r=15&t);break;case 4:n=4,r=t;break;case 6:n=16,r=Math.min(t,64);break;case 7:n=3,r=t;break;case 10:n=10,r=t;break;case 11:n=11,r=t;break;case 12:o=16+Math.min(t,64);break;case 13:n=13,r=0;break;case 14:n=14,r=1&t;break;case 15:n=15,r=t}return{effTyp:n,eff:r,volCol:o}}const k=Math.max(1,d.rowsPerTrack),I=[-50,50,50,-50],U=[];for(let e=0;e<S.length;e++){const t=S[e],n=Array.from({length:4},(e,n)=>{const r=t[n],o=r.startTrackRow,a=r.noteTranspose,i=[];for(let t=0;t<k;t++){const e=o+t,n=e<T.length?T[e]:null;if(!n||0===n.note&&0===n.instr&&0===n.effect&&0===n.effArg){i.push({note:0,instrument:0,volume:0,effTyp:0,eff:0,effTyp2:0,eff2:0});continue}let r=s(n.note);r>0&&!n.disableNoteTranspose&&0!==a&&(r=Math.max(1,Math.min(96,r+a)));const l=n.instr>0?n.instr:0,{effTyp:f,eff:u,volCol:m}=M(n.effect,n.effArg);i.push({note:r,instrument:l,volume:m,effTyp:f,eff:u,effTyp2:0,eff2:0})}return{id:`channel-${n}`,name:`Channel ${n+1}`,muted:!1,solo:!1,collapsed:!1,volume:100,pan:I[n],instrumentId:null,color:null,rows:i}});U.push({id:`pattern-${e}`,name:`Pattern ${e}`,length:k,channels:n,importMetadata:{sourceFormat:"SonicArranger",sourceFile:f,importedAt:(new Date).toISOString(),originalChannelCount:4,originalPatternCount:S.length,originalInstrumentCount:b}})}0===U.length&&U.push({id:"pattern-0",name:"Pattern 0",length:64,channels:Array.from({length:4},(e,t)=>({id:`channel-${t}`,name:`Channel ${t+1}`,muted:!1,solo:!1,collapsed:!1,volume:100,pan:I[t],instrumentId:null,color:null,rows:Array.from({length:64},()=>({note:0,instrument:0,volume:0,effTyp:0,eff:0,effTyp2:0,eff2:0}))})),importMetadata:{sourceFormat:"SonicArranger",sourceFile:f,importedAt:(new Date).toISOString(),originalChannelCount:4,originalPatternCount:0,originalInstrumentCount:0}});const $=Math.min(d.firstPosition,U.length-1),B=Math.min(d.lastPosition,U.length-1),N=[];for(let e=$;e<=B;e++)N.push(e);0===N.length&&N.push(0);const D=d.tempo>0?Math.max(32,Math.min(255,Math.round(125*d.tempo/50))):125,O=Math.min(Math.max(0,d.restartPosition-$),N.length-1);return{name:f.replace(/\.[^/.]+$/,""),format:"MOD",patterns:U,instruments:L,songPositions:N,songLength:N.length,restartPosition:O,numChannels:4,initialSpeed:Math.max(1,d.startSpeed),initialBPM:D,linearPeriods:!1}}export{l as isSonicArrangerFormat,f as parseSonicArrangerFile};
