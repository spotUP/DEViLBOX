import{aB as e}from"./index-zx6LJBPK.js";import"./vendor-react-DkDaD07v.js";import"./vendor-utils-XMmR-oGw.js";import"./vendor-tone-CADp_hfL.js";import"./vendor-ui-uomqNFY-.js";function t(e,t){return e[t]<<8|e[t+1]}function n(e,t){return(e[t]<<24|e[t+1]<<16|e[t+2]<<8|e[t+3])>>>0}function o(e){return e<128?e:e-256}function r(e){return Math.max(1,Math.min(96,13+(127&e)))}function a(e,t){let n;do{if(n=!1,e.frqSustain>0){e.frqSustain--;break}let r,a=t[e.frqMacroIdx];if(!a)break;do{if(r=!1,e.frqStep>=64)break;let l=a[e.frqStep];if(225===l)break;if(224===l){if(e.frqStep=63&(e.frqStep+1<64?a[e.frqStep+1]:0),e.frqStep>=64)break;if(l=a[e.frqStep],225===l)break}switch(l){case 226:e.enabled=1,e.volCtr=1,e.volStep=0,e.frqStep+1<64&&(e.currentWaveform=a[e.frqStep+1]),e.frqStep+=2;break;case 228:e.frqStep+1<64&&(e.currentWaveform=a[e.frqStep+1]),e.frqStep+=2;break;case 233:e.frqStep+2<64&&(e.currentWaveform=100+10*a[e.frqStep+1]+a[e.frqStep+2]),e.enabled=1,e.volCtr=1,e.volStep=0,e.frqStep+=3;break;case 231:if(r=!0,e.frqStep+1<64){const n=a[e.frqStep+1];n<t.length&&(e.frqMacroIdx=n,a=t[n])}e.frqStep=0;break;case 234:e.frqStep+2<64&&(e.pitchBendSpeed=o(a[e.frqStep+1]),e.pitchBendTime=a[e.frqStep+2]),e.frqStep+=3;break;case 232:n=!0,e.frqStep+1<64&&(e.frqSustain=a[e.frqStep+1]),e.frqStep+=2;break;case 227:e.frqStep+2<64&&(e.vibratoSpeed=a[e.frqStep+1],e.vibratoDepth=a[e.frqStep+2]),e.frqStep+=3}n||r||e.frqStep<64&&(e.frqTranspose=a[e.frqStep],e.frqStep++)}while(r)}while(n)}function l(e,t){if(e.volSustain>0)return void e.volSustain--;if(e.volBendTime>0)return e.volBendFlag^=1,void(e.volBendFlag&&(e.volBendTime--,e.volume+=e.volBendSpeed,(e.volume<0||e.volume>64)&&(e.volBendTime=0)));if(e.volCtr--,e.volCtr>0)return;e.volCtr=e.volSpeed;const n=t[e.volMacroIdx];if(!n)return;let r;do{r=!1;const t=5+e.volStep;if(t>=64)break;const a=n[t];if(225===a)break;switch(a){case 234:t+2<64&&(e.volBendSpeed=o(n[t+1]),e.volBendTime=n[t+2]),e.volStep+=3,e.volBendFlag^=1,e.volBendFlag&&(e.volBendTime--,e.volume+=e.volBendSpeed,(e.volume<0||e.volume>64)&&(e.volBendTime=0));break;case 232:t+1<64&&(e.volSustain=n[t+1]),e.volStep+=2;break;case 224:{r=!0;const o=t+1<64?63&n[t+1]:5;e.volStep=Math.max(0,o-5);break}default:e.volume=a,e.volStep++}}while(r)}function i(e){if(e.vibratoDelay>0)e.vibratoDelay--;else if(e.vibratoSpeed>0&&e.vibratoDepth>0){let t=e.vibrato;if(e.vibratoFlag){const n=e.vibratoDepth<<1;t+=e.vibratoSpeed,t>n&&(t=n,e.vibratoFlag=0)}else t-=e.vibratoSpeed,t<0&&(t=0,e.vibratoFlag=1);e.vibrato=t}e.portamentoFlag^=1,e.portamentoFlag&&e.portamento>0&&(e.portamento>31?e.pitch+=31&e.portamento:e.pitch-=e.portamento),e.pitchBendFlag^=1,e.pitchBendFlag&&e.pitchBendTime>0&&(e.pitchBendTime--,e.pitch-=e.pitchBendSpeed)}function p(e,t){const n=e.replace(/\.[^/.]+$/,""),o=Array.from({length:32},()=>({note:0,instrument:0,volume:0,effTyp:0,eff:0,effTyp2:0,eff2:0}));return{name:`${n} [${t}]`,format:"FC",patterns:[{id:"pattern-0",name:"Pattern 0",length:32,channels:Array.from({length:4},(e,t)=>({id:`channel-${t}`,name:`Channel ${t+1}`,muted:!1,solo:!1,collapsed:!1,volume:100,pan:0===t||3===t?-50:50,instrumentId:null,color:null,rows:o})),importMetadata:{sourceFormat:"FC",sourceFile:e,importedAt:(new Date).toISOString(),originalChannelCount:4,originalPatternCount:0,originalInstrumentCount:0}}],instruments:[],songPositions:[0],songLength:1,restartPosition:0,numChannels:4,initialSpeed:6,initialBPM:125,linearPeriods:!1}}function s(s,f){const d=new Uint8Array(s);if(function(e){return!(e.length<32)&&96===e[0]&&26===e[1]}(d))return p(f,"Follin Player II");if(function(e){return!(e.length<16)&&70===e[0]&&85===e[1]&&67===e[2]&&79===e[3]}(d))return p(f,"FC BSI");const c=String.fromCharCode(d[0],d[1],d[2],d[3]);if("FC13"!==c&&"FC14"!==c&&"SMOD"!==c)throw new Error(`Not a Future Composer file: magic="${c}"`);const v="FC14"===c;let u=4;const h=n(d,u);u+=4;const m=n(d,u);u+=4;const S=n(d,u);u+=4;const b=n(d,u);u+=4;const g=n(d,u);u+=4;const q=n(d,u);u+=4;const B=n(d,u);u+=4;const M=n(d,u);u+=4;const F=n(d,u);u+=4;const y=[];for(let e=0;e<10;e++)y.push({len:t(d,u),loopStart:t(d,u+2),loopLen:t(d,u+4)}),u+=6;const C=[];if(v)for(let e=0;e<80;e++)C.push(d[u++]);const T=Math.floor(h/13),I=[];for(let e=0;e<T;e++)I.push({pat:[d[u],d[u+3],d[u+6],d[u+9]],transpose:[o(d[u+1]),o(d[u+4]),o(d[u+7]),o(d[u+10])],offsetIns:[o(d[u+2]),o(d[u+5]),o(d[u+8]),o(d[u+11])],speed:d[u+12]}),u+=13;const x=Math.floor(S/64),w=[];for(let e=0;e<x;e++){const t=m+64*e,n=new Uint8Array(32),o=new Uint8Array(32);for(let e=0;e<32;e++)n[e]=d[t+2*e],o[e]=d[t+2*e+1];w.push({note:n,val:o})}const D=Math.floor(g/64),k=[];for(let e=0;e<D;e++)k.push(d.slice(b+64*e,b+64*e+64));const $=Math.floor(B/64),P=[];for(let e=0;e<$;e++)P.push(d.slice(q+64*e,q+64*e+64));const A=[];let L=M;for(let e=0;e<10;e++){const t=2*y[e].len;t>0&&L+t<=d.length?A.push(d.slice(L,L+t)):A.push(new Uint8Array(0)),L+=t,v&&t>0&&(L+=2)}const W=[];if(v){let e=F;for(let t=0;t<80;t++){const n=2*C[t];n>0&&e+n<=d.length?W.push(d.slice(e,e+n)):W.push(new Uint8Array(0)),e+=n}}const U=[],V=new Map,j=new Map;let N=1;function O(e){if(j.has(e))return j.get(e);const t=N++;j.set(e,t);const n=function(e){const t=e<P.length?P[e]:null;if(!t)return{waveNumber:0,synthTable:[],synthSpeed:1,atkLength:4,atkVolume:64,decLength:8,decVolume:32,sustVolume:32,relLength:8,vibDelay:0,vibSpeed:0,vibDepth:0,arpTable:new Array(16).fill(0)};const n=t[0]>0?t[0]:1,o=t[1]||0,r=t[2]||0,a=t[3]||0,l=t[4]||0,i=[];let p=0;const s=o<k.length?k[o]:null;if(s){let e=0;for(;e<64&&i.length<16;){const t=s[e];if(225===t)break;if(224!==t){if((226===t||228===t)&&e+1<64){const n=s[e+1];if(n>=10&&n<(v?90:57)){const e=Math.min(46,n-10);0===i.length&&(p=e),i.push({waveNum:e,transposition:0,effect:226===t?1:0})}e+=2;continue}227!==t&&234!==t&&232!==t?233!==t?231!==t?e++:e+=2:e+=4:e+=3}else e+=2}}let f=32,d=4,c=16,u=8,h=16,m=8,S=0,b=0;for(let v=5;v<64;v++){const e=t[v];if(225===e)break;e<224&&e>S&&(S=e,b=v-5)}return S>0&&(f=Math.min(64,S),d=Math.min(255,Math.max(1,b)*n),c=Math.min(64,Math.round(.5*f)),u=Math.min(255,8*n),h=Math.min(64,Math.max(8,Math.round(.4*f))),m=Math.min(255,8*n)),{waveNumber:p,synthTable:i,synthSpeed:Math.max(1,Math.min(15,n)),atkLength:d,atkVolume:f,decLength:u,decVolume:c,sustVolume:h,relLength:m,vibDelay:l,vibSpeed:r,vibDepth:a,arpTable:new Array(16).fill(0)}}(e);return U.push({id:t,name:`FC Inst ${e+1}`,type:"synth",synthType:"FCSynth",fc:n,effects:[],volume:-6,pan:0}),t}function E(t){if(V.has(t))return V.get(t);const n=N++;if(V.set(t,n),t<10)if(y[t].len>0){const o=y[t],r=o.loopLen>1?o.loopStart:0,a=o.loopLen>1?o.loopStart+2*o.loopLen:0;U.push(e(n,`Sample ${t}`,A[t],64,8287,r,a))}else U.push(z(n,`Sample ${t}`));else t>=100?U.push(z(n,`Pack ${Math.floor((t-100)/10)}:${(t-100)%10}`)):U.push(z(n,`Unknown ${t}`));return n}function z(e,t){return{id:e,name:t,type:"synth",synthType:"Synth",effects:[],volume:-6,pan:0}}const G=[{note:0,transpose:0,pitch:0,frqMacroIdx:0,frqStep:0,frqSustain:0,frqTranspose:0,volMacroIdx:0,volStep:0,volCtr:1,volSpeed:1,volSustain:0,volBendFlag:0,volBendSpeed:0,volBendTime:0,volume:0,enabled:0,vibratoFlag:0,vibratoSpeed:0,vibratoDepth:0,vibratoDelay:0,vibrato:0,pitchBendFlag:0,pitchBendSpeed:0,pitchBendTime:0,portamentoFlag:0,portamento:0,currentWaveform:-1,instrIdx:0},{note:0,transpose:0,pitch:0,frqMacroIdx:0,frqStep:0,frqSustain:0,frqTranspose:0,volMacroIdx:0,volStep:0,volCtr:1,volSpeed:1,volSustain:0,volBendFlag:0,volBendSpeed:0,volBendTime:0,volume:0,enabled:0,vibratoFlag:0,vibratoSpeed:0,vibratoDepth:0,vibratoDelay:0,vibrato:0,pitchBendFlag:0,pitchBendSpeed:0,pitchBendTime:0,portamentoFlag:0,portamento:0,currentWaveform:-1,instrIdx:0},{note:0,transpose:0,pitch:0,frqMacroIdx:0,frqStep:0,frqSustain:0,frqTranspose:0,volMacroIdx:0,volStep:0,volCtr:1,volSpeed:1,volSustain:0,volBendFlag:0,volBendSpeed:0,volBendTime:0,volume:0,enabled:0,vibratoFlag:0,vibratoSpeed:0,vibratoDepth:0,vibratoDelay:0,vibrato:0,pitchBendFlag:0,pitchBendSpeed:0,pitchBendTime:0,portamentoFlag:0,portamento:0,currentWaveform:-1,instrIdx:0},{note:0,transpose:0,pitch:0,frqMacroIdx:0,frqStep:0,frqSustain:0,frqTranspose:0,volMacroIdx:0,volStep:0,volCtr:1,volSpeed:1,volSustain:0,volBendFlag:0,volBendSpeed:0,volBendTime:0,volume:0,enabled:0,vibratoFlag:0,vibratoSpeed:0,vibratoDepth:0,vibratoDelay:0,vibrato:0,pitchBendFlag:0,pitchBendSpeed:0,pitchBendTime:0,portamentoFlag:0,portamento:0,currentWaveform:-1,instrIdx:0}];let H=3;const J=[];for(let e=0;e<I.length;e++){const t=I[e],n=[[],[],[],[]];t.speed>0&&(H=t.speed);for(let e=0;e<32;e++){const o=[!1,!1,!1,!1],p=G.map(e=>e.currentWaveform);for(let n=0;n<4;n++){const r=G[n],a=t.pat[n],l=a<w.length?w[a]:null,i=l?l.note[e]:0,p=l?l.val[e]:0;if(0!==i&&i<73){r.note=127&i,r.pitch=0,r.portamento=0,r.enabled=0,o[n]=!0;const e=Math.max(0,(63&p)+t.offsetIns[n]);if(r.instrIdx=e,e<P.length){const t=P[e];r.volMacroIdx=e,r.volStep=0,r.volSpeed=t[0]||1,r.volCtr=r.volSpeed,r.volSustain=0;const n=t[1];n<k.length&&(r.frqMacroIdx=n),r.frqStep=0,r.frqSustain=0,r.vibratoFlag=0,r.vibratoSpeed=t[2],r.vibratoDepth=t[3],r.vibrato=0,r.vibratoDelay=t[4],r.frqTranspose=0,r.volBendFlag=0,r.volBendSpeed=0,r.volBendTime=0,r.pitchBendFlag=0,r.pitchBendSpeed=0,r.pitchBendTime=0}}64&p?r.portamento=0:128&p&&e<31&&l&&(r.portamento=l.val[e+1],v||(r.portamento<<=1))}for(let e=0;e<H;e++)for(let t=0;t<4;t++)a(G[t],k),l(G[t],P),i(G[t]);for(let a=0;a<4;a++){const l=G[a],i=t.pat[a]<w.length?w[t.pat[a]]:null,s=i?i.note[e]:0;let f=0;if(o[a]){f=r(l.frqTranspose+l.note+t.transpose[a]&127)}else(73===s||i&&240===i.val[e])&&(f=97);let d=0;l.currentWaveform>=0&&(o[a]||l.currentWaveform!==p[a])&&(d=l.currentWaveform<10?E(l.currentWaveform):O(l.instrIdx));const c=Math.max(0,Math.min(64,l.volume)),v=o[a]||l.enabled?16+c:0;let u=0,h=0,m=0,S=0;if(l.vibratoSpeed>0&&l.vibratoDepth>0&&0===l.vibratoDelay){u=4;h=Math.min(l.vibratoSpeed,15)<<4|Math.min(l.vibratoDepth,15)}0===u&&l.portamento>0&&(l.portamento>31?(u=2,h=Math.min(31&l.portamento,255)):(u=1,h=Math.min(l.portamento,255))),0===u&&l.pitchBendTime>0&&0!==l.pitchBendSpeed&&(l.pitchBendSpeed>0?(u=1,h=Math.min(l.pitchBendSpeed,255)):(u=2,h=Math.min(-l.pitchBendSpeed,255))),3===a&&0===e&&t.speed>0&&(0===u?(u=15,h=t.speed):(m=15,S=t.speed)),n[a].push({note:f,instrument:d,volume:v,effTyp:u,eff:h,effTyp2:m,eff2:S})}}J.push({id:`pattern-${e}`,name:`Pattern ${e}`,length:32,channels:n.map((e,t)=>({id:`channel-${t}`,name:`Channel ${t+1}`,muted:!1,solo:!1,collapsed:!1,volume:100,pan:0===t||3===t?-50:50,instrumentId:null,color:null,rows:e})),importMetadata:{sourceFormat:"FC",sourceFile:f,importedAt:(new Date).toISOString(),originalChannelCount:4,originalPatternCount:x,originalInstrumentCount:$||10}})}0===J.length&&J.push({id:"pattern-0",name:"Pattern 0",length:32,channels:Array.from({length:4},(e,t)=>({id:`channel-${t}`,name:`Channel ${t+1}`,muted:!1,solo:!1,collapsed:!1,volume:100,pan:0===t||3===t?-50:50,instrumentId:null,color:null,rows:Array.from({length:32},()=>({note:0,instrument:0,volume:0,effTyp:0,eff:0,effTyp2:0,eff2:0}))})),importMetadata:{sourceFormat:"FC",sourceFile:f,importedAt:(new Date).toISOString(),originalChannelCount:4,originalPatternCount:0,originalInstrumentCount:0}});return{name:f.replace(/\.[^/.]+$/,""),format:"FC",patterns:J,instruments:U,songPositions:J.map((e,t)=>t),songLength:J.length,restartPosition:0,numChannels:4,initialSpeed:I.length>0&&I[0].speed>0?I[0].speed:3,initialBPM:125,linearPeriods:!1}}export{s as parseFCFile};
