import{aB as e}from"./index-zx6LJBPK.js";import"./vendor-react-DkDaD07v.js";import"./vendor-utils-XMmR-oGw.js";import"./vendor-tone-CADp_hfL.js";import"./vendor-ui-uomqNFY-.js";function n(e,n){return e[n]??0}function t(e,n){return((e[n]??0)|(e[n+1]??0)<<8)>>>0}function r(e,n){return((e[n]??0)|(e[n+1]??0)<<8|(e[n+2]??0)<<16|(e[n+3]??0)<<24)>>>0}function f(e,n,t){let r="";for(let f=0;f<t;f++){const t=e[n+f]??0;if(0===t)break;r+=String.fromCharCode(t)}return r.trim()}const o=384;function s(e){if(e.length<832)return!1;if(73!==e[60]||77!==e[61]||49!==e[62]||48!==e[63])return!1;const r=t(e,32),f=t(e,36),o=n(e,49),s=n(e,50),a=n(e,51);if(r>256)return!1;if(f>=256)return!1;if(o<32)return!1;if(s>64)return!1;if(a<4||a>127)return!1;let i=0;for(let t=0;t<32;t++){const r=n(e,64+16*t+13);if(r<2)i=t+1;else if(r>2)return!1}return 0!==i}const a=[0,15,15,3,5,4,6,4,7,0,8,25,12,10,10,36,0,0,1,2,1,2,0,0,9,0,20,27,29,11,13,16,17,14,0,0];function i(e,n){switch(e){case 1:break;case 2:return{effTyp:15,eff:n};case 14:return 0===n||(n=240===n?239:15===n?254:240&n?240&n|15:15&n|240),{effTyp:10,eff:n};case 15:return n^=128,{effTyp:0,eff:0};case 20:case 21:return{effTyp:20===e?1:2,eff:n=n>>4?240|n>>4:224|15&n};case 31:return{effTyp:16,eff:n=Math.min(255,2*n)};case 33:{let e=0;switch(n>>4){case 0:break;case 1:case 15:default:return{effTyp:0,eff:0};case 3:e=32;break;case 5:e=48;break;case 8:e=64;break;case 10:e=176;break;case 11:e=224;break;case 12:case 13:if(!n)return{effTyp:0,eff:0};break;case 14:switch(15&n){case 0:case 1:n=119;break;case 2:n=121;break;case 3:n=123;break;default:return{effTyp:0,eff:0}}return{effTyp:14,eff:n}}return e&&(n=e|15&n),{effTyp:14,eff:n}}}return{effTyp:e<a.length?a[e]:0,eff:n}}function u(a,u){try{return function(a,u){if(!s(a))return null;const m=t(a,32),h=t(a,34),y=t(a,36),g=t(a,38),d=n(a,48),T=n(a,49),b=f(a,0,32)||u.replace(/\.[^/.]+$/,""),k=!!(1&g),C=(()=>{let e=0;for(let t=0;t<32;t++){n(a,64+16*t+13)<2&&(e=t+1)}return e})();if(0===C)return null;const M=[],$=[];for(let e=0;e<C;e++){const t=64+16*e,r=n(a,t+12),f=n(a,t+13);M.push(Math.round(r/255*256)-128),$.push(1===f||2===f)}let v=576;const I=[];for(let e=0;e<256;e++){const t=n(a,v+e);if(255===t)break;e<m&&I.push(t)}0===I.length&&I.push(0);v+=256;const w=[];for(let e=0;e<h;e++){if(v+4>a.length){w.push(c(e,C,M,u));continue}const r=t(a,v),f=t(a,v+2);v+=4;const o=v+r-4,s=Array.from({length:C},()=>Array.from({length:f},()=>({note:0,instrument:0,volume:0,effTyp:0,eff:0,effTyp2:0,eff2:0})));let p=0,m=v;for(;p<f&&m<o;){const e=n(a,m++);if(0===e){p++;continue}const t=31&e,r=t<C?s[t][p]:l();if(32&e){if(m+2>o)break;const e=n(a,m++),t=n(a,m++);if(160===e)r.note=97;else if(255!==e){const n=12*(e>>4)+(15&e)+12+1;r.note=n>=1&&n<=96?n:0}r.instrument=t}const f=192&e;if(192===f){if(m+4>o)break;const e=n(a,m++),t=n(a,m++),f=n(a,m++),s=n(a,m++),{effTyp:u,eff:l}=i(e,t),{effTyp:c,eff:p}=i(f,s);0!==u?(r.effTyp=u,r.eff=l,r.effTyp2=c,r.eff2=p):(r.effTyp=c,r.eff=p)}else if(f){if(m+2>o)break;const e=n(a,m++),t=n(a,m++),{effTyp:f,eff:s}=i(e,t);12===f?r.volume=s:(r.effTyp=f,r.eff=s)}}v=o;const g=s.map((e,n)=>({id:`channel-${n}`,name:`Channel ${n+1}`,muted:$[n]??!1,solo:!1,collapsed:!1,volume:100,pan:M[n]??0,instrumentId:null,color:null,rows:e}));w.push({id:`pattern-${e}`,name:`Pattern ${e}`,length:f,channels:g,importMetadata:{sourceFormat:"IMF",sourceFile:u,importedAt:(new Date).toISOString(),originalChannelCount:C,originalPatternCount:h,originalInstrumentCount:y}})}const A=[];let P=1;for(let s=0;s<y;s++){if(v+o>a.length){A.push(p(s+1,`Instrument ${s+1}`));continue}const i=v,u=f(a,i,32)||`Instrument ${s+1}`,l=t(a,i+378);v+=o;const c=[];for(let t=0;t<l&&!(v+64>a.length);t++){const o=v,s=f(a,o,13)||`${u} ${t+1}`;let i=r(a,o+16),l=r(a,o+20),m=r(a,o+24);const h=r(a,o+28),y=n(a,o+32),g=n(a,o+48);v+=64;const d=!!(1&g),T=!!(2&g),b=!!(4&g);b&&(i=Math.floor(i/2),l=Math.floor(l/2),m=Math.floor(m/2));const k=h>0?h:8363,C=P+t;if(0===i||v+(b?2*i:i)>a.length){v+=b?2*i:i,c.push(p(C,s));continue}const M=b?2*i:i,$=a.subarray(v,v+M);let I;if(v+=M,b){I=new Uint8Array(i);for(let e=0;e<i;e++){const n=(($[2*e]??0)|($[2*e+1]??0)<<8)<<16>>16,t=Math.max(-128,Math.min(127,n>>8));I[e]=t+256&255}}else{I=new Uint8Array(i);for(let e=0;e<i;e++){const n=$[e]??0;I[e]=(n<128?n:n-256)+128&255}}const w=e(C,s,I,y,k,d?l:0,d?m:0);T&&w.sample&&(w.sample.loopType="pingpong"),c.push(w)}if(c.length>0){const e={...c[0],id:s+1,name:u};A.push(e)}else A.push(p(s+1,u));P+=l}return{name:b,format:"XM",patterns:w,instruments:A,songPositions:I,songLength:I.length,restartPosition:0,numChannels:C,initialSpeed:d>0?d:6,initialBPM:T>=32?T:125,linearPeriods:k}}(a,u)}catch{return null}}function l(){return{note:0,instrument:0,volume:0,effTyp:0,eff:0,effTyp2:0,eff2:0}}function c(e,n,t,r){return{id:`pattern-${e}`,name:`Pattern ${e}`,length:64,channels:Array.from({length:n},(e,n)=>({id:`channel-${n}`,name:`Channel ${n+1}`,muted:!1,solo:!1,collapsed:!1,volume:100,pan:t[n]??0,instrumentId:null,color:null,rows:Array.from({length:64},()=>({note:0,instrument:0,volume:0,effTyp:0,eff:0,effTyp2:0,eff2:0}))})),importMetadata:{sourceFormat:"IMF",sourceFile:r,importedAt:(new Date).toISOString(),originalChannelCount:n,originalPatternCount:0,originalInstrumentCount:0}}}function p(e,n){return{id:e,name:n,type:"sample",synthType:"Sampler",effects:[],volume:0,pan:0}}export{s as isImagoOrpheusFormat,u as parseImagoOrpheusFile};
