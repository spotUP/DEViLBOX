import{aB as e}from"./index-zx6LJBPK.js";import"./vendor-react-DkDaD07v.js";import"./vendor-utils-XMmR-oGw.js";import"./vendor-tone-CADp_hfL.js";import"./vendor-ui-uomqNFY-.js";function t(e,t){return e.getUint8(t)}function n(e,t){return e.getUint8(t)|e.getUint8(t+1)<<8|e.getUint8(t+2)<<16}const r=16,a=256,l=64,o=4097,s=4353;function u(e,t,n){if(0===e&&0===t)return{command:0,param:0};let r,a=e,l=t;if(11===a&&l<255)l++;else if(16===a||17===a)l=128|(15&a)<<4|15&l,a=14;else{if(18===a)return{command:0,param:0};if(a>18)return null}switch(a){case 0:r=0;break;case 1:r=1;break;case 2:r=2;break;case 3:case 5:r=3;break;case 4:case 6:r=4;break;case 7:r=7;break;case 8:r=8;break;case 9:r=9;break;case 10:r=10;break;case 11:r=11;break;case 12:r=12;break;case 13:r=13;break;case 14:r=14;break;case 15:r=15;break;default:r=0,l=0}return 4===n&&12===r?3&l&&255!==l?r=16:l=Math.floor((l+3)/4):12===r&&(r=16),{command:r,param:l}}function f(e,r,a){const l=n(e,r+0),o=n(e,r+3),s=n(e,r+6),u=n(e,r+9),f=t(e,r+12),i=t(e,r+13),c=function(e,t){return e.getUint16(t,!0)}(e,r+14);if(-29&i)return null;if(16==(24&i))return null;if(s>u)return null;const m=u-s;if(2!==a&&m>0&&c<100)return null;if(2===a&&m>0&&c>=32768)return null;if(4&i&&m%2!=0)return null;if(8&i&&!o)return null;if(l>o||l>m)return null;if(0!==o&&(o>=m||l>=o))return null;const p=!!(4&i);return{loopStart:l,loopEnd:o,dataStart:s,dataEnd:u,defaultVolume:f,flags:i,sampleRate:c,is16Bit:p,hasLoop:!!(8&i),hasBidiLoop:!!(16&i),length:p?m/2:m,lengthBytes:m,hasSampleData:u>s}}function i(e){if(e.length<17)return!1;const n=new DataView(e.buffer,e.byteOffset,e.byteLength),l=t(n,0);if(l<2||l>4)return!1;if(e.length<4356)return!1;const o=Math.min(a,Math.floor((e.length-1)/r));for(let t=0;t<o;t++){const a=1+t*r;if(a+r>e.length)break;if(null===f(n,a,l))return!1}return!0}function c(n,c){try{return function(n,c){if(!i(n))return null;const m=new DataView(n.buffer,n.byteOffset,n.byteLength),p=t(m,0),h=[];let g=0;for(let e=0;e<a;e++){const t=f(m,1+e*r,p);if(null===t)return null;h.push(t),t.hasSampleData&&(g=e+1)}if(0===g)return null;const d=[];for(let e=0;e<a;e++){const n=t(m,o+e);if(255===n)break;d.push(n)}0===d.length&&d.push(0);const y=t(m,s);if(y>31)return null;const b=y+1,k=t(m,4354)+1,S=k*b*l*6,B=4355,$=B+b;if($+S>n.length)return null;const v=[];for(let e=0;e<b;e++){const n=17*t(m,B+e);v.push(Math.round(n/255*200-100))}const w=new Map;for(let e=0;e<k;e++){const r=$+e*b*l*6,a=Array.from({length:b},()=>Array.from({length:l},()=>({note:0,instrument:0,volume:0,effTyp:0,eff:0,effTyp2:0,eff2:0})));let o=!0;for(let e=0;e<l&&o;e++)for(let l=0;l<b&&o;l++){const s=r+6*(e*b+l);if(s+6>n.length){o=!1;break}const f=t(m,s+0),i=t(m,s+1),c=t(m,s+2),h=t(m,s+3),g=t(m,s+4);let d=0;f>0&&f<=77&&(d=36+f);const y=u(c,t(m,s+5),p),k=u(h,g,p);if(null===y||null===k){o=!1;break}a[l][e].note=d,a[l][e].instrument=i,a[l][e].effTyp=y.command,a[l][e].eff=y.param,a[l][e].effTyp2=k.command,a[l][e].eff2=k.param}w.set(e,a)}const D=d.map((e,t)=>{const n=w.get(e),r=Array.from({length:b},(e,r)=>{const a=Array.from({length:l},(e,t)=>n?{...n[r][t]}:{note:0,instrument:0,volume:0,effTyp:0,eff:0,effTyp2:0,eff2:0});return{id:`c${t}-ch${r}`,name:`Channel ${r+1}`,muted:!1,solo:!1,collapsed:!1,volume:100,pan:v[r]??0,instrumentId:null,color:null,rows:a}});return{id:`pattern-${t}-${e}`,name:`Pattern ${e}`,length:l,channels:r,importMetadata:{sourceFormat:"xmf",sourceFile:c,importedAt:(new Date).toISOString(),originalChannelCount:b,originalPatternCount:k,originalInstrumentCount:g}}});let M=$+S;const T=[];for(let t=0;t<g;t++){const r=t+1,a=h[t];if(!a||!a.hasSampleData||0===a.lengthBytes){T.push({id:r,name:`Sample ${r}`,type:"sample",synthType:"Sampler",effects:[],volume:0,pan:0}),a&&a.hasSampleData&&(M+=a.lengthBytes);continue}const l=M+a.lengthBytes;if(l>n.length){T.push({id:r,name:`Sample ${r}`,type:"sample",synthType:"Sampler",effects:[],volume:0,pan:0}),M+=a.lengthBytes;continue}const o=a.hasLoop?a.loopStart+1:0,s=a.hasLoop?a.loopEnd+1:0,u=a.sampleRate>0?a.sampleRate:8363;if(a.is16Bit){const t=a.length,l=new Uint8Array(t);for(let e=0;e<t;e++){const t=M+2*e;if(t+2>n.length)break;const r=m.getInt16(t,!0);l[e]=128+(r>>8)}T.push(e(r,`Sample ${r}`,l,a.defaultVolume,u,o,s))}else{const t=n.subarray(M,l);T.push(e(r,`Sample ${r}`,t,a.defaultVolume,u,o,s))}M+=a.lengthBytes}const L=D.map((e,t)=>t),A=c.replace(/\.[^/.]+$/,"");return{name:A,format:"MOD",patterns:D,instruments:T,songPositions:L,songLength:L.length,restartPosition:0,numChannels:b,initialSpeed:6,initialBPM:125,linearPeriods:!1}}(n,c)}catch{return null}}export{i as isXMFFormat,c as parseXMFFile};
