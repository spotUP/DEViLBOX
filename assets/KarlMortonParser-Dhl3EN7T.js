import{aB as e}from"./index-zx6LJBPK.js";import"./vendor-react-DkDaD07v.js";import"./vendor-utils-XMmR-oGw.js";import"./vendor-tone-CADp_hfL.js";import"./vendor-ui-uomqNFY-.js";function t(e,t){return e[t]??0}function n(e,t){return((e[t]??0)|(e[t+1]??0)<<8|(e[t+2]??0)<<16|(e[t+3]??0)<<24)>>>0}function r(e,t){let n="";for(let r=0;r<32;r++){const o=e[t+r]??0;if(0===o)break;o>=32&&(n+=String.fromCharCode(o))}return n.trim()}const o=1196314451,f=1280331091,s=1100,i=64,a=3546895,l=[0,16,32,48,64,80,96,112,-128,-112,-96,-80,-64,-48,-32,-16],u=[[12,0],[14,160],[14,176],[14,16],[14,32],[14,80],[9,0],[3,0],[5,0],[4,0],[6,0],[0,0],[1,0],[2,0],[10,0],[14,144],[3,255],[14,192],[15,0],[7,0]];function c(e,t){let n=!1;for(let r=0;r<32;r++){const o=e[t+r]??0;if(o>0&&o<32)return!1;if(0===o)n=!0;else if(n)return!1}return n}function p(e){if(e.length<1116)return!1;const r=n(e,0),f=n(e,4);if(r!==o)return!1;if(f<1108)return!1;if(f>262144)return!1;if(f-1108!==n(e,1100))return!1;const s=function(e,t){return((e[t]??0)|(e[t+1]??0)<<8)>>>0}(e,1094);if(0!==s)return!1;const i=n(e,1096);if(i<1||i>4)return!1;if(!c(e,8))return!1;for(let n=0;n<31;n++){const r=40+34*n,o=t(e,r+32),f=t(e,r+33);if(o>15||f>64)return!1;if(!c(e,r))return!1}return!0}function m(m,g){try{return function(m,g){if(!p(m))return null;const v=[],d=[];let y=0;for(;y+8<=m.length;){const e=n(m,y),i=n(m,y+4);if(i<8)break;const a=y+8,l=i-8;if(e===f){if(l>=40){const e=r(m,a),t=n(m,a+32),o=n(m,a+36);c(m,a)&&v.push({name:e,loopStart:t,size:o,dataOffset:a+40})}}else if(e===o&&l>=s){const e=r(m,a),o=n(m,a+1088),f=n(m,a+1092),i=n(m,a+1096),l=[];for(let n=0;n<31;n++){const e=a+32+34*n,o=r(m,e),f=t(m,e+32),s=t(m,e+33);l.push({name:o,finetune:f,volume:s})}d.push({name:e,samples:l,numChannels:Math.min(Math.max(o,1),4),restartPos:f,musicSize:i,musicOffset:a+s})}y+=i}if(0===d.length||0===v.length)return null;const T=d[0];if(!T)return null;const P=T.numChannels,S=new Map;for(let e=0;e<v.length;e++){const t=v[e];t&&!S.has(t.name)&&S.set(t.name,e)}const C=new Array(32).fill(-1);for(let e=0;e<31;e++){const t=T.samples[e];if(!t||""===t.name)continue;const n=S.get(t.name);void 0!==n&&(C[e+1]=n)}const E=T.musicOffset+T.musicSize;let O=T.musicOffset;const z=[],M=[];let A=0;const b=Array.from({length:P},()=>({prevNote:0,prevInstr:0,prevEffTyp:0,prevEff:0,repeat:0,repeatsLeft:0}));let I=0,k=Array.from({length:P},()=>Array.from({length:i},()=>({note:0,instrument:0,volume:0,effTyp:0,eff:0,effTyp2:0,eff2:0}))),$=i,j=0,w=-1;function N(){const e=z.length,t=k.map((e,t)=>({id:`channel-${t}`,name:`Channel ${t+1}`,muted:!1,solo:!1,collapsed:!1,volume:100,pan:t<2?-50:50,instrumentId:null,color:null,rows:e}));z.push({id:`pattern-${e}`,name:`Pattern ${e}`,length:i,channels:t,importMetadata:{sourceFormat:"MUS",sourceFile:g,importedAt:(new Date).toISOString(),originalChannelCount:P,originalPatternCount:0,originalInstrumentCount:v.length}}),M.push(e)}for(;I>0||O<E;){$++,$>=i&&(z.length,N(),k=Array.from({length:P},()=>Array.from({length:i},()=>({note:0,instrument:0,volume:0,effTyp:0,eff:0,effTyp2:0,eff2:0}))),$=0);for(let e=0;e<P;e++){const n=b[e];if(!n)continue;if(n.repeat>0){n.repeat--,I--;const t=k[e]?.[$];t&&(t.note=n.prevNote,t.instrument=n.prevInstr,t.effTyp=n.prevEffTyp,t.eff=n.prevEff);continue}if(O>=E)continue;O-T.musicOffset===T.restartPos&&(A=M.length-1,j=$,w=z.length-1);const r=t(m,O++);if(128&r){n.repeat=127&r,I+=n.repeat;const t=k[e]?.[$];t&&(t.note=n.prevNote,t.instrument=n.prevInstr,t.effTyp=n.prevEffTyp,t.eff=n.prevEff);continue}let o=0;if(r>0&&r<=36&&(o=r+36),O>=E)continue;const f=t(m,O++),s=31&f;let i=0,a=0;if(!!(128&f))i=n.prevEffTyp,a=n.prevEff;else{if(O+2>E)continue;const e=t(m,O++),n=t(m,O++);if(e<u.length){const[t,r]=u[e]??[0,0];i=t,a=r?r|15&n:n,18===e&&n>=32&&(i=15)}}const l=s>0?C[s]:-1,c=l>=0?l+1:0,p=k[e]?.[$];p&&(p.note=o,p.instrument=c,p.effTyp=i,p.eff=a),n.prevNote=o,n.prevInstr=c,n.prevEffTyp=i,n.prevEff=a}}if($<63||0===z.length){if(0!==j&&w>=0){const e=k[0]?.[$];e&&(e.effTyp=13,e.eff=j)}N()}if(0===M.length)return null;const x=[];for(let t=0;t<v.length;t++){const n=v[t];if(!n)continue;const r=t+1,o=n.name||`Sample ${r}`;if(0===n.size||n.dataOffset+n.size>m.length){x.push(h(r,o));continue}const f=m.subarray(n.dataOffset,n.dataOffset+n.size),s=new Uint8Array(n.size);for(let e=0;e<n.size;e++){const t=f[e]??0;s[e]=(t<128?t:t-256)+128&255}let i=0,u=64;for(let e=0;e<31;e++){const t=T.samples[e];if(t&&t.name===n.name){const e=15&t.finetune;i=l[e]??0,u=Math.min(t.volume,64);break}}const c=n.loopStart,p=n.size,g=e(r,o,s,u,8287,c,p);g.metadata?.modPlayback&&(g.metadata.modPlayback.finetune=i,g.metadata.modPlayback.periodMultiplier=a),x.push(g)}const B=T.name||g.replace(/\.[^/.]+$/,"");return{name:B,format:"MOD",patterns:z,instruments:x,songPositions:M,songLength:M.length,restartPosition:A>=0?A:0,numChannels:P,initialSpeed:6,initialBPM:125,linearPeriods:!1}}(m,g)}catch{return null}}function h(e,t){return{id:e,name:t,type:"sample",synthType:"Sampler",effects:[],volume:0,pan:0}}export{p as isKarlMortonFormat,m as parseKarlMortonFile};
