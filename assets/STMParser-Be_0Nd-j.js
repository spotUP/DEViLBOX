import{aB as e}from"./index-zx6LJBPK.js";import"./vendor-react-DkDaD07v.js";import"./vendor-utils-XMmR-oGw.js";import"./vendor-tone-CADp_hfL.js";import"./vendor-ui-uomqNFY-.js";function t(e,t){return e.getUint8(t)}function n(e,t){return e.getUint16(t,!0)}function o(e,t,n){let o="";for(let r=0;r<n;r++){const n=e.getUint8(t+r);if(0===n)break;o+=String.fromCharCode(n)}return o}const r=[0,15,11,13,10,2,1,3,4,29,0,0,0,0,0,0];function f(e){if(e.byteLength<48)return!1;const n=new DataView(e),o=t(n,28),r=t(n,29),f=t(n,30),s=t(n,31),a=t(n,33),i=t(n,34);if(2!==r)return!1;if(26!==o&&2!==o)return!1;if(2!==f)return!1;if(0!==s&&10!==s&&20!==s&&21!==s)return!1;if(a>64)return!1;if(i>64&&88!==i)return!1;for(let l=20;l<28;l++){const e=t(n,l);if(e<32||e>=127)return!1}return!0}function s(e,r){return{filename:o(e,r,12),zero:t(e,r+12),offset:n(e,r+14),length:n(e,r+16),loopStart:n(e,r+18),loopEnd:n(e,r+20),volume:Math.min(t(e,r+22),64),sampleRate:n(e,r+24)}}function a(e,t,n){const o=15&e,f=r[o];if(o>=10)return{effTyp:0,eff:0};if(0===o)return{effTyp:0,eff:0};switch(o){case 1:{let e=t;return n<21&&(e=(Math.floor(e/10)<<4)+e%10),0===e?{effTyp:0,eff:0}:{effTyp:f,eff:e>>4}}case 2:return{effTyp:f,eff:t};case 3:return{effTyp:f,eff:10*(t>>4)+(15&t)};case 4:{let e=t;return e&=15&e?15:240,{effTyp:f,eff:e}}default:return 0===t?{effTyp:0,eff:0}:{effTyp:f,eff:t}}}async function i(n,r){const f=new DataView(n),i=new Uint8Array(n),l=o(f,0,20),u=t(f,31);let p=t(f,32);const c=t(f,33);u<21&&(p=(Math.floor(p/10)<<4)+p%10),0===p&&(p=96);const m=Math.max(1,p>>4),h=[];let y=48;for(let e=0;e<31;e++)h.push(s(f,y)),y+=32;const g=0===u?64:128,d=[];for(let e=0;e<g;e++){const n=t(f,y+e);if(99===n||255===n)break;n<=63&&d.push(n)}y+=g,0===d.length&&d.push(0);const T=y,v=new Set(d);for(let e=0;e<c;e++)v.add(e);const S=Array.from(v).sort((e,t)=>e-t),w=S.length>0?S[S.length-1]:0,M=new Map,C=[];for(const e of S){const o=T+1024*e,s=[];for(let e=0;e<4;e++){const r=[];for(let s=0;s<64;s++){const i=o+4*(4*s+e);if(i+3>=n.byteLength){r.push({note:0,instrument:0,volume:0,effTyp:0,eff:0,effTyp2:0,eff2:0});continue}const l=t(f,i),p=t(f,i+1),c=t(f,i+2),m=t(f,i+3);let h=0;if(251===l||252===l)h=0;else if(253===l||254===l)h=97;else if(l<96){h=12*(l>>4&15)+(15&l)+36+1}let y=p>>3;y>31&&(y=0);const g=7&p|(240&c)>>1,d=g<=64?g:0,{effTyp:T,eff:v}=a(15&c,m,u);r.push({note:h,instrument:y,volume:d,effTyp:T,eff:v,effTyp2:0,eff2:0})}s.push({id:`channel-${e}`,name:`Channel ${e+1}`,muted:!1,solo:!1,collapsed:!1,volume:100,pan:0,instrumentId:null,color:null,rows:r})}const i=C.length;M.set(e,i),C.push({id:`pattern-${e}`,name:`Pattern ${e}`,length:64,channels:s,importMetadata:{sourceFormat:"STM",sourceFile:r,importedAt:(new Date).toISOString(),originalChannelCount:4,originalPatternCount:w+1,originalInstrumentCount:31}})}const b=[];for(const e of d){const t=M.get(e);void 0!==t&&b.push(t)}0===b.length&&b.push(0);const P=h.map((t,o)=>{const r=o+1,f=t.filename.replace(/\0/g,"").trim()||`Sample ${r}`,s=t.offset<<4,a=t.length;if(a<2||s<48||s>=n.byteLength||0===t.volume)return{id:r,name:f,type:"sample",synthType:"Sampler",effects:[],volume:-60,pan:0};const l=Math.min(s+a,n.byteLength)-s;if(l<=0)return{id:r,name:f,type:"sample",synthType:"Sampler",effects:[],volume:-60,pan:0};const u=i.subarray(s,s+l),p=t.loopStart<a&&t.loopEnd>t.loopStart&&65535!==t.loopEnd,c=p?t.loopStart:0,m=p?t.loopEnd:0,h=t.sampleRate>0?t.sampleRate:8363;return e(r,f,u,t.volume,h,c,m)});return{name:l.replace(/\0/g,"").trim()||r.replace(/\.[^/.]+$/,""),format:"MOD",patterns:C,instruments:P,songPositions:b,songLength:b.length,restartPosition:0,numChannels:4,initialSpeed:m,initialBPM:125,linearPeriods:!1}}export{f as isSTMFormat,i as parseSTMFile};
