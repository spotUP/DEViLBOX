import{aB as t}from"./index-zx6LJBPK.js";import"./vendor-react-DkDaD07v.js";import"./vendor-utils-XMmR-oGw.js";import"./vendor-tone-CADp_hfL.js";import"./vendor-ui-uomqNFY-.js";function n(t,n){return t.getUint8(n)}function e(t,n){return t.getInt8(n)}function o(t,n){return t.getUint16(n,!1)}function r(t,n,e){let o="";for(let r=0;r<e;r++){const e=t.getUint8(n+r);if(0===e)break;o+=String.fromCharCode(e)}return o.trim()}const a=952,i=[-50,50,50,-50];function s(t){if(t.byteLength<960)return!1;const n=new DataView(t);return 75===n.getUint8(a)&&82===n.getUint8(953)&&73===n.getUint8(954)&&83===n.getUint8(955)}async function f(a,s){const f=new DataView(a),u=new Uint8Array(a),l=r(f,0,22)||s.replace(/\.[^/.]+$/,""),m=[];for(let t=0;t<31;t++){const a=22+30*t,i=Array.from(u.subarray(a,a+22)),s=r(f,a,22),l=o(f,a+22),p=e(f,a+24),c=Math.min(n(f,a+25),64),h=o(f,a+26),y=o(f,a+28),g=0===i[0];m.push({name:s,nameRaw:i,length:l,finetune:p,volume:c,loopStart:h,loopLen:y,isSynth:g})}const p=Math.max(1,Math.min(n(f,956),128)),c=Math.min(n(f,957),127),h=[];for(let t=0;t<128;t++){const o=[];for(let r=0;r<4;r++){const a=958+2*(4*t+r);o.push({trackIdx:n(f,a),transpose:e(f,a+1)})}h.push(o)}let y=0;for(const t of m){if(!t.isSynth)continue;const n=[t.nameRaw[1],t.nameRaw[5],t.nameRaw[10],t.nameRaw[19]];for(const t of n)"number"==typeof t&&t>y&&(y=t)}const g=1982+64*y;let d=0;for(let t=0;t<p;t++)for(let n=0;n<4;n++){const e=h[t][n].trackIdx;e>d&&(d=e)}const S=g+256*(d+1),w=new Map;function M(t){if(w.has(t))return w.get(t);const e=g+256*t,o=[];for(let r=0;r<64;r++){const t=e+4*r;if(t+3>=a.byteLength){o.push({noteByte:168,instrument:0,effTyp:0,eff:0});continue}const i=n(f,t),s=n(f,t+1),u=n(f,t+2),l=n(f,t+3);o.push({noteByte:i,instrument:s,effTyp:15&u,eff:l})}return w.set(t,o),o}function v(t,n){if(168===t)return 0;if(1&t)return 0;if(t<24||t>158)return 0;const e=25+Math.floor((t-24)/2)+n;return Math.max(1,Math.min(96,e))}const C=[],I=[];for(let t=0;t<p;t++){I.push(t);const n=[];for(let e=0;e<4;e++){const o=h[t][e],r=M(o.trackIdx),a=o.transpose,s=r.map(t=>({note:v(t.noteByte,a),instrument:t.instrument,volume:0,effTyp:t.effTyp,eff:t.eff,effTyp2:0,eff2:0}));n.push({id:`channel-${e}`,name:`Channel ${e+1}`,muted:!1,solo:!1,collapsed:!1,volume:100,pan:i[e],instrumentId:null,color:null,rows:s})}C.push({id:`pattern-${t}`,name:`Pattern ${t}`,length:64,channels:n,importMetadata:{sourceFormat:"KRIS",sourceFile:s,importedAt:(new Date).toISOString(),originalChannelCount:4,originalPatternCount:p,originalInstrumentCount:31}})}return{name:l,format:"MOD",patterns:C,instruments:m.map((n,e)=>{const o=e+1;if(n.isSynth)return{id:o,name:n.name.replace(/\0/g,"").trim()||"Synthetic",type:"sample",synthType:"Sampler",effects:[],volume:-60,pan:0};const r=2*n.length,i=2*n.loopStart,s=2*n.loopLen,f=n.loopLen>1,l=f?i+s:r;if(0===r||S+r>a.byteLength)return{id:o,name:n.name||`Sample ${o}`,type:"sample",synthType:"Sampler",effects:[],volume:-60,pan:0};let p=S;for(let t=0;t<e;t++)p+=m[t].isSynth?0:2*m[t].length;const c=u.subarray(p,p+r);return t(o,n.name||`Sample ${o}`,c,n.volume,8287,f?i:0,f?l:0)}),songPositions:I,songLength:I.length,restartPosition:c,numChannels:4,initialSpeed:6,initialBPM:125,linearPeriods:!1}}export{s as isKRISFormat,f as parseKRISFile};
