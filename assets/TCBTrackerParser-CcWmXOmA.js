import{aB as t}from"./index-zx6LJBPK.js";import"./vendor-react-DkDaD07v.js";import"./vendor-utils-XMmR-oGw.js";import"./vendor-tone-CADp_hfL.js";import"./vendor-ui-uomqNFY-.js";function n(t,n){return t[n]}function r(t,n){return(t[n]<<8|t[n+1])>>>0}function e(t,n){return(t[n]<<24|t[n+1]<<16|t[n+2]<<8|t[n+3])>>>0}function o(t,n,r){let e="";for(let o=0;o<r;o++){const r=t[n+o];if(0===r)break;e+=String.fromCharCode(r)}return e.trim()}function i(t,n){const r=new Uint8Array(t);if(void 0!==n){if(!(n.split("/").pop()??n).toLowerCase().startsWith("tcb."))return!1}if(r.length<306)return!1;if(1095639107!==e(r,0))return!1;const o=e(r,4);let i;if(1330596897===o)i=1;else{if(1330596910!==o)return!1;i=2}const s=e(r,8);if(s>127)return!1;if(r[12]>15)return!1;if(0!==r[13])return!1;const a=r[142];if(0===a||a>127)return!1;const l=(1===i?272:306)+512*s+212;return!(l>=r.length)&&(!(l-144<0)&&(!(l-144+3>=r.length)&&(4294967295===e(r,l-8)&&(0===e(r,l-4)&&212===e(r,l-144)))))}async function s(s,a){const l=new Uint8Array(s);if(!i(s,a))throw new Error("Not a TCB Tracker module");const u=a.split("/").pop()??a,f=u.replace(/^tcb\./i,"")||u,c=46===l[7],m=e(l,8),p=n(l,12),h=n(l,142),d=c?146:144,g=[];for(let t=0;t<16;t++)g.push(o(l,d+8*t,8));const C=(c?306:272)+512*m,y=C+4,w=y+64,v=[];for(let o=0;o<16;o++){const i=y+4*o,s=w+8*o,a=Math.min(n(l,i),127),u=r(l,i+2),f=e(l,s),c=e(l,s+4);if(0===c||c>2097152)continue;const m=C+f,p=m+c;if(p>l.length)continue;const h=l.slice(m,p),d=new Uint8Array(c);for(let t=0;t<c;t++)d[t]=255&(128^h[t]);let A=0,M=c;A=0!==u&&u<c?c-u:0;const P=g[o]||`Sample ${o+1}`;v.push(t(o+1,P,d,a,8363,A,M))}const A=Array.from({length:64},()=>({note:0,instrument:0,volume:0,effTyp:0,eff:0,effTyp2:0,eff2:0})),M={id:"pattern-0",name:"Pattern 0",length:64,channels:Array.from({length:4},(t,n)=>({id:`channel-${n}`,name:`Channel ${n+1}`,muted:!1,solo:!1,collapsed:!1,volume:100,pan:0===n||3===n?-50:50,instrumentId:null,color:null,rows:A})),importMetadata:{sourceFormat:"MOD",sourceFile:a,importedAt:(new Date).toISOString(),originalChannelCount:4,originalPatternCount:m,originalInstrumentCount:v.length}},P=Math.max(1,h);return{name:`${f} [TCB Tracker]`,format:"MOD",patterns:[M],instruments:v,songPositions:Array.from({length:P},(t,n)=>l[14+n]||0),songLength:P,restartPosition:0,numChannels:4,initialSpeed:16-p,initialBPM:125,linearPeriods:!1}}export{i as isTCBTrackerFormat,s as parseTCBTrackerFile};
