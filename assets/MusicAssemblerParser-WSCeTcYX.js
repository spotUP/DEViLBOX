import{aB as t}from"./index-zx6LJBPK.js";import"./vendor-react-DkDaD07v.js";import"./vendor-utils-XMmR-oGw.js";import"./vendor-tone-CADp_hfL.js";import"./vendor-ui-uomqNFY-.js";const n=[1712,1616,1524,1440,1356,1280,1208,1140,1076,1016,960,906,856,808,762,720,678,640,604,570,538,508,480,453,428,404,381,360,339,320,302,285,269,254,240,226,214,202,190,180,170,160,151,143,135,127,120,113],e=[0,3,1,2],r=Math.round(3546895/428);function o(t,n){return(t[n]<<8|t[n+1])>>>0}function s(t,n){const e=t[n]<<8|t[n+1];return e<32768?e:e-65536}function l(t,n){return t[n]<<24|t[n+1]<<16|t[n+2]<<8|t[n+3]}function f(t){return t<128?t:t-256}function u(t){return 0===t?0:t-12+37}function i(t,n,e){let r="";for(let o=0;o<e;o++){const e=t[n+o];if(0===e)break;r+=String.fromCharCode(e)}return r.trim()}function a(t){const n=t.length,e=s(t,2)+2;if(e<0||e>=n)return null;let r=e;for(;r<n-4&&(176!==t[r]||124!==t[r+1]);)r+=2;if(r>=n-4)return null;const o=t[r+2]<<8|t[r+3];for(r+=4;r<n-4&&(73!==t[r]||250!==t[r+1]);)r+=2;if(r>=n-4)return null;const l=s(t,r+2)+r+2;for(r+=4;r<n-4&&(73!==t[r]||251!==t[r+1]);)r+=2;if(r>=n-4)return null;const u=f(t[r+3])+r+2;for(r=12;r<n-4&&(67!==t[r]||250!==t[r+1]);)r+=2;if(r>=n-4)return null;const i=s(t,r+2)+r+2;for(r+=4;r<n-8&&(211!==t[r]||250!==t[r+1]);)r+=2;if(r>=n-8)return null;const a=s(t,r+2)+r+2;if(213!==t[r+4]||250!==t[r+5])return null;const c=s(t,r+6)+r+6;for(r+=8;r<n-2&&97!==t[r];)r+=2;if(r>=n-2)return null;if(r=f(t[r+1])+r+2,r<0||r>=n)return null;for(;r<n-4&&(219!==t[r]||250!==t[r+1]);)r+=2;if(r>=n-4)return null;return{subSongCount:o,subSongSpeedOffset:l,subSongPositionListOffset:u,moduleStartOffset:i,instrumentInfoOffsetOffset:a,sampleInfoOffsetOffset:c,tracksOffsetOffset:s(t,r+2)+r+2}}function c(t){if(t.length<1570)return!1;if(96!==t[0]||0!==t[1]||96!==t[4]||0!==t[5]||96!==t[8]||0!==t[9]||72!==t[12]||231!==t[13])return!1;return null!==a(t.length>=1792?t.subarray(0,1792):t)}function h(s,f){try{return function(s,f){if(!c(s))return null;const h=s.length>=1792?s.subarray(0,1792):s,g=a(h);if(!g)return null;const{subSongCount:d,subSongSpeedOffset:y,subSongPositionListOffset:b,moduleStartOffset:k,instrumentInfoOffsetOffset:O,sampleInfoOffsetOffset:S,tracksOffsetOffset:v}=g;if(d<=0||d>256)return null;if(y+d>s.length)return null;const L=s.subarray(y,y+d),N=b;if(N+4*d*2>s.length)return null;const M=[];for(let t=0;t<d;t++){const n=N+8*t,e=o(s,n+0),r=o(s,n+2),l=o(s,n+4),f=o(s,n+6);e+2===r&&r+2===l&&l+2===f||M.push({startSpeed:L[t]||6,positionListOffsets:[e,r,l,f]})}if(0===M.length)return null;const C=new Map;for(const t of M)for(const n of t.positionListOffsets){if(C.has(n))continue;const t=k+n;if(t>=s.length)continue;const e=p(s,t);e&&C.set(n,e)}let I=0;for(const t of C.values())for(const n of t)255!==n.trackNumber&&254!==n.trackNumber&&n.trackNumber>I&&(I=n.trackNumber);const W=I+1;if(v+4>s.length)return null;const w=l(s,v),$=w+k;if(k+2*W>s.length)return null;const A=[];for(let t=0;t<W;t++)A.push(o(s,k+2*t));const T=new Array(W).fill(null);for(let t=0;t<W;t++){const n=$+A[t];n<0||n>=s.length||(T[t]=m(s,n))}const P=T.map(t=>t?function(t){const n=[];let e=0;for(;e<t.length;){const r=t[e++];if(255===r)break;let o=0,s=0,l=0;if(128&r){if(64&r){if(o=63&r,e>=t.length)break;if(s=127&t[e++],e>=t.length)break;if(128&t[e++]){if(e>=t.length)break;l=t[e++]}}}else{if(o=63&r,e>=t.length)break;const n=t[e++];if(s=127&n,128&n){if(e>=t.length)break;l=t[e++]}}n.push({note:o,instrument:s,speed:l})}return n}(t):[]);if(O+4>s.length)return null;const x=l(s,O);if(S+4>s.length)return null;const j=l(s,S),F=(j-x)/16;if(F<0||F>256)return null;const B=k+x;if(B+16*F>s.length)return null;const D=[];for(let t=0;t<F;t++){const n=B+16*t;D.push({sampleNumber:s[n+0],attack:s[n+1],decaySustain:s[n+2],vibratoDelay:s[n+3],release:s[n+4],vibratoSpeed:s[n+5],vibratoLevel:s[n+6],arpeggio:s[n+7],fxArpSpdLp:s[n+8],hold:s[n+9],keyWaveRate:s[n+10],waveLevelSpeed:s[n+11]})}const R=k+j;let U=1/0;for(const t of C.keys())t<U&&(U=t);if(!isFinite(U))return null;const X=Math.floor((U+k-R)/24);if(X<0||X>256)return null;if(R+24*X>s.length)return null;const q=[];for(let t=0;t<X;t++){const n=R+24*t,e=l(s,n+0),r=o(s,n+4),f=o(s,n+6),u=i(s,n+8,16),a=e<0?-1:R+e;q.push({name:u,dataOffset:a,lengthWords:r,loopLengthWords:f})}const z=[];for(let n=0;n<F;n++){const e=n+1,o=D[n].sampleNumber;if(o>=X||q[o].dataOffset<0){z.push({id:e,name:`Instrument ${e}`,type:"synth",synthType:"Synth",effects:[],volume:0,pan:0,oscillator:{type:"sawtooth",detune:0,octave:0}});continue}const l=q[o];if(l.lengthWords>1&&l.lengthWords<=128)z.push({id:e,name:l.name||`Instrument ${e}`,type:"synth",synthType:"Synth",effects:[],volume:0,pan:0,oscillator:{type:"sawtooth",detune:0,octave:0}});else if(l.lengthWords>128){const n=2*l.lengthWords,f=l.dataOffset;if(f+n>s.length){z.push({id:e,name:l.name||`Instrument ${e}`,type:"synth",synthType:"Synth",effects:[],volume:0,pan:0,oscillator:{type:"sawtooth",detune:0,octave:0}});continue}const u=s.slice(f,f+n);let i=0,a=0;0!==l.loopLengthWords&&(i=2*(l.lengthWords-l.loopLengthWords),a=i+2*l.loopLengthWords),z.push(t(e,l.name||`Sample ${o}`,u,64,r,i,a))}else z.push({id:e,name:l.name||`Instrument ${e}`,type:"synth",synthType:"Synth",effects:[],volume:0,pan:0,oscillator:{type:"sawtooth",detune:0,octave:0}})}const E=M[0];if(!E)return null;const G=[-50,50,50,-50],H=[];for(let t=0;t<4;t++){const n=E.positionListOffsets[e[t]],r=C.get(n);H.push(r??[])}const J=H.map(t=>t.filter(t=>255!==t.trackNumber&&254!==t.trackNumber).length),K=Math.max(...J,0);function Q(t){return t>=P.length?16:Math.max(P[t].length,1)}const V=[],Y=[];for(let t=0;t<K;t++){let e=16;for(let n=0;n<4;n++){const r=H[n];if(t<r.length){const n=r[t].trackNumber;if(255!==n&&254!==n){const t=Q(n);t>e&&(e=t)}}}const r=Array.from({length:e},()=>Array.from({length:4},()=>({note:0,instrument:0,volume:0,effTyp:0,eff:0,effTyp2:0,eff2:0})));for(let s=0;s<4;s++){const o=H[s];if(t>=o.length)continue;const l=o[t];if(255===l.trackNumber||254===l.trackNumber)continue;const f=l.trackNumber;if(f>=P.length)continue;const i=P[f],a=l.transpose;for(let t=0;t<Math.min(i.length,e);t++){const e=i[t];let o=0;if(0!==e.note){const t=e.note+a;o=u(Math.max(0,Math.min(n.length-1,t)))}let l=0,f=0;0!==e.speed&&(l=15,f=e.speed),r[t][s]={note:o,instrument:e.instrument,volume:0,effTyp:l,eff:f,effTyp2:0,eff2:0}}}const o=V.length;V.push({id:`pattern-${o}`,name:`Pattern ${o}`,length:e,channels:Array.from({length:4},(t,n)=>({id:`channel-${n}`,name:`Channel ${n+1}`,muted:!1,solo:!1,collapsed:!1,volume:100,pan:G[n],instrumentId:null,color:null,rows:r.map(t=>t[n])})),importMetadata:{sourceFormat:"MusicAssembler",sourceFile:f,importedAt:(new Date).toISOString(),originalChannelCount:4,originalPatternCount:K,originalInstrumentCount:F}}),Y.push(o)}if(0===V.length)return null;const Z=f.replace(/\.[^/.]+$/,"");return{name:Z,format:"XM",patterns:V,instruments:z,songPositions:Y,songLength:Y.length,restartPosition:0,numChannels:4,initialSpeed:E.startSpeed||6,initialBPM:125}}(s,f)}catch{return null}}function p(t,n){const e=[];for(;;){if(n+2>t.length)return null;const r=t[n++],o=t[n++]<<4&65535,s=o>>8&255,l=f((255&o)>>1);if(e.push({trackNumber:r,transpose:s,repeatCounter:l}),255===r||254===r)break}return e}function m(t,n){const e=[];for(;;){if(n>=t.length)return null;let r=t[n++];if(e.push(r),128&r){if(64&r){if(n>=t.length)return null;if(r=t[n++],e.push(r),n>=t.length)return null;if(r=t[n++],e.push(r),128&r){if(n>=t.length)return null;r=t[n++],e.push(r)}}}else{if(n>=t.length)return null;if(r=t[n++],e.push(r),128&r){if(n>=t.length)return null;r=t[n++],e.push(r)}}if(n>=t.length)return null;const o=t[n];if(255===o){e.push(o),n++;break}}return new Uint8Array(e)}export{c as isMusicAssemblerFormat,h as parseMusicAssemblerFile};
