import{j as e,aS as t,aQ as n,aR as i,aT as s}from"./index-zx6LJBPK.js";import{r as o}from"./vendor-utils-XMmR-oGw.js";import{P as r,C as c,u as a,O as l}from"./DJ3DCameraControls-DKofB3_2.js";import{V as m}from"./DJView-B1pcUmTm.js";import{V as u,B as d,u as p,M as D}from"./react-three-fiber.esm-DUbY8J_y.js";import"./vendor-react-DkDaD07v.js";import"./vendor-tone-CADp_hfL.js";import"./vendor-ui-uomqNFY-.js";import"./DJKeyboardHandler-Dzr29xNs.js";import"./parseModuleToSong-BCo4MrbT.js";import"./ReadOnlyPatternCanvas-D4F3fqwn.js";import"./sortable.esm-Nw3Rboz6.js";import"./MasterEffectsModal-BHri30Qv.js";import"./guitarMLRegistry-Ct9uudVS.js";import"./useVisualizationAnimation-D37DdYyX.js";import"./NoteRepeatEngine-CA535fLg.js";import"./MpcResamplerDSP-nORj9P5z.js";import"./AudioContextSingleton-BmUieoGD.js";const V="/models/turntable.glb",f={A:"#60a5fa",B:"#f87171",C:"#34d399"},h=new D,b=new D,y=new D,v=new D;function x(e,t,n){b.makeTranslation(t.x,t.y,t.z),h.makeRotationY(e),y.makeTranslation(-t.x,-t.y,-t.z),n.copy(b).multiply(h).multiply(y)}function N({deckId:r,orbitRef:c}){const{scene:m}=a(V),D=o.useRef(new t),h=o.useRef(0),b=o.useRef(.3),y=o.useRef(!1),N=o.useRef(null),g=o.useRef(0),k=o.useRef(1),j=o.useRef(!1),E=o.useRef(0),C=o.useRef(0),P=o.useRef(33),w=n(e=>e.decks[r].isPlaying),M=n(e=>e.decks[r].songPos),B=n(e=>e.decks[r].totalPositions),L=n(e=>e.decks[r].audioPosition),O=n(e=>e.decks[r].durationMs),U=n(e=>e.decks[r].playbackMode),X=n(e=>e.decks[r].pitchOffset),R=n(e=>e.decks[r].trackName),S=o.useRef({isPlaying:w,songPos:M,totalPositions:B,audioPosition:L,durationMs:O,playbackMode:U,pitchOffset:X});S.current={isPlaying:w,songPos:M,totalPositions:B,audioPosition:L,durationMs:O,playbackMode:U,pitchOffset:X};const _=f[r]??"#60a5fa",{clonedScene:A,platterMeshes:I,tonearmMeshes:T,platterCenter:G,tonearmPivot:W}=o.useMemo(()=>{const e=m.clone(!0);e.updateMatrixWorld(!0);const t=[],n=[];let i=null;e.traverse(e=>{if(!("isMesh"in e)||!e.isMesh)return;const s=e,o=s.name;"Platter_2_1"===o||"Vinyl_1"===o?t.push(s):"Tonearm_2_1"===o||"Swivle_1"===o||"Cartridge_1"===o?(n.push(s),"Swivle_1"===o&&(i=s)):"Glass_Cover_2_1"!==o&&"Hinges_1"!==o&&"Glass_Caps_1"!==o||(s.visible=!1)});const s=new u,o=t.find(e=>"Vinyl_1"===e.name);if(o)o.geometry.computeBoundingBox(),o.geometry.boundingBox.getCenter(s);else if(t.length>0){const e=new d;for(const n of t)n.geometry.computeBoundingBox(),n.geometry.boundingBox&&e.union(n.geometry.boundingBox);e.getCenter(s)}const r=new u;i&&(i.geometry.computeBoundingBox(),i.geometry.boundingBox.getCenter(r));for(const c of t)c.matrixAutoUpdate=!1;for(const c of n)c.matrixAutoUpdate=!1;return{clonedScene:e,platterMeshes:t,tonearmMeshes:n,platterCenter:s,tonearmPivot:r}},[m]);p((e,t)=>{const{isPlaying:s,songPos:o,totalPositions:c,audioPosition:a,durationMs:l,playbackMode:m}=S.current,u=D.current;if(I.length>0){const e=(45===P.current?.75:.55555)*Math.pow(2,S.current.pitchOffset/12);if(s||y.current){let s=1;if((y.current||u.spinbackActive||u.powerCutActive)&&(s=u.tick(t)),h.current-=e*s*2*Math.PI*t,y.current&&Math.abs(s-k.current)>.01){try{i().getDeck(r).setScratchVelocity(s)}catch{}k.current=s}if(y.current&&!u.touching&&!u.spinbackActive&&!u.powerCutActive&&Math.abs(s-1)<.02){y.current=!1;try{i().getDeck(r).stopScratch(50)}catch{}n.getState().setDeckScratchActive(r,!1),k.current=1}}x(h.current,G,v);for(const t of I)t.matrix.copy(v)}if(T.length>0){let e=0;"audio"===m&&l>0?e=a/(l/1e3):"tracker"===m&&c>0&&(e=o/c),e=Math.max(0,Math.min(1,e));const n=R?0+-.35*e:.3;b.current+=(n-b.current)*Math.min(1,5*t),x(b.current,W,v);for(const t of T)t.matrix.copy(v)}});const Y=o.useCallback(()=>{if(!y.current){y.current=!0,n.getState().setDeckScratchActive(r,!0);try{i().getDeck(r).startScratch()}catch{}}},[r]),H=o.useCallback(e=>{e.stopPropagation(),e.nativeEvent.target?.setPointerCapture?.(e.nativeEvent.pointerId),S.current.isPlaying&&(Y(),N.current={x:e.nativeEvent.clientX,y:e.nativeEvent.clientY},g.current=performance.now(),D.current.setTouching(!0),D.current.setHandVelocity(0))},[Y]),z=o.useCallback(e=>{if(!N.current)return;const t=e.nativeEvent.clientX-N.current.x,n=performance.now(),i=Math.max(.001,(n-g.current)/1e3);g.current=n;const o=-t/i/400*s;D.current.setHandVelocity(o),N.current={x:e.nativeEvent.clientX,y:e.nativeEvent.clientY}},[]),F=o.useCallback(()=>{N.current=null,D.current.setTouching(!1)},[]),J=o.useCallback(e=>{e.stopPropagation();try{const e=i().getDeck(r),t=n.getState();t.decks[r].isPlaying?(e.pause(),t.setDeckPlaying(r,!1)):(e.play(),t.setDeckPlaying(r,!0))}catch{}},[r]),q=o.useCallback(e=>{e.stopPropagation(),j.current=!0,E.current=e.nativeEvent.clientY,C.current=S.current.pitchOffset,e.nativeEvent.target?.setPointerCapture?.(e.nativeEvent.pointerId)},[]),K=o.useCallback(e=>{if(!j.current)return;const t=(e.nativeEvent.clientY-E.current)/200*8,i=Math.max(-8,Math.min(8,C.current+t));n.getState().setDeckPitch(r,i)},[r]),Q=o.useCallback(()=>{j.current=!1},[]),Z=o.useCallback(e=>{e.stopPropagation(),n.getState().setDeckPitch(r,0)},[r]),$=o.useCallback(e=>{e.stopPropagation(),P.current=33===P.current?45:33},[]),ee=o.useCallback(e=>{if(!S.current.isPlaying)return;e.stopPropagation(),y.current||Y();const n=t.deltaToImpulse(e.nativeEvent.deltaY,e.nativeEvent.deltaMode);D.current.applyImpulse(n)},[Y]);return e.jsxDEV(e.Fragment,{children:[e.jsxDEV("ambientLight",{intensity:.5},void 0,!1,{fileName:"/Users/spot/Code/DEViLBOX/src/components/dj/DeckVinyl3DView.tsx",lineNumber:355,columnNumber:7},this),e.jsxDEV("directionalLight",{position:[2,5,3],intensity:.9,castShadow:!1},void 0,!1,{fileName:"/Users/spot/Code/DEViLBOX/src/components/dj/DeckVinyl3DView.tsx",lineNumber:356,columnNumber:7},this),e.jsxDEV("directionalLight",{position:[-2,3,-1],intensity:.3},void 0,!1,{fileName:"/Users/spot/Code/DEViLBOX/src/components/dj/DeckVinyl3DView.tsx",lineNumber:357,columnNumber:7},this),e.jsxDEV("pointLight",{position:[0,.05,0],color:_,intensity:.4,distance:.6},void 0,!1,{fileName:"/Users/spot/Code/DEViLBOX/src/components/dj/DeckVinyl3DView.tsx",lineNumber:358,columnNumber:7},this),e.jsxDEV("primitive",{object:A,scale:.01},void 0,!1,{fileName:"/Users/spot/Code/DEViLBOX/src/components/dj/DeckVinyl3DView.tsx",lineNumber:361,columnNumber:7},this),e.jsxDEV("mesh",{position:[-.049,.108,-.01],rotation:[-Math.PI/2,0,0],onPointerDown:H,onPointerMove:z,onPointerUp:F,onPointerCancel:F,onWheel:ee,children:[e.jsxDEV("circleGeometry",{args:[.159,32]},void 0,!1,{fileName:"/Users/spot/Code/DEViLBOX/src/components/dj/DeckVinyl3DView.tsx",lineNumber:373,columnNumber:9},this),e.jsxDEV("meshBasicMaterial",{transparent:!0,opacity:0,depthWrite:!1},void 0,!1,{fileName:"/Users/spot/Code/DEViLBOX/src/components/dj/DeckVinyl3DView.tsx",lineNumber:374,columnNumber:9},this)]},void 0,!0,{fileName:"/Users/spot/Code/DEViLBOX/src/components/dj/DeckVinyl3DView.tsx",lineNumber:364,columnNumber:7},this),e.jsxDEV("mesh",{position:[-.175,.105,.12],onClick:J,children:[e.jsxDEV("boxGeometry",{args:[.05,.02,.05]},void 0,!1,{fileName:"/Users/spot/Code/DEViLBOX/src/components/dj/DeckVinyl3DView.tsx",lineNumber:379,columnNumber:9},this),e.jsxDEV("meshBasicMaterial",{transparent:!0,opacity:0,depthWrite:!1},void 0,!1,{fileName:"/Users/spot/Code/DEViLBOX/src/components/dj/DeckVinyl3DView.tsx",lineNumber:380,columnNumber:9},this)]},void 0,!0,{fileName:"/Users/spot/Code/DEViLBOX/src/components/dj/DeckVinyl3DView.tsx",lineNumber:378,columnNumber:7},this),e.jsxDEV("mesh",{position:[.175,.105,.02],onPointerDown:q,onPointerMove:K,onPointerUp:Q,onPointerCancel:Q,onDoubleClick:Z,children:[e.jsxDEV("boxGeometry",{args:[.025,.02,.18]},void 0,!1,{fileName:"/Users/spot/Code/DEViLBOX/src/components/dj/DeckVinyl3DView.tsx",lineNumber:392,columnNumber:9},this),e.jsxDEV("meshBasicMaterial",{transparent:!0,opacity:0,depthWrite:!1},void 0,!1,{fileName:"/Users/spot/Code/DEViLBOX/src/components/dj/DeckVinyl3DView.tsx",lineNumber:393,columnNumber:9},this)]},void 0,!0,{fileName:"/Users/spot/Code/DEViLBOX/src/components/dj/DeckVinyl3DView.tsx",lineNumber:384,columnNumber:7},this),e.jsxDEV("mesh",{position:[-.12,.105,.13],onClick:$,children:[e.jsxDEV("boxGeometry",{args:[.06,.02,.04]},void 0,!1,{fileName:"/Users/spot/Code/DEViLBOX/src/components/dj/DeckVinyl3DView.tsx",lineNumber:398,columnNumber:9},this),e.jsxDEV("meshBasicMaterial",{transparent:!0,opacity:0,depthWrite:!1},void 0,!1,{fileName:"/Users/spot/Code/DEViLBOX/src/components/dj/DeckVinyl3DView.tsx",lineNumber:399,columnNumber:9},this)]},void 0,!0,{fileName:"/Users/spot/Code/DEViLBOX/src/components/dj/DeckVinyl3DView.tsx",lineNumber:397,columnNumber:7},this),e.jsxDEV(l,{ref:c,enablePan:!1,enableZoom:!1,enableRotate:!1,enableDamping:!0,dampingFactor:.1,minPolarAngle:.05*Math.PI,maxPolarAngle:.45*Math.PI,minDistance:.1,maxDistance:2,mouseButtons:{LEFT:void 0,MIDDLE:void 0,RIGHT:void 0}},void 0,!1,{fileName:"/Users/spot/Code/DEViLBOX/src/components/dj/DeckVinyl3DView.tsx",lineNumber:402,columnNumber:7},this)]},void 0,!0,{fileName:"/Users/spot/Code/DEViLBOX/src/components/dj/DeckVinyl3DView.tsx",lineNumber:353,columnNumber:5},this)}function g({deckId:t}){const n=o.useRef(null);return e.jsxDEV("div",{className:"relative w-full h-full min-h-[200px]",style:{touchAction:"none"},children:[e.jsxDEV(m,{className:"absolute inset-0",children:[e.jsxDEV(r,{makeDefault:!0,position:[.2,.42,.5],fov:45,near:.01,far:10},void 0,!1,{fileName:"/Users/spot/Code/DEViLBOX/src/components/dj/DeckVinyl3DView.tsx",lineNumber:437,columnNumber:9},this),e.jsxDEV(N,{deckId:t,orbitRef:n},void 0,!1,{fileName:"/Users/spot/Code/DEViLBOX/src/components/dj/DeckVinyl3DView.tsx",lineNumber:444,columnNumber:9},this)]},void 0,!0,{fileName:"/Users/spot/Code/DEViLBOX/src/components/dj/DeckVinyl3DView.tsx",lineNumber:436,columnNumber:7},this),e.jsxDEV(c,{orbitRef:n},void 0,!1,{fileName:"/Users/spot/Code/DEViLBOX/src/components/dj/DeckVinyl3DView.tsx",lineNumber:446,columnNumber:7},this)]},void 0,!0,{fileName:"/Users/spot/Code/DEViLBOX/src/components/dj/DeckVinyl3DView.tsx",lineNumber:433,columnNumber:5},this)}a.preload(V);export{g as default};
