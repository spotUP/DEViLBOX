import{aB as e}from"./index-zx6LJBPK.js";import"./vendor-react-DkDaD07v.js";import"./vendor-utils-XMmR-oGw.js";import"./vendor-tone-CADp_hfL.js";import"./vendor-ui-uomqNFY-.js";function t(e,t){return e.getUint8(t)}function n(e,t){return e.getInt8(t)}function o(e,t){return e.getUint16(t,!0)}function r(e,t){return e.getUint32(t,!0)}function a(e,t,n){let o="";for(let r=0;r<n;r++){const n=e.getUint8(t+r);if(0===n)break;o+=String.fromCharCode(n)}return o.trim()}function f(e){const t=15&e;return 16*(t<8?t:t-16)}function s(e,t){return{id:e,name:t||`Sample ${e}`,type:"sample",synthType:"Sampler",effects:[],volume:-60,pan:0}}function i(e){if(e.byteLength<4)return!1;const t=new DataView(e);if(e.byteLength>=38){let e=!0;const n="ASYLUM Music Format V1.0\0";for(let o=0;o<25;o++)if(t.getUint8(o)!==n.charCodeAt(o)){e=!1;break}if(e){if(t.getUint8(34)<=64)return!0}}const n=String.fromCharCode(t.getUint8(0)),o=String.fromCharCode(t.getUint8(1)),r=String.fromCharCode(t.getUint8(2)),a=t.getUint8(3);return"A"===n&&"M"===o&&"F"===r&&(1===a||a>=8&&a<=14)||"D"===n&&"M"===o&&"F"===r&&a>=10&&a<=14}function l(e,t){switch(e){case 0:return{effTyp:0,eff:t};case 1:return{effTyp:1,eff:t};case 2:return{effTyp:2,eff:t};case 3:return{effTyp:3,eff:t};case 4:return{effTyp:4,eff:t};case 5:return{effTyp:5,eff:t};case 6:return{effTyp:6,eff:t};case 7:return{effTyp:7,eff:t};case 8:return{effTyp:8,eff:Math.min(255,2*t)};case 9:return{effTyp:9,eff:t};case 10:return{effTyp:10,eff:t};case 11:return{effTyp:11,eff:t};case 12:return{effTyp:12,eff:Math.min(64,t)};case 13:return{effTyp:13,eff:t};case 14:return{effTyp:14,eff:t};case 15:return{effTyp:15,eff:t};default:return{effTyp:0,eff:0}}}function c(e,t,n){const o=127&e,r=[0,15,10,12,1,0,3,29,0,4,5,6,13,11,0,27,9,10,1,14,14,15,1,8];if(o>=r.length)return;let a=r[o],f=t;switch(o){case 2:case 10:case 11:f=128&f?15&-f:(15&f)<<4;break;case 3:f=Math.min(f,64),0===n.volume&&(n.volume=f,a=0,f=0);break;case 4:128&f?f=127&-f:a=2;break;case 17:if(0===f){a=0;break}f=128&f?240|15&-f:15|(15&f)<<4;break;case 18:case 22:if(0===f){a=0;break}128&f?(a=1,f=15&-f):a=2,f|=22===o?224:240;break;case 19:f=208|15&f;break;case 20:f=192|15&f;break;case 23:100===f?f=164:(f=Math.max(0,Math.min(128,(f<128?f:f-256)+64)),0!==n.effTyp&&(0===n.volume&&(n.volume=Math.floor(f/2)),a=0,f=0))}0===a&&0===f||(n.effTyp=a,n.eff=f)}function u(e,t,n){let o=0;for(;o+2<e.length;){const r=e[o],a=e[o+1],f=e[o+2];if(o+=3,r>=t)break;const s=n[r];a<127?0===a&&0===f?s.note=97:(s.note=a+1,255!==f&&(s.volume=f)):127===a||(128===a?s.instrument=f+1:c(a,f,s))}}async function h(c,h){if(!i(c))throw new Error("AMFParser: file does not match ASYLUM or DSMI AMF format");const p=new DataView(c),m=new Uint8Array(c);let g=!0;for(let e=0;e<25;e++)if(p.getUint8(e)!=="ASYLUM Music Format V1.0\0".charCodeAt(e)){g=!1;break}return g?function(o,i,c){const u=t(o,32),h=t(o,33),p=t(o,34),m=t(o,35),g=t(o,36),d=t(o,37),M=[];for(let e=0;e<g;e++)M.push(t(o,38+e));0===M.length&&M.push(0);const y=[];for(let e=0;e<64;e++){const f=294+37*e;y.push({name:a(o,f,22),finetune:t(o,f+22),volume:Math.min(t(o,f+23),64),transpose:n(o,f+24),length:r(o,f+25),loopStart:r(o,f+29),loopLength:r(o,f+33)})}const S=[];for(let e=0;e<m;e++){const n=2662+2048*e,r=Array.from({length:8},(e,r)=>{const a=[];for(let f=0;f<64;f++){const e=n+8*f*4+4*r;if(e+3>=o.byteLength){a.push({note:0,instrument:0,volume:0,effTyp:0,eff:0,effTyp2:0,eff2:0});continue}const s=t(o,e),i=t(o,e+1),c=t(o,e+2),u=t(o,e+3);let h=0;s>0&&s+12+1<=120&&(h=s+12+1);const{effTyp:p,eff:m}=l(c,u);a.push({note:h,instrument:i,volume:0,effTyp:p,eff:m,effTyp2:0,eff2:0})}return{id:`channel-${r}`,name:`Channel ${r+1}`,muted:!1,solo:!1,collapsed:!1,volume:100,pan:r%2==0?-64:64,instrumentId:null,color:null,rows:a}});S.push({id:`pattern-${e}`,name:`Pattern ${e}`,length:64,channels:r,importMetadata:{sourceFormat:"AMF_ASYLUM",sourceFile:c,importedAt:(new Date).toISOString(),originalChannelCount:8,originalPatternCount:m,originalInstrumentCount:p}})}let b=2662+2048*m;const A=[];for(let t=0;t<p;t++){const n=y[t],r=t+1,a=n?.name||`Sample ${r}`;if(!n||0===n.length||b+n.length>o.byteLength){A.push(s(r,a)),n&&n.length>0&&(b+=Math.min(n.length,o.byteLength-b));continue}const l=i.slice(b,b+n.length);b+=n.length;const c=n.loopLength>2&&n.loopStart+n.loopLength<=n.length,u=c?n.loopStart:0,h=c?n.loopStart+n.loopLength:0,p=8363,m=f(n.finetune),g=e(r,a,l,n.volume,p,u,h);g.metadata?.modPlayback&&(g.metadata.modPlayback.finetune=m),A.push(g)}const w=d<g?d:0,T=Math.max(0,S.length-1),k=M.map(e=>Math.min(e,T));return{name:c.replace(/\.[^/.]+$/i,""),format:"MOD",patterns:S,instruments:A,songPositions:k,songLength:k.length,restartPosition:w,numChannels:8,initialSpeed:Math.max(1,u),initialBPM:Math.max(1,h),linearPeriods:!1}}(p,m,h):function(f,i,l){const c=f.byteLength;let h=0;const p=String.fromCharCode(f.getUint8(0),f.getUint8(1),f.getUint8(2)),m=f.getUint8(3),g="DMF"===p;h=4;let d="";if(!g){if(h+32>c)throw new Error("AMFParser(DSMI): truncated at title");d=a(f,h,32),h+=32}if(h+4>c)throw new Error("AMFParser(DSMI): truncated at file header");const M=t(f,h);h++;const y=t(f,h);h++;const S=o(f,h);h+=2;let b=4;if(m>=9){if(h>=c)throw new Error("AMFParser(DSMI): truncated at numChannels");if(b=t(f,h),h++,b<1||b>32)throw new Error(`AMFParser(DSMI): invalid numChannels ${b}`)}const A=Array(b).fill(0);if(m>=11){const e=m>=12?32:16;for(let t=0;t<b&&t<e&&!(h>=c);t++){const e=n(f,h+t);if(100===e)A[t]=0;else{const n=Math.max(0,Math.min(256,2*(e+64)));A[t]=n-128}}h+e<=c?h+=e:h=c}else if(m>=9){h+=16;for(let e=0;e<b;e++)A[e]=1&e?64:-64}else for(let e=0;e<4;e++)A[e]=1&e?64:-64;let w=125,T=6;if(m>=13){if(h+2>c)throw new Error("AMFParser(DSMI): truncated at tempo");let e=t(f,h);h++,e<32&&(e=125),w=e,T=t(f,h),h++}const k=[];for(let e=0;e<y;e++){let e=64;if(m>=14){if(h+2>c)break;e=o(f,h),h+=2}const t=[];for(let n=0;n<b;n++)h+2>c?t.push(0):(t.push(o(f,h)),h+=2);k.push({patLength:e,trackRefs:t})}let C=!1;if(10===m&&!g){const e=h,n=65;for(let o=0;o<M;o++){const a=e+o*n;if(a+n>c)break;const s=t(f,a),i=r(f,a+46),l=r(f,a+50),u=t(f,a+56),h=r(f,a+57),p=r(f,a+61);if(s>1||i>M||l>1048576||u>64||h>l||p>l){C=!0;break}}}const v=[],U=[];for(let e=0;e<M;e++)if(m<10){const e=59;if(h+e>c)break;const n=t(f,h),s=a(f,h+1,32),i=r(f,h+46),l=o(f,h+50),u=o(f,h+52),p=t(f,h+54),m=o(f,h+55),g=o(f,h+57),d=0!==n&&65535!==g&&g>m+2&&g<=l;v.push({type:n,name:s,index:i,length:l,sampleRate:u,volume:Math.min(p,64),loopStart:d?m:0,loopEnd:d?g:0,hasLoop:d}),U.push(i),h+=e}else if(g){const e=20;if(h+e>c)break;const n=t(f,h),a=r(f,h+2),s=r(f,h+6),i=o(f,h+10),l=t(f,h+12),u=r(f,h+13),p=o(f,h+17)|t(f,h+19)<<16,m=0!==n&&p>u+2&&p<=s;v.push({type:n,name:"",index:a,length:s,sampleRate:i,volume:Math.min(l,64),loopStart:m?u:0,loopEnd:m?p:0,hasLoop:m}),U.push(a),h+=e}else{const e=65,n=C?59:e;if(h+n>c)break;const s=t(f,h),i=a(f,h+1,32),l=r(f,h+46),u=r(f,h+50),p=o(f,h+54),m=t(f,h+56);let g,d,M;if(C){const e=h+57+2<=h+n?o(f,h+57):0,t=h+57+4<=h+n?o(f,h+59):0;M=0!==s&&t>e+2&&t<=u,g=M?e:0,d=M?t:0,C&&e>0&&(d=u),h+=n}else g=r(f,h+57),d=r(f,h+61),M=0!==s&&d>g+2&&d<=u,h+=e;v.push({type:s,name:i,index:l,length:u,sampleRate:p,volume:Math.min(m,64),loopStart:M?g:0,loopEnd:M?d:0,hasLoop:M}),U.push(l)}if(h+2*S>c)throw new Error("AMFParser(DSMI): truncated at track map");const F=[];for(let e=0;e<S;e++)F.push(o(f,h)),h+=2;let L=0;for(const e of F)e>L&&(L=e);const P=[];for(let e=0;e<L&&h+3<=c;e++){if(h+3>c){P.push(null);break}const e=o(f,h);h+=2,h++;const t=3*e+(1===m?3:0);if(0===e)P.push(null);else{const e=Math.min(h+t,c);P.push(i.slice(h,e)),h+=t}}const D=h,I=[];for(let e=0;e<y;e++){const t=k[e];if(!t)continue;const n=t.patLength,o=Array.from({length:b},()=>Array.from({length:n},()=>({note:0,instrument:0,volume:0,effTyp:0,eff:0,effTyp2:0,eff2:0})));for(let e=0;e<b;e++){const r=t.trackRefs[e]??0;if(0===r||r>S)continue;const a=F[r-1];if(0===a||a>L)continue;const f=P[a-1];f&&u(f,n,o[e])}const r=Array.from({length:b},(e,t)=>({id:`channel-${t}`,name:`Channel ${t+1}`,muted:!1,solo:!1,collapsed:!1,volume:100,pan:A[t]??0,instrumentId:null,color:null,rows:o[t]}));I.push({id:`pattern-${e}`,name:`Pattern ${e}`,length:n,channels:r,importMetadata:{sourceFormat:g?"AMF_DMF":"AMF_DSMI",sourceFile:l,importedAt:(new Date).toISOString(),originalChannelCount:b,originalPatternCount:y,originalInstrumentCount:M}})}const $=Array.from({length:y},(e,t)=>t),E=[];let x=D;for(let t=1;t<=M&&x<c;t++){const n=x;for(let r=0;r<M;r++){if(U[r]!==t)continue;const o=v[r];if(!o)continue;const a=r+1,f=o.name||`Sample ${a}`;if(0===o.length){E.push(s(a,f));continue}const l=Math.min(o.length,c-n);if(l<=0){E.push(s(a,f));continue}x=n;const u=i.slice(n,n+l);if(g){const t=new Uint8Array(l);let n=0;for(let e=0;e<l;e++)n=n+u[e]&255,t[e]=128^n;E.push(e(a,f,t,o.volume,o.sampleRate||8363,o.loopStart,o.loopEnd))}else{const t=new Uint8Array(l);for(let e=0;e<l;e++)t[e]=128^u[e];E.push(e(a,f,t,o.volume,o.sampleRate||8363,o.loopStart,o.loopEnd))}x=n+o.length}let o=0;for(let e=0;e<M;e++)if(U[e]===t){o=v[e]?.length??0;break}x=n+o}return E.sort((e,t)=>e.id-t.id),{name:d||l.replace(/\.[^/.]+$/i,""),format:"MOD",patterns:I,instruments:E,songPositions:$,songLength:$.length,restartPosition:0,numChannels:b,initialSpeed:T,initialBPM:w,linearPeriods:!1}}(p,m,h)}export{i as isAMFFormat,h as parseAMFFile};
