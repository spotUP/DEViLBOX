import{a6 as e,a7 as t,u as r,a8 as s,j as n,a9 as a,b as o}from"./index-1wJvggfK.js";import{r as c}from"./vendor-utils-Cm-70yv0.js";import{createDefaultTB303Instrument as l}from"./instrumentFactory-D6AbfmDv.js";import{suggestBaseOctave as i,validatePatternForTD3Export as d,trackerPatternToTD3Steps as x,td3StepsToTrackerCells as u}from"./TD3PatternTranslator-BMbzUD7o.js";import{parseTD3File as m}from"./TD3PatternLoader-C1bZAG-1.js";import{X as p,ad as h,D as g,a8 as f,e as b,aY as v,aZ as y,L as j}from"./vendor-ui-Cpb_sTe-.js";import"./vendor-react-LeNVipsj.js";import"./vendor-tone-CADp_hfL.js";function N(e){if(!e.note)return 0;const{value:t,octave:r,upperC:s}=e.note;let n=12+t+12*r;return s&&(n|=128),n}function E(t){const r=Math.max(0,Math.min(3,t.group)),s=Math.max(0,Math.min(15,t.pattern)),n=t.steps.slice(0,16);for(;n.length<16;)n.push({note:null,accent:!1,slide:!1,tie:!1});const a=function(e){const t=new Uint8Array(32);for(let r=0;r<16;r++){const s=N(e[r]||{note:null});t[2*r]=s>>4&15,t[2*r+1]=15&s}return t}(n),o=function(e){const t=new Uint8Array(32);for(let r=0;r<16;r++){const s=e[r]||{accent:!1};t[2*r]=0,t[2*r+1]=s.accent?1:0}return t}(n),c=function(e){const t=new Uint8Array(32);for(let r=0;r<16;r++){const s=e[r]||{slide:!1};t[2*r]=0,t[2*r+1]=s.slide?1:0}return t}(n),l=new Uint8Array([0,0]),i=function(e){const t=Math.max(1,Math.min(16,e));return new Uint8Array([t>>4&15,15&t])}(t.activeSteps),d=new Uint8Array([0,0]),x=function(e){let t=0;for(let r=0;r<16;r++){const s=e[r];s?.tie&&(t|=1<<r)}return new Uint8Array([t>>4&15,15&t,t>>12&15,t>>8&15])}(n),u=function(e){let t=0;for(let r=0;r<16;r++){const s=e[r];s?.note||(t|=1<<r)}return new Uint8Array([t>>4&15,15&t,t>>12&15,t>>8&15])}(n),m=e.HEADER.length,p=new Uint8Array(m+115+1);let h=0;return p.set(e.HEADER,h),h+=e.HEADER.length,p[h++]=e.CMD_SEND_PATTERN,p[h++]=r,p[h++]=s,p[h++]=0,p[h++]=1,p.set(a,h),h+=a.length,p.set(o,h),h+=o.length,p.set(c,h),h+=c.length,p.set(l,h),h+=l.length,p.set(i,h),h+=i.length,p.set(d,h),h+=d.length,p.set(x,h),h+=x.length,p.set(u,h),h+=u.length,p[h]=e.FOOTER,p}function w(e,t){return`${["A","B","C","D"][e]||"?"}${t<8?"A":"B"}${t%8+1}`}function k(e,t){const r=e<<4|t;if(0===r)return null;const s=!!(128&r),n=(127&r)-12;if(n<0)return null;const a=Math.floor(n/12),o=n%12;return{value:o,octave:Math.min(a,2),upperC:s&&0===o}}function A(e,t){const r=[];for(let s=0;s<16;s++)r.push(0!==e[t+2*s+1]);return r}function C(t){const r=function(t){if(t.length<e.HEADER.length+5)return{valid:!1,error:"Message too short"};for(let s=0;s<e.HEADER.length;s++)if(t[s]!==e.HEADER[s])return{valid:!1,error:"Invalid TD-3 header"};const r=t[e.HEADER.length];return r!==e.CMD_SEND_PATTERN?{valid:!1,error:`Invalid command: expected ${e.CMD_SEND_PATTERN}, got ${r}`}:t[t.length-1]!==e.FOOTER?{valid:!1,error:"Invalid SysEx footer"}:{valid:!0}}(t);if(!r.valid)return null;const s=e.HEADER.length+1,n=t[s],a=t[s+1],o=function(e,t){const r=[];for(let s=0;s<16;s++){const n=e[t+2*s],a=e[t+2*s+1];r.push(k(n,a))}return r}(t,s+4),c=A(t,s+36),l=A(t,s+68),i=0!==t[s+101],d=function(e,t){return e[t]<<4|e[t+1]}(t,s+102),x=function(e,t){const r=e[t+1]|e[t]<<4|e[t+3]<<8|e[t+2]<<12,s=[];for(let n=0;n<16;n++)s.push(!!(r&1<<n));return s}(t,s+106),u=[];for(let e=0;e<16;e++)u.push({note:o[e],accent:c[e],slide:l[e],tie:x[e]});return{group:n,pattern:a,steps:u,triplet:i,activeSteps:Math.min(16,Math.max(1,d))}}function S(e){let t=0,r=0;for(let s=0;s<8;s++)e[s]&&(t|=1<<s);for(let s=8;s<16;s++)e[s]&&(r|=1<<s-8);return new Uint8Array([t>>4&15,15&t,r>>4&15,15&r])}const D=["A","B","C","D"],T=({isOpen:N,onClose:k})=>{const[A,T]=c.useState("export"),[R,M]=c.useState(0),[H,I]=c.useState(0),[z,F]=c.useState(0),[P,U]=c.useState(2),[$,O]=c.useState(!1),[q,B]=c.useState(!1),[_,L]=c.useState(null),[J,V]=c.useState(null),[Q,Y]=c.useState([]),G=c.useRef(null),W=c.useRef(null),{selectedOutputId:Z,selectedInputId:K}=t(),{patterns:X,currentPatternIndex:ee,cursor:te,setCell:re}=r(),se=X[ee],ne=se?.channels||[];c.useEffect(()=>{if(N&&(L(null),V(null),Y([]),F(te.channelIndex),se&&se.channels[te.channelIndex])){const e=se.channels[te.channelIndex].rows;U(i(e))}},[N,te.channelIndex,se]),c.useEffect(()=>()=>{null!==G.current&&(clearTimeout(G.current),G.current=null)},[]),c.useEffect(()=>{if(!N||"import"!==A||!q)return;const t=s(),r=t=>{if("sysex"===t.type&&function(t){if(t.length<e.HEADER.length+2)return!1;for(let r=0;r<e.HEADER.length;r++)if(t[r]!==e.HEADER[r])return!1;return t[e.HEADER.length]===e.CMD_SEND_PATTERN}(t.data)){const e=C(t.data);e&&(null!==G.current&&(clearTimeout(G.current),G.current=null),V(e),B(!1))}};return t.addMessageHandler(r),()=>t.removeMessageHandler(r)},[N,A,q]);const ae=c.useCallback(()=>se&&se.channels[z]?se.channels[z].rows:[],[se,z]),oe=d(ae(),P);return N?n.jsx("div",{className:"fixed inset-0 bg-black/60 flex items-center justify-center z-50 animate-fade-in",children:n.jsxs("div",{className:"bg-dark-bgSecondary border border-dark-border rounded-lg shadow-xl w-[480px] max-h-[80vh] overflow-hidden animate-slide-in-up",children:[n.jsxs("div",{className:"flex items-center justify-between px-4 py-3 border-b border-dark-border",children:[n.jsx("h2",{className:"text-lg font-bold text-text-primary",children:"TD-3 Pattern Transfer"}),n.jsx("button",{onClick:k,className:"p-1 rounded hover:bg-dark-bgHover text-text-muted hover:text-text-primary transition-colors",children:n.jsx(p,{size:18})})]}),n.jsxs("div",{className:"flex border-b border-dark-border",children:[n.jsxs("button",{onClick:()=>T("export"),className:"flex-1 px-4 py-2 text-sm font-medium transition-colors flex items-center justify-center gap-2\n              "+("export"===A?"text-text-primary border-b-2 border-accent-primary bg-dark-bgActive":"text-text-secondary hover:text-text-primary"),children:[n.jsx(h,{size:14}),"Export"]}),n.jsxs("button",{onClick:()=>T("import"),className:"flex-1 px-4 py-2 text-sm font-medium transition-colors flex items-center justify-center gap-2\n              "+("import"===A?"text-text-primary border-b-2 border-accent-primary bg-dark-bgActive":"text-text-secondary hover:text-text-primary"),children:[n.jsx(g,{size:14}),"Import"]})]}),n.jsxs("div",{className:"p-4 space-y-4 overflow-y-auto max-h-[400px]",children:[!Z&&"export"===A&&n.jsxs("div",{className:"flex items-center gap-2 p-3 bg-accent-warning/10 border border-accent-warning/30 rounded-md",children:[n.jsx(f,{size:16,className:"text-accent-warning flex-shrink-0"}),n.jsx("span",{className:"text-sm text-text-secondary",children:"No MIDI output selected. You can still export to file."})]}),(!Z||!K)&&"import"===A&&!J&&n.jsxs("div",{className:"flex items-center gap-2 p-3 bg-dark-bgTertiary border border-dark-border rounded-md",children:[n.jsx(f,{size:16,className:"text-text-muted flex-shrink-0"}),n.jsx("span",{className:"text-sm text-text-muted",children:'MIDI transfer requires hardware. Use "Load File" for .sqs or .json patterns.'})]}),n.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[n.jsxs("div",{children:[n.jsx("label",{className:"block text-xs font-medium text-text-muted uppercase tracking-wide mb-1",children:"Group"}),n.jsx("div",{className:"flex gap-1",children:D.map((e,t)=>n.jsx("button",{onClick:()=>M(t),className:"flex-1 py-2 rounded font-medium text-sm transition-colors\n                      "+(R===t?"bg-accent-primary text-text-inverse":"bg-dark-bgTertiary text-text-secondary hover:text-text-primary hover:bg-dark-bgActive"),children:e},e))})]}),n.jsxs("div",{children:[n.jsx("label",{className:"block text-xs font-medium text-text-muted uppercase tracking-wide mb-1",children:"Pattern (1-16)"}),n.jsx("select",{value:H,onChange:e=>I(Number(e.target.value)),className:"w-full px-3 py-2 rounded bg-dark-bgTertiary border border-dark-border text-text-primary",children:Array.from({length:16},(e,t)=>n.jsx("option",{value:t,children:t<8?`A${t+1}`:"B"+(t-7)},t))})]})]}),"export"===A&&n.jsxs(n.Fragment,{children:[n.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[n.jsxs("div",{children:[n.jsx("label",{className:"block text-xs font-medium text-text-muted uppercase tracking-wide mb-1",children:"Source Channel"}),n.jsx("select",{value:z,onChange:e=>F(Number(e.target.value)),className:"w-full px-3 py-2 rounded bg-dark-bgTertiary border border-dark-border text-text-primary",children:ne.map((e,t)=>n.jsx("option",{value:t,children:e.name||`Channel ${t+1}`},t))})]}),n.jsxs("div",{children:[n.jsx("label",{className:"block text-xs font-medium text-text-muted uppercase tracking-wide mb-1",children:"Base Octave"}),n.jsxs("select",{value:P,onChange:e=>U(Number(e.target.value)),className:"w-full px-3 py-2 rounded bg-dark-bgTertiary border border-dark-border text-text-primary",children:[n.jsx("option",{value:1,children:"C1 - C4"}),n.jsx("option",{value:2,children:"C2 - C5"}),n.jsx("option",{value:3,children:"C3 - C6"}),n.jsx("option",{value:4,children:"C4 - C7"})]})]})]}),(oe.warnings.length>0||Q.length>0)&&n.jsx("div",{className:"space-y-1",children:[...oe.warnings,...Q].map((e,t)=>n.jsxs("div",{className:"flex items-center gap-2 text-xs text-accent-warning",children:[n.jsx(f,{size:12}),n.jsx("span",{children:e})]},t))}),n.jsx("div",{className:"text-xs text-text-muted",children:n.jsxs("p",{children:["Exporting ",Math.min(16,ae().length)," steps from"," ",ne[z]?.name||`Channel ${z+1}`," to"," ",n.jsx("span",{className:"text-text-primary font-mono",children:w(R,H)})]})})]}),"import"===A&&J&&n.jsxs("div",{className:"p-3 bg-dark-bgTertiary rounded-md border border-accent-primary/20",children:[n.jsxs("h4",{className:"text-sm font-medium text-text-primary mb-2 flex items-center gap-2",children:[n.jsx(b,{size:14,className:"text-accent-success"}),"Pattern Loaded"]}),n.jsxs("p",{className:"text-xs text-text-muted",children:[J.activeSteps," active steps detected."]}),n.jsxs("div",{className:"mt-3",children:[n.jsx("label",{className:"block text-xs font-medium text-text-muted uppercase tracking-wide mb-1",children:"Target Channel"}),n.jsx("select",{value:z,onChange:e=>F(Number(e.target.value)),className:"w-full px-3 py-2 rounded bg-dark-bg border border-dark-border text-text-primary",children:ne.map((e,t)=>n.jsx("option",{value:t,children:e.name||`Channel ${t+1}`},t))})]})]}),_&&n.jsxs("div",{className:"flex items-center gap-2 p-3 rounded-md "+(_.success?"bg-accent-success/10 border border-accent-success/30":"bg-accent-error/10 border border-accent-error/30"),children:[_.success?n.jsx(b,{size:16,className:"text-accent-success"}):n.jsx(f,{size:16,className:"text-accent-error"}),n.jsx("span",{className:"text-sm text-text-secondary",children:_.message})]})]}),n.jsxs("div",{className:"flex flex-wrap items-center justify-between gap-2 px-4 py-3 border-t border-dark-border bg-dark-bgTertiary",children:[n.jsxs("div",{className:"flex gap-2",children:["import"===A&&n.jsxs(n.Fragment,{children:[n.jsx("input",{ref:W,type:"file",accept:".json,.sqs",className:"hidden",onChange:async e=>{const t=e.target.files?.[0];if(t){try{const e=await t.arrayBuffer();if(t.name.toLowerCase().endsWith(".sqs")){const t=await m(e);if(t.patterns.length>0){const e=t.patterns[0];V({group:0,pattern:0,steps:e.steps,triplet:e.triplet||!1,activeSteps:e.length}),L({success:!0,message:`Loaded pattern "${e.name}" from .sqs file`})}}else{const t=(new TextDecoder).decode(e),r=JSON.parse(t),s=r.steps.map(e=>({note:null===e.note?null:{value:e.note,octave:e.octave,upperC:e.upperC||!1},flag1:e.accent?1:void 0,flag2:e.slide?2:void 0,tie:e.tie}));V({group:r.group||0,pattern:r.pattern||0,steps:s,triplet:r.triplet||!1,activeSteps:r.activeSteps||16}),L({success:!0,message:"Loaded pattern from JSON file"})}}catch{L({success:!1,message:"Failed to parse pattern file"})}W.current&&(W.current.value="")}}}),n.jsxs("button",{onClick:()=>W.current?.click(),className:"px-3 py-2 text-xs font-bold bg-dark-bg border border-dark-border text-text-secondary hover:text-text-primary rounded transition-colors flex items-center gap-2",children:[n.jsx(v,{size:14}),"LOAD FILE"]})]}),"export"===A&&n.jsxs(n.Fragment,{children:[n.jsxs("button",{onClick:()=>{const e=ae(),{steps:t}=x(e,P),r={name:`Pattern ${w(R,H)}`,steps:t.map(e=>({note:e.note?e.note.value:null,octave:e.note?e.note.octave:0,upperC:!!e.note&&e.note.upperC,flag1:e.accent?1:void 0,flag2:e.slide?2:void 0,tie:e.tie})),activeSteps:Math.min(16,e.length)},s=new Blob([JSON.stringify(r,null,2)],{type:"application/json"});a.saveAs(s,`td3-pattern-${w(R,H).replace(" ","")}.json`),L({success:!0,message:"Pattern exported to JSON file"})},className:"px-3 py-2 text-xs font-bold bg-dark-bg border border-dark-border text-text-secondary hover:text-text-primary rounded transition-colors flex items-center gap-2",children:[n.jsx(y,{size:14}),"SAVE AS JSON"]}),n.jsxs("button",{onClick:()=>{const e=ae(),{steps:t}=x(e,P),r={group:R,pattern:H,steps:t,triplet:!1,activeSteps:Math.min(16,e.length)};try{const e=function(e){const t=new Uint8Array(146);new DataView(t.buffer).setUint32(0,597185654,!1);const r=new Uint8Array([0,0,0,8,0,84,0,68,0,45,0,51,0,0,0,10,0,49,0,46,0,51,0,46,0,55,0,0]);t.set(r,4),t[32]=0,t[33]=112,t[34]=0,t[35]=0;const s=36,n=Array(16).fill(!1),a=Array(16).fill(!1),o=[],c=[],l=[];for(let i=0;i<16;i++){const t=e.steps[i]||{note:null,accent:!1,slide:!1,tie:!1};if(i>0&&t.tie)n[i]=!1,a[i]=null===t.note;else{n[i]=!0,a[i]=null===t.note;let e=0;t.note&&(e=24+t.note.value+12*t.note.octave,t.note.upperC&&(e=60)),o.push(e),c.push(t.accent),l.push(t.slide)}}for(let i=0;i<16;i++){const e=o[i]||0;t[s+2*i]=e>>4&15,t[s+2*i+1]=15&e}for(let i=0;i<16;i++){const e=c[i]?1:0;t[68+2*i]=0,t[68+2*i+1]=e}for(let i=0;i<16;i++){const e=l[i]?1:0;t[100+2*i]=0,t[100+2*i+1]=e}return t[132]=0,t[133]=0,t[134]=0,t[135]=15&e.activeSteps,t.set(S(n),138),t.set(S(a),142),t}(r),t=new Blob([e.buffer],{type:"application/octet-stream"});a.saveAs(t,`td3-pattern-${w(R,H).replace(" ","")}.seq`),L({success:!0,message:"Pattern exported to .seq file"})}catch{L({success:!1,message:"Failed to export .seq file"})}},className:"px-3 py-2 text-xs font-bold bg-dark-bg border border-dark-border text-text-secondary hover:text-text-primary rounded transition-colors flex items-center gap-2",children:[n.jsx(y,{size:14}),"SAVE AS .SEQ"]})]})]}),n.jsxs("div",{className:"flex gap-2",children:[n.jsx("button",{onClick:k,className:"px-4 py-2 text-sm font-medium text-text-secondary hover:text-text-primary transition-colors",children:"Close"}),"export"===A&&n.jsx("button",{onClick:async()=>{if(!Z)return;const e=ae(),{steps:t,warnings:r}=x(e,P);Y(r);const n=E({group:R,pattern:H,steps:t,activeSteps:Math.min(16,e.length)});O(!0),L(null);try{s().sendSysEx(n),L({success:!0,message:`Pattern sent to ${w(R,H)}`})}catch(a){L({success:!1,message:a instanceof Error?a.message:"Failed to send pattern"})}finally{O(!1)}},disabled:!Z||$||!oe.valid,className:"px-4 py-2 text-sm font-medium bg-accent-primary text-text-inverse rounded hover:bg-accent-primary/90 transition-colors disabled:opacity-50 disabled:cursor-not-allowed flex items-center gap-2 shadow-glow-sm",children:$?n.jsxs(n.Fragment,{children:[n.jsx(j,{size:14,className:"animate-spin"}),"Sending..."]}):n.jsxs(n.Fragment,{children:[n.jsx(h,{size:14}),"Send to TD-3"]})}),"import"===A&&!J&&n.jsx("button",{onClick:()=>{if(!Z||!K)return;const t=function(t,r){const s=Math.max(0,Math.min(3,t)),n=Math.max(0,Math.min(15,r)),a=new Uint8Array(e.HEADER.length+4);return a.set(e.HEADER,0),a[e.HEADER.length]=e.CMD_REQUEST_PATTERN,a[e.HEADER.length+1]=s,a[e.HEADER.length+2]=n,a[e.HEADER.length+3]=e.FOOTER,a}(R,H);B(!0),V(null),L(null);try{s().sendSysEx(t),null!==G.current&&clearTimeout(G.current),G.current=window.setTimeout(()=>{G.current=null,B(!1),L({success:!1,message:"No response from TD-3. Make sure it is connected and in the correct mode."})},5e3)}catch(r){B(!1),L({success:!1,message:r instanceof Error?r.message:"Failed to send request"})}},disabled:!Z||!K||q,className:"px-4 py-2 text-sm font-medium bg-accent-primary text-text-inverse rounded hover:bg-accent-primary/90 transition-colors disabled:opacity-50 disabled:cursor-not-allowed flex items-center gap-2",children:q?n.jsxs(n.Fragment,{children:[n.jsx(j,{size:14,className:"animate-spin"}),"Requesting..."]}):n.jsxs(n.Fragment,{children:[n.jsx(g,{size:14}),"Request from TD-3"]})}),"import"===A&&J&&n.jsxs("button",{onClick:()=>{if(!J)return;const{instruments:e,addInstrument:t}=o.getState();let r=e.find(e=>"TB303"===e.synthType);if(!r){const e=l();t(e),r=e}const s=e.findIndex(e=>e.id===r.id)+1,n=u(J.steps,P),a=Math.min(J.activeSteps,n.length);for(let o=0;o<a;o++){const e=n[o];re(z,o,{note:e.note,instrument:e.note?s:void 0,flag1:e.flag1,flag2:e.flag2})}L({success:!0,message:`Imported ${a} steps into channel ${z+1} with TB-303`}),V(null)},className:"px-4 py-2 text-sm font-medium bg-accent-success text-text-inverse rounded hover:bg-accent-success/90 transition-colors flex items-center gap-2 shadow-glow-sm",children:[n.jsx(b,{size:14}),"Insert into Pattern"]})]})]})]})}):null};export{T as TD3PatternDialog};
