const e=new Uint8Array([2,1,19,19,20,18,1,11]),t=63,n=64,f=256,r=(()=>{const e=new Int16Array(256);for(let t=0;t<256;t++){const n=255&~t,f=128&n?-1:1,r=((15&n)<<1|33)<<(n>>4&7);e[t]=f*(r-33)}return e})();function s(e){let t="";for(let n=0;n<e.length;n++)t+=String.fromCharCode(e[n]<32?32:e[n]);return t.trimEnd()}class a{data;bytePos;bitBuf;bitsLeft;constructor(e,t){this.data=e,this.bytePos=t,this.bitBuf=0,this.bitsLeft=0}get position(){return this.bytePos}readBits(e){for(;this.bitsLeft<e;){if(this.bytePos>=this.data.length)throw new Error("BitReader EOF");this.bitBuf|=this.data[this.bytePos++]<<this.bitsLeft,this.bitsLeft+=8}const t=this.bitBuf&(1<<e)-1;return this.bitBuf>>>=e,this.bitsLeft-=e,t}}function o(e,t,n){const f=8192,r=new Uint16Array(f),s=new Uint8Array(f),o=new Uint8Array(f);for(let a=0;a<256;a++)r[a]=f,s[a]=a;let i=9,l=0,c=257;const u=new Uint8Array(n);let h=0;const p=new a(e,t);e:for(;h<n;){const e=p.readBits(i);if(257===e||e>c)break;if(256===e){i=9,l=0,c=257;continue}let t=e<c?e:l,a=f;do{o[--a]=s[t],t=r[t]}while(t<f);const y=f-a;if(h+(e===c?y+1:y)>n){for(let e=a;e<f&&h<n;e++)u[h++]=o[e];e===c&&h<n&&(u[h++]=o[a]);break e}for(let n=a;n<f;n++)u[h++]=o[n];e===c&&(u[h++]=o[a]),c<f&&h<n&&(s[c]=o[a],r[c]=l,c++,c!==f&&c===1<<i&&i++),l=e}return{output:u,endPos:t+(p.position-t+3&-4)}}function i(e,t,n){let f=e[t++];f<1&&(f=1);const r=e.length-t,s=8*Math.min(r,536870911);n>s&&(n=s);const o=new Uint8Array(n);let i=0,l=f,c=8;const u=t,h=new a(e,t);let p=255&h.readBits(c);for(o[i++]=p;i<n;){const e=h.readBits(c);if(0!==e)p=1&e?p-(e>>>1)&255:p+(e>>>1)&255,o[i++]=p,e>>>c-1==0?0===--l&&(c>1&&c--,l=f):l=f;else{if(c>=9)break;c++,l=f}}return{output:o,endPos:u+(h.position-u+3&-4)}}function l(e,t,n){if(t>=e.length)return null;const f=e[t++];if(f>1)return null;if(1===f){const{output:f,endPos:r}=o(e,t,n);return f.length<n?null:{chunk:f,endPos:r}}if(t+n>e.length)return null;return{chunk:e.slice(t,t+n),endPos:t+n}}function c(t){if(t.length<89)return!1;for(let o=0;o<8;o++)if(t[o]!==e[o])return!1;const n=new DataView(t.buffer,t.byteOffset,t.byteLength),f=t[8],r=t[9],s=n.getUint16(10,!0),a=n.getUint16(12,!0);return!(f>1)&&(!(r<1||r>8)&&(!(s>4096)&&!(a>4096)))}function u(e){const t=new Int16Array(e.length);for(let n=0;n<e.length;n++){const f=255&(e[n]<<7|(255&~e[n])>>1);t[n]=r[f]}return t}function h(e){const t=new Int16Array(e.length);for(let n=0;n<e.length;n++){const f=(128^e[n])-128;t[n]=256*f}return t}function p(e){const t=new Int16Array(e.length);let n=0;for(let f=0;f<e.length;f++){n=n+(e[f]<<24>>24)&255;const r=(128^n)-128;t[f]=256*r}return t}function y(e){const t=new Int16Array(e.length>>1),n=new DataView(e.buffer,e.byteOffset,e.byteLength);for(let f=0;f<t.length;f++)t[f]=n.getInt16(2*f,!0);return t}function b(e){const t=new Int16Array(e.length);for(let n=0;n<e.length;n++){const f=e[n],s=f^(f>=128?127:0);t[n]=r[s]}return t}function g(e){const t=new Int16Array(e.length);for(let n=0;n<e.length;n++)t[n]=256*(e[n]-128)|0;return t}function m(e,t=8287,n=0,f=0){const r=e.length,s=2*r,a=f>n&&f>2,o=a?88:0,i=44+s+(a?8+o:0),l=new ArrayBuffer(i),c=new DataView(l),u=new Uint8Array(l);u[0]=82,u[1]=73,u[2]=70,u[3]=70,c.setUint32(4,i-8,!0),u[8]=87,u[9]=65,u[10]=86,u[11]=69,u[12]=102,u[13]=109,u[14]=116,u[15]=32,c.setUint32(16,16,!0),c.setUint16(20,1,!0),c.setUint16(22,1,!0),c.setUint32(24,t,!0),c.setUint32(28,2*t,!0),c.setUint16(32,2,!0),c.setUint16(34,16,!0),u[36]=100,u[37]=97,u[38]=116,u[39]=97,c.setUint32(40,s,!0);const h=new DataView(l,44,s);for(let p=0;p<r;p++)h.setInt16(2*p,e[p],!0);if(a){let e=44+s;u[e++]=115,u[e++]=109,u[e++]=112,u[e++]=108,c.setUint32(e,o,!0),e+=4,c.setUint32(e,0,!0),e+=4,c.setUint32(e,0,!0),e+=4,c.setUint32(e,Math.round(1e9/t),!0),e+=4,c.setUint32(e,60,!0),e+=4,c.setUint32(e,0,!0),e+=4,c.setUint32(e,0,!0),e+=4,c.setUint32(e,0,!0),e+=4,c.setUint32(e,1,!0),e+=4,c.setUint32(e,0,!0),e+=4,c.setUint32(e,0,!0),e+=4,c.setUint32(e,0,!0),e+=4,c.setUint32(e,n,!0),e+=4,c.setUint32(e,f-1,!0),e+=4,c.setUint32(e,0,!0),e+=4,c.setUint32(e,0,!0),e+=4}return l}function k(e,t){return{effTyp:15&e,eff:255&t}}function d(e,r){try{return function(e,r){if(!c(e))return null;const a=new DataView(e.buffer,e.byteOffset,e.byteLength);let k=8;e[k++];const d=e[k++],U=a.getUint16(k,!0);k+=2;const A=a.getUint16(k,!0);k+=2;const P=e[k]|e[k+1]<<8|e[k+2]<<16;function M(e){const t=3&e;return 1===t||2===t?50:-50}k+=3;const S=new Uint8Array(64);for(let n=1;n<=t;n++){if(k>=e.length)return null;S[n]=e[k++]}const C=new Uint32Array(64);for(let n=1;n<=t;n++)if(!(128&S[n])){if(k+3>e.length)return null;const t=e[k]|e[k+1]<<8|e[k+2]<<16;C[n]=t<<1,k+=3}if(k>=e.length)return null;const I=e[k++];if(k+I>e.length)return null;const $=e.slice(k,k+I);k+=I;const B=s($).trim()||r.replace(/\.[^/.]+$/,"");if(k+8>e.length)return null;const D=e.slice(k,k+8);k+=8;const L=U*d*2;let O=null;if(U>0){const t=l(e,k,L);if(!t)return null;k=t.endPos,O=new Uint16Array(t.chunk.buffer,t.chunk.byteOffset,L/2)}else O=new Uint16Array(0);const v=new Uint8Array(A*f);let E=0;for(let t=0;t<A;t+=2e3){const n=Math.min(A-t,2e3)*f,r=l(e,k,n);if(!r)return null;k=r.endPos,v.set(r.chunk.slice(0,n),E),E+=n}const F=[];for(let f=0;f<U;f++){const e=[];for(let t=0;t<d;t++){const r=null!==O?O[f*d+t]:0,s=[];for(let e=0;e<n;e++){const n=T(v,r,A,e,t,D);s.push(n)}e.push({id:`channel-${t}`,name:`Channel ${t+1}`,muted:!1,solo:!1,collapsed:!1,volume:100,pan:M(t),instrumentId:null,color:null,rows:s})}F.push({id:`pattern-${f}`,name:`Pattern ${f}`,length:n,channels:e,importMetadata:{sourceFormat:"DigitalSymphony",sourceFile:r,importedAt:(new Date).toISOString(),originalChannelCount:d,originalPatternCount:U,originalInstrumentCount:t}})}0===F.length&&F.push(function(e,t){return{id:"pattern-0",name:"Pattern 0",length:n,channels:Array.from({length:t},(e,t)=>({id:`channel-${t}`,name:`Channel ${t+1}`,muted:!1,solo:!1,collapsed:!1,volume:100,pan:1==(3&t)||2==(3&t)?50:-50,instrumentId:null,color:null,rows:Array.from({length:n},()=>({note:0,instrument:0,volume:0,effTyp:0,eff:0,effTyp2:0,eff2:0}))})),importMetadata:{sourceFormat:"DigitalSymphony",sourceFile:e,importedAt:(new Date).toISOString(),originalChannelCount:t,originalPatternCount:0,originalInstrumentCount:0}}}(r,d));const V=[];for(let n=1;n<=t;n++){const f=63&S[n],r=!!(128&S[n]);let a="";if(f>0){if(k+f>e.length){for(let e=n;e<=t;e++)V.push(w(e));break}const r=e.slice(k,k+f);k+=f;let o=r.indexOf(0);o<0&&(o=f),a=s(r.slice(0,o))}if(r||0===C[n]){V.push(w(n,a||`Sample ${n}`));continue}if(k+8>e.length){V.push(w(n,a||`Sample ${n}`));continue}const l=(e[k]|e[k+1]<<8|e[k+2]<<16)<<1;k+=3;const c=(e[k]|e[k+1]<<8|e[k+2]<<16)<<1;k+=3;const d=Math.min(e[k++],64);e[k++];const T=c>2,U=l,A=T?l+c:0;if(k>=e.length){V.push(w(n,a||`Sample ${n}`));continue}const P=e[k++];let M=null;const I=C[n];switch(P){case 0:{if(k+I>e.length){k+=Math.min(I,e.length-k);break}const t=e.slice(k,k+I);k+=I,M=u(t);break}case 1:{let t;try{t=o(e,k,I)}catch{break}k=t.endPos,M=p(t.output);break}case 2:{if(k+I>e.length){k+=Math.min(I,e.length-k);break}const t=e.slice(k,k+I);k+=I,M=h(t);break}case 3:{if(k+I>e.length){k+=Math.min(I,e.length-k);break}const t=e.slice(k,k+I);k+=I,M=y(t);break}case 4:{let t;try{t=i(e,k,I)}catch{break}k=t.endPos,M=g(t.output);break}case 5:{let t;try{t=i(e,k,I)}catch{break}k=t.endPos,M=b(t.output);break}default:V.push(w(n,a||`Sample ${n}`));continue}if(!M||0===M.length){V.push(w(n,a||`Sample ${n}`));continue}const $=U,B=T?A:0,D=m(M,8287,$,B),L=a.trim()||`Sample ${n}`;V.push({id:n,name:L,type:"sample",synthType:"Sampler",effects:[],volume:0===d?-60:Math.round(d/64*60)-60,pan:0,samplerConfig:{audioBuffer:D,baseNote:"C3",loopStart:T?$/M.length:0,loopEnd:T?B/M.length:0,loopMode:T?"sustain":"none",loopEnabled:T,volume:d/64,pan:0,attack:0,decay:0,sustain:1,release:0}})}if(P>0&&k<e.length){const t=l(e,k,P);t&&(k=t.endPos)}const x=F.map((e,t)=>t);return{name:B,format:"MOD",patterns:F,instruments:V,songPositions:x,songLength:x.length,restartPosition:0,numChannels:d,initialSpeed:6,initialBPM:125,linearPeriods:!1}}(e,r)}catch{return null}}function T(e,t,n,r,s,a,o,i){const l={note:0,instrument:0,volume:0,effTyp:0,eff:0,effTyp2:0,eff2:0};if(t>=n)return l;const c=t*f+4*r;if(c+4>e.length)return l;const u=e[c],h=e[c+1],p=e[c+2],y=e[c+3],b=63&u;0!==b&&(l.note=b+48),l.instrument=u>>6|(15&h)<<2;const g=h>>6|(15&p)<<2,m=p>>4|y<<4;if(!(a[g>>3]&1<<(7&g)))return l;if(0===g&&0===m)return l;const d=255&m,T=m>>8&255;switch(g){case 0:case 1:case 2:{const{effTyp:e,eff:t}=k(15&g,d);l.effTyp=e,l.eff=t,0!==T&&(l.effTyp2=58,l.effTyp2=0,l.eff2=0);break}case 32:case 33:case 34:{const{effTyp:e,eff:t}=k(15&g,d);l.effTyp=e,l.eff=t;break}case 3:l.effTyp=3,l.eff=d;break;case 4:l.effTyp=4,l.eff=d;break;case 5:l.effTyp=5,l.eff=d;break;case 6:l.effTyp=6,l.eff=d;break;case 7:l.effTyp=7,l.eff=d;break;case 9:l.effTyp=9,l.eff=m>>1&255;break;case 10:if(m<255){const{effTyp:e,eff:t}=k(10,d);l.effTyp=e,l.eff=t}else l.effTyp=14,l.eff=16|15&T;break;case 42:if(m<255){const{effTyp:e,eff:t}=k(10,d);l.effTyp=e,l.eff=t}else l.effTyp=14,l.eff=32|15&T;break;case 11:l.effTyp=11,l.eff=Math.min(m,255);break;case 12:l.effTyp=12,l.eff=d;break;case 13:l.effTyp=13,l.eff=d>63?0:d;break;case 15:l.effTyp=15,l.eff=Math.min(m,255);break;case 16:l.effTyp=14,l.eff=15&d;break;case 17:l.effTyp=14,l.eff=255&d?16|15&m:160|15&T;break;case 18:l.effTyp=14,l.eff=255&d?32|15&m:160|15&T;break;case 19:l.effTyp=14,l.eff=48|15&d;break;case 20:l.effTyp=14,l.eff=64|15&d;break;case 21:l.effTyp=14,l.eff=80|15&d;break;case 22:l.effTyp=14,l.eff=96|Math.min(m,15);break;case 23:l.effTyp=14,l.eff=112|15&d;break;case 25:l.effTyp=14,l.eff=144|Math.min(m,15);break;case 26:l.effTyp=14,l.eff=255&d?16|15&m:176|15&T;break;case 27:l.effTyp=14,l.eff=255&d?32|15&m:176|15&T;break;case 28:l.effTyp=14,l.eff=192|Math.min(m,15);break;case 29:l.effTyp=14,l.eff=208|Math.min(m,15);break;case 30:l.effTyp=14,l.eff=224|Math.min(m,15);break;case 31:l.effTyp=14,l.eff=240|15&d;break;case 43:l.effTyp=13,l.eff=d;break;case 47:if(m>0){let e=Math.max(8,m+4)>>3;e<32&&(e=32),e>255&&(e=255),l.effTyp=15,l.eff=e}break;case 48:{const e=[0,0,43,86,128,170,212,255];if(l.effTyp=8,7&m)l.eff=e[7&m];else if(m>>4!=128){const e=m>>4&255;l.eff=e<128?e+128:255-e}else l.effTyp=0,l.eff=0;break}case 49:break;case 50:0===l.note?l.note=97:(l.effTyp=14,l.eff=192)}return l}function w(e,t=`Sample ${e}`){return{id:e,name:t,type:"sample",synthType:"Sampler",effects:[],volume:0,pan:0}}export{c as isDigitalSymphonyFormat,d as parseDigitalSymphonyFile};
