import{aB as e,aD as t}from"./index-zx6LJBPK.js";import"./vendor-react-DkDaD07v.js";import"./vendor-utils-XMmR-oGw.js";import"./vendor-tone-CADp_hfL.js";import"./vendor-ui-uomqNFY-.js";function n(e,t){return e.getUint32(t,!1)}function o(e,t){return e.getUint16(t,!1)}function r(e,t){return e.getInt16(t,!1)}function a(e,t){return e.getUint8(t)}function s(e,t,n){let o="";for(let r=0;r<n;r++){const n=e.getUint8(t+r);if(0===n)break;o+=String.fromCharCode(n)}return o}function l(e){if(0===e)return 0;if(e<0)return 0;const n=t(e);return 0===n?0:n+12}async function i(t,i){const c=new DataView(t),u=new Uint8Array(t);if(t.byteLength<1686)throw new Error("SoundFX: file too small");let m,p,f;if("SONG"===s(c,60,4))m="v1",p=16,f=0;else{if(t.byteLength<2350)throw new Error("SoundFX: file too small for v2.0");if("SO31"!==s(c,124,4))throw new Error("SoundFX: unrecognized magic bytes");m="v2",p=32,f=544}const h=o(c,"v1"===m?64:128);let g=0;const d=[];for(let e=0;e<p;e++){const e=n(c,g);d.push(e),g+=4}g+=20;const v=[],w=[];let M=0;for(let e=0;e<p;e++)w.push(M),e>0&&d[e]>0&&(M+=d[e]);for(let e=0;e<p;e++){if(0===e){v.push(null);continue}if(0===d[e]){v.push(null),g+=30;continue}const t=s(c,g,22),n=o(c,g+22)<<1;a(c,g+24);const r=a(c,g+25),l=o(c,g+26),i=o(c,g+28)<<1;v.push({name:t,length:n,volume:Math.min(r,64),loop:l,repeat:i,pointer:w[e]}),g+=30}const b=530+f,y=a(c,b);let C=b+2;const S=[];let k=0;for(let e=0;e<y;e++){const e=a(c,C);S.push(e),e>k&&(k=e),C++}let P=660+f;"v2"===m&&(P+=4);const $=256*(k+1),D=[];let F=P;for(let e=0;e<$;e++){if(F+4>t.byteLength){D.push({note:0,sample:0,effect:0,param:0}),F+=4;continue}const e=r(c,F),n=a(c,F+2),o=a(c,F+3),s=15&n;let l=n>>4;"v2"===m&&4096&e&&(l+=16),(l>=p||null==v[l])&&(l=0),D.push({note:"v2"===m&&4096&e&&e>0?61439&e:e,sample:l,effect:s,param:o}),F+=4}const I=F,O=[];for(let n=1;n<p;n++){const o=v[n];if(!o||0===o.length)continue;const r=I+o.pointer,a=r+o.length;if(a>t.byteLength)continue;const s=u.slice(r,a);let l=0,i=0;o.loop>0&&o.repeat>2?(l=o.loop,i=o.loop+o.repeat):o.repeat>2&&(i=o.repeat),O.push(e(n,o.name||`Sample ${n}`,s,o.volume,8287,l,i))}const j=[...new Set(S)].sort((e,t)=>e-t),A=new Map,L=[];for(let e=0;e<j.length;e++){const t=j[e];A.set(t,e);const n=256*t,o=[];for(let e=0;e<4;e++){const t=[];for(let o=0;o<64;o++){const r=n+4*o+e,a=r<D.length?D[r]:{note:0,sample:0,effect:0,param:0};let s=0,i=0,c=0,u=0,m=0;if(-3===a.note||(-2===a.note?s=97:-4===a.note?(u=13,m=0):-5===a.note||a.note>0&&(s=l(a.note))),a.sample>0){i=a.sample;const e=v[a.sample];e&&(c=16+Math.min(e.volume,64))}if(5===a.effect&&a.sample>0){const e=v[a.sample];e&&(c=16+Math.min(e.volume+a.param,64))}else if(6===a.effect&&a.sample>0){const e=v[a.sample];e&&(c=16+Math.max(e.volume-a.param,0))}if(0===u)switch(a.effect){case 0:case 5:case 6:break;case 1:0!==a.param&&(u=0,m=a.param);break;case 2:{const e=a.param>>4,t=15&a.param;e>0?(u=2,m=e):t>0&&(u=1,m=t)}break;case 3:u=14,m=1;break;case 4:u=14,m=0;break;case 7:{const e=15&a.param;e>0&&(u=1,m=e)}break;case 8:{const e=15&a.param;e>0&&(u=2,m=e)}break;case 9:0!==a.param&&(u=2,m=15&a.param)}t.push({note:s,instrument:i,volume:c,effTyp:u,eff:m,effTyp2:0,eff2:0,period:a.note>0?a.note:void 0})}const r=0===e||3===e?-50:50;o.push({id:`channel-${e}`,name:`Channel ${e+1}`,muted:!1,solo:!1,collapsed:!1,volume:100,pan:r,instrumentId:null,color:null,rows:t})}L.push({id:`pattern-${e}`,name:`Pattern ${e}`,length:64,channels:o,importMetadata:{sourceFormat:"MOD",sourceFile:i,importedAt:(new Date).toISOString(),originalChannelCount:4,originalPatternCount:j.length,originalInstrumentCount:O.length}})}const U=S.map(e=>A.get(e)??0);0===L.length&&(L.push({id:"pattern-0",name:"Pattern 0",length:64,channels:Array.from({length:4},(e,t)=>({id:`channel-${t}`,name:`Channel ${t+1}`,muted:!1,solo:!1,collapsed:!1,volume:100,pan:0===t||3===t?-50:50,instrumentId:null,color:null,rows:Array.from({length:64},()=>({note:0,instrument:0,volume:0,effTyp:0,eff:0,effTyp2:0,eff2:0}))})),importMetadata:{sourceFormat:"MOD",sourceFile:i,importedAt:(new Date).toISOString(),originalChannelCount:4,originalPatternCount:0,originalInstrumentCount:0}}),U.push(0));const x=h>0?Math.round(1776930/h):125;return{name:i.replace(/\.[^/.]+$/,""),format:"MOD",patterns:L,instruments:O,songPositions:U,songLength:U.length,restartPosition:0,numChannels:4,initialSpeed:6,initialBPM:Math.max(32,Math.min(255,x||125)),linearPeriods:!1}}export{i as parseSoundFXFile};
