import{aW as e}from"./index-zx6LJBPK.js";import"./vendor-react-DkDaD07v.js";import"./vendor-utils-XMmR-oGw.js";import"./vendor-tone-CADp_hfL.js";import"./vendor-ui-uomqNFY-.js";function t(e,t){return e.getUint8(t)}function n(e,t){return e.getUint16(t,!0)}function o(e,t){return e.getUint32(t,!0)}function r(e,t,n){let o="";for(let r=0;r<n;r++){const n=e.getUint8(t+r);if(0===n)break;o+=String.fromCharCode(n)}return o}const f=64,a=[0,15,11,13,10,2,1,3,4,29,0,0,0,0,0,0];function i(e){if(e.byteLength<64)return!1;const r=new DataView(e);if(83!==t(r,60)||67!==t(r,61)||82!==t(r,62)||77!==t(r,63))return!1;const f=n(r,28),a=n(r,30),i=o(r,38),l=t(r,42),s=o(r,44),u=n(r,48),p=n(r,50),c=n(r,52);if(0!==a)return!1;if(0!==i)return!1;if(1!==s)return!1;if(f<64&&26!==f)return!1;if(f>2112)return!1;if(l>64&&88!==l)return!1;if(u>64)return!1;if(p>96)return!1;if(c>129&&257!==c)return!1;for(let n=20;n<28;n++){const e=t(r,n);if(e<32||e>=127)return!1}return!0}function l(e,t){const n=15&e,o=a[n];if(0===n||n>=10)return{effTyp:0,eff:0};switch(n){case 1:return 0===t?{effTyp:0,eff:0}:{effTyp:o,eff:t>>4};case 2:return{effTyp:o,eff:t};case 3:return{effTyp:o,eff:10*(t>>4)+(15&t)};case 4:{let e=t;return e&=15&e?15:240,{effTyp:o,eff:e}}default:return 0===t?{effTyp:0,eff:0}:{effTyp:o,eff:t}}}function s(e,n){const f=t(e,n),a=16*(t(e,n+14)|t(e,n+15)<<8|t(e,n+13)<<16);return{sampleType:f,filename:r(e,n+1,12),dataOffset:a,length:o(e,n+16),loopStart:o(e,n+20),loopEnd:o(e,n+24),defaultVolume:Math.min(t(e,n+28),64),pack:t(e,n+30),flags:t(e,n+31),c5speed:o(e,n+32),name:r(e,n+48,28)}}function u(e,t){const n=()=>({note:0,instrument:0,volume:0,effTyp:0,eff:0,effTyp2:0,eff2:0}),o=Array.from({length:f},()=>Array.from({length:t},n));let r=0,a=0;for(;a<f&&r<e.length;){const n=e[r++];if(0===n){a++;continue}const f=31&n;let i=0,s=0,u=0,p=0,c=0;if(32&n){const t=e[r++];if(s=e[r++],254===t)i=97;else if(255!==t){i=12*(t>>4&15)+(15&t)+1}}if(64&n){const t=e[r++];u=t<=64?t:0}if(128&n){const t=e[r++],n=e[r++],{effTyp:o,eff:f}=l(t,n);p=o,c=f}f<t&&(o[a][f]={note:i,instrument:s,volume:u,effTyp:p,eff:c,effTyp2:0,eff2:0})}return o}function p(e,t,n,o,r){const a={note:0,instrument:0,volume:0,effTyp:0,eff:0,effTyp2:0,eff2:0},i=[];for(let l=0;l<t;l++)i.push({id:`channel-${l}`,name:`Channel ${l+1}`,muted:!1,solo:!1,collapsed:!1,volume:100,pan:0,instrumentId:null,color:null,rows:Array.from({length:f},()=>({...a}))});return{id:`pattern-${e}`,name:`Pattern ${e}`,length:f,channels:i,importMetadata:{sourceFormat:"STX",sourceFile:n,importedAt:(new Date).toISOString(),originalChannelCount:t,originalPatternCount:o+1,originalInstrumentCount:r}}}function c(e,t){return{id:e,name:t||`Sample ${e}`,type:"sample",synthType:"Sampler",effects:[],volume:-60,pan:0}}function m(e,t,n){const o=Math.min(t+n,e.length)-t,r=new ArrayBuffer(o),f=new Uint8Array(r);for(let a=0;a<o;a++)f[a]=e[t+a];return r}function h(o,a){if(!i(o))throw new Error("Not a valid STX file");const l=new DataView(o),h=new Uint8Array(o),g=r(l,0,20),d=n(l,28),y=n(l,32),T=n(l,34),S=n(l,36);Math.min(t(l,42),64);const w=t(l,43)||96,v=n(l,48),C=n(l,50),$=n(l,52),M=Math.max(1,w>>4),b=y<<4,A=[];for(let e=0;e<v;e++)A.push(n(l,b+2*e));const L=T<<4,P=[];for(let e=0;e<C;e++)P.push(n(l,L+2*e));const D=32+(S<<4),I=[];for(let e=0;e<$;e++){const n=t(l,D+5*e);if(99===n||255===n)break;n<=63&&I.push(n)}0===I.length&&I.push(0);let O=1;if(v>0&&26!==d){const e=A[0]<<4;e+2<=o.byteLength&&n(l,e)===d&&(O=0)}const U=[];for(let t=0;t<C;t++){const n=t+1,r=P[t]<<4;if(0===r||r+80>o.byteLength){U.push(c(n,`Sample ${n}`));continue}const f=s(l,r);if(1!==f.sampleType){const e=f.name.replace(/\0/g,"").trim()||`Sample ${n}`;U.push(c(n,e));continue}const a=f.name.replace(/\0/g,"").trim()||f.filename.replace(/\0/g,"").trim()||`Sample ${n}`;if(1===f.pack||0===f.length||0===f.dataOffset||f.dataOffset>=o.byteLength){U.push(c(n,a));continue}const i=!!(4&f.flags),u=i?2:1,p=f.length*u,g=m(h,f.dataOffset,p),d=!!(1&f.flags)&&f.loopEnd>f.loopStart&&f.loopEnd<=f.length,y=d?f.loopEnd-f.loopStart:0,T={id:n,name:a,pcmData:g,bitDepth:i?16:8,sampleRate:f.c5speed||8363,length:f.length,loopStart:d?f.loopStart:0,loopLength:y,loopType:d?"forward":"none",volume:f.defaultVolume,finetune:0,relativeNote:0,panning:128},S=e({id:n,name:a,samples:[T],fadeout:0},n,"S3M");S.length>0?U.push(S[0]):U.push(c(n,a))}const j=new Set(I);for(let e=0;e<v;e++)j.add(e);const E=Array.from(j).sort((e,t)=>e-t),k=E.length>0?E[E.length-1]:0,F=[],V=new Map;for(const e of E){if(e>=A.length||0===A[e]){V.set(e,F.length),F.push(p(e,4,a,k,C));continue}const t=A[e]<<4;if(t+2>o.byteLength){V.set(e,F.length),F.push(p(e,4,a,k,C));continue}let r,i=t;if(0===O){if(n(l,t)>2112){V.set(e,F.length),F.push(p(e,4,a,k,C));continue}i=t+2}r=0===O?n(l,t):Math.min(2048,o.byteLength-i);const s=u(h.subarray(i,i+r),4),c=[];for(let e=0;e<4;e++){const t=[];for(let n=0;n<f;n++)t.push(s[n]?.[e]??{note:0,instrument:0,volume:0,effTyp:0,eff:0,effTyp2:0,eff2:0});c.push({id:`channel-${e}`,name:`Channel ${e+1}`,muted:!1,solo:!1,collapsed:!1,volume:100,pan:0,instrumentId:null,color:null,rows:t})}V.set(e,F.length),F.push({id:`pattern-${e}`,name:`Pattern ${e}`,length:f,channels:c,importMetadata:{sourceFormat:"STX",sourceFile:a,importedAt:(new Date).toISOString(),originalChannelCount:4,originalPatternCount:k+1,originalInstrumentCount:C}})}const x=[];for(const e of I){const t=V.get(e);void 0!==t&&x.push(t)}return 0===x.length&&x.push(0),{name:g.replace(/\0/g,"").trim()||a.replace(/\.[^/.]+$/,""),format:"S3M",patterns:F,instruments:U,songPositions:x,songLength:x.length,restartPosition:0,numChannels:4,initialSpeed:M,initialBPM:125,linearPeriods:!1}}export{i as isSTXFormat,h as parseSTXFile};
