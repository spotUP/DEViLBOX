const e=[0,5760,5424,5120,4832,4560,4304,4064,3840,3616,3424,3232,3048,2880,2712,2560,2416,2280,2152,2032,1920,1808,1712,1616,1524,1440,1356,1280,1208,1140,1076,1016,960,904,856,808,762,720,678,640,604,570,538,508,480,453,428,404,381,360,339,320,302,285,269,254,240,226,214,202,190,180,170,160,151,143,135,127,120,113,107,101,95];function t(e,t,n){let a="";for(let o=0;o<n;o++){const n=e[t+o];if(0===n)break;a+=String.fromCharCode(n)}return a}function n(e,t){return e[t]}function a(e,t){const n=e[t];return n<128?n:n-256}function o(e,t){return e[t]<<8|e[t+1]}function r(e,t){const n=e[t]<<8|e[t+1];return n<32768?n:n-65536}function s(e,t){return(e[t]<<24|e[t+1]<<16|e[t+2]<<8|e[t+3])>>>0}function i(t,n){if(t<=0||t>72)return 0;const a=t+n;if(a<1||a>72)return 0;const o=e[a];return o?function(t){if(t<=0)return 0;let n=1,a=Math.abs(e[1]-t);for(let o=2;o<=72;o++){const r=Math.abs(e[o]-t);r<a&&(a=r,n=o)}return n+12}(o):0}async function l(e,l){const c=new Uint8Array(e),p=t(c,58,28);if("SIDMON II - THE MIDI VERSION"!==p)throw new Error(`Not a SidMon II file: magic="${p}"`);let f=2;const u=n(c,f);f++;const d=n(c,f);f++;const m=o(c,f)>>6;f+=2;const h=s(c,14),g=s(c,26);f=90;const M=h,y=new Array(M);let v=0;for(let t=0;t<M;t++){const e={pattern:0,transpose:0,soundTranspose:0};e.pattern=n(c,f),f++,e.pattern>v&&(v=e.pattern),y[t]=e}for(let t=0;t<M;t++)y[t].transpose=a(c,f),f++;for(let t=0;t<M;t++)y[t].soundTranspose=a(c,f),f++;const S=f,b=1+(g>>5),w=new Array(b);w[0]={wave:0,waveLen:0,waveSpeed:0,waveDelay:0,arpeggio:0,arpeggioLen:0,arpeggioSpeed:0,arpeggioDelay:0,vibrato:0,vibratoLen:0,vibratoSpeed:0,vibratoDelay:0,pitchBend:0,pitchBendDelay:0,attackMax:0,attackSpeed:0,decayMin:0,decaySpeed:0,sustain:0,releaseMin:0,releaseSpeed:0},f=S;for(let t=1;t<b;t++){const e=n(c,f)<<4;f++;const o=n(c,f);f++;const r=n(c,f);f++;const s=n(c,f);f++;const i=n(c,f)<<4;f++;const l=n(c,f);f++;const p=n(c,f);f++;const u=n(c,f);f++;const d=n(c,f)<<4;f++;const m=n(c,f);f++;const h=n(c,f);f++;const g=n(c,f);f++;const M=a(c,f);f++;const y=n(c,f);f++,f++,f++;const v=n(c,f);f++;const S=n(c,f);f++;const b=n(c,f);f++;const P=n(c,f);f++;const k=n(c,f);f++;const D=n(c,f);f++;const C=n(c,f);f++,f+=9,w[t]={wave:e,waveLen:o,waveSpeed:r,waveDelay:s,arpeggio:i,arpeggioLen:l,arpeggioSpeed:p,arpeggioDelay:u,vibrato:d,vibratoLen:m,vibratoSpeed:h,vibratoDelay:g,pitchBend:M,pitchBendDelay:y,attackMax:v,attackSpeed:S,decayMin:b,decaySpeed:P,sustain:k,releaseMin:D,releaseSpeed:C}}const P=f,k=s(c,30),D=new Uint8Array(k);f=P;for(let t=0;t<k;t++)D[t]=n(c,f),f++;const C=f,I=s(c,34),A=new Int8Array(I);f=C;for(let t=0;t<I;t++)A[t]=a(c,f),f++;const T=f,x=s(c,38),L=new Int8Array(x);f=T;for(let t=0;t<x;t++)L[t]=a(c,f),f++;const $=new Array(m);let O=0;for(let n=0;n<m;n++){f+=4;const e=o(c,f)<<1;f+=2;const a=o(c,f)<<1;f+=2;const i=o(c,f)<<1;f+=2;const l=O+(o(c,f)<<1);f+=2;const p=o(c,f)<<1;f+=2;const u=o(c,f);f+=2;const d=o(c,f);f+=2;const m=r(c,f);f+=2;const h=s(c,f);f+=4;const g=o(c,f);f+=2,f+=6;const M=t(c,f,32);f+=32,$[n]={name:M,length:e,loop:a,repeat:i,pointer:O,loopPtr:O+a,negStart:l,negLen:p,negSpeed:u,negDir:d,negOffset:m,negPos:h,negCtr:g},O+=e}const B=v+1,N=new Uint16Array(B+1);for(let t=0;t<B;t++)N[t]=o(c,f),f+=2;const F=f,U=s(c,50),E=[];let R=0,H=1;for(let t=0;t<U;){const e={note:0,sample:0,effect:0,param:0,speed:0},o=a(c,f);if(f++,t++,0===o)e.effect=a(c,f),f++,t++,e.param=n(c,f),f++,t++;else if(o<0)e.speed=~o;else if(o<112){e.note=o;const r=a(c,f);if(f++,t++,r<0)e.speed=~r;else if(r<112){e.sample=r;const o=a(c,f);f++,t++,o<0?e.speed=~o:(e.effect=o,e.param=n(c,f),f++,t++)}else e.effect=r,e.param=n(c,f),f++,t++}else e.effect=o,e.param=n(c,f),f++,t++;E[R++]=e,H<B&&F+N[H]===f&&(N[H]=R,H++)}N[H]=E.length,1&f&&f++;const V=f,W=[];for(let t=0;t<m;t++){const e=$[t];e.length>0&&V+e.pointer+e.length<=c.length?W.push(c.slice(V+e.pointer,V+e.pointer+e.length)):W.push(new Uint8Array(0))}for(let t=0;t<M;t++)y[t].pattern=N[y[t].pattern];const j=u+1,q=[];for(let t=1;t<b;t++){const e=w[t],n=e.wave<D.length?D[e.wave]:-1,a=n>=0&&n<m&&W[n].length>0?W[n]:void 0,o=n>=0&&n<m?$[n]:null,r=Math.max(0,Math.min(15,15-Math.floor(16*e.attackSpeed/256))),s=Math.max(0,Math.min(15,15-Math.floor(16*e.decaySpeed/256))),i=Math.max(0,Math.min(15,Math.round(15*e.decayMin/255))),l=Math.max(0,Math.min(15,15-Math.floor(16*e.releaseSpeed/256))),c=[],p=e.arpeggio;for(let t=0;t<8;t++)c.push(p+t<A.length?A[p+t]:0);const f=Math.min(255,e.vibratoDelay),u=Math.min(63,e.vibratoSpeed),d=Math.min(63,e.vibratoLen),h=o&&o.repeat>2?o.loop:0,g=o&&o.repeat>2?o.repeat:0,M={type:"pcm",waveform:1,pulseWidth:128,attack:r,decay:s,sustain:i,release:l,arpTable:c,arpSpeed:Math.min(15,e.arpeggioSpeed),vibDelay:f,vibSpeed:u,vibDepth:d,filterCutoff:255,filterResonance:0,filterMode:0,pcmData:a,loopStart:h,loopLength:g};q.push({id:t,name:o?.name||`Instrument ${t}`,type:"synth",synthType:"SidMonSynth",sidMon:M,effects:[],volume:-6,pan:0})}const z=[],G=Array.from({length:4},()=>({step:null,patternPtr:0,speed:0,note:0,instrument:0,instr:w[0],volume:0,adsrPos:0,sustainCtr:0}));let J=d;for(let t=0;t<j;t++){const e=[[],[],[],[]];for(let n=0;n<64;n++)for(let a=0;a<4;a++){const o=G[a];let r=!1,s=0,l=0,c=0,p=0;if(0===n){const e=t+a*j;e<y.length&&(o.step=y[e],o.patternPtr=o.step.pattern),o.speed=0}if(o.speed--,o.speed<0){const e=o.patternPtr<E.length?E[o.patternPtr]:null;if(e){if(o.patternPtr++,o.speed=e.speed,e.note>0){r=!0;const t=o.step,n=t?t.transpose:0,a=t?t.soundTranspose:0;if(o.note=e.note+n,e.sample>0){o.instrument=e.sample;const t=o.instrument+a;t>=0&&t<b&&(o.instr=w[t],p=t)}c=i(o.note,0),o.adsrPos=4,o.volume=0,o.sustainCtr=0}if(e.effect){const t=e.effect,n=e.param;switch(t){case 112:s=0,l=n;break;case 113:s=1,l=n;break;case 114:s=2,l=n;break;case 115:s=10,l=(15&n)<<4;break;case 116:s=10,l=15&n;break;case 117:case 118:break;case 124:s=12,l=Math.min(n,64);break;case 127:s=15,l=15&n,l>0&&(J=l);break;default:t>0&&t<112&&n>0&&(s=3,l=n)}}}}const f=o.instr;switch(o.adsrPos){case 4:o.volume+=f.attackSpeed,o.volume>=f.attackMax&&(o.volume=f.attackMax,o.adsrPos=3);break;case 3:f.decaySpeed?(o.volume-=f.decaySpeed,o.volume<=f.decayMin&&(o.volume=f.decayMin,o.adsrPos=2)):o.adsrPos=2;break;case 2:o.sustainCtr>=f.sustain?o.adsrPos=1:o.sustainCtr++;break;case 1:o.volume-=f.releaseSpeed,o.volume<=f.releaseMin&&(o.volume=f.releaseMin,o.adsrPos=0)}const u=Math.max(0,Math.min(255,o.volume)),d=r?16+Math.min(64,u>>2):0;e[a].push({note:c,instrument:p,volume:d,effTyp:s,eff:l,effTyp2:0,eff2:0})}if(0===t){const t=e[0][0];0===t.effTyp&&0===t.eff&&(t.effTyp=15,t.eff=J)}z.push({id:`pattern-${t}`,name:`Pattern ${t}`,length:64,channels:e.map((e,t)=>({id:`channel-${t}`,name:`Channel ${t+1}`,muted:!1,solo:!1,collapsed:!1,volume:100,pan:0===t||3===t?-50:50,instrumentId:null,color:null,rows:e})),importMetadata:{sourceFormat:"SIDMON2",sourceFile:l,importedAt:(new Date).toISOString(),originalChannelCount:4,originalPatternCount:B,originalInstrumentCount:b-1}})}0===z.length&&z.push({id:"pattern-0",name:"Pattern 0",length:64,channels:Array.from({length:4},(e,t)=>({id:`channel-${t}`,name:`Channel ${t+1}`,muted:!1,solo:!1,collapsed:!1,volume:100,pan:0===t||3===t?-50:50,instrumentId:null,color:null,rows:Array.from({length:64},()=>({note:0,instrument:0,volume:0,effTyp:0,eff:0,effTyp2:0,eff2:0}))})),importMetadata:{sourceFormat:"SIDMON2",sourceFile:l,importedAt:(new Date).toISOString(),originalChannelCount:4,originalPatternCount:0,originalInstrumentCount:0}});return{name:l.replace(/\.[^/.]+$/,""),format:"MOD",patterns:z,instruments:q,songPositions:z.map((e,t)=>t),songLength:z.length,restartPosition:0,numChannels:4,initialSpeed:d||6,initialBPM:125,linearPeriods:!1}}export{l as parseSidMon2File};
