import{bF as e,bG as t,bH as i,bI as s,bg as o,aN as n}from"./index-8CwCY7yO.js";import"./vendor-utils-Cm-70yv0.js";import"./vendor-react-LeNVipsj.js";import"./vendor-tone-CADp_hfL.js";import"./vendor-ui-Dw7lX8uV.js";const c=32;class a{name="HarmonicSynth";output;config;audioContext;filter;masterGain;lfo;lfoGain;voices=new Map;voiceOrder=[];currentWave;constructor(t){this.config={...t,harmonics:[...t.harmonics]},this.audioContext=e(),this.output=this.audioContext.createGain(),this.output.gain.value=1,this.masterGain=this.audioContext.createGain(),this.masterGain.gain.value=.7,this.filter=this.audioContext.createBiquadFilter(),this.filter.type=t.filter.type,this.filter.frequency.value=t.filter.cutoff,this.filter.Q.value=t.filter.resonance,this.lfo=this.audioContext.createOscillator(),this.lfo.type="sine",this.lfo.frequency.value=t.lfo.rate,this.lfoGain=this.audioContext.createGain(),this.lfoGain.gain.value=0,this.filter.connect(this.masterGain),this.masterGain.connect(this.output),this.lfo.connect(this.lfoGain),this.lfo.start(),this.connectLFO(),this.currentWave=this.buildPeriodicWave()}buildPeriodicWave(){const e=new Float32Array(33),t=new Float32Array(33);e[0]=0,t[0]=0;const i=this.config.spectralTilt/100,s=this.config.evenOddBalance/100;for(let o=1;o<=c;o++){let e=this.config.harmonics[o-1]||0;0!==i&&(e*=Math.pow(o,-i));const n=o%2==0;s>0&&!n?e*=1-s:s<0&&n&&(e*=1+s),t[o]=e}return this.audioContext.createPeriodicWave(e,t,{disableNormalization:!1})}connectLFO(){try{this.lfoGain.disconnect()}catch{}const e=this.config.lfo.depth/100;switch(this.config.lfo.target){case"pitch":this.lfoGain.gain.value=50*e;break;case"filter":this.lfoGain.gain.value=2e3*e,this.lfoGain.connect(this.filter.frequency)}}triggerAttack(e,o,n=1){const c=o??t(),a="string"==typeof e?i(e):e,r="string"==typeof e?s(e):Math.round(69+12*Math.log2(e/440)),l=this.voices.get(r);l&&(this.killVoice(l),this.voices.delete(r),this.voiceOrder=this.voiceOrder.filter(e=>e!==r));const f=this.config.maxVoices||6;for(;this.voices.size>=f&&this.voiceOrder.length>0;){const e=this.voiceOrder.shift(),t=this.voices.get(e);t&&(this.killVoice(t),this.voices.delete(e))}const h=this.audioContext.createOscillator();h.setPeriodicWave(this.currentWave),h.frequency.setValueAtTime(a,c);const u=this.audioContext.createGain();u.gain.setValueAtTime(0,c),h.connect(u),u.connect(this.filter),"pitch"===this.config.lfo.target&&this.config.lfo.depth>0&&this.lfoGain.connect(h.detune),h.start(c);const v=this.config.envelope,d=v.attack/1e3,g=v.decay/1e3,p=v.sustain/100*n;u.gain.linearRampToValueAtTime(n,c+d),u.gain.linearRampToValueAtTime(p,c+d+g);const m={osc:h,gain:u,midiNote:r};this.voices.set(r,m),this.voiceOrder.push(r)}triggerRelease(e,i){const o=i??t();if(void 0===e){for(const e of this.voices.values())this.scheduleRelease(e,o);return}const n="string"==typeof e?s(e):"number"==typeof e&&e<128?e:Math.round(69+12*Math.log2(e/440)),c=this.voices.get(n);c&&this.scheduleRelease(c,o)}triggerAttackRelease(e,i,s,o){const n=s??t();this.triggerAttack(e,n,o),this.triggerRelease(e,n+i)}scheduleRelease(e,t){const i=this.config.envelope.release/1e3;e.gain.gain.cancelScheduledValues(t),e.gain.gain.setValueAtTime(e.gain.gain.value,t),e.gain.gain.linearRampToValueAtTime(0,t+i);const s=1e3*(i+.05);e.releaseTimeout=setTimeout(()=>{this.killVoice(e),this.voices.delete(e.midiNote),this.voiceOrder=this.voiceOrder.filter(t=>t!==e.midiNote)},s)}killVoice(e){e.releaseTimeout&&clearTimeout(e.releaseTimeout);try{e.osc.stop()}catch{}try{e.osc.disconnect()}catch{}try{e.gain.disconnect()}catch{}}set(e,t){let i=!1;if(e.startsWith("harmonic_")){const s=parseInt(e.split("_")[1],10);s>=0&&s<c&&(this.config.harmonics[s]=t,i=!0)}else if("spectralTilt"===e)this.config.spectralTilt=t,i=!0;else if("evenOddBalance"===e)this.config.evenOddBalance=t,i=!0;else if("filterCutoff"===e)this.config.filter.cutoff=t,this.filter.frequency.value=t;else if("filterResonance"===e)this.config.filter.resonance=t,this.filter.Q.value=t;else if("filterType"===e){const e=["lowpass","highpass","bandpass"];this.config.filter.type=e[t]||"lowpass",this.filter.type=this.config.filter.type}else if("attack"===e)this.config.envelope.attack=t;else if("decay"===e)this.config.envelope.decay=t;else if("sustain"===e)this.config.envelope.sustain=t;else if("release"===e)this.config.envelope.release=t;else if("lfoRate"===e)this.config.lfo.rate=t,this.lfo.frequency.value=t;else if("lfoDepth"===e)this.config.lfo.depth=t,this.connectLFO();else if("lfoTarget"===e){const e=["pitch","filter","spectral"];this.config.lfo.target=e[t]||"pitch",this.connectLFO()}if(i){this.currentWave=this.buildPeriodicWave();for(const e of this.voices.values())e.osc.setPeriodicWave(this.currentWave)}}get(e){if(e.startsWith("harmonic_")){const t=parseInt(e.split("_")[1],10);return this.config.harmonics[t]}switch(e){case"spectralTilt":return this.config.spectralTilt;case"evenOddBalance":return this.config.evenOddBalance;case"filterCutoff":return this.config.filter.cutoff;case"filterResonance":return this.config.filter.resonance;case"attack":return this.config.envelope.attack;case"decay":return this.config.envelope.decay;case"sustain":return this.config.envelope.sustain;case"release":return this.config.envelope.release;case"lfoRate":return this.config.lfo.rate;case"lfoDepth":return this.config.lfo.depth;default:return}}setHarmonics(e){for(let t=0;t<c;t++)this.config.harmonics[t]=e[t]||0;this.currentWave=this.buildPeriodicWave();for(const t of this.voices.values())t.osc.setPeriodicWave(this.currentWave)}applyConfig(e){let t=!1;if(e.harmonics){for(let t=0;t<c;t++)this.config.harmonics[t]=e.harmonics[t]??this.config.harmonics[t];t=!0}if(void 0!==e.spectralTilt&&(this.config.spectralTilt=e.spectralTilt,t=!0),void 0!==e.evenOddBalance&&(this.config.evenOddBalance=e.evenOddBalance,t=!0),e.filter&&(void 0!==e.filter.type&&(this.config.filter.type=e.filter.type,this.filter.type=e.filter.type),void 0!==e.filter.cutoff&&(this.config.filter.cutoff=e.filter.cutoff,this.filter.frequency.value=e.filter.cutoff),void 0!==e.filter.resonance&&(this.config.filter.resonance=e.filter.resonance,this.filter.Q.value=e.filter.resonance)),e.envelope&&(void 0!==e.envelope.attack&&(this.config.envelope.attack=e.envelope.attack),void 0!==e.envelope.decay&&(this.config.envelope.decay=e.envelope.decay),void 0!==e.envelope.sustain&&(this.config.envelope.sustain=e.envelope.sustain),void 0!==e.envelope.release&&(this.config.envelope.release=e.envelope.release)),e.lfo){let t=!1;void 0!==e.lfo.target&&(this.config.lfo.target=e.lfo.target,t=!0),void 0!==e.lfo.rate&&(this.config.lfo.rate=e.lfo.rate,this.lfo.frequency.value=e.lfo.rate),void 0!==e.lfo.depth&&(this.config.lfo.depth=e.lfo.depth,t=!0),t&&this.connectLFO()}if(t){this.currentWave=this.buildPeriodicWave();for(const e of this.voices.values())e.osc.setPeriodicWave(this.currentWave)}}dispose(){for(const e of this.voices.values())this.killVoice(e);this.voices.clear(),this.voiceOrder=[];try{this.lfo.stop()}catch{}try{this.lfo.disconnect()}catch{}try{this.lfoGain.disconnect()}catch{}try{this.filter.disconnect()}catch{}try{this.masterGain.disconnect()}catch{}}}const r={id:"HarmonicSynth",name:"Harmonic Synth",category:"native",loadMode:"lazy",create:e=>{const t=e.harmonicSynth||n;return new a(t)},volumeOffsetDb:5,useSynthBus:!0,controlsComponent:"HarmonicSynthControls"};o.register(r);
