class t{pos;data;view;constructor(t,e=0){this.data=t,this.view=new DataView(t.buffer,t.byteOffset,t.byteLength),this.pos=e}get length(){return this.data.length}get remaining(){return this.data.length-this.pos}canRead(t){return this.pos+t<=this.data.length}u8(){if(!this.canRead(1))throw new Error("EOF");return this.data[this.pos++]}u16be(){if(!this.canRead(2))throw new Error("EOF");const t=this.view.getUint16(this.pos,!1);return this.pos+=2,t}u32be(){if(!this.canRead(4))throw new Error("EOF");const t=this.view.getUint32(this.pos,!1);return this.pos+=4,t}bytes(t){if(!this.canRead(t))throw new Error("EOF");const e=this.data.slice(this.pos,this.pos+t);return this.pos+=t,e}skip(t){this.pos=Math.min(this.pos+t,this.data.length)}}function e(t,e,n){let a="";const s=Math.min(e+n,t.length);for(let i=e;i<s;i++){const e=t[i];if(0===e)break;a+=e>=32&&e<128||e>=160?String.fromCharCode(e):" "}return a.trimEnd()}function n(t,e){const n=t.get(e);return n&&n.length>0?n[0].data:null}const a=[0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,0,0,20,21,0,0,0,25,0,0,0,0,0,0,0,0,0,0];function s(t,e){let n=t<a.length?a[t]:0,s=e;if(0===n&&0!==t)return{effTyp:0,eff:0};switch(t){case 0:0===e&&(n=0);break;case 13:s=10*(e>>4)+(15&e);break;case 10:case 5:case 6:240&e&&240&~e&&15&~e&&(s=240&e);break;case 16:s=e<=64?2*e:128}return{effTyp:n,eff:s}}function i(t,e,n){const a=2*e,s=44+a,i=new ArrayBuffer(s),r=new DataView(i);r.setUint8(0,82),r.setUint8(1,73),r.setUint8(2,70),r.setUint8(3,70),r.setUint32(4,s-8,!0),r.setUint8(8,87),r.setUint8(9,65),r.setUint8(10,86),r.setUint8(11,69),r.setUint8(12,102),r.setUint8(13,109),r.setUint8(14,116),r.setUint8(15,32),r.setUint32(16,16,!0),r.setUint16(20,1,!0),r.setUint16(22,1,!0),r.setUint32(24,n,!0),r.setUint32(28,2*n,!0),r.setUint16(32,2,!0),r.setUint16(34,16,!0),r.setUint8(36,100),r.setUint8(37,97),r.setUint8(38,116),r.setUint8(39,97),r.setUint32(40,a,!0);const o=new DataView(t.buffer,t.byteOffset,t.byteLength);let f=44;for(let l=0;l<e;l++){const t=o.getInt16(2*l,!1);r.setInt16(f,t,!0),f+=2}return i}function r(t,e,n){const a=Math.min(e.volume,64),s=a>0?20*Math.log10(a/64):-60,r=e.sampleRate>0?Math.round(8303*e.sampleRate/8363):8287,o=e.loopLength>0&&!!(3&e.flags),f=o?e.loopStart+e.loopLength:0,l=e.name||`Instrument ${t}`;if(!n||0===n.frames||0===n.data.length)return{id:t,name:l,type:"sample",synthType:"Sampler",effects:[],volume:0,pan:0};let u;if(8===n.bits)u=function(t,e){const n=t.length,a=2*n,s=44+a,i=new ArrayBuffer(s),r=new DataView(i);r.setUint8(0,82),r.setUint8(1,73),r.setUint8(2,70),r.setUint8(3,70),r.setUint32(4,s-8,!0),r.setUint8(8,87),r.setUint8(9,65),r.setUint8(10,86),r.setUint8(11,69),r.setUint8(12,102),r.setUint8(13,109),r.setUint8(14,116),r.setUint8(15,32),r.setUint32(16,16,!0),r.setUint16(20,1,!0),r.setUint16(22,1,!0),r.setUint32(24,e,!0),r.setUint32(28,2*e,!0),r.setUint16(32,2,!0),r.setUint16(34,16,!0),r.setUint8(36,100),r.setUint8(37,97),r.setUint8(38,116),r.setUint8(39,97),r.setUint32(40,a,!0);let o=44;for(let f=0;f<n;f++){const e=t[f]<128?t[f]:t[f]-256;r.setInt16(o,256*e,!0),o+=2}return i}(n.data,r);else if(16===n.bits)u=i(n.data,n.frames,r);else{const t=Math.floor(n.data.length/4),e=new Uint8Array(2*t);for(let a=0;a<t;a++)e[2*a]=n.data[4*a],e[2*a+1]=n.data[4*a+1];u=i(e,t,r)}const c=function(t){const e=new Uint8Array(t);let n="";for(let a=0;a<e.length;a+=8192)n+=String.fromCharCode(...Array.from(e.subarray(a,Math.min(a+8192,e.length))));return`data:audio/wav;base64,${btoa(n)}`}(u);return{id:t,name:l,type:"sample",synthType:"Sampler",effects:[],volume:s,pan:0,sample:{audioBuffer:u,url:c,baseNote:"C3",detune:0,loop:o,loopType:o?2&e.flags?"pingpong":"forward":"off",loopStart:e.loopStart,loopEnd:f>0?f:n.frames,sampleRate:r,reverse:!1,playbackRate:1},metadata:{modPlayback:{usePeriodPlayback:!1,periodMultiplier:3546895,finetune:0,defaultVolume:a}}}}function o(e,n,a){const i=Array.from({length:a},()=>Array.from({length:n},()=>({note:0,instrument:0,volume:0,effTyp:0,eff:0,effTyp2:0,eff2:0}))),r=new t(e);let o=0;for(;r.canRead(1)&&o<n;){const t=r.u8();if(0===t){o++;continue}if(!r.canRead(1))break;const e=r.u8(),f=t-1,l=f>=0&&f<a&&o<n?i[f][o]:null;if(1&e){if(!r.canRead(1))break;const t=r.u8();l&&(31===t?l.note=97:t>0&&t<254&&(l.note=12*(t>>4)+(15&t)+13))}if(2&e){if(!r.canRead(1))break;const t=r.u8();l&&(l.instrument=t)}if(60&e){let t=0,n=0,a=0,i=0;if(4&e){if(!r.canRead(1))break;t=r.u8()}if(8&e){if(!r.canRead(1))break;n=r.u8()}if(16&e){if(!r.canRead(1))break;a=r.u8()}if(32&e){if(!r.canRead(1))break;i=r.u8()}if(l){const e=s(a,i),r=s(t,n);l.effTyp=e.effTyp,l.eff=e.eff,l.effTyp2=r.effTyp,l.eff2=r.eff}}}return i}function f(t){return!(t.length<8)&&(68===t[0]&&66===t[1]&&77===t[2]&&48===t[3]&&!(t[4]>3))}function l(a,s){try{return function(a,s){if(!f(a))return null;const i=function(e,n){const a=new Map,s=new t(e,n);for(;s.canRead(8);){const t=String.fromCharCode(s.u8(),s.u8(),s.u8(),s.u8()),e=s.u32be();if(!s.canRead(e))break;const n=s.bytes(e);a.has(t)||a.set(t,[]),a.get(t).push({id:t,data:n})}return a}(a,8),l=n(i,"INFO");if(!l||l.length<10)return null;const u=new DataView(l.buffer,l.byteOffset,l.byteLength),c=u.getUint16(0,!1),h=u.getUint16(2,!1),p=u.getUint16(4,!1),d=u.getUint16(6,!1),g=Math.max(1,Math.min(u.getUint16(8,!1),254));let m="";const U=n(i,"NAME");U&&U.length>0&&(m=e(U,0,U.length));const b=n(i,"SONG");let y=[];if(b){const{name:n,orders:a}=function(n,a){const s=new t(n);let i="";const r=[];for(let t=0;t<a&&s.canRead(46);t++){const n=e(s.bytes(44),0,44),a=s.u16be();0===t&&(i=n);for(let t=0;t<a&&s.canRead(2);t++)r.push(s.u16be())}return{name:i,orders:r}}(b,p);y=a,m||(m=n)}m||(m=s.replace(/\.[^/.]+$/,""));const w=n(i,"INST"),R=w?function(t,n){const a=[],s=new DataView(t.buffer,t.byteOffset,t.byteLength);for(let i=0;i<n;i++){const n=50*i;if(n+50>t.length)break;const r=e(t,n,30),o=s.getUint16(n+30,!1),f=s.getUint16(n+32,!1),l=s.getUint32(n+34,!1),u=s.getUint32(n+38,!1),c=s.getUint32(n+42,!1),h=s.getInt16(n+46,!1),p=s.getUint16(n+48,!1);a.push({name:r,sample:o,volume:f,sampleRate:l,loopStart:u,loopLength:c,panning:h,flags:p})}return a}(w,c):[],M=n(i,"SMPL"),k=M?function(e,n){const a=[],s=new t(e);for(let t=0;t<n&&s.canRead(8);t++){const t=s.u32be(),e=s.u32be(),n=7&t;let i=0;if(1&n?i=8:2&n?i=16:4&n&&(i=32),0===i||0===e){a.push({frames:0,bits:0,data:new Uint8Array(0)});continue}const r=e*(i/8);if(!s.canRead(r)){a.push({frames:0,bits:i,data:new Uint8Array(0)});break}const o=s.bytes(r);a.push({frames:e,bits:i,data:o})}return a}(M,h):[],A=new Map;for(let t=0;t<k.length;t++)A.set(t+1,k[t]);const C=[];for(let t=0;t<R.length;t++){const e=R[t],n=t+1,a=e.sample>0?A.get(e.sample):void 0;C.push(r(n,e,a))}const T=n(i,"PATT"),S=[];if(T){const a=new t(T),r=n(i,"PNAM");let f=r?new t(r):null;f&&f.canRead(1)&&f.skip(1);for(let t=0;t<d&&a.canRead(6);t++){const n=a.u16be(),i=a.u32be();if(!a.canRead(i))break;const r=a.bytes(i);let l=`Pattern ${t}`;if(f&&f.canRead(1)){const t=f.u8();if(t>0&&f.canRead(t)){const n=e(f.bytes(t),0,t);n&&(l=n)}}const u=o(r,n,g),h=Array.from({length:g},(t,e)=>{const a=e%4;return{id:`channel-${e}`,name:`Channel ${e+1}`,muted:!1,solo:!1,collapsed:!1,volume:100,pan:0===a||3===a?-50:50,instrumentId:null,color:null,rows:u[e]??Array.from({length:n},()=>({note:0,instrument:0,volume:0,effTyp:0,eff:0,effTyp2:0,eff2:0}))}});S.push({id:`pattern-${t}`,name:l,length:n,channels:h,importMetadata:{sourceFormat:"DBM",sourceFile:s,importedAt:(new Date).toISOString(),originalChannelCount:g,originalPatternCount:d,originalInstrumentCount:c}})}}if(0===S.length){const t=Array.from({length:g},(t,e)=>{const n=e%4;return{id:`channel-${e}`,name:`Channel ${e+1}`,muted:!1,solo:!1,collapsed:!1,volume:100,pan:0===n||3===n?-50:50,instrumentId:null,color:null,rows:Array.from({length:64},()=>({note:0,instrument:0,volume:0,effTyp:0,eff:0,effTyp2:0,eff2:0}))}});S.push({id:"pattern-0",name:"Pattern 0",length:64,channels:t,importMetadata:{sourceFormat:"DBM",sourceFile:s,importedAt:(new Date).toISOString(),originalChannelCount:g,originalPatternCount:0,originalInstrumentCount:c}})}const v=y.filter(t=>t<S.length),P=v.length>0?v:S.map((t,e)=>e);return{name:m,format:"MOD",patterns:S,instruments:C,songPositions:P,songLength:P.length,restartPosition:0,numChannels:g,initialSpeed:6,initialBPM:125,linearPeriods:!1}}(a,s)}catch{return null}}export{f as isDigiBoosterProFormat,l as parseDigiBoosterProFile};
