import{aB as e}from"./index-zx6LJBPK.js";import"./vendor-react-DkDaD07v.js";import"./vendor-utils-XMmR-oGw.js";import"./vendor-tone-CADp_hfL.js";import"./vendor-ui-uomqNFY-.js";const t=27,n=[1695,1600,1505,1426,1347,1268,1189,1125,1062,1006,951,895,1695,1600,1505,1426,1347,1268,1189,1125,1062,1006,951,895,1695,1600,1505,1426,1347,1268,1189,1125,1062,1006,951,1790,1695,1600,1505,1426,1347,1268,1189,1125,1062,1006,951,895,848,800,753,713,674,634,595,563,531,503,476,448,424,400,377,357,337,317,298,282,266,252,238,224,212,200,189,179,169,159,149,141,133,126,119,112,106];function r(e,t){return e[t]<<8|e[t+1]}function o(e,t){return(e[t]<<24|e[t+1]<<16|e[t+2]<<8|e[t+3])>>>0}function l(e){return e<128?e:e-256}function f(e,t){const n=r(e,t);return n<32768?n:n-65536}function s(e){return Math.round(3546895/(2*e))}function i(e){if(e<0||e>=n.length)return 0;const t=e-60+37;return Math.max(1,Math.min(96,t))}function u(e){if(e.length<1024)return!1;return null!==a(e)}function a(e){const t=Math.min(e.length,4096);let n=-1;for(let f=0;f<t-3;f++)if(72===e[f]&&231===e[f+1]&&252===e[f+2]&&254===e[f+3]){n=f;break}if(n<0)return null;let r,o=-1,l=-1;for(r=n;r<t-6&&(233!==e[r]||65!==e[r+1]||112!==e[r+2]||0!==e[r+3]||65!==e[r+4]||250!==e[r+5]);r+=2);if(r>=t-6)return null;for(o=f(e,r+6)+r+6;r<t-4;r+=2){if(78===e[r]&&117===e[r+1])return null;if(97===e[r]&&0===e[r+1])break}if(r>=t-4)return null;if(r=f(e,r+2)+r+2,r<0||r>=t)return null;if(122!==e[r]||0!==e[r+1])return null;if(73!==e[r+6]||250!==e[r+7])return null;l=f(e,r+8)+r+8;let s=-1,i=-1,u=-1,a=-1,p=-1,c=-1,m=-1,h=0,g=-1,b=0,d=0,O=!1,v=!1,y=0;for(r=n;r<t-8&&(44!==e[r]||124!==e[r+1]||74!==e[r+6]||41!==e[r+7]);r+=2);if(r>=t-8)return null;const S=r;let k=0;for(r-=4;r>=0&&(75===e[r]&&250===e[r+1]?a=f(e,r+2)+r+2:67===e[r]&&250===e[r+1]&&(k=f(e,r+2)+r+2),-1===a||0===k);r-=2);if(-1===a||0===k)return null;for(r=S;r<t-16&&(83!==e[r]||105!==e[r+1]||103!==e[r+4]);r+=2);if(r>=t-16)return null;if(112===e[r+6]&&3===e[r+7])h=1;else{if(122!==e[r+6]||0!==e[r+7])return null;if(h=2,218!==e[r+12]||41!==e[r+13])return null;g=k+f(e,r+14)}for(r+=8;r<t-12&&(122!==e[r]||0!==e[r+1]||26!==e[r+2]||49!==e[r+3]||218!==e[r+6]||69!==e[r+7]||73!==e[r+8]||250!==e[r+9]);r+=2);if(r>=t-12)return null;if(s=f(e,r+10)+r+10,r+=12,r>=t-8)return null;if(58!==e[r]||52!==e[r+1]||73!==e[r+4]||250!==e[r+5])return null;for(i=f(e,r+6)+r+6,r+=8;r<t-6&&(24!==e[r]||49!==e[r+1]);r+=2);if(r>=t-6)return null;for(r+=6;r<t-10&&(66!==e[r]||49!==e[r+1]);r+=2);if(r>=t-10)return null;if(r+=8,8===e[r]&&49===e[r+1])b=1;else if(74===e[r]&&52===e[r+1])b=2;else if(26===e[r]&&52===e[r+1])b=3;else{if(66!==e[r]||48!==e[r+1])return null;for(b=4,r+=2;r<t-4&&(49!==e[r]||133!==e[r+1]);r+=2)if(12===e[r]&&5===e[r+1]&&0===e[r+2]&&132===e[r+3]){b=5;break}if(r>=t-4)return null;r-=2}for(r+=2;r<t-2&&(49!==e[r]||133!==e[r+1]);r+=2);if(r>=t-2)return null;if(r+=4,r>=t-16)return null;if(19===e[r]&&181===e[r+1]&&80===e[r+2]&&2===e[r+3]&&19===e[r+6]&&181===e[r+7]&&80===e[r+8]&&7===e[r+9]&&19===e[r+12]&&181===e[r+13]&&80===e[r+14]&&15===e[r+15])d=1;else if(17===e[r]&&181===e[r+1]&&80===e[r+2]&&1===e[r+3]&&19===e[r+6]&&181===e[r+7]&&80===e[r+8]&&2===e[r+9]&&19===e[r+12]&&181===e[r+13]&&80===e[r+14]&&7===e[r+15]&&19===e[r+18]&&181===e[r+19]&&80===e[r+20]&&15===e[r+21])d=2;else{if(17!==e[r]||181!==e[r+1]||80!==e[r+2]||1!==e[r+3]||19!==e[r+6]||181!==e[r+7]||80!==e[r+8]||2!==e[r+9]||19!==e[r+12]||181!==e[r+13]||80!==e[r+14]||3!==e[r+15]||49!==e[r+18]||181!==e[r+19]||80!==e[r+20]||4!==e[r+21]||51!==e[r+24]||117!==e[r+25]||80!==e[r+26]||6!==e[r+27]||19!==e[r+30]||181!==e[r+31]||80!==e[r+32]||8!==e[r+33]||19!==e[r+36]||181!==e[r+37]||80!==e[r+38]||15!==e[r+39])return null;d=3}for(;r<t-14&&(229!==e[r]||69!==e[r+1]||69!==e[r+2]||250!==e[r+3]);r+=2);if(r>=t-14)return null;if(p=f(e,r+4)+r+4,69!==e[r+10]||250!==e[r+11])return null;for(c=f(e,r+12)+r+12,r+=14,r<t-20&&202===e[r+12]&&252===e[r+13]&&69===e[r+16]&&250===e[r+17]&&(O=!0,m=f(e,r+18)+r+18,r+=18);r<t-12&&(107!==e[r]||0!==e[r+1]||74!==e[r+4]||49!==e[r+5]);r+=2);if(r>=t-12)return null;for(r+=10;r<t-10;r+=2)if(218===e[r]&&69===e[r+1]){r+=2;break}for(;r<t-10&&(155!==e[r]||112!==e[r+1]);r+=2);if(r>=t-10)return null;if(83===e[r+4]&&49===e[r+5])y=1;else{if(138!==e[r+8]||241!==e[r+9])return null;y=2}if(r+=10,v=!1,r<t-8&&107===e[r+4]&&74===e[r+6]&&49===e[r+7])for(v=!0,r+=8;r<t-10;r+=2)if(233===e[r]&&68===e[r+1]&&(49===e[r+2]||17===e[r+2])&&132===e[r+3]&&69===e[r+6]&&250===e[r+7]){u=f(e,r+8)+r+8;break}return o<0||l<0||s<0||i<0||a<0||p<0||c<0?null:{subSongListOffset:o,positionListsOffset:l,trackOffsetsOffset:s,tracksOffset:i,envelopesOffset:v?u:-1,instrumentsOffset:a,sampleStartOffsetsOffset:p,sampleDataOffset:c,sampleInfoOffset:O?m:-1,instrumentFormatVersion:d,parseTrackVersion:b,speedVariationVersion:h,speedVariationSpeedIncrementOffset:g,haveSeparateSampleInfo:O,haveEnvelope:v,vibratoVersion:y}}function p(n,i){if(n.length<1024)return null;try{return function(n,i){const u=a(n);if(!u)return null;const p=n.length,d=u.subSongListOffset,O=u.positionListsOffset;if(d<0||O<=d)return null;const v=Math.floor((O-d)/16);if(v<=0)return null;const y=[];for(let e=0;e<v;e++){const t=d+16*e;if(t+16>p)break;const o=[r(n,t),r(n,t+2),r(n,t+4),r(n,t+6)],f=new Int8Array(8);for(let e=0;e<8;e++)f[e]=l(n[t+8+e]);const s=[];for(let e=0;e<4;e++){const t=O+o[e];if(t>=p){s.push(new Uint8Array([255]));continue}const r=c(n,t);s.push(r)}y.push({positionLists:s,speedVariation:f})}if(0===y.length)return null;const S=u.trackOffsetsOffset,k=u.tracksOffset;if(S<0||k<0||k<=S)return null;const T=Math.floor((k-S)/2),A=[];for(let e=0;e<T;e++){const t=S+2*e;if(t+2>p)break;A.push(f(n,t))}const N=new Array(T).fill(null);for(let e=0;e<A.length;e++){if(A[e]<0)continue;const t=k+A[e];t>=p||(N[e]=h(n,t,u.parseTrackVersion))}const I=u.instrumentsOffset,L=u.trackOffsetsOffset;if(I<0||L<=I)return null;const V=Math.floor((L-I)/16),D=[];for(let e=0;e<V;e++){const t=I+16*e;if(t+16>p)break;const r=g(n,t,u.instrumentFormatVersion);r&&D.push(r)}const w=Array.from({length:t},()=>({length:0,loopStart:0,loopLength:1,pcm:null}));if(u.haveSeparateSampleInfo&&u.sampleInfoOffset>=0){let e=u.sampleInfoOffset;for(let o=0;o<t&&!(e+6>p);o++)w[o].length=r(n,e),w[o].loopStart=r(n,e+2),w[o].loopLength=r(n,e+4),e+=6}const C=u.sampleStartOffsetsOffset,M=u.sampleDataOffset;if(C>=0&&M>=0&&C+112<=p){const e=[];for(let r=0;r<=t;r++)e.push(o(n,C+4*r));for(let o=0;o<t;o++){const t=e[o+1]-e[o];if(0===t){w[o].length=0,w[o].loopStart=0,w[o].loopLength=1;continue}const f=M+e[o];if(f>=p)continue;let s=f,i=t;if(!u.haveSeparateSampleInfo){if(f+6>p)continue;w[o].length=r(n,f),w[o].loopStart=r(n,f+2),w[o].loopLength=r(n,f+4),s+=6,i=t-6}if(i<=0||s+i>p)continue;const a=new Int8Array(i);for(let e=0;e<i;e++)a[e]=l(n[s+e]);w[o].pcm=a}}const P=[];for(let r=0;r<D.length;r++){const n=D[r],o=r+1,l=n.sampleNumber;if(l>=0&&l<t){const t=w[l];if(t.pcm&&t.pcm.length>0){const r=new Uint8Array(t.pcm.buffer),f=s(424),i=t.loopLength>1,u=i?t.loopStart:0,a=i?t.loopStart+t.loopLength:0;P.push(e(o,`Sample ${l}`,r,n.volume||64,f,u,a));continue}}P.push({id:o,name:`Instrument ${o}`,type:"synth",synthType:"Synth",effects:[],volume:0,pan:0})}const F=y[0],E=[],$=Math.max(...F.positionLists.map(e=>function(e){let t=0,n=0;for(;n<e.length;){const r=e[n++];if(254===r||255===r)break;r>=253||!(64&r)?n++:t++}return t}(e)));for(let e=0;e<$;e++){const t=[[],[],[],[]];for(let n=0;n<4;n++){const r=m(F.positionLists[n],e),o=b(r>=0&&r<N.length?N[r]:null,D,u.parseTrackVersion);for(;o.length<64;)o.push({note:0,instrument:0,volume:0,effTyp:0,eff:0,effTyp2:0,eff2:0});t[n]=o.slice(0,64)}E.push({id:`pattern-${e}`,name:`Position ${e}`,length:64,channels:t.map((e,t)=>({id:`channel-${t}`,name:`Channel ${t+1}`,muted:!1,solo:!1,collapsed:!1,volume:100,pan:[-50,50,50,-50][t]??0,instrumentId:null,color:null,rows:e})),importMetadata:{sourceFormat:"AVP",sourceFile:i,importedAt:(new Date).toISOString(),originalChannelCount:4,originalPatternCount:N.length,originalInstrumentCount:D.length}})}0===E.length&&E.push(function(e,t){return{id:"pattern-0",name:"Pattern 0",length:64,channels:Array.from({length:4},(e,t)=>({id:`channel-${t}`,name:`Channel ${t+1}`,muted:!1,solo:!1,collapsed:!1,volume:100,pan:[-50,50,50,-50][t]??0,instrumentId:null,color:null,rows:Array.from({length:64},()=>({note:0,instrument:0,volume:0,effTyp:0,eff:0,effTyp2:0,eff2:0}))})),importMetadata:{sourceFormat:"AVP",sourceFile:e,importedAt:(new Date).toISOString(),originalChannelCount:4,originalPatternCount:0,originalInstrumentCount:t}}}(i,D.length));const x=i.replace(/\.[^/.]+$/,"");return{name:x,format:"AVP",patterns:E,instruments:P,songPositions:E.map((e,t)=>t),songLength:E.length,restartPosition:0,numChannels:4,initialSpeed:6,initialBPM:125,linearPeriods:!1}}(n,i)}catch(u){return null}}function c(e,t){const n=[],r=e.length;let o=t;for(;o<r;){const t=e[o++];if(n.push(t),!(t>=253)&&64&t||o<r&&n.push(e[o++]),254===t||255===t)break}return new Uint8Array(n)}function m(e,t){let n=0,r=0;for(;r<e.length;){const o=e[r++];if(254===o||255===o)return-1;if(o>=253||!(64&o))r++;else{if(n===t)return o;n++}}return-1}function h(e,t,n){const r=[],o=e.length;let l=t;for(;l<o;){let t=e[l++];if(r.push(t),255===t)break;if(3===n)for(;128&t&&l<o&&(r.push(e[l++]),!(l>=o));)t=e[l++],r.push(t);else if(4===n||5===n){if(129!==t)for(;128&t&&l<o&&(r.push(e[l++]),!(l>=o));)t=e[l++],r.push(t)}else 128&t&&l<o&&(r.push(e[l++]),2===n&&l<o&&r.push(e[l++]));l<o&&r.push(e[l++])}return new Uint8Array(r)}function g(e,t,n){if(t+16>e.length)return null;const o={sampleNumber:0,envelopeNumber:0,volume:64,enabledEffectFlags:0,portamentoAdd:0,fineTune:0,stopResetEffectDelay:0,sampleNumber2:0,sampleStartOffset:0,arpeggioTable:[0,0,0,0],fixedOrTransposedNote:0,transpose:0,vibratoNumber:0,vibratoDelay:0};if(1===n){o.sampleNumber=e[t],o.envelopeNumber=e[t+1],o.enabledEffectFlags=e[t+2],o.portamentoAdd=e[t+4],o.stopResetEffectDelay=e[t+7],o.sampleNumber2=e[t+8];for(let n=0;n<4;n++)o.arpeggioTable[n]=l(e[t+9+n]);o.fixedOrTransposedNote=e[t+13],o.vibratoNumber=e[t+14],o.vibratoDelay=e[t+15]}else if(2===n){o.sampleNumber=e[t],o.volume=e[t+1],o.enabledEffectFlags=e[t+2],o.portamentoAdd=e[t+4],o.stopResetEffectDelay=e[t+7],o.sampleNumber2=e[t+8];for(let n=0;n<4;n++)o.arpeggioTable[n]=l(e[t+9+n]);o.fixedOrTransposedNote=e[t+13],o.vibratoNumber=e[t+14],o.vibratoDelay=e[t+15]}else if(3===n){o.sampleNumber=e[t],o.volume=e[t+1],o.enabledEffectFlags=e[t+2],o.transpose=l(e[t+3]),o.fineTune=f(e,t+4),o.sampleStartOffset=r(e,t+6),o.stopResetEffectDelay=e[t+8];for(let n=0;n<4;n++)o.arpeggioTable[n]=l(e[t+9+n]);o.fixedOrTransposedNote=e[t+13],o.vibratoNumber=e[t+14],o.vibratoDelay=e[t+15]}return o}function b(e,t,r){const o=[];if(!e)return o;const l=e.length;let f=0;for(;f<l&&o.length<64&&!(f>=l);){let s=e[f++];if(255===s)break;let u=0;if(3===r){for(;128&s&&f<l&&(f++,!(f>=l));)s=e[f++];u=s}else if(4===r||5===r)if(129===s)u=0;else{for(;128&s&&f<l&&(f++,!(f>=l));)s=e[f++];u=s}else 128&s&&(f++,2===r&&f<l&&f++),u=f<l?e[f++]:0;const a=63&u,p=u>>6&1;let c=0,m=0;a>0&&a<n.length&&(c=i(a)),p&&t.length>0&&(m=1),o.push({note:c,instrument:m,volume:0,effTyp:0,eff:0,effTyp2:0,eff2:0})}return o}export{u as isActivisionProFormat,p as parseActivisionProFile};
