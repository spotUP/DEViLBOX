import{aB as n}from"./index-zx6LJBPK.js";import"./vendor-react-DkDaD07v.js";import"./vendor-utils-XMmR-oGw.js";import"./vendor-tone-CADp_hfL.js";import"./vendor-ui-uomqNFY-.js";function e(n,e){return n[e]??0}function t(n,e){return(n[e]??0)<<8|(n[e+1]??0)}function o(n,e){return((n[e]??0)<<24|(n[e+1]??0)<<16|(n[e+2]??0)<<8|(n[e+3]??0))>>>0}function r(n,e,t){let o="";for(let r=0;r<t;r++){const t=n[e+r]??0;if(0===t)break;o+=String.fromCharCode(t)}return o.trim()}function f(n){if(n.length<206)return null;if(71!==n[0]||84!==n[1]||75!==n[2])return null;const o=e(n,3);if(o<1||o>4)return null;const f=r(n,4,32),s=t(n,196),l=t(n,198),a=t(n,200),i=t(n,202),u=t(n,204);return s>255||0===l||l>256||0===a||a>32||i>256||i>0&&u>=i?null:{fileVersion:o,songName:f,numSamples:s,numRows:l,numChannels:a,numOrders:i,restartPos:u}}function s(n){if(n.length<236)return null;if(71!==n[0]||84!==n[1]||50!==n[2])return null;const f=e(n,3);if(f>9)return null;const s=o(n,4),l=r(n,8,32),a=t(n,203);if(a<1980||a>9999)return null;const i=f<=5?t(n,228):6,u=f<=5?t(n,230):125,c=f<=5?t(n,232):4095,m=f<=5?t(n,234):0;if(f<=5){if(0===i||0===u)return null;if(c>4095)return null;if(m>99)return null}return{fileVersion:f,headerSize:s,songName:l,speed:i,tempo:u,masterVol:c,numPannedTracks:m}}function l(n){return!(n.length<10)&&(71===n[0]&&84===n[1]&&50===n[2]?null!==s(n):71===n[0]&&84===n[1]&&75===n[2]&&null!==f(n))}function a(n,e,t){if(!n)return{effTyp:0,eff:0};if(n>=176&&t)return{effTyp:0,eff:0};const o=(15&n)<<8|e,r=Math.min(e,14);switch(n>>4){case 2:return{effTyp:12,eff:Math.min(Math.trunc(o/4),64)};case 4:return{effTyp:8,eff:Math.min(Math.trunc(o/16),255)};case 7:return{effTyp:27,eff:15&n}}switch(n){case 1:return{effTyp:1,eff:e};case 2:return{effTyp:2,eff:e};case 3:return{effTyp:3,eff:e};case 4:return{effTyp:4,eff:e};case 7:return{effTyp:7,eff:e};case 11:return{effTyp:11,eff:e};case 13:return{effTyp:13,eff:e};case 15:return{effTyp:15,eff:e};case 9:return{effTyp:14,eff:208|Math.min(e,15)};case 10:return{effTyp:20,eff:0};case 16:return{effTyp:0,eff:e};case 20:return{effTyp:10,eff:r<<4};case 21:return{effTyp:10,eff:r};case 170:return{effTyp:14,eff:224|Math.min(e,15)};case 168:return e>0?{effTyp:15,eff:e}:{effTyp:0,eff:0};case 177:return{effTyp:14,eff:176|Math.min(e,15)};default:return{effTyp:0,eff:0}}}function i(n,e){return n.find(n=>n.id===e)}function u(n,e){return n.filter(n=>n.id===e)}function c(f,l){const c=s(f);if(!c)return null;const{fileVersion:p,headerSize:g,songName:y,speed:d,tempo:M,numPannedTracks:T}=c,v=[];if(p<=5)for(let n=0;n<T;n++)v.push(t(f,236+2*n));const S=function(n,e){const t=[];let r=e;for(;r+8<=n.length;){const e=o(n,r),f=o(n,r+4),s=Math.max(f,8)-8;if(t.push({id:e,length:s,offset:r+8}),r+=8+s,1162757187===e)break}return t}(f,Math.max(g,236)),w=i(S,1346458707);if(!w||w.length<2)return null;const C=t(f,w.offset);if(C<1||C>32)return null;const A=i(S,1397706311);if(!A||A.length<2)return null;let P=A.offset;const $=t(f,P);P+=2;const F=t(f,P);P+=2;const b=[],k=Math.min($,Math.trunc((A.length-4)/2));for(let n=0;n<k;n++)b.push(t(f,P+2*n));let x=Math.max(M,1),I=Math.max(d,1);const L=i(S,1413697074);if(L&&L.length>=12){const n=L.offset,e=t(f,n+2),o=t(f,n+6);e>=32&&e<=999&&(x=e),o>=1&&o<=255&&(I=o)}const N=[];for(let n=0;n<C;n++)if(p<=5&&n<v.length){const e=Math.min(Math.trunc(256*v[n]/4095),256);N.push(e-128)}else{const e=n%4;N.push(0===e||3===e?-64:64)}const O=i(S,1414942540),q=new Array(C).fill(100);if(O&&O.length>=2){const n=Math.min(t(f,O.offset),C);for(let e=0;e<n;e++)if(O.offset+2+2*e+1<f.length){const n=t(f,O.offset+2+2*e);q[e]=Math.min(Math.trunc(n/4096*100),100)}}const z=i(S,1296652368);if(z&&z.length>=56){const n=z.offset,o=t(f,n+34),r=t(f,n+50);if(4===o&&257===r){const o=t(f,n+38);for(let r=0;r<o;r++){const o=n+56+8*r;if(o+7>=f.length)break;const s=e(f,o),l=t(f,o+2),a=t(f,o+4),i=t(f,o+6);if(0===s&&l<C){const n=Math.min(Math.trunc(256*i/4095),256);N[l]=n-128,q[l]=Math.min(Math.trunc(64*a/4096),64)}}}}const E=new Map;for(const n of u(S,1396788530)){if(n.length<78)continue;const e=n.offset,s=t(f,e);if(!s||s>=1e3)continue;const l=r(f,e+2,28),a=t(f,e+30),i=t(f,e+32),u=t(f,e+36),c=t(f,e+40),m=t(f,e+44),h=t(f,e+48),p=2*o(f,e+54),g=o(f,e+58),y=o(f,e+62),d=o(f,e+66),M=o(f,e+74);if(h>1||a>1)continue;if(0!==a)continue;const T=y+d,v=0!==m,S=n.offset-8+(M-8);let w=0;w=8===i?g:2*g,2===u&&(w*=2);let C=new Uint8Array(0);if(S>=0&&S<f.length&&w>0){const n=Math.min(w,f.length-S);C=f.slice(S,S+n)}const A=2===u,P=!!(2&m);E.set(s,{smpNum:s,name:l,bits:16===i?16:8,sampleFreq:p,length:g,loopStart:y,loopEnd:T,hasLoop:v,volume:Math.min(c,255),stereo:A,pingpong:P,pcm:C})}for(const n of u(S,1396788560)){if(n.length<56)continue;const e=n.offset,s=t(f,e);if(!s||s>=1e3||E.has(s))continue;const l=r(f,e+2,28),a=t(f,e+30),i=t(f,e+34),u=2*t(f,e+36),c=o(f,e+38),m=o(f,e+42),h=o(f,e+46),p=t(f,e+50);if(0!==t(f,e+54))continue;const g=!!(1&a),y=!!(2&a);let d=c,M=m,T=m+h;16===i&&(d/=2,M/=2,T/=2);const v=m>0||h>2,S=e+56;let w=c;w=c,g&&(w*=2);let C=new Uint8Array(0);if(S<f.length&&w>0){const n=Math.min(w,f.length-S);C=f.slice(S,S+n)}E.set(s,{smpNum:s,name:l,bits:16===i?16:8,sampleFreq:u,length:d,loopStart:M,loopEnd:T,hasLoop:v,volume:Math.min(Math.abs(p),255),stereo:g,pingpong:y,pcm:C})}const U=new Map;for(const n of u(S,1229869908)){if(n.length<308)continue;const o=n.offset,s=t(f,o);if(!s)continue;const l=r(f,o+2,28);if(0!==t(f,o+30))continue;const a=[];for(let n=0;n<128;n++)a.push(e(f,o+52+2*n));U.set(s,{insNum:s,name:l,samples:a})}const j=[];if(U.size>0){const e=Array.from(U.keys()).sort((n,e)=>n-e);for(const t of e){const e=U.get(t);let o=e.samples[60]||e.samples[48]||e.samples.find(n=>0!==n)||0;const r=o>0?E.get(o):void 0;if(!r||0===r.pcm.length){j.push({id:t,name:e.name||`Instrument ${t}`,type:"sample",synthType:"Sampler",effects:[],volume:0,pan:0});continue}const f=m(r),s=r.volume>0?Math.min(r.volume/4,64):64,l=r.sampleFreq>0?r.sampleFreq:8363;j.push(n(t,e.name||`Instrument ${t}`,f,s,l,r.hasLoop?r.loopStart:0,r.hasLoop?r.loopEnd:0))}}else{const e=Array.from(E.keys()).sort((n,e)=>n-e);for(const t of e){const e=E.get(t);if(0===e.pcm.length){j.push({id:t,name:e.name||`Sample ${t}`,type:"sample",synthType:"Sampler",effects:[],volume:0,pan:0});continue}const o=m(e),r=e.volume>0?Math.min(e.volume/4,64):64,f=e.sampleFreq>0?e.sampleFreq:8363;j.push(n(t,e.name||`Sample ${t}`,o,r,f,e.hasLoop?e.loopStart:0,e.hasLoop?e.loopEnd:0))}}const D=b.length>0?Math.max(...b)+1:0,R=new Map;for(const n of u(S,1346458692)){if(n.length<24)continue;const o=n.offset,r=t(f,o),s=t(f,o+18),l=t(f,o+20),i=t(f,o+22);if(s>1)continue;if(0===l||0===i)continue;const u=l*i*5;if(n.length<24+u)continue;const c=[];for(let n=0;n<l;n++){const t=[];for(let r=0;r<i;r++){const l=o+24+5*(n*i+r),u=e(f,l),c=e(f,l+1),m=e(f,l+2),h=e(f,l+3),p=e(f,l+4);let g=0;u>0&&u<=120&&(g=u+1);const y=c,{effTyp:d,eff:M}=a(m,h,!1);let T=0;p>0&&(T=0===s?Math.min(Math.trunc(p/4),64):Math.max(p-16,0)),t.push({note:g,instrument:y,volume:p>0?T:0,effTyp:d,eff:M,effTyp2:0,eff2:0})}c.push(t)}R.set(r,c)}const V=R.values().next().value,B=V?V.length:64,G=new Array(C).fill(""),H=i(S,1414414669);if(H&&H.length>=2){const n=t(f,H.offset);for(let e=0;e<n;e++){const n=H.offset+2+36*e;if(n+35>=f.length)break;const o=t(f,n),s=t(f,n+2);0===o&&s<C&&(G[s]=r(f,n+4,32))}}const J=b.map((n,e)=>{const t=R.get(n),o=t?t.length:B,r=Array.from({length:C},(n,e)=>{const r=Array.from({length:o},(n,o)=>t&&t[o]?t[o][e]??{note:0,instrument:0,volume:0,effTyp:0,eff:0,effTyp2:0,eff2:0}:{note:0,instrument:0,volume:0,effTyp:0,eff:0,effTyp2:0,eff2:0});return{id:`channel-${e}`,name:G[e]||`Channel ${e+1}`,muted:!1,solo:!1,collapsed:!1,volume:q[e]??100,pan:N[e]??0,instrumentId:null,color:null,rows:r}});return{id:`pattern-${e}`,name:`Pattern ${e}`,length:o,channels:r,importMetadata:{sourceFormat:"GraoumfTracker2",sourceFile:l,importedAt:(new Date).toISOString(),originalChannelCount:C,originalPatternCount:D,originalInstrumentCount:U.size>0?U.size:E.size}}});return 0===J.length&&J.push(h(C,B,l,0,0)),{name:y||l.replace(/\.[^/.]+$/,""),format:"MOD",patterns:J,instruments:j,songPositions:J.map((n,e)=>e),songLength:J.length,restartPosition:Math.min(F,Math.max(J.length-1,0)),numChannels:C,initialSpeed:I,initialBPM:x,linearPeriods:!1}}function m(n){const{pcm:e,bits:t,stereo:o}=n;if(8===t&&!o)return e;let r;if(16===t){const n=Math.trunc(e.length/2);r=[];for(let t=0;t<n;t++){const n=e[2*t]??0,o=256*(n<128?n:n-256)+(e[2*t+1]??0);r.push(Math.round(o/256)+128)}}else r=Array.from(e);if(o){const n=[];for(let e=0;e<r.length-1;e+=2){const t=(r[e]??128)-128,o=(r[e+1]??128)-128;n.push(Math.round((t+o)/2)+128)}return new Uint8Array(n)}return new Uint8Array(r)}function h(n,e,t,o,r){return{id:"pattern-0",name:"Pattern 0",length:e,channels:Array.from({length:n},(n,t)=>({id:`channel-${t}`,name:`Channel ${t+1}`,muted:!1,solo:!1,collapsed:!1,volume:100,pan:0,instrumentId:null,color:null,rows:Array.from({length:e},()=>({note:0,instrument:0,volume:0,effTyp:0,eff:0,effTyp2:0,eff2:0}))})),importMetadata:{sourceFormat:"GraoumfTracker2",sourceFile:t,importedAt:(new Date).toISOString(),originalChannelCount:o,originalPatternCount:r,originalInstrumentCount:0}}}function p(s,l){try{return!s||s.length<10?null:71===s[0]&&84===s[1]&&50===s[2]?c(s,l):71===s[0]&&84===s[1]&&75===s[2]?function(s,l){const i=f(s);if(!i)return null;const{fileVersion:u,songName:c,numSamples:m,numRows:p,numChannels:g,numOrders:y,restartPos:d}=i,M=u<3?48:64,T=M*m+512+(u<4?4:5)*p*g;if(s.length<206+T)return null;let v=206;const S=[];for(let n=0;n<m;n++){const n=v,f=1===u?32:28,l=r(s,n,f);let a=-1,i=1,c=8363,m=n+f;if(u>=3){m+=14;const n=e(s,m)<<8|e(s,m+1);a=n>=32768?n-65536:n,m+=2}u>=2&&(i=t(s,m),m+=2,c=2*t(s,m),m+=2);const h=o(s,m);m+=4;const p=o(s,m);m+=4;const g=o(s,m);m+=4;const y=t(s,m);m+=2;const d=t(s,m)>=32768?t(s,m)-65536:t(s,m);m+=2;let T=h,w=p,C=p+g;const A=2===i;A&&(T/=2,w/=2,C/=2);const P=p>0||g>2;S.push({name:l,length:T,loopStart:w,loopEnd:C,hasLoop:P,volume:y,finetune:d,bits:A?16:8,sampleRate:c,defaultPan:a}),v+=M}const w=s.slice(v,v+512);v+=512;const C=[];for(let n=0;n<y;n++)C.push(t(w,2*n));const A=C.length>0?Math.max(...C)+1:0,P=u<4?4:5,$=[];for(let n=0;n<A;n++){const n=[];for(let t=0;t<p;t++){const o=[];for(let n=0;n<g;n++){const r=v+(t*g+n)*P;if(r+P>s.length){o.push({note:0,instrument:0,volume:0,effTyp:0,eff:0,effTyp2:0,eff2:0});continue}const f=e(s,r),l=e(s,r+1),i=e(s,r+2),u=e(s,r+3),c=P>=5?e(s,r+4):0;let m=0;f>=24&&f<84&&(m=f+13);const h=l,{effTyp:p,eff:y}=a(i,u,!0);let d=0,M=0;c>0&&(d=12,M=Math.min(Math.trunc((c+1)/4),64)),o.push({note:m,instrument:h,volume:12===d?M:0,effTyp:p,eff:y,effTyp2:0,eff2:0})}n.push(o)}$.push(n),v+=p*g*P}const F=[];for(const n of S){if(0===n.length||v>=s.length){F.push(new Uint8Array(0));continue}const e=16===n.bits?2*n.length:n.length,t=Math.min(e,s.length-v);F.push(s.slice(v,v+t)),v+=e}const b=[];for(let e=0;e<m;e++){const t=S[e],o=F[e],r=e+1;if(!o||0===o.length){b.push({id:r,name:t.name||`Sample ${r}`,type:"sample",synthType:"Sampler",effects:[],volume:0,pan:0});continue}let f;if(16===t.bits){f=new Uint8Array(o.length/2);for(let n=0;n<f.length;n++)f[n]=o[2*n]??0}else f=o;const s=t.volume>0?Math.min(t.volume,64):64,l=t.hasLoop?t.loopStart:0,a=t.hasLoop?t.loopEnd:0,i=t.sampleRate>0?t.sampleRate:8363;b.push(n(r,t.name||`Sample ${r}`,f,s,i,l,a))}const k=[];for(let n=0;n<g;n++){const e=n%4;k.push(0===e||3===e?-64:64)}const x=C.map((n,e)=>{const t=n<$.length?$[n]:null,o=Array.from({length:g},(n,e)=>{const o=Array.from({length:p},(n,o)=>t&&t[o]&&t[o][e]?t[o][e]:{note:0,instrument:0,volume:0,effTyp:0,eff:0,effTyp2:0,eff2:0});return{id:`channel-${e}`,name:`Channel ${e+1}`,muted:!1,solo:!1,collapsed:!1,volume:100,pan:k[e]??0,instrumentId:null,color:null,rows:o}});return{id:`pattern-${e}`,name:`Pattern ${e}`,length:p,channels:o,importMetadata:{sourceFormat:"GraoumfTracker",sourceFile:l,importedAt:(new Date).toISOString(),originalChannelCount:g,originalPatternCount:A,originalInstrumentCount:m}}});return 0===x.length&&x.push(h(g,p,l,0,0)),{name:c||l.replace(/\.[^/.]+$/,""),format:"MOD",patterns:x,instruments:b,songPositions:x.map((n,e)=>e),songLength:x.length,restartPosition:d,numChannels:g,initialSpeed:6,initialBPM:125,linearPeriods:!1}}(s,l):null}catch{return null}}export{l as isGraoumfTracker2Format,p as parseGraoumfTracker2File};
