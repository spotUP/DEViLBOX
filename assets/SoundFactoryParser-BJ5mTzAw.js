import{aB as e}from"./index-zx6LJBPK.js";import"./vendor-react-DkDaD07v.js";import"./vendor-utils-XMmR-oGw.js";import"./vendor-tone-CADp_hfL.js";import"./vendor-ui-uomqNFY-.js";const t=276,n=128,r=129,s=130,a=131,o=132,c=133,l=134,f=135,u=136,i=137,h=138,p=139,m=140,g=141,d=142,b=143,k=144,y=145,P=146,S=147,v=148,w=149,C=150,I=151,M=152,T=153,$=154,A=155,D=156;function F(e,t){return e[t]}function O(e,t){return e[t]<<8|e[t+1]}function j(e,t){return 0|(e[t]<<24|e[t+1]<<16|e[t+2]<<8|e[t+3])}function x(e,t){return(e[t]<<24|e[t+1]<<16|e[t+2]<<8|e[t+3])>>>0}function B(e){return e<=0?8287:Math.round(3546895/(2*e))}function L(e){if(e>127)return 0;const t=e+13;return Math.max(1,Math.min(96,t))}function U(e){if(e.length<t)return!1;if(x(e,0)>e.length)return!1;for(let t=0;t<16;t++)if(F(e,4+t)>15)return!1;let n=4294967295;for(let t=0;t<64;t++){const r=x(e,20+4*t);if(r>e.length)return!1;r>0&&r<n&&(n=r)}return n===t}function q(e,t,x,B){let L=t;const U=e.length;for(;L<U;){if(x.has(L))return;x.add(L);const t=F(e,L++);if(t<128)L+=2;else switch(t){case i:case p:case m:case y:case P:break;case r:case s:case a:case u:case h:case b:case $:case A:case D:L+=1;break;case n:case T:L+=2;break;case C:case I:case M:if(L>=U)return;0!==F(e,L++)&&(L+=3);break;case v:if(L>=U)return;0!==F(e,L++)&&(L+=1);break;case S:case w:if(L>=U)return;0!==F(e,L++)&&(L+=4);break;case k:if(L+3>=U)return;L+=3;0!==F(e,L++)&&(L+=1);break;case o:{if(L+3>U)return;L++;const t=O(e,L);L+=2;const n=L;if(!B.has(n)&&n+4<=U){const t=z(e,n);B.set(n,t)}const r=2*t-4;r>0&&(L+=r);break}case c:return;case l:{if(L+4>U)return;const t=j(e,L);L+=4;const n=L+t>>>0;n<U&&!x.has(n)&&q(e,n,x,B);break}case f:{if(L+4>U)return;const t=j(e,L);if(L+=4,L=L+t>>>0,x.has(L))return;break}case g:case d:return}}}function z(e,t){let n=t;const r=e.length,s=n+2<=r?O(e,n):0;n+=2;const a=n+2<=r?O(e,n):0;n+=2;const o=n<r?F(e,n++):0;n+=3,n+=4,n+=4,n+=4,n+=4,n+=2,n+=3,n+=1,n+=4;const c=2*s;let l;if(c>0&&n+c<=r){l=new Int8Array(c);for(let t=0;t<c;t++)l[t]=e[n+t]<128?e[n+t]:e[n+t]-256}else l=new Int8Array(0);return{offset:t,sampleLength:s,samplingPeriod:a,effectByte:o,sampleData:l,name:""}}function E(z,E){if(!U(z))return null;const H=x(z,0),J=[],K=[];for(let e=0;e<16;e++)K.push(F(z,4+e));const N=[];for(let e=0;e<16;e++){const t=[];for(let n=0;n<4;n++)t.push(x(z,20+4*(4*e+n)));N.push(t)}let Q=0;for(let e=0;e<16;e++){const n=K[e];if(0===n){Q++;continue}const r=N[Q++].map(e=>e>0?e-t:0);J.push({enabledChannels:n,opcodeStartOffsets:r})}if(0===J.length)return null;const R=H>t?H-t:0;if(0===R||t+R>z.length)return null;const V=z.slice(t,t+R),W=new Map,X=new Set;for(const e of J)for(let t=0;t<4;t++){const n=e.opcodeStartOffsets[t];n<R&&q(V,n,X,W)}const Y=[],Z=new Map;let _=1;for(const[e,t]of W)Y.push(t),Z.set(e,_++);const ee=[];for(let t=0;t<Y.length;t++){const n=Y[t],r=t+1,s=!!(1&n.effectByte);if(n.sampleData.length>0){const t=new Uint8Array(n.sampleData.length);for(let e=0;e<n.sampleData.length;e++)t[e]=n.sampleData[e]+128&255;const a=n.samplingPeriod>0?B(n.samplingPeriod):B(214),o=0,c=s?0:t.length;ee.push(e(r,`Instrument ${r}`,t,64,a,o,c))}else ee.push({id:r,name:`Instrument ${r}`,type:"synth",synthType:"Synth",effects:[],volume:0,pan:0})}function te(e){const t=[];let x=e,B=0,U=64;const q=[],z=[],E=new Set;let G=0;for(;x<V.length&&G<65536;){G++;const e=F(V,x++);if(e<128){if(E.has(x-1))break;if(x+2>V.length)break;const n=O(V,x);x+=2;const r=L(e);t.push({note:r,instrId:B,volume:U,duration:n});continue}switch(e){case n:case T:{if(x+2>V.length)return t;const n=O(V,x);if(x+=2,t.push({note:0,instrId:0,volume:0,duration:n}),e===T)return t;break}case r:x<V.length&&(U=Math.min(64,F(V,x++)));break;case s:case a:if(x<V.length){const t=F(V,x++);e===a&&t<Y.length&&(B=t+1)}break;case o:{if(x+3>V.length)return t;x++;const e=O(V,x);x+=2;const n=x;B=Z.get(n)??B;const r=2*e-4;r>0&&(x+=r);break}case c:if(!(q.length>0))return t;x=q.pop();break;case l:{if(x+4>V.length)return t;const e=j(V,x);x+=4,q.push(x),x=x-4+e>>>0;break}case f:{if(x+4>V.length)return t;const e=j(V,x);x+=4,x=x-4+e>>>0;break}case u:if(x<V.length){const e=F(V,x++);z.push({count:e,returnOffset:x})}break;case i:if(z.length>0){const e=z[z.length-1];e.count--,e.count>0?x=e.returnOffset:z.pop()}break;case g:case d:return t;case p:case m:case y:case P:break;case h:case b:case $:case A:case D:x<V.length&&x++;break;case C:case I:case M:if(x>=V.length)return t;0!==F(V,x++)&&(x+=3);break;case v:if(x>=V.length)return t;0!==F(V,x++)&&(x+=1);break;case S:case w:if(x>=V.length)return t;0!==F(V,x++)&&(x+=4);break;case k:if(x+3>=V.length)return t;x+=3;0!==F(V,x++)&&(x+=1);break}}return t}const ne=J[0],re=[-50,50,50,-50],se=[];for(let e=0;e<4;e++){const t=ne.opcodeStartOffsets[e];!!(ne.enabledChannels&1<<e)&&t<V.length?se.push(te(t)):se.push([])}const ae=se.map(function(e){const t=[];for(const n of e){t.push({note:n.note,instrument:n.instrId,volume:0,effTyp:0,eff:0,effTyp2:0,eff2:0});for(let e=1;e<n.duration;e++)t.push(G())}return t.length>0?t:[{note:0,instrument:0,volume:0,effTyp:0,eff:0,effTyp2:0,eff2:0}]}),oe=Math.max(...ae.map(e=>e.length),1),ce=Math.ceil(oe/64),le=[];for(let e=0;e<ce;e++){const t=64*e,n=Math.min(t+64,oe)-t,r=[];for(let e=0;e<4;e++){const s=[],a=ae[e];for(let e=0;e<n;e++){const n=t+e;s.push(n<a.length?a[n]:G())}r.push(s)}le.push({id:`pattern-${e}`,name:`Pattern ${e}`,length:n,channels:r.map((e,t)=>({id:`channel-${t}`,name:`Channel ${t+1}`,muted:!1,solo:!1,collapsed:!1,volume:100,pan:re[t]??0,instrumentId:null,color:null,rows:e})),importMetadata:{sourceFormat:"PSF",sourceFile:E,importedAt:(new Date).toISOString(),originalChannelCount:4,originalPatternCount:ce,originalInstrumentCount:ee.length}})}0===le.length&&le.push(function(e,t,n){return{id:"pattern-0",name:"Pattern 0",length:n,channels:Array.from({length:t},(e,t)=>({id:`channel-${t}`,name:`Channel ${t+1}`,muted:!1,solo:!1,collapsed:!1,volume:100,pan:0,instrumentId:null,color:null,rows:Array.from({length:n},()=>({note:0,instrument:0,volume:0,effTyp:0,eff:0,effTyp2:0,eff2:0}))})),importMetadata:{sourceFormat:"PSF",sourceFile:e,importedAt:(new Date).toISOString(),originalChannelCount:t,originalPatternCount:0,originalInstrumentCount:0}}}(E,4,64));return{name:E.replace(/\.[^/.]+$/,""),format:"PSF",patterns:le,instruments:ee,songPositions:le.map((e,t)=>t),songLength:le.length,restartPosition:0,numChannels:4,initialSpeed:6,initialBPM:125,linearPeriods:!1}}function G(){return{note:0,instrument:0,volume:0,effTyp:0,eff:0,effTyp2:0,eff2:0}}export{U as isSoundFactoryFormat,E as parseSoundFactoryFile};
