import{aB as t}from"./index-zx6LJBPK.js";import"./vendor-react-DkDaD07v.js";import"./vendor-utils-XMmR-oGw.js";import"./vendor-tone-CADp_hfL.js";import"./vendor-ui-uomqNFY-.js";function e(t,e){return t.getUint8(e)}function n(t,e){return t.getUint16(e,!1)}function o(t,e,n){let o="";for(let r=0;r<n;r++){const n=t.getUint8(e+r);if(0===n)break;n>=32&&(o+=String.fromCharCode(n))}return o.trim()}function r(t,e,n){let o=0;for(let r=0;r<n;r++){const n=t.getUint8(e+r);0!==n&&(n<32||n>126)&&o++}return o}const s=20,i=15,a=600,l=1024,c=[856,808,762,720,678,640,604,570,538,508,480,453,428,404,381,360,339,320,302,285,269,254,240,226,214,202,190,180,170,160,151,143,135,127,120,113];function f(t){if(0===t)return 0;let e=0,n=1/0;for(let o=0;o<c.length;o++){const r=Math.abs(c[o]-t);r<n&&(n=r,e=o)}return e+13}function u(t){if(t.byteLength<1624)return!1;const o=new DataView(t);if(83===o.getUint8(0)&&80===o.getUint8(1)&&83===o.getUint8(2))return!0;let a=r(o,0,s),l=a,c=0,f=0,u=0,h=!1;for(let d=0;d<i;d++){const t=s+30*d;l+=r(o,t,22);0!==e(o,t+24)&&(l+=16);const i=e(o,t+25),a=n(o,t+22);let m=!1,p=!1;for(let e=0;e<22;e++){const n=o.getUint8(t+e);if(0===n)break;n>=32&&n<=126?m=!0:p=!0}if(m&&!p&&u++,p&&(h=!0),l>48)return!1;if(i>64)return!1;if(a>37e3)return!1;c+=a,f|=i}if(a>5&&(u<4||h))return!1;if(0===c||0===f)return!1;const m=e(o,470),p=e(o,471);if(m>128)return!1;if(p>220)return!1;let g=0;for(let n=0;n<128;n++){const t=e(o,472+n);t>g&&(g=t)}return!(g>63)&&((0!==p||0!==m||0!==g)&&!(t.byteLength<1624))}async function h(r,c){const u=new DataView(r),h=new Uint8Array(r),m=o(u,0,s),p=[];for(let t=0;t<i;t++){const r=s+30*t,i=o(u,r,22),a=n(u,r+22),l=Math.min(e(u,r+25),64),c=n(u,r+26),f=n(u,r+28);p.push({name:i,lengthWords:a,volume:l,loopStart:c,loopLengthWords:f})}const g=470,d=e(u,g);let y=e(u,471);const b=h.slice(0,6),M=String.fromCharCode(...b);("jjk55\0"===M||M.startsWith("jjk55"))&&(y=120),y||(y=120);const v=[];for(let t=0;t<128;t++)v.push(e(u,472+t));const S=d>0?v.slice(0,d):v;let w=0;for(const t of S)t+1>w&&(w=t+1);0===w&&(w=1);let k=0;for(let t=0;t<128;t++){const n=e(u,472+t);n>k&&(k=n)}const C=Math.floor((r.byteLength-a)/l);w=Math.min(Math.max(w,k+1),C,64);let L=125;120!==y&&(L=Math.round(1773447.5/(122*(240-y))),L=Math.max(1,Math.min(255,L)));const U=Math.max(1,Math.min(d,128)),j=v.slice(0,U),x=[],P=new Map,$=new Set;for(const t of j)$.add(t);for(let t=0;t<w;t++)$.add(t);const T=Array.from($).sort((t,e)=>t-e);for(const t of T){const n=600+t*l;if(n+l>r.byteLength)continue;const o=[];for(let t=0;t<4;t++){const r=[];for(let o=0;o<64;o++){const s=n+4*(4*o+t),i=e(u,s),a=e(u,s+1),l=e(u,s+2),c=15&l,h=e(u,s+3),m=(i>>4&15)<<4|l>>4&15,p=f((15&i)<<8|a);let g=0,d=0;if(0!==c||0!==h)switch(c){case 0:h>=3&&(g=0,d=h);break;case 1:g=0,d=h;break;case 2:15&h?(g=2,d=15&h):h>>4&&(g=1,d=h>>4);break;case 12:g=12,d=127&h;break;case 13:g=10,d=h;break;case 14:g=14,d=h;break;case 15:g=15,d=15&h}r.push({note:p,instrument:m,volume:0,effTyp:g,eff:d,effTyp2:0,eff2:0})}o.push({id:`channel-${t}`,name:`Channel ${t+1}`,muted:!1,solo:!1,collapsed:!1,volume:100,pan:t%2==0?-50:50,instrumentId:null,color:null,rows:r})}const s=x.length;P.set(t,s),x.push({id:`pattern-${t}`,name:`Pattern ${t}`,length:64,channels:o,importMetadata:{sourceFormat:"STK",sourceFile:c,importedAt:(new Date).toISOString(),originalChannelCount:4,originalPatternCount:w,originalInstrumentCount:i}})}const W=[];for(const t of j){const e=P.get(t);void 0!==e&&W.push(e)}0===W.length&&W.push(0);let A=a+w*l;const D=[];for(let e=0;e<i;e++){const n=p[e],o=e+1,s=n.name||`Sample ${o}`,i=2*n.lengthWords;if(i<4||0===n.volume){A+=i,D.push({id:o,name:s,type:"sample",synthType:"Sampler",effects:[],volume:-60,pan:0});continue}const a=n.loopStart,l=2*n.loopLengthWords,c=l>2,f=c?a:0,u=A+f,m=i-f;let g;if(u+m<=r.byteLength&&m>0)g=h.slice(u,u+m);else if(A+i<=r.byteLength)g=h.slice(A,A+i);else{const t=Math.max(0,r.byteLength-A);g=t>0?h.slice(A,A+t):new Uint8Array(0)}if(A+=i,0===g.length){D.push({id:o,name:s,type:"sample",synthType:"Sampler",effects:[],volume:-60,pan:0});continue}const d=c?l:0;D.push(t(o,s,g,n.volume,8287,0,d))}return{name:m||c.replace(/\.[^/.]+$/,""),format:"MOD",patterns:x,instruments:D,songPositions:W,songLength:W.length,restartPosition:0,numChannels:4,initialSpeed:6,initialBPM:L,linearPeriods:!1}}export{u as isSTKFormat,h as parseSTKFile};
