!function(){"use strict";let t=null,e=null,n=!1;async function s(){if(n)return;const s=self.location.origin,a=`${s}/essentia/essentia-wasm.web.js`,r=`${s}/essentia/essentia.js-core.es.js`,o=await fetch(a);let c=await o.text();c=c.replace(/import\.meta\.url/g,`"${a}"`),c=c.replace(/export\s+default\s+/g,"var EssentiaWASM = "),c=c.replace(/export\s*\{[^}]*\}/g,""),c=c.replace(/var ENVIRONMENT_IS_WEB=true;var ENVIRONMENT_IS_WORKER=false;/g,"var ENVIRONMENT_IS_WEB=false;var ENVIRONMENT_IS_WORKER=true;"),c='var document = { currentScript: { src: "'+a+'" }, title: "" };\n'+c;const l=new Function(c+'\n;return typeof EssentiaWASM !== "undefined" ? EssentiaWASM : Module;')();e=await l();const i=await fetch(r);let f=await i.text();f=f.replace(/export\s+default\s+/g,"var Essentia = "),f=f.replace(/export\s*\{[^}]*\}/g,""),f=f.replace(/import\s+.*?from\s+['"][^'"]+['"];?/g,"");const h=new Function(f+'\n;return typeof Essentia !== "undefined" ? Essentia : null;')();if(!h)throw new Error("Failed to load Essentia core class");t=new h(e),n=!0}function a(t,e){self.postMessage({type:"analysisProgress",id:t,progress:Math.round(e)})}self.onmessage=async e=>{const n=e.data;switch(n.type){case"init":try{await s(),self.postMessage({type:"ready"})}catch(r){self.postMessage({type:"ready",error:r instanceof Error?r.message:String(r)})}break;case"analyze":{const{id:e,pcmLeft:o,pcmRight:c,sampleRate:l,numBins:i=800}=n;try{await s(),a(e,5);const n=function(t,e){if(!e)return t;const n=new Float32Array(t.length);for(let s=0;s<t.length;s++)n[s]=.5*(t[s]+e[s]);return n}(o,c);a(e,10);const f=function(t,e){try{const n=e.arrayToVector(t),s=e.RhythmExtractor2013(n,208,"multifeature",40),a=s.bpm??0,r=Math.min(1,Math.max(0,(s.confidence??0)/5.32)),o=[];if(s.ticks){const t=s.ticks.size();for(let e=0;e<t;e++)o.push(s.ticks.get(e))}try{n.delete()}catch{}try{s.ticks?.delete()}catch{}try{s.estimates?.delete()}catch{}try{s.bpmIntervals?.delete()}catch{}return{bpm:a,confidence:r,beats:o}}catch(r){return{bpm:0,confidence:0,beats:[]}}}(n,t);a(e,40);const h=function(t,e,n){try{const s=n.arrayToVector(t),a=n.KeyExtractor(s,!0,4096,4096,36,5e3,60,25,.2,"bgate",e),r=`${a.key??"Unknown"} ${a.scale??""}`.trim(),o=a.strength??0;try{s.delete()}catch{}return{key:r,confidence:o}}catch(r){return{key:"Unknown",confidence:0}}}(n,l,t);a(e,60);const{downbeats:u,timeSignature:p}=function(t,e,n){if(t.length<4)return{downbeats:t.length>0?[t[0]]:[],timeSignature:4};const s=Math.floor(.05*n),a=[];for(const l of t){const t=Math.floor(l*n),r=Math.max(0,t-s),o=Math.min(e.length,t+s);let c=0;for(let n=r;n<o;n++)c+=e[n]*e[n];a.push(c)}let r=4,o=-1/0;for(const l of[3,4]){let e=0;const n=Math.floor(t.length/l);if(!(n<2)){for(let t=0;t<n;t++){const n=t*l;if(n<a.length){const t=a[n];let s=0,r=0;for(let e=1;e<l&&n+e<a.length;e++)s+=a[n+e],r++;s=r>0?s/r:0,e+=t-s}}e>o&&(o=e,r=l)}}const c=[];for(let l=0;l<t.length;l+=r)c.push(t[l]);return{downbeats:c,timeSignature:r}}(f.beats,n,l);a(e,70);const g=function(t,e,n,s){const a=t.length,r=Math.floor(a/s);if(r<1)return[[0],[0],[0]];const o=new Float32Array(s),c=new Float32Array(s),l=new Float32Array(s),i=1/n,f=2*Math.PI*i*200/(2*Math.PI*i*200+1),h=1/(2*Math.PI*i*2e3+1);let u=0,p=0;for(let y=0;y<s;y++){const n=y*r,s=Math.min(n+r,a);let i=0,g=0,m=0;for(let a=n;a<s;a++){let n=t[a];e&&(n=.5*(n+e[a]));const s=Math.abs(n);u+=f*(s-u);const r=u,o=h*(p+s-(a>0?Math.abs(t[a-1]):0));p=o;const c=Math.max(0,s-r-Math.abs(o));r>i&&(i=r),c>g&&(g=c);const l=Math.abs(o);l>m&&(m=l)}o[y]=i,c[y]=g,l[y]=m}const g=t=>{let e=0;for(let s=0;s<t.length;s++)t[s]>e&&(e=t[s]);if(0===e)return Array.from(t);const n=new Array(t.length);for(let s=0;s<t.length;s++)n[s]=t[s]/e;return n};return[g(o),g(c),g(l)]}(o,c,l,i);a(e,90);const y=function(t){let e=0,n=0;for(let a=0;a<t.length;a++){const s=t[a];e+=s*s;const r=Math.abs(s);r>n&&(n=r)}const s=Math.sqrt(e/t.length);return{rmsDb:s>0?20*Math.log10(s):-100,peakDb:n>0?20*Math.log10(n):-100}}(n);a(e,95);const m={bpm:f.bpm,bpmConfidence:f.confidence,beats:f.beats,downbeats:u,timeSignature:p,musicalKey:h.key,keyConfidence:h.confidence,onsets:f.beats,frequencyPeaks:g,rmsDb:y.rmsDb,peakDb:y.peakDb};a(e,100),self.postMessage({type:"analysisComplete",id:e,result:m})}catch(r){const t=r instanceof Error?r.message:String(r);self.postMessage({type:"analysisError",id:e,error:t})}break}}},self.postMessage({type:"ready"})}();
