import{aG as e,bw as t,j as r}from"./index-zx6LJBPK.js";import{R as n,r as o}from"./vendor-utils-XMmR-oGw.js";function c(e){return new Worker("/assets/readonly-pattern.worker-BTbA0zPI.js",{name:e?.name})}const s=n.memo(({pattern:n,currentRow:s,numChannels:l,isPlaying:a=!1,height:i})=>{const u=o.useRef(null),f=o.useRef(null),h=o.useRef(null),[d,m]=o.useState({width:400,height:i??300}),p=e(e=>e.getCurrentTheme),w=o.useCallback(()=>{const e=p();return{accent:e.colors.accent,accentSecondary:e.colors.accentSecondary,accentGlow:e.colors.accentGlow,bg:e.colors.trackerRowEven,rowNormal:e.colors.trackerRowOdd,rowHighlight:e.colors.trackerRowHighlight,border:e.colors.border,textNote:e.colors.textSecondary,textNoteActive:e.colors.text,textMuted:e.colors.cellEmpty,textInstrument:e.colors.cellInstrument,textVolume:e.colors.cellVolume,textEffect:e.colors.cellEffect,lineNumber:e.colors.textMuted,lineNumberHighlight:e.colors.accentSecondary,selection:e.colors.accentGlow}},[p]),y=o.useCallback((e,t)=>e?{id:e.id,length:e.length,channels:e.channels.slice(0,t).map(e=>({id:e.id,effectCols:e.channelMeta?.effectCols??2,color:e.color??void 0,rows:e.rows.map(e=>({note:e.note??0,instrument:e.instrument??0,volume:e.volume??0,effTyp:e.effTyp??0,eff:e.eff??0,effTyp2:e.effTyp2??0,eff2:e.eff2??0}))}))}:null,[]),g=o.useCallback((e,t)=>{const r=e-40,n=Math.max(170,Math.floor(r/Math.max(1,t)));return{offsets:Array.from({length:t},(e,t)=>40+t*n),widths:Array.from({length:t},()=>n),totalWidth:n*t}},[]);return o.useEffect(()=>{const e=f.current;if(!e||!("transferControlToOffscreen"in HTMLCanvasElement.prototype))return;const r=document.createElement("canvas");r.style.cssText="display:block;width:100%;height:100%",e.appendChild(r),u.current=r;const o=new t(c,{onReady:()=>{}});h.current=o;const d=window.devicePixelRatio||1,m=Math.max(1,e.clientWidth),p=Math.max(1,i??e.clientHeight),x=r.transferControlToOffscreen();return o.post({type:"init",canvas:x,dpr:d,width:m,height:p,theme:w(),pattern:y(n,l),currentRow:s,numChannels:l,isPlaying:a,layout:g(m,l)},[x]),()=>{o.dispose(),h.current=null,r.remove(),u.current=null}},[]),o.useEffect(()=>{const e=f.current;if(!e)return;const t=new ResizeObserver(e=>{const t=e[0];if(!t)return;const r=Math.floor(t.contentRect.width),n=i??Math.floor(t.contentRect.height);if(r>0&&n>0){m({width:r,height:n});const e=window.devicePixelRatio||1;h.current?.post({type:"resize",w:r,h:n,dpr:e})}});return t.observe(e),()=>t.disconnect()},[i]),o.useEffect(()=>{h.current?.post({type:"pattern",pattern:y(n,l),numChannels:l,layout:g(d.width,l)})},[n,l,d.width,y,g]),o.useEffect(()=>{h.current?.post({type:"playback",currentRow:s,isPlaying:a})},[s,a]),r.jsxDEV("div",{ref:f,className:"w-full h-full",style:i?{height:i}:void 0},void 0,!1,{fileName:"/Users/spot/Code/DEViLBOX/src/components/tracker/ReadOnlyPatternCanvas.tsx",lineNumber:243,columnNumber:5},void 0)});export{s as R};
