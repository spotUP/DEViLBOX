function t(t,n){return t[n]??0}function n(t,n){return(t[n]??0)|(t[n+1]??0)<<8}function e(t,n){return((t[n]??0)|(t[n+1]??0)<<8|(t[n+2]??0)<<16|(t[n+3]??0)<<24)>>>0}function r(t,n){return new DataView(t.buffer,t.byteOffset+n,8).getFloat64(0,!0)}function o(t,n,e){let r="";for(let o=0;o<e;o++){const e=t[n+o]??0;if(0===e)break;r+=String.fromCharCode(e>=32?e:32)}return r.trimEnd()}const a=274;function f(t){if(t.length<382)return!1;if(77!==t[0]||84!==t[1]||50!==t[2]||48!==t[3])return!1;const e=n(t,6);if(e<512||e>=768)return!1;const r=n(t,42);if(r<1||r>64)return!1;if(n(t,38)>256)return!1;if(n(t,48)>=255)return!1;return!(n(t,50)>=256)}function l(l,c){try{return function(l,c){if(!f(l))return null;let h=0;const m=n(l,6),p=o(l,40,64),g=n(l,104),d=n(l,106),M=n(l,108),x=n(l,110),y=n(l,112),C=t(l,114),v=t(l,115),T=e(l,116),b=n(l,120),k=n(l,122);if(x<1||x>64)return null;if(g>256)return null;if(h=126,h+256>l.length)return null;const $=[];for(let n=0;n<g;n++)$.push(t(l,h+n));if(h+=256,h+2>l.length)return null;const P=n(l,h);h+=2;const S=[];let w=0;if(0!==P){if(h+a>l.length)return null;w=8;for(let n=0;n<a;n++)S.push(t(l,h+n));h+=a}if(h+4>l.length)return null;const A=e(l,h);h+=4;const I=h;if(h+A>l.length)return null;const F=h+A;h+=A;const z=x+w,D=!!(1&T),O=[];for(let r=0;r<M&&!(h+6>l.length);r++){const o=n(l,h);h+=2;const a=e(l,h);h+=4;const f=h,m=h+(a+1&-2);if(h=m,m>l.length)break;const p=Math.min(o,256);if(0===p){O.push(u(r,p,z,c,M,b));continue}const g=Array.from({length:p},()=>Array.from({length:z},()=>({note:0,instrument:0,volume:0,effTyp:0,eff:0,effTyp2:0,eff2:0})));let d=f;if(D){let n=0,e=0;for(;d<m&&e<x&&!(d>=l.length);){const r=t(l,d++);let o=0,a=r;if(255===r){if(d>=m)break;if(o=t(l,d++),d>=m)break;a=t(l,d++)}if(127&a){const r={note:0,instr:0,vol:0,pan:0,fxcmd:0,fxparam1:0,fxparam2:0};1&a&&d<m&&(r.note=t(l,d++)),2&a&&d<m&&(r.instr=t(l,d++)),4&a&&d<m&&(r.vol=t(l,d++)),8&a&&d<m&&(r.pan=t(l,d++)),16&a&&d<m&&(r.fxcmd=t(l,d++)),32&a&&d<m&&(r.fxparam1=t(l,d++)),64&a&&d<m&&(r.fxparam2=t(l,d++)),n<p&&e<x&&i(g[n][e],r);const f=Math.min(o,p-(n+1));for(let t=0;t<f;t++)n+1+t<p&&e<x&&i(g[n+1+t][e],r)}for(n+=o+1;n>=p;)n-=p,e++;if(e>=x)break}}else for(let n=0;n<p;n++)for(let e=0;e<x&&!(d+7>m);e++){const r={note:t(l,d),instr:t(l,d+1),vol:t(l,d+2),pan:t(l,d+3),fxcmd:t(l,d+4),fxparam1:t(l,d+5),fxparam2:t(l,d+6)};d+=7,i(g[n][e],r)}O.push(s(r,p,z,g,c,M,b))}let B=0;{let n=I;for(;n+8<=F;){const o=e(l,n),a=e(l,n+4);n+=8;const f=n+a;if(f>F)break;if(726487106===o){const e=t(l,n-8),o=t(l,n-7),f=t(l,n-6),i=t(l,n-5);66===e&&80===o&&77===f&&43===i&&a>=8&&(B=r(l,n))}else{const e=t(l,n-8),o=t(l,n-7),i=t(l,n-6),s=t(l,n-5),u=String.fromCharCode(e,o,i,s);if("BPM+"===u&&a>=8)B=r(l,n);else if("SUM\0"===u&&a>7){let e=n+6;for(;e<f&&0!==t(l,e);)e++}}n=f}}if(2&T){const t=(8&T?z:x)+(m>=592?0:0)+(16&T?1:0);for(let r=0;r<M;r++)for(let o=0;o<t&&!(h+4>l.length);o++){let t;if(m>=515){if(h+8>l.length)break;t=e(l,h),h+=4,h+=4}else{if(h+4>l.length)break;t=n(l,h),h+=2,h+=2}let r=t;for(;0!==r;)1&r&&(h+=260),r>>>=1}}const E=[];for(let t=0;t<255;t++){if(h+32+4>l.length){E.push({start:0,size:0,name:""});continue}const t=o(l,h,32);h+=32;let n=e(l,h);h+=4,32===n&&(n+=396),m>513&&n>0&&(n+=4),E.push({start:h,size:n,name:t}),h+=n}for(let r=0;r<256;r++){if(h+32+4>l.length)continue;o(l,h,32);h+=32;const a=e(l,h);h+=4;const f=h;a>=26&&r<k&&(e(l,f),e(l,f+4),t(l,f+8),t(l,f+9),t(l,f+10),t(l,f+11),e(l,f+12),e(l,f+16),n(l,f+20),t(l,f+22),t(l,f+22),t(l,f+23)),h+=a}const L=Array.from({length:b},()=>[]);for(let e=0;e<b;e++){const r=E[e];if(0===r.size)continue;if(r.start+106>l.length)continue;const o=n(l,r.start);if(0===o||o>256)continue;const a=[];for(let n=0;n<o&&!(h+8>l.length);n++)a.push({sample:t(l,h),vol:t(l,h+1),pitch:t(l,h+2)>=128?t(l,h+2)-256:t(l,h+2)}),h+=8;L[e]=a}const U=[];for(let t=0;t<b;t++){const n=E[t],e=t+1;U.push({id:e,name:n.name||`Instrument ${e}`,type:"sample",synthType:"Sampler",effects:[],volume:0,pan:0})}let V=125;const X=Math.max(1,Math.min(31,C)),j=Math.max(1,Math.min(32,v));if(y>1&&y<5e3)if(B>1e-8){const t=2646e3/(X*j*B);V=Math.round(Math.max(32,Math.min(999,t)))}else{const t=2646e3/(X*j*y);V=Math.round(Math.max(32,Math.min(999,t)))}const q=$.slice(0,g),G=Math.max(...q,0);for(;O.length<=G;){const t=O.length;O.push(u(t,64,z,c,M,b))}0===O.length&&O.push(u(0,64,z,c,0,b));0===q.length&&q.push(0);const H=c.replace(/\.[^/.]+$/,"");return{name:p.trim()||H,format:"XM",patterns:O,instruments:U,songPositions:q,songLength:q.length,restartPosition:Math.min(d,q.length-1),numChannels:z,initialSpeed:X,initialBPM:V,linearPeriods:!0}}(l,c)}catch{return null}}function i(t,n){var e;t.note=function(t){if(0===t)return 0;if(t>96)return 121;const n=t+12;return Math.max(1,Math.min(120,n))}(n.note),t.instrument=n.instr,t.volume=(e=n.vol)>=16&&e<=144?Math.round((e-16)/2):0;const[r,o]=function(t,n,e){if(!t&&!n&&!e)return[0,0];switch(t){case 0:return 15===e?[15,n]:11===e?[11,n]:13===e?[13,n]:1===e?[1,n]:2===e?[2,n]:3===e?[3,n]:4===e?[4,n]:10===e?[10,n]:[0,0];case 1:return[1,Math.min(255,e<<4|n>>4)];case 2:return[2,Math.min(255,e<<4|n>>4)];case 3:return[3,Math.min(255,e<<4|n>>4)];case 4:return[4,255&(240&e|n>>4)];case 8:return n?[8,n]:[0,0];case 12:return[12,Math.min(64,e>>1)];case 15:return 0!==e?[15,e]:[15,15&n];case 16:return[e,n];case 29:return[29,n];case 36:return[19,159];case 128:return[17,Math.min(64,e>>2)];default:return[0,0]}}(n.fxcmd,n.fxparam1,n.fxparam2);t.effTyp=r,t.eff=o,n.pan&&0===t.effTyp&&(t.effTyp=8,t.eff=n.pan)}function s(t,n,e,r,o,a,f){const l=[];for(let i=0;i<e;i++){const t=[];for(let e=0;e<n;e++)t.push(r[e]?.[i]??{note:0,instrument:0,volume:0,effTyp:0,eff:0,effTyp2:0,eff2:0});l.push({id:`channel-${i}`,name:`Channel ${i+1}`,muted:!1,solo:!1,collapsed:!1,volume:100,pan:0,instrumentId:null,color:null,rows:t})}return{id:`pattern-${t}`,name:`Pattern ${t}`,length:n,channels:l,importMetadata:{sourceFormat:"MadTracker2",sourceFile:o,importedAt:(new Date).toISOString(),originalChannelCount:e,originalPatternCount:a,originalInstrumentCount:f}}}function u(t,n,e,r,o,a){const f=()=>({note:0,instrument:0,volume:0,effTyp:0,eff:0,effTyp2:0,eff2:0}),l=Array.from({length:e},(t,e)=>({id:`channel-${e}`,name:`Channel ${e+1}`,muted:!1,solo:!1,collapsed:!1,volume:100,pan:0,instrumentId:null,color:null,rows:Array.from({length:n},f)}));return{id:`pattern-${t}`,name:`Pattern ${t}`,length:n,channels:l,importMetadata:{sourceFormat:"MadTracker2",sourceFile:r,importedAt:(new Date).toISOString(),originalChannelCount:e,originalPatternCount:o,originalInstrumentCount:a}}}export{f as isMadTracker2Format,l as parseMadTracker2File};
