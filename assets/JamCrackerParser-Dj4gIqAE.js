import{aB as t,aC as e}from"./index-zx6LJBPK.js";import"./vendor-react-DkDaD07v.js";import"./vendor-utils-XMmR-oGw.js";import"./vendor-tone-CADp_hfL.js";import"./vendor-ui-uomqNFY-.js";function n(t,e){return t.getUint8(e)}function r(t,e){return t.getInt8(e)}function o(t,e){return t.getUint16(e,!1)}function a(t,e){return t.getUint32(e,!1)}function s(t,e,n){let r="";for(let o=0;o<n;o++){const n=t.getUint8(e+o);if(0===n)break;r+=String.fromCharCode(n)}return r}function i(t){if(t.byteLength<10)return!1;return"BeEp"===s(new DataView(t),0,4)}async function l(i,l){const u=new DataView(i),p=new Uint8Array(i);if(i.byteLength<10)throw new Error("JamCracker: file too small");const c=s(u,0,4);if("BeEp"!==c)throw new Error(`JamCracker: bad magic "${c}"`);const m=o(u,4);if(6+40*m>i.byteLength)throw new Error("JamCracker: truncated instrument table");const f=[];for(let t=0;t<m;t++){const e=6+40*t,r=s(u,e,31).trim(),o=n(u,e+31),i=a(u,e+32);f.push({name:r,flags:o,size:i})}let h=6+40*m;if(h+2>i.byteLength)throw new Error("JamCracker: truncated pattern count");const g=o(u,h);h+=2;if(h+6*g>i.byteLength)throw new Error("JamCracker: truncated pattern table");const d=[];for(let t=0;t<g;t++){const t=o(u,h);d.push({rows:t>0?t:64}),h+=6}if(h+2>i.byteLength)throw new Error("JamCracker: truncated song length");const w=o(u,h);h+=2;const C=[];for(let t=0;t<w&&!(h+2>i.byteLength);t++)C.push(o(u,h)),h+=2;const y=[];for(let t=0;t<g;t++){const e=d[t].rows,o=[];for(let t=0;t<e;t++){const t=[];for(let e=0;e<4;e++)h+8>i.byteLength?t.push({period:0,instr:0,speed:0,arpeggio:0,vibrato:0,phase:0,volume:0,porta:0}):(t.push({period:n(u,h),instr:r(u,h+1),speed:n(u,h+2),arpeggio:n(u,h+3),vibrato:n(u,h+4),phase:n(u,h+5),volume:n(u,h+6),porta:n(u,h+7)}),h+=8);o.push(t)}y.push(o)}const b=[];for(let t=0;t<m;t++){const e=f[t].size;if(!!(2&f[t].flags)||0===e)b.push(null),h+=e;else{const t=Math.min(e,Math.max(0,i.byteLength-h));b.push(t>0?p.slice(h,h+t):null),h+=e}}const v=[];for(let e=0;e<m;e++){const n=f[e],r=!!(2&n.flags),o=!!(1&n.flags),a=b[e],s=n.name||`Sample ${e+1}`;if(r||null===a)v.push({id:e+1,name:s,type:"sample",synthType:"Sampler",effects:[],volume:-60,pan:0});else{const n=0,r=o?a.length:0;v.push(t(e+1,s,a,64,8287,n,r))}}const k=[-50,50,50,-50],L=y.map((t,n)=>{const r=Array.from({length:4},(n,r)=>{const o=t.map(t=>{const n=t[r],o=n.period>0?e(n.period):0,a=n.instr>0?n.instr:0,s=n.volume>0?16+Math.min(n.volume-1,64):0;let i=0,l=0;return n.speed>0?(i=15,l=n.speed):n.arpeggio>0?(i=0,l=n.arpeggio):n.vibrato>0?(i=4,l=n.vibrato):n.porta>0&&(i=3,l=n.porta),{note:o,instrument:a,volume:s,effTyp:i,eff:l,effTyp2:0,eff2:0}});return{id:`channel-${r}`,name:`Channel ${r+1}`,muted:!1,solo:!1,collapsed:!1,volume:100,pan:k[r],instrumentId:null,color:null,rows:o}});return{id:`pattern-${n}`,name:`Pattern ${n}`,length:t.length,channels:r,importMetadata:{sourceFormat:"JamCracker",sourceFile:l,importedAt:(new Date).toISOString(),originalChannelCount:4,originalPatternCount:g,originalInstrumentCount:m}}});0===L.length&&L.push({id:"pattern-0",name:"Pattern 0",length:64,channels:Array.from({length:4},(t,e)=>({id:`channel-${e}`,name:`Channel ${e+1}`,muted:!1,solo:!1,collapsed:!1,volume:100,pan:k[e],instrumentId:null,color:null,rows:Array.from({length:64},()=>({note:0,instrument:0,volume:0,effTyp:0,eff:0,effTyp2:0,eff2:0}))})),importMetadata:{sourceFormat:"JamCracker",sourceFile:l,importedAt:(new Date).toISOString(),originalChannelCount:4,originalPatternCount:0,originalInstrumentCount:0}});const $=C.filter(t=>t<g).map(t=>t);0===$.length&&$.push(0);let E=6;if($.length>0){const t=y[$[0]];if(t?.length>0)for(const e of t[0])if(e.speed>0){E=e.speed;break}}return{name:l.replace(/\.[^/.]+$/,""),format:"MOD",patterns:L,instruments:v,songPositions:$,songLength:$.length,restartPosition:0,numChannels:4,initialSpeed:E,initialBPM:125,linearPeriods:!1}}export{i as isJamCrackerFormat,l as parseJamCrackerFile};
