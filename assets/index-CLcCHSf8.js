import{bd as e,d as t,j as r,Q as i,u as o,n as a}from"./index-1wJvggfK.js";import{r as s,R as n}from"./vendor-utils-Cm-70yv0.js";import{ae as l,n as c,aK as d,aL as h,ag as u,N as p,l as g,aI as f,aA as w,aJ as x,z as m,d as b,C as v}from"./vendor-ui-Cpb_sTe-.js";import"./vendor-react-LeNVipsj.js";import"./vendor-tone-CADp_hfL.js";const y=[{label:"Row",value:1},{label:"Beat",value:6},{label:"1/2 Bar",value:12},{label:"Bar",value:24},{label:"2 Bars",value:48},{label:"4 Bars",value:96},{label:"Off",value:0}],k=()=>{const{tool:o,setTool:a,view:s,setPixelsPerRow:n,setSnapDivision:b,setFollowPlayback:v,zoomToFit:k,addTrack:R}=e(),{isPlaying:S,togglePlayPause:I,stop:C}=t(),T=(e,t,i,s)=>r.jsx("button",{className:"p-1.5 rounded text-xs transition-colors "+(o===e?"bg-accent-primary text-white":"bg-dark-bgTertiary text-text-secondary hover:bg-dark-border hover:text-text-primary"),onClick:()=>a(e),title:`${i} (${s})`,children:t});return r.jsxs("div",{className:"flex items-center gap-2 px-3 py-1.5 bg-dark-bgSecondary border-b border-dark-border text-xs select-none",children:[r.jsxs("select",{value:"arrangement",onChange:e=>{"arrangement"!==e.target.value&&i.getState().setActiveView("tracker")},className:"px-2 py-0.5 text-[10px] font-bold tracking-widest uppercase bg-dark-bgTertiary text-text-muted border border-dark-border rounded hover:bg-dark-bgHover transition-colors cursor-pointer",title:"Switch view",children:[r.jsx("option",{value:"tracker",children:"Tracker"}),r.jsx("option",{value:"arrangement",children:"Arrangement"})]}),r.jsx("div",{className:"w-px h-5 bg-dark-border"}),r.jsxs("div",{className:"flex items-center gap-1",children:[r.jsx("button",{className:"p-1.5 rounded text-xs transition-colors "+(S?"bg-green-600 text-white":"bg-dark-bgTertiary text-text-secondary hover:bg-dark-border hover:text-text-primary"),onClick:I,title:"Play/Pause (Space)",children:r.jsx(l,{size:14,fill:S?"currentColor":"none"})}),r.jsx("button",{className:"p-1.5 rounded bg-dark-bgTertiary text-text-secondary hover:bg-dark-border hover:text-text-primary",onClick:C,title:"Stop (Space when playing)",children:r.jsx(c,{size:14})})]}),r.jsx("div",{className:"w-px h-5 bg-dark-border"}),r.jsxs("div",{className:"flex items-center gap-1",children:[T("select",r.jsx(f,{size:14}),"Select","V"),T("draw",r.jsx(w,{size:14}),"Draw","D"),T("erase",r.jsx(x,{size:14}),"Erase","E"),T("split",r.jsx(m,{size:14}),"Split","S")]}),r.jsx("div",{className:"w-px h-5 bg-dark-border"}),r.jsxs("div",{className:"flex items-center gap-1",children:[r.jsx("button",{className:"p-1 rounded bg-dark-bgTertiary text-text-secondary hover:bg-dark-border hover:text-text-primary",onClick:()=>n(Math.max(.5,s.pixelsPerRow/1.5)),title:"Zoom Out (Ctrl+-)",children:r.jsx(d,{size:14})}),r.jsx("span",{className:"text-text-muted w-12 text-center text-[10px] tabular-nums",children:s.pixelsPerRow.toFixed(1)}),r.jsx("button",{className:"p-1 rounded bg-dark-bgTertiary text-text-secondary hover:bg-dark-border hover:text-text-primary",onClick:()=>n(Math.min(32,1.5*s.pixelsPerRow)),title:"Zoom In (Ctrl++)",children:r.jsx(h,{size:14})}),r.jsx("button",{className:"p-1 rounded bg-dark-bgTertiary text-text-secondary hover:bg-dark-border hover:text-text-primary",onClick:k,title:"Zoom to Fit (Ctrl+0)",children:r.jsx(u,{size:14})})]}),r.jsx("div",{className:"w-px h-5 bg-dark-border"}),r.jsxs("div",{className:"flex items-center gap-1",children:[r.jsx("span",{className:"text-text-muted",children:"Snap:"}),r.jsx("select",{className:"bg-dark-bgTertiary border border-dark-border rounded px-1.5 py-0.5 text-text-primary text-xs",value:s.snapDivision,onChange:e=>b(Number(e.target.value)),children:y.map(e=>r.jsx("option",{value:e.value,children:e.label},e.value))})]}),r.jsx("div",{className:"w-px h-5 bg-dark-border"}),r.jsxs("button",{className:"p-1 rounded text-xs flex items-center gap-1 "+(s.followPlayback?"bg-accent-primary/20 text-accent-primary":"bg-dark-bgTertiary text-text-secondary hover:bg-dark-border"),onClick:()=>v(!s.followPlayback),title:"Follow Playback (F)",children:[r.jsx(p,{size:14}),r.jsx("span",{children:"Follow"})]}),r.jsx("div",{className:"flex-1"}),r.jsxs("button",{className:"p-1.5 rounded bg-dark-bgTertiary text-text-secondary hover:bg-dark-border hover:text-text-primary flex items-center gap-1",onClick:()=>R(),title:"Add Track (Ctrl+T)",children:[r.jsx(g,{size:14}),r.jsx("span",{children:"Track"})]})]})},R=({track:t,height:i})=>{const{toggleTrackMute:o,toggleTrackSolo:a,updateTrack:n}=e(),[l,c]=s.useState(!1),[d,h]=s.useState(t.name);s.useEffect(()=>{requestAnimationFrame(()=>h(t.name))},[t.name]);const u=s.useCallback(()=>{c(!1),d.trim()&&d!==t.name&&n(t.id,{name:d.trim()})},[d,t.id,t.name,n]),p=s.useCallback(e=>{"Enter"===e.key&&u(),"Escape"===e.key&&(h(t.name),c(!1))},[u,t.name]);return r.jsxs("div",{className:"flex border-b border-dark-border bg-dark-bgSecondary select-none",style:{height:i,minHeight:30},children:[r.jsx("div",{className:"flex-shrink-0",style:{width:4,backgroundColor:t.color||"#666"}}),r.jsxs("div",{className:"flex-1 flex flex-col px-2 py-1.5 min-w-0",children:[r.jsxs("div",{className:"flex items-center gap-1.5 min-h-[20px]",children:[r.jsx("span",{className:"flex-shrink-0 w-4 h-4 rounded text-[8px] font-bold flex items-center justify-center",style:{backgroundColor:`${t.color||"#666"}33`,color:t.color||"#888"},children:t.index+1}),l?r.jsx("input",{className:"bg-dark-bgTertiary border border-dark-border rounded px-1 text-xs text-text-primary w-full",value:d,onChange:e=>h(e.target.value),onBlur:u,onKeyDown:p,autoFocus:!0}):r.jsx("span",{className:"text-xs text-text-primary truncate cursor-pointer hover:text-accent-primary font-medium",onDoubleClick:()=>c(!0),title:t.name,children:t.name})]}),i>=44&&r.jsxs("div",{className:"flex items-center gap-1 mt-1.5",children:[r.jsx("button",{className:"w-6 h-5 rounded text-[10px] font-bold leading-none transition-colors "+(t.muted?"bg-red-600 text-white":"bg-dark-bgTertiary text-text-muted hover:bg-dark-border hover:text-text-primary"),onClick:()=>o(t.id),title:"Mute",children:"M"}),r.jsx("button",{className:"w-6 h-5 rounded text-[10px] font-bold leading-none transition-colors "+(t.solo?"bg-yellow-600 text-white":"bg-dark-bgTertiary text-text-muted hover:bg-dark-border hover:text-text-primary"),onClick:()=>a(t.id),title:"Solo",children:"S"}),i>=56&&r.jsx("div",{className:"flex-1 ml-1.5",children:r.jsx("div",{className:"relative h-[4px] bg-dark-bgTertiary rounded-full overflow-hidden",children:r.jsx("div",{className:"absolute inset-y-0 left-0 rounded-full",style:{width:`${t.volume}%`,backgroundColor:`${t.color||"#3b82f6"}88`}})})})]})]})]})},S=({tracks:e,entries:t,scrollY:i})=>{const o=new Map(e.map(e=>[e.id,e])),a=[...t].filter(e=>e.visible).sort((e,t)=>e.trackIndex-t.trackIndex);return r.jsxs("div",{className:"flex-shrink-0 overflow-hidden bg-dark-bgSecondary border-r border-dark-border flex flex-col",style:{width:180},children:[r.jsx("div",{className:"flex items-center px-3 border-b border-dark-border flex-shrink-0",style:{height:36},children:r.jsx("span",{className:"text-[10px] font-bold text-text-muted tracking-widest uppercase",children:"Tracks"})}),r.jsx("div",{className:"flex-1 overflow-hidden",children:r.jsx("div",{style:{transform:`translateY(${-i}px)`,willChange:"transform"},children:a.map(e=>{const t=o.get(e.trackId);return t?r.jsx(R,{track:t,height:e.height},t.id):null})})})]})};class I{scrollRow=0;scrollY=0;pixelsPerRow=4;width=800;height=400;update(e){void 0!==e.scrollRow&&(this.scrollRow=e.scrollRow),void 0!==e.scrollY&&(this.scrollY=e.scrollY),void 0!==e.pixelsPerRow&&(this.pixelsPerRow=e.pixelsPerRow),void 0!==e.width&&(this.width=e.width),void 0!==e.height&&(this.height=e.height)}rowToPixelX(e){return(e-this.scrollRow)*this.pixelsPerRow}pixelXToRow(e){return e/this.pixelsPerRow+this.scrollRow}trackYToScreenY(e){return e-this.scrollY}screenYToTrackY(e){return e+this.scrollY}snapRow(e,t){return t<=0?Math.round(e):Math.round(e/t)*t}getVisibleRowRange(){const e=Math.floor(this.scrollRow),t=Math.ceil(this.scrollRow+this.width/this.pixelsPerRow)+1;return{startRow:Math.max(0,e),endRow:t}}get visibleRows(){return this.width/this.pixelsPerRow}}class C{entries=[];totalHeight=0;rebuild(e,t,r){const i=new Set(t.filter(e=>e.collapsed).map(e=>e.id)),o=new Set(t.filter(e=>e.folded).map(e=>e.id)),a=[...e].sort((e,t)=>e.index-t.index);this.entries=[];let s=0;for(const n of a){const e=!n.groupId||!i.has(n.groupId)&&!o.has(n.groupId),t=r.filter(e=>e.trackId===n.id&&e.visible),a=n.automationVisible?40*t.length:0,l=n.collapsed?24:n.height,c=l+a;this.entries.push({trackId:n.id,trackIndex:n.index,y:s,height:e?c:0,bodyHeight:e?l:0,automationY:s+l,automationHeight:e?a:0,visible:e}),e&&(s+=c+1)}this.totalHeight=s}getTotalHeight(){return this.totalHeight}getEntries(){return this.entries}getVisibleEntries(e,t){return this.entries.filter(r=>{if(!r.visible)return!1;return r.y+r.height>e&&r.y<e+t})}hitTestY(e){for(const t of this.entries){if(!t.visible)continue;if(e<t.y)continue;if(e>t.y+t.height)continue;const r=e-t.y;return r>=t.bodyHeight-4&&r<=t.bodyHeight?{trackIndex:t.trackIndex,trackId:t.trackId,zone:"resize-handle"}:r>t.bodyHeight?{trackIndex:t.trackIndex,trackId:t.trackId,zone:"automation"}:{trackIndex:t.trackIndex,trackId:t.trackId,zone:"body"}}return null}getEntryForTrack(e){return this.entries.find(t=>t.trackId===e)}}const T={background:"#0c0c0e",trackEven:"rgba(255,255,255,0.02)",trackOdd:"rgba(255,255,255,0.05)",trackSeparator:"rgba(255,255,255,0.12)",gridLine:"rgba(255,255,255,0.04)",beatLine:"rgba(255,255,255,0.15)",barLine:"rgba(255,255,255,0.30)",fourBarLine:"rgba(255,255,255,0.42)",beyondEnd:"rgba(100,100,100,0.08)"};class P{canvas=null;ctx=null;lastKey="";colors={...T};cacheKey(e,t,r,i,o,a){const s=t.map(e=>`${e.y}_${e.height}`).join(",");return`${e.scrollRow.toFixed(2)}_${e.scrollY.toFixed(1)}_${e.pixelsPerRow}_${e.width}_${e.height}_${r}_${i}_${o}_${a}_${s}`}render(e,t,r,i,o,a){const s=this.cacheKey(e,t,r,i,o,a);if(s===this.lastKey&&this.canvas)return this.canvas;const n=Math.ceil(e.width*a),l=Math.ceil(e.height*a);if(n<=0||l<=0)return null;this.canvas&&this.canvas.width===n&&this.canvas.height===l||(this.canvas=new OffscreenCanvas(n,l),this.ctx=this.canvas.getContext("2d"));const c=this.ctx;if(!c)return null;c.setTransform(a,0,0,a,0,0),c.fillStyle=this.colors.background,c.fillRect(0,0,e.width,e.height);for(let w=0;w<t.length;w++){const r=t[w];if(!r.visible)continue;const i=e.trackYToScreenY(r.y);i+r.height<0||i>e.height||(c.fillStyle=w%2==0?this.colors.trackEven:this.colors.trackOdd,c.fillRect(0,i,e.width,r.height),c.fillStyle=this.colors.trackSeparator,c.fillRect(0,i+r.height,e.width,1))}const d=r,h=r*i,u=4*h,p=e.getVisibleRowRange();let g=1;e.pixelsPerRow<1?g=h:e.pixelsPerRow<2&&(g=d);const f=Math.max(0,Math.floor(p.startRow/g)*g);if(o<p.endRow){const t=e.rowToPixelX(o);t<e.width&&(c.fillStyle=this.colors.beyondEnd,c.fillRect(t,0,e.width-t,e.height))}for(let w=f;w<=Math.min(p.endRow,o);w+=g){const t=e.rowToPixelX(w);if(t<-1||t>e.width+1)continue;const r=w%h===0,i=w%d===0;w%u===0?(c.fillStyle=this.colors.fourBarLine,c.fillRect(t,0,1,e.height)):r?(c.fillStyle=this.colors.barLine,c.fillRect(t,0,1,e.height)):i?(c.fillStyle=this.colors.beatLine,c.fillRect(t,0,1,e.height)):e.pixelsPerRow>=2&&(c.fillStyle=this.colors.gridLine,c.fillRect(t,0,1,e.height))}return this.lastKey=s,this.canvas}invalidate(){this.lastKey=""}}class M{previewCache=new Map;render(e,t,r,i,o,a,s,n,l,c,d){const h=new Map(i.map(e=>[e.id,e])),u=new Map(o.map(e=>[e.trackId,e])),p=new Map(a.map(e=>[e.id,e])),g=t.getVisibleRowRange(),f=r.filter(e=>{const t=p.get(e.patternId),r=e.clipLengthRows??(t?t.length-e.offsetRows:64);return e.startRow+r>=g.startRow-10&&e.startRow<=g.endRow+10});for(const w of f){const r=u.get(w.trackId);if(!r||!r.visible)continue;const i=h.get(w.trackId);if(!i)continue;const o=p.get(w.patternId),a=w.clipLengthRows??(o?o.length-w.offsetRows:64),n=w.startRow+a,g=s.has(w.id),f=c&&void 0!==l&&l>=w.startRow&&l<n,x=d===w.id;this.drawClip(e,t,w,i,r,o,a,g,!1,f,l,x)}if(n)for(const w of n){const r=u.get(w.trackId);if(!r||!r.visible)continue;const i=h.get(w.trackId);if(!i)continue;const o=p.get(w.patternId),a=w.clipLengthRows??(o?o.length-w.offsetRows:64);this.drawClip(e,t,w,i,r,o,a,!1,!0,!1,void 0,!1)}}drawClip(e,t,r,i,o,a,s,n,l,c=!1,d,h=!1){const u=t.rowToPixelX(r.startRow)+1,p=t.trackYToScreenY(o.y)+1,g=s*t.pixelsPerRow-2,f=o.bodyHeight-2;if(g<2||f<4)return;const w=r.color??i.color??"#3b82f6",x=function(e){const t=e.replace("#",""),r=parseInt(3===t.length?t.split("").map(e=>e+e).join(""):t.slice(0,6),16);return{r:r>>16&255,g:r>>8&255,b:255&r}}(w);if(e.save(),l&&(e.globalAlpha=.4),e.beginPath(),this.roundRect(e,u,p,g,f,4),r.muted)e.fillStyle=`rgba(${x.r},${x.g},${x.b},0.18)`;else{const t=e.createLinearGradient(u,p,u,p+f);t.addColorStop(0,`rgba(${x.r},${x.g},${x.b},0.55)`),t.addColorStop(1,`rgba(${Math.floor(.6*x.r)},${Math.floor(.6*x.g)},${Math.floor(.6*x.b)},0.45)`),e.fillStyle=t}e.fill(),n?(e.strokeStyle="#ffffff",e.lineWidth=2,e.stroke()):h&&!l?(e.strokeStyle=`rgba(${x.r},${x.g},${x.b},0.9)`,e.lineWidth=2,e.stroke()):(e.strokeStyle=`rgba(${x.r},${x.g},${x.b},0.7)`,e.lineWidth=1,e.stroke()),l&&(e.setLineDash([4,4]),e.strokeStyle="#ffffffaa",e.lineWidth=1,e.stroke(),e.setLineDash([])),e.beginPath(),this.roundRect(e,u,p,g,f,4),e.clip(),r.muted?(e.fillStyle=`rgba(${x.r},${x.g},${x.b},0.35)`,e.fillRect(u,p,g,4)):(e.fillStyle=w,e.fillRect(u,p,g,4));const m=e.createLinearGradient(u,p+4,u,p+4+6);m.addColorStop(0,"rgba(255,255,255,0.07)"),m.addColorStop(1,"rgba(255,255,255,0)"),e.fillStyle=m,e.fillRect(u,p+4,g,6);const b=e.createLinearGradient(u,p+f-8,u,p+f);if(b.addColorStop(0,"rgba(0,0,0,0)"),b.addColorStop(1,"rgba(0,0,0,0.15)"),e.fillStyle=b,e.fillRect(u,p+f-8,g,8),g>20&&f>20&&a&&this.drawNoteDensityPreview(e,t,r,a,u,p+16,g,f-16),g>30){const t=a?.name??r.patternId,i=g-8;e.fillStyle="rgba(0,0,0,0.5)",e.font="bold 10px Inter, system-ui, sans-serif",e.textBaseline="top",e.fillText(t,u+5,p+4+3,i),e.fillStyle=r.muted?"#ffffff55":"#ffffffee",e.fillText(t,u+4,p+4+2,i)}if(c&&void 0!==d&&!l){const t=u+g*((d-r.startRow)/s);e.fillStyle=`rgba(${x.r},${x.g},${x.b},0.2)`,e.fillRect(u,p,t-u,f);const i=e.createLinearGradient(t-4,p,t+4,p);i.addColorStop(0,`rgba(${x.r},${x.g},${x.b},0)`),i.addColorStop(.5,`rgba(${Math.min(255,x.r+60)},${Math.min(255,x.g+60)},${Math.min(255,x.b+60)},0.8)`),i.addColorStop(1,`rgba(${x.r},${x.g},${x.b},0)`),e.fillStyle=i,e.fillRect(t-4,p,8,f),e.strokeStyle="rgba(255,255,255,0.9)",e.lineWidth=2,e.beginPath(),e.moveTo(t,p),e.lineTo(t,p+f),e.stroke(),e.fillStyle="rgba(255,255,255,0.15)",e.fillRect(u,p,g,4)}if(r.fadeInRows&&r.fadeInRows>0&&!l){const i=Math.min(.4*g,r.fadeInRows*t.pixelsPerRow);if(i>2){const t=r.fadeInCurve||"linear",o=e.createLinearGradient(u,p,u+i,p);"exponential"===t?(o.addColorStop(0,"rgba(0,0,0,0.6)"),o.addColorStop(.3,"rgba(0,0,0,0.3)"),o.addColorStop(1,"rgba(0,0,0,0)")):"logarithmic"===t?(o.addColorStop(0,"rgba(0,0,0,0.6)"),o.addColorStop(.7,"rgba(0,0,0,0.3)"),o.addColorStop(1,"rgba(0,0,0,0)")):(o.addColorStop(0,"rgba(0,0,0,0.5)"),o.addColorStop(1,"rgba(0,0,0,0)")),e.fillStyle=o,e.fillRect(u,p,i,f),e.fillStyle="rgba(255,255,255,0.3)",e.beginPath(),e.moveTo(u+i-6,p),e.lineTo(u+i,p),e.lineTo(u+i,p+6),e.closePath(),e.fill()}}if(r.fadeOutRows&&r.fadeOutRows>0&&!l){const i=Math.min(.4*g,r.fadeOutRows*t.pixelsPerRow);if(i>2){const t=r.fadeOutCurve||"linear",o=e.createLinearGradient(u+g-i,p,u+g,p);"exponential"===t?(o.addColorStop(0,"rgba(0,0,0,0)"),o.addColorStop(.7,"rgba(0,0,0,0.3)"),o.addColorStop(1,"rgba(0,0,0,0.6)")):"logarithmic"===t?(o.addColorStop(0,"rgba(0,0,0,0)"),o.addColorStop(.3,"rgba(0,0,0,0.3)"),o.addColorStop(1,"rgba(0,0,0,0.6)")):(o.addColorStop(0,"rgba(0,0,0,0)"),o.addColorStop(1,"rgba(0,0,0,0.5)")),e.fillStyle=o,e.fillRect(u+g-i,p,i,f),e.fillStyle="rgba(255,255,255,0.3)",e.beginPath(),e.moveTo(u+g-i,p),e.lineTo(u+g-i+6,p),e.lineTo(u+g-i,p+6),e.closePath(),e.fill()}}if(r.muted&&!l){e.fillStyle="rgba(0,0,0,0.3)",e.fillRect(u,p,g,f),e.strokeStyle="rgba(255,255,255,0.1)",e.lineWidth=1;for(let t=-f;t<g;t+=8)e.beginPath(),e.moveTo(u+t,p),e.lineTo(u+t+f,p+f),e.stroke()}if(n&&!l&&g>24){const t=e.createLinearGradient(u,p,u+6,p);t.addColorStop(0,"rgba(255,255,255,0.25)"),t.addColorStop(1,"rgba(255,255,255,0)"),e.fillStyle=t,e.fillRect(u,p,6,f);const r=e.createLinearGradient(u+g-6,p,u+g,p);r.addColorStop(0,"rgba(255,255,255,0)"),r.addColorStop(1,"rgba(255,255,255,0.25)"),e.fillStyle=r,e.fillRect(u+g-6,p,6,f)}e.restore()}drawNoteDensityPreview(e,t,r,i,o,a,s,n){const l=i.channels[r.sourceChannelIndex];if(!l)return;const c=Math.round(s),d=Math.round(n);if(c<10||d<10)return;const h=`${r.patternId}_${r.sourceChannelIndex}_${c}_${d}`;let u=this.previewCache.get(h);if(!u){if(this.previewCache.size>=64){const e=this.previewCache.keys().next().value;e&&this.previewCache.delete(e)}const e=new OffscreenCanvas(c,d),t=e.getContext("2d");if(!t)return;const o=l.rows,a=r.clipLengthRows??i.length-r.offsetRows,s=r.offsetRows;let n=127,p=0;for(let r=s;r<s+a&&r<o.length;r++){const e=o[r]?.note??0;if(e>0&&e<97){const t=e+11;t<n&&(n=t),t>p&&(p=t)}}if(n>p)return u={canvas:e,width:c,height:d},void this.previewCache.set(h,u);n=Math.max(0,n-2),p=Math.min(127,p+2);const g=p-n+1;t.fillStyle="rgba(255,255,255,0.35)";for(let r=s;r<s+a&&r<o.length;r++){const e=o[r]?.note??0;if(e<=0||e>=97)continue;const i=(r-s)/a*c,n=(p-(e+11))/g*d,l=Math.max(1,c/a),h=Math.max(1,d/g);t.fillRect(i,n,l,h)}u={canvas:e,width:c,height:d},this.previewCache.set(h,u)}e.drawImage(u.canvas,o,a,c,d)}roundRect(e,t,r,i,o,a){e.moveTo(t+a,r),e.lineTo(t+i-a,r),e.arcTo(t+i,r,t+i,r+a,a),e.lineTo(t+i,r+o-a),e.arcTo(t+i,r+o,t+i-a,r+o,a),e.lineTo(t+a,r+o),e.arcTo(t,r+o,t,r+o-a,a),e.lineTo(t,r+a),e.arcTo(t,r,t+a,r,a),e.closePath()}invalidateCache(e){if(e){const t=[...this.previewCache.keys()].filter(t=>t.startsWith(e));for(const e of t)this.previewCache.delete(e)}else this.previewCache.clear()}dispose(){this.previewCache.clear()}}const j=36,z={background:"#111114",text:"#aaaabc",beatText:"#666677",tick:"rgba(255,255,255,0.1)",beatTick:"rgba(255,255,255,0.25)",barLine:"rgba(255,255,255,0.45)",markerFlag:"#f59e0b",markerText:"#ffffffcc",loopRegion:"rgba(34,197,94,0.15)"};class D{canvas=null;ctx=null;lastKey="";colors={...z};get height(){return j}cacheKey(e,t,r,i,o,a,s){const n=i.map(e=>`${e.row}_${e.type}_${e.name}_${e.color}`).join(",");return`${e.scrollRow.toFixed(2)}_${e.pixelsPerRow}_${e.width}_${t}_${r}_${n}_${o}_${a}_${s}`}render(e,t,r,i,o,a,s){const n=this.cacheKey(e,t,r,i,o,a,s);if(n===this.lastKey&&this.canvas)return this.canvas;const l=Math.ceil(e.width*s),c=Math.ceil(j*s);if(l<=0)return null;this.canvas&&this.canvas.width===l&&this.canvas.height===c||(this.canvas=new OffscreenCanvas(l,c),this.ctx=this.canvas.getContext("2d"));const d=this.ctx;if(!d)return null;d.setTransform(s,0,0,s,0,0),d.fillStyle=this.colors.background,d.fillRect(0,0,e.width,j),d.fillStyle="rgba(255,255,255,0.15)",d.fillRect(0,35,e.width,1);const h=t,u=t*r,p=e.getVisibleRowRange();if(null!==o&&null!==a&&a>o){const t=e.rowToPixelX(o),r=(a-o)*e.pixelsPerRow;d.fillStyle=this.colors.loopRegion,d.fillRect(t,0,r,j),d.fillStyle="#22c55e",d.fillRect(t-1,0,3,j),d.beginPath(),d.moveTo(t+1,28),d.lineTo(t-5,j),d.lineTo(t+7,j),d.closePath(),d.fill();const i=t+r;d.fillRect(i-1,0,3,j),d.beginPath(),d.moveTo(i+1,28),d.lineTo(i-5,j),d.lineTo(i+7,j),d.closePath(),d.fill()}let g=1;e.pixelsPerRow<1?g=u:e.pixelsPerRow<3&&(g=h);const f=Math.floor(p.startRow/g)*g;for(let w=Math.max(0,f);w<=p.endRow;w+=g){const t=e.rowToPixelX(w);if(t<-50||t>e.width+50)continue;const r=w%h===0;if(w%u===0){const e=Math.floor(w/u)+1;d.fillStyle=this.colors.barLine,d.fillRect(t,14,1,22),d.font="bold 12px Inter, system-ui, sans-serif",d.textBaseline="middle",d.fillStyle=this.colors.text,d.fillText(`${e}`,t+4,10)}else if(r&&e.pixelsPerRow>=2){if(d.fillStyle=this.colors.beatTick,d.fillRect(t,22,1,14),e.pixelsPerRow>=4){const e=Math.floor(w/u)+1,r=Math.floor(w%u/h)+1;d.font="9px Inter, system-ui, sans-serif",d.textBaseline="middle",d.fillStyle=this.colors.beatText,d.fillText(`${e}.${r}`,t+3,18)}}else e.pixelsPerRow>=4&&(d.fillStyle=this.colors.tick,d.fillRect(t,28,1,8))}d.font="9px Inter, system-ui, sans-serif";for(const w of i){if(w.row<p.startRow||w.row>p.endRow)continue;const t=e.rowToPixelX(w.row),r=w.color||this.colors.markerFlag;d.fillStyle=r,d.beginPath(),d.moveTo(t,0),d.lineTo(t+8,4),d.lineTo(t,8),d.fill(),d.fillStyle=this.colors.markerText,d.fillText(w.name,t+10,5),d.fillStyle=`${r}66`,d.fillRect(t,0,1,j)}return this.lastKey=n,this.canvas}invalidate(){this.lastKey=""}}class _{clipRects=[];rebuild(e,t,r,i,o){const a=new Map(r.map(e=>[e.id,e]));this.clipRects=[];for(const s of e){const e=o.getEntryForTrack(s.trackId);if(!e||!e.visible)continue;const t=a.get(s.patternId),r=s.clipLengthRows??(t?t.length-s.offsetRows:64),n=i.rowToPixelX(s.startRow),l=i.trackYToScreenY(e.y),c=r*i.pixelsPerRow,d=e.bodyHeight;this.clipRects.push({clip:s,x:n,y:l,w:c,h:d})}}hitTest(e,t,r,i,o,a,s,n){if(t<o){if(null!=a){const t=r.rowToPixelX(a);if(Math.abs(e-t)<=7)return{type:"loop-start",row:a}}if(null!=s){const t=r.rowToPixelX(s);if(Math.abs(e-t)<=7)return{type:"loop-end",row:s}}return{type:"ruler",row:Math.max(0,Math.round(r.pixelXToRow(e)))}}const l=t-o,c=Math.max(0,Math.round(r.pixelXToRow(e)));if(n&&"point"===n.type&&void 0!==n.pointIndex)return{type:"automation-point",laneId:n.laneId,pointIndex:n.pointIndex};if(n&&"segment"===n.type&&void 0!==n.insertAfterIndex&&void 0!==n.row&&void 0!==n.value)return{type:"automation-segment",laneId:n.laneId,insertAfterIndex:n.insertAfterIndex,row:n.row,value:n.value};let d=null,h="body";for(const g of this.clipRects){const t=g.y;if(e<g.x||e>g.x+g.w)continue;if(l<t||l>t+g.h)continue;const r=e-g.x;let i="body";r<=6&&g.w>18?i="resize-start":r>=g.w-6&&g.w>18&&(i="resize-end"),d=g,h=i}if(d)return{type:"clip",clipId:d.clip.id,zone:h,trackId:d.clip.trackId,row:c};const u=r.screenYToTrackY(l),p=i.hitTestY(u);return p?"resize-handle"===p.zone?{type:"track-resize",trackId:p.trackId}:"automation"===p.zone?{type:"automation",trackId:p.trackId,row:c}:{type:"empty",trackId:p.trackId,trackIndex:p.trackIndex,row:c}:{type:"none"}}findClipsInRect(e,t,r,i){const o=Math.min(e,r),a=Math.max(e,r),s=Math.min(t,i),n=Math.max(t,i),l=[];for(const c of this.clipRects)c.x+c.w<o||c.x>a||c.y+c.h<s||c.y>n||l.push(c.clip.id);return l}getCursor(e,t){if("draw"===t)return"crosshair";if("erase"===t)return"not-allowed";if("split"===t)return"col-resize";if("clip"===e.type)switch(e.zone){case"resize-start":case"resize-end":return"ew-resize";case"body":return"grab"}return"track-resize"===e.type?"ns-resize":"loop-start"===e.type||"loop-end"===e.type?"ew-resize":"ruler"===e.type?"pointer":"automation-point"===e.type?"move":"automation-segment"===e.type?"crosshair":"default"}}class L{_state="idle";_tool="select";_drag=null;_ghostClips=[];_selectionBox=null;_drawPreview=null;_cursor="default";_dirty=!0;get state(){return this._state}get tool(){return this._tool}get drag(){return this._drag}setTool(e){this._tool=e,this._dirty=!0}beginDrag(e,t,r,i,o,a,s,n){this._state=e,this._drag={startX:t,startY:r,currentX:t,currentY:r,startRow:i,startTrackIndex:o,targetClipId:a,selectedAtStart:new Set(s),originalClips:[...n]},this._dirty=!0}updateDrag(e,t){this._drag&&(this._drag.currentX=e,this._drag.currentY=t,this._dirty=!0)}endDrag(){this._state="idle",this._drag=null,this._ghostClips=[],this._selectionBox=null,this._drawPreview=null,this._dirty=!0}setGhostClips(e){this._ghostClips=e,this._dirty=!0}setSelectionBox(e){this._selectionBox=e,this._dirty=!0}setDrawPreview(e){this._drawPreview=e,this._dirty=!0}updateCursor(e){let t;if("idle"!==this._state)switch(this._state){case"moving-clips":t="grabbing";break;case"resizing-clip-start":case"resizing-clip-end":case"moving-loop-start":case"moving-loop-end":t="ew-resize";break;case"drawing-clip":case"select-box":case"adding-automation-point":t="crosshair";break;case"erasing":t="not-allowed";break;case"moving-playhead":t="pointer";break;case"resizing-track-height":t="ns-resize";break;case"moving-automation-point":t="move";break;default:t="default"}else if("draw"===this._tool)t="crosshair";else if("erase"===this._tool)t="not-allowed";else if("split"===this._tool)t="col-resize";else if("clip"===e.type)switch(e.zone){case"resize-start":case"resize-end":t="ew-resize";break;case"body":t="grab";break;default:t="default"}else t="ruler"===e.type?"pointer":"track-resize"===e.type?"ns-resize":"loop-start"===e.type||"loop-end"===e.type?"ew-resize":"automation-point"===e.type?"move":"automation-segment"===e.type?"crosshair":"default";t!==this._cursor&&(this._cursor=t,this._dirty=!0)}getRenderState(){const e={state:this._state,ghostClips:this._ghostClips,selectionBox:this._selectionBox,drawPreview:this._drawPreview,cursor:this._cursor,dirty:this._dirty};return this._dirty=!1,e}getDragDelta(e,t){if(!this._drag)return{deltaRow:0,deltaTrackIndex:0};return{deltaRow:Math.round((this._drag.currentX-this._drag.startX)/e),deltaTrackIndex:Math.round((this._drag.currentY-this._drag.startY)/(t||60))}}markDirty(){this._dirty=!0}}class Y{beforeState=null;description="";committed=!1;begin(e,t){this.beforeState=JSON.parse(JSON.stringify(e)),this.description=t,this.committed=!1}get isActive(){return null!==this.beforeState&&!this.committed}execute(e){this.isActive&&e()}commit(e){this.beforeState&&!this.committed&&(e(this.beforeState),this.committed=!0,this.beforeState=null)}cancel(){this.beforeState=null,this.committed=!1}getBeforeState(){return this.beforeState}getDescription(){return this.description}}const $=40;function N(e,t,r){const i=e.curve||"linear",o=e.tension??.5;switch(i){case"exponential":return e.value+(t.value-e.value)*Math.pow(r,1+3*o);case"logarithmic":return e.value+(t.value-e.value)*(1-Math.pow(1-r,1+3*o));case"s-curve":const i=r*r*(3-2*r);return e.value+(t.value-e.value)*i;default:return e.value+(t.value-e.value)*r}}class E{render(e,t,r,i,o,a){const s=new Map(i.map(e=>[e.trackId,e])),n=t.getVisibleRowRange(),l=new Map;for(const c of r){if(!c.visible||!c.enabled||0===c.points.length)continue;const e=l.get(c.trackId)??[];e.push(c),l.set(c.trackId,e)}for(const[c,d]of l){const r=s.get(c);if(r&&r.visible&&!(r.automationHeight<=0))for(let i=0;i<d.length;i++){const s=d[i],l=t.trackYToScreenY(r.automationY)+i*$,c=$;if(l+c<0||l>t.height)continue;const h=o===s.id;this.drawLane(e,t,s,l,c,n.startRow,n.endRow,h,a??void 0)}}}drawLane(e,t,r,i,o,a,s,n=!1,l){const c=r.points;if(0===c.length)return;e.save(),e.beginPath(),e.rect(0,i,t.width,o),e.clip();const d=[];for(let u=0;u<c.length;u++){const e=c[u];if(e.row>s+10)break;const r=t.rowToPixelX(e.row),a=i+o-e.value*o;if(d.push({x:r,y:a}),u<c.length-1){const r=c[u+1],a=r.row-e.row;if(a*t.pixelsPerRow>4){const s=Math.min(20,Math.floor(a*t.pixelsPerRow/4));for(let n=1;n<s;n++){const l=n/s,c=e.row+a*l,h=N(e,r,l),u=t.rowToPixelX(c),p=i+o-h*o;d.push({x:u,y:p})}}}}if(0===d.length)return void e.restore();e.beginPath(),e.moveTo(d[0].x,i+o);for(const u of d)e.lineTo(u.x,u.y);e.lineTo(d[d.length-1].x,i+o),e.closePath();const h=e.createLinearGradient(0,i,0,i+o);h.addColorStop(0,"rgba(59,130,246,0.2)"),h.addColorStop(1,"rgba(59,130,246,0.02)"),e.fillStyle=h,e.fill(),e.beginPath(),e.moveTo(d[0].x,d[0].y);for(let u=1;u<d.length;u++)e.lineTo(d[u].x,d[u].y);e.strokeStyle="#3b82f6",e.lineWidth=1.5,e.stroke();for(let u=0;u<d.length;u++){const r=d[u];if(r.x<-3||r.x>t.width+3)continue;n&&l===u?(e.fillStyle="#ffffff",e.strokeStyle="#3b82f6",e.lineWidth=2,e.beginPath(),e.arc(r.x,r.y,5,0,2*Math.PI),e.fill(),e.stroke()):(e.fillStyle="#3b82f6",e.beginPath(),e.arc(r.x,r.y,3,0,2*Math.PI),e.fill())}e.restore()}hitTest(e,t,r,i,o){const a=new Map(o.map(e=>[e.trackId,e])),s=new Map;for(const n of i){if(!n.visible||!n.enabled||0===n.points.length)continue;const e=s.get(n.trackId)??[];e.push(n),s.set(n.trackId,e)}for(const[n,l]of s){const i=a.get(n);if(i&&i.visible&&!(i.automationHeight<=0))for(let o=0;o<l.length;o++){const a=l[o],s=r.trackYToScreenY(i.automationY)+o*$,n=$;if(!(t<s||t>s+n)){for(let i=0;i<a.points.length;i++){const o=a.points[i],l=r.rowToPixelX(o.row),c=s+n-o.value*n;if(Math.hypot(e-l,t-c)<=8)return{type:"point",laneId:a.id,pointIndex:i}}for(let i=0;i<a.points.length-1;i++){const o=a.points[i],l=a.points[i+1],c=r.rowToPixelX(o.row),d=s+n-o.value*n,h=r.rowToPixelX(l.row),u=s+n-l.value*n;if(e<Math.min(c,h)||e>Math.max(c,h))continue;const p=Math.hypot(h-c,u-d);if(p<.1)continue;const g=Math.max(0,Math.min(1,((e-c)*(h-c)+(t-d)*(u-d))/(p*p))),f=c+g*(h-c),w=d+g*(u-d);if(Math.hypot(e-f,t-w)<=6){const o=Math.round(r.pixelXToRow(e)),l=Math.max(0,Math.min(1,(s+n-t)/n));return{type:"segment",laneId:a.id,insertAfterIndex:i,row:o,value:l}}}}}}return{type:"none",laneId:""}}getPointScreenPos(e,t,r,i,o){const a=t.trackYToScreenY(i.automationY)+o*$;return{x:t.rowToPixelX(e.row),y:a+40-40*e.value}}}const X=[.5,1,2,4,8,12,16,24,32],A=()=>{s.useEffect(()=>{const t=t=>{const r=e.getState(),i=t.metaKey||t.ctrlKey,a=()=>{t.preventDefault(),t.stopPropagation()};if(!i||"d"!==t.key||t.shiftKey)if(i&&"j"===t.key)r.selectedClipIds.size>1&&(a(),function(e){const t=e.clips.filter(t=>e.selectedClipIds.has(t.id));if(t.length<2)return;const r=Math.min(...t.map(e=>e.startRow)),i=Math.max(...t.map(e=>{const t=e.clipLengthRows??64;return e.startRow+t})),a=t[0].trackId;if(0===o.getState().patterns.length)return;const s=e.addClip({patternId:t[0].patternId,trackId:a,startRow:r,offsetRows:0,clipLengthRows:i-r,sourceChannelIndex:0,color:t[0].color,muted:!1});e.removeClips([...e.selectedClipIds]),e.clearSelection(),e.selectClip(s)}(r));else if(i&&"e"===t.key){if(r.selectedClipIds.size>0){a();const e=r.playbackRow;for(const t of r.selectedClipIds)r.splitClip(t,e)}}else{if(i&&"l"===t.key)return a(),void function(e){const t=e.clips.filter(t=>e.selectedClipIds.has(t.id));if(0===t.length)return void e.clearLoopRegion();const r=Math.min(...t.map(e=>e.startRow)),i=Math.max(...t.map(e=>{const t=e.clipLengthRows??64;return e.startRow+t}));e.setLoopRegion(r,i)}(r);if(i&&"a"===t.key&&!t.shiftKey){a();const e=r.clips.map(e=>e.id);return void r.selectClips(e)}if(i&&t.shiftKey&&"a"===t.key)return a(),void r.clearSelection();if("Delete"!==t.key&&"Backspace"!==t.key||t.metaKey||t.ctrlKey){if("Tab"===t.key)return a(),void r.setTool("draw"===r.tool?"select":"draw");if(t.key>="1"&&t.key<="9"&&!i&&!t.shiftKey){const e=parseInt(t.key)-1;return void(e<X.length&&(a(),r.setPixelsPerRow(X[e])))}if("0"===t.key&&!i)return a(),void r.zoomToFit();if(i&&t.shiftKey&&"m"===t.key)return a(),void function(e){const t=o.getState().patterns;if(0===t.length)return;let r=e.selectedTrackId;!r&&e.tracks.length>0&&(r=e.tracks[0].id);if(!r)return;const i=e.view.snapDivision||1,a=Math.floor(e.playbackRow/i)*i;e.addClip({patternId:t[0].id,trackId:r,startRow:a,offsetRows:0,clipLengthRows:t[0].length,sourceChannelIndex:0,color:null,muted:!1})}(r);if("ArrowLeft"===t.key&&!i){a();const e=r.view.snapDivision||1;return void r.setPlaybackRow(Math.max(0,r.playbackRow-e))}if("ArrowRight"===t.key&&!i){a();const e=r.view.snapDivision||1;return void r.setPlaybackRow(r.playbackRow+e)}}else r.selectedClipIds.size>0&&(a(),r.removeClips([...r.selectedClipIds]))}else if(r.selectedClipIds.size>0){a();const e=r.duplicateClips([...r.selectedClipIds]);r.clearSelection(),r.selectClips(e)}};return window.addEventListener("keydown",t),()=>window.removeEventListener("keydown",t)},[])};const K=36,F=()=>{const i=s.useRef(null),a=s.useRef(null),l=s.useRef(0),c=s.useRef(!0),d=s.useRef(new I),h=s.useRef(new C),u=s.useRef(new P),p=s.useRef(new M),g=s.useRef(new D),f=s.useRef(new _),w=s.useRef(new L),x=s.useRef(new Y),m=s.useRef(new E),b=s.useRef(!1),[v,y]=n.useState(null),[k,R]=n.useState(null),S=s.useRef(null);A();const T=s.useCallback(()=>{c.current=!0},[]);s.useEffect(()=>{let r=e.getState().tool,i=o.getState().patterns;const a=[e.subscribe(e=>{e.tool!==r&&(r=e.tool,w.current.setTool(e.tool)),T()}),t.subscribe(T),o.subscribe(e=>{e.patterns!==i&&(i=e.patterns,p.current.invalidateCache(),T())})];return()=>a.forEach(e=>e())},[T]),s.useEffect(()=>{const e=a.current;if(!e)return;const t=new ResizeObserver(e=>{for(const t of e){const{width:e,height:r}=t.contentRect;d.current.update({width:e,height:r-K}),c.current=!0}});return t.observe(e),()=>t.disconnect()},[]),s.useEffect(()=>{const r=()=>{l.current=requestAnimationFrame(r);const a=i.current;if(!a)return;const s=w.current.getRenderState();if(!c.current&&!s.dirty)return;c.current=!1;const n=a.getContext("2d");if(!n)return;const x=window.devicePixelRatio||1,b=e.getState(),y=t.getState(),R=o.getState().patterns,S=d.current,I=h.current;if(b.view.followPlayback&&b.isArrangementMode&&y.isPlaying){const e=(b.playbackRow-b.view.scrollRow)*b.view.pixelsPerRow,t=a.getBoundingClientRect().width;(e>.8*t||e<0)&&b.setScrollRow(Math.max(0,b.playbackRow-.2*t/b.view.pixelsPerRow))}S.update({scrollRow:b.view.scrollRow,scrollY:b.view.scrollY,pixelsPerRow:b.view.pixelsPerRow}),I.rebuild(b.tracks,b.groups,b.automationLanes),f.current.rebuild(b.clips,b.tracks,R,S,I);const C=a.getBoundingClientRect(),T=C.width,P=C.height;a.width===Math.ceil(T*x)&&a.height===Math.ceil(P*x)||(a.width=Math.ceil(T*x),a.height=Math.ceil(P*x)),n.setTransform(x,0,0,x,0,0),n.clearRect(0,0,T,P);const M=I.getVisibleEntries(b.view.scrollY,P-K),j=y.speed||6,z=y.timeSignature[0]||4,D=b.getTotalRows(),_=g.current.render(S,j,z,b.markers,b.view.loopStart,b.view.loopEnd,x);_&&n.drawImage(_,0,0,T,K),n.save(),n.translate(0,K);const L=u.current.render(S,M,j,z,D,x);if(L&&n.drawImage(L,0,0,T,P-K),null!==b.view.loopStart&&null!==b.view.loopEnd&&b.view.loopEnd>b.view.loopStart){const e=S.rowToPixelX(b.view.loopStart),t=(b.view.loopEnd-b.view.loopStart)*S.pixelsPerRow;n.fillStyle="rgba(34,197,94,0.06)",n.fillRect(e,0,t,P-K)}if(k){const e=I.getEntryForTrack(k);if(e&&e.visible){const t=S.trackYToScreenY(e.y);n.fillStyle="rgba(59, 130, 246, 0.03)",n.fillRect(0,t,T,e.bodyHeight)}}p.current.render(n,S,b.clips,b.tracks,M,R,b.selectedClipIds,s.ghostClips.length>0?s.ghostClips:null,b.playbackRow,y.isPlaying,v);const Y=w.current;let $=null,N=null;if("moving-automation-point"===Y.state&&Y.drag&&($=Y.drag.automationLaneId??null,N=Y.drag.automationPointIndex??null),m.current.render(n,S,b.automationLanes,M,$,N),s.selectionBox){const{x1:e,y1:t,x2:r,y2:i}=s.selectionBox;n.strokeStyle="#3b82f6",n.lineWidth=1,n.setLineDash([4,4]),n.strokeRect(Math.min(e,r),Math.min(t,i)-K,Math.abs(r-e),Math.abs(i-t)),n.setLineDash([]),n.fillStyle="rgba(59,130,246,0.08)",n.fillRect(Math.min(e,r),Math.min(t,i)-K,Math.abs(r-e),Math.abs(i-t))}if(s.drawPreview){const e=I.getEntryForTrack(s.drawPreview.trackId);if(e&&e.visible){const t=S.rowToPixelX(s.drawPreview.startRow),r=(s.drawPreview.endRow-s.drawPreview.startRow)*S.pixelsPerRow,i=S.trackYToScreenY(e.y);n.fillStyle="rgba(59,130,246,0.2)",n.strokeStyle="#3b82f6",n.lineWidth=1,n.fillRect(t,i,r,e.bodyHeight),n.strokeRect(t,i,r,e.bodyHeight)}}if("resizing-track-height"===Y.state&&Y.drag&&Y.drag.trackId&&void 0!==Y.drag.startHeight){const e=I.getEntryForTrack(Y.drag.trackId);if(e){const t=Y.drag.currentY-Y.drag.startY,r=Math.max(30,Math.min(200,Y.drag.startHeight+t)),i=S.trackYToScreenY(e.y+r);n.strokeStyle="#3b82f6",n.lineWidth=2,n.beginPath(),n.moveTo(0,i),n.lineTo(T,i),n.stroke()}}if(("moving-clips"===Y.state||"drawing-clip"===Y.state||"resizing-clip-start"===Y.state||"resizing-clip-end"===Y.state)&&b.view.snapDivision>0){const e=b.view.snapDivision;n.strokeStyle="rgba(59, 130, 246, 0.25)",n.lineWidth=1,n.setLineDash([4,4]);const t=S.getVisibleRowRange();for(let r=Math.floor(t.startRow/e)*e;r<=t.endRow;r+=e){const e=S.rowToPixelX(r);e>=0&&e<=T&&(n.beginPath(),n.moveTo(e,0),n.lineTo(e,P-K),n.stroke())}n.setLineDash([])}if(b.isArrangementMode){const e=S.rowToPixelX(b.playbackRow);e>=-2&&e<=T+2&&(n.fillStyle="rgba(239,68,68,0.15)",n.fillRect(e-3,0,8,P-K),n.fillStyle="#ef4444",n.fillRect(e,0,2,P-K))}if(n.restore(),b.isArrangementMode){const e=S.rowToPixelX(b.playbackRow);e>=-6&&e<=T+6&&(n.fillStyle="#ef4444",n.beginPath(),n.moveTo(e+1,K),n.lineTo(e-5,29),n.lineTo(e+7,29),n.closePath(),n.fill(),n.fillStyle="rgba(239,68,68,0.5)",n.fillRect(e,0,1,K))}a.style.cursor!==s.cursor&&(a.style.cursor=s.cursor)};return l.current=requestAnimationFrame(r),()=>cancelAnimationFrame(l.current)},[]);const j=s.useCallback(e=>{const t=i.current;if(!t)return{x:0,y:0};const r=t.getBoundingClientRect();return{x:e.clientX-r.left,y:e.clientY-r.top}},[]),z=s.useCallback(r=>{const{x:i,y:o}=j(r),a=d.current,s=h.current,n=w.current,l=e.getState(),u=m.current.hitTest(i,o-K,a,l.automationLanes,s.getEntries()),p=f.current.hitTest(i,o,a,s,K,l.view.loopStart,l.view.loopEnd,u);if("ruler"===p.type)return n.beginDrag("moving-playhead",i,o,p.row,0,null,l.selectedClipIds,[]),e.getState().setPlaybackRow(p.row),void t.getState().setCurrentGlobalRow(p.row);if("loop-start"===p.type){const e=l.view.loopEnd;return n.beginDrag("moving-loop-start",i,o,p.row,0,null,l.selectedClipIds,[]),void(n.drag&&(n.drag.loopStart=p.row,n.drag.loopEnd=e??void 0))}if("loop-end"===p.type){const e=l.view.loopStart;return n.beginDrag("moving-loop-end",i,o,p.row,0,null,l.selectedClipIds,[]),void(n.drag&&(n.drag.loopStart=e??void 0,n.drag.loopEnd=p.row))}if("track-resize"===p.type){const e=s.getEntryForTrack(p.trackId);return void(e&&(n.beginDrag("resizing-track-height",i,o,0,0,null,l.selectedClipIds,[]),n.drag&&(n.drag.trackId=p.trackId,n.drag.startHeight=e.bodyHeight)))}if("automation-point"===p.type){S.current={laneId:p.laneId,pointIndex:p.pointIndex};const e=l.automationLanes.find(e=>e.id===p.laneId);if(e&&e.points[p.pointIndex]){const t=e.points[p.pointIndex];n.beginDrag("moving-automation-point",i,o,0,0,null,l.selectedClipIds,[]),n.drag&&(n.drag.automationLaneId=p.laneId,n.drag.automationPointIndex=p.pointIndex,n.drag.automationStartValue=t.value,n.drag.automationStartRow=t.row)}return}if("automation-segment"===p.type){const e={row:p.row,value:p.value,curve:"linear"};l.addAutomationPoint(p.laneId,e);if(l.automationLanes.find(e=>e.id===p.laneId)){const e=p.insertAfterIndex+1;n.beginDrag("moving-automation-point",i,o,0,0,null,l.selectedClipIds,[]),n.drag&&(n.drag.automationLaneId=p.laneId,n.drag.automationPointIndex=e,n.drag.automationStartValue=p.value,n.drag.automationStartRow=p.row)}return}if("select"===n.tool)if("clip"===p.type)if("body"===p.zone){if(r.metaKey||r.ctrlKey)return void l.selectClip(p.clipId,!0);if(r.shiftKey?l.selectClip(p.clipId,!0):l.selectedClipIds.has(p.clipId)||l.selectClip(p.clipId),r.altKey){const t=e.getState().selectedClipIds,r=l.duplicateClips([...t]);l.clearSelection(),l.selectClips(r);const a=l.clips.filter(e=>r.includes(e.id));n.beginDrag("moving-clips",i,o,p.row,0,r[0],new Set(r),a),x.current.begin(l.getSnapshot(),"Duplicate and move clips")}else{const t=e.getState().selectedClipIds,r=l.clips.filter(e=>t.has(e.id));n.beginDrag("moving-clips",i,o,p.row,0,p.clipId,t,r),x.current.begin(l.getSnapshot(),"Move clips")}}else"resize-start"===p.zone?(l.selectClip(p.clipId),n.beginDrag("resizing-clip-start",i,o,p.row,0,p.clipId,l.selectedClipIds,[]),x.current.begin(l.getSnapshot(),"Resize clip start")):"resize-end"===p.zone&&(l.selectClip(p.clipId),n.beginDrag("resizing-clip-end",i,o,p.row,0,p.clipId,l.selectedClipIds,[]),x.current.begin(l.getSnapshot(),"Resize clip end"));else"empty"===p.type&&(r.shiftKey||l.clearSelection(),n.beginDrag("select-box",i,o,p.row,p.trackIndex,null,l.selectedClipIds,[]));else if("draw"===n.tool){if("empty"===p.type){const e=l.view.snapDivision||1,t=a.snapRow(p.row,e);n.beginDrag("drawing-clip",i,o,t,p.trackIndex,null,l.selectedClipIds,[]),n.setDrawPreview({trackId:p.trackId,startRow:t,endRow:t+e})}}else if("erase"===n.tool)"clip"===p.type&&(x.current.begin(l.getSnapshot(),"Erase clip"),l.removeClip(p.clipId),x.current.commit(t=>e.getState().pushUndo(t)));else if("split"===n.tool&&"clip"===p.type){const t=l.view.snapDivision||1,r=a.snapRow(p.row,t);x.current.begin(l.getSnapshot(),"Split clip"),l.splitClip(p.clipId,r),x.current.commit(t=>e.getState().pushUndo(t))}c.current=!0},[j]),$=s.useCallback(r=>{const{x:i,y:o}=j(r),a=d.current,s=h.current,n=w.current;if("idle"!==n.state&&n.drag){n.updateDrag(i,o);const r=e.getState(),l=r.view.snapDivision||1;if("moving-clips"===n.state){const{deltaRow:e,deltaTrackIndex:t}=n.getDragDelta(a.pixelsPerRow,80),i=Math.round(e/l)*l,o=[...r.tracks].sort((e,t)=>e.index-t.index),s=n.drag.originalClips.map(e=>{const a=r.tracks.find(t=>t.id===e.trackId);let s=e.trackId;if(a&&0!==t){const e=Math.max(0,Math.min(o.length-1,a.index+t)),r=o[e];r&&(s=r.id)}return{...e,startRow:Math.max(0,e.startRow+i),trackId:s}});n.setGhostClips(s)}else if("select-box"===n.state){n.setSelectionBox({x1:n.drag.startX,y1:n.drag.startY,x2:i,y2:o});const e=f.current.findClipsInRect(n.drag.startX,n.drag.startY-K,i,o-K);r.selectClips(e)}else if("drawing-clip"===n.state){const e=Math.max(0,a.snapRow(a.pixelXToRow(i),l)),t=n.drag.startRow;n.setDrawPreview({trackId:"",startRow:Math.min(t,e),endRow:Math.max(t+l,e)})}else if("resizing-clip-end"===n.state){const e=Math.max(1,a.snapRow(a.pixelXToRow(i),l));n.drag.targetClipId&&r.resizeClipEnd(n.drag.targetClipId,e)}else if("resizing-clip-start"===n.state){const e=Math.max(0,a.snapRow(a.pixelXToRow(i),l));n.drag.targetClipId&&r.resizeClipStart(n.drag.targetClipId,e)}else if("moving-playhead"===n.state){const e=Math.max(0,Math.round(a.pixelXToRow(i)));r.setPlaybackRow(e),t.getState().setCurrentGlobalRow(e)}else if("moving-automation-point"===n.state&&n.drag&&n.drag.automationLaneId&&void 0!==n.drag.automationPointIndex){const e=Math.max(0,Math.round(a.pixelXToRow(i))),t=r.automationLanes.find(e=>e.id===n.drag.automationLaneId);if(t){const i=s.getEntryForTrack(t.trackId);if(i){const s=r.automationLanes.filter(e=>e.trackId===t.trackId&&e.visible&&e.enabled).findIndex(e=>e.id===t.id);if(s>=0){const t=40,l=a.trackYToScreenY(i.automationY)+s*t,c=t,d=Math.max(0,Math.min(1,(l+c-(o-K))/c));r.moveAutomationPoint(n.drag.automationLaneId,n.drag.automationPointIndex,e,d)}}}}}else{const t=e.getState(),r=m.current.hitTest(i,o-K,a,t.automationLanes,s.getEntries()),l=f.current.hitTest(i,o,a,s,K,t.view.loopStart,t.view.loopEnd,r);n.updateCursor(l),"clip"===l.type&&l.clipId!==v?y(l.clipId):"clip"!==l.type&&null!==v&&y(null);const c=("empty"===l.type||"clip"===l.type||"track-resize"===l.type)&&("track-resize"===l.type||"trackId"in l)?l.trackId:null;c!==k&&R(c)}c.current=!0},[j,v,k]),N=s.useCallback(t=>{const r=w.current,i=e.getState();if("moving-clips"===r.state&&r.drag){const e=i.view.snapDivision||1,{deltaRow:t,deltaTrackIndex:o}=r.getDragDelta(d.current.pixelsPerRow,80),a=Math.round(t/e)*e;0!==a||0!==o?(i.moveClips([...i.selectedClipIds],a,o),x.current.commit(e=>i.pushUndo(e)),b.current=!0,setTimeout(()=>{b.current=!1},100)):x.current.cancel()}else if("drawing-clip"===r.state&&r.drag){const e=d.current,a=i.view.snapDivision||1,s=Math.max(0,e.snapRow(e.pixelXToRow(j(t).x),a)),n=Math.min(r.drag.startRow,s),l=Math.max(r.drag.startRow+a,s),c=e.screenYToTrackY(j(t).y-K),u=h.current.hitTestY(c);if(u){const e=o.getState().patterns;e.length>0&&(x.current.begin(i.getSnapshot(),"Draw clip"),i.addClip({patternId:e[0].id,trackId:u.trackId,startRow:n,offsetRows:0,clipLengthRows:l-n,sourceChannelIndex:0,color:null,muted:!1}),x.current.commit(e=>i.pushUndo(e)))}}else if("resizing-clip-start"===r.state||"resizing-clip-end"===r.state)x.current.commit(e=>i.pushUndo(e));else if("resizing-track-height"===r.state&&r.drag){const{trackId:e,startHeight:t}=r.drag;if(e&&void 0!==t){const o=r.drag.currentY-r.drag.startY,a=Math.max(30,Math.min(200,t+o));i.setTrackHeight(e,a)}}else if("moving-loop-start"===r.state&&r.drag){const{loopEnd:e}=r.drag,t=d.current,o=i.view.snapDivision||1,a=t.snapRow(t.pixelXToRow(r.drag.currentX),o);i.setLoopRegion(a,e??null)}else if("moving-loop-end"===r.state&&r.drag){const{loopStart:e}=r.drag,t=d.current,o=i.view.snapDivision||1,a=t.snapRow(t.pixelXToRow(r.drag.currentX),o);i.setLoopRegion(e??null,a)}else r.state;r.endDrag(),c.current=!0},[j]),X=s.useCallback(t=>{if(b.current)return void(b.current=!1);const{x:r,y:i}=j(t),a=d.current,s=h.current,n=e.getState(),l=f.current.hitTest(r,i,a,s,K,n.view.loopStart,n.view.loopEnd);if("clip"===l.type){const t=e.getState().clips.find(e=>e.id===l.clipId);if(!t)return;require("@stores/useUIStore").useUIStore.getState().setActiveView("tracker");const r=o.getState().patterns.findIndex(e=>e.id===t.patternId);r>=0&&o.getState().setCurrentPattern(r)}},[j]);return s.useEffect(()=>{const e=()=>{const e=w.current;"idle"!==e.state&&(e.endDrag(),c.current=!0)};return window.addEventListener("mouseup",e),()=>window.removeEventListener("mouseup",e)},[]),s.useEffect(()=>{const t=t=>{if("Delete"===t.key||"Backspace"===t.key){const r=S.current;if(r){e.getState().removeAutomationPoint(r.laneId,r.pointIndex),S.current=null,c.current=!0,t.preventDefault()}}},r=i.current;if(r)return r.tabIndex=0,r.addEventListener("keydown",t),()=>r.removeEventListener("keydown",t)},[]),s.useEffect(()=>{const t=i.current;if(!t)return;const r=t=>{t.preventDefault();const r=e.getState();if(t.ctrlKey||t.metaKey){const e=t.deltaY>0?.9:1.1;r.setPixelsPerRow(Math.max(.5,Math.min(32,r.view.pixelsPerRow*e)))}else t.shiftKey?r.setScrollRow(Math.max(0,r.view.scrollRow+t.deltaY/r.view.pixelsPerRow)):r.setScrollY(Math.max(0,r.view.scrollY+t.deltaY));c.current=!0};return t.addEventListener("wheel",r,{passive:!1}),()=>t.removeEventListener("wheel",r)},[]),r.jsx("div",{ref:a,className:"flex-1 relative overflow-hidden",children:r.jsx("canvas",{ref:i,className:"absolute inset-0 w-full h-full",onMouseDown:z,onMouseMove:$,onMouseUp:N,onDoubleClick:X})})},B=["#ef4444","#f97316","#f59e0b","#eab308","#84cc16","#22c55e","#10b981","#14b8a6","#06b6d4","#0ea5e9","#3b82f6","#6366f1","#8b5cf6","#a855f7","#d946ef","#ec4899"],H=({x:t,y:i,clipId:o,trackId:a,row:s,onClose:n})=>{const{removeClips:l,duplicateClips:c,toggleClipMute:d,setClipColor:h,splitClip:u,selectAllClipsOnTrack:p,selectedClipIds:g,pushUndo:f}=e(),w=e=>{f(),e(),n()};return r.jsxs("div",{className:"fixed z-50 bg-dark-bgSecondary border border-dark-border rounded-lg shadow-xl py-1 text-xs min-w-[160px]",style:{left:t,top:i},onMouseDown:e=>e.stopPropagation(),children:[o&&r.jsxs(r.Fragment,{children:[r.jsx(O,{label:"Duplicate",onClick:()=>w(()=>c([...g]))}),r.jsx(O,{label:"Split at Cursor",onClick:()=>w(()=>u(o,s))}),r.jsx(O,{label:"Mute/Unmute",onClick:()=>w(()=>d(o))}),r.jsx(G,{}),r.jsxs("div",{className:"px-2 py-2",children:[r.jsx("div",{className:"text-[10px] text-text-muted mb-1",children:"Clip Color"}),r.jsx("div",{className:"grid grid-cols-8 gap-1",children:B.map(e=>r.jsx("button",{className:"w-6 h-6 rounded border border-dark-border hover:scale-110 transition-transform",style:{backgroundColor:e},onClick:()=>{w(()=>h(o,e))}},e))})]}),r.jsx(G,{}),r.jsx(O,{label:"Delete",onClick:()=>w(()=>l([...g])),danger:!0})]}),a&&!o&&r.jsx(r.Fragment,{children:r.jsx(O,{label:"Select All on Track",onClick:()=>{p(a),n()}})}),!o&&!a&&r.jsx("div",{className:"px-3 py-1 text-text-muted italic",children:"No selection"})]})},O=({label:e,onClick:t,danger:i})=>r.jsx("button",{className:"w-full px-3 py-1.5 text-left hover:bg-dark-bgTertiary "+(i?"text-red-400 hover:text-red-300":"text-text-primary"),onClick:t,children:e}),G=()=>r.jsx("div",{className:"my-1 border-t border-dark-border"}),V=()=>{const{tracks:i,groups:l,view:c,setTool:d,selectedClipIds:h,removeClips:u,duplicateClips:p,clearSelection:g,selectAllClipsOnTrack:f,pushUndo:w,undo:x,redo:m,importFromPatternOrder:b,isArrangementMode:v,setIsArrangementMode:y}=e(),R=t(),I=s.useRef(!1),C=s.useRef(!1);s.useEffect(()=>{if(I.current)return;if(i.length>0)return;const{patternOrder:e,patterns:t}=o.getState();t.length>0&&e.length>0&&(I.current=!0,b(e,t),a.success("Converted pattern order to arrangement"))},[i.length,b]),s.useEffect(()=>{C.current||0===i.length||(C.current=!0,e.getState().zoomToFit())},[i.length]),s.useEffect(()=>{!v&&i.length>0&&(y(!0),a.info("Arrangement mode enabled"))},[v,y,i.length]),s.useEffect(()=>{if(!R.isPlaying||!v)return;const r=requestAnimationFrame(function r(){const i=R.currentGlobalRow;e.getState().setPlaybackRow(i),t.getState().isPlaying&&e.getState().isArrangementMode&&requestAnimationFrame(r)});return()=>cancelAnimationFrame(r)},[R.isPlaying,R.currentGlobalRow,v]);const T=s.useMemo(()=>{const e=i.slice().sort((e,t)=>e.index-t.index),t=[];let r=0;for(let i=0;i<e.length;i++){const o=e[i],a=o.groupId?l.find(e=>e.id===o.groupId):null,s=!a||!a.collapsed,n=s?o.height:0;t.push({trackId:o.id,trackIndex:i,y:r,height:n,bodyHeight:n,automationY:r+n,automationHeight:0,visible:s}),s&&(r+=o.height)}return t},[i,l]),[P,M]=n.useState(null),j=s.useRef(null),z=s.useCallback(t=>{if("INPUT"===t.target?.tagName||"SELECT"===t.target?.tagName)return;const r=t.ctrlKey||t.metaKey;if(!r&&!t.shiftKey)switch(t.key.toLowerCase()){case"v":return d("select"),void t.preventDefault();case"d":return d("draw"),void t.preventDefault();case"e":return d("erase"),void t.preventDefault();case"s":return d("split"),void t.preventDefault()}if(("Delete"===t.key||"Backspace"===t.key)&&h.size>0)return w(),u([...h]),void t.preventDefault();if(r&&"a"===t.key){const r=e.getState().selectedTrackId;if(r)return f(r),void t.preventDefault()}return r&&"d"===t.key&&h.size>0?(w(),p([...h]),void t.preventDefault()):r&&"z"===t.key&&!t.shiftKey?(x(),void t.preventDefault()):r&&"z"===t.key&&t.shiftKey?(m(),void t.preventDefault()):void("Escape"===t.key&&(g(),M(null),t.preventDefault()))},[h,d,u,p,g,f,w,x,m]);s.useEffect(()=>(window.addEventListener("keydown",z),()=>window.removeEventListener("keydown",z)),[z]);const D=s.useCallback(e=>{e.preventDefault(),M({x:e.clientX,y:e.clientY,clipId:1===h.size?[...h][0]:null,trackId:null,row:0})},[h]);return s.useEffect(()=>{if(!P)return;const e=()=>M(null);return window.addEventListener("mousedown",e),()=>window.removeEventListener("mousedown",e)},[P]),r.jsxs("div",{ref:j,className:"flex flex-col h-full bg-dark-bg",onContextMenu:D,children:[r.jsx(k,{}),r.jsxs("div",{className:"flex flex-1 overflow-hidden",children:[r.jsx(S,{tracks:i,groups:l,entries:T,scrollY:c.scrollY}),r.jsx(F,{})]}),P&&r.jsx(H,{x:P.x,y:P.y,clipId:P.clipId,trackId:P.trackId,row:P.row,onClose:()=>M(null)})]})},W=({group:t})=>{const{toggleGroupCollapse:i}=e();return r.jsxs("div",{className:"flex items-center gap-1.5 px-2 py-1 border-b border-dark-border bg-dark-bgTertiary select-none cursor-pointer hover:bg-dark-border/50",onClick:()=>i(t.id),children:[t.collapsed?r.jsx(b,{size:12,className:"text-text-muted"}):r.jsx(v,{size:12,className:"text-text-muted"}),r.jsx("div",{className:"w-2 h-2 rounded-full flex-shrink-0",style:{backgroundColor:t.color||"#888"}}),r.jsx("span",{className:"text-xs font-medium text-text-primary truncate flex-1",children:t.name}),r.jsx("span",{className:"text-[9px] text-text-muted",children:t.collapsed?"...":""})]})};export{F as ArrangementCanvas,H as ArrangementContextMenu,k as ArrangementToolbar,V as ArrangementView,W as TrackGroupHeader,R as TrackHeader,S as TrackHeaderPanel};
