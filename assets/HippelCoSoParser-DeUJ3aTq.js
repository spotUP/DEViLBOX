function t(t,n){return 255&t[n]}function n(t,n){const e=255&t[n];return e<128?e:e-256}function e(t,n){return(255&t[n])<<8|255&t[n+1]}function o(t,n){return 16777216*(255&t[n])+((255&t[n+1])<<16)+((255&t[n+2])<<8)+(255&t[n+3])}const r=[1712,1616,1524,1440,1356,1280,1208,1140,1076,1016,960,906,856,808,762,720,678,640,604,570,538,508,480,453,428,404,381,360,339,320,302,285,269,254,240,226,214,202,190,180,170,160,151,143,135,127,120,113,113,113,113,113,113,113,113,113,113,113,113,113,3424,3232,3048,2880,2712,2560,2416,2280,2152,2032,1920,1812,6848,6464,6096,5760,5424,5120,4832,4560,4304,4064,3840,3624],l=[856,808,762,720,678,640,604,570,538,508,480,453,428,404,381,360,339,320,302,285,269,254,240,226,214,202,190,180,170,160,151,143,135,127,120,113,107,101,95,90,85,80,76,72,68,64,60,57];function i(t,n){const e=t+n,o=Math.max(0,Math.min(83,e)),i=r[o];if(!i||i<=0)return 0;let s=0,a=1/0;for(let r=0;r<l.length;r++){const t=Math.abs(l[r]-i);t<a&&(a=t,s=r)}const h=s+13;return Math.max(1,Math.min(96,h))}function s(t){if(t.byteLength<32)return!1;const n=new Uint8Array(t);return 67===n[0]&&79===n[1]&&83===n[2]&&79===n[3]}function a(t,e,o=256){const r=[];for(let l=0;l<o;l++){const o=e+l;if(o>=t.length)break;const i=n(t,o);if(r.push(i),-31===i)break}return 0===r.length&&r.push(0,-31),r}function h(t,e,o=128){const r=[];for(let l=0;l<o;l++){const o=e+l;if(o>=t.length)break;const i=n(t,o);if(r.push(i),i>=-31&&i<=-25)break}return 0===r.length&&r.push(32,-31),r}async function f(r,l){const s=new Uint8Array(r);if(s.length<32)throw new Error("File too small to be a Jochen Hippel CoSo module");const f=function(t,n,e){let o="";for(let r=0;r<e;r++){const e=t[n+r];if(0===e)break;o+=String.fromCharCode(e)}return o}(s,0,4);if("COSO"!==f)throw new Error(`Not a CoSo file: magic="${f}"`);const p=o(s,4),c=o(s,8),m=o(s,12),g=o(s,16),d=o(s,20),y=o(s,24),C=Math.max(1,Math.floor((y-d)/6)),M=[];for(let t=0;t<C;t++){const n=d+6*t;if(n+6>s.length)break;let o=e(s,n);const r=e(s,n+2),l=e(s,n+4),i=12*(r-o+1);o=12*o+g,i>12&&M.push({pointer:o,length:i,speed:l})}0===M.length&&M.push({pointer:g,length:12,speed:6});const b=M[0],S=Math.min(32,Math.floor((m-c)/2)),v=[];for(let o=0;o<S;o++){const r=c+2*o;if(r+2>s.length)break;const l=e(s,r);if(0===l||l>=s.length)break;if(l+5>=s.length)break;const i=t(s,l),f=n(s,l+1),u=n(s,l+2),m=Math.abs(n(s,l+3)),g=t(s,l+4),d=h(s,l+5);let y=[0,-31];if(-128!==f){const t=p+2*f;if(t+2<=s.length){const n=e(s,t);n>0&&n<s.length&&(y=a(s,n))}}const C={fseq:y,vseq:d,volSpeed:Math.max(1,i),vibSpeed:u,vibDepth:m,vibDelay:g};v.push({id:o+1,name:`CoSo ${o+1}`,type:"synth",synthType:"HippelCoSoSynth",hippelCoso:C,effects:[],volume:-6,pan:0})}0===v.length&&v.push({id:1,name:"CoSo 1",type:"synth",synthType:"HippelCoSoSynth",hippelCoso:{fseq:[0,-31],vseq:[32,-31],volSpeed:1,vibSpeed:0,vibDepth:0,vibDelay:0},effects:[],volume:-6,pan:0});const k=[],w=Math.floor(b.length/12);for(let o=0;o<w;o++){const r=b.pointer+12*o,a=[[],[],[],[]];for(let o=0;o<4;o++){const l=r+3*o;if(l+3>s.length){for(let t=0;t<16;t++)a[o].push(u());continue}const h=t(s,l),f=n(s,l+1),p=m+2*h;let c=0;p+2<=s.length&&(c=e(s,p));const g=[];let d=c;for(;g.length<16&&d<s.length;){const t=n(s,d);if(-1===t)break;if(-2===t||-3===t)d+=2,g.push(u());else if(t>=0){const e=t;d++;let o=0;d<s.length&&(o=n(s,d),d++),224&o&&d<s.length&&d++;const r=(31&o)+1,l=i(e,f);g.push({note:l,instrument:r<=v.length?r:0,volume:0,effTyp:0,eff:0,effTyp2:0,eff2:0})}else d++,g.push(u())}for(;g.length<16;)g.push(u());a[o]=g}k.push({id:`pattern-${o}`,name:`Pattern ${o}`,length:16,channels:a.map((t,n)=>({id:`channel-${n}`,name:`Channel ${n+1}`,muted:!1,solo:!1,collapsed:!1,volume:100,pan:0===n||3===n?-50:50,instrumentId:null,color:null,rows:t})),importMetadata:{sourceFormat:"MOD",sourceFile:l,importedAt:(new Date).toISOString(),originalChannelCount:4,originalPatternCount:w,originalInstrumentCount:v.length}})}0===k.length&&k.push(function(t,n){return{id:"pattern-0",name:"Pattern 0",length:16,channels:Array.from({length:4},(t,n)=>({id:`channel-${n}`,name:`Channel ${n+1}`,muted:!1,solo:!1,collapsed:!1,volume:100,pan:0===n||3===n?-50:50,instrumentId:null,color:null,rows:Array.from({length:16},()=>({note:0,instrument:0,volume:0,effTyp:0,eff:0,effTyp2:0,eff2:0}))})),importMetadata:{sourceFormat:"MOD",sourceFile:t,importedAt:(new Date).toISOString(),originalChannelCount:4,originalPatternCount:0,originalInstrumentCount:n}}}(l,v.length));const $=l.replace(/\.[^/.]+$/,""),D=Math.round(b.speed>0?2500/b.speed:125);return{name:`${$} [Hippel CoSo]`,format:"MOD",patterns:k,instruments:v,songPositions:k.map((t,n)=>n),songLength:k.length,restartPosition:0,numChannels:4,initialSpeed:6,initialBPM:Math.max(32,Math.min(255,D)),linearPeriods:!1}}function u(){return{note:0,instrument:0,volume:0,effTyp:0,eff:0,effTyp2:0,eff2:0}}export{s as isHippelCoSoFormat,f as parseHippelCoSoFile};
