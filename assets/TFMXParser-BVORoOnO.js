function n(n,t){return t+1>=n.length?0:n[t]<<8|n[t+1]}function t(n){return Math.max(1,Math.min(96,13+(127&n)))}function e(e,r,o=0){const a=new Uint8Array(e),l=function(n){const t=Math.min(512,n.length-10);for(let e=0;e<t;e++){const t=n[e];if(84===t||116===t){if(84===n[e+0]&&70===n[e+1]&&77===n[e+2]&&88===n[e+3]&&45===n[e+4]&&83===n[e+5]&&79===n[e+6]&&78===n[e+7]&&71===n[e+8]&&32===n[e+9])return e;if(84===n[e+0]&&70===n[e+1]&&77===n[e+2]&&88===n[e+3]&&95===n[e+4]&&83===n[e+5]&&79===n[e+6]&&78===n[e+7]&&71===n[e+8])return e;if(116===n[e+0]&&102===n[e+1]&&109===n[e+2]&&120===n[e+3]&&115===n[e+4]&&111===n[e+5]&&110===n[e+6]&&103===n[e+7])return e;if(84===n[e+0]&&70===n[e+1]&&77===n[e+2]&&88===n[e+3]&&32===n[e+4]&&71!==n[e+8]&&(83!==n[e+5]||79!==n[e+6]||78!==n[e+7]))return e}}return-1}(a);if(l<0)throw new Error("[TFMXParser] Not a TFMX file (no magic found)");if(a.length<512)throw new Error("[TFMXParser] File too small to be a valid TFMX module");const i=[],s=[],u=[];for(let t=0;t<32;t++)i.push(n(a,l+256+2*t)),s.push(n(a,l+320+2*t)),u.push(n(a,l+384+2*t));let f=function(n,t){return t+3>=n.length?0:(n[t]<<24|n[t+1]<<16|n[t+2]<<8|n[t+3])>>>0}(a,l+464);0===f&&(f=l+1536);const h=Math.max(0,Math.min(31,o));let m=i[h],c=s[h];const p=u[h];(m>c||m>16383||c>16383)&&(m=0,c=0);const g=[];for(let n=m;n<=c;n++){const e=f+16*n;if(e+16>a.length)break;const o=[];let l=!1;for(let n=0;n<4;n++){const t=a[e+2*n];if(a[e+2*n+1],255===t){l=!0;break}o.push(128===t?-1:t)}if(l)break;const i=Array.from({length:4},()=>[]);for(let n=0;n<32;n++)for(let e=0;e<4;e++){const r=o[e]??0,a=0===n&&r>=0?t(r):0;i[e].push({note:a,instrument:0,volume:0,effTyp:0,eff:0,effTyp2:0,eff2:0})}g.push({id:`pattern-${g.length}`,name:`Pattern ${g.length+1}`,length:32,channels:i.map((n,t)=>({id:`channel-${t}`,name:`Channel ${t+1}`,muted:!1,solo:!1,collapsed:!1,volume:100,pan:0===t||3===t?-50:50,instrumentId:null,color:null,rows:n})),importMetadata:{sourceFormat:"TFMX",sourceFile:r,importedAt:(new Date).toISOString(),originalChannelCount:4,originalPatternCount:c-m+1,originalInstrumentCount:0}})}if(0===g.length){const n=Array.from({length:32},()=>({note:0,instrument:0,volume:0,effTyp:0,eff:0,effTyp2:0,eff2:0}));g.push({id:"pattern-0",name:"Pattern 0",length:32,channels:Array.from({length:4},(t,e)=>({id:`channel-${e}`,name:`Channel ${e+1}`,muted:!1,solo:!1,collapsed:!1,volume:100,pan:0===e||3===e?-50:50,instrumentId:null,color:null,rows:n})),importMetadata:{sourceFormat:"TFMX",sourceFile:r,importedAt:(new Date).toISOString(),originalChannelCount:4,originalPatternCount:0,originalInstrumentCount:0}})}let d=125,M=6;p>15?d=p:p>0&&(d=Math.round(50/(p+1)*2.5),M=p+1);return{name:r.replace(/\.[^/.]+$/,""),format:"TFMX",patterns:g,instruments:[],songPositions:g.map((n,t)=>t),songLength:g.length,restartPosition:0,numChannels:4,initialSpeed:M,initialBPM:d,linearPeriods:!1}}export{e as parseTFMXFile};
