import{aB as t}from"./index-zx6LJBPK.js";import"./vendor-react-DkDaD07v.js";import"./vendor-utils-XMmR-oGw.js";import"./vendor-tone-CADp_hfL.js";import"./vendor-ui-uomqNFY-.js";function n(t,n){return t.getUint8(n)}function e(t,n){return t.getInt8(n)}function o(t,n){return t.getUint16(n,!0)}function r(t,n){return t.getUint32(n,!0)}function f(t,n,e){let o=n;for(;o<n+e&&0!==t[o];)o++;return String.fromCharCode(...Array.from(t.subarray(n,o))).trim()}function i(t){if(t.byteLength<66)return!1;const n=new Uint8Array(t);return 77===n[0]&&84===n[1]&&77===n[2]&&(!(n[3]>=32)&&(!(n[27]>127)&&(!(n[32]>64)&&!(0===n[33]||n[33]>32))))}function s(t,n){if(0===t&&0===n)return{effTyp:0,eff:0};let e=n;if(10===t)e&=240&e?240:15;else{if(8===t)return{effTyp:0,eff:0};if(14===t){const t=240&e;if(0===t||48===t||64===t||96===t||112===t||240===t)return{effTyp:0,eff:0}}}return{effTyp:t,eff:e}}function a(t){return 0===t?0:Math.min(t,96)}async function l(i,l){const u=new DataView(i),p=new Uint8Array(i),m=f(p,4,20),c=o(u,24),h=n(u,26),y=n(u,27),g=o(u,28),d=n(u,30),M=n(u,32),T=n(u,33),v=Array.from(p.subarray(34,66)),w=M>0?M:64,L=h+1,C=y+1,S=66+37*d,b=S+128,A=b+192*c,U=A+32*L*2+g,P=[];for(let t=0;t<d;t++){const o=66+37*t,i=f(p,o,22),s=r(u,o+22),a=r(u,o+26),l=r(u,o+30),m=e(u,o+34),c=n(u,o+35),h=!!(1&n(u,o+36));let y=s,g=a,d=Math.min(Math.max(l,1)-1,s);h&&(y=Math.floor(y/2),g=Math.floor(g/2),d=Math.floor(d/2));let M=!1;y>2?(g+4>=d&&(g=0,d=0),M=d>2):y=0,P.push({name:i,rawLength:s,length:y,loopStart:g,loopEnd:d,finetune:m,volume:Math.min(c,64),is16bit:h,hasLoop:M})}const $=[];for(let t=0;t<C;t++)$.push(n(u,S+t));const j=[];for(let t=0;t<c;t++){const e=b+192*t,o=[];for(let t=0;t<w;t++){const r=e+3*t,f=n(u,r),i=n(u,r+1),l=n(u,r+2),p=252&f?a(f>>2):0,m=(3&f)<<4|i>>4,c=15&i,{effTyp:h,eff:y}=s(c,l);o.push({note:p,instr:m,effTyp:h,eff:y})}j.push(o)}const I=[];for(let t=0;t<L;t++){const n=A+32*t*2,e=[];for(let t=0;t<32;t++)e.push(o(u,n+2*t));const r=[];for(let t=0;t<T;t++){const n=e[t],o=[];for(let t=0;t<w;t++)if(0===n||n>c||n>j.length)o.push({note:0,instrument:0,volume:0,effTyp:0,eff:0,effTyp2:0,eff2:0});else{const e=j[n-1][t];o.push({note:e.note,instrument:e.instr,volume:0,effTyp:e.effTyp,eff:e.eff,effTyp2:0,eff2:0})}const f=15&v[t],i=Math.round(50*(f/15*2-1));r.push({id:`channel-${t}`,name:`Channel ${t+1}`,muted:!1,solo:!1,collapsed:!1,volume:100,pan:i,instrumentId:null,color:null,rows:o})}I.push({id:`pattern-${t}`,name:`Pattern ${t}`,length:w,channels:r,importMetadata:{sourceFormat:"MTM",sourceFile:l,importedAt:(new Date).toISOString(),originalChannelCount:T,originalPatternCount:L,originalInstrumentCount:d}})}const x=$.map(t=>Math.min(t,L-1));let D=U;const B=P.map((n,e)=>{const r=e+1,f=n.name||`Sample ${r}`,s=n.rawLength,a=D;if(D+=s,0===n.length||0===s||a+s>i.byteLength)return{id:r,name:f,type:"sample",synthType:"Sampler",effects:[],volume:-60,pan:0};const l=n.hasLoop?n.loopStart:0,m=n.hasLoop?n.loopEnd:0;if(n.is16bit){const e=n.length,s=new Uint8Array(e);for(let t=0;t<e&&a+2*t+1<i.byteLength;t++){const n=o(u,a+2*t);s[t]=255&(n>>8^128)}return t(r,f,s,n.volume,8363,l,m)}{const e=new Uint8Array(s);for(let t=0;t<s;t++)e[t]=128^p[a+t];return t(r,f,e,n.volume,8363,l,m)}});return{name:m||l.replace(/\.[^/.]+$/,""),format:"MOD",patterns:I,instruments:B,songPositions:x,songLength:x.length,restartPosition:0,numChannels:T,initialSpeed:6,initialBPM:125,linearPeriods:!1}}export{i as isMTMFormat,l as parseMTMFile};
