import{aB as t}from"./index-zx6LJBPK.js";import"./vendor-react-DkDaD07v.js";import"./vendor-utils-XMmR-oGw.js";import"./vendor-tone-CADp_hfL.js";import"./vendor-ui-uomqNFY-.js";function n(t,n){return t.getUint8(n)}function e(t,n){return t.getUint16(n,!0)}function o(t,n){return t.getUint32(n,!0)}function r(t,n,e){let o="";for(let r=0;r<e;r++){const e=t.getUint8(n+r);if(0===e)break;o+=String.fromCharCode(e)}return o.replace(/\s+$/,"")}const s=64,i=[0,1,2,3,10,7,4,14,14,15,15,11,11,9,14,27,14,14,14,21,6,5,9];function a(t){const n=17*Math.min(t,15);return Math.round(50*(n-128)/128)}function l(t){if(t.byteLength<96)return!1;const e=new DataView(t);if(80!==n(e,0))return!1;if(76!==n(e,1))return!1;if(77!==n(e,2))return!1;if(26!==n(e,3))return!1;const o=n(e,4),r=n(e,5),s=n(e,54);return 16===r&&(!(s<1)&&(!(s>32)&&!(o<96)))}function f(t,n){if(t>=i.length)return[0,0];const e=i[t];let o=n;switch(t){case 7:o=64|3&n;break;case 8:o=48|3&n;break;case 14:o=128|15&n;break;case 16:o=208|Math.min(n,15);break;case 17:o=192|Math.min(n,15);break;case 18:o=224|Math.min(n,15);break;case 4:case 20:case 21:240&n&&15&n&&240&~n&&(o=15|n)}return[e,o]}async function c(i,c){if(!l(i))throw new Error("PLMParser: file does not pass PLM format validation");const h=new DataView(i),g=new Uint8Array(i),y=n(h,4),d=r(h,6,48)||c.replace(/\.[^/.]+$/,""),M=n(h,54),P=n(h,58),b=n(h,59),v=[];for(let t=0;t<32;t++)v.push(n(h,60+t));const w=n(h,92),S=n(h,93),B=e(h,94);let L=y;const k=[];for(let t=0;t<B;t++)k.push({x:e(h,L),y:n(h,L+2),pattern:n(h,L+3)}),L+=4;const C=[];for(let t=0;t<S;t++)C.push(o(h,L)),L+=4;const O=[];for(let t=0;t<w;t++)O.push(o(h,L)),L+=4;const $=[];for(let t=0;t<w;t++){const s=O[t];if(0===s||s+71>i.byteLength||80!==n(h,s+0)||76!==n(h,s+1)||83!==n(h,s+2)||26!==n(h,s+3)){$.push(p(t));continue}const a=n(h,s+4),l=r(h,s+6,32)||`Sample ${t+1}`,f=n(h,s+50),c=Math.min(n(h,s+51),64),u=n(h,s+52),m=e(h,s+53),g=o(h,s+59),y=o(h,s+63),d=o(h,s+67),M=!!(1&u),P=!!(2&u),b=M?2:1,v=Math.floor(g/b),w=Math.floor(y/b),S=Math.floor(d/b);$.push({name:l,panning:f<=15?17*f:null,volume:c,is16Bit:M,isPingPong:P,sampleRate:m||8363,loopStart:v,loopEnd:w,length:S,pcmOffset:s+a,pcmBytes:d})}const T=new Map;let U=0;for(const t of k){if(t.pattern>=S)continue;if(t.y>=M)continue;const e=C[t.pattern];if(0===e||e+32>i.byteLength)continue;const o=n(h,e+4),r=n(h,e+5);if(0===o)continue;const a=Math.min(r,M-t.y);let l=t.x,c=e+32;for(let p=0;p<o;p++,l++){const e=Math.floor(l/s),o=l%s;if(!T.has(e)){const t=[];for(let n=0;n<M;n++){const n=[];for(let t=0;t<s;t++)n.push(u());t.push(n)}T.set(e,t)}const p=T.get(e);for(let s=0;s<r&&!(c+5>i.byteLength);s++,c+=5){const e=n(h,c),r=n(h,c+1),i=n(h,c+2),l=n(h,c+3),u=n(h,c+4);if(s>=a)continue;const m=t.y+s;if(m>=M)continue;let g=0;e>0&&e<144&&(g=12*(e>>4)+(15&e)+12+1);const y=255!==i?16+Math.min(i,64):0,[d,P]=f(l,u);p[m][o]={note:g,instrument:r,volume:y,effTyp:d,eff:P,effTyp2:0,eff2:0}}U=Math.max(U,l)}}const j=Array.from(T.keys()).sort((t,n)=>t-n),x=j.length>0?j[j.length-1]:0,E=[],A=[];for(let t=0;t<=x;t++){E.push(t);const n=T.get(t);let e=s;if(t===Math.floor(U/s)){const t=U%s+1;t<s&&(e=t)}const o=[];for(let t=0;t<M;t++){const r=[];for(let o=0;o<e;o++)r.push(n?.[t]?.[o]??u());o.push({id:`channel-${t}`,name:`Channel ${t+1}`,muted:!1,solo:!1,collapsed:!1,volume:100,pan:a(v[t]??7),instrumentId:null,color:null,rows:r})}A.push({id:`pattern-${t}`,name:`Pattern ${t}`,length:e,channels:o,importMetadata:{sourceFormat:"PLM",sourceFile:c,importedAt:(new Date).toISOString(),originalChannelCount:M,originalPatternCount:S,originalInstrumentCount:w}})}const D=[];for(let n=0;n<w;n++){const e=$[n],o=n+1;if(0===e.length||0===e.pcmOffset||e.pcmOffset+e.pcmBytes>i.byteLength){D.push(m(o,e.name));continue}const r=g.slice(e.pcmOffset,e.pcmOffset+e.pcmBytes),s=new Uint8Array(e.length);if(e.is16Bit)for(let t=0;t<e.length;t++){const n=r[2*t+1]??128;s[t]=128^n}else for(let t=0;t<e.length;t++)s[t]=128^r[t];const a=e.loopEnd>e.loopStart,l=a?e.loopStart:0,f=a?Math.min(e.loopEnd,e.length):0,c=t(o,e.name,s,e.volume,e.sampleRate,l,f);a&&e.isPingPong&&c.sample&&(c.sample.loopType="pingpong"),D.push(c)}return{name:d,format:"MOD",patterns:A,instruments:D,songPositions:E,songLength:E.length,restartPosition:0,numChannels:M,initialSpeed:b||6,initialBPM:P||125,linearPeriods:!1}}function u(){return{note:0,instrument:0,volume:0,effTyp:0,eff:0,effTyp2:0,eff2:0}}function p(t){return{name:`Sample ${t+1}`,panning:null,volume:64,is16Bit:!1,isPingPong:!1,sampleRate:8363,loopStart:0,loopEnd:0,length:0,pcmOffset:0,pcmBytes:0}}function m(t,n){return{id:t,name:n,type:"sample",synthType:"Sampler",effects:[],volume:-60,pan:0}}export{l as isPLMFormat,c as parsePLMFile};
