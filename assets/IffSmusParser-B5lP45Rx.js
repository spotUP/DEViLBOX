import{aB as n}from"./index-zx6LJBPK.js";import"./vendor-react-DkDaD07v.js";import"./vendor-utils-XMmR-oGw.js";import"./vendor-tone-CADp_hfL.js";import"./vendor-ui-uomqNFY-.js";function t(n,t){return String.fromCharCode(n[t],n[t+1],n[t+2],n[t+3])}function e(n,t,e){let r="";for(let a=0;a<e;a++){const e=n[t+a];if(0===e)break;r+=String.fromCharCode(e)}return r.trim()}function r(n,t){return n[t]}function a(n,t){return n[t]<<8|n[t+1]}const o=[32,16,8,4,2,-1,-1,-1,48,24,12,6,3,-1,-1,-1],s=[64131,62757,61412,60096,58809,57548,56315,55108,53928,52772,51641,50535,49452,48392,47355,46340,45347,44376,43425,42494,41584,40693,39821,38967,38132,37315,36516,35733,34968,34218,33485,32768,32065,31378,30706,30048,29404,28774,28157,27554,26964,26386,25820,25267,24726,24196,23677,23170,22673,22188,21712,21247,20792,20346,19910,19483,19066,18657,18258,17866,17484,17109,16742,16384,16032,15689,15353,15024,14702,14387,14078,13777,13482,13193,12910,12633,12363,12098,11838,11585,11336,11094,10856,10623,10396,10173,9955,9741,9533,9328,9129,8933,8742,8554,8371,8192,8016,7844,7676,7512,7351,7193,7039,6888,6741,6596,6455,6316,6181,6049,5919,5792,5668,5547,5428,5311,5198,5086,4977,4870,4766,4664,4564,4466,4371,4277,4185,4096];function i(n){return Math.max(1,Math.min(96,n-11))}function l(n){if(n.byteLength<12)return!1;const e=new Uint8Array(n);if("FORM"!==t(e,0))return!1;const r=t(e,8);return"SMUS"===r||"TINY"===r}async function c(l,c){const m=new Uint8Array(l);if(m.length<12){throw new Error("File too small to be an IFF SMUS module")}if("FORM"!==t(m,0)){throw new Error("Not an IFF FORM file")}const h=t(m,8);if("SMUS"!==h&&"TINY"!==h)throw new Error(`Not an IFF SMUS file: FORM type is ${h}`);let p=12;const M=m.length;let d="",k="";const S={globalVolume:255,tempoIndex:0,transpose:0,tune:128,timeSigNumerator:4,timeSigDenominator:4,trackVolumes:[],tracksEnabled:[],tracks:[],instrumentMapper:new Array(256).fill(0),numChannels:0},g=[];let b=0;for(;p+8<=M;){const n=t(m,p);p+=4;const i=(m[p]<<24|m[p+1]<<16|m[p+2]<<8|m[p+3])>>>0;p+=4;const l=p;switch(n){case"NAME":l+i<=M&&(d=e(m,l,i));break;case"AUTH":l+i<=M&&(k=e(m,l,i));break;case"SHDR":{if(l+4>M)break;const n=a(m,l);if(n>=3601){const t=Math.floor(235929600/n);let e=0;for(;e<128&&!(t>=s[e]);e++);S.tempoIndex=Math.min(e,127)}else S.tempoIndex=0;let t=r(m,l+2);t<128&&(t*=2),S.globalVolume=t,S.numChannels=r(m,l+3),S.trackVolumes=new Array(S.numChannels).fill(255),S.tracksEnabled=new Array(S.numChannels).fill(1),S.tracks=new Array(S.numChannels).fill(null);break}case"INS1":{if(l+4>M)break;const n=r(m,l);if(0!==r(m,l+1))break;if(0!==S.instrumentMapper[n])break;const t=i-4;if(t<=0||l+4+t>M)break;const a=e(m,l+4,t);if(!a)break;g.push({name:a}),S.instrumentMapper[n]=g.length;break}case"TRAK":{if(0===S.numChannels)break;if(b>=S.numChannels)break;const n=Math.floor(i/2),t=[];for(let e=0;e<n;e++){const n=l+2*e;if(n+2>M)break;const a=r(m,n);let s=r(m,n+1);if(255===a)break;if(a<=127||128===a){s&=15;const n=o[s];if(n<0)continue;s=n}else if(129!==a){if(130===a){S.timeSigNumerator=1+(s>>3&31),S.timeSigDenominator=1<<(7&s);continue}if(132===a){b<S.trackVolumes.length&&(S.trackVolumes[b]=2*(127&s));continue}continue}t.push({type:a,data:s})}t.push({type:255,data:255}),S.tracks[b]={events:t},b++;break}case"SNX1":case"SNX2":case"SNX3":case"SNX4":case"SNX5":case"SNX6":case"SNX7":case"SNX8":case"SNX9":if(0===S.numChannels)break;if(l+8+4*S.numChannels>M)break;S.transpose=a(m,l),S.tune=a(m,l+2);for(let n=0;n<S.numChannels;n++){const t=l+8+4*n;S.tracksEnabled[n]=(m[t]<<24|m[t+1]<<16|m[t+2]<<8|m[t+3])>>>0}}let c=i;1&c&&c++,p=l+c}const y=Math.max(1,S.numChannels),{speed:C,bpm:N}=function(n){const t=Math.max(0,Math.min(127,n)),e=s[t],r=Math.max(1,e>>12&15);return{speed:r,bpm:Math.max(32,Math.min(255,Math.round(900/r)))}}(S.tempoIndex),w=[];for(let t=0;t<g.length;t++){const e=g[t],r=t+1,a=new Uint8Array(2);w.push(n(r,e.name||`Instrument ${r}`,a,64,8287,0,0))}const x=[];for(let n=0;n<y;n++){const t=n<S.tracks.length?S.tracks[n]:null,e=[];if(!t){x.push(e);continue}let r=0;for(const a of t.events){if(255===a.type)break;if(a.type<=127){const t=Math.round(S.transpose/16)-8,o=i(a.type+t);let s=0;if(0!==r){const n=S.instrumentMapper[r];0!==n&&(s=n)}const l=n<S.trackVolumes.length?S.trackVolumes[n]:255,c=255===l?0:16+Math.min(64,Math.round(l/254*64)),f=Math.max(1,a.data);e.push({note:o,instrument:s,volume:c,effTyp:0,eff:0,effTyp2:0,eff2:0});for(let n=1;n<f;n++)e.push(u())}else if(128===a.type){const n=Math.max(1,a.data);for(let t=0;t<n;t++)e.push(u())}else 129===a.type&&(r=a.data)}x.push(e)}let I=0;for(const n of x)n.length>I&&(I=n.length);0===I&&(I=64);for(const n of x)for(;n.length<I;)n.push(u());const F=Math.max(1,Math.ceil(I/64)),A=[];for(let n=0;n<F;n++){const t=64*n,e=Math.min(t+64,I),r=e-t,a=x.map((n,r)=>({id:`channel-${r}`,name:`Channel ${r+1}`,muted:!1,solo:!1,collapsed:!1,volume:100,pan:f(r),instrumentId:null,color:null,rows:n.slice(t,e)}));A.push({id:`pattern-${n}`,name:`Pattern ${n+1}`,length:r,channels:a,importMetadata:{sourceFormat:"MOD",sourceFile:c,importedAt:(new Date).toISOString(),originalChannelCount:y,originalPatternCount:F,originalInstrumentCount:g.length}})}const $=c.replace(/\.[^/.]+$/,"");return{name:`${d?k?`${d} (${k})`:d:$} [SMUS]`,format:"MOD",patterns:A,instruments:w,songPositions:A.map((n,t)=>t),songLength:A.length,restartPosition:0,numChannels:y,initialSpeed:C,initialBPM:N,linearPeriods:!1}}function u(){return{note:0,instrument:0,volume:0,effTyp:0,eff:0,effTyp2:0,eff2:0}}function f(n){return[-50,50,50,-50][n%4]}export{l as isIffSmusFormat,c as parseIffSmusFile};
