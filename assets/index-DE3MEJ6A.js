import{r as e,t,w as r,bN as o,j as n,cu as i,s,v as a}from"./index-zx6LJBPK.js";import{r as l,R as c}from"./vendor-utils-XMmR-oGw.js";import{start as d}from"./vendor-tone-CADp_hfL.js";import{P as m,a8 as u,at as p,au as g,$ as f,ax as h,l as b,J as x,ay as v,az as w,aA as y,aB as N,c as k,f as C}from"./vendor-ui-uomqNFY-.js";import{u as D}from"./ArrangementKeyboardShortcuts-DvPf7hcZ.js";import"./vendor-react-DkDaD07v.js";const E=[{label:"Row",value:1},{label:"Beat",value:6},{label:"1/2 Bar",value:12},{label:"Bar",value:24},{label:"2 Bars",value:48},{label:"4 Bars",value:96},{label:"Off",value:0}],R=()=>{const{tool:o,setTool:s,view:a,setPixelsPerRow:l,setSnapDivision:c,setFollowPlayback:k,zoomToFit:C,addTrack:D}=e(),R=r(e=>e.isPlaying),T=r(e=>e.togglePlayPause),S=r(e=>e.stop),V=(e,t,r,i)=>n.jsxDEV("button",{className:"p-1.5 rounded text-xs transition-colors "+(o===e?"bg-accent-primary text-white":"bg-dark-bgTertiary text-text-secondary hover:bg-dark-border hover:text-text-primary"),onClick:()=>s(e),title:`${r} (${i})`,children:t},void 0,!1,{fileName:"/Users/spot/Code/DEViLBOX/src/components/arrangement/ArrangementToolbar.tsx",lineNumber:52,columnNumber:5},void 0);return n.jsxDEV("div",{className:"flex items-center gap-2 px-3 py-1.5 bg-dark-bgSecondary border-b border-dark-border text-xs select-none",children:[n.jsxDEV("select",{value:"arrangement",onChange:e=>{const r=e.target.value;"arrangement"!==r&&t.getState().setActiveView(r)},className:"px-2 py-0.5 text-[10px] font-bold tracking-widest uppercase bg-dark-bgTertiary text-text-muted border border-dark-border rounded hover:bg-dark-bgHover transition-colors cursor-pointer",title:"Switch view",children:[n.jsxDEV("option",{value:"tracker",children:"Tracker"},void 0,!1,{fileName:"/Users/spot/Code/DEViLBOX/src/components/arrangement/ArrangementToolbar.tsx",lineNumber:79,columnNumber:9},void 0),n.jsxDEV("option",{value:"grid",children:"Grid"},void 0,!1,{fileName:"/Users/spot/Code/DEViLBOX/src/components/arrangement/ArrangementToolbar.tsx",lineNumber:80,columnNumber:9},void 0),n.jsxDEV("option",{value:"pianoroll",children:"Piano Roll"},void 0,!1,{fileName:"/Users/spot/Code/DEViLBOX/src/components/arrangement/ArrangementToolbar.tsx",lineNumber:81,columnNumber:9},void 0),n.jsxDEV("option",{value:"tb303",children:"TB-303"},void 0,!1,{fileName:"/Users/spot/Code/DEViLBOX/src/components/arrangement/ArrangementToolbar.tsx",lineNumber:82,columnNumber:9},void 0),n.jsxDEV("option",{value:"arrangement",children:"Arrangement"},void 0,!1,{fileName:"/Users/spot/Code/DEViLBOX/src/components/arrangement/ArrangementToolbar.tsx",lineNumber:83,columnNumber:9},void 0),n.jsxDEV("option",{value:"dj",children:"DJ Mixer"},void 0,!1,{fileName:"/Users/spot/Code/DEViLBOX/src/components/arrangement/ArrangementToolbar.tsx",lineNumber:84,columnNumber:9},void 0),n.jsxDEV("option",{value:"drumpad",children:"Drum Pads"},void 0,!1,{fileName:"/Users/spot/Code/DEViLBOX/src/components/arrangement/ArrangementToolbar.tsx",lineNumber:85,columnNumber:9},void 0),n.jsxDEV("option",{value:"vj",children:"VJ View"},void 0,!1,{fileName:"/Users/spot/Code/DEViLBOX/src/components/arrangement/ArrangementToolbar.tsx",lineNumber:86,columnNumber:9},void 0)]},void 0,!0,{fileName:"/Users/spot/Code/DEViLBOX/src/components/arrangement/ArrangementToolbar.tsx",lineNumber:68,columnNumber:7},void 0),n.jsxDEV("div",{className:"w-px h-5 bg-border opacity-50"},void 0,!1,{fileName:"/Users/spot/Code/DEViLBOX/src/components/arrangement/ArrangementToolbar.tsx",lineNumber:89,columnNumber:7},void 0),n.jsxDEV("div",{className:"flex items-center gap-1",children:[n.jsxDEV("button",{className:"p-1.5 rounded text-xs transition-colors "+(R?"bg-green-600 text-white":"bg-dark-bgTertiary text-text-secondary hover:bg-dark-border hover:text-text-primary"),onClick:()=>{d(),T()},title:"Play/Pause (Space)",children:n.jsxDEV(m,{size:14,fill:R?"currentColor":"none"},void 0,!1,{fileName:"/Users/spot/Code/DEViLBOX/src/components/arrangement/ArrangementToolbar.tsx",lineNumber:102,columnNumber:11},void 0)},void 0,!1,{fileName:"/Users/spot/Code/DEViLBOX/src/components/arrangement/ArrangementToolbar.tsx",lineNumber:93,columnNumber:9},void 0),n.jsxDEV("button",{className:"p-1.5 rounded bg-dark-bgTertiary text-text-secondary hover:bg-dark-border hover:text-text-primary",onClick:e=>{R&&e.shiftKey?(e.preventDefault(),i().triggerPowerCut()):S()},onContextMenu:e=>{R&&(e.preventDefault(),i().triggerPowerCut())},title:R?"Click: Stop Â· Shift+click/Right-click: Power off":"Stop",children:n.jsxDEV(u,{size:14},void 0,!1,{fileName:"/Users/spot/Code/DEViLBOX/src/components/arrangement/ArrangementToolbar.tsx",lineNumber:112,columnNumber:11},void 0)},void 0,!1,{fileName:"/Users/spot/Code/DEViLBOX/src/components/arrangement/ArrangementToolbar.tsx",lineNumber:104,columnNumber:9},void 0)]},void 0,!0,{fileName:"/Users/spot/Code/DEViLBOX/src/components/arrangement/ArrangementToolbar.tsx",lineNumber:92,columnNumber:7},void 0),n.jsxDEV("div",{className:"w-px h-5 bg-border opacity-50"},void 0,!1,{fileName:"/Users/spot/Code/DEViLBOX/src/components/arrangement/ArrangementToolbar.tsx",lineNumber:116,columnNumber:7},void 0),n.jsxDEV("div",{className:"flex items-center gap-1",children:[V("select",n.jsxDEV(v,{size:14},void 0,!1,{fileName:"/Users/spot/Code/DEViLBOX/src/components/arrangement/ArrangementToolbar.tsx",lineNumber:120,columnNumber:28},void 0),"Select","V"),V("draw",n.jsxDEV(w,{size:14},void 0,!1,{fileName:"/Users/spot/Code/DEViLBOX/src/components/arrangement/ArrangementToolbar.tsx",lineNumber:121,columnNumber:26},void 0),"Draw","D"),V("erase",n.jsxDEV(y,{size:14},void 0,!1,{fileName:"/Users/spot/Code/DEViLBOX/src/components/arrangement/ArrangementToolbar.tsx",lineNumber:122,columnNumber:27},void 0),"Erase","E"),V("split",n.jsxDEV(N,{size:14},void 0,!1,{fileName:"/Users/spot/Code/DEViLBOX/src/components/arrangement/ArrangementToolbar.tsx",lineNumber:123,columnNumber:27},void 0),"Split","S")]},void 0,!0,{fileName:"/Users/spot/Code/DEViLBOX/src/components/arrangement/ArrangementToolbar.tsx",lineNumber:119,columnNumber:7},void 0),n.jsxDEV("div",{className:"w-px h-5 bg-border opacity-50"},void 0,!1,{fileName:"/Users/spot/Code/DEViLBOX/src/components/arrangement/ArrangementToolbar.tsx",lineNumber:126,columnNumber:7},void 0),n.jsxDEV("div",{className:"flex items-center gap-1",children:[n.jsxDEV("button",{className:"p-1 rounded bg-dark-bgTertiary text-text-secondary hover:bg-dark-border hover:text-text-primary",onClick:()=>l(Math.max(.5,a.pixelsPerRow/1.5)),title:"Zoom Out (Ctrl+-)",children:n.jsxDEV(p,{size:14},void 0,!1,{fileName:"/Users/spot/Code/DEViLBOX/src/components/arrangement/ArrangementToolbar.tsx",lineNumber:135,columnNumber:11},void 0)},void 0,!1,{fileName:"/Users/spot/Code/DEViLBOX/src/components/arrangement/ArrangementToolbar.tsx",lineNumber:130,columnNumber:9},void 0),n.jsxDEV("span",{className:"text-text-muted w-12 text-center text-[10px] tabular-nums",children:a.pixelsPerRow.toFixed(1)},void 0,!1,{fileName:"/Users/spot/Code/DEViLBOX/src/components/arrangement/ArrangementToolbar.tsx",lineNumber:137,columnNumber:9},void 0),n.jsxDEV("button",{className:"p-1 rounded bg-dark-bgTertiary text-text-secondary hover:bg-dark-border hover:text-text-primary",onClick:()=>l(Math.min(32,1.5*a.pixelsPerRow)),title:"Zoom In (Ctrl++)",children:n.jsxDEV(g,{size:14},void 0,!1,{fileName:"/Users/spot/Code/DEViLBOX/src/components/arrangement/ArrangementToolbar.tsx",lineNumber:143,columnNumber:11},void 0)},void 0,!1,{fileName:"/Users/spot/Code/DEViLBOX/src/components/arrangement/ArrangementToolbar.tsx",lineNumber:138,columnNumber:9},void 0),n.jsxDEV("button",{className:"p-1 rounded bg-dark-bgTertiary text-text-secondary hover:bg-dark-border hover:text-text-primary",onClick:C,title:"Zoom to Fit (Ctrl+0)",children:n.jsxDEV(f,{size:14},void 0,!1,{fileName:"/Users/spot/Code/DEViLBOX/src/components/arrangement/ArrangementToolbar.tsx",lineNumber:150,columnNumber:11},void 0)},void 0,!1,{fileName:"/Users/spot/Code/DEViLBOX/src/components/arrangement/ArrangementToolbar.tsx",lineNumber:145,columnNumber:9},void 0)]},void 0,!0,{fileName:"/Users/spot/Code/DEViLBOX/src/components/arrangement/ArrangementToolbar.tsx",lineNumber:129,columnNumber:7},void 0),n.jsxDEV("div",{className:"w-px h-5 bg-border opacity-50"},void 0,!1,{fileName:"/Users/spot/Code/DEViLBOX/src/components/arrangement/ArrangementToolbar.tsx",lineNumber:154,columnNumber:7},void 0),n.jsxDEV("div",{className:"flex items-center gap-1",children:[n.jsxDEV("span",{className:"text-text-muted",children:"Snap:"},void 0,!1,{fileName:"/Users/spot/Code/DEViLBOX/src/components/arrangement/ArrangementToolbar.tsx",lineNumber:158,columnNumber:9},void 0),n.jsxDEV("select",{className:"bg-dark-bgTertiary border border-dark-border rounded px-1.5 py-0.5 text-text-primary text-xs",value:a.snapDivision,onChange:e=>c(Number(e.target.value)),children:E.map(e=>n.jsxDEV("option",{value:e.value,children:e.label},e.value,!1,{fileName:"/Users/spot/Code/DEViLBOX/src/components/arrangement/ArrangementToolbar.tsx",lineNumber:165,columnNumber:13},void 0))},void 0,!1,{fileName:"/Users/spot/Code/DEViLBOX/src/components/arrangement/ArrangementToolbar.tsx",lineNumber:159,columnNumber:9},void 0)]},void 0,!0,{fileName:"/Users/spot/Code/DEViLBOX/src/components/arrangement/ArrangementToolbar.tsx",lineNumber:157,columnNumber:7},void 0),n.jsxDEV("div",{className:"w-px h-5 bg-border opacity-50"},void 0,!1,{fileName:"/Users/spot/Code/DEViLBOX/src/components/arrangement/ArrangementToolbar.tsx",lineNumber:170,columnNumber:7},void 0),n.jsxDEV("button",{className:"p-1 rounded text-xs flex items-center gap-1 "+(a.followPlayback?"bg-accent-primary/20 text-accent-primary":"bg-dark-bgTertiary text-text-secondary hover:bg-dark-border"),onClick:()=>k(!a.followPlayback),title:"Follow Playback (F)",children:[n.jsxDEV(h,{size:14},void 0,!1,{fileName:"/Users/spot/Code/DEViLBOX/src/components/arrangement/ArrangementToolbar.tsx",lineNumber:182,columnNumber:9},void 0),n.jsxDEV("span",{children:"Follow"},void 0,!1,{fileName:"/Users/spot/Code/DEViLBOX/src/components/arrangement/ArrangementToolbar.tsx",lineNumber:183,columnNumber:9},void 0)]},void 0,!0,{fileName:"/Users/spot/Code/DEViLBOX/src/components/arrangement/ArrangementToolbar.tsx",lineNumber:173,columnNumber:7},void 0),n.jsxDEV("div",{className:"flex-1"},void 0,!1,{fileName:"/Users/spot/Code/DEViLBOX/src/components/arrangement/ArrangementToolbar.tsx",lineNumber:186,columnNumber:7},void 0),n.jsxDEV("button",{className:"p-1.5 rounded bg-dark-bgTertiary text-text-secondary hover:bg-dark-border hover:text-text-primary flex items-center gap-1",onClick:()=>D(),title:"Add Track (Ctrl+T)",children:[n.jsxDEV(b,{size:14},void 0,!1,{fileName:"/Users/spot/Code/DEViLBOX/src/components/arrangement/ArrangementToolbar.tsx",lineNumber:194,columnNumber:9},void 0),n.jsxDEV("span",{children:"Track"},void 0,!1,{fileName:"/Users/spot/Code/DEViLBOX/src/components/arrangement/ArrangementToolbar.tsx",lineNumber:195,columnNumber:9},void 0)]},void 0,!0,{fileName:"/Users/spot/Code/DEViLBOX/src/components/arrangement/ArrangementToolbar.tsx",lineNumber:189,columnNumber:7},void 0),n.jsxDEV("button",{className:"p-1.5 rounded bg-dark-bgTertiary text-text-secondary hover:bg-dark-border hover:text-text-primary",onClick:()=>t.getState().setArrangementPoppedOut(!0),title:"Pop out Arrangement",children:n.jsxDEV(x,{size:14},void 0,!1,{fileName:"/Users/spot/Code/DEViLBOX/src/components/arrangement/ArrangementToolbar.tsx",lineNumber:204,columnNumber:9},void 0)},void 0,!1,{fileName:"/Users/spot/Code/DEViLBOX/src/components/arrangement/ArrangementToolbar.tsx",lineNumber:199,columnNumber:7},void 0)]},void 0,!0,{fileName:"/Users/spot/Code/DEViLBOX/src/components/arrangement/ArrangementToolbar.tsx",lineNumber:66,columnNumber:5},void 0)},T=({track:t,height:r})=>{const{toggleTrackMute:o,toggleTrackSolo:i,updateTrack:s}=e(),[a,c]=l.useState(!1),[d,m]=l.useState(t.name);l.useEffect(()=>{requestAnimationFrame(()=>m(t.name))},[t.name]);const u=l.useCallback(()=>{c(!1),d.trim()&&d!==t.name&&s(t.id,{name:d.trim()})},[d,t.id,t.name,s]),p=l.useCallback(e=>{"Enter"===e.key&&u(),"Escape"===e.key&&(m(t.name),c(!1))},[u,t.name]);return n.jsxDEV("div",{className:"flex border-b border-dark-border bg-dark-bgSecondary select-none",style:{height:r,minHeight:30},children:[n.jsxDEV("div",{className:"flex-shrink-0",style:{width:4,backgroundColor:t.color||"#666"}},void 0,!1,{fileName:"/Users/spot/Code/DEViLBOX/src/components/arrangement/TrackHeader.tsx",lineNumber:44,columnNumber:7},void 0),n.jsxDEV("div",{className:"flex-1 flex flex-col px-2 py-1.5 min-w-0",children:[n.jsxDEV("div",{className:"flex items-center gap-1.5 min-h-[20px]",children:[n.jsxDEV("span",{className:"flex-shrink-0 w-4 h-4 rounded text-[8px] font-bold flex items-center justify-center",style:{backgroundColor:`${t.color||"#666"}33`,color:t.color||"#888"},children:t.index+1},void 0,!1,{fileName:"/Users/spot/Code/DEViLBOX/src/components/arrangement/TrackHeader.tsx",lineNumber:56,columnNumber:11},void 0),a?n.jsxDEV("input",{className:"bg-dark-bgTertiary border border-dark-border rounded px-1 text-xs text-text-primary w-full",value:d,onChange:e=>m(e.target.value),onBlur:u,onKeyDown:p,autoFocus:!0},void 0,!1,{fileName:"/Users/spot/Code/DEViLBOX/src/components/arrangement/TrackHeader.tsx",lineNumber:66,columnNumber:13},void 0):n.jsxDEV("span",{className:"text-xs text-text-primary truncate cursor-pointer hover:text-accent-primary font-medium",onDoubleClick:()=>c(!0),title:t.name,children:t.name},void 0,!1,{fileName:"/Users/spot/Code/DEViLBOX/src/components/arrangement/TrackHeader.tsx",lineNumber:75,columnNumber:13},void 0)]},void 0,!0,{fileName:"/Users/spot/Code/DEViLBOX/src/components/arrangement/TrackHeader.tsx",lineNumber:55,columnNumber:9},void 0),r>=44&&n.jsxDEV("div",{className:"flex items-center gap-1 mt-1.5",children:[n.jsxDEV("button",{className:"w-6 h-5 rounded text-[10px] font-bold leading-none transition-colors "+(t.muted?"bg-red-600 text-white":"bg-dark-bgTertiary text-text-muted hover:bg-dark-border hover:text-text-primary"),onClick:()=>o(t.id),title:"Mute",children:"M"},void 0,!1,{fileName:"/Users/spot/Code/DEViLBOX/src/components/arrangement/TrackHeader.tsx",lineNumber:88,columnNumber:13},void 0),n.jsxDEV("button",{className:"w-6 h-5 rounded text-[10px] font-bold leading-none transition-colors "+(t.solo?"bg-yellow-600 text-white":"bg-dark-bgTertiary text-text-muted hover:bg-dark-border hover:text-text-primary"),onClick:()=>i(t.id),title:"Solo",children:"S"},void 0,!1,{fileName:"/Users/spot/Code/DEViLBOX/src/components/arrangement/TrackHeader.tsx",lineNumber:99,columnNumber:13},void 0),r>=56&&n.jsxDEV("div",{className:"flex-1 ml-1.5",children:n.jsxDEV("div",{className:"relative h-[4px] bg-dark-bgTertiary rounded-full overflow-hidden",children:n.jsxDEV("div",{className:"absolute inset-y-0 left-0 rounded-full",style:{width:`${t.volume}%`,backgroundColor:`${t.color||"#3b82f6"}88`}},void 0,!1,{fileName:"/Users/spot/Code/DEViLBOX/src/components/arrangement/TrackHeader.tsx",lineNumber:115,columnNumber:19},void 0)},void 0,!1,{fileName:"/Users/spot/Code/DEViLBOX/src/components/arrangement/TrackHeader.tsx",lineNumber:114,columnNumber:17},void 0)},void 0,!1,{fileName:"/Users/spot/Code/DEViLBOX/src/components/arrangement/TrackHeader.tsx",lineNumber:113,columnNumber:15},void 0)]},void 0,!0,{fileName:"/Users/spot/Code/DEViLBOX/src/components/arrangement/TrackHeader.tsx",lineNumber:87,columnNumber:11},void 0)]},void 0,!0,{fileName:"/Users/spot/Code/DEViLBOX/src/components/arrangement/TrackHeader.tsx",lineNumber:53,columnNumber:7},void 0)]},void 0,!0,{fileName:"/Users/spot/Code/DEViLBOX/src/components/arrangement/TrackHeader.tsx",lineNumber:39,columnNumber:5},void 0)},S=({tracks:e,entries:t,scrollY:r})=>{const o=new Map(e.map(e=>[e.id,e])),i=[...t].filter(e=>e.visible).sort((e,t)=>e.trackIndex-t.trackIndex);return n.jsxDEV("div",{className:"flex-shrink-0 overflow-hidden bg-dark-bgSecondary border-r border-dark-border flex flex-col",style:{width:180},children:[n.jsxDEV("div",{className:"flex items-center px-3 border-b border-dark-border flex-shrink-0",style:{height:36},children:n.jsxDEV("span",{className:"text-[10px] font-bold text-text-muted tracking-widest uppercase",children:"Tracks"},void 0,!1,{fileName:"/Users/spot/Code/DEViLBOX/src/components/arrangement/TrackHeaderPanel.tsx",lineNumber:40,columnNumber:9},void 0)},void 0,!1,{fileName:"/Users/spot/Code/DEViLBOX/src/components/arrangement/TrackHeaderPanel.tsx",lineNumber:36,columnNumber:7},void 0),n.jsxDEV("div",{className:"flex-1 overflow-hidden",children:n.jsxDEV("div",{style:{transform:`translateY(${-r}px)`,willChange:"transform"},children:i.map(e=>{const t=o.get(e.trackId);return t?n.jsxDEV(T,{track:t,height:e.height},t.id,!1,{fileName:"/Users/spot/Code/DEViLBOX/src/components/arrangement/TrackHeaderPanel.tsx",lineNumber:57,columnNumber:15},void 0):null})},void 0,!1,{fileName:"/Users/spot/Code/DEViLBOX/src/components/arrangement/TrackHeaderPanel.tsx",lineNumber:47,columnNumber:9},void 0)},void 0,!1,{fileName:"/Users/spot/Code/DEViLBOX/src/components/arrangement/TrackHeaderPanel.tsx",lineNumber:46,columnNumber:7},void 0)]},void 0,!0,{fileName:"/Users/spot/Code/DEViLBOX/src/components/arrangement/TrackHeaderPanel.tsx",lineNumber:31,columnNumber:5},void 0)};class V{scrollRow=0;scrollY=0;pixelsPerRow=4;width=800;height=400;update(e){void 0!==e.scrollRow&&(this.scrollRow=e.scrollRow),void 0!==e.scrollY&&(this.scrollY=e.scrollY),void 0!==e.pixelsPerRow&&(this.pixelsPerRow=e.pixelsPerRow),void 0!==e.width&&(this.width=e.width),void 0!==e.height&&(this.height=e.height)}rowToPixelX(e){return(e-this.scrollRow)*this.pixelsPerRow}pixelXToRow(e){return e/this.pixelsPerRow+this.scrollRow}trackYToScreenY(e){return e-this.scrollY}screenYToTrackY(e){return e+this.scrollY}snapRow(e,t){return t<=0?Math.round(e):Math.round(e/t)*t}getVisibleRowRange(){const e=Math.floor(this.scrollRow),t=Math.ceil(this.scrollRow+this.width/this.pixelsPerRow)+1;return{startRow:Math.max(0,e),endRow:t}}get visibleRows(){return this.width/this.pixelsPerRow}}class I{entries=[];totalHeight=0;rebuild(e,t,r){const o=new Set(t.filter(e=>e.collapsed).map(e=>e.id)),n=new Set(t.filter(e=>e.folded).map(e=>e.id)),i=[...e].sort((e,t)=>e.index-t.index);this.entries=[];let s=0;for(const a of i){const e=!a.groupId||!o.has(a.groupId)&&!n.has(a.groupId),t=r.filter(e=>e.trackId===a.id&&e.visible),i=a.automationVisible?40*t.length:0,l=a.collapsed?24:a.height,c=l+i;this.entries.push({trackId:a.id,trackIndex:a.index,y:s,height:e?c:0,bodyHeight:e?l:0,automationY:s+l,automationHeight:e?i:0,visible:e}),e&&(s+=c+1)}this.totalHeight=s}getTotalHeight(){return this.totalHeight}getEntries(){return this.entries}getVisibleEntries(e,t){return this.entries.filter(r=>{if(!r.visible)return!1;return r.y+r.height>e&&r.y<e+t})}hitTestY(e){for(const t of this.entries){if(!t.visible)continue;if(e<t.y)continue;if(e>t.y+t.height)continue;const r=e-t.y;return r>=t.bodyHeight-4&&r<=t.bodyHeight?{trackIndex:t.trackIndex,trackId:t.trackId,zone:"resize-handle"}:r>t.bodyHeight?{trackIndex:t.trackIndex,trackId:t.trackId,zone:"automation"}:{trackIndex:t.trackIndex,trackId:t.trackId,zone:"body"}}return null}getEntryForTrack(e){return this.entries.find(t=>t.trackId===e)}}const L={background:"#0c0c0e",trackEven:"rgba(255,255,255,0.02)",trackOdd:"rgba(255,255,255,0.05)",trackSeparator:"rgba(255,255,255,0.08)",gridLine:"rgba(255,255,255,0.02)",beatLine:"rgba(255,255,255,0.05)",barLine:"rgba(255,255,255,0.10)",fourBarLine:"rgba(255,255,255,0.16)",beyondEnd:"rgba(100,100,100,0.06)"};class M{canvas=null;ctx=null;lastKey="";colors={...L};cacheKey(e,t,r,o,n,i){const s=t.map(e=>`${e.y}_${e.height}`).join(",");return`${e.scrollRow.toFixed(2)}_${e.scrollY.toFixed(1)}_${e.pixelsPerRow}_${e.width}_${e.height}_${r}_${o}_${n}_${i}_${s}`}render(e,t,r,o,n,i){const s=this.cacheKey(e,t,r,o,n,i);if(s===this.lastKey&&this.canvas)return this.canvas;const a=Math.ceil(e.width*i),l=Math.ceil(e.height*i);if(a<=0||l<=0)return null;this.canvas&&this.canvas.width===a&&this.canvas.height===l||(this.canvas=new OffscreenCanvas(a,l),this.ctx=this.canvas.getContext("2d"));const c=this.ctx;if(!c)return null;c.setTransform(i,0,0,i,0,0),c.fillStyle=this.colors.background,c.fillRect(0,0,e.width,e.height);for(let h=0;h<t.length;h++){const r=t[h];if(!r.visible)continue;const o=e.trackYToScreenY(r.y);o+r.height<0||o>e.height||(c.fillStyle=h%2==0?this.colors.trackEven:this.colors.trackOdd,c.fillRect(0,o,e.width,r.height),c.fillStyle=this.colors.trackSeparator,c.fillRect(0,o+r.height,e.width,1))}const d=r,m=r*o,u=4*m,p=e.getVisibleRowRange();let g=1;e.pixelsPerRow<1?g=m:e.pixelsPerRow<2&&(g=d);const f=Math.max(0,Math.floor(p.startRow/g)*g);if(n<p.endRow){const t=e.rowToPixelX(n);t<e.width&&(c.fillStyle=this.colors.beyondEnd,c.fillRect(t,0,e.width-t,e.height))}for(let h=f;h<=Math.min(p.endRow,n);h+=g){const t=e.rowToPixelX(h);if(t<-1||t>e.width+1)continue;const r=h%m===0,o=h%d===0;h%u===0?(c.fillStyle=this.colors.fourBarLine,c.fillRect(t,0,1,e.height)):r?(c.fillStyle=this.colors.barLine,c.fillRect(t,0,1,e.height)):o?(c.fillStyle=this.colors.beatLine,c.fillRect(t,0,1,e.height)):e.pixelsPerRow>=2&&(c.fillStyle=this.colors.gridLine,c.fillRect(t,0,1,e.height))}return this.lastKey=s,this.canvas}invalidate(){this.lastKey=""}}class P{previewCache=new Map;render(e,t,r,o,n,i,s,a,l,c,d){const m=new Map(o.map(e=>[e.id,e])),u=new Map(n.map(e=>[e.trackId,e])),p=new Map(i.map(e=>[e.id,e])),g=t.getVisibleRowRange(),f=r.filter(e=>{const t=p.get(e.patternId),r=e.clipLengthRows??(t?t.length-e.offsetRows:64);return e.startRow+r>=g.startRow-10&&e.startRow<=g.endRow+10});for(const h of f){const r=u.get(h.trackId);if(!r||!r.visible)continue;const o=m.get(h.trackId);if(!o)continue;const n=p.get(h.patternId),i=h.clipLengthRows??(n?n.length-h.offsetRows:64),a=h.startRow+i,g=s.has(h.id),f=c&&void 0!==l&&l>=h.startRow&&l<a,b=d===h.id;this.drawClip(e,t,h,o,r,n,i,g,!1,f,l,b)}if(a)for(const h of a){const r=u.get(h.trackId);if(!r||!r.visible)continue;const o=m.get(h.trackId);if(!o)continue;const n=p.get(h.patternId),i=h.clipLengthRows??(n?n.length-h.offsetRows:64);this.drawClip(e,t,h,o,r,n,i,!1,!0,!1,void 0,!1)}}drawClip(e,t,r,o,n,i,s,a,l,c=!1,d,m=!1){const u=t.rowToPixelX(r.startRow)+1,p=t.trackYToScreenY(n.y)+1,g=s*t.pixelsPerRow-2,f=n.bodyHeight-2;if(g<2||f<4)return;const h=r.color??o.color??"#3b82f6",b=function(e){const t=e.replace("#",""),r=parseInt(3===t.length?t.split("").map(e=>e+e).join(""):t.slice(0,6),16);return{r:r>>16&255,g:r>>8&255,b:255&r}}(h);if(e.save(),l&&(e.globalAlpha=.4),e.beginPath(),this.roundRect(e,u,p,g,f,4),r.muted)e.fillStyle=`rgba(${b.r},${b.g},${b.b},0.18)`;else{const t=e.createLinearGradient(u,p,u,p+f);t.addColorStop(0,`rgba(${b.r},${b.g},${b.b},0.55)`),t.addColorStop(1,`rgba(${Math.floor(.6*b.r)},${Math.floor(.6*b.g)},${Math.floor(.6*b.b)},0.45)`),e.fillStyle=t}e.fill(),a?(e.strokeStyle="#ffffff",e.lineWidth=2,e.stroke()):m&&!l?(e.strokeStyle=`rgba(${b.r},${b.g},${b.b},0.9)`,e.lineWidth=2,e.stroke()):(e.strokeStyle=`rgba(${b.r},${b.g},${b.b},0.7)`,e.lineWidth=1,e.stroke()),l&&(e.setLineDash([4,4]),e.strokeStyle="#ffffffaa",e.lineWidth=1,e.stroke(),e.setLineDash([])),e.beginPath(),this.roundRect(e,u,p,g,f,4),e.clip(),r.muted?(e.fillStyle=`rgba(${b.r},${b.g},${b.b},0.35)`,e.fillRect(u,p,g,4)):(e.fillStyle=h,e.fillRect(u,p,g,4));const x=e.createLinearGradient(u,p+4,u,p+4+6);x.addColorStop(0,"rgba(255,255,255,0.07)"),x.addColorStop(1,"rgba(255,255,255,0)"),e.fillStyle=x,e.fillRect(u,p+4,g,6);const v=e.createLinearGradient(u,p+f-8,u,p+f);if(v.addColorStop(0,"rgba(0,0,0,0)"),v.addColorStop(1,"rgba(0,0,0,0.15)"),e.fillStyle=v,e.fillRect(u,p+f-8,g,8),g>20&&f>20&&i&&this.drawNoteDensityPreview(e,t,r,i,u,p+16,g,f-16),g>30){const t=i?.name??r.patternId,o=g-8;e.fillStyle="rgba(0,0,0,0.5)",e.font="bold 10px Inter, system-ui, sans-serif",e.textBaseline="top",e.fillText(t,u+5,p+4+3,o),e.fillStyle=r.muted?"#ffffff55":"#ffffffee",e.fillText(t,u+4,p+4+2,o)}if(c&&void 0!==d&&!l){const t=u+g*((d-r.startRow)/s);e.fillStyle=`rgba(${b.r},${b.g},${b.b},0.2)`,e.fillRect(u,p,t-u,f);const o=e.createLinearGradient(t-4,p,t+4,p);o.addColorStop(0,`rgba(${b.r},${b.g},${b.b},0)`),o.addColorStop(.5,`rgba(${Math.min(255,b.r+60)},${Math.min(255,b.g+60)},${Math.min(255,b.b+60)},0.8)`),o.addColorStop(1,`rgba(${b.r},${b.g},${b.b},0)`),e.fillStyle=o,e.fillRect(t-4,p,8,f),e.strokeStyle="rgba(255,255,255,0.9)",e.lineWidth=2,e.beginPath(),e.moveTo(t,p),e.lineTo(t,p+f),e.stroke(),e.fillStyle="rgba(255,255,255,0.15)",e.fillRect(u,p,g,4)}if(r.fadeInRows&&r.fadeInRows>0&&!l){const o=Math.min(.4*g,r.fadeInRows*t.pixelsPerRow);if(o>2){const t=r.fadeInCurve||"linear",n=e.createLinearGradient(u,p,u+o,p);"exponential"===t?(n.addColorStop(0,"rgba(0,0,0,0.6)"),n.addColorStop(.3,"rgba(0,0,0,0.3)"),n.addColorStop(1,"rgba(0,0,0,0)")):"logarithmic"===t?(n.addColorStop(0,"rgba(0,0,0,0.6)"),n.addColorStop(.7,"rgba(0,0,0,0.3)"),n.addColorStop(1,"rgba(0,0,0,0)")):(n.addColorStop(0,"rgba(0,0,0,0.5)"),n.addColorStop(1,"rgba(0,0,0,0)")),e.fillStyle=n,e.fillRect(u,p,o,f),e.fillStyle="rgba(255,255,255,0.3)",e.beginPath(),e.moveTo(u+o-6,p),e.lineTo(u+o,p),e.lineTo(u+o,p+6),e.closePath(),e.fill()}}if(r.fadeOutRows&&r.fadeOutRows>0&&!l){const o=Math.min(.4*g,r.fadeOutRows*t.pixelsPerRow);if(o>2){const t=r.fadeOutCurve||"linear",n=e.createLinearGradient(u+g-o,p,u+g,p);"exponential"===t?(n.addColorStop(0,"rgba(0,0,0,0)"),n.addColorStop(.7,"rgba(0,0,0,0.3)"),n.addColorStop(1,"rgba(0,0,0,0.6)")):"logarithmic"===t?(n.addColorStop(0,"rgba(0,0,0,0)"),n.addColorStop(.3,"rgba(0,0,0,0.3)"),n.addColorStop(1,"rgba(0,0,0,0.6)")):(n.addColorStop(0,"rgba(0,0,0,0)"),n.addColorStop(1,"rgba(0,0,0,0.5)")),e.fillStyle=n,e.fillRect(u+g-o,p,o,f),e.fillStyle="rgba(255,255,255,0.3)",e.beginPath(),e.moveTo(u+g-o,p),e.lineTo(u+g-o+6,p),e.lineTo(u+g-o,p+6),e.closePath(),e.fill()}}if(r.muted&&!l){e.fillStyle="rgba(0,0,0,0.3)",e.fillRect(u,p,g,f),e.strokeStyle="rgba(255,255,255,0.1)",e.lineWidth=1;for(let t=-f;t<g;t+=8)e.beginPath(),e.moveTo(u+t,p),e.lineTo(u+t+f,p+f),e.stroke()}if(a&&!l&&g>24){const t=e.createLinearGradient(u,p,u+6,p);t.addColorStop(0,"rgba(255,255,255,0.25)"),t.addColorStop(1,"rgba(255,255,255,0)"),e.fillStyle=t,e.fillRect(u,p,6,f);const r=e.createLinearGradient(u+g-6,p,u+g,p);r.addColorStop(0,"rgba(255,255,255,0)"),r.addColorStop(1,"rgba(255,255,255,0.25)"),e.fillStyle=r,e.fillRect(u+g-6,p,6,f)}e.restore()}drawNoteDensityPreview(e,t,r,o,n,i,s,a){const l=o.channels[r.sourceChannelIndex];if(!l)return;const c=Math.round(s),d=Math.round(a);if(c<10||d<10)return;const m=`${r.patternId}_${r.sourceChannelIndex}_${c}_${d}`;let u=this.previewCache.get(m);if(!u){if(this.previewCache.size>=64){const e=this.previewCache.keys().next().value;e&&this.previewCache.delete(e)}const e=new OffscreenCanvas(c,d),t=e.getContext("2d");if(!t)return;const n=l.rows,i=r.clipLengthRows??o.length-r.offsetRows,s=r.offsetRows;let a=127,p=0;for(let r=s;r<s+i&&r<n.length;r++){const e=n[r]?.note??0;if(e>0&&e<97){const t=e+11;t<a&&(a=t),t>p&&(p=t)}}if(a>p)return u={canvas:e,width:c,height:d},void this.previewCache.set(m,u);a=Math.max(0,a-2),p=Math.min(127,p+2);const g=p-a+1;t.fillStyle="rgba(255,255,255,0.35)";for(let r=s;r<s+i&&r<n.length;r++){const e=n[r]?.note??0;if(e<=0||e>=97)continue;const o=(r-s)/i*c,a=(p-(e+11))/g*d,l=Math.max(1,c/i),m=Math.max(1,d/g);t.fillRect(o,a,l,m)}u={canvas:e,width:c,height:d},this.previewCache.set(m,u)}e.drawImage(u.canvas,n,i,c,d)}roundRect(e,t,r,o,n,i){e.moveTo(t+i,r),e.lineTo(t+o-i,r),e.arcTo(t+o,r,t+o,r+i,i),e.lineTo(t+o,r+n-i),e.arcTo(t+o,r+n,t+o-i,r+n,i),e.lineTo(t+i,r+n),e.arcTo(t,r+n,t,r+n-i,i),e.lineTo(t,r+i),e.arcTo(t,r,t+i,r,i),e.closePath()}invalidateCache(e){if(e){const t=[...this.previewCache.keys()].filter(t=>t.startsWith(e));for(const e of t)this.previewCache.delete(e)}else this.previewCache.clear()}dispose(){this.previewCache.clear()}}const X=36,B={background:"#111114",text:"#aaaabc",beatText:"#666677",tick:"rgba(255,255,255,0.1)",beatTick:"rgba(255,255,255,0.25)",barLine:"rgba(255,255,255,0.45)",markerFlag:"#f59e0b",markerText:"#ffffffcc",loopRegion:"rgba(34,197,94,0.15)"};class O{canvas=null;ctx=null;lastKey="";colors={...B};get height(){return X}cacheKey(e,t,r,o,n,i,s){const a=o.map(e=>`${e.row}_${e.type}_${e.name}_${e.color}`).join(",");return`${e.scrollRow.toFixed(2)}_${e.pixelsPerRow}_${e.width}_${t}_${r}_${a}_${n}_${i}_${s}`}render(e,t,r,o,n,i,s){const a=this.cacheKey(e,t,r,o,n,i,s);if(a===this.lastKey&&this.canvas)return this.canvas;const l=Math.ceil(e.width*s),c=Math.ceil(X*s);if(l<=0)return null;this.canvas&&this.canvas.width===l&&this.canvas.height===c||(this.canvas=new OffscreenCanvas(l,c),this.ctx=this.canvas.getContext("2d"));const d=this.ctx;if(!d)return null;d.setTransform(s,0,0,s,0,0),d.fillStyle=this.colors.background,d.fillRect(0,0,e.width,X),d.fillStyle="rgba(255,255,255,0.15)",d.fillRect(0,35,e.width,1);const m=t,u=t*r,p=e.getVisibleRowRange();if(null!==n&&null!==i&&i>n){const t=e.rowToPixelX(n),r=(i-n)*e.pixelsPerRow;d.fillStyle=this.colors.loopRegion,d.fillRect(t,0,r,X),d.fillStyle="#22c55e",d.fillRect(t-1,0,3,X),d.beginPath(),d.moveTo(t+1,28),d.lineTo(t-5,X),d.lineTo(t+7,X),d.closePath(),d.fill();const o=t+r;d.fillRect(o-1,0,3,X),d.beginPath(),d.moveTo(o+1,28),d.lineTo(o-5,X),d.lineTo(o+7,X),d.closePath(),d.fill()}let g=1;e.pixelsPerRow<1?g=u:e.pixelsPerRow<3&&(g=m);const f=Math.floor(p.startRow/g)*g;for(let h=Math.max(0,f);h<=p.endRow;h+=g){const t=e.rowToPixelX(h);if(t<-50||t>e.width+50)continue;const r=h%m===0;if(h%u===0){const e=Math.floor(h/u)+1;d.fillStyle=this.colors.barLine,d.fillRect(t,14,1,22),d.font="bold 12px Inter, system-ui, sans-serif",d.textBaseline="middle",d.fillStyle=this.colors.text,d.fillText(`${e}`,t+4,10)}else if(r&&e.pixelsPerRow>=2){if(d.fillStyle=this.colors.beatTick,d.fillRect(t,22,1,14),e.pixelsPerRow>=4){const e=Math.floor(h/u)+1,r=Math.floor(h%u/m)+1;d.font="9px Inter, system-ui, sans-serif",d.textBaseline="middle",d.fillStyle=this.colors.beatText,d.fillText(`${e}.${r}`,t+3,18)}}else e.pixelsPerRow>=4&&(d.fillStyle=this.colors.tick,d.fillRect(t,28,1,8))}d.font="9px Inter, system-ui, sans-serif";for(const h of o){if(h.row<p.startRow||h.row>p.endRow)continue;const t=e.rowToPixelX(h.row),r=h.color||this.colors.markerFlag;d.fillStyle=r,d.beginPath(),d.moveTo(t,0),d.lineTo(t+8,4),d.lineTo(t,8),d.fill(),d.fillStyle=this.colors.markerText,d.fillText(h.name,t+10,5),d.fillStyle=`${r}66`,d.fillRect(t,0,1,X)}return this.lastKey=a,this.canvas}invalidate(){this.lastKey=""}}class A{clipRects=[];rebuild(e,t,r,o,n){const i=new Map(r.map(e=>[e.id,e]));this.clipRects=[];for(const s of e){const e=n.getEntryForTrack(s.trackId);if(!e||!e.visible)continue;const t=i.get(s.patternId),r=s.clipLengthRows??(t?t.length-s.offsetRows:64),a=o.rowToPixelX(s.startRow),l=o.trackYToScreenY(e.y),c=r*o.pixelsPerRow,d=e.bodyHeight;this.clipRects.push({clip:s,x:a,y:l,w:c,h:d})}}hitTest(e,t,r,o,n,i,s,a){if(t<n){if(null!=i){const t=r.rowToPixelX(i);if(Math.abs(e-t)<=7)return{type:"loop-start",row:i}}if(null!=s){const t=r.rowToPixelX(s);if(Math.abs(e-t)<=7)return{type:"loop-end",row:s}}return{type:"ruler",row:Math.max(0,Math.round(r.pixelXToRow(e)))}}const l=t-n,c=Math.max(0,Math.round(r.pixelXToRow(e)));if(a&&"point"===a.type&&void 0!==a.pointIndex)return{type:"automation-point",laneId:a.laneId,pointIndex:a.pointIndex};if(a&&"segment"===a.type&&void 0!==a.insertAfterIndex&&void 0!==a.row&&void 0!==a.value)return{type:"automation-segment",laneId:a.laneId,insertAfterIndex:a.insertAfterIndex,row:a.row,value:a.value};let d=null,m="body";for(const g of this.clipRects){const t=g.y;if(e<g.x||e>g.x+g.w)continue;if(l<t||l>t+g.h)continue;const r=e-g.x;let o="body";r<=6&&g.w>18?o="resize-start":r>=g.w-6&&g.w>18&&(o="resize-end"),d=g,m=o}if(d)return{type:"clip",clipId:d.clip.id,zone:m,trackId:d.clip.trackId,row:c};const u=r.screenYToTrackY(l),p=o.hitTestY(u);return p?"resize-handle"===p.zone?{type:"track-resize",trackId:p.trackId}:"automation"===p.zone?{type:"automation",trackId:p.trackId,row:c}:{type:"empty",trackId:p.trackId,trackIndex:p.trackIndex,row:c}:{type:"none"}}findClipsInRect(e,t,r,o){const n=Math.min(e,r),i=Math.max(e,r),s=Math.min(t,o),a=Math.max(t,o),l=[];for(const c of this.clipRects)c.x+c.w<n||c.x>i||c.y+c.h<s||c.y>a||l.push(c.clip.id);return l}getCursor(e,t){if("draw"===t)return"crosshair";if("erase"===t)return"not-allowed";if("split"===t)return"col-resize";if("clip"===e.type)switch(e.zone){case"resize-start":case"resize-end":return"ew-resize";case"body":return"grab"}return"track-resize"===e.type?"ns-resize":"loop-start"===e.type||"loop-end"===e.type?"ew-resize":"ruler"===e.type?"pointer":"automation-point"===e.type?"move":"automation-segment"===e.type?"crosshair":"default"}}class U{_state="idle";_tool="select";_drag=null;_ghostClips=[];_selectionBox=null;_drawPreview=null;_cursor="default";_dirty=!0;get state(){return this._state}get tool(){return this._tool}get drag(){return this._drag}setTool(e){this._tool=e,this._dirty=!0}beginDrag(e,t,r,o,n,i,s,a){this._state=e,this._drag={startX:t,startY:r,currentX:t,currentY:r,startRow:o,startTrackIndex:n,targetClipId:i,selectedAtStart:new Set(s),originalClips:[...a]},this._dirty=!0}updateDrag(e,t){this._drag&&(this._drag.currentX=e,this._drag.currentY=t,this._dirty=!0)}endDrag(){this._state="idle",this._drag=null,this._ghostClips=[],this._selectionBox=null,this._drawPreview=null,this._dirty=!0}setGhostClips(e){this._ghostClips=e,this._dirty=!0}setSelectionBox(e){this._selectionBox=e,this._dirty=!0}setDrawPreview(e){this._drawPreview=e,this._dirty=!0}updateCursor(e){let t;if("idle"!==this._state)switch(this._state){case"moving-clips":t="grabbing";break;case"resizing-clip-start":case"resizing-clip-end":case"moving-loop-start":case"moving-loop-end":t="ew-resize";break;case"drawing-clip":case"select-box":case"adding-automation-point":t="crosshair";break;case"erasing":t="not-allowed";break;case"moving-playhead":t="pointer";break;case"resizing-track-height":t="ns-resize";break;case"moving-automation-point":t="move";break;default:t="default"}else if("draw"===this._tool)t="crosshair";else if("erase"===this._tool)t="not-allowed";else if("split"===this._tool)t="col-resize";else if("clip"===e.type)switch(e.zone){case"resize-start":case"resize-end":t="ew-resize";break;case"body":t="grab";break;default:t="default"}else t="ruler"===e.type?"pointer":"track-resize"===e.type?"ns-resize":"loop-start"===e.type||"loop-end"===e.type?"ew-resize":"automation-point"===e.type?"move":"automation-segment"===e.type?"crosshair":"default";t!==this._cursor&&(this._cursor=t,this._dirty=!0)}getRenderState(){const e={state:this._state,ghostClips:this._ghostClips,selectionBox:this._selectionBox,drawPreview:this._drawPreview,cursor:this._cursor,dirty:this._dirty};return this._dirty=!1,e}getDragDelta(e,t){if(!this._drag)return{deltaRow:0,deltaTrackIndex:0};return{deltaRow:Math.round((this._drag.currentX-this._drag.startX)/e),deltaTrackIndex:Math.round((this._drag.currentY-this._drag.startY)/(t||60))}}markDirty(){this._dirty=!0}}class j{beforeState=null;description="";committed=!1;begin(e,t){this.beforeState=JSON.parse(JSON.stringify(e)),this.description=t,this.committed=!1}get isActive(){return null!==this.beforeState&&!this.committed}execute(e){this.isActive&&e()}commit(e){this.beforeState&&!this.committed&&(e(this.beforeState),this.committed=!0,this.beforeState=null)}cancel(){this.beforeState=null,this.committed=!1}getBeforeState(){return this.beforeState}getDescription(){return this.description}}const z=40;function _(e,t,r){const o=e.curve||"linear",n=e.tension??.5;switch(o){case"exponential":return e.value+(t.value-e.value)*Math.pow(r,1+3*n);case"logarithmic":return e.value+(t.value-e.value)*(1-Math.pow(1-r,1+3*n));case"s-curve":const o=r*r*(3-2*r);return e.value+(t.value-e.value)*o;default:return e.value+(t.value-e.value)*r}}class ${render(e,t,r,o,n,i){const s=new Map(o.map(e=>[e.trackId,e])),a=t.getVisibleRowRange(),l=new Map;for(const c of r){if(!c.visible||!c.enabled||0===c.points.length)continue;const e=l.get(c.trackId)??[];e.push(c),l.set(c.trackId,e)}for(const[c,d]of l){const r=s.get(c);if(r&&r.visible&&!(r.automationHeight<=0))for(let o=0;o<d.length;o++){const s=d[o],l=t.trackYToScreenY(r.automationY)+o*z,c=z;if(l+c<0||l>t.height)continue;const m=n===s.id;this.drawLane(e,t,s,l,c,a.startRow,a.endRow,m,i??void 0)}}}drawLane(e,t,r,o,n,i,s,a=!1,l){const c=r.points;if(0===c.length)return;e.save(),e.beginPath(),e.rect(0,o,t.width,n),e.clip();const d=[];for(let u=0;u<c.length;u++){const e=c[u];if(e.row>s+10)break;const r=t.rowToPixelX(e.row),i=o+n-e.value*n;if(d.push({x:r,y:i}),u<c.length-1){const r=c[u+1],i=r.row-e.row;if(i*t.pixelsPerRow>4){const s=Math.min(20,Math.floor(i*t.pixelsPerRow/4));for(let a=1;a<s;a++){const l=a/s,c=e.row+i*l,m=_(e,r,l),u=t.rowToPixelX(c),p=o+n-m*n;d.push({x:u,y:p})}}}}if(0===d.length)return void e.restore();e.beginPath(),e.moveTo(d[0].x,o+n);for(const u of d)e.lineTo(u.x,u.y);e.lineTo(d[d.length-1].x,o+n),e.closePath();const m=e.createLinearGradient(0,o,0,o+n);m.addColorStop(0,"rgba(59,130,246,0.2)"),m.addColorStop(1,"rgba(59,130,246,0.02)"),e.fillStyle=m,e.fill(),e.beginPath(),e.moveTo(d[0].x,d[0].y);for(let u=1;u<d.length;u++)e.lineTo(d[u].x,d[u].y);e.strokeStyle="#3b82f6",e.lineWidth=1.5,e.stroke();for(let u=0;u<d.length;u++){const r=d[u];if(r.x<-3||r.x>t.width+3)continue;a&&l===u?(e.fillStyle="#ffffff",e.strokeStyle="#3b82f6",e.lineWidth=2,e.beginPath(),e.arc(r.x,r.y,5,0,2*Math.PI),e.fill(),e.stroke()):(e.fillStyle="#3b82f6",e.beginPath(),e.arc(r.x,r.y,3,0,2*Math.PI),e.fill())}e.restore()}hitTest(e,t,r,o,n){const i=new Map(n.map(e=>[e.trackId,e])),s=new Map;for(const a of o){if(!a.visible||!a.enabled||0===a.points.length)continue;const e=s.get(a.trackId)??[];e.push(a),s.set(a.trackId,e)}for(const[a,l]of s){const o=i.get(a);if(o&&o.visible&&!(o.automationHeight<=0))for(let n=0;n<l.length;n++){const i=l[n],s=r.trackYToScreenY(o.automationY)+n*z,a=z;if(!(t<s||t>s+a)){for(let o=0;o<i.points.length;o++){const n=i.points[o],l=r.rowToPixelX(n.row),c=s+a-n.value*a;if(Math.hypot(e-l,t-c)<=8)return{type:"point",laneId:i.id,pointIndex:o}}for(let o=0;o<i.points.length-1;o++){const n=i.points[o],l=i.points[o+1],c=r.rowToPixelX(n.row),d=s+a-n.value*a,m=r.rowToPixelX(l.row),u=s+a-l.value*a;if(e<Math.min(c,m)||e>Math.max(c,m))continue;const p=Math.hypot(m-c,u-d);if(p<.1)continue;const g=Math.max(0,Math.min(1,((e-c)*(m-c)+(t-d)*(u-d))/(p*p))),f=c+g*(m-c),h=d+g*(u-d);if(Math.hypot(e-f,t-h)<=6){const n=Math.round(r.pixelXToRow(e)),l=Math.max(0,Math.min(1,(s+a-t)/a));return{type:"segment",laneId:i.id,insertAfterIndex:o,row:n,value:l}}}}}}return{type:"none",laneId:""}}getPointScreenPos(e,t,r,o,n){const i=t.trackYToScreenY(o.automationY)+n*z;return{x:t.rowToPixelX(e.row),y:i+40-40*e.value}}}const Y=36,H=()=>{const t=l.useRef(null),o=l.useRef(null),i=l.useRef(0),a=l.useRef(!0),d=l.useRef(new V),m=l.useRef(new I),u=l.useRef(new M),p=l.useRef(new P),g=l.useRef(new O),f=l.useRef(new A),h=l.useRef(new U),b=l.useRef(new j),x=l.useRef(new $),v=l.useRef(!1),[w,y]=c.useState(null),[N,k]=c.useState(null),C=l.useRef(null);D();const E=l.useCallback(()=>{a.current=!0},[]);l.useEffect(()=>{let t=e.getState().tool,o=s.getState().patterns;const n=[e.subscribe(e=>{e.tool!==t&&(t=e.tool,h.current.setTool(e.tool)),E()}),r.subscribe(E),s.subscribe(e=>{e.patterns!==o&&(o=e.patterns,p.current.invalidateCache(),E())})];return()=>n.forEach(e=>e())},[E]),l.useEffect(()=>{const e=o.current;if(!e)return;const t=new ResizeObserver(e=>{for(const t of e){const{width:e,height:r}=t.contentRect;d.current.update({width:e,height:r-Y}),a.current=!0}});return t.observe(e),()=>t.disconnect()},[]),l.useEffect(()=>{const o=()=>{i.current=requestAnimationFrame(o);const n=t.current;if(!n)return;const l=h.current.getRenderState();if(!a.current&&!l.dirty)return;a.current=!1;const c=n.getContext("2d");if(!c)return;const b=window.devicePixelRatio||1,v=e.getState(),y=r.getState(),k=s.getState().patterns,C=d.current,D=m.current;if(v.view.followPlayback&&v.isArrangementMode&&y.isPlaying){const e=(v.playbackRow-v.view.scrollRow)*v.view.pixelsPerRow,t=n.getBoundingClientRect().width;(e>.8*t||e<0)&&v.setScrollRow(Math.max(0,v.playbackRow-.2*t/v.view.pixelsPerRow))}C.update({scrollRow:v.view.scrollRow,scrollY:v.view.scrollY,pixelsPerRow:v.view.pixelsPerRow}),D.rebuild(v.tracks,v.groups,v.automationLanes),f.current.rebuild(v.clips,v.tracks,k,C,D);const E=n.getBoundingClientRect(),R=E.width,T=E.height;n.width===Math.ceil(R*b)&&n.height===Math.ceil(T*b)||(n.width=Math.ceil(R*b),n.height=Math.ceil(T*b)),c.setTransform(b,0,0,b,0,0),c.clearRect(0,0,R,T);const S=D.getVisibleEntries(v.view.scrollY,T-Y),V=y.speed||6,I=y.timeSignature[0]||4,L=v.getTotalRows(),M=g.current.render(C,V,I,v.markers,v.view.loopStart,v.view.loopEnd,b);M&&c.drawImage(M,0,0,R,Y),c.save(),c.translate(0,Y);const P=u.current.render(C,S,V,I,L,b);if(P&&c.drawImage(P,0,0,R,T-Y),null!==v.view.loopStart&&null!==v.view.loopEnd&&v.view.loopEnd>v.view.loopStart){const e=C.rowToPixelX(v.view.loopStart),t=(v.view.loopEnd-v.view.loopStart)*C.pixelsPerRow;c.fillStyle="rgba(34,197,94,0.06)",c.fillRect(e,0,t,T-Y)}if(N){const e=D.getEntryForTrack(N);if(e&&e.visible){const t=C.trackYToScreenY(e.y);c.fillStyle="rgba(59, 130, 246, 0.03)",c.fillRect(0,t,R,e.bodyHeight)}}p.current.render(c,C,v.clips,v.tracks,S,k,v.selectedClipIds,l.ghostClips.length>0?l.ghostClips:null,v.playbackRow,y.isPlaying,w);const X=h.current;let B=null,O=null;if("moving-automation-point"===X.state&&X.drag&&(B=X.drag.automationLaneId??null,O=X.drag.automationPointIndex??null),x.current.render(c,C,v.automationLanes,S,B,O),l.selectionBox){const{x1:e,y1:t,x2:r,y2:o}=l.selectionBox;c.strokeStyle="#3b82f6",c.lineWidth=1,c.setLineDash([4,4]),c.strokeRect(Math.min(e,r),Math.min(t,o)-Y,Math.abs(r-e),Math.abs(o-t)),c.setLineDash([]),c.fillStyle="rgba(59,130,246,0.08)",c.fillRect(Math.min(e,r),Math.min(t,o)-Y,Math.abs(r-e),Math.abs(o-t))}if(l.drawPreview){const e=D.getEntryForTrack(l.drawPreview.trackId);if(e&&e.visible){const t=C.rowToPixelX(l.drawPreview.startRow),r=(l.drawPreview.endRow-l.drawPreview.startRow)*C.pixelsPerRow,o=C.trackYToScreenY(e.y);c.fillStyle="rgba(59,130,246,0.2)",c.strokeStyle="#3b82f6",c.lineWidth=1,c.fillRect(t,o,r,e.bodyHeight),c.strokeRect(t,o,r,e.bodyHeight)}}if("resizing-track-height"===X.state&&X.drag&&X.drag.trackId&&void 0!==X.drag.startHeight){const e=D.getEntryForTrack(X.drag.trackId);if(e){const t=X.drag.currentY-X.drag.startY,r=Math.max(30,Math.min(200,X.drag.startHeight+t)),o=C.trackYToScreenY(e.y+r);c.strokeStyle="#3b82f6",c.lineWidth=2,c.beginPath(),c.moveTo(0,o),c.lineTo(R,o),c.stroke()}}if(("moving-clips"===X.state||"drawing-clip"===X.state||"resizing-clip-start"===X.state||"resizing-clip-end"===X.state)&&v.view.snapDivision>0){const e=v.view.snapDivision;c.strokeStyle="rgba(59, 130, 246, 0.25)",c.lineWidth=1,c.setLineDash([4,4]);const t=C.getVisibleRowRange();for(let r=Math.floor(t.startRow/e)*e;r<=t.endRow;r+=e){const e=C.rowToPixelX(r);e>=0&&e<=R&&(c.beginPath(),c.moveTo(e,0),c.lineTo(e,T-Y),c.stroke())}c.setLineDash([])}if(v.isArrangementMode){const e=C.rowToPixelX(v.playbackRow);e>=-2&&e<=R+2&&(c.fillStyle="rgba(239,68,68,0.15)",c.fillRect(e-3,0,8,T-Y),c.fillStyle="#ef4444",c.fillRect(e,0,2,T-Y))}if(c.restore(),v.isArrangementMode){const e=C.rowToPixelX(v.playbackRow);e>=-6&&e<=R+6&&(c.fillStyle="#ef4444",c.beginPath(),c.moveTo(e+1,Y),c.lineTo(e-5,29),c.lineTo(e+7,29),c.closePath(),c.fill(),c.fillStyle="rgba(239,68,68,0.5)",c.fillRect(e,0,1,Y))}n.style.cursor!==l.cursor&&(n.style.cursor=l.cursor)};return i.current=requestAnimationFrame(o),()=>cancelAnimationFrame(i.current)},[]);const R=l.useCallback(e=>{const r=t.current;if(!r)return{x:0,y:0};const o=r.getBoundingClientRect();return{x:e.clientX-o.left,y:e.clientY-o.top}},[]),T=l.useCallback(t=>{const{x:o,y:n}=R(t),i=d.current,s=m.current,l=h.current,c=e.getState(),u=x.current.hitTest(o,n-Y,i,c.automationLanes,s.getEntries()),p=f.current.hitTest(o,n,i,s,Y,c.view.loopStart,c.view.loopEnd,u);if("ruler"===p.type)return l.beginDrag("moving-playhead",o,n,p.row,0,null,c.selectedClipIds,[]),e.getState().setPlaybackRow(p.row),void r.getState().setCurrentGlobalRow(p.row);if("loop-start"===p.type){const e=c.view.loopEnd;return l.beginDrag("moving-loop-start",o,n,p.row,0,null,c.selectedClipIds,[]),void(l.drag&&(l.drag.loopStart=p.row,l.drag.loopEnd=e??void 0))}if("loop-end"===p.type){const e=c.view.loopStart;return l.beginDrag("moving-loop-end",o,n,p.row,0,null,c.selectedClipIds,[]),void(l.drag&&(l.drag.loopStart=e??void 0,l.drag.loopEnd=p.row))}if("track-resize"===p.type){const e=s.getEntryForTrack(p.trackId);return void(e&&(l.beginDrag("resizing-track-height",o,n,0,0,null,c.selectedClipIds,[]),l.drag&&(l.drag.trackId=p.trackId,l.drag.startHeight=e.bodyHeight)))}if("automation-point"===p.type){C.current={laneId:p.laneId,pointIndex:p.pointIndex};const e=c.automationLanes.find(e=>e.id===p.laneId);if(e&&e.points[p.pointIndex]){const t=e.points[p.pointIndex];l.beginDrag("moving-automation-point",o,n,0,0,null,c.selectedClipIds,[]),l.drag&&(l.drag.automationLaneId=p.laneId,l.drag.automationPointIndex=p.pointIndex,l.drag.automationStartValue=t.value,l.drag.automationStartRow=t.row)}return}if("automation-segment"===p.type){const e={row:p.row,value:p.value,curve:"linear"};c.addAutomationPoint(p.laneId,e);if(c.automationLanes.find(e=>e.id===p.laneId)){const e=p.insertAfterIndex+1;l.beginDrag("moving-automation-point",o,n,0,0,null,c.selectedClipIds,[]),l.drag&&(l.drag.automationLaneId=p.laneId,l.drag.automationPointIndex=e,l.drag.automationStartValue=p.value,l.drag.automationStartRow=p.row)}return}if("select"===l.tool)if("clip"===p.type)if("body"===p.zone){if(t.metaKey||t.ctrlKey)return void c.selectClip(p.clipId,!0);if(t.shiftKey?c.selectClip(p.clipId,!0):c.selectedClipIds.has(p.clipId)||c.selectClip(p.clipId),t.altKey){const t=e.getState().selectedClipIds,r=c.duplicateClips([...t]);c.clearSelection(),c.selectClips(r);const i=c.clips.filter(e=>r.includes(e.id));l.beginDrag("moving-clips",o,n,p.row,0,r[0],new Set(r),i),b.current.begin(c.getSnapshot(),"Duplicate and move clips")}else{const t=e.getState().selectedClipIds,r=c.clips.filter(e=>t.has(e.id));l.beginDrag("moving-clips",o,n,p.row,0,p.clipId,t,r),b.current.begin(c.getSnapshot(),"Move clips")}}else"resize-start"===p.zone?(c.selectClip(p.clipId),l.beginDrag("resizing-clip-start",o,n,p.row,0,p.clipId,c.selectedClipIds,[]),b.current.begin(c.getSnapshot(),"Resize clip start")):"resize-end"===p.zone&&(c.selectClip(p.clipId),l.beginDrag("resizing-clip-end",o,n,p.row,0,p.clipId,c.selectedClipIds,[]),b.current.begin(c.getSnapshot(),"Resize clip end"));else"empty"===p.type&&(t.shiftKey||c.clearSelection(),l.beginDrag("select-box",o,n,p.row,p.trackIndex,null,c.selectedClipIds,[]));else if("draw"===l.tool){if("empty"===p.type){const e=c.view.snapDivision||1,t=i.snapRow(p.row,e);l.beginDrag("drawing-clip",o,n,t,p.trackIndex,null,c.selectedClipIds,[]),l.setDrawPreview({trackId:p.trackId,startRow:t,endRow:t+e})}}else if("erase"===l.tool)"clip"===p.type&&(b.current.begin(c.getSnapshot(),"Erase clip"),c.removeClip(p.clipId),b.current.commit(t=>e.getState().pushUndo(t)));else if("split"===l.tool&&"clip"===p.type){const t=c.view.snapDivision||1,r=i.snapRow(p.row,t);b.current.begin(c.getSnapshot(),"Split clip"),c.splitClip(p.clipId,r),b.current.commit(t=>e.getState().pushUndo(t))}a.current=!0},[R]),S=l.useCallback(t=>{const{x:o,y:n}=R(t),i=d.current,s=m.current,l=h.current;if("idle"!==l.state&&l.drag){l.updateDrag(o,n);const t=e.getState(),a=t.view.snapDivision||1;if("moving-clips"===l.state){const{deltaRow:e,deltaTrackIndex:r}=l.getDragDelta(i.pixelsPerRow,80),o=Math.round(e/a)*a,n=[...t.tracks].sort((e,t)=>e.index-t.index),s=l.drag.originalClips.map(e=>{const i=t.tracks.find(t=>t.id===e.trackId);let s=e.trackId;if(i&&0!==r){const e=Math.max(0,Math.min(n.length-1,i.index+r)),t=n[e];t&&(s=t.id)}return{...e,startRow:Math.max(0,e.startRow+o),trackId:s}});l.setGhostClips(s)}else if("select-box"===l.state){l.setSelectionBox({x1:l.drag.startX,y1:l.drag.startY,x2:o,y2:n});const e=f.current.findClipsInRect(l.drag.startX,l.drag.startY-Y,o,n-Y);t.selectClips(e)}else if("drawing-clip"===l.state){const e=Math.max(0,i.snapRow(i.pixelXToRow(o),a)),t=l.drag.startRow;l.setDrawPreview({trackId:"",startRow:Math.min(t,e),endRow:Math.max(t+a,e)})}else if("resizing-clip-end"===l.state){const e=Math.max(1,i.snapRow(i.pixelXToRow(o),a));l.drag.targetClipId&&t.resizeClipEnd(l.drag.targetClipId,e)}else if("resizing-clip-start"===l.state){const e=Math.max(0,i.snapRow(i.pixelXToRow(o),a));l.drag.targetClipId&&t.resizeClipStart(l.drag.targetClipId,e)}else if("moving-playhead"===l.state){const e=Math.max(0,Math.round(i.pixelXToRow(o)));t.setPlaybackRow(e),r.getState().setCurrentGlobalRow(e)}else if("moving-automation-point"===l.state&&l.drag&&l.drag.automationLaneId&&void 0!==l.drag.automationPointIndex){const e=Math.max(0,Math.round(i.pixelXToRow(o))),r=t.automationLanes.find(e=>e.id===l.drag.automationLaneId);if(r){const o=s.getEntryForTrack(r.trackId);if(o){const s=t.automationLanes.filter(e=>e.trackId===r.trackId&&e.visible&&e.enabled).findIndex(e=>e.id===r.id);if(s>=0){const r=40,a=i.trackYToScreenY(o.automationY)+s*r,c=r,d=Math.max(0,Math.min(1,(a+c-(n-Y))/c));t.moveAutomationPoint(l.drag.automationLaneId,l.drag.automationPointIndex,e,d)}}}}}else{const t=e.getState(),r=x.current.hitTest(o,n-Y,i,t.automationLanes,s.getEntries()),a=f.current.hitTest(o,n,i,s,Y,t.view.loopStart,t.view.loopEnd,r);l.updateCursor(a),"clip"===a.type&&a.clipId!==w?y(a.clipId):"clip"!==a.type&&null!==w&&y(null);const c=("empty"===a.type||"clip"===a.type||"track-resize"===a.type)&&("track-resize"===a.type||"trackId"in a)?a.trackId:null;c!==N&&k(c)}a.current=!0},[R,w,N]),L=l.useCallback(t=>{const r=h.current,o=e.getState();if("moving-clips"===r.state&&r.drag){const e=o.view.snapDivision||1,{deltaRow:t,deltaTrackIndex:n}=r.getDragDelta(d.current.pixelsPerRow,80),i=Math.round(t/e)*e;0!==i||0!==n?(o.moveClips([...o.selectedClipIds],i,n),b.current.commit(e=>o.pushUndo(e)),v.current=!0,setTimeout(()=>{v.current=!1},100)):b.current.cancel()}else if("drawing-clip"===r.state&&r.drag){const e=d.current,n=o.view.snapDivision||1,i=Math.max(0,e.snapRow(e.pixelXToRow(R(t).x),n)),a=Math.min(r.drag.startRow,i),l=Math.max(r.drag.startRow+n,i),c=e.screenYToTrackY(R(t).y-Y),u=m.current.hitTestY(c);if(u){const e=s.getState().patterns;e.length>0&&(b.current.begin(o.getSnapshot(),"Draw clip"),o.addClip({patternId:e[0].id,trackId:u.trackId,startRow:a,offsetRows:0,clipLengthRows:l-a,sourceChannelIndex:0,color:null,muted:!1}),b.current.commit(e=>o.pushUndo(e)))}}else if("resizing-clip-start"===r.state||"resizing-clip-end"===r.state)b.current.commit(e=>o.pushUndo(e));else if("resizing-track-height"===r.state&&r.drag){const{trackId:e,startHeight:t}=r.drag;if(e&&void 0!==t){const n=r.drag.currentY-r.drag.startY,i=Math.max(30,Math.min(200,t+n));o.setTrackHeight(e,i)}}else if("moving-loop-start"===r.state&&r.drag){const{loopEnd:e}=r.drag,t=d.current,n=o.view.snapDivision||1,i=t.snapRow(t.pixelXToRow(r.drag.currentX),n);o.setLoopRegion(i,e??null)}else if("moving-loop-end"===r.state&&r.drag){const{loopStart:e}=r.drag,t=d.current,n=o.view.snapDivision||1,i=t.snapRow(t.pixelXToRow(r.drag.currentX),n);o.setLoopRegion(e??null,i)}else r.state;r.endDrag(),a.current=!0},[R]),X=l.useCallback(t=>{if(v.current)return void(v.current=!1);const{x:r,y:o}=R(t),n=d.current,i=m.current,a=e.getState(),l=f.current.hitTest(r,o,n,i,Y,a.view.loopStart,a.view.loopEnd);if("clip"===l.type){const t=e.getState().clips.find(e=>e.id===l.clipId);if(!t)return;require("@stores/useUIStore").useUIStore.getState().setActiveView("tracker");const r=s.getState().patterns.findIndex(e=>e.id===t.patternId);r>=0&&s.getState().setCurrentPattern(r)}},[R]);return l.useEffect(()=>{const e=()=>{const e=h.current;"idle"!==e.state&&(e.endDrag(),a.current=!0)};return window.addEventListener("mouseup",e),()=>window.removeEventListener("mouseup",e)},[]),l.useEffect(()=>{const r=t=>{if("Delete"===t.key||"Backspace"===t.key){const r=C.current;if(r){e.getState().removeAutomationPoint(r.laneId,r.pointIndex),C.current=null,a.current=!0,t.preventDefault()}}},o=t.current;if(o)return o.tabIndex=0,o.addEventListener("keydown",r),()=>o.removeEventListener("keydown",r)},[]),l.useEffect(()=>{const r=t.current;if(!r)return;const o=t=>{t.preventDefault();const r=e.getState();if(t.ctrlKey||t.metaKey){const e=t.deltaY>0?.9:1.1;r.setPixelsPerRow(Math.max(.5,Math.min(32,r.view.pixelsPerRow*e)))}else t.shiftKey?r.setScrollRow(Math.max(0,r.view.scrollRow+t.deltaY/r.view.pixelsPerRow)):r.setScrollY(Math.max(0,r.view.scrollY+t.deltaY));a.current=!0};return r.addEventListener("wheel",o,{passive:!1}),()=>r.removeEventListener("wheel",o)},[]),n.jsxDEV("div",{ref:o,className:"flex-1 relative overflow-hidden",children:n.jsxDEV("canvas",{ref:t,className:"absolute inset-0 w-full h-full",onMouseDown:T,onMouseMove:S,onMouseUp:L,onDoubleClick:X},void 0,!1,{fileName:"/Users/spot/Code/DEViLBOX/src/components/arrangement/ArrangementCanvas.tsx",lineNumber:825,columnNumber:7},void 0)},void 0,!1,{fileName:"/Users/spot/Code/DEViLBOX/src/components/arrangement/ArrangementCanvas.tsx",lineNumber:824,columnNumber:5},void 0)},K=["#ef4444","#f97316","#f59e0b","#eab308","#84cc16","#22c55e","#10b981","#14b8a6","#06b6d4","#0ea5e9","#3b82f6","#6366f1","#8b5cf6","#a855f7","#d946ef","#ec4899"],F=({x:t,y:r,clipId:o,trackId:i,row:s,onClose:a})=>{const{removeClips:l,duplicateClips:c,toggleClipMute:d,setClipColor:m,splitClip:u,selectAllClipsOnTrack:p,selectedClipIds:g,pushUndo:f}=e(),h=e=>{f(),e(),a()};return n.jsxDEV("div",{className:"fixed z-50 bg-dark-bgSecondary border border-dark-border rounded-lg shadow-xl py-1 text-xs min-w-[160px]",style:{left:t,top:r},onMouseDown:e=>e.stopPropagation(),children:[o&&n.jsxDEV(n.Fragment,{children:[n.jsxDEV(G,{label:"Duplicate",onClick:()=>h(()=>c([...g]))},void 0,!1,{fileName:"/Users/spot/Code/DEViLBOX/src/components/arrangement/ArrangementContextMenu.tsx",lineNumber:46,columnNumber:11},void 0),n.jsxDEV(G,{label:"Split at Cursor",onClick:()=>h(()=>u(o,s))},void 0,!1,{fileName:"/Users/spot/Code/DEViLBOX/src/components/arrangement/ArrangementContextMenu.tsx",lineNumber:47,columnNumber:11},void 0),n.jsxDEV(G,{label:"Mute/Unmute",onClick:()=>h(()=>d(o))},void 0,!1,{fileName:"/Users/spot/Code/DEViLBOX/src/components/arrangement/ArrangementContextMenu.tsx",lineNumber:48,columnNumber:11},void 0),n.jsxDEV(W,{},void 0,!1,{fileName:"/Users/spot/Code/DEViLBOX/src/components/arrangement/ArrangementContextMenu.tsx",lineNumber:49,columnNumber:11},void 0),n.jsxDEV("div",{className:"px-2 py-2",children:[n.jsxDEV("div",{className:"text-[10px] text-text-muted mb-1",children:"Clip Color"},void 0,!1,{fileName:"/Users/spot/Code/DEViLBOX/src/components/arrangement/ArrangementContextMenu.tsx",lineNumber:51,columnNumber:13},void 0),n.jsxDEV("div",{className:"grid grid-cols-8 gap-1",children:K.map(e=>n.jsxDEV("button",{className:"w-6 h-6 rounded border border-dark-border hover:scale-110 transition-transform",style:{backgroundColor:e},onClick:()=>{h(()=>m(o,e))}},e,!1,{fileName:"/Users/spot/Code/DEViLBOX/src/components/arrangement/ArrangementContextMenu.tsx",lineNumber:54,columnNumber:17},void 0))},void 0,!1,{fileName:"/Users/spot/Code/DEViLBOX/src/components/arrangement/ArrangementContextMenu.tsx",lineNumber:52,columnNumber:13},void 0)]},void 0,!0,{fileName:"/Users/spot/Code/DEViLBOX/src/components/arrangement/ArrangementContextMenu.tsx",lineNumber:50,columnNumber:11},void 0),n.jsxDEV(W,{},void 0,!1,{fileName:"/Users/spot/Code/DEViLBOX/src/components/arrangement/ArrangementContextMenu.tsx",lineNumber:65,columnNumber:11},void 0),n.jsxDEV(G,{label:"Delete",onClick:()=>h(()=>l([...g])),danger:!0},void 0,!1,{fileName:"/Users/spot/Code/DEViLBOX/src/components/arrangement/ArrangementContextMenu.tsx",lineNumber:66,columnNumber:11},void 0)]},void 0,!0,{fileName:"/Users/spot/Code/DEViLBOX/src/components/arrangement/ArrangementContextMenu.tsx",lineNumber:45,columnNumber:9},void 0),i&&!o&&n.jsxDEV(n.Fragment,{children:n.jsxDEV(G,{label:"Select All on Track",onClick:()=>{p(i),a()}},void 0,!1,{fileName:"/Users/spot/Code/DEViLBOX/src/components/arrangement/ArrangementContextMenu.tsx",lineNumber:72,columnNumber:11},void 0)},void 0,!1,{fileName:"/Users/spot/Code/DEViLBOX/src/components/arrangement/ArrangementContextMenu.tsx",lineNumber:71,columnNumber:9},void 0),!o&&!i&&n.jsxDEV("div",{className:"px-3 py-1 text-text-muted italic",children:"No selection"},void 0,!1,{fileName:"/Users/spot/Code/DEViLBOX/src/components/arrangement/ArrangementContextMenu.tsx",lineNumber:77,columnNumber:9},void 0)]},void 0,!0,{fileName:"/Users/spot/Code/DEViLBOX/src/components/arrangement/ArrangementContextMenu.tsx",lineNumber:39,columnNumber:5},void 0)},G=({label:e,onClick:t,danger:r})=>n.jsxDEV("button",{className:"w-full px-3 py-1.5 text-left hover:bg-dark-bgTertiary "+(r?"text-red-400 hover:text-red-300":"text-text-primary"),onClick:t,children:e},void 0,!1,{fileName:"/Users/spot/Code/DEViLBOX/src/components/arrangement/ArrangementContextMenu.tsx",lineNumber:86,columnNumber:3},void 0),W=()=>n.jsxDEV("div",{className:"my-1 border-t border-dark-border"},void 0,!1,{fileName:"/Users/spot/Code/DEViLBOX/src/components/arrangement/ArrangementContextMenu.tsx",lineNumber:97,columnNumber:3},void 0),q=()=>{!function(){const n=l.useCallback((o,n)=>{const{selectedClipIds:i,removeClips:s,duplicateClips:a,moveClips:l,setTool:c,undo:d,redo:m}=e.getState(),u=n.key,p=n.ctrlKey||n.metaKey;if(("Delete"===u||"Backspace"===u)&&i.size>0)return n.preventDefault(),s([...i]),!0;if(p&&"d"===u.toLowerCase()&&i.size>0)return n.preventDefault(),a([...i]),!0;if(p&&"z"===u.toLowerCase()&&!n.shiftKey)return n.preventDefault(),d(),!0;if(p&&n.shiftKey&&"z"===u.toLowerCase()||p&&"y"===u.toLowerCase())return n.preventDefault(),m(),!0;if(("ArrowLeft"===u||"ArrowRight"===u)&&i.size>0){n.preventDefault();const e="ArrowLeft"===u?-1:1;return l([...i],e,0),!0}if(("ArrowUp"===u||"ArrowDown"===u)&&i.size>0){n.preventDefault();const e="ArrowUp"===u?-1:1;return l([...i],0,e),!0}if("s"===u.toLowerCase()&&!p)return c("select"),t.getState().setStatusMessage("Tool: Select",!1,800),!0;if("p"===u.toLowerCase()&&!p)return c("draw"),t.getState().setStatusMessage("Tool: Draw",!1,800),!0;if("e"===u.toLowerCase()&&!p)return c("erase"),t.getState().setStatusMessage("Tool: Erase",!1,800),!0;if(" "===u){n.preventDefault();const e=r.getState();return e.isPlaying?e.stop():e.play(),!0}return!1},[]);l.useEffect(()=>o("arrangement",n),[n])}();const{tracks:i,groups:d,automationLanes:m,view:u,setTool:p,selectedClipIds:g,removeClips:f,duplicateClips:h,clearSelection:b,selectAllClipsOnTrack:x,pushUndo:v,undo:w,redo:y,importFromPatternOrder:N,isArrangementMode:k,setIsArrangementMode:C}=e(),D=r(e=>e.isPlaying),E=l.useRef(!1),T=l.useRef(!1);l.useEffect(()=>{if(E.current)return;if(i.length>0)return;const{patternOrder:e,patterns:t}=s.getState();t.length>0&&e.length>0&&(E.current=!0,N(e,t),a.success("Converted pattern order to arrangement"))},[i.length,N]),l.useEffect(()=>{T.current||0===i.length||(T.current=!0,e.getState().zoomToFit())},[i.length]),l.useEffect(()=>{!k&&i.length>0&&(C(!0),a.info("Arrangement mode enabled"))},[k,C,i.length]),l.useEffect(()=>{if(!D||!k)return;const t=requestAnimationFrame(function t(){const o=r.getState().currentGlobalRow;e.getState().setPlaybackRow(o),r.getState().isPlaying&&e.getState().isArrangementMode&&requestAnimationFrame(t)});return()=>cancelAnimationFrame(t)},[D,k]);const V=l.useMemo(()=>{const e=i.slice().sort((e,t)=>e.index-t.index),t=[];let r=0;for(let o=0;o<e.length;o++){const n=e[o],i=n.groupId?d.find(e=>e.id===n.groupId):null,s=!i||!i.collapsed&&!i.folded,a=m.filter(e=>e.trackId===n.id&&e.visible),l=n.automationVisible?40*a.length:0,c=n.collapsed?24:n.height,u=c+l;t.push({trackId:n.id,trackIndex:o,y:r,height:s?u:0,bodyHeight:s?c:0,automationY:r+(s?c:0),automationHeight:s?l:0,visible:s}),s&&(r+=u+1)}return t},[i,d,m]),[I,L]=c.useState(null),M=l.useRef(null),P=l.useCallback(t=>{if("INPUT"===t.target?.tagName||"SELECT"===t.target?.tagName)return;const r=t.ctrlKey||t.metaKey;if(!r&&!t.shiftKey)switch(t.key.toLowerCase()){case"v":return p("select"),void t.preventDefault();case"d":return p("draw"),void t.preventDefault();case"e":return p("erase"),void t.preventDefault();case"s":return p("split"),void t.preventDefault()}if(("Delete"===t.key||"Backspace"===t.key)&&g.size>0)return v(),f([...g]),void t.preventDefault();if(r&&"a"===t.key){const r=e.getState().selectedTrackId;if(r)return x(r),void t.preventDefault()}return r&&"d"===t.key&&g.size>0?(v(),h([...g]),void t.preventDefault()):r&&"z"===t.key&&!t.shiftKey?(w(),void t.preventDefault()):r&&"z"===t.key&&t.shiftKey?(y(),void t.preventDefault()):void("Escape"===t.key&&(b(),L(null),t.preventDefault()))},[g,p,f,h,b,x,v,w,y]);l.useEffect(()=>(window.addEventListener("keydown",P),()=>window.removeEventListener("keydown",P)),[P]);const X=l.useCallback(e=>{e.preventDefault(),L({x:e.clientX,y:e.clientY,clipId:1===g.size?[...g][0]:null,trackId:null,row:0})},[g]);return l.useEffect(()=>{if(!I)return;const e=()=>L(null);return window.addEventListener("mousedown",e),()=>window.removeEventListener("mousedown",e)},[I]),n.jsxDEV("div",{ref:M,className:"flex flex-col h-full bg-dark-bg",onContextMenu:X,children:[n.jsxDEV(R,{},void 0,!1,{fileName:"/Users/spot/Code/DEViLBOX/src/components/arrangement/ArrangementView.tsx",lineNumber:237,columnNumber:7},void 0),n.jsxDEV("div",{className:"flex flex-1 overflow-hidden",children:[n.jsxDEV(S,{tracks:i,groups:d,entries:V,scrollY:u.scrollY},void 0,!1,{fileName:"/Users/spot/Code/DEViLBOX/src/components/arrangement/ArrangementView.tsx",lineNumber:242,columnNumber:9},void 0),n.jsxDEV(H,{},void 0,!1,{fileName:"/Users/spot/Code/DEViLBOX/src/components/arrangement/ArrangementView.tsx",lineNumber:250,columnNumber:9},void 0)]},void 0,!0,{fileName:"/Users/spot/Code/DEViLBOX/src/components/arrangement/ArrangementView.tsx",lineNumber:240,columnNumber:7},void 0),I&&n.jsxDEV(F,{x:I.x,y:I.y,clipId:I.clipId,trackId:I.trackId,row:I.row,onClose:()=>L(null)},void 0,!1,{fileName:"/Users/spot/Code/DEViLBOX/src/components/arrangement/ArrangementView.tsx",lineNumber:255,columnNumber:9},void 0)]},void 0,!0,{fileName:"/Users/spot/Code/DEViLBOX/src/components/arrangement/ArrangementView.tsx",lineNumber:231,columnNumber:5},void 0)},J=({group:t})=>{const{toggleGroupCollapse:r}=e();return n.jsxDEV("div",{className:"flex items-center gap-1.5 px-2 py-1 border-b border-dark-border bg-dark-bgTertiary select-none cursor-pointer hover:bg-dark-border/50",onClick:()=>r(t.id),children:[t.collapsed?n.jsxDEV(k,{size:12,className:"text-text-muted"},void 0,!1,{fileName:"/Users/spot/Code/DEViLBOX/src/components/arrangement/TrackGroupHeader.tsx",lineNumber:23,columnNumber:9},void 0):n.jsxDEV(C,{size:12,className:"text-text-muted"},void 0,!1,{fileName:"/Users/spot/Code/DEViLBOX/src/components/arrangement/TrackGroupHeader.tsx",lineNumber:25,columnNumber:9},void 0),n.jsxDEV("div",{className:"w-2 h-2 rounded-full flex-shrink-0",style:{backgroundColor:t.color||"#888"}},void 0,!1,{fileName:"/Users/spot/Code/DEViLBOX/src/components/arrangement/TrackGroupHeader.tsx",lineNumber:27,columnNumber:7},void 0),n.jsxDEV("span",{className:"text-xs font-medium text-text-primary truncate flex-1",children:t.name},void 0,!1,{fileName:"/Users/spot/Code/DEViLBOX/src/components/arrangement/TrackGroupHeader.tsx",lineNumber:31,columnNumber:7},void 0),n.jsxDEV("span",{className:"text-[9px] text-text-muted",children:t.collapsed?"...":""},void 0,!1,{fileName:"/Users/spot/Code/DEViLBOX/src/components/arrangement/TrackGroupHeader.tsx",lineNumber:34,columnNumber:7},void 0)]},void 0,!0,{fileName:"/Users/spot/Code/DEViLBOX/src/components/arrangement/TrackGroupHeader.tsx",lineNumber:18,columnNumber:5},void 0)};export{H as ArrangementCanvas,F as ArrangementContextMenu,R as ArrangementToolbar,q as ArrangementView,J as TrackGroupHeader,T as TrackHeader,S as TrackHeaderPanel};
