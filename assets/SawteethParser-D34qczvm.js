function n(n,t){return n[t]}function t(n){return n<128?n:n-256}function e(n,t){return n[t]<<8|n[t+1]}function l(n,t){let e="";for(;t<n.length;){const l=n[t++];if(0===l||10===l)break;13!==l&&(e+=String.fromCharCode(l))}return{str:e,nextOff:t}}function r(n){return!(n.length<10)&&(83===n[0]&&87===n[1]&&84===n[2]&&68===n[3])}function o(o,u){if(!r(o))return null;let i=4;if(i+2>o.length)return null;const f=e(o,i);if(i+=2,f>1200)return null;let a;if(f<900)a=882;else{if(i+2>o.length)return null;a=e(o,i),i+=2}if(f>=900&&a<1)return null;if(i>=o.length)return null;const p=n(o,i++);if(p<1||p>12)return null;const h=[];for(let l=0;l<p;l++){if(i+4>o.length)return null;const l=n(o,i++),r=n(o,i++),s=e(o,i);let u,a;if(i+=2,f<910)u=0;else{if(i+2>o.length)return null;u=e(o,i),i+=2}if(f<1200)a=s-1;else{if(i+2>o.length)return null;a=e(o,i),i+=2}if(s<1||s>8192)return null;const p=a>=s?s-1:a,c=[];for(let e=0;e<s;e++){if(i+3>o.length)return null;const e=n(o,i++),l=t(o[i++]),r=n(o,i++);c.push({part:e,transp:l,dAmp:r})}h.push({left:l,right:r,len:s,lLoop:u,rLoop:p,steps:c})}if(i>=o.length)return null;const c=n(o,i++);if(c<1)return null;const m=[];for(let t=0;t<c;t++){if(i+2>o.length)return null;const t=n(o,i++);if(t<1)return null;const e=n(o,i++);if(e<1)return null;const l=[];for(let r=0;r<e;r++){if(i+3>o.length)return null;const t=n(o,i++),e=n(o,i++),r=n(o,i++);l.push({ins:t,eff:e,note:r})}m.push({sps:t,len:e,steps:l,name:""})}for(let n=0;n<p;n++)for(let t=0;t<h[n].len;t++)h[n].steps[t].part>=c&&(h[n].steps[t].part=c-1);if(i>=o.length)return null;const g=n(o,i++)+1;if(g<2)return null;const d=[{filterPoints:1,filter:[{time:0,lev:0}],ampPoints:1,amp:[{time:0,lev:0}],filterMode:0,clipMode:0,boost:1,vibS:1,vibD:1,pwmS:1,pwmD:1,res:0,sps:30,len:1,loop:0,steps:[{relative:!1,wForm:0,note:0}],name:""}];for(let t=1;t<g;t++){if(i>=o.length)return null;const t=n(o,i++);if(t<1)return null;const e=[];for(let f=0;f<t;f++){if(i+2>o.length)return null;e.push({time:n(o,i++),lev:n(o,i++)})}if(i>=o.length)return null;const l=n(o,i++);if(l<1)return null;const r=[];for(let f=0;f<l;f++){if(i+2>o.length)return null;r.push({time:n(o,i++),lev:n(o,i++)})}if(i+8>o.length)return null;const s=n(o,i++),u=n(o,i++),a=15&u,p=u>>4&15,h=n(o,i++),c=n(o,i++),m=n(o,i++),g=n(o,i++),v=n(o,i++),S=n(o,i++);if(S<1)return null;let y,C;if(f<900){if(i>=o.length)return null;const t=n(o,i++);y=127&t,C=1&t?0:y>0?y-1:0}else{if(i+2>o.length)return null;if(y=n(o,i++),C=n(o,i++),y<1||C>=y)return null}if(y<1)return null;const M=[];for(let f=0;f<y;f++){if(i+2>o.length)return null;const t=n(o,i++),e=n(o,i++);M.push({relative:!!(128&t),wForm:15&t,note:e})}d.push({filterPoints:t,filter:e,ampPoints:l,amp:r,filterMode:s,clipMode:p,boost:a,vibS:h,vibD:c,pwmS:m,pwmD:g,res:v,sps:S,len:y,loop:C,steps:M,name:""})}if(i>=o.length)return null;const v=n(o,i++);for(let n=0;n<v&&!(i+8>o.length);n++)i+=8;let S=u.replace(/\.[^/.]+$/,"");if(i<o.length){const n=l(o,i);n.str&&(S=n.str),i=n.nextOff}if(i<o.length){i=l(o,i).nextOff}for(let n=0;n<c&&i<o.length;n++){const t=l(o,i);m[n].name=t.str,i=t.nextOff}for(let n=1;n<g&&i<o.length;n++){const t=l(o,i);d[n].name=t.str,i=t.nextOff}const y=[];for(let n=1;n<g;n++){const t=d[n];y.push({id:n,name:t.name||`Instrument ${n}`,type:"synth",synthType:"Synth",effects:[],volume:0,pan:0})}const C=[];for(let n=0;n<p;n++){const t=h[n],e=[];for(let n=0;n<=t.rLoop;n++){const l=t.steps[n],r=l.part<c?l.part:c-1,o=m[r];for(let n=0;n<o.len;n++){const t=o.steps[n];let s=t.note;s>0&&(s=Math.max(1,Math.min(96,s+l.transp))),e.push({ins:t.ins,eff:t.eff,note:s,partIdx:r})}}C.push(e)}const M=Math.max(...C.map(n=>n.length),1),P=Math.ceil(M/64),w=[];for(let n=0;n<P;n++){const t=64*n,e=Math.min(t+64,M)-t,l=[];for(let n=0;n<p;n++){const r=[],o=C[n];for(let n=0;n<e;n++){const e=t+n;if(e>=o.length){r.push(s());continue}const l=o[e],u=l.note,i=l.ins>0&&l.ins<g?l.ins:0;r.push({note:u,instrument:i,volume:0,effTyp:0,eff:0,effTyp2:0,eff2:0})}l.push(r)}w.push({id:`pattern-${n}`,name:`Pattern ${n}`,length:e,channels:l.map((n,t)=>{const e=h[t];return{id:`channel-${t}`,name:`Channel ${t+1}`,muted:!1,solo:!1,collapsed:!1,volume:100,pan:Math.round((e.right-e.left)/255*50),instrumentId:null,color:null,rows:n}}),importMetadata:{sourceFormat:"SAW",sourceFile:u,importedAt:(new Date).toISOString(),originalChannelCount:p,originalPatternCount:c,originalInstrumentCount:g-1}})}return 0===w.length&&w.push(function(n,t,e){return{id:"pattern-0",name:"Pattern 0",length:e,channels:Array.from({length:t},(n,t)=>({id:`channel-${t}`,name:`Channel ${t+1}`,muted:!1,solo:!1,collapsed:!1,volume:100,pan:0,instrumentId:null,color:null,rows:Array.from({length:e},()=>({note:0,instrument:0,volume:0,effTyp:0,eff:0,effTyp2:0,eff2:0}))})),importMetadata:{sourceFormat:"SAW",sourceFile:n,importedAt:(new Date).toISOString(),originalChannelCount:t,originalPatternCount:0,originalInstrumentCount:0}}}(u,p,64)),{name:S,format:"SAW",patterns:w,instruments:y,songPositions:w.map((n,t)=>t),songLength:w.length,restartPosition:0,numChannels:p,initialSpeed:6,initialBPM:125,linearPeriods:!1}}function s(){return{note:0,instrument:0,volume:0,effTyp:0,eff:0,effTyp2:0,eff2:0}}export{r as isSawteethFormat,o as parseSawteethFile};
