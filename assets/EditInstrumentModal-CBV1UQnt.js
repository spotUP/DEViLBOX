import{q as e,j as t,M as a,r as n,s as r,B as s,t as i,v as o,w as l,g as d,y as c,S as u,T as m,D as p,z as h,A as f,C as x,E as g,G as b,H as y,I as v,J as w,K as j,L as _,O as k,P as N,Q as $,R as C,U as S,V as M,W as z,b as T,X as E,Y as A,Z as I,_ as O,$ as R,a0 as V,a1 as P,n as D,a2 as B,a3 as L,a4 as F,a5 as W,a6 as U,a7 as q,a8 as H,a9 as G,aa as K,ab as X,ac as Y,ad as Z,ae as Q,af as J,ag as ee,ah as te,ai as ae,aj as ne,ak as re,al as se,am as ie,an as oe,ao as le,ap as de,aq as ce,ar as ue,as as me,at as pe}from"./index-DxMPGKEz.js";import{r as he,R as fe}from"./vendor-utils-Cm-70yv0.js";import{l as xe,aq as ge,X as be,D as ye,M as ve,C as we,R as je,aK as _e,au as ke,L as Ne,a9 as $e,aL as Ce,Z as Se,aM as Me,ac as ze,ad as Te,p as Ee,aN as Ae,m as Ie,y as Oe,o as Re,aO as Ve,K as Pe,k as De,x as Be,aP as Le,W as Fe,T as We,aJ as Ue,b as qe,d as He,V as Ge,aQ as Ke,aR as Xe,aS as Ye,aT as Ze,t as Qe,_ as Je,ax as et,aU as tt,aV as at,r as nt,c as rt,a2 as st,a3 as it,a4 as ot,aW as lt,a6 as dt,aX as ct,ay as ut,az as mt,aY as pt,aZ as ht,a_ as ft,a$ as xt,b0 as gt,Q as bt,b1 as yt,b2 as vt,b3 as wt,b4 as jt,S as _t,b5 as kt,b6 as Nt,b7 as $t,f as Ct,am as St,b8 as Mt,b9 as zt,$ as Tt,e as Et,N as At,aG as It}from"./vendor-ui-C64XGON6.js";import{Y as Ot,a5 as Rt,w as Vt}from"./vendor-tone-MhHxAwwC.js";import{u as Pt,a as Dt,D as Bt,c as Lt,S as Ft,v as Wt,s as Ut,K as qt,P as Ht,b as Gt,C as Kt}from"./sortable.esm-lxC05b89.js";import"./vendor-react-LeNVipsj.js";const Xt=["Bass","Lead","Pad","Drum","FX","User"],Yt=["acid","deep","aggressive","soft","bright","dark","punchy","smooth","distorted","clean","wet","dry"],Zt=({instrument:o,onClose:l})=>{const{savePreset:d}=e(),[c,u]=he.useState(o.name),[m,p]=he.useState("User"),[h,f]=he.useState([]),[x,g]=he.useState(""),[b,y]=he.useState(!1),v=()=>{c.trim()&&(d(o,c.trim(),m,h),b&&i(o,{name:c.trim(),category:m,tags:h,author:"DEViLBOX User",comment:`${o.synthType} preset`}),l())},w=e=>{e&&!h.includes(e)&&h.length<5&&f([...h,e]),g("")};return t.jsxs(a,{isOpen:!0,onClose:l,size:"sm",theme:"modern",backdropOpacity:"dark",closeOnBackdropClick:!0,closeOnEscape:!0,children:[t.jsx(n,{title:"Save Preset",icon:t.jsx(xe,{size:18}),onClose:l,theme:"modern"}),t.jsxs("div",{className:"p-4 space-y-4",children:[t.jsxs("div",{children:[t.jsx("label",{className:"block text-xs font-medium text-text-muted uppercase tracking-wide mb-2",children:"Preset Name"}),t.jsx("input",{type:"text",value:c,onChange:e=>u(e.target.value),onKeyDown:e=>{"Enter"===e.key&&(e.preventDefault(),v())},placeholder:"My Awesome Sound",className:"w-full px-3 py-2 bg-dark-bg border border-dark-border rounded-lg text-text-primary placeholder:text-text-muted/50 focus:outline-none focus:ring-2 focus:ring-accent-primary/50",autoFocus:!0})]}),t.jsxs("div",{children:[t.jsx("label",{className:"block text-xs font-medium text-text-muted uppercase tracking-wide mb-2",children:"Category"}),t.jsx("div",{className:"flex flex-wrap gap-2",children:Xt.map(e=>t.jsx("button",{onClick:()=>p(e),className:`\n                    px-3 py-1.5 rounded-lg text-sm font-medium transition-all\n                    ${m===e?"bg-accent-primary/20 text-accent-primary border border-accent-primary":"bg-dark-bg border border-dark-border text-text-secondary hover:text-text-primary hover:border-text-muted"}\n                  `,children:e},e))})]}),t.jsxs("div",{children:[t.jsx("label",{className:"block text-xs font-medium text-text-muted uppercase tracking-wide mb-2",children:"Tags (optional)"}),h.length>0&&t.jsx("div",{className:"flex flex-wrap gap-1 mb-2",children:h.map(e=>t.jsxs("span",{className:"flex items-center gap-1 px-2 py-1 bg-accent-primary/20 text-accent-primary rounded text-xs",children:[t.jsx(ge,{size:10}),e,t.jsx("button",{onClick:()=>(e=>{f(h.filter(t=>t!==e))})(e),className:"hover:text-accent-error ml-1",children:t.jsx(be,{size:10})})]},e))}),t.jsx("div",{className:"flex flex-wrap gap-1 mb-2",children:Yt.filter(e=>!h.includes(e)).slice(0,8).map(e=>t.jsxs("button",{onClick:()=>w(e),className:"px-2 py-1 bg-dark-bg border border-dark-border rounded text-xs text-text-muted hover:text-text-primary hover:border-text-muted transition-colors",children:["+ ",e]},e))}),t.jsxs("div",{className:"flex gap-2",children:[t.jsx("input",{type:"text",value:x,onChange:e=>g(e.target.value.toLowerCase()),onKeyDown:e=>{"Enter"===e.key&&(e.preventDefault(),w(x))},placeholder:"Add custom tag...",className:"flex-1 px-3 py-1.5 bg-dark-bg border border-dark-border rounded-lg text-sm text-text-primary placeholder:text-text-muted/50 focus:outline-none focus:ring-1 focus:ring-accent-primary/50"}),t.jsx("button",{onClick:()=>w(x),disabled:!x||h.includes(x),className:"px-3 py-1.5 bg-dark-bg border border-dark-border rounded-lg text-sm text-text-secondary hover:text-text-primary disabled:opacity-50 disabled:cursor-not-allowed",children:"Add"})]})]}),t.jsx("div",{className:"border-t border-dark-border pt-4",children:t.jsxs("label",{className:"flex items-center gap-3 cursor-pointer group",children:[t.jsx("input",{type:"checkbox",checked:b,onChange:e=>y(e.target.checked),className:"w-4 h-4 rounded border-dark-border bg-dark-bg text-accent-primary focus:ring-accent-primary/50"}),t.jsxs("div",{children:[t.jsx("div",{className:"text-sm text-text-primary group-hover:text-accent-primary transition-colors",children:"Also export as .nksf file"}),t.jsx("div",{className:"text-xs text-text-muted",children:"For Native Instruments Komplete Kontrol hardware"})]})]})}),t.jsxs("div",{className:"text-xs text-text-muted bg-dark-bg/50 rounded-lg p-3",children:[t.jsxs("p",{children:[t.jsx("span",{className:"font-medium",children:"Synth Type:"})," ",o.synthType]}),t.jsxs("p",{children:[t.jsx("span",{className:"font-medium",children:"Effects:"})," ",o.effects?.length||0," effect",1!==(o.effects?.length||0)?"s":""]})]})]}),t.jsxs(r,{theme:"modern",align:"right",children:[t.jsx(s,{variant:"ghost",onClick:l,children:"Cancel"}),t.jsxs(s,{variant:"default",onClick:()=>{c.trim()&&i(o,{name:c.trim(),category:m,tags:h,author:"DEViLBOX User",comment:`${o.synthType} preset`})},disabled:!c.trim(),title:"Download as .nksf file only (won't save to library)",children:[t.jsx(ye,{size:14,className:"mr-1"}),"Export NKS"]}),t.jsxs(s,{variant:"primary",onClick:v,disabled:!c.trim(),children:[t.jsx(xe,{size:14,className:"mr-1"}),"Save Preset"]})]})]})},Qt=({synthType:e,onChange:a})=>{const[n,r]=he.useState(!1),s=he.useRef(null),i=he.useMemo(()=>o.filter(t=>t.synthType===e),[e]);he.useEffect(()=>{const e=e=>{s.current&&!s.current.contains(e.target)&&r(!1)};return document.addEventListener("mousedown",e),()=>document.removeEventListener("mousedown",e)},[]);return 0===i.length?t.jsxs("div",{className:"flex items-center gap-2 px-3 py-1.5 rounded-lg bg-dark-bgSecondary border border-dark-border opacity-50 cursor-not-allowed text-sm",title:"No presets available for this synth type",children:[t.jsx(ve,{size:14,className:"text-text-muted"}),t.jsx("span",{className:"text-text-secondary",children:"No Presets"})]}):t.jsxs("div",{className:"relative",ref:s,children:[t.jsxs("button",{onClick:()=>r(!n),className:"flex items-center gap-2 px-3 py-1.5 rounded-lg bg-dark-bgSecondary border border-dark-border hover:border-text-muted transition-colors text-sm",children:[t.jsx(ve,{size:14,className:"text-text-muted"}),t.jsxs("span",{className:"text-text-secondary",children:["Presets (",i.length,")"]}),t.jsx(we,{size:14,className:"text-text-muted transition-transform "+(n?"rotate-180":"")})]}),n&&t.jsxs("div",{className:"absolute top-full right-0 mt-1 w-64 bg-dark-bgSecondary border border-dark-border rounded-lg shadow-xl z-50 overflow-hidden",children:[t.jsx("div",{className:"p-2 border-b border-dark-border bg-dark-bgTertiary flex items-center justify-between",children:t.jsxs("span",{className:"text-[10px] font-bold text-text-muted uppercase tracking-wider",children:[l(e).name," Presets"]})}),t.jsx("div",{className:"max-h-80 overflow-y-auto scrollbar-ft2",children:i.map((e,n)=>t.jsxs("button",{onClick:()=>(e=>{const{name:t,type:n,synthType:s,...i}=e;a(i),r(!1)})(e),className:"w-full px-3 py-2 text-left hover:bg-dark-bgTertiary transition-colors border-b border-dark-border/50 last:border-b-0 flex flex-col gap-0.5",children:[t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx("span",{className:"text-sm font-bold text-text-primary truncate",children:e.name}),e.effects&&e.effects.length>0&&t.jsx(ge,{size:10,className:"text-green-400"})]}),t.jsxs("div",{className:"flex items-center justify-between text-[10px]",children:[t.jsx("span",{className:"text-text-muted uppercase font-mono",children:e.synthType}),e.effects&&e.effects.length>0&&t.jsxs("span",{className:"text-green-500/70",children:["+",e.effects.length," FX"]})]})]},`${e.name}-${n}`))})]})]})},Jt={TB303:{overview:'The TB-303 is the legendary acid bass synthesizer. It creates squelchy, resonant bass lines\nby sweeping a low-pass filter with high resonance. The filter envelope "envelope mod" (Env Mod) determines\nhow much the filter opens on each note, while resonance adds that characteristic "acid" squelch.',keyParameters:[{name:"Cutoff",description:"Base filter frequency. Lower = darker, higher = brighter."},{name:"Resonance",description:"Filter emphasis at cutoff. High values create the classic acid squelch."},{name:"Env Mod",description:"How much the envelope opens the filter. The key to acid sound."},{name:"Decay",description:"How quickly the filter closes after note attack."},{name:"Accent",description:"Velocity sensitivity - accented notes are louder and brighter."},{name:"Slide",description:"Portamento time - creates the classic 303 slide between notes."}],tips:["Start with high resonance (70-90%) and medium env mod (50-70%) for classic acid.","Use short decay (100-300ms) for plucky bass, longer (500ms+) for smoother lines.","The 303 is monophonic - use single notes, not chords.","Accent certain notes in your pattern for rhythmic variation.","Enable slide between notes for smooth glides - essential for acid."],trackerUsage:"Use note slides (3xx) and volume commands for accent variation."},MonoSynth:{overview:"A classic monophonic synthesizer with a single oscillator, filter, and ADSR envelopes.\nPerfect for bass lines and lead melodies. The portamento (glide) lets notes slide smoothly into each other.",keyParameters:[{name:"Waveform",description:"Oscillator shape: Saw (bright), Square (hollow), Triangle (soft), Sine (pure)."},{name:"Filter Frequency",description:"Cutoff frequency of the low-pass filter."},{name:"Filter Q",description:"Resonance/emphasis at the cutoff frequency."},{name:"Portamento",description:"Time to glide between notes. 0 = instant."},{name:"ADSR",description:"Attack, Decay, Sustain, Release - shapes the amplitude over time."}],tips:["Saw waves are great for bass and cutting leads.","Square waves work well for hollow bass and chiptune-style sounds.","Use portamento for smooth legato lines.","Keep attack short (0-20ms) for punchy bass."],trackerUsage:"Use portamento effect (3xx) for glides between notes."},Synth:{overview:"A basic polyphonic synthesizer that can play multiple notes simultaneously.\nSimple but versatile, great for chords and pads.",keyParameters:[{name:"Waveform",description:"Base oscillator shape - determines the raw tone character."},{name:"Detune",description:"Slight pitch offset in cents for thickness."},{name:"ADSR",description:"Envelope controlling volume shape of each note."}],tips:["Use longer attack and release for smooth pads.","Add slight detune (5-15 cents) for a fuller sound.","Works well layered with other synths."]},DuoSynth:{overview:"Two oscillators with independent settings that can be mixed together.\nCreates rich, harmonically complex sounds through the interplay of two voices.",keyParameters:[{name:"Voice 0/1 Frequency",description:"Pitch multiplier for each oscillator (1 = unison)."},{name:"Harmonicity",description:"Frequency ratio between voices. Integer values = consonant, fractional = dissonant."},{name:"Vibrato Rate/Depth",description:"LFO modulating pitch for expressive wobble."}],tips:["Set harmonicity to 0.5 for sub-octave thickness.","Use harmonicity of 2 for octave doubling.","Slight vibrato adds life to sustained notes.","Great for detuned leads and wide pads."]},FMSynth:{overview:"Frequency Modulation synthesis creates complex harmonic tones by using one oscillator (modulator)\nto modulate another (carrier). Famous for electric pianos, bells, and metallic sounds.",keyParameters:[{name:"Harmonicity",description:"Frequency ratio between modulator and carrier. Integer = harmonic, fractional = inharmonic/bell-like."},{name:"Modulation Index",description:"Amount of FM - higher values = more harmonics/brightness."},{name:"Modulator Envelope",description:"Controls how modulation changes over time."}],tips:["Low modulation index (1-3) for subtle warmth.","High modulation index (5+) for metallic/bell tones.","Harmonicity of 1 = basic FM, 2-4 = harmonic overtones, non-integer = bells.",'Fast modulator decay creates plucky "DX7" sounds.',"Try harmonicity 3.5 or 7 for classic bell tones."],trackerUsage:"Modulation index can be automated with effect commands for evolving timbres."},AMSynth:{overview:"Amplitude Modulation synthesis creates tremolo and ring modulation effects.\nOne oscillator modulates the volume of another, creating characteristic sidebands.",keyParameters:[{name:"Harmonicity",description:"Frequency ratio of modulator. Affects sideband frequencies."},{name:"Modulator Envelope",description:"Shape of the AM intensity over time."}],tips:["Low harmonicity (0.5-2) for subtle tremolo.","Higher harmonicity for more obvious ring mod character.","Works great for atmospheric and sci-fi sounds."]},PluckSynth:{overview:"Karplus-Strong synthesis simulates plucked strings by feeding filtered noise through a delay line.\nCreates realistic plucked string sounds without samples.",keyParameters:[{name:"Attack Time",description:'Initial "pluck" noise burst duration.'},{name:"Damping",description:"How quickly high frequencies decay - more damping = duller tone."},{name:"Resonance",description:"Sustain and brightness of the string."}],tips:["Short attack + high damping = nylon guitar.","Longer attack + low damping = steel strings.","Great for harps, pizzicato, and ethnic strings.","Lower notes naturally sustain longer (like real strings)."]},MembraneSynth:{overview:'Simulates drum membranes like kick drums and toms. Uses a pitched oscillator with\nrapid pitch decay to create the characteristic "thump" of drum heads.',keyParameters:[{name:"Pitch Decay",description:"How fast the pitch drops. Fast = punchy kick, slow = tom."},{name:"Octaves",description:"Range of pitch sweep from high to low."},{name:"Sustain",description:"How long the drum resonates after hit."}],tips:["Fast pitch decay + high octaves = punchy 808-style kick.","Slower decay + lower octaves = boomy floor tom.","Add distortion for aggressive electronic kicks.","Trigger at different pitches for tom fills."]},MetalSynth:{overview:"Creates metallic percussion sounds like hi-hats, cymbals, and bells.\nUses multiple harmonically-related oscillators to create complex inharmonic spectra.",keyParameters:[{name:"Frequency",description:"Base pitch of the metallic sound."},{name:"Harmonicity",description:"Spacing of harmonics - affects the metallic character."},{name:"Modulators",description:"Number of oscillators contributing to the sound."},{name:"Resonance",description:"Ring/sustain of the metal."}],tips:["Higher frequency = higher pitched cymbals.","More modulators = more complex/realistic metal.","Short envelope = hi-hat, long = crash cymbal.","Lower resonance = duller, muted hits."]},NoiseSynth:{overview:"Filtered noise generator perfect for snares, hi-hats, and sound effects.\nThe filter shapes the noise character while the envelope controls its duration.",keyParameters:[{name:"Noise Type",description:"White (full spectrum), Pink (darker), Brown (very dark)."},{name:"Filter Frequency",description:"Cutoff - higher = brighter noise."},{name:"ADSR",description:"Shape of the noise burst."}],tips:["Fast attack/decay = snare crack or hi-hat.","Longer envelope = crash or riser.","Use bandpass filter for telephone/radio effect.","Pink noise is less harsh for most uses."]},Wavetable:{overview:"Wavetable synthesis scans through different waveforms, creating evolving timbres.\nModern EDM staple for basslines, leads, and pads.",keyParameters:[{name:"Wavetable",description:"The set of waveforms to scan through."},{name:"Position",description:"Current position in the wavetable (can be modulated)."},{name:"Morph",description:"Speed/amount of automatic wavetable scanning."},{name:"Unison",description:"Multiple detuned voices for width."}],tips:["Automate wavetable position for evolving sounds.","High unison + detune = massive EDM leads.","Try different wavetables for different characters.","Combine with filter movement for extra motion."],trackerUsage:"Use effect commands to automate wavetable position over time."},Sampler:{overview:"Plays audio samples pitched across the keyboard. The sample is mapped to a base note\nand transposed chromatically. Perfect for realistic instruments and one-shots.",keyParameters:[{name:"Sample",description:"The loaded audio file."},{name:"Base Note",description:"The note at which the sample plays at original pitch (usually C4)."},{name:"Loop",description:"Enable looping for sustained notes."},{name:"ADSR",description:"Volume envelope applied to the sample."}],tips:["Set base note to match the original pitch of your sample.","Enable loop for sustaining instruments like pads.","Short samples work well for drums and percussion.","Long attack smooths the sample start."],trackerUsage:"Use note commands to trigger, volume column for velocity, offset (9xx) to start playback mid-sample."},Player:{overview:"Simple one-shot sample player. Plays the full sample from start to end without pitch transposition.\nIdeal for loops, vocal samples, and sound effects.",keyParameters:[{name:"Sample",description:"The loaded audio file."},{name:"Playback Rate",description:"Speed multiplier (1 = normal, 2 = double speed)."},{name:"Loop",description:"Loop the sample continuously."}],tips:["Use for drum loops that should stay at original tempo.","Adjust playback rate to match your song tempo.","Great for vocal phrases and FX."]},GranularSynth:{overview:'Granular synthesis breaks a sample into tiny "grains" and reassembles them.\nCreates textures, pads, and time-stretching effects impossible with normal sampling.',keyParameters:[{name:"Grain Size",description:"Duration of each grain in ms. Small = glitchy, large = smoother."},{name:"Overlap",description:"How much grains overlap. More = smoother, less = stuttery."},{name:"Scan Position",description:"Where in the sample grains are taken from."},{name:"Scan Speed",description:"How fast position moves through the sample."},{name:"Density",description:"Number of simultaneous grains."},{name:"Random Pitch",description:"Pitch variation between grains for texture."}],tips:["Small grains (10-30ms) for glitchy textures.","Large grains (100-200ms) for smooth time-stretching.","Random pitch creates shimmer and width.","Automate scan position for evolving pads.","Try freezing on interesting moments in the sample."],trackerUsage:"Automate scan position with effect commands for texture sweeps."},SuperSaw:{overview:'Multiple detuned sawtooth waves layered together for massive, wide leads.\nThe signature sound of trance and EDM. Think "big room" and "hands in the air."',keyParameters:[{name:"Voice Count",description:"Number of saw waves (more = bigger, heavier CPU)."},{name:"Detune",description:"Pitch spread between voices. More = wider/thicker."},{name:"Spread",description:"Stereo width of the voices."}],tips:["5-7 voices is usually enough for big sounds.","Moderate detune (10-30 cents) for classic trance.","High detune (40-60 cents) for modern EDM.","Works great with filter sweeps and sidechain.","Layer with a clean sub bass for low-end foundation."]},PolySynth:{overview:"True polyphonic synthesizer with multiple independent voices. Each note gets its own voice,\nallowing rich chords and pads with proper note management.",keyParameters:[{name:"Voice Count",description:"Maximum simultaneous notes (more = bigger, heavier CPU)."},{name:"Voice Type",description:"The synthesis type for each voice."},{name:"Portamento",description:"Glide time between notes."}],tips:["4-8 voices is good for most chord work.","Use longer release for pad sounds.","Experiment with different voice types.","Great for lush string-like chords."]},Organ:{overview:"Hammond-style tonewheel organ with drawbar controls. Each drawbar adds a harmonic partial\nat a specific interval, allowing you to sculpt the tone like a real organ.",keyParameters:[{name:"Drawbars",description:"9 harmonic levels: 16', 5⅓', 8', 4', 2⅔', 2', 1⅗', 1⅓', 1'"},{name:"Percussion",description:"Adds attack transient (2nd or 3rd harmonic)."},{name:"Vibrato/Chorus",description:"Classic organ modulation effects."}],tips:["888000000 (first three up) = classic jazz/soul organ.","888888888 (all up) = full, powerful gospel sound.","800000008 = hollow, spooky organ.","Add percussion for attack definition.","Pairs well with Leslie speaker simulation."]},DrumMachine:{overview:"Analog drum synthesizer in the style of TR-808 and TR-909. Each drum type uses dedicated\nsynthesis algorithms optimized for that sound. Select 808 or 909 mode for different characters.",keyParameters:[{name:"Machine Type",description:"808 = warm/boomy, 909 = punchy/bright."},{name:"Drum Type",description:"Kick, Snare, Hi-hat, Clap, Tom, Cymbal, etc."},{name:"Pitch",description:"Tune the drum up or down."},{name:"Decay",description:"How long the sound rings out."}],tips:["808 kick: long decay, low pitch for trap/hip-hop.","909 kick: shorter decay for house/techno.","Layer kick with 808 sub for maximum impact.","Hi-hats: trigger at different pitches for variety."],trackerUsage:"Different notes trigger different drums: C=kick, D=snare, F#=hi-hat, etc."},ChipSynth:{overview:"8-bit video game console synthesizer with authentic lo-fi character. Features classic\npulse/triangle waves, bit crushing, and built-in arpeggiator for authentic chiptune.",keyParameters:[{name:"Channel",description:"Pulse 1, Pulse 2, Triangle, or Noise (like NES channels)."},{name:"Duty Cycle",description:"For pulse waves: 12.5%, 25%, 50% - affects tone color."},{name:"Bit Depth",description:"Resolution - lower = crunchier/more lo-fi."},{name:"Arpeggio",description:"Built-in arpeggiator for classic chip arpeggios."}],tips:["Pulse 50% = square wave, classic lead sound.","Pulse 12.5% = thin, nasal tone for accents.","Triangle = smooth bass, no harmonics.","Enable arpeggio for rapid note sequences.","Use the arpeggio editor for custom patterns.","4-bit depth is very crunchy, 8-bit is cleaner."],trackerUsage:"Arpeggio effect (0xy) for tracker-style arpeggios. Duty cycle can be automated."},PWMSynth:{overview:"Pulse Width Modulation synthesis varies the duty cycle of a pulse wave over time,\ncreating movement and richness. Classic analog synth technique for warm, animated tones.",keyParameters:[{name:"Modulation Rate",description:"How fast the pulse width changes."},{name:"Modulation Depth",description:"How much the pulse width varies."},{name:"Base Width",description:"Starting pulse width (50% = square)."}],tips:["Slow modulation (1-2 Hz) for subtle movement.","Fast modulation for more aggressive wobble.","Great for pads and warm analog leads.","Stack with filter for extra animation."]},StringMachine:{overview:"Vintage polyphonic string synthesizer in the style of Solina/ARP String Ensemble.\nCreates lush, choir-like string pads through ensemble detuning and chorus.",keyParameters:[{name:"Ensemble",description:"Chorus/ensemble depth for width and shimmer."},{name:"Attack",description:"Fade-in time for swell effects."},{name:"Release",description:"Fade-out tail after release."}],tips:["Long attack for swelling string pads.","Layer with other synths for full arrangements.","Classic sound for disco and synthwave.","Works beautifully with reverb and delay."]},FormantSynth:{overview:"Vowel synthesis creates vocal-like sounds by emphasizing formant frequencies.\nCan morph between vowels (A, E, I, O, U) for talk-box and vocal pad effects.",keyParameters:[{name:"Vowel",description:"Current vowel formant (A, E, I, O, U)."},{name:"Morph",description:"Blend between vowels over time."},{name:"Octave",description:"Pitch register of the voice."}],tips:['Automate vowel changes for "talking" effects.',"Layer multiple instances for choir sounds.","Great for robotic and vocoder-like tones.","Combine with vibrato for more realistic voice."],trackerUsage:"Automate vowel parameter with effect commands for talk-box sequences."},Furnace:{overview:"4-operator FM synthesizer compatible with Furnace Tracker instruments (.fui files).\nEmulates classic FM chips like YM2612 (Sega Genesis) and OPN series.",keyParameters:[{name:"Algorithm",description:"How the 4 operators are connected (8 algorithms)."},{name:"Operator Levels",description:"Output level of each operator."},{name:"Ratios",description:"Frequency multiplier for each operator."},{name:"Feedback",description:"Self-modulation amount for operator 1."}],tips:["Import .fui files directly for authentic Genesis sounds.","Algorithm 7 (all carriers) = organ-like.","Algorithm 4 = classic electric piano setup.","High feedback = aggressive, distorted tones.","Many Genesis game sounds available online as .fui files."],trackerUsage:"Full FM parameter control via tracker macros in Furnace format."},ChiptuneModule:{overview:"Module file player for classic tracker formats (MOD, XM, IT, S3M).\nPlays back existing tracker music with sample-accurate accuracy using libopenmpt.",keyParameters:[{name:"Module File",description:"The loaded module file."},{name:"Pattern",description:"Current pattern in the module."},{name:"Tempo/Speed",description:"Playback speed settings."}],tips:["Load MOD/XM/IT/S3M files to play classic tracker music.","Great for importing existing chiptune compositions.","Respects all original tracker effects."]},DubSiren:{overview:'A classic dub sound system siren generator. It uses a single oscillator\nmodulated by an LFO to create rising and falling alert tones, processed through\ndelay and reverb for that signature "space" echo effect.',keyParameters:[{name:"Oscillator Type",description:"Waveform shape: Sine (smooth), Square (harsh), Sawtooth (bright), Triangle (warm)."},{name:"Frequency",description:"Base pitch of the siren."},{name:"LFO Rate",description:"Speed of the pitch modulation."},{name:"LFO Depth",description:"Amount of pitch variation - higher values create wider sweeps."},{name:"Delay Time",description:"Echo spacing - essential for the dub character."},{name:"Delay Feedback",description:"Number of echo repeats - high values create infinite trails."}],tips:["Use high LFO depth and medium rate for classic rising/falling alerts.",'Square LFO with high depth creates a trilling "police" siren effect.','High delay feedback (70%+) creates the signature dub "wash" sound.',"Modulate the frequency manually while the siren is playing for extra expression.",'Use the filter to thin out the sound for more "lo-fi" sound system vibes.'],trackerUsage:"Trigger notes to start the siren. Use pitch bend or vibrato commands for extra modulation."},SpaceLaser:{overview:'A specialized FM-based synthesizer designed for classic "pew pew" laser sounds.\nIt combines a fast exponential pitch sweep with Frequency Modulation to create metallic, \nzapping textures common in classic reggae dubs and vintage anime sci-fi effects.',keyParameters:[{name:"Start/End Freq",description:"The range of the pitch sweep. Lasers typically start high and end low."},{name:"Sweep Time",description:'The duration of the "zap". Shorter = sharper, longer = sci-fi blast.'},{name:"FM Index",description:'Amount of frequency modulation - higher creates more metallic "grit".'},{name:"FM Ratio",description:"Harmonic relationship of the modulator - higher values create more complex textures."},{name:"Noise Amount",description:'Adds "dust" or "grit" to the laser blast, like vintage arcade sound chips.'}],tips:['Exponential sweeps sound more "natural" for lasers than linear ones.','High FM Ratio + High FM Index creates that distinctive anime "beam" sound.',"Add a small amount of Noise for a lo-fi vintage arcade character.","Use the Bandpass filter to focus the energy of the zap.",'Medium delay (300ms) with high feedback is the classic reggae "Space Laser" sound.'],trackerUsage:"Each note trigger starts a new laser sweep. Higher notes start at higher frequencies."},V2:{overview:"The legendary demoscene synth engine by Farbrausch (kb/fr), \ncompiled to WASM for high-performance demoscene-grade audio.\nV2 is a multi-voice subtractive synth with multiple oscillators, \nadvanced routing, and a unique character that defined the sound of \ncountless 4k and 64k intros from the 2000s.",keyParameters:[{name:"Osc 1 Transpose",description:"Coarse tuning for the primary oscillator."},{name:"Osc 1 Detune",description:"Fine tuning for thick, detuned sounds."},{name:"VCF Cutoff",description:"Resonant filter frequency control."},{name:"VCF Resonance",description:"Emphasizes the cutoff frequency for squelchy or piercing sounds."},{name:"Amp Envelope",description:"Attack, Decay, Sustain, and Release controls for the volume."}],tips:['The V2 sound is known for its "plastic" but powerful trance leads.',"Stack detuned sawtooth oscillators for that classic demoscene supersaw.","Use fast decay on the filter envelope for punchy basslines.","V2 was designed to fit in 4kb - its efficiency is unmatched.",'Try the "V2 Trance Lead" preset for an instant fr-08 vibe.'],trackerUsage:"Standard note triggering. Use MIDI CCs or the Special tab for real-time parameter modulation."},Synare:{overview:'The Synare 3 is a classic analog electronic percussion synthesizer from the 1970s.\nIt is famous for the "disco tom" sound—a resonant, descending pitch sweep—and is a staple of\nclassic Dub and Reggae percussion. It combines dual square/pulse oscillators with a noise generator\nand a highly resonant 24dB low-pass filter.',keyParameters:[{name:"Tune",description:"Base frequency of the oscillators."},{name:"Pitch Sweep",description:'Enables the signature descending "pyiuuu" sound. Range controls the drop amount, Time controls the speed.'},{name:"Noise Mix",description:"Adds white/pink noise for snare-like or gritty textures."},{name:"Filter Resonance",description:'Emphasis at the cutoff frequency. High resonance creates the "singing" tom sound.'},{name:"Decay",description:"How long the sound lasts. Use short decay for clicks, long for deep toms."}],tips:["For classic disco toms, use a square wave, high resonance, and a wide pitch sweep.","Add a small amount of noise to make the percussion sound more like a real drum hit.","Use the LFO on pitch for strange, sci-fi percussive effects.",'The Synare is perfect for adding "flavor" hits on top of your main drum pattern.'],trackerUsage:"Trigger with short notes. Use velocity to control the impact level."},MAMEVFX:{overview:"Ensoniq VFX engine using bit-perfect MAME emulation of the ES5506 (OTTO) chip.\nThis engine requires the official MAME ROM set to function. It provides 32 voices of\nadvanced wavetable synthesis with high-fidelity interpolation.",keyParameters:[{name:"Clock",description:"Emulation speed. Standard is 16MHz."},{name:"ROM ZIP",description:"Requires standard MAME ensvfx.zip or vfx.zip archive."}],tips:["Upload the official ensvfx.zip from your MAME ROMs collection.","The engine will automatically extract the OS and wavetable ROMs.","Great for early 90s digital pads and atmospheric sounds."]},MAMEDOC:{overview:"Ensoniq ESQ-1 / SQ-80 engine using bit-perfect MAME emulation of the ES5503 (DOC) chip.\nThis classic 8-bit wavetable engine is famous for its gritty, warm digital character and \nanalog-style modulation.",keyParameters:[{name:"Clock",description:"Emulation speed. Standard is 16MHz."},{name:"ROM ZIP",description:"Requires standard MAME esq1.zip archive."}],tips:["Upload the official esq1.zip from your MAME ROMs collection.","Includes the original factory waveforms and OS.","Perfect for vintage synthwave bass and crystalline bells."]},MAMERSA:{overview:'Roland Structured Adaptive (SA) synthesis engine from the MKS-20 and RD-1000.\nFamous for the iconic "SA Piano" and "EP" sounds that defined 80s pop and gospel.',keyParameters:[{name:"Clock",description:"Emulation speed. Standard is 20MHz."},{name:"ROM ZIP",description:"Requires standard MAME mks20.zip archive."}],tips:["Upload the official mks20.zip from your MAME ROMs collection.","Provides bit-accurate reproduction of Roland's signature SA piano algorithm.","Essential for that classic 80s studio piano sound."]}};function ea({onFrame:e,enabled:t=!0,fps:a=30,idleThreshold:n=10}){const r=he.useRef(null),s=he.useRef(0),i=he.useRef(!1),o=he.useRef(0),l=he.useRef(e);he.useEffect(()=>{l.current=e},[e]);const d=1e3/a,c=he.useCallback(e=>{if(!i.current)return;const t=e-s.current,a=o.current>n?2*d:d;if(t<a)return void(r.current=requestAnimationFrame(c));s.current=e-t%a;l.current(e)?o.current=0:o.current++,r.current=requestAnimationFrame(c)},[d,n]);return he.useEffect(()=>(t?(i.current=!0,o.current=0,s.current=0,r.current=requestAnimationFrame(c)):(i.current=!1,null!==r.current&&(cancelAnimationFrame(r.current),r.current=null)),()=>{i.current=!1,null!==r.current&&(cancelAnimationFrame(r.current),r.current=null)}),[t,c]),{isAnimating:i,idleFrames:o}}const ta=new Map,aa=({instrumentId:e,width:a=200,height:n=80,color:r="#4ade80",backgroundColor:s="#0a0a0a",lineWidth:i=1.2,className:o=""})=>{const l=he.useRef(null),c=he.useRef(null),u=he.useRef(null),[m,p]=he.useState("auto"===a?200:a);he.useEffect(()=>{if("auto"!==a)return void p(a);const e=l.current;if(!e)return;const t=()=>{const t=e.getBoundingClientRect();t.width>0&&p(Math.floor(t.width))};t();const n=new ResizeObserver(t);return n.observe(e),()=>n.disconnect()},[a]),he.useLayoutEffect(()=>{const e=c.current;if(!e)return;const t=e.getContext("2d",{alpha:!0});if(!t)return;const a=window.devicePixelRatio||1;e.width=m*a,e.height=n*a,t.setTransform(1,0,0,1,0,0),t.scale(a,a),u.current=t,ta.clear()},[m,n]);ea({onFrame:he.useCallback(()=>{const t=u.current;if(!t)return!1;const a=d().getInstrumentAnalyser(e);if("transparent"===s||"rgba(0,0,0,0)"===s?t.clearRect(0,0,m,n):(t.fillStyle=s,t.fillRect(0,0,m,n)),t.strokeStyle="#333",t.lineWidth=1,t.beginPath(),t.moveTo(0,n/2),t.lineTo(m,n/2),t.stroke(),!a)return!1;const o=a.getWaveform();if(!a.hasActivity())return!1;const l=`${r}-${n}`;let c=ta.get(l);c||(c=t.createLinearGradient(0,0,0,n),c.addColorStop(0,r),c.addColorStop(.5,r),c.addColorStop(1,r),ta.set(l,c)),t.strokeStyle=c,t.lineWidth=i,t.lineCap="round",t.lineJoin="round",t.beginPath();const p=m/o.length;let h=0;for(let e=0;e<o.length;e++){const a=(o[e]+1)/2*n;0===e?t.moveTo(h,a):t.lineTo(h,a),h+=p}return t.stroke(),t.shadowColor=r,t.shadowBlur=4,t.stroke(),t.shadowBlur=0,!0},[e,s,r,i,m,n]),enabled:!0});const h=t.jsx("canvas",{ref:c,className:`rounded ${o}`,style:{backgroundColor:"transparent"===s?"transparent":s,width:"auto"===a?"100%":`${a}px`,height:`${n}px`,display:"block"}});return"auto"===a?t.jsx("div",{ref:l,className:"w-full h-full",children:h}):h},na=new Map;const ra=({instrumentId:e,width:a=200,height:n=80,barCount:r=32,color:s="#4ade80",colorEnd:i="#22c55e",backgroundColor:o="#0a0a0a",className:l=""})=>{const c=he.useRef(null),u=he.useRef(null),m=he.useRef(null),p=he.useRef(null),[h,f]=he.useState("auto"===a?200:a);he.useEffect(()=>{if("auto"!==a)return void f(a);const e=c.current;if(!e)return;const t=()=>{const t=e.getBoundingClientRect();t.width>0&&f(Math.floor(t.width))};t();const n=new ResizeObserver(t);return n.observe(e),()=>n.disconnect()},[a]),he.useLayoutEffect(()=>{const e=u.current;if(!e)return;const t=e.getContext("2d",{alpha:!1});if(!t)return;const a=window.devicePixelRatio||1;e.width=h*a,e.height=n*a,t.setTransform(1,0,0,1,0,0),t.scale(a,a),m.current=t;const r=t.createLinearGradient(0,n,0,0);r.addColorStop(0,i),r.addColorStop(.5,s),r.addColorStop(1,s),p.current=r},[h,n,s,i]);ea({onFrame:he.useCallback(()=>{const t=m.current;if(!t)return!1;const a=d().getInstrumentAnalyser(e);if(t.fillStyle=o,t.fillRect(0,0,h,n),!a)return!1;const i=a.getFFT();if(!a.hasActivity())return!1;const l=function(e,t){const a=`${e}-${t}`;let n=na.get(a);if(!n){n=new Array(t);const r=e/2;for(let e=0;e<t;e++){const a=Math.log10(1),s=a+(Math.log10(r)-a)*e/(t-1);n[e]=Math.min(Math.floor(Math.pow(10,s)),r-1)}na.set(a,n)}return n}(2*i.length,r),c=(h-2*(r-1))/r;t.fillStyle=p.current||s;for(let e=0;e<r;e++){const a=i[l[e]]||-100,r=Math.max(0,(a+100)/100)*n;if(r>0){const a=e*(c+2),s=n-r,i=Math.min(c/2,2);t.beginPath(),t.roundRect(a,s,c,r,[i,i,0,0]),t.fill()}}return!0},[e,o,s,r,h,n]),enabled:!0});const x=t.jsx("canvas",{ref:u,className:`rounded ${l}`,style:{backgroundColor:o,width:"auto"===a?"100%":`${a}px`,height:`${n}px`,display:"block"}});return"auto"===a?t.jsx("div",{ref:c,className:"w-full h-full",children:x}):x},sa=new Map;const ia=({instrumentId:e,orientation:a="horizontal",segments:n=16,width:r,height:s,colorLow:i="#22c55e",colorMid:o="#eab308",colorHigh:l="#ef4444",backgroundColor:c="#1a1a1a",className:u=""})=>{const m=r??("horizontal"===a?120:20),p=s??("horizontal"===a?16:80),h=he.useRef(null),f=he.useRef(null),x=he.useRef(0),g=he.useRef(0),b=he.useRef(0),y=function(e,t,a,n){const r=`${e}-${t}-${a}-${n}`;let s=sa.get(r);if(!s){s=new Array(e);const i=Math.floor(.6*e),o=Math.floor(.85*e);for(let r=0;r<e;r++)s[r]=r<i?t:r<o?a:n;sa.set(r,s)}return s}(n,i,o,l);he.useEffect(()=>{const e=h.current;if(!e)return;const t=e.getContext("2d",{alpha:!1});t&&(f.current=t)},[]);return ea({onFrame:he.useCallback(t=>{const r=h.current,s=f.current;if(!r||!s)return!1;const i=d().getInstrumentAnalyser(e),o=i?i.getLevel():0;o>x.current?x.current=o:(x.current*=.92,x.current<.001&&(x.current=0)),o>g.current?(g.current=o,b.current=t):t-b.current>1e3&&(g.current*=.98,g.current<.001&&(g.current=0)),s.fillStyle=c,s.fillRect(0,0,r.width,r.height);const l="horizontal"===a,u=l?(r.width-2*(n-1))/n:(r.height-2*(n-1))/n,m=Math.round(x.current*n),p=Math.min(Math.round(g.current*n),n-1);for(let e=0;e<n;e++){const t=e<m,a=e===p&&g.current>0;let n,i,o,d;l?(n=e*(u+2),i=2,o=u,d=r.height-4):(n=2,i=r.height-(e+1)*(u+2),o=r.width-4,d=u),t||a?(s.fillStyle=y[e],s.globalAlpha=a&&!t?.6:1,s.beginPath(),s.roundRect(n,i,o,d,1),s.fill(),s.globalAlpha=1,t&&(s.shadowColor=y[e],s.shadowBlur=4,s.fill(),s.shadowBlur=0)):(s.fillStyle="#333",s.globalAlpha=.3,s.beginPath(),s.roundRect(n,i,o,d,1),s.fill(),s.globalAlpha=1)}return x.current>0||g.current>0},[e,a,n,c,y]),enabled:!0}),t.jsx("canvas",{ref:h,width:m,height:p,className:`rounded ${u}`,style:{backgroundColor:c}})},oa=({instrumentId:e,attack:a,decay:n,sustain:r,release:s,width:i=200,height:o=80,color:l="#4ade80",activeColor:d="#fbbf24",backgroundColor:u="#1a1a1a",className:m=""})=>{const p=he.useRef(null),h=he.useRef(null),f=c(e=>e.adsrStages),x=c(e=>e.adsrProgress),g=f.get(e)||"idle",b=x.get(e)||0;he.useLayoutEffect(()=>{const e=p.current;if(!e)return;const t=e.getContext("2d",{alpha:!1});if(!t)return;const a=window.devicePixelRatio||1;e.width=i*a,e.height=o*a,t.setTransform(1,0,0,1,0,0),t.scale(a,a),h.current=t},[i,o]);return ea({onFrame:he.useCallback(()=>{const e=h.current;if(!e)return!1;e.fillStyle=u,e.fillRect(0,0,i,o);const t=10,a=10,n=o-t-10,s=(i-a-10)/4,c=a,m=c+s,p=m+s,f=p+s,x=f+s,y=t+n,v=t,w=y-n*r;if(e.strokeStyle="#333",e.lineWidth=1,e.setLineDash([2,2]),e.beginPath(),e.moveTo(c,w),e.lineTo(x,w),e.stroke(),e.setLineDash([]),e.beginPath(),e.moveTo(c,y),e.lineTo(m,v),e.lineTo(p,w),e.lineTo(f,w),e.lineTo(x,y),e.strokeStyle=l,e.lineWidth=2,e.stroke(),e.lineTo(x,y),e.lineTo(c,y),e.fillStyle=`${l}22`,e.fill(),"idle"!==g){let t=c,a=y;switch(g){case"attack":t=c+s*b,a=y-n*b;break;case"decay":t=m+s*b,a=v+(w-v)*b;break;case"sustain":t=p+s*b,a=w;break;case"release":t=f+s*b,a=w+(y-w)*b}e.beginPath(),e.arc(t,a,4,0,2*Math.PI),e.fillStyle=d,e.shadowColor=d,e.shadowBlur=8,e.fill(),e.shadowBlur=0}return"idle"!==g},[g,b,a,n,r,s,i,o,l,d,u]),enabled:!0}),t.jsx("canvas",{ref:p,className:`rounded ${m}`,style:{backgroundColor:u,width:`${i}px`,height:`${o}px`,display:"block"}})},la=({instrumentId:e,cutoff:a,resonance:n,type:r,envelopeAmount:s=0,lfoAmount:i=0,width:o=200,height:l=80,color:d="#ff6b6b",modulatedColor:u="#fbbf24",backgroundColor:m="#1a1a1a",className:p=""})=>{const h=he.useRef(null),f=he.useRef(null),x=he.useRef(a),g=c(e=>e.lfoPhases),b=c(e=>e.adsrStages),y=c(e=>e.adsrProgress),v=g.get(e),w=b.get(e)||"idle",j=y.get(e)||0,_={top:8,right:8,bottom:20,left:32},k=o-_.left-_.right,N=l-_.top-_.bottom,$=2e4,C=he.useCallback(e=>{const t=Math.log10(20),a=Math.log10($),n=Math.log10(Math.max(20,Math.min($,e)));return _.left+(n-t)/(a-t)*k},[k,_.left]),S=-24,M=he.useCallback(e=>_.top+(1-(e-S)/48)*N,[N,_.top]),z=he.useCallback((e,t)=>{const a=[];for(let n=0;n<=100;n++){const s=_.left+n/100*k,i=Math.log10(20),o=Math.log10($),l=(s-_.left)/k;let d=0;const c=Math.pow(10,i+l*(o-i))/e,u=Math.max(.5,t/3);switch(r){case"lowpass":{const e=1/Math.sqrt(1+Math.pow(c,4)),t=c>.7&&c<1.3?6*(u-.5)*Math.exp(-Math.pow(3*(c-1),2)):0;d=20*Math.log10(e)+t;break}case"highpass":{const e=Math.pow(c,2)/Math.sqrt(1+Math.pow(c,4)),t=c>.7&&c<1.3?6*(u-.5)*Math.exp(-Math.pow(3*(c-1),2)):0;d=20*Math.log10(Math.max(.001,e))+t;break}case"bandpass":{const e=1/u,t=1/Math.sqrt(1+Math.pow((c-1/c)/e,2));d=20*Math.log10(t);break}case"notch":{const e=1/u,t=Math.abs(c-1/c)/Math.sqrt(Math.pow(c-1/c,2)+e*e);d=20*Math.log10(Math.max(.001,t));break}}d=Math.max(S,Math.min(24,d));const m=M(d);a.push(0===n?`M ${s} ${m}`:`L ${s} ${m}`)}return a.join(" ")},[r,k,_.left,M]);he.useLayoutEffect(()=>{const e=h.current;if(!e)return;const t=e.getContext("2d",{alpha:!1});if(!t)return;const a=window.devicePixelRatio||1;e.width=o*a,e.height=l*a,t.setTransform(1,0,0,1,0,0),t.scale(a,a),f.current=t},[o,l]);return ea({onFrame:he.useCallback(()=>{const e=f.current;if(!e)return!1;let t=a;if("idle"!==w&&0!==s){let e=0;switch(w){case"attack":e=j;break;case"decay":case"sustain":e=1-.3*j;break;case"release":e=.7*(1-j)}const n=4*(s/100*e);t=a*Math.pow(2,n)}if(v&&i>0){const e=Math.sin(v.filter*Math.PI*2),a=2*(i/100*e);t*=Math.pow(2,a)}t=Math.max(20,Math.min($,t)),x.current=t,e.fillStyle=m,e.fillRect(0,0,o,l),e.strokeStyle="#333",e.lineWidth=1,e.setLineDash([2,4]),[-12,0,12].forEach(t=>{const a=M(t);e.beginPath(),e.moveTo(_.left,a),e.lineTo(_.left+k,a),e.stroke()}),[100,1e3,1e4].forEach(t=>{const a=C(t);e.beginPath(),e.moveTo(a,_.top),e.lineTo(a,_.top+N),e.stroke()}),e.setLineDash([]);const r=Math.abs(t-a)>10;if(r){const a=new Path2D(z(t,n)),r=new Path2D(z(t,n));r.lineTo(_.left+k,M(S)),r.lineTo(_.left,M(S)),r.closePath(),e.fillStyle=`${u}22`,e.fill(r),e.strokeStyle=u,e.lineWidth=2,e.stroke(a),e.shadowColor=u,e.shadowBlur=6,e.stroke(a),e.shadowBlur=0}const c=new Path2D(z(a,n)),p=new Path2D(z(a,n));p.lineTo(_.left+k,M(S)),p.lineTo(_.left,M(S)),p.closePath(),e.fillStyle=`${d}22`,e.fill(p),e.strokeStyle=r?`${d}66`:d,e.lineWidth=2,e.stroke(c),r||(e.shadowColor=d,e.shadowBlur=4,e.stroke(c),e.shadowBlur=0);const h=C(r?t:a);return e.strokeStyle=r?u:d,e.lineWidth=1,e.setLineDash([4,4]),e.beginPath(),e.moveTo(h,_.top),e.lineTo(h,_.top+N),e.stroke(),e.setLineDash([]),e.fillStyle="#555",e.font="8px monospace",e.textAlign="center",[100,1e3,1e4].forEach(t=>{const a=C(t),n=t>=1e3?t/1e3+"k":`${t}`;e.fillText(n,a,_.top+N+12)}),e.textAlign="right",[-12,0,12].forEach(t=>{const a=M(t);e.fillText(`${t>0?"+":""}${t}`,_.left-4,a+3)}),r},[a,n,s,i,v,w,j,d,u,m,z,C,M,k,N,_,o,l]),enabled:!0}),t.jsx("canvas",{ref:h,className:`rounded ${p}`,style:{backgroundColor:m,width:`${o}px`,height:`${l}px`,display:"block"}})};const da=({instrumentId:e,rate:a,depth:n,waveform:r,syncToBPM:s=!1,bpm:i=120,width:o=120,height:l=50,color:d="#a855f7",dotColor:u="#ffffff",backgroundColor:m="#1a1a1a",className:p="",label:h="LFO"})=>{const f=he.useRef(null),x=he.useRef(null),g=he.useRef(0),b=he.useRef(0);c(e=>e.lfoPhases);const y=c(e=>e.setLFOPhase),v={top:4,right:4,bottom:16,left:4},w=o-v.left-v.right,j=l-v.top-v.bottom,_=v.top+j/2,k=j/2*(n/100),N=s?i/60*a:a;he.useEffect(()=>{const e=f.current;if(!e)return;const t=e.getContext("2d",{alpha:!1});t&&(x.current=t)},[]);const $=he.useCallback(t=>{const i=f.current,c=x.current;if(!i||!c)return!1;const p=b.current?(t-b.current)/1e3:0;b.current=t,g.current=(g.current+N*p)%1,y(e,{filter:g.current,pitch:g.current,rate:N}),c.fillStyle=m,c.fillRect(0,0,i.width,i.height),c.strokeStyle="#333",c.lineWidth=1,c.beginPath(),c.moveTo(v.left,_),c.lineTo(v.left+w,_),c.stroke();const j=function(e,t,a,n,r){const s=t-n.left-n.right,i=a-n.top-n.bottom,o=n.top+i/2,l=i/2*(r/100),d=[];for(let c=0;c<=100;c++){const t=c/100,a=n.left+t*s;let r=0;switch(e){case"sine":r=Math.sin(t*Math.PI*2);break;case"triangle":r=1-4*Math.abs(Math.round(t)-t);break;case"sawtooth":r=2*(t-Math.floor(t+.5));break;case"square":r=t<.5?1:-1}const i=o-r*l;d.push(0===c?`M ${a} ${i}`:`L ${a} ${i}`)}return d.join(" ")}(r,o,l,v,n),$=new Path2D(j);c.strokeStyle=d,c.lineWidth=2,c.lineCap="round",c.lineJoin="round",c.stroke($),c.shadowColor=d,c.shadowBlur=4,c.stroke($),c.shadowBlur=0;const C=v.left+g.current*w,S=function(e,t){switch(e){case"sine":return Math.sin(t*Math.PI*2);case"triangle":return 1-4*Math.abs(Math.round(t)-t);case"sawtooth":return 2*(t-Math.floor(t+.5));case"square":return t<.5?1:-1;default:return 0}}(r,g.current),M=_-S*k;c.fillStyle=u,c.shadowColor=u,c.shadowBlur=8,c.beginPath(),c.arc(C,M,4,0,2*Math.PI),c.fill(),c.shadowBlur=0,c.strokeStyle=d,c.lineWidth=1,c.stroke(),c.fillStyle="#666",c.font="9px monospace",c.textAlign="left",c.fillText(h,v.left,i.height-2),c.textAlign="right";const z=s?`${a}x`:`${a.toFixed(1)}Hz`;return c.fillText(z,i.width-v.right,i.height-2),!0},[e,r,n,N,s,a,d,u,m,h,o,l,v,w,_,k,y]);return ea({onFrame:$,enabled:n>0}),t.jsx("canvas",{ref:f,width:o,height:l,className:`rounded ${p}`,style:{backgroundColor:m}})},ca=["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"],ua=[0,2,4,5,7,9,11],ma=[1,3,6,8,10];function pa(e){const t=e.match(/^([A-G]#?)(-?\d+)$/);if(!t)return-1;const a=t[1],n=parseInt(t[2],10),r=ca.indexOf(a);return-1===r?-1:12*(n+1)+r}const ha=({channelIndex:e,octaveStart:a=2,octaveEnd:n=6,width:r=200,height:s=32,whiteKeyColor:i="#f5f5f5",blackKeyColor:o="#1a1a1a",activeColor:l="#4ade80",backgroundColor:d="#0a0a0a",className:u=""})=>{const m=he.useRef(null),p=he.useRef(null),h=c(e=>e.activeNotes),f=7*(n-a),x=r/f,g=.6*x,b=.6*s,y=12*(a+1),v=12*(n+1);he.useEffect(()=>{const e=m.current;if(!e)return;const t=e.getContext("2d",{alpha:!1});t&&(p.current=t)},[]);return ea({onFrame:he.useCallback(()=>{const t=m.current,r=p.current;if(!t||!r)return!1;const c=new Map;if(void 0!==e){const t=h.get(e)||[];for(const e of t){const t=pa(e.note);t>=y&&t<v&&c.set(t,Math.max(c.get(t)||0,e.velocity))}}else h.forEach(e=>{for(const t of e){const e=pa(t.note);e>=y&&e<v&&c.set(e,Math.max(c.get(e)||0,t.velocity))}});r.fillStyle=d,r.fillRect(0,0,t.width,t.height);let u=0;for(let e=a;e<n;e++)for(const t of ua){const a=12*(e+1)+t,n=u*x,o=c.get(a);if(void 0!==o){const e=.4+.6*o;r.fillStyle=l,r.globalAlpha=e,r.fillRect(n+.5,0,x-1,s-1),r.globalAlpha=1,r.shadowColor=l,r.shadowBlur=4,r.fillRect(n+.5,0,x-1,s-1),r.shadowBlur=0}else r.fillStyle=i,r.fillRect(n+.5,0,x-1,s-1);r.strokeStyle="#333",r.lineWidth=1,r.strokeRect(n+.5,.5,x-1,s-1),u++}u=0;for(let e=a;e<n;e++)for(let t=0;t<ua.length;t++){const a=u*x,n=ua[t]+1;if(ma.includes(n)){const t=12*(e+1)+n,s=a+x-g/2,i=c.get(t);if(void 0!==i){const e=.4+.6*i;r.fillStyle=l,r.globalAlpha=e,r.fillRect(s,0,g,b),r.globalAlpha=1,r.shadowColor=l,r.shadowBlur=4,r.fillRect(s,0,g,b),r.shadowBlur=0}else r.fillStyle=o,r.fillRect(s,0,g,b);r.strokeStyle="#222",r.lineWidth=1,r.strokeRect(s,0,g,b)}u++}return c.size>0},[h,e,y,v,f,x,g,b,i,o,l,d,s,a,n]),enabled:!0}),t.jsx("canvas",{ref:m,width:r,height:s,className:`rounded ${u}`,style:{backgroundColor:d}})};function fa(e){return["Sampler","Player","GranularSynth","DrumKit","ChiptuneModule"].includes(e)}const xa=({instrument:e,onChange:a,vizMode:n,onVizModeChange:r,hideVisualization:s=!1,showHelpButton:i=!1,showHelp:o=!1,onHelpToggle:d,customHeader:c,customHeaderControls:T,compact:E=!1,onBake:A,onBakePro:I,onUnbake:O,isBaked:R,isBaking:V})=>{const P=l(e.synthType),D=(B=e.synthType,Jt[B]);var B;const L=(F=P.icon,ze[F]||Te);var F;return c?t.jsxs(t.Fragment,{children:[c,!s&&t.jsx(ga,{instrument:e,vizMode:n,onVizModeChange:r,compact:E})]}):t.jsxs(t.Fragment,{children:[t.jsx("div",{className:"synth-editor-header px-4 py-3 bg-[#1a1a1a]",children:t.jsxs("div",{className:"flex items-center gap-3",children:[t.jsx("div",{className:`p-2 rounded-lg bg-gradient-to-br from-gray-800 to-gray-900 ${P.color}`,children:t.jsx(L,{size:20})}),t.jsxs("div",{className:"flex-1 min-w-0",children:[t.jsx("div",{className:"flex items-center gap-2",children:t.jsx("select",{value:e.synthType,onChange:t=>function(e,t,a){if(t===e.synthType)return;m.getInstance().invalidateInstrument(e.id);const n={synthType:t,name:l(t).name,tb303:void 0,drumMachine:void 0,chipSynth:void 0,pwmSynth:void 0,wavetable:void 0,granular:void 0,superSaw:void 0,polySynth:void 0,organ:void 0,stringMachine:void 0,formantSynth:void 0,furnace:void 0,wobbleBass:void 0,drumKit:void 0,buzzmachine:void 0,dubSiren:void 0,spaceLaser:void 0,synare:void 0,effects:[]};switch(t){case"TB303":n.tb303={...S};break;case"DrumMachine":n.drumMachine={...C};break;case"ChipSynth":n.chipSynth={...$};break;case"PWMSynth":n.pwmSynth={...N};break;case"Wavetable":n.wavetable={...k};break;case"GranularSynth":n.granular={..._};break;case"SuperSaw":n.superSaw={...j};break;case"PolySynth":n.polySynth={...w};break;case"Organ":n.organ={...v};break;case"StringMachine":n.stringMachine={...y};break;case"FormantSynth":n.formantSynth={...b};break;case"WobbleBass":n.wobbleBass={...g};break;case"DrumKit":n.drumKit={...x};break;case"DubSiren":n.dubSiren={...f},n.effects=[{id:Math.random().toString(36).substring(7),category:"tonejs",type:"SpaceEcho",enabled:!0,wet:80,parameters:{mode:4,rate:350,intensity:.6,echoVolume:.8,reverbVolume:.3}},{id:Math.random().toString(36).substring(7),category:"tonejs",type:"DubFilter",enabled:!0,wet:100,parameters:{cutoff:45,resonance:4,gain:1.2}}];break;case"SpaceLaser":n.spaceLaser={...h};break;case"Synare":n.synare={...p},n.effects=[{id:Math.random().toString(36).substring(7),category:"tonejs",type:"Reverb",enabled:!0,wet:30,parameters:{decay:2.5,preDelay:.01}}]}t.startsWith("Furnace")&&(n.furnace={...M}),("Buzzmachine"===t||t.startsWith("Buzz"))&&(n.buzzmachine={...z}),a(n)}(e,t.target.value,a),className:"px-2 py-1 text-sm font-medium bg-gray-800 border border-gray-700 rounded text-white hover:border-gray-500 focus:border-blue-500 focus:outline-none cursor-pointer",title:"Switch synth type",children:u.map(e=>t.jsx("optgroup",{label:e.name,children:e.synths.sort((e,t)=>e.name.localeCompare(t.name)).map(a=>t.jsx("option",{value:a.type,children:a.name},`${e.id}-${a.type}`))},e.id))})}),t.jsx("p",{className:"text-xs text-gray-400 truncate",children:P.description})]}),t.jsxs("div",{className:"flex items-center gap-2 flex-shrink-0",children:[T,t.jsxs("button",{onClick:()=>a({isLive:!e.isLive}),className:"p-1.5 rounded transition-all flex items-center gap-1.5 px-2 "+(e.isLive?"bg-accent-success/20 text-accent-success ring-1 ring-accent-success/50 animate-pulse-glow":"bg-gray-800 text-text-muted hover:text-text-secondary border border-gray-700"),title:e.isLive?"Live Mode Active: Bypasses lookahead for zero-latency jamming":"Enable Live Mode: Bypasses lookahead buffer",children:[t.jsx(je,{size:14,className:e.isLive?"animate-pulse":""}),t.jsx("span",{className:"text-[10px] font-bold uppercase tracking-tight",children:e.isLive?"LIVE":"STD"})]}),t.jsxs("button",{onClick:()=>a({monophonic:!e.monophonic}),className:"p-1.5 rounded transition-all flex items-center gap-1.5 px-2 "+(e.monophonic?"bg-orange-500/20 text-orange-400 ring-1 ring-orange-500/50":"bg-blue-500/20 text-blue-400 ring-1 ring-blue-500/50"),title:e.monophonic?"Switch to Polyphonic":"Switch to Monophonic",children:[e.monophonic?t.jsx(_e,{size:14}):t.jsx(ke,{size:14}),t.jsx("span",{className:"text-[10px] font-bold uppercase tracking-tight",children:e.monophonic?"Mono":"Poly"})]}),(A||O)&&!fa(e.synthType)&&t.jsxs("button",{onClick:R?O:A,disabled:V,className:`p-1.5 rounded transition-all flex items-center gap-1.5 px-2 ${R?"bg-amber-500/20 text-amber-400 ring-1 ring-amber-500/50 hover:bg-amber-500/30":"bg-gray-800 text-gray-400 hover:text-white hover:bg-gray-700 border border-gray-700"} ${V?"opacity-50 cursor-not-allowed":""}`,title:R?"Unbake: Revert to live synth engine":"Lite Bake: Render single C-4 sample (fast & small)",children:[V?t.jsx(Ne,{size:14,className:"animate-spin"}):R?t.jsx($e,{size:14}):t.jsx(Ce,{size:14}),t.jsx("span",{className:"text-[10px] font-bold uppercase tracking-tight",children:V?"BAKING":R?"UNBAKE":"BAKE"})]}),!R&&I&&!fa(e.synthType)&&t.jsxs("button",{onClick:I,disabled:V,className:"p-1.5 rounded transition-all flex items-center gap-1.5 px-2 bg-gray-800 text-gray-400 hover:text-white hover:bg-gray-700 border border-gray-700 "+(V?"opacity-50 cursor-not-allowed":""),title:"Pro Bake: Render every unique note used in the song for maximum accuracy",children:[V?t.jsx(Ne,{size:14,className:"animate-spin"}):t.jsx(Se,{size:14,className:"text-amber-400"}),t.jsx("span",{className:"text-[10px] font-bold uppercase tracking-tight",children:"PRO"})]}),R&&e.sample?.url&&t.jsxs("button",{onClick:()=>{const t=document.createElement("a");t.href=e.sample.url,t.download=`${e.name||"baked-sample"}.wav`,document.body.appendChild(t),t.click(),document.body.removeChild(t)},className:"p-1.5 rounded bg-gray-800 text-gray-400 hover:text-white hover:bg-gray-700 border border-gray-700 transition-all flex items-center gap-1.5 px-2",title:"Download baked sample as WAV",children:[t.jsx(ye,{size:14}),t.jsx("span",{className:"text-[10px] font-bold uppercase tracking-tight",children:"WAV"})]}),t.jsx(Qt,{synthType:e.synthType,onChange:a}),i&&d&&t.jsx("button",{onClick:d,className:"p-1.5 rounded transition-all "+(o?"bg-blue-500/20 text-blue-400 ring-1 ring-blue-500":"bg-gray-800 text-gray-400 hover:text-white hover:bg-gray-700"),title:"Show help",children:t.jsx(Me,{size:16})})]})]})}),o&&D&&t.jsxs("div",{className:"px-4 py-3 bg-gradient-to-r from-blue-900/20 to-purple-900/20 border-b border-gray-800 text-xs",children:[t.jsx("p",{className:"text-gray-300 mb-2",children:D.overview}),D.tips.length>0&&t.jsx("ul",{className:"flex flex-wrap gap-2",children:D.tips.slice(0,3).map((e,a)=>t.jsx("li",{className:"text-gray-400 bg-black/30 px-2 py-1 rounded",children:e},a))})]}),!s&&t.jsx(ga,{instrument:e,vizMode:n,onVizModeChange:r,compact:E})]})},ga=({instrument:e,vizMode:a,onVizModeChange:n,compact:r=!1,height:s=60})=>{const i=r?48:s;return t.jsxs("div",{className:"synth-editor-viz-header",children:[t.jsxs("div",{className:"flex bg-gray-900 rounded p-0.5",children:[t.jsxs("button",{onClick:()=>n("oscilloscope"),className:"px-2 py-1 text-xs font-medium rounded transition-all "+("oscilloscope"===a?"bg-gray-700 text-white":"text-gray-500 hover:text-gray-300"),children:[t.jsx(Ee,{size:12,className:"inline mr-1"}),"Scope"]}),t.jsxs("button",{onClick:()=>n("spectrum"),className:"px-2 py-1 text-xs font-medium rounded transition-all "+("spectrum"===a?"bg-gray-700 text-white":"text-gray-500 hover:text-gray-300"),children:[t.jsx(Ae,{size:12,className:"inline mr-1"}),"FFT"]})]}),t.jsx("div",{className:"flex-1 bg-black rounded overflow-hidden border border-gray-800",style:{height:i},children:"oscilloscope"===a?t.jsx(aa,{instrumentId:e.id,width:"auto",height:i,color:"#4ade80",backgroundColor:"#000000"}):t.jsx(ra,{instrumentId:e.id,width:"auto",height:i,barCount:48,color:"#22c55e",colorEnd:"#ef4444",backgroundColor:"#000000"})}),t.jsx(ia,{instrumentId:e.id,orientation:"vertical",width:16,height:i-10}),!r&&t.jsx(ha,{width:80,height:24,octaveStart:3,octaveEnd:5,activeColor:"#4ade80"})]})},ba="C4",ya=new Set(["Sam","V2Speech","DrumKit","ChiptuneModule","Player"]);const va=[{id:"oscillator",label:"Oscillator",shortLabel:"OSCILLATOR"},{id:"envelope",label:"Envelope",shortLabel:"ENVELOPE"},{id:"filter",label:"Filter",shortLabel:"FILTER"},{id:"modulation",label:"Modulation",shortLabel:"MODULATION"},{id:"output",label:"Output",shortLabel:"OUTPUT"},{id:"special",label:"Parameters",shortLabel:"PARAMETERS"}],wa=({activeTab:e,onTabChange:a,hiddenTabs:n=[],showFullLabels:r=!1})=>{const s=va.filter(e=>!n.includes(e.id));return t.jsx("div",{className:"synth-editor-tabs",children:s.map(n=>t.jsx("button",{onClick:()=>a(n.id),className:"synth-editor-tab "+(e===n.id?"active":""),title:n.label,children:r?n.label:n.shortLabel},n.id))})},ja=({config:e,onChange:a,onPresetLoad:n,isBuzz3o3:r=!1})=>t.jsx(E,{config:e,onChange:a,onPresetLoad:n,isBuzz3o3:r}),_a={[A.VOL]:"Volume",[A.ARP]:"Arpeggio",[A.DUTY]:"Duty",[A.WAVE]:"Waveform",[A.PITCH]:"Pitch",[A.EX1]:"Extra 1",[A.EX2]:"Extra 2",[A.EX3]:"Extra 3",[A.EX4]:"Extra 4",[A.EX5]:"Extra 5",[A.EX6]:"Extra 6",[A.EX7]:"Extra 7",[A.EX8]:"Extra 8",[A.ALG]:"Algorithm",[A.FB]:"Feedback",[A.FMS]:"FM LFO Speed",[A.AMS]:"AM LFO Speed",[A.PAN_L]:"Pan Left",[A.PAN_R]:"Pan Right",[A.PHASE_RESET]:"Phase Reset"},ka=({macro:e,macroType:a,onChange:n,minValue:r=0,maxValue:s=15,height:i=120,color:o="#a78bfa",label:l,bipolar:d=!1})=>{const c=he.useRef(null),u=he.useRef(null),[m,p]=he.useState(!1),[h,f]=he.useState(!1),[x,g]=he.useState(!1),b=l||_a[a]||`Macro ${a}`,y=Math.max(8,Math.min(20,400/Math.max(e.data.length,1))),v=Math.max(400,e.data.length*y),w=he.useCallback(()=>{const t=c.current;if(!t)return;const a=t.getContext("2d");if(!a)return;const n=window.devicePixelRatio||1;t.width=v*n,t.height=i*n,a.scale(n,n);const l=v,u=i,m=s-r;a.fillStyle="#1a1a2e",a.fillRect(0,0,l,u),a.strokeStyle="#2a2a4e",a.lineWidth=1;for(let e=0;e<=4;e++){const t=u/4*e;a.beginPath(),a.moveTo(0,t),a.lineTo(l,t),a.stroke()}if(d&&r<0){const e=u*(s/m);a.strokeStyle="#4a4a6e",a.beginPath(),a.moveTo(0,e),a.lineTo(l,e),a.stroke()}a.strokeStyle="#2a2a4e";for(let r=0;r<e.data.length;r+=4){const t=r/e.data.length*l;a.beginPath(),a.moveTo(t,0),a.lineTo(t,u),a.stroke()}if(e.loop>=0&&e.loop<e.data.length){const t=e.loop/e.data.length*l,n=e.release>=0?e.release/e.data.length*l:l;a.fillStyle="rgba(59, 130, 246, 0.15)",a.fillRect(t,0,n-t,u)}const p=l/e.data.length;if(e.data.forEach((e,t)=>{const n=t*p,s=(e-r)/m*u,i=u-s;a.fillStyle=o,a.fillRect(n+1,i,p-2,s),a.strokeStyle="rgba(255,255,255,0.3)",a.strokeRect(n+1,i,p-2,s)}),e.loop>=0&&e.loop<e.data.length){const t=e.loop/e.data.length*l;a.strokeStyle="#3b82f6",a.lineWidth=2,a.beginPath(),a.moveTo(t,0),a.lineTo(t,u),a.stroke(),a.fillStyle="#3b82f6",a.beginPath(),a.moveTo(t-6,10),a.lineTo(t,0),a.lineTo(t+6,10),a.closePath(),a.fill()}if(e.release>=0&&e.release<e.data.length){const t=e.release/e.data.length*l;a.strokeStyle="#ef4444",a.lineWidth=2,a.beginPath(),a.moveTo(t,0),a.lineTo(t,u),a.stroke(),a.fillStyle="#ef4444",a.fillRect(t-5,5,10,10)}},[e,r,s,o,d]);he.useEffect(()=>{w()},[w]);const j=t=>{const a=c.current;if(!a)return{step:0,value:0};const n=a.getBoundingClientRect(),i=t.clientX-n.left,o=t.clientY-n.top,l=Math.floor(i/n.width*e.data.length),d=s-r,u=1-o/n.height,m=Math.round(r+u*d);return{step:Math.max(0,Math.min(e.data.length-1,l)),value:Math.max(r,Math.min(s,m))}},_=()=>{p(!1)};return t.jsxs("div",{className:"bg-dark-bgSecondary rounded-lg border border-dark-border overflow-hidden",children:[t.jsxs("div",{className:"flex items-center justify-between px-3 py-2 bg-dark-bg border-b border-dark-border",children:[t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx("span",{className:"font-mono text-xs font-bold text-text-primary uppercase tracking-wider",children:b}),t.jsxs("span",{className:"text-[10px] text-text-muted font-mono",children:[e.data.length," steps"]})]}),t.jsxs("div",{className:"flex items-center gap-1",children:[t.jsxs("label",{className:"flex items-center gap-1 text-[10px] text-text-muted mr-2",children:[t.jsx("span",{children:"Speed:"}),t.jsx("input",{type:"number",min:1,max:16,value:e.speed||1,onChange:t=>n({...e,speed:parseInt(t.target.value)||1}),className:"w-10 bg-dark-bg border border-dark-border rounded px-1 py-0.5 text-text-primary text-[10px] font-mono"})]}),t.jsx("button",{onClick:()=>{if(e.data.length<=1)return;const t=e.data.slice(0,-1),a=e.loop>=t.length?t.length-1:e.loop,r=e.release>=t.length?t.length-1:e.release;n({...e,data:t,loop:a,release:r})},className:"p-1 text-text-muted hover:text-text-primary hover:bg-dark-border/50 rounded",title:"Remove step",children:t.jsx(Oe,{size:14})}),t.jsx("button",{onClick:()=>{e.data.length>=256||n({...e,data:[...e.data,e.data[e.data.length-1]||0]})},className:"p-1 text-text-muted hover:text-text-primary hover:bg-dark-border/50 rounded",title:"Add step",children:t.jsx(Ie,{size:14})}),t.jsx("button",{onClick:()=>{f(!h),g(!1)},className:"p-1 rounded "+(h?"bg-blue-500 text-white":"text-blue-400 hover:bg-blue-500/20"),title:h?"Click on macro to set loop":"Set loop point",children:t.jsx(Re,{size:14})}),t.jsx("button",{onClick:()=>{g(!x),f(!1)},className:"p-1 rounded "+(x?"bg-red-500 text-white":"text-red-400 hover:bg-red-500/20"),title:x?"Click on macro to set release":"Set release point",children:t.jsx(Ve,{size:14})}),t.jsx("button",{onClick:()=>{const t=d?0:r;n({...e,data:Array(e.data.length).fill(t),loop:-1,release:-1})},className:"p-1 text-text-muted hover:text-text-primary hover:bg-dark-border/50 rounded",title:"Reset macro",children:t.jsx(Pe,{size:14})})]})]}),t.jsxs("div",{ref:u,className:"relative overflow-x-auto",style:{height:i+20},children:[t.jsx("canvas",{ref:c,width:v,height:i,className:"cursor-"+(h||x?"crosshair":"pointer"),onMouseDown:t=>{if(h||x){const{step:a}=j(t);return void(h?(n({...e,loop:a}),f(!1)):x&&(n({...e,release:a}),g(!1)))}p(!0);const{step:a,value:r}=j(t),s=[...e.data];s[a]=r,n({...e,data:s})},onMouseMove:t=>{if(!m)return;const{step:a,value:r}=j(t),s=[...e.data];s[a]=r,n({...e,data:s})},onMouseUp:_,onMouseLeave:_}),t.jsxs("div",{className:"absolute bottom-0 left-0 right-0 flex items-center gap-4 px-2 py-1 bg-dark-bg/80 text-[9px] font-mono",children:[e.loop>=0?t.jsxs("button",{onClick:()=>{n({...e,loop:-1})},className:"flex items-center gap-1 text-blue-400 hover:text-blue-300",children:[t.jsx(Re,{size:10}),"Loop: ",e.loop,t.jsx("span",{className:"text-text-muted",children:"×"})]}):t.jsx("span",{className:"text-text-muted",children:"No loop"}),e.release>=0?t.jsxs("button",{onClick:()=>{n({...e,release:-1})},className:"flex items-center gap-1 text-red-400 hover:text-red-300",children:[t.jsx(Ve,{size:10}),"Release: ",e.release,t.jsx("span",{className:"text-text-muted",children:"×"})]}):t.jsx("span",{className:"text-text-muted",children:"No release"})]})]})]})},Na=({macros:e,onChange:a,chipType:n=0})=>{const[r,s]=he.useState(null),i=e=>{switch(e){case A.VOL:return{min:0,max:15,bipolar:!1};case A.ARP:return{min:-12,max:12,bipolar:!0};case A.DUTY:return{min:0,max:3,bipolar:!1};case A.WAVE:return{min:0,max:255,bipolar:!1};case A.PITCH:return{min:-128,max:127,bipolar:!0};case A.ALG:case A.FB:return{min:0,max:7,bipolar:!1};default:return{min:0,max:15,bipolar:!1}}},o=e=>{switch(e){case A.VOL:return"#22c55e";case A.ARP:return"#3b82f6";case A.DUTY:return"#f59e0b";case A.WAVE:return"#06b6d4";case A.PITCH:return"#ec4899";default:return"#a78bfa"}},l=Object.entries(_a).filter(([t])=>!e.some(e=>e.type===parseInt(t))).map(([e,t])=>({type:parseInt(e),name:t}));return t.jsxs("div",{className:"space-y-2",children:[e.map((n,l)=>t.jsxs("div",{className:"border border-dark-border rounded-lg overflow-hidden",children:[t.jsxs("div",{className:"flex items-center justify-between px-3 py-2 bg-dark-bg cursor-pointer hover:bg-dark-bgSecondary",onClick:()=>s(r===l?null:l),children:[t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx("div",{className:"w-3 h-3 rounded-sm",style:{backgroundColor:o(n.type)}}),t.jsx("span",{className:"font-mono text-xs font-bold text-text-primary",children:_a[n.type]||`Macro ${n.type}`}),t.jsxs("span",{className:"text-[10px] text-text-muted",children:[n.data.length," steps",n.loop>=0&&` • Loop@${n.loop}`,n.release>=0&&` • Rel@${n.release}`]})]}),t.jsx("button",{onClick:t=>{t.stopPropagation(),(t=>{a(e.filter((e,a)=>a!==t)),r===t&&s(null)})(l)},className:"text-red-400 hover:text-red-300 text-xs",children:"×"})]}),r===l&&t.jsx(ka,{macro:n,macroType:n.type,onChange:t=>((t,n)=>{const r=[...e];r[t]=n,a(r)})(l,t),...i(n.type),color:o(n.type)})]},l)),l.length>0&&t.jsxs("div",{className:"relative group",children:[t.jsxs("button",{className:"w-full py-2 border border-dashed border-dark-border rounded-lg text-text-muted hover:text-text-primary hover:border-accent text-xs font-mono flex items-center justify-center gap-2",children:[t.jsx(Ie,{size:14}),"Add Macro"]}),t.jsx("div",{className:"absolute top-full left-0 right-0 mt-1 bg-dark-bg border border-dark-border rounded-lg shadow-lg z-10 hidden group-hover:block",children:l.slice(0,10).map(({type:n,name:r})=>t.jsxs("button",{onClick:()=>(t=>{const n=i(t),r=n.bipolar?0:n.min,o={type:t,data:Array(16).fill(r),loop:-1,release:-1,mode:0,speed:1};a([...e,o]),s(e.length)})(n),className:"w-full px-3 py-2 text-left text-xs font-mono text-text-primary hover:bg-dark-bgSecondary flex items-center gap-2",children:[t.jsx("div",{className:"w-2 h-2 rounded-sm",style:{backgroundColor:o(n)}}),r]},n))})]})]})},$a=(e,t,a)=>{const n=[],r=a/2;for(let s=0;s<t;s++){const i=s/t;let o;switch(e){case"sine":o=Math.sin(2*i*Math.PI)*r+r;break;case"triangle":o=i<.5?4*i*r:4*(1-i)*r;break;case"saw":o=i*a;break;case"square":o=i<.5?a:0;break;case"pulse25":o=i<.25?a:0;break;case"pulse12":o=i<.125?a:0;break;case"noise":o=Math.random()*a;break;default:o=r}n.push(Math.round(Math.max(0,Math.min(a,o))))}return n},Ca=({wavetable:e,onChange:a,onRemove:n,height:r=180,color:s="#06b6d4"})=>{const i=he.useRef(null),o=he.useRef(null),[l,d]=he.useState(!1),[c,u]=he.useState(!1),m=e.max??15,p=e.data.length||32,h=(e,t)=>{if(e.length===t)return e;const a=[],n=e.length/t;for(let r=0;r<t;r++){const t=r*n,s=Math.floor(t),i=t-s,o=e[s],l=e[(s+1)%e.length];a.push(Math.round(o+(l-o)*i))}return a},f=he.useCallback(()=>{const t=i.current;if(!t)return;const a=t.getContext("2d");if(!a)return;const n=window.devicePixelRatio||1,o=Math.max(320,12*p),l=r;t.width=o*n,t.height=l*n,t.style.width=o+"px",t.style.height=l+"px",a.scale(n,n);const d=o,c=l;a.fillStyle="#1a1a2e",a.fillRect(0,0,d,c),a.strokeStyle="#2a2a4e",a.lineWidth=1;for(let e=1;e<4;e++){const t=c/4*e;a.beginPath(),a.moveTo(0,t),a.lineTo(d,t),a.stroke()}const u=Math.max(1,Math.floor(p/8));for(let e=0;e<p;e+=u){const t=e/p*d;a.beginPath(),a.moveTo(t,0),a.lineTo(t,c),a.stroke()}const h=d/p;e.data.forEach((e,t)=>{const n=t*h,r=e/m*c,i=c-r;a.fillStyle=s,a.fillRect(n,i,h-1,r)}),a.strokeStyle="rgba(255,255,255,0.5)",a.lineWidth=1,a.beginPath(),e.data.forEach((e,t)=>{const n=t/p*d+h/2,r=c-e/m*c;0===t?a.moveTo(n,r):a.lineTo(n,r)}),a.stroke()},[e,m,p,s]);he.useEffect(()=>{f()},[f]);const x=(t,n=!1)=>{if(!l&&!n)return;const r=i.current;if(!r)return;const s=r.getBoundingClientRect(),o=t.clientX-s.left,d=t.clientY-s.top,c=Math.floor(o/s.width*p),u=1-d/s.height,h=Math.round(u*m);if(c>=0&&c<p){const t=[...e.data];t[c]=Math.max(0,Math.min(m,h)),a({...e,data:t})}},g=t=>{if(t<4||t>256)return;const n=[];for(let a=0;a<t;a++){const r=a/t*e.data.length,s=Math.floor(r),i=Math.min(e.data.length-1,s+1),o=r-s,l=e.data[s]*(1-o)+e.data[i]*o;n.push(Math.round(l))}a({...e,data:n,len:t})};return t.jsxs("div",{className:"bg-dark-bgSecondary rounded-lg border border-dark-border overflow-hidden",children:[t.jsxs("div",{className:"flex items-center justify-between px-3 py-2 bg-dark-bg border-b border-dark-border",children:[t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx(Be,{size:14,className:"text-cyan-400"}),t.jsxs("span",{className:"font-mono text-[10px] font-bold text-text-primary",children:["Wave ",e.id]}),t.jsxs("span",{className:"text-[9px] text-text-muted",children:[p,"×",m+1]})]}),t.jsxs("div",{className:"flex items-center gap-1",children:[t.jsx("button",{onClick:()=>o.current?.click(),className:"p-1 text-cyan-400 hover:bg-cyan-500/20 rounded",title:"Import .wav or .h wave",children:t.jsx(Le,{size:14})}),t.jsx("input",{ref:o,type:"file",accept:".wav,.h",onChange:async t=>{const n=t.target.files?.[0];if(n){try{if(n.name.endsWith(".h")){const t=(await n.text()).split(/[\s,]+/).map(e=>parseInt(e)).filter(e=>!isNaN(e));if(t.length>0){const n=Math.max(...t),r=t.map(e=>Math.round(e/n*m)),s=h(r,p);a({...e,data:s})}}else{const t=new(window.AudioContext||window.webkitAudioContext),r=await n.arrayBuffer(),s=(await t.decodeAudioData(r)).getChannelData(0),i=Array.from(s).map(e=>Math.round((e+1)/2*m)),o=h(i,p);a({...e,data:o})}}catch(r){}o.current&&(o.current.value="")}},className:"hidden"}),t.jsxs("div",{className:"relative",children:[t.jsx("button",{onClick:()=>u(!c),className:"p-1 text-amber-400 hover:bg-amber-500/20 rounded",title:"Generate waveform",children:t.jsx(Fe,{size:14})}),c&&t.jsx("div",{className:"absolute top-full right-0 mt-1 bg-dark-bg border border-dark-border rounded shadow-lg z-20 min-w-[120px]",children:["sine","triangle","saw","square","pulse25","pulse12","noise"].map(n=>t.jsx("button",{onClick:()=>(t=>{const n=$a(t,p,m);a({...e,data:n}),u(!1)})(n),className:"w-full px-3 py-1.5 text-left text-[10px] font-mono text-text-primary hover:bg-dark-bgSecondary capitalize",children:n},n))})]}),t.jsx("button",{onClick:()=>{const t=e.data.map(e=>m-e);a({...e,data:t})},className:"p-1 text-text-muted hover:text-text-primary hover:bg-dark-border/50 rounded",title:"Invert",children:t.jsx(De,{size:14})}),t.jsx("button",{onClick:()=>{const t=Math.floor(m/2);a({...e,data:Array(p).fill(t)})},className:"p-1 text-text-muted hover:text-text-primary hover:bg-dark-border/50 rounded",title:"Clear",children:t.jsx(Pe,{size:14})}),n&&t.jsx("button",{onClick:n,className:"p-1 text-red-400 hover:text-red-300 hover:bg-red-500/20 rounded",title:"Remove wavetable",children:t.jsx(We,{size:14})})]})]}),t.jsx("div",{className:"relative",children:t.jsx("canvas",{ref:i,width:Math.max(320,12*p),height:r,className:"cursor-crosshair",onMouseDown:e=>{d(!0),x(e,!0)},onMouseMove:e=>x(e),onMouseUp:()=>d(!1),onMouseLeave:()=>d(!1)})}),t.jsxs("div",{className:"flex items-center justify-between px-3 py-2 bg-dark-bg border-t border-dark-border text-[9px] font-mono",children:[t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx("span",{className:"text-text-muted",children:"Length:"}),t.jsx("button",{onClick:()=>g(p/2),className:"text-text-muted hover:text-text-primary",disabled:p<=4,children:"÷2"}),t.jsx("span",{className:"text-text-primary",children:p}),t.jsx("button",{onClick:()=>g(2*p),className:"text-text-muted hover:text-text-primary",disabled:p>=256,children:"×2"})]}),t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx("span",{className:"text-text-muted",children:"Height:"}),t.jsxs("select",{value:m,onChange:t=>(t=>{if(t<1||t>255)return;const n=t/m,r=e.data.map(e=>Math.round(e*n));a({...e,data:r,max:t})})(parseInt(t.target.value)),className:"bg-dark-bgSecondary border border-dark-border rounded px-1 py-0.5 text-text-primary",children:[t.jsx("option",{value:3,children:"4"}),t.jsx("option",{value:7,children:"8"}),t.jsx("option",{value:15,children:"16"}),t.jsx("option",{value:31,children:"32"}),t.jsx("option",{value:63,children:"64"}),t.jsx("option",{value:127,children:"128"}),t.jsx("option",{value:255,children:"256"})]})]})]})]})},Sa=({wavetables:e,onChange:a,maxWavetables:n=64})=>{const[r,s]=he.useState(e.length>0?0:null),i=()=>{if(e.length>=n)return;const t={id:e.length>0?Math.max(...e.map(e=>e.id))+1:0,data:$a("sine",32,15),len:32,max:15};a([...e,t]),s(e.length)};return t.jsxs("div",{className:"space-y-3",children:[t.jsxs("div",{className:"flex items-center gap-2 flex-wrap",children:[e.map((e,a)=>t.jsxs("button",{onClick:()=>s(a),className:`\n              px-3 py-1.5 rounded font-mono text-[10px] border transition-colors\n              ${r===a?"bg-cyan-500/20 border-cyan-500 text-cyan-400":"bg-dark-bg border-dark-border text-text-muted hover:text-text-primary hover:border-dark-border/80"}\n            `,children:["Wave ",e.id]},e.id)),e.length<n&&t.jsxs(t.Fragment,{children:[t.jsxs("button",{onClick:i,className:"px-3 py-1.5 rounded border border-dashed border-dark-border text-text-muted hover:text-text-primary hover:border-accent text-[10px] font-mono flex items-center gap-1",children:[t.jsx(Ie,{size:12}),"Add"]}),null!==r&&t.jsxs("button",{onClick:()=>(t=>{if(e.length>=n)return;const r=e[t],i=Math.max(...e.map(e=>e.id))+1,o={...r,id:i,data:[...r.data]};a([...e,o]),s(e.length)})(r),className:"px-3 py-1.5 rounded border border-dashed border-dark-border text-text-muted hover:text-text-primary hover:border-cyan-500 text-[10px] font-mono flex items-center gap-1",children:[t.jsx(De,{size:12}),"Duplicate"]})]})]}),null!==r&&e[r]&&t.jsx(Ca,{wavetable:e[r],onChange:t=>((t,n)=>{const r=[...e];r[t]=n,a(r)})(r,t),onRemove:e.length>1?()=>(t=>{const n=e.filter((e,a)=>a!==t);a(n),r===t?s(n.length>0?Math.min(t,n.length-1):null):null!==r&&r>t&&s(r-1)})(r):void 0}),0===e.length&&t.jsxs("div",{className:"text-center py-8 text-text-muted text-sm",children:[t.jsx(Be,{size:32,className:"mx-auto mb-2 opacity-50"}),t.jsx("p",{children:"No wavetables"}),t.jsx("button",{onClick:i,className:"mt-2 text-accent hover:underline text-xs",children:"Add your first wavetable"})]})]})};const Ma=({tl:e,ar:a,dr:n,d2r:r,rr:s,sl:i,maxTl:o,maxArDr:l,hasD2R:d,width:c=120,height:u=48,color:m="#f59e0b"})=>{const p=fe.useRef(null);return fe.useEffect(()=>{const t=p.current;if(!t)return;const h=t.getContext("2d");if(!h)return;const f=window.devicePixelRatio||1;t.width=c*f,t.height=u*f,h.scale(f,f);const x=c,g=u;h.clearRect(0,0,x,g),h.fillStyle="#0f172a",h.fillRect(0,0,x,g),h.strokeStyle="#1e293b",h.lineWidth=.5;for(let e=1;e<4;e++)h.beginPath(),h.moveTo(0,g/4*e),h.lineTo(x,g/4*e),h.stroke();const b=1-e/o,y=l>0?.3*(1-a/l):0,v=l>0?.25*(1-n/l):0,w=b*(1-i/15),j=d&&r>0?.25*(1-r/31):.15,_=d&&r>0?.5*w:w,k=.2*(1-s/15);h.beginPath(),h.strokeStyle=m,h.lineWidth=2;const N=x-4,$=g-4;let C=2,S=g-2;h.moveTo(C,S),C+=y*N,S=2+$*(1-b),h.lineTo(C,S),C+=v*N,S=2+$*(1-w),h.lineTo(C,S),d&&r>0?(C+=j*N,S=2+$*(1-_),h.lineTo(C,S)):(C+=.15*N,h.lineTo(C,S)),C+=k*N,S=g-2,h.lineTo(C,S),h.lineTo(x-2,S),h.stroke(),h.lineTo(x-2,g-2),h.lineTo(2,g-2),h.closePath(),h.fillStyle=`${m}15`,h.fill()},[e,a,n,r,s,i,o,l,d,m,c,u]),t.jsx("canvas",{ref:p,width:c,height:u,className:"rounded border border-dark-border w-full",style:{maxWidth:"100%"}})},za=({algorithm:e,feedback:a,opCount:n=4})=>{const r=[{ops:[[4,3],[3,2],[2,1]],carriers:[1]},{ops:[[4,2],[3,2],[2,1]],carriers:[1]},{ops:[[4,3],[3,1],[2,1]],carriers:[1]},{ops:[[4,3],[3,1],[2,1]],carriers:[1]},{ops:[[4,3],[2,1]],carriers:[3,1]},{ops:[[4,3],[4,2],[4,1]],carriers:[3,2,1]},{ops:[[4,3]],carriers:[3,2,1]},{ops:[],carriers:[4,3,2,1]}],s=r[e]||r[0];return t.jsxs("div",{className:"bg-dark-bg rounded border border-dark-border p-2",children:[t.jsxs("svg",{viewBox:"0 0 120 50",className:"w-full h-12",children:[[4,3,2,1].map((e,a)=>{const n=10+28*a,r=s.carriers.includes(e);return t.jsxs("g",{children:[t.jsx("rect",{x:n,y:15,width:20,height:20,rx:2,fill:r?"#f59e0b":"#3b82f6",stroke:r?"#fbbf24":"#60a5fa",strokeWidth:1}),t.jsx("text",{x:n+10,y:29,textAnchor:"middle",fontSize:"10",fill:"white",fontWeight:"bold",children:e})]},e)}),a>0&&t.jsx("path",{d:"M 20 15 Q 20 5 30 5 Q 40 5 40 15",fill:"none",stroke:"#f472b6",strokeWidth:1,strokeDasharray:"2,1"}),t.jsx("path",{d:"M 110 25 L 118 25",fill:"none",stroke:"#22c55e",strokeWidth:2}),t.jsx("polygon",{points:"118,25 114,22 114,28",fill:"#22c55e"}),s.ops.map(([e,a],n)=>{const r=10+28*(4-e)+20,s=10+28*(4-a);return t.jsx("line",{x1:r,y1:25,x2:s,y2:25,stroke:"#64748b",strokeWidth:1},n)})]}),t.jsxs("div",{className:"text-[9px] text-center text-text-muted font-mono",children:["ALG ",e," • FB ",a]})]})},Ta=({config:e,instrumentId:a,onChange:n})=>{const[r,s]=he.useState("fm"),[i,o]=he.useState(new Set([0,1,2,3])),l=he.useRef(null),d=he.useCallback((t,a)=>{const r=[...e.operators];r[t]={...r[t],...a},n({operators:r})},[e.operators,n]),c=he.useCallback(e=>{o(t=>{const a=new Set(t);return a.has(e)?a.delete(e):a.add(e),a})},[]),u={0:"Sega Genesis (YM2612)",1:"Arcade / X68000 (YM2151)",2:"AdLib / Sound Blaster (OPL3)",3:"Sega Master System (SN76489)",4:"Nintendo NES (2A03)",5:"Nintendo Game Boy (LR35902)",6:"PC Engine / TurboGrafx (HuC6280)",7:"Konami MSX (SCC)",8:"Namco Arcade (N163)",9:"Famicom (VRC6)",10:"Commodore 64 (SID)",11:"MSX / Sega (OPLL)",12:"ZX Spectrum / Amstrad (AY-3-8910)",13:"NEC PC-98 (OPNA)",14:"Neo Geo (OPNB)",15:"Atari 2600 (TIA)",16:"Famicom Disk System",17:"Famicom (MMC5)",18:"SAM Coupe (SAA1099)",19:"Bandai WonderSwan",20:"Arcade (OKI MSM6295)",21:"Ensoniq (ES5506)",22:"Yamaha TX81Z (OPZ)",23:"MSX-Audio (Y8950)",24:"Super Nintendo (SPC700)",25:"Atari Lynx",26:"Yamaha (OPL4)",27:"Sega Arcade (SegaPCM)",28:"Yamaha (YMZ280B)",29:"Sega CD (RF5C68)",30:"Irem Arcade (GA20)",31:"Namco Arcade (C140)",32:"Capcom Arcade (QSound)",33:"Commodore VIC-20",34:"Commodore Plus/4 (TED)",35:"Watara Supervision",36:"Commander X16 (VERA)",37:"Game Gear (SM8521)",38:"Konami Bubble System",39:"Konami Arcade (K007232)",40:"Konami Arcade (K053260)",41:"Seta Arcade (X1-010)",42:"NEC (μPD1771)",43:"Toshiba (T6W28)",44:"Nintendo Virtual Boy"}[m=e.chipType]||`Unknown Chip (${m})`;var m;const p=function(e){return[0,1,2,11,13,14,22,23,26].includes(e)?"FM":[3,4,5,12,15,16,17,18,33,34,35,43,44].includes(e)?"PSG":[6,7,8,9,19,36,37,38].includes(e)?"Wavetable":[10,20,21,24,25,27,28,29,30,31,32,39,40,41,42].includes(e)?"PCM":"Other"}(e.chipType),h=he.useMemo(()=>{return t=e.chipType,[0,13,14].includes(t)?{tl:{min:0,max:127},ar:{min:0,max:31},dr:{min:0,max:31},d2r:{min:0,max:31},rr:{min:0,max:15},sl:{min:0,max:15},mult:{min:0,max:15},dt:{min:-3,max:3},rs:{min:0,max:3},hasD2R:!0,hasSSG:!0,hasWS:!1,hasDT2:!1,opCount:4}:1===t?{tl:{min:0,max:127},ar:{min:0,max:31},dr:{min:0,max:31},d2r:{min:0,max:31},rr:{min:0,max:15},sl:{min:0,max:15},mult:{min:0,max:15},dt:{min:-3,max:3},dt2:{min:0,max:3},rs:{min:0,max:3},hasD2R:!0,hasSSG:!1,hasWS:!1,hasDT2:!0,opCount:4}:[2,23,26].includes(t)?{tl:{min:0,max:63},ar:{min:0,max:15},dr:{min:0,max:15},d2r:{min:0,max:0},rr:{min:0,max:15},sl:{min:0,max:15},mult:{min:0,max:15},dt:{min:0,max:0},rs:{min:0,max:0},ksl:{min:0,max:3},ws:{min:0,max:7},hasD2R:!1,hasSSG:!1,hasWS:!0,hasDT2:!1,opCount:4}:11===t?{tl:{min:0,max:63},ar:{min:0,max:15},dr:{min:0,max:15},d2r:{min:0,max:0},rr:{min:0,max:15},sl:{min:0,max:15},mult:{min:0,max:15},dt:{min:0,max:0},rs:{min:0,max:0},ksl:{min:0,max:3},hasD2R:!1,hasSSG:!1,hasWS:!1,hasDT2:!1,opCount:2}:22===t?{tl:{min:0,max:127},ar:{min:0,max:31},dr:{min:0,max:31},d2r:{min:0,max:31},rr:{min:0,max:15},sl:{min:0,max:15},mult:{min:0,max:15},dt:{min:-3,max:3},dt2:{min:0,max:3},rs:{min:0,max:3},hasD2R:!0,hasSSG:!1,hasWS:!1,hasDT2:!0,opCount:4}:{tl:{min:0,max:127},ar:{min:0,max:31},dr:{min:0,max:31},d2r:{min:0,max:31},rr:{min:0,max:15},sl:{min:0,max:15},mult:{min:0,max:15},dt:{min:-3,max:3},rs:{min:0,max:3},hasD2R:!0,hasSSG:!0,hasWS:!1,hasDT2:!1,opCount:4};var t},[e.chipType]),f=he.useMemo(()=>2===h.opCount?[0,1]:[0,2,1,3],[h.opCount]);return t.jsxs("div",{className:"space-y-4",children:[t.jsxs("div",{className:"flex items-center justify-between bg-dark-bgSecondary p-3 rounded-lg border border-dark-border/50",children:[t.jsxs("div",{className:"flex items-center gap-3",children:[t.jsx("div",{className:"w-10 h-10 bg-gradient-to-br from-indigo-600 to-violet-700 rounded flex items-center justify-center shadow-lg shadow-indigo-900/20",children:t.jsx(Ue,{size:20,className:"text-white"})}),t.jsxs("div",{children:[t.jsx("h2",{className:"font-bold text-white text-sm tracking-tight",children:u}),t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsxs("span",{className:"text-[10px] text-text-muted font-mono uppercase bg-dark-bg px-1.5 py-0.5 rounded border border-dark-border",children:[p," • ",h.opCount,"OP"]}),t.jsxs("span",{className:"text-[10px] text-emerald-400 font-mono flex items-center gap-1",children:[t.jsx(Se,{size:8})," Ready"]})]})]})]}),t.jsx("div",{className:"flex-1 mx-4",children:t.jsx(aa,{instrumentId:a,width:"auto",height:40,color:"#a78bfa",backgroundColor:"transparent",className:"w-full rounded border border-violet-500/20"})}),t.jsxs("div",{className:"flex gap-3",children:[t.jsx(I,{label:"FMS",value:e.fms??0,min:0,max:7,onChange:e=>n({fms:Math.round(e)}),size:"sm",color:"#8b5cf6",formatValue:e=>String(Math.round(e))}),t.jsx(I,{label:"AMS",value:e.ams??0,min:0,max:3,onChange:e=>n({ams:Math.round(e)}),size:"sm",color:"#a78bfa",formatValue:e=>String(Math.round(e))})]})]}),"FM"===p&&t.jsx("div",{className:"flex gap-1 bg-dark-bg p-1 rounded-lg border border-dark-border",children:["fm","macros","chip"].map(e=>t.jsx("button",{onClick:()=>s(e),className:"flex-1 py-1.5 px-3 rounded text-xs font-mono uppercase transition-colors "+(r===e?"bg-amber-600 text-white":"text-text-muted hover:text-white hover:bg-dark-bgSecondary"),children:"fm"===e?"Operators":"macros"===e?"Macros":"Settings"},e))}),"FM"===p&&"fm"===r&&t.jsxs("div",{className:"space-y-4 animate-in fade-in duration-200",children:[t.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[t.jsx("div",{className:"md:col-span-2",children:t.jsx(za,{algorithm:e.algorithm,feedback:e.feedback,opCount:h.opCount})}),t.jsx("div",{className:"bg-dark-bgSecondary p-3 rounded-lg border border-dark-border",children:t.jsxs("div",{className:"flex flex-wrap gap-6",children:[t.jsx(I,{label:"ALG",value:e.algorithm,min:0,max:7,onChange:e=>n({algorithm:Math.round(e)}),size:"md",color:"#f59e0b",formatValue:e=>String(Math.round(e))}),t.jsx(I,{label:"FB",value:e.feedback,min:0,max:7,onChange:e=>n({feedback:Math.round(e)}),size:"md",color:"#d97706",formatValue:e=>String(Math.round(e))})]})})]}),t.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-3",children:f.slice(0,h.opCount).map(a=>t.jsx(Ea,{index:a,op:e.operators[a],onUpdate:e=>d(a,e),ranges:h,isExpanded:i.has(a),onToggleExpand:()=>c(a),isCarrier:qa(e.algorithm,a)},a))})]}),"FM"===p&&"macros"===r&&t.jsxs("div",{className:"bg-dark-bgSecondary p-4 rounded-lg border border-dark-border animate-in fade-in duration-200",children:[t.jsxs("div",{className:"flex items-center gap-2 mb-4",children:[t.jsx(Ee,{size:16,className:"text-violet-400"}),t.jsx("h3",{className:"font-mono text-xs font-bold text-text-primary uppercase",children:"Macro Editor"}),t.jsx("span",{className:"text-[9px] text-text-muted",children:"Draw to edit • Loop (blue) • Release (red)"})]}),t.jsx(Na,{macros:e.macros,onChange:e=>n({macros:e}),chipType:e.chipType})]}),"FM"===p&&"chip"===r&&t.jsxs("div",{className:"bg-dark-bgSecondary p-4 rounded-lg border border-dark-border animate-in fade-in duration-200",children:[t.jsxs("div",{className:"flex items-center gap-2 mb-4",children:[t.jsx(qe,{size:16,className:"text-cyan-400"}),t.jsx("h3",{className:"font-mono text-xs font-bold text-text-primary uppercase",children:"Chip Settings"})]}),t.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-4 gap-4",children:[void 0!==e.opllPreset&&t.jsxs("div",{children:[t.jsx("label",{className:"text-[10px] text-text-muted font-mono block mb-1",children:"OPLL Preset"}),t.jsx("select",{value:e.opllPreset,onChange:e=>n({opllPreset:parseInt(e.target.value)}),className:"w-full bg-dark-bg border border-dark-border rounded px-2 py-1 text-xs text-white",children:Ha.map((e,a)=>t.jsxs("option",{value:a,children:[a,": ",e]},a))})]}),h.hasDT2&&t.jsx("div",{className:"flex justify-center",children:t.jsx(I,{label:"FMS2",value:e.fms2??0,min:0,max:7,onChange:e=>n({fms2:Math.round(e)}),size:"sm",color:"#06b6d4",formatValue:e=>String(Math.round(e))})})]})]}),5===e.chipType&&t.jsx(Oa,{config:e,onChange:n}),10===e.chipType&&t.jsx(Pa,{config:e,onChange:n}),24===e.chipType&&t.jsx(Ba,{config:e,onChange:n}),"PSG"===p&&![5,10,24].includes(e.chipType)&&t.jsx(Fa,{config:e,onChange:n}),("Wavetable"===p||e.wavetables.length>0)&&t.jsxs("div",{className:"bg-dark-bgSecondary p-4 rounded-lg border border-dark-border animate-in fade-in slide-in-from-top-2",children:[t.jsxs("div",{className:"flex items-center gap-2 mb-4",children:[t.jsx(Be,{size:16,className:"text-cyan-400"}),t.jsxs("h3",{className:"font-mono text-xs font-bold text-text-primary uppercase tracking-wider",children:["Wavetable Editor (",e.wavetables.length," waves)"]}),t.jsx("button",{onClick:()=>l.current?.click(),className:"p-1 text-text-muted hover:text-cyan-400 transition-colors",title:"Import .wav or .fuw wave",children:t.jsx(Le,{size:14})}),t.jsx("input",{ref:l,type:"file",accept:".wav,.fuw",onChange:async t=>{const a=t.target.files?.[0];if(a){try{if(a.name.endsWith(".fuw")){const t=await a.arrayBuffer(),r=new DataView(t),s=[];for(let e=32;e<t.byteLength;e+=4)e+4<=t.byteLength&&s.push(r.getUint32(e,!0));if(s.length>0){const t=[...e.wavetables,{id:e.wavetables.length,data:s,len:s.length,max:Math.max(...s)}];n({wavetables:t})}}else{const t=new(window.AudioContext||window.webkitAudioContext),r=await a.arrayBuffer(),s=(await t.decodeAudioData(r)).getChannelData(0),i=Array.from(s).map(e=>Math.round((e+1)/2*15)),o=[...e.wavetables,{id:e.wavetables.length,data:i,len:i.length,max:15}];n({wavetables:o})}}catch(r){}l.current&&(l.current.value="")}},className:"hidden"}),t.jsx("span",{className:"text-[9px] text-text-muted",children:"Draw to edit waveforms"})]}),t.jsx(Sa,{wavetables:e.wavetables,onChange:e=>n({wavetables:e})})]}),"FM"!==p&&t.jsxs("div",{className:"bg-dark-bgSecondary p-4 rounded-lg border border-dark-border animate-in fade-in slide-in-from-top-2",children:[t.jsxs("div",{className:"flex items-center gap-2 mb-4",children:[t.jsx(Ee,{size:16,className:"text-violet-400"}),t.jsxs("h3",{className:"font-mono text-xs font-bold text-text-primary uppercase tracking-wider",children:["Macros (",e.macros.length,")"]}),t.jsx("span",{className:"text-[9px] text-text-muted",children:"Draw to edit • Loop (blue) • Release (red)"})]}),t.jsx(Na,{macros:e.macros,onChange:e=>n({macros:e}),chipType:e.chipType})]}),"PCM"===p&&t.jsx(Ua,{config:e,onChange:n})]})},Ea=({index:e,op:a,onUpdate:n,ranges:r,isExpanded:s,onToggleExpand:i,isCarrier:o})=>{const l=o?"border-amber-500/30":"border-blue-500/30",d=o?"#f59e0b":"#3b82f6",c=o?"from-amber-950/20 to-transparent":"from-blue-950/20 to-transparent";return t.jsxs("div",{className:`bg-gradient-to-br ${c} bg-dark-bgSecondary p-3 rounded-lg border ${l} transition-colors`,children:[t.jsxs("div",{className:"flex items-center justify-between mb-2",children:[t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx("button",{onClick:i,className:"text-text-muted hover:text-white transition-colors",children:s?t.jsx(we,{size:14}):t.jsx(He,{size:14})}),t.jsx("div",{className:"w-6 h-6 rounded flex items-center justify-center font-mono text-xs font-bold border",style:{backgroundColor:`${d}20`,borderColor:`${d}50`,color:d},children:e+1}),t.jsxs("div",{children:[t.jsxs("span",{className:"font-mono text-[10px] font-bold text-text-primary uppercase",children:["OP",e+1]}),t.jsx("span",{className:"text-[9px] text-text-muted ml-2",children:o?"Carrier":"Modulator"})]})]}),t.jsx("button",{onClick:()=>n({enabled:!a.enabled}),className:"text-[9px] font-mono px-2 py-0.5 rounded border transition-colors "+(a.enabled?"bg-emerald-600/20 border-emerald-500/50 text-emerald-400":"bg-dark-bg border-dark-border text-text-muted"),children:a.enabled?"ON":"OFF"})]}),t.jsx("div",{className:"mb-3 w-full",children:t.jsx(Ma,{tl:a.tl,ar:a.ar,dr:a.dr,d2r:a.d2r??0,rr:a.rr,sl:a.sl,maxTl:r.tl.max,maxArDr:r.ar.max,hasD2R:r.hasD2R,color:d,width:280,height:48})}),t.jsxs("div",{className:"flex justify-between items-center gap-1 mb-2",children:[t.jsx(I,{label:"TL",value:a.tl,min:r.tl.min,max:r.tl.max,onChange:e=>n({tl:Math.round(e)}),size:"sm",color:"#ef4444",formatValue:e=>String(Math.round(e))}),t.jsx(I,{label:"MULT",value:a.mult,min:r.mult.min,max:r.mult.max,onChange:e=>n({mult:Math.round(e)}),size:"sm",color:"#22d3ee",formatValue:e=>String(Math.round(e))}),t.jsx(I,{label:"DT",value:a.dt,min:r.dt.min,max:r.dt.max,onChange:e=>n({dt:Math.round(e)}),size:"sm",color:"#a78bfa",formatValue:e=>{const t=Math.round(e);return t>0?`+${t}`:String(t)}})]}),t.jsxs("div",{className:"flex justify-between items-center gap-1 mb-2",children:[t.jsx(I,{label:"AR",value:a.ar,min:r.ar.min,max:r.ar.max,onChange:e=>n({ar:Math.round(e)}),size:"sm",color:"#10b981",formatValue:e=>String(Math.round(e))}),t.jsx(I,{label:"DR",value:a.dr,min:r.dr.min,max:r.dr.max,onChange:e=>n({dr:Math.round(e)}),size:"sm",color:"#f59e0b",formatValue:e=>String(Math.round(e))}),t.jsx(I,{label:"SL",value:a.sl,min:r.sl.min,max:r.sl.max,onChange:e=>n({sl:Math.round(e)}),size:"sm",color:"#8b5cf6",formatValue:e=>String(Math.round(e))}),t.jsx(I,{label:"RR",value:a.rr,min:r.rr.min,max:r.rr.max,onChange:e=>n({rr:Math.round(e)}),size:"sm",color:"#ec4899",formatValue:e=>String(Math.round(e))})]}),s&&t.jsxs("div",{className:"pt-2 border-t border-dark-border mt-1 animate-in slide-in-from-top-2 duration-200",children:[t.jsxs("div",{className:"flex justify-center items-center gap-3 mb-2",children:[r.hasD2R&&t.jsx(I,{label:"D2R",value:a.d2r??0,min:r.d2r.min,max:r.d2r.max,onChange:e=>n({d2r:Math.round(e)}),size:"sm",color:"#fb923c",formatValue:e=>String(Math.round(e))}),r.rs.max>0&&t.jsx(I,{label:"RS",value:a.rs,min:r.rs.min,max:r.rs.max,onChange:e=>n({rs:Math.round(e)}),size:"sm",color:"#06b6d4",formatValue:e=>String(Math.round(e))}),r.hasDT2&&t.jsx(I,{label:"DT2",value:a.dt2??0,min:0,max:3,onChange:e=>n({dt2:Math.round(e)}),size:"sm",color:"#c084fc",formatValue:e=>String(Math.round(e))}),r.ksl&&t.jsx(I,{label:"KSL",value:a.ksl,min:r.ksl.min,max:r.ksl.max,onChange:e=>n({ksl:Math.round(e)}),size:"sm",color:"#fbbf24",formatValue:e=>String(Math.round(e))}),r.hasWS&&t.jsx(I,{label:"WS",value:a.ws,min:0,max:7,onChange:e=>n({ws:Math.round(e)}),size:"sm",color:"#34d399",formatValue:e=>String(Math.round(e))})]}),t.jsxs("div",{className:"flex justify-center gap-2",children:[t.jsx(Aa,{label:"AM",value:a.am,onChange:e=>n({am:e})}),r.hasSSG&&t.jsx(Aa,{label:"SSG",value:(a.ssg??0)>0,onChange:e=>n({ssg:e?8:0})}),r.hasWS&&t.jsxs(t.Fragment,{children:[t.jsx(Aa,{label:"VIB",value:a.vib,onChange:e=>n({vib:e})}),t.jsx(Aa,{label:"SUS",value:a.sus,onChange:e=>n({sus:e})}),t.jsx(Aa,{label:"KSR",value:a.ksr,onChange:e=>n({ksr:e})})]})]})]})]})},Aa=({label:e,value:a,onChange:n})=>t.jsx("button",{onClick:()=>n(!a),className:"text-[9px] font-mono px-1.5 py-0.5 rounded border transition-colors "+(a?"bg-cyan-600/20 border-cyan-500/50 text-cyan-400":"bg-dark-bg border-dark-border text-text-muted hover:text-white"),children:e}),Ia={envVol:15,envDir:0,envLen:2,soundLen:0,softEnv:!1,alwaysInit:!0},Oa=({config:e,onChange:a})=>{const n=he.useMemo(()=>({...Ia,...e.gb}),[e.gb]),r=he.useCallback(t=>{a({gb:{...e.gb,...Ia,...t}})},[e.gb,a]);return t.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4 animate-in fade-in slide-in-from-top-2",children:[t.jsxs("div",{className:"bg-dark-bgSecondary p-4 rounded-lg border border-emerald-500/30",children:[t.jsxs("div",{className:"flex items-center gap-2 mb-4",children:[t.jsx(Ee,{size:16,className:"text-emerald-400"}),t.jsx("h3",{className:"font-mono text-xs font-bold text-text-primary uppercase",children:"GB Envelope"})]}),t.jsxs("div",{className:"space-y-4",children:[t.jsxs("div",{className:"flex justify-between gap-4",children:[t.jsx(I,{label:"VOL",value:n.envVol,min:0,max:15,onChange:e=>r({envVol:Math.round(e)}),size:"md",color:"#34d399",formatValue:e=>String(Math.round(e))}),t.jsx(I,{label:"LEN",value:n.envLen,min:0,max:7,onChange:e=>r({envLen:Math.round(e)}),size:"md",color:"#10b981",formatValue:e=>String(Math.round(e))}),t.jsx(I,{label:"SND",value:n.soundLen,min:0,max:64,onChange:e=>r({soundLen:Math.round(e)}),size:"md",color:"#059669",formatValue:e=>0===e||e>63?"∞":String(Math.round(e))})]}),t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx("span",{className:"text-[10px] text-text-muted font-mono",children:"Direction:"}),t.jsx("button",{onClick:()=>r({envDir:1}),className:"px-3 py-1 text-[10px] font-mono rounded border transition-colors "+(1===n.envDir?"bg-emerald-600/20 border-emerald-500/50 text-emerald-400":"bg-dark-bg border-dark-border text-text-muted hover:text-white"),children:"↑ UP"}),t.jsx("button",{onClick:()=>r({envDir:0}),className:"px-3 py-1 text-[10px] font-mono rounded border transition-colors "+(0===n.envDir?"bg-rose-600/20 border-rose-500/50 text-rose-400":"bg-dark-bg border-dark-border text-text-muted hover:text-white"),children:"↓ DOWN"})]}),t.jsxs("div",{className:"flex flex-wrap gap-2 pt-2 border-t border-dark-border",children:[t.jsx("button",{onClick:()=>r({softEnv:!n.softEnv}),className:"px-2 py-1 text-[9px] font-mono rounded border transition-colors "+(n.softEnv?"bg-cyan-600/20 border-cyan-500/50 text-cyan-400":"bg-dark-bg border-dark-border text-text-muted"),children:"Soft Envelope"}),t.jsx("button",{onClick:()=>r({alwaysInit:!n.alwaysInit}),className:"px-2 py-1 text-[9px] font-mono rounded border transition-colors "+(n.alwaysInit?"bg-cyan-600/20 border-cyan-500/50 text-cyan-400":"bg-dark-bg border-dark-border text-text-muted"),children:"Always Init"})]})]})]}),t.jsxs("div",{className:"bg-dark-bgSecondary p-4 rounded-lg border border-dark-border",children:[t.jsxs("div",{className:"flex items-center gap-2 mb-4",children:[t.jsx(Be,{size:16,className:"text-emerald-400"}),t.jsx("h3",{className:"font-mono text-xs font-bold text-text-primary uppercase",children:"Envelope Shape"})]}),t.jsx(Ra,{envVol:n.envVol,envLen:n.envLen,soundLen:n.soundLen,envDir:n.envDir})]})]})},Ra=({envVol:e,envLen:a,soundLen:n,envDir:r})=>{const s=he.useRef(null),i=200,o=80;return he.useEffect(()=>{const t=s.current;if(!t)return;const l=t.getContext("2d");if(!l)return;const d=window.devicePixelRatio||1;t.width=i*d,t.height=o*d,l.scale(d,d),l.clearRect(0,0,i,o),l.fillStyle="#020617",l.fillRect(0,0,i,o),l.strokeStyle="#1e293b",l.setLineDash([2,2]);for(let e=0;e<=4;e++){const t=e/4*o;l.beginPath(),l.moveTo(0,t),l.lineTo(i,t),l.stroke()}l.setLineDash([]),l.beginPath(),l.strokeStyle="#34d399",l.lineWidth=2;const c=0===a?1:16-e,u=0===n||n>63?i:n/64*i,m=o-(1===r?0:e)/15*72-4,p=o-(1===r?e:0)/15*72-4;if(l.moveTo(0,m),0===a)l.lineTo(u,m);else{const e=Math.min(c*a*4,u);l.lineTo(e,p),e<u&&l.lineTo(u,p)}l.stroke(),l.font="9px monospace",l.fillStyle="#64748b",l.fillText(`V:${e}`,4,12),l.fillText(`L:${a}`,4,24),l.fillText(1===r?"↑":"↓",188,12)},[e,a,n,r]),t.jsx("canvas",{ref:s,width:i,height:o,className:"w-full rounded border border-dark-border",style:{height:o}})},Va={triOn:!1,sawOn:!0,pulseOn:!1,noiseOn:!1,a:0,d:8,s:8,r:4,duty:2048,ringMod:!1,oscSync:!1,toFilter:!1,filterCutoff:1024,filterResonance:0,filterLP:!1,filterBP:!1,filterHP:!1},Pa=({config:e,onChange:a})=>{const n=he.useMemo(()=>({...Va,...e.c64}),[e.c64]),r=he.useCallback(t=>{a({c64:{...e.c64,...Va,...t}})},[e.c64,a]);return t.jsxs("div",{className:"space-y-4 animate-in fade-in slide-in-from-top-2",children:[t.jsxs("div",{className:"bg-dark-bgSecondary p-4 rounded-lg border border-violet-500/30",children:[t.jsxs("div",{className:"flex items-center gap-2 mb-4",children:[t.jsx(Be,{size:16,className:"text-violet-400"}),t.jsx("h3",{className:"font-mono text-xs font-bold text-text-primary uppercase",children:"Waveform"})]}),t.jsxs("div",{className:"flex gap-2",children:[t.jsx("button",{onClick:()=>r({triOn:!n.triOn}),className:"px-4 py-2 text-[10px] font-mono rounded border transition-colors "+(n.triOn?"bg-emerald-600/20 border-emerald-500/50 text-emerald-400":"bg-dark-bg border-dark-border text-text-muted hover:text-white"),children:"TRI"}),t.jsx("button",{onClick:()=>r({sawOn:!n.sawOn}),className:"px-4 py-2 text-[10px] font-mono rounded border transition-colors "+(n.sawOn?"bg-amber-600/20 border-amber-500/50 text-amber-400":"bg-dark-bg border-dark-border text-text-muted hover:text-white"),children:"SAW"}),t.jsx("button",{onClick:()=>r({pulseOn:!n.pulseOn}),className:"px-4 py-2 text-[10px] font-mono rounded border transition-colors "+(n.pulseOn?"bg-cyan-600/20 border-cyan-500/50 text-cyan-400":"bg-dark-bg border-dark-border text-text-muted hover:text-white"),children:"PULSE"}),t.jsx("button",{onClick:()=>r({noiseOn:!n.noiseOn}),className:"px-4 py-2 text-[10px] font-mono rounded border transition-colors "+(n.noiseOn?"bg-rose-600/20 border-rose-500/50 text-rose-400":"bg-dark-bg border-dark-border text-text-muted hover:text-white"),children:"NOISE"})]})]}),t.jsxs("div",{className:"bg-dark-bgSecondary p-4 rounded-lg border border-dark-border",children:[t.jsxs("div",{className:"flex items-center gap-2 mb-4",children:[t.jsx(Ee,{size:16,className:"text-amber-400"}),t.jsx("h3",{className:"font-mono text-xs font-bold text-text-primary uppercase",children:"ADSR Envelope"})]}),t.jsxs("div",{className:"flex justify-between gap-4",children:[t.jsx(I,{label:"A",value:n.a,min:0,max:15,onChange:e=>r({a:Math.round(e)}),size:"md",color:"#f59e0b",formatValue:e=>String(Math.round(e))}),t.jsx(I,{label:"D",value:n.d,min:0,max:15,onChange:e=>r({d:Math.round(e)}),size:"md",color:"#fb923c",formatValue:e=>String(Math.round(e))}),t.jsx(I,{label:"S",value:n.s,min:0,max:15,onChange:e=>r({s:Math.round(e)}),size:"md",color:"#fbbf24",formatValue:e=>String(Math.round(e))}),t.jsx(I,{label:"R",value:n.r,min:0,max:15,onChange:e=>r({r:Math.round(e)}),size:"md",color:"#facc15",formatValue:e=>String(Math.round(e))})]})]}),t.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[t.jsxs("div",{className:"bg-dark-bgSecondary p-4 rounded-lg border border-dark-border",children:[t.jsxs("div",{className:"flex items-center gap-2 mb-4",children:[t.jsx(qe,{size:16,className:"text-cyan-400"}),t.jsx("h3",{className:"font-mono text-xs font-bold text-text-primary uppercase",children:"Pulse Width"})]}),t.jsx(I,{label:"DUTY",value:n.duty,min:0,max:4095,onChange:e=>r({duty:Math.round(e)}),size:"md",color:"#22d3ee",formatValue:e=>String(Math.round(e))})]}),t.jsxs("div",{className:"bg-dark-bgSecondary p-4 rounded-lg border border-dark-border",children:[t.jsxs("div",{className:"flex items-center gap-2 mb-4",children:[t.jsx(Se,{size:16,className:"text-rose-400"}),t.jsx("h3",{className:"font-mono text-xs font-bold text-text-primary uppercase",children:"Modulation"})]}),t.jsxs("div",{className:"flex gap-2",children:[t.jsx("button",{onClick:()=>r({ringMod:!n.ringMod}),className:"flex-1 px-2 py-2 text-[10px] font-mono rounded border transition-colors "+(n.ringMod?"bg-rose-600/20 border-rose-500/50 text-rose-400":"bg-dark-bg border-dark-border text-text-muted"),children:"RING"}),t.jsx("button",{onClick:()=>r({oscSync:!n.oscSync}),className:"flex-1 px-2 py-2 text-[10px] font-mono rounded border transition-colors "+(n.oscSync?"bg-violet-600/20 border-violet-500/50 text-violet-400":"bg-dark-bg border-dark-border text-text-muted"),children:"SYNC"})]})]})]}),t.jsxs("div",{className:"bg-dark-bgSecondary p-4 rounded-lg border border-dark-border",children:[t.jsxs("div",{className:"flex items-center gap-2 mb-4",children:[t.jsx(Ge,{size:16,className:"text-purple-400"}),t.jsx("h3",{className:"font-mono text-xs font-bold text-text-primary uppercase",children:"Filter"})]}),t.jsxs("div",{className:"flex items-center gap-4",children:[t.jsx("button",{onClick:()=>r({toFilter:!n.toFilter}),className:"px-3 py-1 text-[10px] font-mono rounded border transition-colors "+(n.toFilter?"bg-purple-600/20 border-purple-500/50 text-purple-400":"bg-dark-bg border-dark-border text-text-muted"),children:"Enable"}),n.toFilter&&t.jsxs(t.Fragment,{children:[t.jsx(I,{label:"CUT",value:n.filterCutoff??1024,min:0,max:2047,onChange:e=>r({filterCutoff:Math.round(e)}),size:"sm",color:"#a855f7",formatValue:e=>String(Math.round(e))}),t.jsx(I,{label:"RES",value:n.filterResonance??0,min:0,max:15,onChange:e=>r({filterResonance:Math.round(e)}),size:"sm",color:"#c084fc",formatValue:e=>String(Math.round(e))}),t.jsxs("div",{className:"flex gap-1",children:[t.jsx("button",{onClick:()=>r({filterLP:!n.filterLP}),className:"px-2 py-1 text-[9px] font-mono rounded border transition-colors "+(n.filterLP?"bg-purple-600/20 border-purple-500/50 text-purple-400":"bg-dark-bg border-dark-border text-text-muted"),children:"LP"}),t.jsx("button",{onClick:()=>r({filterBP:!n.filterBP}),className:"px-2 py-1 text-[9px] font-mono rounded border transition-colors "+(n.filterBP?"bg-purple-600/20 border-purple-500/50 text-purple-400":"bg-dark-bg border-dark-border text-text-muted"),children:"BP"}),t.jsx("button",{onClick:()=>r({filterHP:!n.filterHP}),className:"px-2 py-1 text-[9px] font-mono rounded border transition-colors "+(n.filterHP?"bg-purple-600/20 border-purple-500/50 text-purple-400":"bg-dark-bg border-dark-border text-text-muted"),children:"HP"})]})]})]})]})]})},Da={useEnv:!0,gainMode:0,gain:127,a:15,d:7,s:7,r:0},Ba=({config:e,onChange:a})=>{const n=he.useMemo(()=>({...Da,...e.snes}),[e.snes]),r=he.useCallback(t=>{a({snes:{...e.snes,...Da,...t}})},[e.snes,a]);return t.jsx("div",{className:"space-y-4 animate-in fade-in slide-in-from-top-2",children:t.jsxs("div",{className:"bg-dark-bgSecondary p-4 rounded-lg border border-cyan-500/30",children:[t.jsxs("div",{className:"flex items-center gap-2 mb-4",children:[t.jsx(Ee,{size:16,className:"text-cyan-400"}),t.jsx("h3",{className:"font-mono text-xs font-bold text-text-primary uppercase",children:"SNES Envelope"}),t.jsx("button",{onClick:()=>r({useEnv:!n.useEnv}),className:"ml-auto px-2 py-1 text-[9px] font-mono rounded border transition-colors "+(n.useEnv?"bg-cyan-600/20 border-cyan-500/50 text-cyan-400":"bg-dark-bg border-dark-border text-text-muted"),children:n.useEnv?"ADSR":"GAIN"})]}),n.useEnv?t.jsxs("div",{className:"flex justify-between gap-4",children:[t.jsx(I,{label:"A",value:n.a,min:0,max:15,onChange:e=>r({a:Math.round(e)}),size:"md",color:"#06b6d4",formatValue:e=>String(Math.round(e))}),t.jsx(I,{label:"D",value:n.d,min:0,max:7,onChange:e=>r({d:Math.round(e)}),size:"md",color:"#22d3ee",formatValue:e=>String(Math.round(e))}),t.jsx(I,{label:"S",value:n.s,min:0,max:7,onChange:e=>r({s:Math.round(e)}),size:"md",color:"#67e8f9",formatValue:e=>String(Math.round(e))}),t.jsx(I,{label:"R",value:n.r,min:0,max:31,onChange:e=>r({r:Math.round(e)}),size:"md",color:"#a5f3fc",formatValue:e=>String(Math.round(e))})]}):t.jsxs("div",{className:"flex items-center gap-4",children:[t.jsxs("div",{children:[t.jsx("label",{className:"text-[10px] text-text-muted font-mono block mb-1",children:"Gain Mode"}),t.jsx("select",{value:"number"==typeof n.gainMode?n.gainMode:0,onChange:e=>r({gainMode:parseInt(e.target.value)}),className:"bg-dark-bg border border-dark-border rounded px-2 py-1 text-xs text-white",children:["Direct","Inc Linear","Inc Bent","Dec Linear","Dec Exp"].map((e,a)=>t.jsx("option",{value:a,children:e},a))})]}),t.jsx(I,{label:"GAIN",value:n.gain,min:0,max:127,onChange:e=>r({gain:Math.round(e)}),size:"md",color:"#06b6d4",formatValue:e=>String(Math.round(e))})]})]})})},La={duty:50,width:50,noiseMode:"white",attack:0,decay:8,sustain:10,release:5},Fa=({config:e,onChange:a})=>{const n=he.useMemo(()=>({...La,...e.psg}),[e.psg]),r=he.useCallback(t=>{a({psg:{...e.psg,...La,...t}})},[e.psg,a]);return t.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4 animate-in fade-in slide-in-from-top-2",children:[t.jsxs("div",{className:"bg-dark-bgSecondary p-4 rounded-lg border border-dark-border",children:[t.jsxs("div",{className:"flex items-center gap-2 mb-4",children:[t.jsx(ve,{size:16,className:"text-sky-400"}),t.jsx("h3",{className:"font-mono text-xs font-bold text-text-primary uppercase",children:"Pulse Control"})]}),t.jsxs("div",{className:"flex flex-wrap gap-6",children:[t.jsx(I,{label:"DUTY",value:n.duty,min:0,max:100,onChange:e=>r({duty:Math.round(e)}),size:"md",color:"#38bdf8",formatValue:e=>`${Math.round(e)}%`}),t.jsx(I,{label:"WIDTH",value:n.width,min:0,max:100,onChange:e=>r({width:Math.round(e)}),size:"md",color:"#0ea5e9",formatValue:e=>`${Math.round(e)}%`})]})]}),t.jsxs("div",{className:"bg-dark-bgSecondary p-4 rounded-lg border border-dark-border",children:[t.jsxs("div",{className:"flex items-center gap-2 mb-4",children:[t.jsx(Ee,{size:16,className:"text-rose-400"}),t.jsx("h3",{className:"font-mono text-xs font-bold text-text-primary uppercase",children:"Noise Mode"})]}),t.jsxs("div",{className:"grid grid-cols-2 gap-2",children:[t.jsx("button",{onClick:()=>r({noiseMode:"white"}),className:"py-2 font-mono text-[10px] rounded border transition-colors "+("white"===n.noiseMode?"bg-rose-600/20 border-rose-500/50 text-rose-400":"bg-dark-bg border-dark-border text-text-muted hover:bg-rose-950/20"),children:"WHITE"}),t.jsx("button",{onClick:()=>r({noiseMode:"periodic"}),className:"py-2 font-mono text-[10px] rounded border transition-colors "+("periodic"===n.noiseMode?"bg-rose-600/20 border-rose-500/50 text-rose-400":"bg-dark-bg border-dark-border text-text-muted hover:bg-rose-950/20"),children:"PERIODIC"})]})]}),t.jsxs("div",{className:"bg-dark-bgSecondary p-4 rounded-lg border border-dark-border",children:[t.jsxs("div",{className:"flex items-center gap-2 mb-4",children:[t.jsx(qe,{size:16,className:"text-emerald-400"}),t.jsx("h3",{className:"font-mono text-xs font-bold text-text-primary uppercase",children:"Envelope"})]}),t.jsxs("div",{className:"flex justify-between gap-2",children:[t.jsx(I,{label:"ATK",value:n.attack,min:0,max:15,onChange:e=>r({attack:Math.round(e)}),size:"sm",color:"#34d399",formatValue:e=>String(Math.round(e))}),t.jsx(I,{label:"DEC",value:n.decay,min:0,max:15,onChange:e=>r({decay:Math.round(e)}),size:"sm",color:"#10b981",formatValue:e=>String(Math.round(e))}),t.jsx(I,{label:"SUS",value:n.sustain,min:0,max:15,onChange:e=>r({sustain:Math.round(e)}),size:"sm",color:"#059669",formatValue:e=>String(Math.round(e))}),t.jsx(I,{label:"REL",value:n.release,min:0,max:15,onChange:e=>r({release:Math.round(e)}),size:"sm",color:"#047857",formatValue:e=>String(Math.round(e))})]})]})]})},Wa={sampleRate:44100,loopStart:0,loopEnd:65535,loopPoint:0,bitDepth:8,loopEnabled:!1},Ua=({config:e,onChange:a})=>{const n=he.useMemo(()=>({...Wa,...e.pcm}),[e.pcm]),r=he.useCallback(t=>{a({pcm:{...e.pcm,...Wa,...t}})},[e.pcm,a]);return t.jsxs("div",{className:"bg-dark-bgSecondary p-4 rounded-lg border border-dark-border animate-in fade-in slide-in-from-top-2",children:[t.jsxs("div",{className:"flex items-center gap-2 mb-4",children:[t.jsx(Ge,{size:16,className:"text-violet-400"}),t.jsx("h3",{className:"font-mono text-xs font-bold text-text-primary uppercase",children:"PCM Sample Properties"})]}),t.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-5 gap-4",children:[t.jsx(I,{label:"RATE",value:n.sampleRate,min:4e3,max:48e3,onChange:e=>r({sampleRate:Math.round(e)}),size:"sm",color:"#a78bfa",formatValue:e=>`${Math.round(e/1e3)}k`}),t.jsx(I,{label:"START",value:n.loopStart,min:0,max:65535,onChange:e=>r({loopStart:Math.round(e)}),size:"sm",color:"#8b5cf6",formatValue:e=>String(Math.round(e))}),t.jsx(I,{label:"END",value:n.loopEnd,min:0,max:65535,onChange:e=>r({loopEnd:Math.round(e)}),size:"sm",color:"#7c3aed",formatValue:e=>String(Math.round(e))}),t.jsx(I,{label:"LOOP",value:n.loopPoint,min:0,max:65535,onChange:e=>r({loopPoint:Math.round(e)}),size:"sm",color:"#6d28d9",formatValue:e=>String(Math.round(e))}),t.jsxs("div",{className:"flex flex-col items-center justify-center gap-1",children:[t.jsx("span",{className:"text-[9px] font-bold text-text-muted uppercase",children:"Bit Depth"}),t.jsx("select",{value:n.bitDepth,onChange:e=>r({bitDepth:parseInt(e.target.value)}),className:"bg-dark-bg px-2 py-1 rounded border border-dark-border text-xs font-mono text-violet-400",children:[8,16].map(e=>t.jsxs("option",{value:e,children:[e,"-BIT"]},e))})]})]}),t.jsx("div",{className:"mt-3 pt-3 border-t border-dark-border",children:t.jsx("button",{onClick:()=>r({loopEnabled:!n.loopEnabled}),className:"px-3 py-1 text-[10px] font-mono rounded border transition-colors "+(n.loopEnabled?"bg-violet-600/20 border-violet-500/50 text-violet-400":"bg-dark-bg border-dark-border text-text-muted"),children:n.loopEnabled?"🔁 Loop Enabled":"Loop Disabled"})})]})};function qa(e,t){return{0:[0],1:[0],2:[0],3:[0],4:[0,2],5:[0,1,2],6:[0,1,2],7:[0,1,2,3]}[e]?.includes(t)??!1}const Ha=["Custom","Violin","Guitar","Piano","Flute","Clarinet","Oboe","Trumpet","Organ","Horn","Synth","Harpsichord","Vibraphone","Synth Bass","Wood Bass","Electric Bass"];function Ga({color:e,title:a}){return t.jsxs("div",{className:"flex items-center gap-2 mb-4",children:[t.jsx("div",{className:"w-1 h-4 rounded-full",style:{backgroundColor:e}}),t.jsx("h3",{className:"text-sm font-bold text-white uppercase tracking-wide",children:a})]})}const Ka=({config:e,onChange:a})=>{const n=e.buzzmachine?.machineType||O.ARGURU_DISTORTION,r=(s=n,Object.values(O).find(e=>e===s)||O.ARGURU_DISTORTION);var s;const i=P[r],o=e.buzzmachine?.parameters||{},l=he.useMemo(()=>R(r),[r]),d=l.length>0,c=he.useCallback((t,r)=>{a({buzzmachine:{...e.buzzmachine,machineType:n,parameters:{...o,[t]:r}}})},[e.buzzmachine,n,o,a]),u=he.useCallback(e=>{if(!e)return;const t=V[r],n=t?.[e];n&&a({buzzmachine:n})},[r,a]);return t.jsxs("div",{className:"space-y-4",children:[d&&t.jsxs("section",{className:"bg-[#1a1a1a] rounded-xl p-4 border border-gray-800",children:[t.jsx(Ga,{color:"#06b6d4",title:"Presets"}),t.jsxs("select",{onChange:e=>u(e.target.value),className:"w-full bg-gray-800 border border-gray-700 rounded-lg px-3 py-2 text-sm text-white focus:outline-none focus:ring-2 focus:ring-cyan-500 focus:border-transparent transition-all",children:[t.jsx("option",{value:"",children:"Select preset..."}),l.map(e=>t.jsx("option",{value:e,children:e},e))]})]}),t.jsxs("section",{className:"bg-[#1a1a1a] rounded-xl p-4 border border-gray-800",children:[t.jsx(Ga,{color:"#8b5cf6",title:`${i.name} Parameters`}),i.parameters.length>0?t.jsx("div",{className:"grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6",children:i.parameters.map(e=>{const a=o[e.index]??e.defaultValue;return"byte"===e.type&&1===e.maxValue?t.jsxs("div",{className:"flex flex-col items-center justify-center space-y-2 p-2 bg-gray-900/50 rounded-lg border border-gray-800",children:[t.jsx("span",{className:"text-[10px] font-bold text-gray-400 uppercase tracking-wider text-center h-8 flex items-center",children:e.name}),t.jsx("button",{onClick:()=>c(e.index,0===a?1:0),className:`\n                        w-full py-2 px-2 rounded font-bold text-[10px] transition-all\n                        ${1===a?"bg-green-600/20 text-green-400 ring-1 ring-green-500":"bg-gray-800 text-gray-500 hover:bg-gray-700"}\n                      `,children:1===a?"ON":"OFF"})]},e.index):t.jsx("div",{className:"flex justify-center",children:t.jsx(I,{value:a,min:e.minValue,max:e.maxValue,onChange:t=>c(e.index,Math.round(t)),label:e.name,size:"sm",color:"#8b5cf6",formatValue:t=>((e,t)=>{if("byte"===e.type)return 1===e.maxValue?0===t?"Off":"On":t.toString();{const a=e.name.toLowerCase();return a.includes("gain")?`${(t/256).toFixed(2)}x`:a.includes("threshold")||"cutoff"===a||"resonance"===a?`${(t/e.maxValue*100).toFixed(0)}%`:a.includes("time")||a.includes("delay")?`${t}ms`:a.includes("freq")?`${t}Hz`:t.toString()}})(e,t)})},e.index)})}):t.jsx("div",{className:"text-center py-4",children:t.jsx("p",{className:"text-gray-500 text-sm italic",children:"No parameters available for this machine."})})]}),t.jsx("div",{className:"bg-blue-900/10 rounded-xl p-4 border border-blue-900/30",children:t.jsxs("p",{className:"text-xs text-blue-300/80 leading-relaxed italic",children:[t.jsx("span",{className:"text-blue-400 font-bold not-italic",children:"TIP:"})," ",(()=>{switch(r){case O.ARGURU_DISTORTION:return"Use Saturate mode for warm tube-like distortion. Use Clip mode for hard digital clipping. Enable Phase Inversor for stereo widening.";case O.ELAK_SVF:return"High resonance values create self-oscillation (TB-303 style). Automate cutoff for classic acid sweeps.";case O.FSM_KICK:case O.FSM_KICKXP:return"Classic electronic kick drum. Trigger with notes - lower notes produce deeper kicks.";case O.JESKOLA_TRILOK:return"Versatile drum machine. Use different notes for different drum sounds.";case O.JESKOLA_NOISE:return"White/pink noise generator. Great for snares, hi-hats, and sound effects.";case O.OOMEK_AGGRESSOR:return"Aggressive bass synth inspired by TB-303. Perfect for acid lines.";case O.JESKOLA_FREEVERB:return"High-quality reverb based on Freeverb algorithm. Use for spatial effects.";case O.JESKOLA_DELAY:case O.JESKOLA_CROSSDELAY:return"Classic delay effect. CrossDelay adds stereo ping-pong effect.";case O.FSM_CHORUS:case O.FSM_CHORUS2:return"Lush chorus effect for thickening sounds. Chorus2 has more modulation options.";case O.GEONIK_COMPRESSOR:return"Dynamic range compressor. Use for punchy drums or glue on buses.";case O.OOMEK_MASTERIZER:return"Mastering processor with limiting and enhancement.";default:return"generator"===i.type?"Sound generator. Trigger with MIDI notes to produce audio.":"Audio effect processor. Route audio through this for processing."}})()]})})]})};function Xa({color:e,title:a}){return t.jsxs("div",{className:"flex items-center gap-2 mb-4",children:[t.jsx("div",{className:"w-1 h-4 rounded-full",style:{backgroundColor:e}}),t.jsx("h3",{className:"text-sm font-bold text-white uppercase tracking-wide",children:a})]})}const Ya=(e,t)=>{const a=he.useRef(e);return a.current=e,he.useCallback((e,n)=>{const r=a.current.buzzmachine?.parameters||{},s=a.current.buzzmachine?.machineType||"ArguruDistortion";t({buzzmachine:{machineType:s,...a.current.buzzmachine,parameters:{...r,[e]:n}}})},[t])},Za={CyanPhaseDTMF:({config:e,onChange:a})=>{const n=Ya(e,a),r=e.buzzmachine?.parameters||{},s=r[0]??0,i=(r[1]??100)|(r[2]??0)<<8,o=r[3]??128;return t.jsxs("div",{className:"synth-editor-container bg-gradient-to-b from-[#1e1e1e] to-[#151515]",children:[t.jsx("div",{className:"synth-editor-header px-4 py-3 bg-[#1a1a1a]",children:t.jsxs("div",{className:"flex items-center gap-3",children:[t.jsx("div",{className:"p-2 rounded-lg bg-gradient-to-br from-cyan-500 to-blue-600",children:t.jsx(Ze,{size:20,className:"text-white"})}),t.jsxs("div",{children:[t.jsx("h2",{className:"text-lg font-bold text-white",children:"CyanPhase DTMF"}),t.jsx("p",{className:"text-xs text-gray-400",children:"Dial Tone Generator by CyanPhase"})]})]})}),t.jsxs("div",{className:"p-4 space-y-4",children:[t.jsxs("section",{className:"bg-[#1a1a1a] rounded-xl p-4 border border-gray-800",children:[t.jsx(Xa,{color:"#06b6d4",title:"Digit"}),t.jsx("div",{className:"grid grid-cols-4 gap-2",children:["1","2","3","4","5","6","7","8","9","*","0","#","A","B","C","D"].map((e,a)=>t.jsx("button",{onClick:()=>n(0,a),className:`\n                  py-3 rounded-lg font-bold text-lg transition-all\n                  ${s===a?"bg-cyan-500/20 text-cyan-400 ring-2 ring-cyan-500":"bg-gray-800 text-gray-400 hover:text-gray-200 hover:bg-gray-700"}\n                `,children:e},a))})]}),t.jsxs("section",{className:"bg-[#1a1a1a] rounded-xl p-4 border border-gray-800",children:[t.jsx(Xa,{color:"#3b82f6",title:"Output"}),t.jsxs("div",{className:"flex flex-wrap gap-6 items-end",children:[t.jsx(I,{value:i,min:1,max:65535,onChange:e=>((e,t,a)=>{const r=a>>8&255;n(e,255&a),n(t,r)})(1,2,Math.round(e)),label:"Length",color:"#3b82f6",formatValue:e=>`${Math.round(e)}ms`}),t.jsx(I,{value:o,min:0,max:255,onChange:e=>n(3,Math.round(e)),label:"Volume",color:"#3b82f6",formatValue:e=>`${Math.round(e/2.55)}%`})]})]})]})]})},ElenzilFrequencyBomb:({config:e,onChange:a})=>{const n=Ya(e,a),r=e.buzzmachine?.parameters||{},s=(r[0]??0)|(r[1]??4)<<8,i=(r[2]??100)|(r[3]??0)<<8,o=(r[4]??10)|(r[5]??0)<<8,l=r[6]??4,d=r[7]??128,c=r[8]??0,u=r[9]??1,m=["","ms","tick","256th","sec"],p=(e,t,a)=>{const r=a>>8&255;n(e,255&a),n(t,r)};return t.jsxs("div",{className:"synth-editor-container bg-gradient-to-b from-[#1e1e1e] to-[#151515]",children:[t.jsx("div",{className:"synth-editor-header px-4 py-3 bg-[#1a1a1a]",children:t.jsxs("div",{className:"flex items-center gap-3",children:[t.jsx("div",{className:"p-2 rounded-lg bg-gradient-to-br from-orange-500 to-red-600",children:t.jsx(Ye,{size:20,className:"text-white"})}),t.jsxs("div",{children:[t.jsx("h2",{className:"text-lg font-bold text-white",children:"Elenzil FrequencyBomb"}),t.jsx("p",{className:"text-xs text-gray-400",children:"Frequency Sweep Generator by Elenzil"})]})]})}),t.jsxs("div",{className:"p-4 space-y-4",children:[t.jsxs("section",{className:"bg-[#1a1a1a] rounded-xl p-4 border border-gray-800",children:[t.jsx(Xa,{color:"#f97316",title:"Frequency Sweep"}),t.jsxs("div",{className:"flex flex-wrap gap-6 items-end",children:[t.jsx(I,{value:s,min:0,max:65534,onChange:e=>p(0,1,Math.round(e)),label:"Start",color:"#f97316",formatValue:e=>`${Math.round(e)}Hz`}),t.jsx(I,{value:i,min:0,max:65534,onChange:e=>p(2,3,Math.round(e)),label:"End",color:"#f97316",formatValue:e=>`${Math.round(e)}Hz`}),t.jsx(I,{value:o,min:0,max:65534,onChange:e=>p(4,5,Math.round(e)),label:`Attack (${m[l]||"ms"})`,color:"#f97316",formatValue:e=>Math.round(e).toString()})]}),t.jsx("div",{className:"flex justify-center mt-4 gap-1",children:[1,2,3,4].map(e=>t.jsx("button",{onClick:()=>n(6,e),className:`\n                  px-3 py-1 text-xs rounded font-medium transition-all\n                  ${l===e?"bg-orange-500/20 text-orange-400 ring-1 ring-orange-500":"bg-gray-800 text-gray-500 hover:text-gray-300"}\n                `,children:m[e]},e))})]}),t.jsxs("section",{className:"bg-[#1a1a1a] rounded-xl p-4 border border-gray-800",children:[t.jsx(Xa,{color:"#ef4444",title:"Waveform"}),t.jsx("div",{className:"flex gap-2 mb-4",children:["Sine","Saw","Square","Triangle","Noise"].map((e,a)=>t.jsx("button",{onClick:()=>n(8,a),className:`\n                  flex-1 py-2 rounded-lg font-bold text-xs transition-all\n                  ${c===a?"bg-red-500/20 text-red-400 ring-1 ring-red-500":"bg-gray-800 text-gray-500 hover:text-gray-300"}\n                `,children:e},a))}),t.jsxs("div",{className:"flex flex-wrap gap-6 items-end",children:[t.jsx(I,{value:u,min:1,max:13,onChange:e=>n(9,Math.round(e)),label:"Power",color:"#ef4444",formatValue:e=>Math.round(e).toString()}),t.jsx(I,{value:d,min:0,max:240,onChange:e=>n(7,Math.round(e)),label:"Volume",color:"#ef4444",formatValue:e=>`${Math.round(e/2.4)}%`})]})]})]})]})},FSMKick:({config:e,onChange:a})=>{const n=Ya(e,a),r=e.buzzmachine?.parameters||{},s=r[1]??198,i=r[2]??64,o=r[3]??46,l=r[4]??27,d=r[5]??55;return t.jsxs("div",{className:"synth-editor-container bg-gradient-to-b from-[#1e1e1e] to-[#151515]",children:[t.jsx("div",{className:"synth-editor-header px-4 py-3 bg-[#1a1a1a]",children:t.jsxs("div",{className:"flex items-center gap-3",children:[t.jsx("div",{className:"p-2 rounded-lg bg-gradient-to-br from-red-600 to-orange-600",children:t.jsx(Ke,{size:20,className:"text-white"})}),t.jsxs("div",{children:[t.jsx("h2",{className:"text-lg font-bold text-white",children:"FSM Kick"}),t.jsx("p",{className:"text-xs text-gray-400",children:"Kick Drum by Krzysztof Foltman"})]})]})}),t.jsxs("div",{className:"p-4 space-y-4",children:[t.jsxs("section",{className:"bg-[#1a1a1a] rounded-xl p-4 border border-gray-800",children:[t.jsx(Xa,{color:"#ef4444",title:"Pitch"}),t.jsxs("div",{className:"flex flex-wrap gap-6 items-end",children:[t.jsx(I,{value:s,min:1,max:240,onChange:e=>n(1,Math.round(e)),label:"Start",color:"#ef4444",formatValue:e=>Math.round(e).toString()}),t.jsx(I,{value:i,min:1,max:240,onChange:e=>n(2,Math.round(e)),label:"End",color:"#ef4444",formatValue:e=>Math.round(e).toString()})]})]}),t.jsxs("section",{className:"bg-[#1a1a1a] rounded-xl p-4 border border-gray-800",children:[t.jsx(Xa,{color:"#f97316",title:"Envelope"}),t.jsxs("div",{className:"flex flex-wrap gap-6 items-end",children:[t.jsx(I,{value:o,min:1,max:240,onChange:e=>n(3,Math.round(e)),label:"Tone Dec",color:"#f97316",formatValue:e=>Math.round(e).toString()}),t.jsx(I,{value:l,min:1,max:240,onChange:e=>n(4,Math.round(e)),label:"Tone Shape",color:"#f97316",formatValue:e=>Math.round(e).toString()}),t.jsx(I,{value:d,min:1,max:240,onChange:e=>n(5,Math.round(e)),label:"Amp Dec",color:"#f97316",formatValue:e=>Math.round(e).toString()})]})]})]})]})},FSMKickXP:({config:e,onChange:a})=>{const n=Ya(e,a),r=e.buzzmachine?.parameters||{},s=r[1]??145,i=r[2]??50,o=r[3]??55,l=r[4]??28,d=r[5]??47,c=r[6]??30,u=r[7]??27,m=r[8]??55,p=r[9]??55,h=r[10]??1,f=r[11]??32,x=r[12]??105;return t.jsxs("div",{className:"synth-editor-container bg-gradient-to-b from-[#1e1e1e] to-[#151515]",children:[t.jsx("div",{className:"synth-editor-header px-4 py-3 bg-[#1a1a1a]",children:t.jsxs("div",{className:"flex items-center gap-3",children:[t.jsx("div",{className:"p-2 rounded-lg bg-gradient-to-br from-red-600 to-pink-600",children:t.jsx(Ke,{size:20,className:"text-white"})}),t.jsxs("div",{children:[t.jsx("h2",{className:"text-lg font-bold text-white",children:"FSM KickXP"}),t.jsx("p",{className:"text-xs text-gray-400",children:"Extended Kick Drum by FSM"})]})]})}),t.jsxs("div",{className:"p-4 space-y-4",children:[t.jsxs("section",{className:"bg-[#1a1a1a] rounded-xl p-4 border border-gray-800",children:[t.jsx(Xa,{color:"#ef4444",title:"Pitch"}),t.jsxs("div",{className:"flex flex-wrap gap-6 items-end",children:[t.jsx(I,{value:s,min:1,max:240,onChange:e=>n(1,Math.round(e)),label:"Start",size:"sm",color:"#ef4444",formatValue:e=>Math.round(e).toString()}),t.jsx(I,{value:i,min:1,max:240,onChange:e=>n(2,Math.round(e)),label:"End",size:"sm",color:"#ef4444",formatValue:e=>Math.round(e).toString()}),t.jsx(I,{value:c,min:1,max:240,onChange:e=>n(6,Math.round(e)),label:"Dec Rate",size:"sm",color:"#ef4444",formatValue:e=>Math.round(e).toString()}),t.jsx(I,{value:u,min:1,max:240,onChange:e=>n(7,Math.round(e)),label:"Dec Shape",size:"sm",color:"#ef4444",formatValue:e=>Math.round(e).toString()})]})]}),t.jsxs("section",{className:"bg-[#1a1a1a] rounded-xl p-4 border border-gray-800",children:[t.jsx(Xa,{color:"#f97316",title:"Character"}),t.jsxs("div",{className:"flex flex-wrap gap-6 items-end",children:[t.jsx(I,{value:o,min:0,max:100,onChange:e=>n(3,Math.round(e)),label:"Buzz",size:"sm",color:"#f97316",formatValue:e=>`${Math.round(e)}%`}),t.jsx(I,{value:l,min:0,max:100,onChange:e=>n(4,Math.round(e)),label:"Click",size:"sm",color:"#f97316",formatValue:e=>`${Math.round(e)}%`}),t.jsx(I,{value:d,min:0,max:100,onChange:e=>n(5,Math.round(e)),label:"Punch",size:"sm",color:"#f97316",formatValue:e=>`${Math.round(e)}%`}),t.jsx(I,{value:m,min:1,max:240,onChange:e=>n(8,Math.round(e)),label:"Buzz Dec",size:"sm",color:"#f97316",formatValue:e=>Math.round(e).toString()}),t.jsx(I,{value:p,min:1,max:240,onChange:e=>n(9,Math.round(e)),label:"C+P Dec",size:"sm",color:"#f97316",formatValue:e=>Math.round(e).toString()})]})]}),t.jsxs("section",{className:"bg-[#1a1a1a] rounded-xl p-4 border border-gray-800",children:[t.jsx(Xa,{color:"#eab308",title:"Amplitude"}),t.jsxs("div",{className:"flex flex-wrap gap-6 items-end",children:[t.jsx(I,{value:h,min:1,max:240,onChange:e=>n(10,Math.round(e)),label:"Dec Slope",color:"#eab308",formatValue:e=>Math.round(e).toString()}),t.jsx(I,{value:f,min:1,max:240,onChange:e=>n(11,Math.round(e)),label:"Dec Time",color:"#eab308",formatValue:e=>Math.round(e).toString()}),t.jsx(I,{value:x,min:1,max:240,onChange:e=>n(12,Math.round(e)),label:"Rel Slope",color:"#eab308",formatValue:e=>Math.round(e).toString()})]})]})]})]})},JeskolaNoise:({config:e,onChange:a})=>{const n=Ya(e,a),r=e.buzzmachine?.parameters||{},s=r[0]??16,i=r[1]??16,o=r[2]??512,l=r[3]??4096,d=r[4]??128;return t.jsxs("div",{className:"synth-editor-container bg-gradient-to-b from-[#1e1e1e] to-[#151515]",children:[t.jsx("div",{className:"synth-editor-header px-4 py-3 bg-[#1a1a1a]",children:t.jsxs("div",{className:"flex items-center gap-3",children:[t.jsx("div",{className:"p-2 rounded-lg bg-gradient-to-br from-gray-500 to-gray-700",children:t.jsx(Xe,{size:20,className:"text-white"})}),t.jsxs("div",{children:[t.jsx("h2",{className:"text-lg font-bold text-white",children:"Jeskola Noise"}),t.jsx("p",{className:"text-xs text-gray-400",children:"Noise Generator by Oskari Tammelin"})]})]})}),t.jsxs("div",{className:"p-4 space-y-4",children:[t.jsxs("section",{className:"bg-[#1a1a1a] rounded-xl p-4 border border-gray-800",children:[t.jsx(Xa,{color:"#6b7280",title:"Envelope"}),t.jsxs("div",{className:"flex flex-wrap gap-6 items-end",children:[t.jsx(I,{value:s,min:1,max:65535,onChange:e=>n(0,Math.round(e)),label:"Attack",color:"#6b7280",formatValue:e=>`${Math.round(e)}ms`}),t.jsx(I,{value:i,min:1,max:65535,onChange:e=>n(1,Math.round(e)),label:"Sustain",color:"#6b7280",formatValue:e=>`${Math.round(e)}ms`}),t.jsx(I,{value:o,min:1,max:65535,onChange:e=>n(2,Math.round(e)),label:"Release",color:"#6b7280",formatValue:e=>`${Math.round(e)}ms`})]})]}),t.jsxs("section",{className:"bg-[#1a1a1a] rounded-xl p-4 border border-gray-800",children:[t.jsx(Xa,{color:"#a855f7",title:"Tone"}),t.jsxs("div",{className:"flex flex-wrap gap-6 items-end",children:[t.jsx(I,{value:l,min:0,max:4096,onChange:e=>n(3,Math.round(e)),label:"Color",size:"lg",color:"#a855f7",formatValue:e=>e<1365?"Dark":e<2730?"Mid":"Bright"}),t.jsx(I,{value:d,min:0,max:254,onChange:e=>n(4,Math.round(e)),label:"Volume",size:"lg",color:"#a855f7",formatValue:e=>`${Math.round(e/2.54)}%`})]})]})]})]})},JeskolaTrilok:({config:e,onChange:a})=>{const n=Ya(e,a),r=e.buzzmachine?.parameters||{},s=r[0]??64,i=r[1]??64,o=r[2]??128;return t.jsxs("div",{className:"synth-editor-container bg-gradient-to-b from-[#1e1e1e] to-[#151515]",children:[t.jsx("div",{className:"synth-editor-header px-4 py-3 bg-[#1a1a1a]",children:t.jsxs("div",{className:"flex items-center gap-3",children:[t.jsx("div",{className:"p-2 rounded-lg bg-gradient-to-br from-orange-600 to-red-700",children:t.jsx(Ke,{size:20,className:"text-white"})}),t.jsxs("div",{children:[t.jsx("h2",{className:"text-lg font-bold text-white",children:"Jeskola Trilok"}),t.jsx("p",{className:"text-xs text-gray-400",children:"Drum Machine by Oskari Tammelin"})]})]})}),t.jsxs("div",{className:"p-4 space-y-4",children:[t.jsxs("section",{className:"bg-[#1a1a1a] rounded-xl p-4 border border-gray-800",children:[t.jsx(Xa,{color:"#ef4444",title:"Bass Drum"}),t.jsxs("div",{className:"flex flex-wrap gap-6 items-end",children:[t.jsx(I,{value:s,min:0,max:127,onChange:e=>n(0,Math.round(e)),label:"Tone",color:"#ef4444",formatValue:e=>Math.round(e).toString()}),t.jsx(I,{value:i,min:0,max:127,onChange:e=>n(1,Math.round(e)),label:"Decay",color:"#ef4444",formatValue:e=>Math.round(e).toString()}),t.jsx(I,{value:o,min:0,max:254,onChange:e=>n(2,Math.round(e)),label:"Volume",color:"#ef4444",formatValue:e=>`${Math.round(e/2.54)}%`})]})]}),t.jsx("div",{className:"bg-gray-900/50 rounded-lg p-4 border border-gray-800",children:t.jsx("p",{className:"text-xs text-gray-400 leading-relaxed",children:"Trigger notes to play the bass drum. Use tracker note commands to control pitch and velocity."})})]})]})},MadBrain4FM2F:({config:e,onChange:a})=>{const n=Ya(e,a),r=e.buzzmachine?.parameters||{},s=r[0]??1,i=r[1]??1,o=r[2]??1,l=r[3]??0,d=r[4]??32;return t.jsxs("div",{className:"synth-editor-container bg-gradient-to-b from-[#1e1e1e] to-[#151515]",children:[t.jsx("div",{className:"synth-editor-header px-4 py-3 bg-[#1a1a1a]",children:t.jsxs("div",{className:"flex items-center gap-3",children:[t.jsx("div",{className:"p-2 rounded-lg bg-gradient-to-br from-purple-600 to-indigo-600",children:t.jsx(Ue,{size:20,className:"text-white"})}),t.jsxs("div",{children:[t.jsx("h2",{className:"text-lg font-bold text-white",children:"MadBrain 4FM2F"}),t.jsx("p",{className:"text-xs text-gray-400",children:"4-Op FM Synth by MadBrain"})]})]})}),t.jsxs("div",{className:"p-4 space-y-4",children:[t.jsxs("section",{className:"bg-[#1a1a1a] rounded-xl p-4 border border-gray-800",children:[t.jsx(Xa,{color:"#8b5cf6",title:"FM Routing"}),t.jsx("div",{className:"flex justify-center",children:t.jsx(I,{value:s,min:1,max:15,onChange:e=>n(0,Math.round(e)),label:"Algorithm",size:"lg",color:"#8b5cf6",formatValue:e=>`Alg ${Math.round(e)}`})})]}),t.jsxs("section",{className:"bg-[#1a1a1a] rounded-xl p-4 border border-gray-800",children:[t.jsx(Xa,{color:"#6366f1",title:"Oscillator 4"}),t.jsxs("div",{className:"mb-4",children:[t.jsx("span",{className:"text-xs text-gray-400 mb-2 block",children:"Waveform"}),t.jsx("select",{value:i,onChange:e=>n(1,parseInt(e.target.value)),className:"w-full bg-gray-800 border border-gray-700 rounded-lg px-3 py-2 text-sm text-white",children:["","Sine","Tri","Saw","Square","Noise","S&H","Ramp","PW25","PW12","PW6","Harm2","Harm3","Harm4","Harm5","Harm6","Harm7"].slice(1).map((e,a)=>t.jsx("option",{value:a+1,children:e},a+1))})]}),t.jsxs("div",{className:"flex flex-wrap gap-6 items-end",children:[t.jsx(I,{value:o,min:0,max:32,onChange:e=>n(2,Math.round(e)),label:"Ratio",color:"#6366f1",formatValue:e=>Math.round(e).toString()}),t.jsx(I,{value:l,min:0,max:254,onChange:e=>n(3,Math.round(e)),label:"Fine",color:"#6366f1",bipolar:!0,formatValue:e=>`${Math.round(e-127)}`}),t.jsx(I,{value:d,min:0,max:64,onChange:e=>n(4,Math.round(e)),label:"Volume",color:"#6366f1",formatValue:e=>`${Math.round(e/.64)}%`})]})]})]})]})},MadBrainDynamite6:({config:e,onChange:a})=>{const n=Ya(e,a),r=e.buzzmachine?.parameters||{},s=r[0]??128,i=r[1]??128,o=r[2]??32,l=r[3]??4,d=r[4]??255,c=r[5]??0,u=r[6]??61440;return t.jsxs("div",{className:"synth-editor-container bg-gradient-to-b from-[#1e1e1e] to-[#151515]",children:[t.jsx("div",{className:"synth-editor-header px-4 py-3 bg-[#1a1a1a]",children:t.jsxs("div",{className:"flex items-center gap-3",children:[t.jsx("div",{className:"p-2 rounded-lg bg-gradient-to-br from-yellow-500 to-orange-600",children:t.jsx(Se,{size:20,className:"text-white"})}),t.jsxs("div",{children:[t.jsx("h2",{className:"text-lg font-bold text-white",children:"MadBrain Dynamite6"}),t.jsx("p",{className:"text-xs text-gray-400",children:"6-Voice Synth by MadBrain"})]})]})}),t.jsxs("div",{className:"p-4 space-y-4",children:[t.jsxs("section",{className:"bg-[#1a1a1a] rounded-xl p-4 border border-gray-800",children:[t.jsx(Xa,{color:"#eab308",title:"Pitch"}),t.jsxs("div",{className:"flex flex-wrap gap-6 items-end",children:[t.jsx(I,{value:s,min:1,max:255,onChange:e=>n(0,Math.round(e)),label:"Coarse",color:"#eab308",bipolar:!0,formatValue:e=>`${Math.round(e-128)}`}),t.jsx(I,{value:i,min:1,max:255,onChange:e=>n(1,Math.round(e)),label:"Fine",color:"#eab308",bipolar:!0,formatValue:e=>`${Math.round(e-128)}`})]})]}),t.jsxs("section",{className:"bg-[#1a1a1a] rounded-xl p-4 border border-gray-800",children:[t.jsx(Xa,{color:"#f97316",title:"Envelope"}),t.jsxs("div",{className:"flex flex-wrap gap-6 items-end",children:[t.jsx(I,{value:l,min:0,max:254,onChange:e=>n(3,Math.round(e)),label:"Attack",size:"sm",color:"#f97316",formatValue:e=>Math.round(e).toString()}),t.jsx(I,{value:d,min:1,max:255,onChange:e=>n(4,Math.round(e)),label:"Decay",size:"sm",color:"#f97316",formatValue:e=>Math.round(e).toString()}),t.jsx(I,{value:u,min:1,max:65535,onChange:e=>n(6,Math.round(e)),label:"Release",size:"sm",color:"#f97316",formatValue:e=>Math.round(e).toString()}),t.jsx(I,{value:o,min:1,max:255,onChange:e=>n(2,Math.round(e)),label:"Amp",size:"sm",color:"#f97316",formatValue:e=>`${Math.round(e/2.55)}%`})]})]}),t.jsxs("section",{className:"bg-[#1a1a1a] rounded-xl p-4 border border-gray-800",children:[t.jsx(Xa,{color:"#f59e0b",title:"Routing"}),t.jsx("div",{className:"flex flex-wrap gap-1 justify-center",children:["1","2","3","4","5","6","7","8","9","10","11"].map((e,a)=>t.jsx("button",{onClick:()=>n(5,a),className:`\n                  w-10 h-10 rounded-lg font-bold text-sm transition-all\n                  ${c===a?"bg-amber-500/20 text-amber-400 ring-1 ring-amber-500":"bg-gray-800 text-gray-500 hover:text-gray-300"}\n                `,children:e},a))})]})]})]})},MakkM3:({config:e,onChange:a})=>{const n=Ya(e,a),r=e.buzzmachine?.parameters||{},s=r[0]??0,i=r[1]??64,o=r[2]??0,l=r[3]??64,d=r[4]??64,c=r[5]??0,u=r[6]??64,m=r[7]??64,p=r[8]??0,h=r[9]??0,f=r[10]??64,x=["Sine","Tri","Saw","Square","Noise","S&H"];return t.jsxs("div",{className:"synth-editor-container bg-gradient-to-b from-[#1e1e1e] to-[#151515]",children:[t.jsx("div",{className:"synth-editor-header px-4 py-3 bg-[#1a1a1a]",children:t.jsxs("div",{className:"flex items-center gap-3",children:[t.jsx("div",{className:"p-2 rounded-lg bg-gradient-to-br from-green-500 to-teal-600",children:t.jsx(ve,{size:20,className:"text-white"})}),t.jsxs("div",{children:[t.jsx("h2",{className:"text-lg font-bold text-white",children:"Makk M3"}),t.jsx("p",{className:"text-xs text-gray-400",children:"2-Osc Subtractive Synth by MAKK"})]})]})}),t.jsxs("div",{className:"p-4 space-y-4",children:[t.jsxs("section",{className:"bg-[#1a1a1a] rounded-xl p-4 border border-gray-800",children:[t.jsx(Xa,{color:"#22c55e",title:"Oscillator 1"}),t.jsx("div",{className:"flex gap-2 mb-3",children:x.map((e,a)=>t.jsx("button",{onClick:()=>n(0,a),className:`\n                  flex-1 py-1.5 rounded text-xs font-bold transition-all\n                  ${s===a?"bg-green-500/20 text-green-400 ring-1 ring-green-500":"bg-gray-800 text-gray-500 hover:text-gray-300"}\n                `,children:e},a))}),t.jsx("div",{className:"flex justify-center",children:t.jsx(I,{value:i,min:0,max:127,onChange:e=>n(1,Math.round(e)),label:"Pulse Width",size:"sm",color:"#22c55e",formatValue:e=>`${Math.round(e/1.27)}%`})})]}),t.jsxs("section",{className:"bg-[#1a1a1a] rounded-xl p-4 border border-gray-800",children:[t.jsx(Xa,{color:"#14b8a6",title:"Oscillator 2"}),t.jsx("div",{className:"flex gap-2 mb-3",children:x.map((e,a)=>t.jsx("button",{onClick:()=>n(2,a),className:`\n                  flex-1 py-1.5 rounded text-xs font-bold transition-all\n                  ${o===a?"bg-teal-500/20 text-teal-400 ring-1 ring-teal-500":"bg-gray-800 text-gray-500 hover:text-gray-300"}\n                `,children:e},a))}),t.jsxs("div",{className:"flex flex-wrap gap-6 items-end",children:[t.jsx(I,{value:l,min:0,max:127,onChange:e=>n(3,Math.round(e)),label:"Pulse Width",size:"sm",color:"#14b8a6",formatValue:e=>`${Math.round(e/1.27)}%`}),t.jsx(I,{value:u,min:0,max:127,onChange:e=>n(6,Math.round(e)),label:"Semi",size:"sm",color:"#14b8a6",bipolar:!0,formatValue:e=>`${Math.round(e-64)}`}),t.jsx(I,{value:m,min:0,max:127,onChange:e=>n(7,Math.round(e)),label:"Fine",size:"sm",color:"#14b8a6",bipolar:!0,formatValue:e=>`${Math.round(e-64)}`})]})]}),t.jsxs("section",{className:"bg-[#1a1a1a] rounded-xl p-4 border border-gray-800",children:[t.jsx(Xa,{color:"#10b981",title:"Mix & Sub"}),t.jsx("div",{className:"flex gap-1 mb-3 flex-wrap",children:["Add","Ring","AM","FM","Sync","HSync","Osc1","Osc2","Sub"].map((e,a)=>t.jsx("button",{onClick:()=>n(5,a),className:`\n                  px-2 py-1 rounded text-xs font-bold transition-all\n                  ${c===a?"bg-emerald-500/20 text-emerald-400 ring-1 ring-emerald-500":"bg-gray-800 text-gray-500 hover:text-gray-300"}\n                `,children:e},a))}),t.jsxs("div",{className:"flex flex-wrap gap-6 items-end",children:[t.jsx(I,{value:d,min:0,max:127,onChange:e=>n(4,Math.round(e)),label:"Mix",size:"sm",color:"#10b981",formatValue:e=>`${Math.round(e/1.27)}%`}),t.jsx(I,{value:p,min:0,max:127,onChange:e=>n(8,Math.round(e)),label:"Glide",size:"sm",color:"#10b981",formatValue:e=>Math.round(e).toString()}),t.jsxs("div",{className:"flex flex-col items-center",children:[t.jsx("span",{className:"text-[10px] text-gray-500 mb-1",children:"Sub Wave"}),t.jsx("select",{value:h,onChange:e=>n(9,parseInt(e.target.value)),className:"bg-gray-800 border border-gray-700 rounded px-2 py-1 text-xs text-white",children:["Sine","Tri","Saw","Square","Noise"].map((e,a)=>t.jsx("option",{value:a,children:e},a))})]}),t.jsx(I,{value:f,min:0,max:127,onChange:e=>n(10,Math.round(e)),label:"Sub Vol",size:"sm",color:"#10b981",formatValue:e=>`${Math.round(e/1.27)}%`})]})]})]})]})},MakkM4:({config:e,onChange:a})=>{const n=Ya(e,a),r=e.buzzmachine?.parameters||{},s=he.useRef(null),i=r[0]??0,o=r[1]??0,l=r[2]??64,d=r[3]??64,c=r[5]??0,u=r[10]??255,m=r[11]??0;return t.jsxs("div",{className:"synth-editor-container bg-gradient-to-b from-[#1e1e1e] to-[#151515]",children:[t.jsx("div",{className:"synth-editor-header px-4 py-3 bg-[#1a1a1a]",children:t.jsxs("div",{className:"flex items-center gap-3",children:[t.jsx("div",{className:"p-2 rounded-lg bg-gradient-to-br from-indigo-500 to-purple-600",children:t.jsx(ke,{size:20,className:"text-white"})}),t.jsxs("div",{children:[t.jsx("h2",{className:"text-lg font-bold text-white",children:"Makk M4"}),t.jsx("p",{className:"text-xs text-gray-400",children:"2-Osc Wavetable Synth by MAKK"})]})]})}),t.jsxs("div",{className:"p-4 space-y-4",children:[t.jsxs("section",{className:"bg-[#1a1a1a] rounded-xl p-4 border border-gray-800",children:[t.jsxs("div",{className:"flex items-center justify-between mb-4",children:[t.jsx(Xa,{color:"#8b5cf6",title:"Oscillators"}),t.jsxs("button",{onClick:()=>s.current?.click(),className:"flex items-center gap-1.5 px-2 py-1 bg-indigo-500/20 text-indigo-400 border border-indigo-500/30 rounded text-[10px] font-bold uppercase hover:bg-indigo-500/30 transition-colors",children:[t.jsx(Le,{size:12}),"Import Wave"]}),t.jsx("input",{ref:s,type:"file",accept:".wav,.h",onChange:async t=>{const n=t.target.files?.[0];if(n){try{let t=[];if(n.name.endsWith(".h")){t=(await n.text()).split(/[\s,]+/).map(e=>parseInt(e)).filter(e=>!isNaN(e))}else{const e=new(window.AudioContext||window.webkitAudioContext),a=await n.arrayBuffer(),r=(await e.decodeAudioData(a)).getChannelData(0);t=Array.from(r).map(e=>Math.round((e+1)/2*255))}t.length>0&&a({buzzmachine:{...e.buzzmachine,customWaves:{...e.buzzmachine?.customWaves||{},[i]:t}}})}catch(r){}s.current&&(s.current.value="")}},className:"hidden"})]}),t.jsxs("div",{className:"grid grid-cols-2 gap-6",children:[t.jsxs("div",{className:"space-y-3",children:[t.jsx("label",{className:"text-[10px] font-bold text-gray-500 uppercase tracking-wider",children:"Osc 1 Wave"}),t.jsx(I,{value:i,min:0,max:127,onChange:e=>n(0,Math.round(e)),label:"Wave Index",color:"#8b5cf6",formatValue:e=>`Index ${Math.round(e)}`})]}),t.jsxs("div",{className:"space-y-3",children:[t.jsx("label",{className:"text-[10px] font-bold text-gray-500 uppercase tracking-wider",children:"Osc 2 Wave"}),t.jsx(I,{value:o,min:0,max:127,onChange:e=>n(1,Math.round(e)),label:"Wave Index",color:"#a855f7",formatValue:e=>`Index ${Math.round(e)}`})]})]}),t.jsxs("div",{className:"flex flex-wrap gap-6 items-end mt-6",children:[t.jsx(I,{value:l,min:0,max:127,onChange:e=>n(2,Math.round(e)),label:"Mix",color:"#8b5cf6",formatValue:e=>`${Math.round(e/1.27)}%`}),t.jsx(I,{value:d,min:0,max:127,onChange:e=>n(3,Math.round(e)),label:"Detune",color:"#8b5cf6",bipolar:!0,formatValue:e=>`${Math.round(e-64)}`}),t.jsx(I,{value:c,min:0,max:127,onChange:e=>n(5,Math.round(e)),label:"Glide",color:"#8b5cf6",formatValue:e=>Math.round(e).toString()})]})]}),t.jsxs("section",{className:"bg-[#1a1a1a] rounded-xl p-4 border border-gray-800",children:[t.jsx(Xa,{color:"#ec4899",title:"Filter"}),t.jsxs("div",{className:"flex flex-wrap gap-6 items-end",children:[t.jsx(I,{value:u,min:0,max:255,onChange:e=>n(10,Math.round(e)),label:"Cutoff",color:"#ec4899",formatValue:e=>`${Math.round(e/2.55)}%`}),t.jsx(I,{value:m,min:0,max:255,onChange:e=>n(11,Math.round(e)),label:"Resonance",color:"#ec4899",formatValue:e=>`${Math.round(e/2.55)}%`})]})]})]})]})},OomekAggressor:({config:e,onChange:a})=>{const n=Ya(e,a),r=e.buzzmachine?.parameters||{},s=r[0]??0,i=r[1]??120,o=r[2]??64,l=r[3]??64,d=r[4]??64,c=r[5]??64,u=r[6]??100,m=r[7]??100;return t.jsxs("div",{className:"synth-editor-container bg-gradient-to-b from-[#1e1e1e] to-[#151515]",children:[t.jsx("div",{className:"synth-editor-header px-4 py-3 bg-[#1a1a1a]",children:t.jsxs("div",{className:"flex items-center gap-3",children:[t.jsx("div",{className:"p-2 rounded-lg bg-gradient-to-br from-red-500 to-orange-500",children:t.jsx(je,{size:20,className:"text-white"})}),t.jsxs("div",{children:[t.jsx("h2",{className:"text-lg font-bold text-white",children:"Oomek Aggressor 3o3"}),t.jsx("p",{className:"text-xs text-gray-400",children:"303-Style Acid Synth by Radoslaw Dutkiewicz"})]})]})}),t.jsxs("div",{className:"p-4 space-y-4",children:[t.jsxs("section",{className:"bg-[#1a1a1a] rounded-xl p-4 border border-gray-800",children:[t.jsx(Xa,{color:"#ef4444",title:"Oscillator"}),t.jsxs("div",{className:"flex gap-4 justify-center mb-4",children:[t.jsx("button",{onClick:()=>n(0,0),className:`\n                flex-1 max-w-32 py-3 rounded-lg font-bold transition-all\n                ${0===s?"bg-red-500/20 text-red-400 ring-2 ring-red-500":"bg-gray-800 text-gray-500 hover:text-gray-300"}\n              `,children:"SAW"}),t.jsx("button",{onClick:()=>n(0,1),className:`\n                flex-1 max-w-32 py-3 rounded-lg font-bold transition-all\n                ${1===s?"bg-red-500/20 text-red-400 ring-2 ring-red-500":"bg-gray-800 text-gray-500 hover:text-gray-300"}\n              `,children:"SQUARE"})]}),t.jsx("div",{className:"flex justify-center",children:t.jsx(I,{value:u,min:0,max:200,onChange:e=>n(6,Math.round(e)),label:"Finetune",color:"#ef4444",bipolar:!0,formatValue:e=>`${Math.round(e-100)}`})})]}),t.jsxs("section",{className:"bg-[#1a1a1a] rounded-xl p-4 border border-gray-800",children:[t.jsx(Xa,{color:"#f97316",title:"Filter"}),t.jsxs("div",{className:"flex flex-wrap gap-6 items-end",children:[t.jsx(I,{value:i,min:0,max:240,onChange:e=>n(1,Math.round(e)),label:"Cutoff",color:"#f97316",formatValue:e=>`${Math.round(e/2.4)}%`}),t.jsx(I,{value:o,min:0,max:128,onChange:e=>n(2,Math.round(e)),label:"Resonance",color:"#f97316",formatValue:e=>`${Math.round(e/1.28)}%`}),t.jsx(I,{value:l,min:0,max:128,onChange:e=>n(3,Math.round(e)),label:"Env Mod",color:"#f97316",formatValue:e=>`${Math.round(e/1.28)}%`})]})]}),t.jsxs("section",{className:"bg-[#1a1a1a] rounded-xl p-4 border border-gray-800",children:[t.jsx(Xa,{color:"#eab308",title:"Envelope & Output"}),t.jsxs("div",{className:"flex flex-wrap gap-6 items-end",children:[t.jsx(I,{value:d,min:0,max:128,onChange:e=>n(4,Math.round(e)),label:"Decay",color:"#eab308",formatValue:e=>`${Math.round(e/1.28)}%`}),t.jsx(I,{value:c,min:0,max:128,onChange:e=>n(5,Math.round(e)),label:"Accent",color:"#eab308",formatValue:e=>`${Math.round(e/1.28)}%`}),t.jsx(I,{value:m,min:0,max:200,onChange:e=>n(7,Math.round(e)),label:"Volume",color:"#eab308",formatValue:e=>`${Math.round(e/2)}%`})]})]})]})]})},JeskolaDelay:({config:e,onChange:a})=>{const n=Ya(e,a),r=e.buzzmachine?.parameters||{},s=r[0]??1,i=(r[1]??3)|(r[2]??0)<<8,o=r[3]??0,l=r[4]??96,d=r[5]??48;return t.jsxs("div",{className:"synth-editor-container bg-gradient-to-b from-[#1e1e1e] to-[#151515]",children:[t.jsx("div",{className:"synth-editor-header px-4 py-3 bg-[#1a1a1a]",children:t.jsxs("div",{className:"flex items-center gap-3",children:[t.jsx("div",{className:"p-2 rounded-lg bg-gradient-to-br from-blue-600 to-cyan-600",children:t.jsx(Be,{size:20,className:"text-white"})}),t.jsxs("div",{children:[t.jsx("h2",{className:"text-lg font-bold text-white",children:"Jeskola Delay"}),t.jsx("p",{className:"text-xs text-gray-400",children:"Mono Delay by Oskari Tammelin"})]})]})}),t.jsxs("div",{className:"p-4 space-y-4",children:[t.jsxs("section",{className:"bg-[#1a1a1a] rounded-xl p-4 border border-gray-800",children:[t.jsx(Xa,{color:"#3b82f6",title:"Time"}),t.jsx("div",{className:"flex flex-wrap gap-6 items-end",children:t.jsx(I,{value:i,min:1,max:65535,onChange:e=>((e,t,a)=>{const r=a>>8&255;n(e,255&a),n(t,r)})(1,2,Math.round(e)),label:"Length",size:"lg",color:"#3b82f6",formatValue:e=>Math.round(e).toString()})}),t.jsx("div",{className:"flex justify-center mt-4 gap-1",children:["tick","ms","sample","1/256 tick"].map((e,a)=>t.jsx("button",{onClick:()=>n(3,a),className:"px-2 py-1 text-xs rounded font-medium transition-all "+(o===a?"bg-blue-500/20 text-blue-400 ring-1 ring-blue-500":"bg-gray-800 text-gray-500 hover:text-gray-300"),children:e},a))})]}),t.jsxs("section",{className:"bg-[#1a1a1a] rounded-xl p-4 border border-gray-800",children:[t.jsx(Xa,{color:"#06b6d4",title:"Mix"}),t.jsxs("div",{className:"flex flex-wrap gap-6 items-end",children:[t.jsxs("div",{className:"flex flex-col items-center gap-2",children:[t.jsx("span",{className:"text-xs text-gray-400",children:"Dry Thru"}),t.jsx("button",{onClick:()=>n(0,1===s?0:1),className:"px-4 py-2 rounded-lg font-bold text-sm transition-all "+(1===s?"bg-cyan-500/20 text-cyan-400 ring-1 ring-cyan-500":"bg-gray-800 text-gray-500 hover:text-gray-300"),children:1===s?"ON":"OFF"})]}),t.jsx(I,{value:l,min:0,max:128,onChange:e=>n(4,Math.round(e)),label:"Feedback",color:"#06b6d4",formatValue:e=>`${Math.round(e/128*100)}%`}),t.jsx(I,{value:d,min:0,max:128,onChange:e=>n(5,Math.round(e)),label:"Wet",color:"#06b6d4",formatValue:e=>`${Math.round(e/128*100)}%`})]})]})]})]})},JeskolaCrossDelay:({config:e,onChange:a})=>{const n=Ya(e,a),r=e.buzzmachine?.parameters||{},s=r[0]??1,i=(r[1]??3)|(r[2]??0)<<8,o=(r[3]??3)|(r[4]??0)<<8,l=r[5]??0,d=r[6]??96,c=r[7]??48,u=(e,t,a)=>{const r=a>>8&255;n(e,255&a),n(t,r)};return t.jsxs("div",{className:"synth-editor-container bg-gradient-to-b from-[#1e1e1e] to-[#151515]",children:[t.jsx("div",{className:"synth-editor-header px-4 py-3 bg-[#1a1a1a]",children:t.jsxs("div",{className:"flex items-center gap-3",children:[t.jsx("div",{className:"p-2 rounded-lg bg-gradient-to-br from-pink-500 to-purple-600",children:t.jsx(Be,{size:20,className:"text-white"})}),t.jsxs("div",{children:[t.jsx("h2",{className:"text-lg font-bold text-white",children:"Jeskola CrossDelay"}),t.jsx("p",{className:"text-xs text-gray-400",children:"Stereo Cross Delay by Oskari Tammelin"})]})]})}),t.jsxs("div",{className:"p-4 space-y-4",children:[t.jsxs("section",{className:"bg-[#1a1a1a] rounded-xl p-4 border border-gray-800",children:[t.jsx(Xa,{color:"#ec4899",title:"Stereo Time"}),t.jsxs("div",{className:"flex flex-wrap gap-6 items-end",children:[t.jsx(I,{value:i,min:1,max:65535,onChange:e=>u(1,2,Math.round(e)),label:"Left",color:"#ec4899",formatValue:e=>Math.round(e).toString()}),t.jsx(I,{value:o,min:1,max:65535,onChange:e=>u(3,4,Math.round(e)),label:"Right",color:"#a855f7",formatValue:e=>Math.round(e).toString()})]}),t.jsx("div",{className:"flex justify-center mt-4 gap-1",children:["tick","ms","sample","1/256 tick"].map((e,a)=>t.jsx("button",{onClick:()=>n(5,a),className:"px-2 py-1 text-xs rounded font-medium transition-all "+(l===a?"bg-pink-500/20 text-pink-400 ring-1 ring-pink-500":"bg-gray-800 text-gray-500 hover:text-gray-300"),children:e},a))})]}),t.jsxs("section",{className:"bg-[#1a1a1a] rounded-xl p-4 border border-gray-800",children:[t.jsx(Xa,{color:"#8b5cf6",title:"Mix"}),t.jsxs("div",{className:"flex flex-wrap gap-6 items-end",children:[t.jsxs("div",{className:"flex flex-col items-center gap-2",children:[t.jsx("span",{className:"text-xs text-gray-400",children:"Dry Thru"}),t.jsx("button",{onClick:()=>n(0,1===s?0:1),className:"px-4 py-2 rounded-lg font-bold text-sm transition-all "+(1===s?"bg-purple-500/20 text-purple-400 ring-1 ring-purple-500":"bg-gray-800 text-gray-500 hover:text-gray-300"),children:1===s?"ON":"OFF"})]}),t.jsx(I,{value:d,min:0,max:128,onChange:e=>n(6,Math.round(e)),label:"Feedback",color:"#8b5cf6",formatValue:e=>`${Math.round(e/128*100)}%`}),t.jsx(I,{value:c,min:0,max:128,onChange:e=>n(7,Math.round(e)),label:"Wet",color:"#8b5cf6",formatValue:e=>`${Math.round(e/128*100)}%`})]})]})]})]})},JeskolaFreeverb:({config:e,onChange:a})=>{const n=Ya(e,a),r=e.buzzmachine?.parameters||{},s=r[0]??200,i=r[1]??128,o=r[2]??0,l=r[3]??0,d=r[4]??255,c=r[5]??64,u=r[6]??255;return t.jsxs("div",{className:"synth-editor-container bg-gradient-to-b from-[#1e1e1e] to-[#151515]",children:[t.jsx("div",{className:"synth-editor-header px-4 py-3 bg-[#1a1a1a]",children:t.jsxs("div",{className:"flex items-center gap-3",children:[t.jsx("div",{className:"p-2 rounded-lg bg-gradient-to-br from-indigo-500 to-blue-600",children:t.jsx(Be,{size:20,className:"text-white"})}),t.jsxs("div",{children:[t.jsx("h2",{className:"text-lg font-bold text-white",children:"Jeskola Freeverb"}),t.jsx("p",{className:"text-xs text-gray-400",children:"Freeverb Reverb by Oskari Tammelin"})]})]})}),t.jsxs("div",{className:"p-4 space-y-4",children:[t.jsxs("section",{className:"bg-[#1a1a1a] rounded-xl p-4 border border-gray-800",children:[t.jsx(Xa,{color:"#6366f1",title:"Reverb Character"}),t.jsxs("div",{className:"flex flex-wrap gap-6 items-end",children:[t.jsx(I,{value:s,min:0,max:255,onChange:e=>n(0,Math.round(e)),label:"Room Size",color:"#6366f1",formatValue:e=>`${Math.round(e/2.55)}%`}),t.jsx(I,{value:i,min:0,max:255,onChange:e=>n(1,Math.round(e)),label:"Hi Damp",color:"#6366f1",formatValue:e=>`${Math.round(e/2.55)}%`}),t.jsx(I,{value:o,min:0,max:255,onChange:e=>n(2,Math.round(e)),label:"Pre-Delay",color:"#6366f1",formatValue:e=>`${Math.round(e)}ms`})]})]}),t.jsxs("section",{className:"bg-[#1a1a1a] rounded-xl p-4 border border-gray-800",children:[t.jsx(Xa,{color:"#8b5cf6",title:"Filter"}),t.jsxs("div",{className:"flex flex-wrap gap-6 items-end",children:[t.jsx(I,{value:l,min:0,max:255,onChange:e=>n(3,Math.round(e)),label:"Low Cut",color:"#8b5cf6",formatValue:e=>`${Math.round(e/2.55)}%`}),t.jsx(I,{value:d,min:0,max:255,onChange:e=>n(4,Math.round(e)),label:"Hi Cut",color:"#8b5cf6",formatValue:e=>`${Math.round(e/2.55)}%`})]})]}),t.jsxs("section",{className:"bg-[#1a1a1a] rounded-xl p-4 border border-gray-800",children:[t.jsx(Xa,{color:"#a855f7",title:"Output"}),t.jsxs("div",{className:"flex flex-wrap gap-6 items-end",children:[t.jsx(I,{value:u,min:0,max:255,onChange:e=>n(6,Math.round(e)),label:"Dry",color:"#a855f7",formatValue:e=>`${Math.round(e/2.55)}%`}),t.jsx(I,{value:c,min:0,max:255,onChange:e=>n(5,Math.round(e)),label:"Reverb",color:"#a855f7",formatValue:e=>`${Math.round(e/2.55)}%`})]})]})]})]})},JeskolaDistortion:({config:e,onChange:a})=>{const n=Ya(e,a),r=e.buzzmachine?.parameters||{},s=(r[0]??0)|(r[1]??96)<<8,i=(r[2]??0)|(r[3]??128)<<8,o=(r[4]??0)|(r[5]??160)<<8,l=(r[6]??0)|(r[7]??128)<<8,d=(r[8]??0)|(r[9]??128)<<8,c=(e,t,a)=>{const r=a>>8&255;n(e,255&a),n(t,r)};return t.jsxs("div",{className:"synth-editor-container bg-gradient-to-b from-[#1e1e1e] to-[#151515]",children:[t.jsx("div",{className:"synth-editor-header px-4 py-3 bg-[#1a1a1a]",children:t.jsxs("div",{className:"flex items-center gap-3",children:[t.jsx("div",{className:"p-2 rounded-lg bg-gradient-to-br from-red-600 to-orange-600",children:t.jsx(Se,{size:20,className:"text-white"})}),t.jsxs("div",{children:[t.jsx("h2",{className:"text-lg font-bold text-white",children:"Jeskola Distortion"}),t.jsx("p",{className:"text-xs text-gray-400",children:"Asymmetric Distortion by Oskari Tammelin"})]})]})}),t.jsxs("div",{className:"p-4 space-y-4",children:[t.jsxs("section",{className:"bg-[#1a1a1a] rounded-xl p-4 border border-gray-800",children:[t.jsx(Xa,{color:"#22c55e",title:"Positive (+)"}),t.jsxs("div",{className:"flex flex-wrap gap-6 items-end",children:[t.jsx(I,{value:s,min:0,max:65535,onChange:e=>c(0,1,Math.round(e)),label:"Threshold",color:"#22c55e",formatValue:e=>`${Math.round(e/655.35)}%`}),t.jsx(I,{value:i,min:0,max:65535,onChange:e=>c(2,3,Math.round(e)),label:"Clamp",color:"#22c55e",formatValue:e=>`${Math.round(e/655.35)}%`})]})]}),t.jsxs("section",{className:"bg-[#1a1a1a] rounded-xl p-4 border border-gray-800",children:[t.jsx(Xa,{color:"#ef4444",title:"Negative (-)"}),t.jsxs("div",{className:"flex flex-wrap gap-6 items-end",children:[t.jsx(I,{value:o,min:0,max:65535,onChange:e=>c(4,5,Math.round(e)),label:"Threshold",color:"#ef4444",formatValue:e=>`${Math.round(e/655.35)}%`}),t.jsx(I,{value:l,min:0,max:65535,onChange:e=>c(6,7,Math.round(e)),label:"Clamp",color:"#ef4444",formatValue:e=>`${Math.round(e/655.35)}%`})]})]}),t.jsxs("section",{className:"bg-[#1a1a1a] rounded-xl p-4 border border-gray-800",children:[t.jsx(Xa,{color:"#f97316",title:"Output"}),t.jsx("div",{className:"flex justify-center",children:t.jsx(I,{value:d,min:0,max:65535,onChange:e=>c(8,9,Math.round(e)),label:"Amount",size:"lg",color:"#f97316",formatValue:e=>`${Math.round(e/655.35)}%`})})]})]})]})}};const Qa=({config:e,onChange:a})=>{const n=function(e){return Za[e]||null}(e.buzzmachine?.machineType||"");return n?t.jsx(n,{config:e,onChange:a}):t.jsx(Ka,{config:e,onChange:a})};async function Ja(e){const t=function(e){const t=e.numberOfChannels,a=e.sampleRate,n=1,r=16,s=t*(r/8),i=e.length,o=i*s,l=44+o,d=new ArrayBuffer(l),c=new DataView(d);en(c,0,"RIFF"),c.setUint32(4,l-8,!0),en(c,8,"WAVE"),en(c,12,"fmt "),c.setUint32(16,16,!0),c.setUint16(20,n,!0),c.setUint16(22,t,!0),c.setUint32(24,a,!0),c.setUint32(28,a*s,!0),c.setUint16(32,s,!0),c.setUint16(34,r,!0),en(c,36,"data"),c.setUint32(40,o,!0);const u=44,m=[];for(let h=0;h<t;h++)m.push(e.getChannelData(h));let p=0;for(let h=0;h<i;h++)for(let e=0;e<t;e++){let t=m[e][h];t=Math.max(-1,Math.min(1,t)),c.setInt16(u+p,t<0?32768*t:32767*t,!0),p+=2}return d}(e),a=new Blob([t],{type:"audio/wav"});return new Promise((e,t)=>{const n=new FileReader;n.onload=()=>e(n.result),n.onerror=t,n.readAsDataURL(a)})}function en(e,t,a){for(let n=0;n<a.length;n++)e.setUint8(t+n,a.charCodeAt(n))}var tn,an,nn,rn,sn,on,ln,dn,cn,un,mn,pn,hn,fn,xn,gn,bn,yn,vn,wn,jn,_n,kn,Nn,$n,Cn,Sn,Mn,zn,Tn,En,An,In,On,Rn=Object.defineProperty,Vn=Object.getOwnPropertyDescriptor,Pn=Object.getOwnPropertyNames,Dn=Object.prototype.hasOwnProperty,Bn=(tn=function(e){if(typeof require<"u")return require.apply(this,arguments);throw Error('Dynamic require of "'+e+'" is not supported')},typeof require<"u"?require:typeof Proxy<"u"?new Proxy(tn,{get:(e,t)=>(typeof require<"u"?require:e)[t]}):tn),Ln=(e,t)=>()=>(e&&(t=e(e=0)),t),Fn=(e,t)=>{for(var a in t)Rn(e,a,{get:t[a],enumerable:!0})},Wn=e=>((e,t,a,n)=>{if(t&&"object"==typeof t||"function"==typeof t)for(let r of Pn(t))!Dn.call(e,r)&&r!==a&&Rn(e,r,{get:()=>t[r],enumerable:!(n=Vn(t,r))||n.enumerable});return e})(Rn({},"__esModule",{value:!0}),e),Un=Ln(()=>{an=new Map,nn=[],rn=(e,t,a)=>{if(t&&"function"==typeof t.init&&"function"==typeof t.createInferenceSessionHandler){let n=an.get(e);if(void 0===n)an.set(e,{backend:t,priority:a});else{if(n.priority>a)return;if(n.priority===a&&n.backend!==t)throw new Error(`cannot register backend "${e}" using priority ${a}`)}if(a>=0){let t=nn.indexOf(e);-1!==t&&nn.splice(t,1);for(let n=0;n<nn.length;n++)if(an.get(nn[n]).priority<=a)return void nn.splice(n,0,e);nn.push(e)}return}throw new TypeError("not a valid backend")},sn=async e=>{let t=an.get(e);if(!t)return"backend not found.";if(t.initialized)return t.backend;if(t.aborted)return t.error;{let n=!!t.initPromise;try{return n||(t.initPromise=t.backend.init(e)),await t.initPromise,t.initialized=!0,t.backend}catch(a){return n||(t.error=`${a}`,t.aborted=!0),t.error}finally{delete t.initPromise}}},on=async e=>{let t,a=e.executionProviders||[],n=a.map(e=>"string"==typeof e?e:e.name),r=0===n.length?nn:n,s=[],i=new Set;for(let l of r){let e=await sn(l);"string"==typeof e?s.push({name:l,err:e}):(t||(t=e),t===e&&i.add(l))}if(!t)throw new Error(`no available backend found. ERR: ${s.map(e=>`[${e.name}] ${e.err}`).join(", ")}`);for(let{name:l,err:d}of s)n.includes(l);let o=a.filter(e=>i.has("string"==typeof e?e:e.name));return[t,new Proxy(e,{get:(e,t)=>"executionProviders"===t?o:Reflect.get(e,t)})]}}),qn=Ln(()=>{Un()}),Hn=Ln(()=>{ln="1.23.2"}),Gn=Ln(()=>{Hn(),dn="warning",cn={wasm:{},webgl:{},webgpu:{},versions:{common:ln},set logLevel(e){if(void 0!==e){if("string"!=typeof e||-1===["verbose","info","warning","error","fatal"].indexOf(e))throw new Error(`Unsupported logging level: ${e}`);dn=e}},get logLevel(){return dn}},Object.defineProperty(cn,"logLevel",{enumerable:!0})}),Kn=Ln(()=>{Gn(),un=cn}),Xn=Ln(()=>{mn=(e,t)=>{let a=typeof document<"u"?document.createElement("canvas"):new OffscreenCanvas(1,1);a.width=e.dims[3],a.height=e.dims[2];let n=a.getContext("2d");if(null!=n){let r,s;void 0!==t?.tensorLayout&&"NHWC"===t.tensorLayout?(r=e.dims[2],s=e.dims[3]):(r=e.dims[3],s=e.dims[2]);let i,o,l=void 0!==t?.format?t.format:"RGB",d=t?.norm;void 0===d||void 0===d.mean?i=[255,255,255,255]:"number"==typeof d.mean?i=[d.mean,d.mean,d.mean,d.mean]:(i=[d.mean[0],d.mean[1],d.mean[2],0],void 0!==d.mean[3]&&(i[3]=d.mean[3])),void 0===d||void 0===d.bias?o=[0,0,0,0]:"number"==typeof d.bias?o=[d.bias,d.bias,d.bias,d.bias]:(o=[d.bias[0],d.bias[1],d.bias[2],0],void 0!==d.bias[3]&&(o[3]=d.bias[3]));let c=s*r,u=0,m=c,p=2*c,h=-1;"RGBA"===l?(u=0,m=c,p=2*c,h=3*c):"RGB"===l?(u=0,m=c,p=2*c):"RBG"===l&&(u=0,p=c,m=2*c);for(let t=0;t<s;t++)for(let a=0;a<r;a++){let r=(e.data[u++]-o[0])*i[0],s=(e.data[m++]-o[1])*i[1],l=(e.data[p++]-o[2])*i[2],d=-1===h?255:(e.data[h++]-o[3])*i[3];n.fillStyle="rgba("+r+","+s+","+l+","+d+")",n.fillRect(a,t,1,1)}if("toDataURL"in a)return a.toDataURL();throw new Error("toDataURL is not supported")}throw new Error("Can not access image data")},pn=(e,t)=>{let a,n=typeof document<"u"?document.createElement("canvas").getContext("2d"):new OffscreenCanvas(1,1).getContext("2d");if(null==n)throw new Error("Can not access image data");{let r,s,i;void 0!==t?.tensorLayout&&"NHWC"===t.tensorLayout?(r=e.dims[2],s=e.dims[1],i=e.dims[3]):(r=e.dims[3],s=e.dims[2],i=e.dims[1]);let o,l,d=void 0!==t&&void 0!==t.format?t.format:"RGB",c=t?.norm;void 0===c||void 0===c.mean?o=[255,255,255,255]:"number"==typeof c.mean?o=[c.mean,c.mean,c.mean,c.mean]:(o=[c.mean[0],c.mean[1],c.mean[2],255],void 0!==c.mean[3]&&(o[3]=c.mean[3])),void 0===c||void 0===c.bias?l=[0,0,0,0]:"number"==typeof c.bias?l=[c.bias,c.bias,c.bias,c.bias]:(l=[c.bias[0],c.bias[1],c.bias[2],0],void 0!==c.bias[3]&&(l[3]=c.bias[3]));let u=s*r;if(void 0!==t&&(void 0!==t.format&&4===i&&"RGBA"!==t.format||3===i&&"RGB"!==t.format&&"BGR"!==t.format))throw new Error("Tensor format doesn't match input tensor dims");let m=4,p=0,h=1,f=2,x=3,g=0,b=u,y=2*u,v=-1;"RGBA"===d?(g=0,b=u,y=2*u,v=3*u):"RGB"===d?(g=0,b=u,y=2*u):"RBG"===d&&(g=0,y=u,b=2*u),a=n.createImageData(r,s);for(let t=0;t<s*r;p+=m,h+=m,f+=m,x+=m,t++)a.data[p]=(e.data[g++]-l[0])*o[0],a.data[h]=(e.data[b++]-l[1])*o[1],a.data[f]=(e.data[y++]-l[2])*o[2],a.data[x]=-1===v?255:(e.data[v++]-l[3])*o[3]}return a}}),Yn=Ln(()=>{Jn(),hn=(e,t)=>{if(void 0===e)throw new Error("Image buffer must be defined");if(void 0===t.height||void 0===t.width)throw new Error("Image height and width must be defined");if("NHWC"===t.tensorLayout)throw new Error("NHWC Tensor layout is not supported yet");let a,n,{height:r,width:s}=t,i=t.norm??{mean:255,bias:0};a="number"==typeof i.mean?[i.mean,i.mean,i.mean,i.mean]:[i.mean[0],i.mean[1],i.mean[2],i.mean[3]??255],n="number"==typeof i.bias?[i.bias,i.bias,i.bias,i.bias]:[i.bias[0],i.bias[1],i.bias[2],i.bias[3]??0];let o=void 0!==t.format?t.format:"RGBA",l=void 0!==t.tensorFormat&&void 0!==t.tensorFormat?t.tensorFormat:"RGB",d=r*s,c="RGBA"===l?new Float32Array(4*d):new Float32Array(3*d),u=4,m=0,p=1,h=2,f=3,x=0,g=d,b=2*d,y=-1;"RGB"===o&&(u=3,m=0,p=1,h=2,f=-1),"RGBA"===l?y=3*d:"RBG"===l?(x=0,b=d,g=2*d):"BGR"===l&&(b=0,g=d,x=2*d);for(let v=0;v<d;v++,m+=u,h+=u,p+=u,f+=u)c[x++]=(e[m]+n[0])/a[0],c[g++]=(e[p]+n[1])/a[1],c[b++]=(e[h]+n[2])/a[2],-1!==y&&-1!==f&&(c[y++]=(e[f]+n[3])/a[3]);return new $n("float32",c,"RGBA"===l?[1,4,r,s]:[1,3,r,s])},fn=async(e,t)=>{let a,n=typeof HTMLImageElement<"u"&&e instanceof HTMLImageElement,r=typeof ImageData<"u"&&e instanceof ImageData,s=typeof ImageBitmap<"u"&&e instanceof ImageBitmap,i="string"==typeof e,o=t??{},l=()=>{if(typeof document<"u")return document.createElement("canvas");if(typeof OffscreenCanvas<"u")return new OffscreenCanvas(1,1);throw new Error("Canvas is not supported")},d=e=>typeof HTMLCanvasElement<"u"&&e instanceof HTMLCanvasElement||e instanceof OffscreenCanvas?e.getContext("2d"):null;if(n){let n=l();n.width=e.width,n.height=e.height;let r=d(n);if(null==r)throw new Error("Can not access image data");{let n=e.height,s=e.width;if(void 0!==t&&void 0!==t.resizedHeight&&void 0!==t.resizedWidth&&(n=t.resizedHeight,s=t.resizedWidth),void 0!==t){if(o=t,void 0!==t.tensorFormat)throw new Error("Image input config format must be RGBA for HTMLImageElement");o.tensorFormat="RGBA",o.height=n,o.width=s}else o.tensorFormat="RGBA",o.height=n,o.width=s;r.drawImage(e,0,0),a=r.getImageData(0,0,s,n).data}}else{if(!r){if(s){if(void 0===t)throw new Error("Please provide image config with format for Imagebitmap");let n=l();n.width=e.width,n.height=e.height;let r=d(n);if(null!=r){let t=e.height,n=e.width;return r.drawImage(e,0,0,n,t),a=r.getImageData(0,0,n,t).data,o.height=t,o.width=n,hn(a,o)}throw new Error("Can not access image data")}if(i)return new Promise((t,a)=>{let n=l(),r=d(n);if(!e||!r)return a();let s=new Image;s.crossOrigin="Anonymous",s.src=e,s.onload=()=>{n.width=s.width,n.height=s.height,r.drawImage(s,0,0,n.width,n.height);let e=r.getImageData(0,0,n.width,n.height);o.height=n.height,o.width=n.width,t(hn(e.data,o))}});throw new Error("Input data provided is not supported - aborted tensor creation")}{let n,r;if(void 0!==t&&void 0!==t.resizedWidth&&void 0!==t.resizedHeight?(n=t.resizedHeight,r=t.resizedWidth):(n=e.height,r=e.width),void 0!==t&&(o=t),o.format="RGBA",o.height=n,o.width=r,void 0!==t){let t=l();t.width=r,t.height=n;let s=d(t);if(null==s)throw new Error("Can not access image data");s.putImageData(e,0,0),a=s.getImageData(0,0,r,n).data}else a=e.data}}if(void 0!==a)return hn(a,o);throw new Error("Input data provided is not supported - aborted tensor creation")},xn=(e,t)=>{let{width:a,height:n,download:r,dispose:s}=t;return new $n({location:"texture",type:"float32",texture:e,dims:[1,n,a,4],download:r,dispose:s})},gn=(e,t)=>{let{dataType:a,dims:n,download:r,dispose:s}=t;return new $n({location:"gpu-buffer",type:a??"float32",gpuBuffer:e,dims:n,download:r,dispose:s})},bn=(e,t)=>{let{dataType:a,dims:n,download:r,dispose:s}=t;return new $n({location:"ml-tensor",type:a??"float32",mlTensor:e,dims:n,download:r,dispose:s})},yn=(e,t,a)=>new $n({location:"cpu-pinned",type:e,data:t,dims:a??[t.length]})}),Zn=Ln(()=>{vn=new Map([["float32",Float32Array],["uint8",Uint8Array],["int8",Int8Array],["uint16",Uint16Array],["int16",Int16Array],["int32",Int32Array],["bool",Uint8Array],["float64",Float64Array],["uint32",Uint32Array],["int4",Uint8Array],["uint4",Uint8Array]]),wn=new Map([[Float32Array,"float32"],[Uint8Array,"uint8"],[Int8Array,"int8"],[Uint16Array,"uint16"],[Int16Array,"int16"],[Int32Array,"int32"],[Float64Array,"float64"],[Uint32Array,"uint32"]]),jn=!1,_n=()=>{if(!jn){jn=!0;let e=typeof BigInt64Array<"u"&&BigInt64Array.from,t=typeof BigUint64Array<"u"&&BigUint64Array.from,a=globalThis.Float16Array,n=typeof a<"u"&&a.from;e&&(vn.set("int64",BigInt64Array),wn.set(BigInt64Array,"int64")),t&&(vn.set("uint64",BigUint64Array),wn.set(BigUint64Array,"uint64")),n?(vn.set("float16",a),wn.set(a,"float16")):vn.set("float16",Uint16Array)}}}),Qn=Ln(()=>{Jn(),kn=e=>{let t=1;for(let a=0;a<e.length;a++){let n=e[a];if("number"!=typeof n||!Number.isSafeInteger(n))throw new TypeError(`dims[${a}] must be an integer, got: ${n}`);if(n<0)throw new RangeError(`dims[${a}] must be a non-negative integer, got: ${n}`);t*=n}return t},Nn=(e,t)=>{switch(e.location){case"cpu":return new $n(e.type,e.data,t);case"cpu-pinned":return new $n({location:"cpu-pinned",data:e.data,type:e.type,dims:t});case"texture":return new $n({location:"texture",texture:e.texture,type:e.type,dims:t});case"gpu-buffer":return new $n({location:"gpu-buffer",gpuBuffer:e.gpuBuffer,type:e.type,dims:t});case"ml-tensor":return new $n({location:"ml-tensor",mlTensor:e.mlTensor,type:e.type,dims:t});default:throw new Error(`tensorReshape: tensor location ${e.location} is not supported`)}}}),Jn=Ln(()=>{Xn(),Yn(),Zn(),Qn(),$n=class{constructor(e,t,a){let n,r;if(_n(),"object"==typeof e&&"location"in e)switch(this.dataLocation=e.location,n=e.type,r=e.dims,e.location){case"cpu-pinned":{let t=vn.get(n);if(!t)throw new TypeError(`unsupported type "${n}" to create tensor from pinned buffer`);if(!(e.data instanceof t))throw new TypeError(`buffer should be of type ${t.name}`);this.cpuData=e.data;break}case"texture":if("float32"!==n)throw new TypeError(`unsupported type "${n}" to create tensor from texture`);this.gpuTextureData=e.texture,this.downloader=e.download,this.disposer=e.dispose;break;case"gpu-buffer":if("float32"!==n&&"float16"!==n&&"int32"!==n&&"int64"!==n&&"uint32"!==n&&"uint8"!==n&&"bool"!==n&&"uint4"!==n&&"int4"!==n)throw new TypeError(`unsupported type "${n}" to create tensor from gpu buffer`);this.gpuBufferData=e.gpuBuffer,this.downloader=e.download,this.disposer=e.dispose;break;case"ml-tensor":if("float32"!==n&&"float16"!==n&&"int32"!==n&&"int64"!==n&&"uint32"!==n&&"uint64"!==n&&"int8"!==n&&"uint8"!==n&&"bool"!==n&&"uint4"!==n&&"int4"!==n)throw new TypeError(`unsupported type "${n}" to create tensor from MLTensor`);this.mlTensorData=e.mlTensor,this.downloader=e.download,this.disposer=e.dispose;break;default:throw new Error(`Tensor constructor: unsupported location '${this.dataLocation}'`)}else{let s,i;if("string"==typeof e)if(n=e,i=a,"string"===e){if(!Array.isArray(t))throw new TypeError("A string tensor's data must be a string array.");s=t}else{let a=vn.get(e);if(void 0===a)throw new TypeError(`Unsupported tensor type: ${e}.`);if(Array.isArray(t)){if("float16"===e&&a===Uint16Array||"uint4"===e||"int4"===e)throw new TypeError(`Creating a ${e} tensor from number array is not supported. Please use ${a.name} as data.`);s="uint64"===e||"int64"===e?a.from(t,BigInt):a.from(t)}else if(t instanceof a)s=t;else if(t instanceof Uint8ClampedArray){if("uint8"!==e)throw new TypeError("A Uint8ClampedArray tensor's data must be type of uint8");s=Uint8Array.from(t)}else{if(!("float16"===e&&t instanceof Uint16Array&&a!==Uint16Array))throw new TypeError(`A ${n} tensor's data must be type of ${a}`);s=new globalThis.Float16Array(t.buffer,t.byteOffset,t.length)}}else if(i=t,Array.isArray(e)){if(0===e.length)throw new TypeError("Tensor type cannot be inferred from an empty array.");let t=typeof e[0];if("string"===t)n="string",s=e;else{if("boolean"!==t)throw new TypeError(`Invalid element type of data array: ${t}.`);n="bool",s=Uint8Array.from(e)}}else if(e instanceof Uint8ClampedArray)n="uint8",s=Uint8Array.from(e);else{let t=wn.get(e.constructor);if(void 0===t)throw new TypeError(`Unsupported type for tensor data: ${e.constructor}.`);n=t,s=e}if(void 0===i)i=[s.length];else if(!Array.isArray(i))throw new TypeError("A tensor's dims must be a number array");r=i,this.cpuData=s,this.dataLocation="cpu"}let s=kn(r);if(this.cpuData&&s!==this.cpuData.length&&("uint4"!==n&&"int4"!==n||Math.ceil(s/2)!==this.cpuData.length))throw new Error(`Tensor's size(${s}) does not match data length(${this.cpuData.length}).`);this.type=n,this.dims=r,this.size=s}static async fromImage(e,t){return fn(e,t)}static fromTexture(e,t){return xn(e,t)}static fromGpuBuffer(e,t){return gn(e,t)}static fromMLTensor(e,t){return bn(e,t)}static fromPinnedBuffer(e,t,a){return yn(e,t,a)}toDataURL(e){return mn(this,e)}toImageData(e){return pn(this,e)}get data(){if(this.ensureValid(),!this.cpuData)throw new Error("The data is not on CPU. Use `getData()` to download GPU data to CPU, or use `texture` or `gpuBuffer` property to access the GPU data directly.");return this.cpuData}get location(){return this.dataLocation}get texture(){if(this.ensureValid(),!this.gpuTextureData)throw new Error("The data is not stored as a WebGL texture.");return this.gpuTextureData}get gpuBuffer(){if(this.ensureValid(),!this.gpuBufferData)throw new Error("The data is not stored as a WebGPU buffer.");return this.gpuBufferData}get mlTensor(){if(this.ensureValid(),!this.mlTensorData)throw new Error("The data is not stored as a WebNN MLTensor.");return this.mlTensorData}async getData(e){switch(this.ensureValid(),this.dataLocation){case"cpu":case"cpu-pinned":return this.data;case"texture":case"gpu-buffer":case"ml-tensor":if(!this.downloader)throw new Error("The current tensor is not created with a specified data downloader.");if(this.isDownloading)throw new Error("The current tensor is being downloaded.");try{this.isDownloading=!0;let t=await this.downloader();return this.downloader=void 0,this.dataLocation="cpu",this.cpuData=t,e&&this.disposer&&(this.disposer(),this.disposer=void 0),t}finally{this.isDownloading=!1}default:throw new Error(`cannot get data from location: ${this.dataLocation}`)}}dispose(){if(this.isDownloading)throw new Error("The current tensor is being downloaded.");this.disposer&&(this.disposer(),this.disposer=void 0),this.cpuData=void 0,this.gpuTextureData=void 0,this.gpuBufferData=void 0,this.mlTensorData=void 0,this.downloader=void 0,this.isDownloading=void 0,this.dataLocation="none"}ensureValid(){if("none"===this.dataLocation)throw new Error("The tensor is disposed.")}reshape(e){if(this.ensureValid(),this.downloader||this.disposer)throw new Error("Cannot reshape a tensor that owns GPU resource.");return Nn(this,e)}}}),er=Ln(()=>{Jn(),Cn=$n}),tr=Ln(()=>{Gn(),Sn=(e,t)=>{typeof cn.trace>"u"?cn.wasm.trace:cn.trace},Mn=(e,t)=>{let a=(new Error).stack?.split(/\r\n|\r|\n/g)||[],n=!1;for(let r=0;r<a.length;r++){if(n&&!a[r].includes("TRACE_FUNC")){let n=`FUNC_${e}::${a[r].trim().split(" ")[1]}`;return t&&(n+=`::${t}`),void Sn("CPU",n)}a[r].includes("TRACE_FUNC")&&(n=!0)}},zn=e=>{(typeof cn.trace>"u"?!cn.wasm.trace:!cn.trace)||Mn("BEGIN",e)},Tn=e=>{(typeof cn.trace>"u"?!cn.wasm.trace:!cn.trace)||Mn("END",e)},En=e=>{typeof cn.trace>"u"?cn.wasm.trace:cn.trace},An=e=>{typeof cn.trace>"u"?cn.wasm.trace:cn.trace}}),ar=Ln(()=>{Un(),er(),tr(),In=class e{constructor(e){this.handler=e}async run(e,t,a){zn(),En("InferenceSession.run");let n={},r={};if("object"!=typeof e||null===e||e instanceof Cn||Array.isArray(e))throw new TypeError("'feeds' must be an object that use input names as keys and OnnxValue as corresponding values.");let s=!0;if("object"==typeof t){if(null===t)throw new TypeError("Unexpected argument[1]: cannot be null.");if(t instanceof Cn)throw new TypeError("'fetches' cannot be a Tensor");if(Array.isArray(t)){if(0===t.length)throw new TypeError("'fetches' cannot be an empty array.");s=!1;for(let e of t){if("string"!=typeof e)throw new TypeError("'fetches' must be a string array or an object.");if(-1===this.outputNames.indexOf(e))throw new RangeError(`'fetches' contains invalid output name: ${e}.`);n[e]=null}if("object"==typeof a&&null!==a)r=a;else if(typeof a<"u")throw new TypeError("'options' must be an object.")}else{let e=!1,i=Object.getOwnPropertyNames(t);for(let a of this.outputNames)if(-1!==i.indexOf(a)){let r=t[a];(null===r||r instanceof Cn)&&(e=!0,s=!1,n[a]=r)}if(e){if("object"==typeof a&&null!==a)r=a;else if(typeof a<"u")throw new TypeError("'options' must be an object.")}else r=t}}else if(typeof t<"u")throw new TypeError("Unexpected argument[1]: must be 'fetches' or 'options'.");for(let l of this.inputNames)if(typeof e[l]>"u")throw new Error(`input '${l}' is missing in 'feeds'.`);if(s)for(let l of this.outputNames)n[l]=null;let i=await this.handler.run(e,n,r),o={};for(let l in i)if(Object.hasOwnProperty.call(i,l)){let e=i[l];o[l]=e instanceof Cn?e:new Cn(e.type,e.data,e.dims)}return An("InferenceSession.run"),Tn(),o}async release(){return this.handler.dispose()}static async create(t,a,n,r){zn(),En("InferenceSession.create");let s,i={};if("string"==typeof t){if(s=t,"object"==typeof a&&null!==a)i=a;else if(typeof a<"u")throw new TypeError("'options' must be an object.")}else if(t instanceof Uint8Array){if(s=t,"object"==typeof a&&null!==a)i=a;else if(typeof a<"u")throw new TypeError("'options' must be an object.")}else{if(!(t instanceof ArrayBuffer||typeof SharedArrayBuffer<"u"&&t instanceof SharedArrayBuffer))throw new TypeError("Unexpected argument[0]: must be 'path' or 'buffer'.");{let e=t,o=0,l=t.byteLength;if("object"==typeof a&&null!==a)i=a;else if("number"==typeof a){if(o=a,!Number.isSafeInteger(o))throw new RangeError("'byteOffset' must be an integer.");if(o<0||o>=e.byteLength)throw new RangeError(`'byteOffset' is out of range [0, ${e.byteLength}).`);if(l=t.byteLength-o,"number"==typeof n){if(l=n,!Number.isSafeInteger(l))throw new RangeError("'byteLength' must be an integer.");if(l<=0||o+l>e.byteLength)throw new RangeError(`'byteLength' is out of range (0, ${e.byteLength-o}].`);if("object"==typeof r&&null!==r)i=r;else if(typeof r<"u")throw new TypeError("'options' must be an object.")}else if(typeof n<"u")throw new TypeError("'byteLength' must be a number.")}else if(typeof a<"u")throw new TypeError("'options' must be an object.");s=new Uint8Array(e,o,l)}}let[o,l]=await on(i),d=await o.createInferenceSessionHandler(s,l);return An("InferenceSession.create"),Tn(),new e(d)}startProfiling(){this.handler.startProfiling()}endProfiling(){this.handler.endProfiling()}get inputNames(){return this.handler.inputNames}get outputNames(){return this.handler.outputNames}get inputMetadata(){return this.handler.inputMetadata}get outputMetadata(){return this.handler.outputMetadata}}}),nr=Ln(()=>{ar(),On=In}),rr=Ln(()=>{}),sr=Ln(()=>{}),ir=Ln(()=>{}),or=Ln(()=>{});Fn({},{InferenceSession:()=>On,TRACE:()=>Sn,TRACE_EVENT_BEGIN:()=>En,TRACE_EVENT_END:()=>An,TRACE_FUNC_BEGIN:()=>zn,TRACE_FUNC_END:()=>Tn,Tensor:()=>Cn,env:()=>un,registerBackend:()=>rn});var lr=Ln(()=>{qn(),Kn(),nr(),er(),rr(),sr(),tr(),ir(),or()}),dr=Ln(()=>{}),cr={};Fn(cr,{default:()=>pr});var ur,mr,pr,hr=Ln(()=>{of(),ep(),Jm(),ur="ort-wasm-proxy-worker",(mr=globalThis.self?.name===ur)&&(self.onmessage=e=>{let{type:t,in:a}=e.data;try{switch(t){case"init-wasm":Br(a.wasm).then(()=>{$h(a).then(()=>{postMessage({type:t})},e=>{postMessage({type:t,err:e})})},e=>{postMessage({type:t,err:e})});break;case"init-ep":{let{epName:e,env:n}=a;Ch(n,e).then(()=>{postMessage({type:t})},e=>{postMessage({type:t,err:e})});break}case"copy-from":{let{buffer:e}=a,n=Th(e);postMessage({type:t,out:n});break}case"create":{let{model:e,options:n}=a;Eh(e,n).then(e=>{postMessage({type:t,out:e})},e=>{postMessage({type:t,err:e})});break}case"release":Ah(a),postMessage({type:t});break;case"run":{let{sessionId:e,inputIndices:n,inputs:r,outputIndices:s,options:i}=a;Oh(e,n,r,s,new Array(s.length).fill(null),i).then(e=>{e.some(e=>"cpu"!==e[3])?postMessage({type:t,err:"Proxy does not support non-cpu tensor location."}):postMessage({type:t,out:e},Vh([...r,...e]))},e=>{postMessage({type:t,err:e})});break}case"end-profiling":Rh(a),postMessage({type:t})}}catch(n){postMessage({type:t,err:n})}}),pr=mr?null:e=>new Worker(e??jr,{type:"module",name:ur})}),fr={};Fn(fr,{default:()=>gr});var xr,gr,br,yr,vr,wr,jr,_r,kr,Nr,$r,Cr,Sr,Mr,zr,Tr,Er,Ar,Ir,Or,Rr,Vr,Pr,Dr,Br,Lr,Fr,Wr,Ur,qr,Hr,Gr,Kr,Xr,Yr,Zr,Qr,Jr,es,ts,as,ns,rs,ss,is,os,ls,ds,cs,us,ms,ps,hs,fs,xs,gs,bs,ys,vs,ws,js,_s,ks,Ns,$s,Cs,Ss,Ms,zs,Ts,Es,As,Is,Os,Rs,Vs,Ps,Ds,Bs,Ls,Fs,Ws,Us,qs,Hs,Gs,Ks,Xs,Ys,Zs,Qs,Js,ei,ti,ai,ni,ri,si,ii,oi,li,di,ci,ui,mi,pi,hi,fi,xi,gi,bi,yi,vi,wi,ji,_i,ki,Ni,$i,Ci,Si,Mi,zi,Ti,Ei,Ai,Ii,Oi,Ri,Vi,Pi,Di,Bi,Li,Fi,Wi,Ui,qi,Hi,Gi,Ki,Xi,Yi,Zi,Qi,Ji,eo,to,ao,no,ro,so,io,oo,lo,co,uo,mo,po,ho,fo,xo,go,bo,yo,vo,wo,jo,_o,ko,No,$o,Co,So,Mo,zo,To,Eo,Ao,Io,Oo,Ro,Vo,Po,Do,Bo,Lo,Fo,Wo,Uo,qo,Ho,Go,Ko,Xo,Yo,Zo,Qo,Jo,el,tl,al,nl,rl,sl,il,ol,ll,dl,cl,ul,ml,pl,hl,fl,xl,gl,bl,yl,vl,wl,jl,_l,kl,Nl,$l,Cl,Sl,Ml,zl,Tl,El,Al,Il,Ol,Rl,Vl,Pl,Dl,Bl,Ll,Fl,Wl,Ul,ql,Hl,Gl,Kl,Xl,Yl,Zl,Ql,Jl,ed,td,ad,nd,rd,sd,id,od,ld,dd,cd,ud,md,pd,hd,fd,xd,gd,bd,yd,vd,wd,jd,_d,kd,Nd,$d,Cd,Sd,Md,zd,Td,Ed,Ad,Id,Od,Rd,Vd,Pd,Dd,Bd,Ld,Fd,Wd,Ud,qd,Hd,Gd,Kd,Xd,Yd,Zd,Qd,Jd,ec,tc,ac,nc,rc,sc,ic,oc,lc,dc,cc,uc,mc,pc,hc,fc,xc,gc,bc,yc,vc,wc,jc,_c,kc,Nc,$c,Cc,Sc,Mc,zc,Tc,Ec,Ac,Ic,Oc,Rc,Vc,Pc,Dc,Bc,Lc,Fc,Wc,Uc,qc,Hc,Gc,Kc,Xc,Yc,Zc,Qc,Jc,eu,tu,au,nu,ru,su,iu,ou,lu,du,cu,uu,mu,pu,hu,fu,xu,gu,bu,yu,vu,wu,ju,_u,ku,Nu,$u,Cu,Su,Mu,zu,Tu,Eu,Au,Iu,Ou,Ru,Vu,Pu,Du,Bu,Lu,Fu,Wu,Uu,qu,Hu,Gu,Ku,Xu,Yu,Zu,Qu,Ju,em,tm,am,nm,rm,sm,im,om,lm,dm,cm,um,mm,pm,hm,fm,xm,gm,bm,ym,vm,wm,jm,_m,km,Nm,$m,Cm,Sm,Mm,zm,Tm,Em,Am,Im,Om,Rm,Vm,Pm,Dm,Bm,Lm,Fm,Wm,Um,qm,Hm,Gm,Km,Xm,Ym,Zm,Qm=Ln(()=>{xr=async function(e={}){var t,a,n=e,r=new Promise((e,n)=>{t=e,a=n}),s="object"==typeof window,i=typeof WorkerGlobalScope<"u",o=i&&self.name?.startsWith("em-pthread");n.mountExternalData=(e,t)=>{e.startsWith("./")&&(e=e.substring(2)),(n.Fb||(n.Fb=new Map)).set(e,t)},n.unmountExternalData=()=>{delete n.Fb};var l=globalThis.SharedArrayBuffer??new WebAssembly.Memory({initial:0,maximum:0,qc:!0}).buffer.constructor;let d=e=>async(...t)=>{try{if(n.Gb)throw Error("Session already started");let a=n.Gb={ec:t[0],errors:[]},r=await e(...t);if(n.Gb!==a)throw Error("Session mismatch");n.Kb?.flush();let s=a.errors;if(0<s.length){let e=await Promise.all(s);if(e=e.filter(e=>e),0<e.length)throw Error(e.join("\n"))}return r}finally{n.Gb=null}};n.jsepInit=(e,t)=>{if("webgpu"===e){[n.Kb,n.Vb,n.Zb,n.Lb,n.Yb,n.Ab,n.$b,n.bc,n.Wb,n.Xb,n.ac]=t;let e=n.Kb;n.jsepRegisterBuffer=(t,a,n,r)=>e.registerBuffer(t,a,n,r),n.jsepGetBuffer=t=>e.getBuffer(t),n.jsepCreateDownloader=(t,a,n)=>e.createDownloader(t,a,n),n.jsepOnCreateSession=t=>{e.onCreateSession(t)},n.jsepOnReleaseSession=t=>{e.onReleaseSession(t)},n.jsepOnRunStart=t=>e.onRunStart(t),n.cc=(t,a)=>{e.upload(t,a)}}else if("webnn"===e){let e=t[0];[n.oc,n.Ob,n.webnnEnsureTensor,n.Pb,n.webnnDownloadTensor,n.nc,n.webnnEnableTraceEvent]=t.slice(1),n.webnnReleaseTensorId=n.Ob,n.webnnUploadTensor=n.Pb,n.webnnRegisterMLContext=n.nc,n.webnnOnRunStart=t=>e.onRunStart(t),n.webnnOnRunEnd=e.onRunEnd.bind(e),n.webnnOnReleaseSession=t=>{e.onReleaseSession(t)},n.webnnCreateMLTensorDownloader=(t,a)=>e.createMLTensorDownloader(t,a),n.webnnRegisterMLTensor=(t,a,n,r)=>e.registerMLTensor(t,a,n,r),n.webnnCreateMLContext=t=>e.createMLContext(t),n.webnnRegisterMLConstant=(t,a,r,s,i,o)=>e.registerMLConstant(t,a,r,s,i,n.Fb,o),n.webnnRegisterGraphInput=e.registerGraphInput.bind(e),n.webnnIsGraphInput=e.isGraphInput.bind(e),n.webnnRegisterGraphOutput=e.registerGraphOutput.bind(e),n.webnnIsGraphOutput=e.isGraphOutput.bind(e),n.webnnCreateTemporaryTensor=e.createTemporaryTensor.bind(e),n.webnnIsGraphInputOutputTypeSupported=e.isGraphInputOutputTypeSupported.bind(e)}};let c=()=>{let e=(e,t,a)=>(...n)=>{let r=Rt,s=t?.();n=e(...n);let i=t?.();return s!==i&&(e=i,a(s),t=a=null),Rt!=r?new Promise((e,t)=>{Ft={resolve:e,reject:t}}):n};(()=>{for(let t of["_OrtAppendExecutionProvider","_OrtCreateSession","_OrtRun","_OrtRunWithBinding","_OrtBindInput"])n[t]=e(n[t],()=>n[t],e=>n[t]=e)})(),void 0!==d&&(n._OrtRun=d(n._OrtRun),n._OrtRunWithBinding=d(n._OrtRunWithBinding)),c=void 0};n.asyncInit=()=>{c?.()};var u,m,p=(e,t)=>{throw t},h=import.meta.url,f="";if(s||i){try{f=new URL(".",h).href}catch{}i&&(m=e=>{var t=new XMLHttpRequest;return t.open("GET",e,!1),t.responseType="arraybuffer",t.send(null),new Uint8Array(t.response)}),u=async e=>{if(R(e))return new Promise((t,a)=>{var n=new XMLHttpRequest;n.open("GET",e,!0),n.responseType="arraybuffer",n.onload=()=>{200==n.status||0==n.status&&n.response?t(n.response):a(n.status)},n.onerror=a,n.send(null)});var t=await fetch(e,{credentials:"same-origin"});if(t.ok)return t.arrayBuffer();throw Error(t.status+" : "+t.url)}}var x,g,b,y,v,w,j,_,k,N,$,C,S,M,z,T=function(){}.bind(),E=function(){}.bind(),A=T,I=E,O=!1,R=e=>e.startsWith("file://");function V(){return g.buffer!=v.buffer&&H(),v}function P(){return g.buffer!=v.buffer&&H(),w}function D(){return g.buffer!=v.buffer&&H(),j}function B(){return g.buffer!=v.buffer&&H(),_}function L(){return g.buffer!=v.buffer&&H(),k}function F(){return g.buffer!=v.buffer&&H(),N}function W(){return g.buffer!=v.buffer&&H(),$}function U(){return g.buffer!=v.buffer&&H(),M}if(o){let e=function(t){try{var a=t.data,r=a.Db;if("load"===r){let t=[];self.onmessage=e=>t.push(e),self.startWorker=()=>{postMessage({Db:"loaded"});for(let a of t)e(a);self.onmessage=e};for(let e of a.Sb)n[e]&&!n[e].proxy||(n[e]=(...t)=>{postMessage({Db:"callHandler",Rb:e,args:t})},"print"==e&&(A=n[e]),"printErr"==e&&(I=n[e]));g=a.kc,H(),z(a.lc)}else if("run"===r){ge(a.Bb),mn(a.Bb,0,0,1,0,0),he(),jt(a.Bb),q||(ln(),q=!0);try{be(a.hc,a.Jb)}catch(s){if("unwind"!=s)throw s}}else"setimmediate"!==a.target&&("checkMailbox"===r?q&&_t():r&&(I(`worker: received unknown command ${r}`),I(a)))}catch(s){throw pn(),s}};var q=!1;self.onunhandledrejection=e=>{throw e.reason||e},self.onmessage=e}function H(){var e=g.buffer;n.HEAP8=v=new Int8Array(e),j=new Int16Array(e),n.HEAPU8=w=new Uint8Array(e),_=new Uint16Array(e),n.HEAP32=k=new Int32Array(e),n.HEAPU32=N=new Uint32Array(e),$=new Float32Array(e),M=new Float64Array(e),C=new BigInt64Array(e),S=new BigUint64Array(e)}function G(){o?startWorker(n):sn.Da()}var K,X=0,Y=null;function Z(){if(0==--X&&Y){var e=Y;Y=null,e()}}function Q(e){throw I(e="Aborted("+e+")"),O=!0,e=new WebAssembly.RuntimeError(e+". Build with -sASSERTIONS for more info."),a(e),e}function J(){return{a:{L:rn,Aa:nn,b:ve,$:je,A:$e,pa:Ce,X:Se,Z:Me,qa:ze,na:Te,ga:Ee,ma:Ae,J:Ie,Y:Oe,V:Re,oa:Ve,W:Pe,va:Be,E:Ge,Q:Xe,O:nt,D:st,v:it,s:ot,P:ct,z:bt,R:yt,ja:vt,T:kt,aa:$t,M:Ct,F:St,ia:jt,sa:Mt,r:Et,Ca:At,w:qt,o:Gt,m:Yt,c:Qe,Ba:Zt,n:Jt,j:aa,u:na,p:ra,f:sa,t:ia,l:oa,e:la,k:da,h:ca,g:ua,d:ma,da:pa,ea:ga,fa:ba,ba:ya,ca:va,N:_a,xa:ka,ua:$a,i:Ma,C:za,G:Ta,ta:Na,x:Ea,ra:Aa,U:Ia,q:ja,y:Oa,K:Ra,S:Va,za:La,ya:Fa,ka:Ha,la:Ga,_:le,B:Ka,I:Xa,ha:Ya,H:Qa,a:g,wa:ie}}}class ee{name="ExitStatus";constructor(e){this.message=`Program terminated with exit(${e})`,this.status=e}}var te=e=>{e.terminate(),e.onmessage=()=>{}},ae=[],ne=e=>{0==de.length&&(xe(),fe(de[0]));var t=de.pop();if(!t)return 6;ce.push(t),me[e.Bb]=t,t.Bb=e.Bb;var a={Db:"run",hc:e.fc,Jb:e.Jb,Bb:e.Bb};return t.postMessage(a,e.Nb),0},re=0,se=(e,t,...a)=>{for(var n=2*a.length,r=jn(),s=wn(8*n),i=s>>>3,o=0;o<a.length;o++){var l=a[o];"bigint"==typeof l?(C[i+2*o]=1n,C[i+2*o+1]=l):(C[i+2*o]=0n,U()[i+2*o+1>>>0]=l)}return e=hn(e,0,n,s,t),vn(r),e};function ie(e){if(o)return se(0,1,e);if(y=e,!(0<re)){for(var t of ce)te(t);for(t of de)te(t);de=[],ce=[],me={},O=!0}p(0,new ee(e))}function oe(e){if(o)return se(1,0,e);le(e)}var le=e=>{if(y=e,o)throw oe(e),"unwind";ie(e)},de=[],ce=[],ue=[],me={},pe=e=>{var t=e.Bb;delete me[t],de.push(e),ce.splice(ce.indexOf(e),1),e.Bb=0,fn(t)};function he(){ue.forEach(e=>e())}var fe=e=>new Promise(t=>{e.onmessage=a=>{var r=(a=a.data).Db;if(a.Hb&&a.Hb!=dn()){var s=me[a.Hb];s?s.postMessage(a,a.Nb):I(`Internal error! Worker sent a message "${r}" to target pthread ${a.Hb}, but that thread no longer exists!`)}else"checkMailbox"===r?_t():"spawnThread"===r?ne(a):"cleanupThread"===r?pe(me[a.ic]):"loaded"===r?(e.loaded=!0,t(e)):"setimmediate"===a.target?e.postMessage(a):"callHandler"===r?n[a.Rb](...a.args):r&&I(`worker sent an unknown command ${r}`)},e.onerror=e=>{throw I(`worker sent an error! ${e.filename}:${e.lineno}: ${e.message}`),e};var a,r=[];for(a of[])n.propertyIsEnumerable(a)&&r.push(a);e.postMessage({Db:"load",Sb:r,kc:g,lc:b})});function xe(){var e=new Worker((()=>{let e=URL;return import.meta.url>"file:"&&import.meta.url<"file;"?new e("ort.bundle.min.mjs",import.meta.url):new URL(import.meta.url)})(),{type:"module",workerData:"em-pthread",name:"em-pthread"});de.push(e)}var ge=e=>{H();var t=F()[e+52>>>2>>>0];e=F()[e+56>>>2>>>0],yn(t,t-e),vn(t)},be=(e,t)=>{re=0,e=_n(e,t),0<re?y=e:xn(e)};class ye{constructor(e){this.Ib=e-24}}function ve(e,t,a){var n=new ye(e>>>=0);throw t>>>=0,a>>>=0,F()[n.Ib+16>>>2>>>0]=0,F()[n.Ib+4>>>2>>>0]=t,F()[n.Ib+8>>>2>>>0]=a,e}function we(e,t,a,n){return o?se(2,1,e,t,a,n):je(e,t,a,n)}function je(e,t,a,n){if(e>>>=0,a>>>=0,n>>>=0,void 0===l)return 6;var r=[];return o&&0===r.length?we(e,t>>>=0,a,n):(e={fc:a,Bb:e,Jb:n,Nb:r},o?(e.Db="spawnThread",postMessage(e,r),0):ne(e))}var _e=typeof TextDecoder<"u"?new TextDecoder:void 0,ke=(e,t=0,a=NaN)=>{var n=(t>>>=0)+a;for(a=t;e[a]&&!(a>=n);)++a;if(16<a-t&&e.buffer&&_e)return _e.decode(e.buffer instanceof ArrayBuffer?e.subarray(t,a):e.slice(t,a));for(n="";t<a;){var r=e[t++];if(128&r){var s=63&e[t++];if(192==(224&r))n+=String.fromCharCode((31&r)<<6|s);else{var i=63&e[t++];65536>(r=224==(240&r)?(15&r)<<12|s<<6|i:(7&r)<<18|s<<12|i<<6|63&e[t++])?n+=String.fromCharCode(r):(r-=65536,n+=String.fromCharCode(55296|r>>10,56320|1023&r))}}else n+=String.fromCharCode(r)}return n},Ne=(e,t)=>(e>>>=0)?ke(P(),e,t):"";function $e(e,t,a){return o?se(3,1,e,t,a):0}function Ce(e,t){if(o)return se(4,1,e,t)}function Se(e,t){if(o)return se(5,1,e,t)}function Me(e,t,a){if(o)return se(6,1,e,t,a)}function ze(e,t,a){return o?se(7,1,e,t,a):0}function Te(e,t){if(o)return se(8,1,e,t)}function Ee(e,t,a){if(o)return se(9,1,e,t,a)}function Ae(e,t,a,n){if(o)return se(10,1,e,t,a,n)}function Ie(e,t,a,n){if(o)return se(11,1,e,t,a,n)}function Oe(e,t,a,n){if(o)return se(12,1,e,t,a,n)}function Re(e){if(o)return se(13,1,e)}function Ve(e,t){if(o)return se(14,1,e,t)}function Pe(e,t,a){if(o)return se(15,1,e,t,a)}var De,Be=()=>Q(""),Le=e=>{for(var t="";P()[e>>>0];)t+=De[P()[e++>>>0]];return t},Fe={},We={},Ue=n.BindingError=class extends Error{constructor(e){super(e),this.name="BindingError"}};function qe(e,t,a={}){return function(e,t,a={}){var n=t.name;if(!e)throw new Ue(`type "${n}" must have a positive integer typeid pointer`);if(We.hasOwnProperty(e)){if(a.Tb)return;throw new Ue(`Cannot register type '${n}' twice`)}We[e]=t,Fe.hasOwnProperty(e)&&(t=Fe[e],delete Fe[e],t.forEach(e=>e()))}(e,t,a)}var He=(e,t,a)=>{switch(t){case 1:return a?e=>V()[e>>>0]:e=>P()[e>>>0];case 2:return a?e=>D()[e>>>1>>>0]:e=>B()[e>>>1>>>0];case 4:return a?e=>L()[e>>>2>>>0]:e=>F()[e>>>2>>>0];case 8:return a?e=>C[e>>>3]:e=>S[e>>>3];default:throw new TypeError(`invalid integer width (${t}): ${e}`)}};function Ge(e,t,a){a>>>=0,qe(e>>>=0,{name:t=Le(t>>>0),fromWireType:e=>e,toWireType:function(e,t){if("bigint"!=typeof t&&"number"!=typeof t)throw t=null===t?"null":"object"==(e=typeof t)||"array"===e||"function"===e?t.toString():""+t,new TypeError(`Cannot convert "${t}" to ${this.name}`);return"number"==typeof t&&(t=BigInt(t)),t},Cb:Ke,readValueFromPointer:He(t,a,-1==t.indexOf("u")),Eb:null})}var Ke=8;function Xe(e,t,a,n){qe(e>>>=0,{name:t=Le(t>>>0),fromWireType:function(e){return!!e},toWireType:function(e,t){return t?a:n},Cb:Ke,readValueFromPointer:function(e){return this.fromWireType(P()[e>>>0])},Eb:null})}var Ye=[],Ze=[];function Qe(e){9<(e>>>=0)&&0==--Ze[e+1]&&(Ze[e]=void 0,Ye.push(e))}var Je=e=>{if(!e)throw new Ue(`Cannot use deleted val. handle = ${e}`);return Ze[e]},et=e=>{switch(e){case void 0:return 2;case null:return 4;case!0:return 6;case!1:return 8;default:let t=Ye.pop()||Ze.length;return Ze[t]=e,Ze[t+1]=1,t}};function tt(e){return this.fromWireType(F()[e>>>2>>>0])}var at={name:"emscripten::val",fromWireType:e=>{var t=Je(e);return Qe(e),t},toWireType:(e,t)=>et(t),Cb:Ke,readValueFromPointer:tt,Eb:null};function nt(e){return qe(e>>>0,at)}var rt=(e,t)=>{switch(t){case 4:return function(e){return this.fromWireType(W()[e>>>2>>>0])};case 8:return function(e){return this.fromWireType(U()[e>>>3>>>0])};default:throw new TypeError(`invalid float width (${t}): ${e}`)}};function st(e,t,a){a>>>=0,qe(e>>>=0,{name:t=Le(t>>>0),fromWireType:e=>e,toWireType:(e,t)=>t,Cb:Ke,readValueFromPointer:rt(t,a),Eb:null})}function it(e,t,a,n,r){if(e>>>=0,a>>>=0,t=Le(t>>>0),-1===r&&(r=4294967295),r=e=>e,0===n){var s=32-8*a;r=e=>e<<s>>>s}var i=t.includes("unsigned")?function(e,t){return t>>>0}:function(e,t){return t};qe(e,{name:t,fromWireType:r,toWireType:i,Cb:Ke,readValueFromPointer:He(t,a,0!==n),Eb:null})}function ot(e,t,a){function n(e){var t=F()[e>>>2>>>0];return e=F()[e+4>>>2>>>0],new r(V().buffer,e,t)}var r=[Int8Array,Uint8Array,Int16Array,Uint16Array,Int32Array,Uint32Array,Float32Array,Float64Array,BigInt64Array,BigUint64Array][t];qe(e>>>=0,{name:a=Le(a>>>0),fromWireType:n,Cb:Ke,readValueFromPointer:n},{Tb:!0})}var lt=(e,t,a)=>{var n=P();if(t>>>=0,0<a){var r=t;a=t+a-1;for(var s=0;s<e.length;++s){var i=e.charCodeAt(s);if(55296<=i&&57343>=i&&(i=65536+((1023&i)<<10)|1023&e.charCodeAt(++s)),127>=i){if(t>=a)break;n[t++>>>0]=i}else{if(2047>=i){if(t+1>=a)break;n[t++>>>0]=192|i>>6}else{if(65535>=i){if(t+2>=a)break;n[t++>>>0]=224|i>>12}else{if(t+3>=a)break;n[t++>>>0]=240|i>>18,n[t++>>>0]=128|i>>12&63}n[t++>>>0]=128|i>>6&63}n[t++>>>0]=128|63&i}}n[t>>>0]=0,e=t-r}else e=0;return e},dt=e=>{for(var t=0,a=0;a<e.length;++a){var n=e.charCodeAt(a);127>=n?t++:2047>=n?t+=2:55296<=n&&57343>=n?(t+=4,++a):t+=3}return t};function ct(e,t){qe(e>>>=0,{name:t=Le(t>>>0),fromWireType:function(e){for(var t,a=F()[e>>>2>>>0],n=e+4,r=n,s=0;s<=a;++s){var i=n+s;s!=a&&0!=P()[i>>>0]||(r=Ne(r,i-r),void 0===t?t=r:(t+="\0",t+=r),r=i+1)}return cn(e),t},toWireType:function(e,t){t instanceof ArrayBuffer&&(t=new Uint8Array(t));var a="string"==typeof t;if(!(a||ArrayBuffer.isView(t)&&1==t.BYTES_PER_ELEMENT))throw new Ue("Cannot pass non-string to std::string");var n=a?dt(t):t.length,r=un(4+n+1),s=r+4;return F()[r>>>2>>>0]=n,a?lt(t,s,n+1):P().set(t,s>>>0),null!==e&&e.push(cn,r),r},Cb:Ke,readValueFromPointer:tt,Eb(e){cn(e)}})}var ut=typeof TextDecoder<"u"?new TextDecoder("utf-16le"):void 0,mt=(e,t)=>{for(var a=e>>1,n=a+t/2;!(a>=n)&&B()[a>>>0];)++a;if(32<(a<<=1)-e&&ut)return ut.decode(P().slice(e,a));for(a="",n=0;!(n>=t/2);++n){var r=D()[e+2*n>>>1>>>0];if(0==r)break;a+=String.fromCharCode(r)}return a},pt=(e,t,a)=>{if(a??=2147483647,2>a)return 0;var n=t;a=(a-=2)<2*e.length?a/2:e.length;for(var r=0;r<a;++r){var s=e.charCodeAt(r);D()[t>>>1>>>0]=s,t+=2}return D()[t>>>1>>>0]=0,t-n},ht=e=>2*e.length,ft=(e,t)=>{for(var a=0,n="";!(a>=t/4);){var r=L()[e+4*a>>>2>>>0];if(0==r)break;++a,65536<=r?(r-=65536,n+=String.fromCharCode(55296|r>>10,56320|1023&r)):n+=String.fromCharCode(r)}return n},xt=(e,t,a)=>{if(t>>>=0,a??=2147483647,4>a)return 0;var n=t;a=n+a-4;for(var r=0;r<e.length;++r){var s=e.charCodeAt(r);if(55296<=s&&57343>=s&&(s=65536+((1023&s)<<10)|1023&e.charCodeAt(++r)),L()[t>>>2>>>0]=s,(t+=4)+4>a)break}return L()[t>>>2>>>0]=0,t-n},gt=e=>{for(var t=0,a=0;a<e.length;++a){var n=e.charCodeAt(a);55296<=n&&57343>=n&&++a,t+=4}return t};function bt(e,t,a){if(e>>>=0,t>>>=0,a=Le(a>>>=0),2===t)var n=mt,r=pt,s=ht,i=e=>B()[e>>>1>>>0];else 4===t&&(n=ft,r=xt,s=gt,i=e=>F()[e>>>2>>>0]);qe(e,{name:a,fromWireType:e=>{for(var a,r=F()[e>>>2>>>0],s=e+4,o=0;o<=r;++o){var l=e+4+o*t;o!=r&&0!=i(l)||(s=n(s,l-s),void 0===a?a=s:(a+="\0",a+=s),s=l+t)}return cn(e),a},toWireType:(e,n)=>{if("string"!=typeof n)throw new Ue(`Cannot pass non-string to C++ string type ${a}`);var i=s(n),o=un(4+i+t);return F()[o>>>2>>>0]=i/t,r(n,o+4,i+t),null!==e&&e.push(cn,o),o},Cb:Ke,readValueFromPointer:tt,Eb(e){cn(e)}})}function yt(e,t){qe(e>>>=0,{Ub:!0,name:t=Le(t>>>0),Cb:0,fromWireType:()=>{},toWireType:()=>{}})}function vt(e){mn(e>>>0,!i,1,!s,131072,!1),he()}var wt=e=>{if(!O)try{if(e(),!(0<re))try{o?xn(y):le(y)}catch(t){t instanceof ee||"unwind"==t||p(0,t)}}catch(t){t instanceof ee||"unwind"==t||p(0,t)}};function jt(e){e>>>=0,"function"==typeof Atomics.jc&&(Atomics.jc(L(),e>>>2,e).value.then(_t),e+=128,Atomics.store(L(),e>>>2,1))}var _t=()=>{var e=dn();e&&(jt(e),wt(bn))};function kt(e,t){(e>>>=0)==t>>>0?setTimeout(_t):o?postMessage({Hb:e,Db:"checkMailbox"}):(e=me[e])&&e.postMessage({Db:"checkMailbox"})}var Nt=[];function $t(e,t,a,n,r){for(t>>>=0,n/=2,Nt.length=n,a=r>>>0>>>3,r=0;r<n;r++)Nt[r]=C[a+2*r]?C[a+2*r+1]:U()[a+2*r+1>>>0];return(t?an[t]:tn[e])(...Nt)}var Ct=()=>{re=0};function St(e){e>>>=0,o?postMessage({Db:"cleanupThread",ic:e}):pe(me[e])}function Mt(e){}var zt=(e,t)=>{var a=We[e];if(void 0===a)throw e=on(e),a=Le(e),cn(e),new Ue(`${t} has unknown type ${a}`);return a},Tt=(e,t,a)=>{var n=[];return e=e.toWireType(n,a),n.length&&(F()[t>>>2>>>0]=et(n)),e};function Et(e,t,a){return t>>>=0,a>>>=0,e=Je(e>>>0),t=zt(t,"emval::as"),Tt(t,a,e)}function At(e,t){return t>>>=0,e=Je(e>>>0),(t=zt(t,"emval::as")).toWireType(null,e)}var It=e=>{try{e()}catch(t){Q(t)}},Ot=0,Rt=null,Vt=0,Pt=[],Dt={},Bt={},Lt=0,Ft=null,Wt=[];function Ut(e){return function(){if(!O){if(0===Ot){var t=!1,a=!1;(t=>{e().then(t)})((e=0)=>{if(!O&&(Vt=e,t=!0,a)){Ot=2,It(()=>$n(Rt)),typeof MainLoop<"u"&&MainLoop.Qb&&MainLoop.resume(),e=!1;try{var n=(i=L()[Rt+8>>>2>>>0],i=sn[Bt[i]],--re,i())}catch(i){n=i,e=!0}var r=!1;if(!Rt){var s=Ft;s&&(Ft=null,(e?s.reject:s.resolve)(n),r=!0)}if(e&&!r)throw n}var i}),a=!0,t||(Ot=1,Rt=function(){var e=un(65548),t=e+12;F()[e>>>2>>>0]=t,F()[e+4>>>2>>>0]=t+65536,t=Pt[0];var a=Dt[t];return void 0===a&&(a=Lt++,Dt[t]=a,Bt[a]=t),t=a,L()[e+8>>>2>>>0]=t,e}(),typeof MainLoop<"u"&&MainLoop.Qb&&MainLoop.pause(),It(()=>kn(Rt)))}else 2===Ot?(Ot=0,It(Cn),cn(Rt),Rt=null,Wt.forEach(wt)):Q(`invalid state: ${Ot}`);return Vt}}()}function qt(e){return e>>>=0,Ut(async()=>{var t=await Je(e);return et(t)})}var Ht=[];function Gt(e,t,a,n){return a>>>=0,n>>>=0,(e=Ht[e>>>0])(null,t=Je(t>>>0),a,n)}var Kt={},Xt=e=>{var t=Kt[e];return void 0===t?Le(e):t};function Yt(e,t,a,n,r){return a>>>=0,n>>>=0,r>>>=0,(e=Ht[e>>>0])(t=Je(t>>>0),t[a=Xt(a)],n,r)}function Zt(e,t){return t>>>=0,(e=Je(e>>>0))==Je(t)}var Qt=()=>"object"==typeof globalThis?globalThis:Function("return this")();function Jt(e){return 0==(e>>>=0)?et(Qt()):(e=Xt(e),et(Qt()[e]))}var ea=e=>{var t=Ht.length;return Ht.push(e),t},ta=(e,t)=>{for(var a=Array(e),n=0;n<e;++n)a[n]=zt(F()[t+4*n>>>2>>>0],`parameter ${n}`);return a};function aa(e,t,a){var n=(t=ta(e,t>>>0)).shift();e--;var r="return function (obj, func, destructorsRef, args) {\n",s=0,i=[];0===a&&i.push("obj");for(var o=["retType"],l=[n],d=0;d<e;++d)i.push(`arg${d}`),o.push(`argType${d}`),l.push(t[d]),r+=`  var arg${d} = argType${d}.readValueFromPointer(args${s?"+"+s:""});\n`,s+=t[d].Cb;return r+=`  var rv = ${1===a?"new func":"func.call"}(${i.join(", ")});\n`,n.Ub||(o.push("emval_returnValue"),l.push(Tt),r+="  return emval_returnValue(retType, destructorsRef, rv);\n"),e=new Function(...o,r+"};\n")(...l),a=`methodCaller<(${t.map(e=>e.name).join(", ")}) => ${n.name}>`,ea(Object.defineProperty(e,"name",{value:a}))}function na(e){return e=Xt(e>>>0),et(n[e])}function ra(e,t){return t>>>=0,e=Je(e>>>0),t=Je(t),et(e[t])}function sa(e){9<(e>>>=0)&&(Ze[e+1]+=1)}function ia(){return et([])}function oa(e){e=Je(e>>>0);for(var t=Array(e.length),a=0;a<e.length;a++)t[a]=e[a];return et(t)}function la(e){return et(Xt(e>>>0))}function da(){return et({})}function ca(e){for(var t=Je(e>>>=0);t.length;){var a=t.pop();t.pop()(a)}Qe(e)}function ua(e,t,a){t>>>=0,a>>>=0,e=Je(e>>>0),t=Je(t),a=Je(a),e[t]=a}function ma(e,t){return t>>>=0,e=(e=zt(e>>>0,"_emval_take_value")).readValueFromPointer(t),et(e)}function pa(e,t){e=-9007199254740992>e||9007199254740992<e?NaN:Number(e),t>>>=0,e=new Date(1e3*e),L()[t>>>2>>>0]=e.getUTCSeconds(),L()[t+4>>>2>>>0]=e.getUTCMinutes(),L()[t+8>>>2>>>0]=e.getUTCHours(),L()[t+12>>>2>>>0]=e.getUTCDate(),L()[t+16>>>2>>>0]=e.getUTCMonth(),L()[t+20>>>2>>>0]=e.getUTCFullYear()-1900,L()[t+24>>>2>>>0]=e.getUTCDay(),e=(e.getTime()-Date.UTC(e.getUTCFullYear(),0,1,0,0,0,0))/864e5|0,L()[t+28>>>2>>>0]=e}var ha=e=>e%4==0&&(e%100!=0||e%400==0),fa=[0,31,60,91,121,152,182,213,244,274,305,335],xa=[0,31,59,90,120,151,181,212,243,273,304,334];function ga(e,t){e=-9007199254740992>e||9007199254740992<e?NaN:Number(e),t>>>=0,e=new Date(1e3*e),L()[t>>>2>>>0]=e.getSeconds(),L()[t+4>>>2>>>0]=e.getMinutes(),L()[t+8>>>2>>>0]=e.getHours(),L()[t+12>>>2>>>0]=e.getDate(),L()[t+16>>>2>>>0]=e.getMonth(),L()[t+20>>>2>>>0]=e.getFullYear()-1900,L()[t+24>>>2>>>0]=e.getDay();var a=(ha(e.getFullYear())?fa:xa)[e.getMonth()]+e.getDate()-1|0;L()[t+28>>>2>>>0]=a,L()[t+36>>>2>>>0]=-60*e.getTimezoneOffset(),a=new Date(e.getFullYear(),6,1).getTimezoneOffset();var n=new Date(e.getFullYear(),0,1).getTimezoneOffset();e=0|(a!=n&&e.getTimezoneOffset()==Math.min(n,a)),L()[t+32>>>2>>>0]=e}function ba(e){e>>>=0;var t=new Date(L()[e+20>>>2>>>0]+1900,L()[e+16>>>2>>>0],L()[e+12>>>2>>>0],L()[e+8>>>2>>>0],L()[e+4>>>2>>>0],L()[e>>>2>>>0],0),a=L()[e+32>>>2>>>0],n=t.getTimezoneOffset(),r=new Date(t.getFullYear(),6,1).getTimezoneOffset(),s=new Date(t.getFullYear(),0,1).getTimezoneOffset(),i=Math.min(s,r);return 0>a?L()[e+32>>>2>>>0]=+(r!=s&&i==n):0<a!=(i==n)&&(r=Math.max(s,r),t.setTime(t.getTime()+6e4*((0<a?i:r)-n))),L()[e+24>>>2>>>0]=t.getDay(),a=(ha(t.getFullYear())?fa:xa)[t.getMonth()]+t.getDate()-1|0,L()[e+28>>>2>>>0]=a,L()[e>>>2>>>0]=t.getSeconds(),L()[e+4>>>2>>>0]=t.getMinutes(),L()[e+8>>>2>>>0]=t.getHours(),L()[e+12>>>2>>>0]=t.getDate(),L()[e+16>>>2>>>0]=t.getMonth(),L()[e+20>>>2>>>0]=t.getYear(),e=t.getTime(),BigInt(isNaN(e)?-1:e/1e3)}function ya(e,t,a,n,r,s,i){return o?se(16,1,e,t,a,n,r,s,i):-52}function va(e,t,a,n,r,s){if(o)return se(17,1,e,t,a,n,r,s)}var wa={},ja=()=>performance.timeOrigin+performance.now();function _a(e,t){if(o)return se(18,1,e,t);if(wa[e]&&(clearTimeout(wa[e].id),delete wa[e]),!t)return 0;var a=setTimeout(()=>{delete wa[e],wt(()=>gn(e,performance.timeOrigin+performance.now()))},t);return wa[e]={id:a,rc:t},0}function ka(e,t,a,n){e>>>=0,t>>>=0,a>>>=0,n>>>=0;var r=(new Date).getFullYear(),s=new Date(r,0,1).getTimezoneOffset();r=new Date(r,6,1).getTimezoneOffset();var i=Math.max(s,r);F()[e>>>2>>>0]=60*i,L()[t>>>2>>>0]=+(s!=r),e=(t=e=>{var t=Math.abs(e);return`UTC${0<=e?"-":"+"}${String(Math.floor(t/60)).padStart(2,"0")}${String(t%60).padStart(2,"0")}`})(s),t=t(r),r<s?(lt(e,a,17),lt(t,n,17)):(lt(e,n,17),lt(t,a,17))}var Na=()=>Date.now();function $a(e,t,a){return 0<=e&&3>=e?(e=0===e?Date.now():performance.timeOrigin+performance.now(),C[a>>>0>>>3]=BigInt(Math.round(1e6*e)),0):28}var Ca=[],Sa=(e,t)=>{Ca.length=0;for(var a;a=P()[e++>>>0];){var n=105!=a;t+=(n&=112!=a)&&t%8?4:0,Ca.push(112==a?F()[t>>>2>>>0]:106==a?C[t>>>3]:105==a?L()[t>>>2>>>0]:U()[t>>>3>>>0]),t+=n?8:4}return Ca};function Ma(e,t,a){return e>>>=0,t=Sa(t>>>0,a>>>0),an[e](...t)}function za(e,t,a){return e>>>=0,t=Sa(t>>>0,a>>>0),an[e](...t)}var Ta=()=>{};function Ea(e,t){return I(Ne(e>>>0,t>>>0))}var Aa=()=>{throw re+=1,"unwind"};function Ia(){return 4294901760}var Oa=()=>navigator.hardwareConcurrency;function Ra(){return Q("Cannot use emscripten_pc_get_function without -sUSE_OFFSET_CONVERTER"),0}function Va(e){e>>>=0;var t=P().length;if(e<=t||4294901760<e)return!1;for(var a=1;4>=a;a*=2){var n=t*(1+.2/a);n=Math.min(n,e+100663296);e:{n=(Math.min(4294901760,65536*Math.ceil(Math.max(e,n)/65536))-g.buffer.byteLength+65535)/65536|0;try{g.grow(n),H();var r=1;break e}catch{}r=void 0}if(r)return!0}return!1}var Pa=()=>(Q("Cannot use convertFrameToPC (needed by __builtin_return_address) without -sUSE_OFFSET_CONVERTER"),0),Da={},Ba=e=>{e.forEach(e=>{Pa()})};function La(){var e=Error().stack.toString().split("\n");return"Error"==e[0]&&e.shift(),Ba(e),Da.Mb=Pa(),Da.dc=e,Da.Mb}function Fa(e,t,a){if(e>>>=0,t>>>=0,Da.Mb==e)var n=Da.dc;else"Error"==(n=Error().stack.toString().split("\n"))[0]&&n.shift(),Ba(n);for(var r=3;n[r]&&Pa()!=e;)++r;for(e=0;e<a&&n[e+r];++e)L()[t+4*e>>>2>>>0]=Pa();return e}var Wa,Ua={},qa=()=>{if(!Wa){var e,t={USER:"web_user",LOGNAME:"web_user",PATH:"/",PWD:"/",HOME:"/home/web_user",LANG:("object"==typeof navigator&&navigator.languages&&navigator.languages[0]||"C").replace("-","_")+".UTF-8",_:"./this.program"};for(e in Ua)void 0===Ua[e]?delete t[e]:t[e]=Ua[e];var a=[];for(e in t)a.push(`${e}=${t[e]}`);Wa=a}return Wa};function Ha(e,t){if(o)return se(19,1,e,t);e>>>=0,t>>>=0;var a,n=0,r=0;for(a of qa()){var s=t+n;F()[e+r>>>2>>>0]=s,n+=lt(a,s,1/0)+1,r+=4}return 0}function Ga(e,t){if(o)return se(20,1,e,t);e>>>=0,t>>>=0;var a=qa();for(var n of(F()[e>>>2>>>0]=a.length,e=0,a))e+=dt(n)+1;return F()[t>>>2>>>0]=e,0}function Ka(e){return o?se(21,1,e):52}function Xa(e,t,a,n){return o?se(22,1,e,t,a,n):52}function Ya(e,t,a,n){return o?se(23,1,e,t,a,n):70}var Za=[null,[],[]];function Qa(e,t,a,n){if(o)return se(24,1,e,t,a,n);t>>>=0,a>>>=0,n>>>=0;for(var r=0,s=0;s<a;s++){var i=F()[t>>>2>>>0],l=F()[t+4>>>2>>>0];t+=8;for(var d=0;d<l;d++){var c=e,u=P()[i+d>>>0],m=Za[c];0===u||10===u?((1===c?A:I)(ke(m)),m.length=0):m.push(u)}r+=l}return F()[n>>>2>>>0]=r,0}o||function(){for(var e=n.numThreads-1;e--;)xe();ae.push(()=>{var e;X++,e=()=>Z(),o?e():Promise.all(de.map(fe)).then(e)})}();for(var Ja=Array(256),en=0;256>en;++en)Ja[en]=String.fromCharCode(en);De=Ja,Ze.push(0,1,void 0,1,null,1,!0,1,!1,1),n.count_emval_handles=()=>Ze.length/2-5-Ye.length,o||(g=new WebAssembly.Memory({initial:256,maximum:65536,shared:!0}),H()),n.wasmBinary&&(x=n.wasmBinary),n.stackSave=()=>jn(),n.stackRestore=e=>vn(e),n.stackAlloc=e=>wn(e),n.setValue=function(e,t,a="i8"){switch(a.endsWith("*")&&(a="*"),a){case"i1":case"i8":V()[e>>>0]=t;break;case"i16":D()[e>>>1>>>0]=t;break;case"i32":L()[e>>>2>>>0]=t;break;case"i64":C[e>>>3]=BigInt(t);break;case"float":W()[e>>>2>>>0]=t;break;case"double":U()[e>>>3>>>0]=t;break;case"*":F()[e>>>2>>>0]=t;break;default:Q(`invalid type for setValue: ${a}`)}},n.getValue=function(e,t="i8"){switch(t.endsWith("*")&&(t="*"),t){case"i1":case"i8":return V()[e>>>0];case"i16":return D()[e>>>1>>>0];case"i32":return L()[e>>>2>>>0];case"i64":return C[e>>>3];case"float":return W()[e>>>2>>>0];case"double":return U()[e>>>3>>>0];case"*":return F()[e>>>2>>>0];default:Q(`invalid type for getValue: ${t}`)}},n.UTF8ToString=Ne,n.stringToUTF8=lt,n.lengthBytesUTF8=dt;var tn=[ie,oe,we,$e,Ce,Se,Me,ze,Te,Ee,Ae,Ie,Oe,Re,Ve,Pe,ya,va,_a,Ha,Ga,Ka,Xa,Ya,Qa],an={893836:(e,t,a,r,s)=>{if(void 0===n||!n.Fb)return 1;if((e=Ne(Number(e>>>0))).startsWith("./")&&(e=e.substring(2)),!(e=n.Fb.get(e)))return 2;if(t=Number(t>>>0),a=Number(a>>>0),r=Number(r>>>0),t+a>e.byteLength)return 3;try{let i=e.subarray(t,t+a);switch(s){case 0:P().set(i,r>>>0);break;case 1:n.mc?n.mc(r,i):n.cc(r,i);break;default:return 4}return 0}catch{return 4}},894660:(e,t,a)=>{n.Pb(e,P().subarray(t>>>0,t+a>>>0))},894724:()=>n.oc(),894766:e=>{n.Ob(e)},894803:()=>{n.Wb()},894834:()=>{n.Xb()},894863:()=>{n.ac()},894888:e=>n.Vb(e),894921:e=>n.Zb(e),894953:(e,t,a)=>{n.Lb(Number(e),Number(t),Number(a),!0)},895016:(e,t,a)=>{n.Lb(Number(e),Number(t),Number(a))},895073:()=>typeof wasmOffsetConverter<"u",895130:e=>{n.Ab("Abs",e,void 0)},895181:e=>{n.Ab("Neg",e,void 0)},895232:e=>{n.Ab("Floor",e,void 0)},895285:e=>{n.Ab("Ceil",e,void 0)},895337:e=>{n.Ab("Reciprocal",e,void 0)},895395:e=>{n.Ab("Sqrt",e,void 0)},895447:e=>{n.Ab("Exp",e,void 0)},895498:e=>{n.Ab("Erf",e,void 0)},895549:e=>{n.Ab("Sigmoid",e,void 0)},895604:(e,t,a)=>{n.Ab("HardSigmoid",e,{alpha:t,beta:a})},895683:e=>{n.Ab("Log",e,void 0)},895734:e=>{n.Ab("Sin",e,void 0)},895785:e=>{n.Ab("Cos",e,void 0)},895836:e=>{n.Ab("Tan",e,void 0)},895887:e=>{n.Ab("Asin",e,void 0)},895939:e=>{n.Ab("Acos",e,void 0)},895991:e=>{n.Ab("Atan",e,void 0)},896043:e=>{n.Ab("Sinh",e,void 0)},896095:e=>{n.Ab("Cosh",e,void 0)},896147:e=>{n.Ab("Asinh",e,void 0)},896200:e=>{n.Ab("Acosh",e,void 0)},896253:e=>{n.Ab("Atanh",e,void 0)},896306:e=>{n.Ab("Tanh",e,void 0)},896358:e=>{n.Ab("Not",e,void 0)},896409:(e,t,a)=>{n.Ab("Clip",e,{min:t,max:a})},896478:e=>{n.Ab("Clip",e,void 0)},896530:(e,t)=>{n.Ab("Elu",e,{alpha:t})},896588:e=>{n.Ab("Gelu",e,void 0)},896640:e=>{n.Ab("Relu",e,void 0)},896692:(e,t)=>{n.Ab("LeakyRelu",e,{alpha:t})},896756:(e,t)=>{n.Ab("ThresholdedRelu",e,{alpha:t})},896826:(e,t)=>{n.Ab("Cast",e,{to:t})},896884:e=>{n.Ab("Add",e,void 0)},896935:e=>{n.Ab("Sub",e,void 0)},896986:e=>{n.Ab("Mul",e,void 0)},897037:e=>{n.Ab("Div",e,void 0)},897088:e=>{n.Ab("Pow",e,void 0)},897139:e=>{n.Ab("Equal",e,void 0)},897192:e=>{n.Ab("Greater",e,void 0)},897247:e=>{n.Ab("GreaterOrEqual",e,void 0)},897309:e=>{n.Ab("Less",e,void 0)},897361:e=>{n.Ab("LessOrEqual",e,void 0)},897420:(e,t,a,r,s)=>{n.Ab("ReduceMean",e,{keepDims:!!t,noopWithEmptyAxes:!!a,axes:r?Array.from(L().subarray(Number(r)>>>0,Number(s)>>>0)):[]})},897595:(e,t,a,r,s)=>{n.Ab("ReduceMax",e,{keepDims:!!t,noopWithEmptyAxes:!!a,axes:r?Array.from(L().subarray(Number(r)>>>0,Number(s)>>>0)):[]})},897769:(e,t,a,r,s)=>{n.Ab("ReduceMin",e,{keepDims:!!t,noopWithEmptyAxes:!!a,axes:r?Array.from(L().subarray(Number(r)>>>0,Number(s)>>>0)):[]})},897943:(e,t,a,r,s)=>{n.Ab("ReduceProd",e,{keepDims:!!t,noopWithEmptyAxes:!!a,axes:r?Array.from(L().subarray(Number(r)>>>0,Number(s)>>>0)):[]})},898118:(e,t,a,r,s)=>{n.Ab("ReduceSum",e,{keepDims:!!t,noopWithEmptyAxes:!!a,axes:r?Array.from(L().subarray(Number(r)>>>0,Number(s)>>>0)):[]})},898292:(e,t,a,r,s)=>{n.Ab("ReduceL1",e,{keepDims:!!t,noopWithEmptyAxes:!!a,axes:r?Array.from(L().subarray(Number(r)>>>0,Number(s)>>>0)):[]})},898465:(e,t,a,r,s)=>{n.Ab("ReduceL2",e,{keepDims:!!t,noopWithEmptyAxes:!!a,axes:r?Array.from(L().subarray(Number(r)>>>0,Number(s)>>>0)):[]})},898638:(e,t,a,r,s)=>{n.Ab("ReduceLogSum",e,{keepDims:!!t,noopWithEmptyAxes:!!a,axes:r?Array.from(L().subarray(Number(r)>>>0,Number(s)>>>0)):[]})},898815:(e,t,a,r,s)=>{n.Ab("ReduceSumSquare",e,{keepDims:!!t,noopWithEmptyAxes:!!a,axes:r?Array.from(L().subarray(Number(r)>>>0,Number(s)>>>0)):[]})},898995:(e,t,a,r,s)=>{n.Ab("ReduceLogSumExp",e,{keepDims:!!t,noopWithEmptyAxes:!!a,axes:r?Array.from(L().subarray(Number(r)>>>0,Number(s)>>>0)):[]})},899175:e=>{n.Ab("Where",e,void 0)},899228:(e,t,a)=>{n.Ab("Transpose",e,{perm:t?Array.from(L().subarray(Number(t)>>>0,Number(a)>>>0)):[]})},899352:(e,t,a,r)=>{n.Ab("DepthToSpace",e,{blocksize:t,mode:Ne(a),format:r?"NHWC":"NCHW"})},899485:(e,t,a,r)=>{n.Ab("DepthToSpace",e,{blocksize:t,mode:Ne(a),format:r?"NHWC":"NCHW"})},899618:(e,t,a,r,s,i,o,l,d,c,u,m,p,h,f)=>{n.Ab("ConvTranspose",e,{format:d?"NHWC":"NCHW",autoPad:t,dilations:[a],group:r,kernelShape:[s],pads:[i,o],strides:[l],wIsConst:()=>!!V()[c>>>0],outputPadding:u?Array.from(L().subarray(Number(u)>>>0,Number(m)>>>0)):[],outputShape:p?Array.from(L().subarray(Number(p)>>>0,Number(h)>>>0)):[],activation:Ne(f)})},900051:(e,t,a,r,s,i,o,l,d,c,u,m,p,h)=>{n.Ab("ConvTranspose",e,{format:l?"NHWC":"NCHW",autoPad:t,dilations:Array.from(L().subarray(Number(a)>>>0,2+(Number(a)>>>0)>>>0)),group:r,kernelShape:Array.from(L().subarray(Number(s)>>>0,2+(Number(s)>>>0)>>>0)),pads:Array.from(L().subarray(Number(i)>>>0,4+(Number(i)>>>0)>>>0)),strides:Array.from(L().subarray(Number(o)>>>0,2+(Number(o)>>>0)>>>0)),wIsConst:()=>!!V()[d>>>0],outputPadding:c?Array.from(L().subarray(Number(c)>>>0,Number(u)>>>0)):[],outputShape:m?Array.from(L().subarray(Number(m)>>>0,Number(p)>>>0)):[],activation:Ne(h)})},900712:(e,t,a,r,s,i,o,l,d,c,u,m,p,h,f)=>{n.Ab("ConvTranspose",e,{format:d?"NHWC":"NCHW",autoPad:t,dilations:[a],group:r,kernelShape:[s],pads:[i,o],strides:[l],wIsConst:()=>!!V()[c>>>0],outputPadding:u?Array.from(L().subarray(Number(u)>>>0,Number(m)>>>0)):[],outputShape:p?Array.from(L().subarray(Number(p)>>>0,Number(h)>>>0)):[],activation:Ne(f)})},901145:(e,t,a,r,s,i,o,l,d,c,u,m,p,h)=>{n.Ab("ConvTranspose",e,{format:l?"NHWC":"NCHW",autoPad:t,dilations:Array.from(L().subarray(Number(a)>>>0,2+(Number(a)>>>0)>>>0)),group:r,kernelShape:Array.from(L().subarray(Number(s)>>>0,2+(Number(s)>>>0)>>>0)),pads:Array.from(L().subarray(Number(i)>>>0,4+(Number(i)>>>0)>>>0)),strides:Array.from(L().subarray(Number(o)>>>0,2+(Number(o)>>>0)>>>0)),wIsConst:()=>!!V()[d>>>0],outputPadding:c?Array.from(L().subarray(Number(c)>>>0,Number(u)>>>0)):[],outputShape:m?Array.from(L().subarray(Number(m)>>>0,Number(p)>>>0)):[],activation:Ne(h)})},901806:(e,t)=>{n.Ab("GlobalAveragePool",e,{format:t?"NHWC":"NCHW"})},901897:(e,t,a,r,s,i,o,l,d,c,u,m,p,h)=>{n.Ab("AveragePool",e,{format:h?"NHWC":"NCHW",auto_pad:t,ceil_mode:a,count_include_pad:r,storage_order:s,dilations:i?Array.from(L().subarray(Number(i)>>>0,Number(o)>>>0)):[],kernel_shape:l?Array.from(L().subarray(Number(l)>>>0,Number(d)>>>0)):[],pads:c?Array.from(L().subarray(Number(c)>>>0,Number(u)>>>0)):[],strides:m?Array.from(L().subarray(Number(m)>>>0,Number(p)>>>0)):[]})},902376:(e,t)=>{n.Ab("GlobalAveragePool",e,{format:t?"NHWC":"NCHW"})},902467:(e,t,a,r,s,i,o,l,d,c,u,m,p,h)=>{n.Ab("AveragePool",e,{format:h?"NHWC":"NCHW",auto_pad:t,ceil_mode:a,count_include_pad:r,storage_order:s,dilations:i?Array.from(L().subarray(Number(i)>>>0,Number(o)>>>0)):[],kernel_shape:l?Array.from(L().subarray(Number(l)>>>0,Number(d)>>>0)):[],pads:c?Array.from(L().subarray(Number(c)>>>0,Number(u)>>>0)):[],strides:m?Array.from(L().subarray(Number(m)>>>0,Number(p)>>>0)):[]})},902946:(e,t)=>{n.Ab("GlobalMaxPool",e,{format:t?"NHWC":"NCHW"})},903033:(e,t,a,r,s,i,o,l,d,c,u,m,p,h)=>{n.Ab("MaxPool",e,{format:h?"NHWC":"NCHW",auto_pad:t,ceil_mode:a,count_include_pad:r,storage_order:s,dilations:i?Array.from(L().subarray(Number(i)>>>0,Number(o)>>>0)):[],kernel_shape:l?Array.from(L().subarray(Number(l)>>>0,Number(d)>>>0)):[],pads:c?Array.from(L().subarray(Number(c)>>>0,Number(u)>>>0)):[],strides:m?Array.from(L().subarray(Number(m)>>>0,Number(p)>>>0)):[]})},903508:(e,t)=>{n.Ab("GlobalMaxPool",e,{format:t?"NHWC":"NCHW"})},903595:(e,t,a,r,s,i,o,l,d,c,u,m,p,h)=>{n.Ab("MaxPool",e,{format:h?"NHWC":"NCHW",auto_pad:t,ceil_mode:a,count_include_pad:r,storage_order:s,dilations:i?Array.from(L().subarray(Number(i)>>>0,Number(o)>>>0)):[],kernel_shape:l?Array.from(L().subarray(Number(l)>>>0,Number(d)>>>0)):[],pads:c?Array.from(L().subarray(Number(c)>>>0,Number(u)>>>0)):[],strides:m?Array.from(L().subarray(Number(m)>>>0,Number(p)>>>0)):[]})},904070:(e,t,a,r,s)=>{n.Ab("Gemm",e,{alpha:t,beta:a,transA:r,transB:s})},904174:e=>{n.Ab("MatMul",e,void 0)},904228:(e,t,a,r)=>{n.Ab("ArgMax",e,{keepDims:!!t,selectLastIndex:!!a,axis:r})},904336:(e,t,a,r)=>{n.Ab("ArgMin",e,{keepDims:!!t,selectLastIndex:!!a,axis:r})},904444:(e,t)=>{n.Ab("Softmax",e,{axis:t})},904507:(e,t)=>{n.Ab("Concat",e,{axis:t})},904567:(e,t,a,r,s)=>{n.Ab("Split",e,{axis:t,numOutputs:a,splitSizes:r?Array.from(L().subarray(Number(r)>>>0,Number(s)>>>0)):[]})},904723:e=>{n.Ab("Expand",e,void 0)},904777:(e,t)=>{n.Ab("Gather",e,{axis:Number(t)})},904848:(e,t)=>{n.Ab("GatherElements",e,{axis:Number(t)})},904927:(e,t)=>{n.Ab("GatherND",e,{batch_dims:Number(t)})},905006:(e,t,a,r,s,i,o,l,d,c,u)=>{n.Ab("Resize",e,{antialias:t,axes:a?Array.from(L().subarray(Number(a)>>>0,Number(r)>>>0)):[],coordinateTransformMode:Ne(s),cubicCoeffA:i,excludeOutside:o,extrapolationValue:l,keepAspectRatioPolicy:Ne(d),mode:Ne(c),nearestMode:Ne(u)})},905368:(e,t,a,r,s,i,o)=>{n.Ab("Slice",e,{starts:t?Array.from(L().subarray(Number(t)>>>0,Number(a)>>>0)):[],ends:r?Array.from(L().subarray(Number(r)>>>0,Number(s)>>>0)):[],axes:i?Array.from(L().subarray(Number(i)>>>0,Number(o)>>>0)):[]})},905632:e=>{n.Ab("Tile",e,void 0)},905684:(e,t,a)=>{n.Ab("InstanceNormalization",e,{epsilon:t,format:a?"NHWC":"NCHW"})},905798:(e,t,a)=>{n.Ab("InstanceNormalization",e,{epsilon:t,format:a?"NHWC":"NCHW"})},905912:e=>{n.Ab("Range",e,void 0)},905965:(e,t)=>{n.Ab("Einsum",e,{equation:Ne(t)})},906046:(e,t,a,r,s)=>{n.Ab("Pad",e,{mode:t,value:a,pads:r?Array.from(L().subarray(Number(r)>>>0,Number(s)>>>0)):[]})},906189:(e,t,a,r,s,i)=>{n.Ab("BatchNormalization",e,{epsilon:t,momentum:a,spatial:!!s,trainingMode:!!r,format:i?"NHWC":"NCHW"})},906358:(e,t,a,r,s,i)=>{n.Ab("BatchNormalization",e,{epsilon:t,momentum:a,spatial:!!s,trainingMode:!!r,format:i?"NHWC":"NCHW"})},906527:(e,t,a)=>{n.Ab("CumSum",e,{exclusive:Number(t),reverse:Number(a)})},906624:(e,t,a)=>{n.Ab("DequantizeLinear",e,{axis:t,blockSize:a})},906714:(e,t,a,r,s)=>{n.Ab("GridSample",e,{align_corners:t,mode:Ne(a),padding_mode:Ne(r),format:s?"NHWC":"NCHW"})},906884:(e,t,a,r,s)=>{n.Ab("GridSample",e,{align_corners:t,mode:Ne(a),padding_mode:Ne(r),format:s?"NHWC":"NCHW"})},907054:(e,t)=>{n.Ab("ScatterND",e,{reduction:Ne(t)})},907139:(e,t,a,r,s,i,o,l,d)=>{n.Ab("Attention",e,{numHeads:t,isUnidirectional:a,maskFilterValue:r,scale:s,doRotary:i,qkvHiddenSizes:o?Array.from(L().subarray(Number(l)>>>0,Number(l)+o>>>0)):[],pastPresentShareBuffer:!!d})},907411:e=>{n.Ab("BiasAdd",e,void 0)},907466:e=>{n.Ab("BiasSplitGelu",e,void 0)},907527:e=>{n.Ab("FastGelu",e,void 0)},907583:(e,t,a,r,s,i,o,l,d,c,u,m,p,h,f,x)=>{n.Ab("Conv",e,{format:m?"NHWC":"NCHW",auto_pad:t,dilations:a?Array.from(L().subarray(Number(a)>>>0,Number(r)>>>0)):[],group:s,kernel_shape:i?Array.from(L().subarray(Number(i)>>>0,Number(o)>>>0)):[],pads:l?Array.from(L().subarray(Number(l)>>>0,Number(d)>>>0)):[],strides:c?Array.from(L().subarray(Number(c)>>>0,Number(u)>>>0)):[],w_is_const:()=>!!V()[Number(p)>>>0],activation:Ne(h),activation_params:f?Array.from(W().subarray(Number(f)>>>0,Number(x)>>>0)):[]})},908167:e=>{n.Ab("Gelu",e,void 0)},908219:(e,t,a,r,s,i,o,l,d)=>{n.Ab("GroupQueryAttention",e,{numHeads:t,kvNumHeads:a,scale:r,softcap:s,doRotary:i,rotaryInterleaved:o,smoothSoftmax:l,localWindowSize:d})},908436:(e,t,a,r)=>{n.Ab("LayerNormalization",e,{axis:t,epsilon:a,simplified:!!r})},908547:(e,t,a,r)=>{n.Ab("LayerNormalization",e,{axis:t,epsilon:a,simplified:!!r})},908658:(e,t,a,r,s,i)=>{n.Ab("MatMulNBits",e,{k:t,n:a,accuracyLevel:r,bits:s,blockSize:i})},908785:(e,t,a,r,s,i)=>{n.Ab("MultiHeadAttention",e,{numHeads:t,isUnidirectional:a,maskFilterValue:r,scale:s,doRotary:i})},908944:(e,t)=>{n.Ab("QuickGelu",e,{alpha:t})},909008:(e,t,a,r,s)=>{n.Ab("RotaryEmbedding",e,{interleaved:!!t,numHeads:a,rotaryEmbeddingDim:r,scale:s})},909147:(e,t,a)=>{n.Ab("SkipLayerNormalization",e,{epsilon:t,simplified:!!a})},909249:(e,t,a)=>{n.Ab("SkipLayerNormalization",e,{epsilon:t,simplified:!!a})},909351:(e,t,a,r)=>{n.Ab("GatherBlockQuantized",e,{gatherAxis:t,quantizeAxis:a,blockSize:r})},909472:e=>{n.$b(e)},909506:(e,t)=>n.bc(Number(e),Number(t),n.Gb.ec,n.Gb.errors)};function nn(e,t,a){return Ut(async()=>{await n.Yb(Number(e),Number(t),Number(a))})}function rn(){return typeof wasmOffsetConverter<"u"}var sn=await async function(){function e(e,t){return sn=e.exports,sn=function(){var e=sn,t={};for(let[a,n]of Object.entries(e))t[a]="function"==typeof n?(...e)=>{Pt.push(a);try{return n(...e)}finally{O||(Pt.pop(),Rt&&1===Ot&&0===Pt.length&&(Ot=0,re+=1,It(Nn),typeof Fibers<"u"&&Fibers.sc()))}}:n;return t}(),a=sn,n=e=>t=>e(t)>>>0,r=e=>()=>e()>>>0,(a=Object.assign({},a)).Ea=n(a.Ea),a.gb=r(a.gb),a.ib=n(a.ib),a.tb=n(a.tb),a.ub=r(a.ub),a.__cxa_get_exception_ptr=n(a.__cxa_get_exception_ptr),sn=a,ue.push(sn.jb),b=t,Z(),sn;var a,n,r}X++;var t=J();if(n.instantiateWasm)return new Promise(a=>{n.instantiateWasm(t,(t,n)=>{a(e(t,n))})});if(o)return new Promise(t=>{z=a=>{var n=new WebAssembly.Instance(a,J());t(e(n,a))}});K??=n.locateFile?n.locateFile?n.locateFile("ort-wasm-simd-threaded.jsep.wasm",f):f+"ort-wasm-simd-threaded.jsep.wasm":new URL("/DEViLBOX/assets/ort-wasm-simd-threaded.jsep-BGTZ4Y7F.wasm",import.meta.url).href;try{var r=await async function(e){var t=K;if(!x&&"function"==typeof WebAssembly.instantiateStreaming&&!R(t))try{var a=fetch(t,{credentials:"same-origin"});return await WebAssembly.instantiateStreaming(a,e)}catch(n){I(`wasm streaming compile failed: ${n}`),I("falling back to ArrayBuffer instantiation")}return async function(e,t){try{var a=await async function(e){if(!x)try{var t=await u(e);return new Uint8Array(t)}catch{}if(e==K&&x)e=new Uint8Array(x);else{if(!m)throw"both async and sync fetching of the wasm failed";e=m(e)}return e}(e);return await WebAssembly.instantiate(a,t)}catch(n){I(`failed to asynchronously prepare wasm: ${n}`),Q(n)}}(t,e)}(t);return e(r.instance,r.module)}catch(s){return a(s),Promise.reject(s)}}(),on=e=>(on=sn.Ea)(e),ln=()=>(ln=sn.Fa)();n._OrtInit=(e,t)=>(n._OrtInit=sn.Ga)(e,t),n._OrtGetLastError=(e,t)=>(n._OrtGetLastError=sn.Ha)(e,t),n._OrtCreateSessionOptions=(e,t,a,r,s,i,o,l,d,c)=>(n._OrtCreateSessionOptions=sn.Ia)(e,t,a,r,s,i,o,l,d,c),n._OrtAppendExecutionProvider=(e,t,a,r,s)=>(n._OrtAppendExecutionProvider=sn.Ja)(e,t,a,r,s),n._OrtAddFreeDimensionOverride=(e,t,a)=>(n._OrtAddFreeDimensionOverride=sn.Ka)(e,t,a),n._OrtAddSessionConfigEntry=(e,t,a)=>(n._OrtAddSessionConfigEntry=sn.La)(e,t,a),n._OrtReleaseSessionOptions=e=>(n._OrtReleaseSessionOptions=sn.Ma)(e),n._OrtCreateSession=(e,t,a)=>(n._OrtCreateSession=sn.Na)(e,t,a),n._OrtReleaseSession=e=>(n._OrtReleaseSession=sn.Oa)(e),n._OrtGetInputOutputCount=(e,t,a)=>(n._OrtGetInputOutputCount=sn.Pa)(e,t,a),n._OrtGetInputOutputMetadata=(e,t,a,r)=>(n._OrtGetInputOutputMetadata=sn.Qa)(e,t,a,r),n._OrtFree=e=>(n._OrtFree=sn.Ra)(e),n._OrtCreateTensor=(e,t,a,r,s,i)=>(n._OrtCreateTensor=sn.Sa)(e,t,a,r,s,i),n._OrtGetTensorData=(e,t,a,r,s)=>(n._OrtGetTensorData=sn.Ta)(e,t,a,r,s),n._OrtReleaseTensor=e=>(n._OrtReleaseTensor=sn.Ua)(e),n._OrtCreateRunOptions=(e,t,a,r)=>(n._OrtCreateRunOptions=sn.Va)(e,t,a,r),n._OrtAddRunConfigEntry=(e,t,a)=>(n._OrtAddRunConfigEntry=sn.Wa)(e,t,a),n._OrtReleaseRunOptions=e=>(n._OrtReleaseRunOptions=sn.Xa)(e),n._OrtCreateBinding=e=>(n._OrtCreateBinding=sn.Ya)(e),n._OrtBindInput=(e,t,a)=>(n._OrtBindInput=sn.Za)(e,t,a),n._OrtBindOutput=(e,t,a,r)=>(n._OrtBindOutput=sn._a)(e,t,a,r),n._OrtClearBoundOutputs=e=>(n._OrtClearBoundOutputs=sn.$a)(e),n._OrtReleaseBinding=e=>(n._OrtReleaseBinding=sn.ab)(e),n._OrtRunWithBinding=(e,t,a,r,s)=>(n._OrtRunWithBinding=sn.bb)(e,t,a,r,s),n._OrtRun=(e,t,a,r,s,i,o,l)=>(n._OrtRun=sn.cb)(e,t,a,r,s,i,o,l),n._OrtEndProfiling=e=>(n._OrtEndProfiling=sn.db)(e),n._JsepOutput=(e,t,a)=>(n._JsepOutput=sn.eb)(e,t,a),n._JsepGetNodeName=e=>(n._JsepGetNodeName=sn.fb)(e);var dn=()=>(dn=sn.gb)(),cn=n._free=e=>(cn=n._free=sn.hb)(e),un=n._malloc=e=>(un=n._malloc=sn.ib)(e),mn=(e,t,a,n,r,s)=>(mn=sn.kb)(e,t,a,n,r,s),pn=()=>(pn=sn.lb)(),hn=(e,t,a,n,r)=>(hn=sn.mb)(e,t,a,n,r),fn=e=>(fn=sn.nb)(e),xn=e=>(xn=sn.ob)(e),gn=(e,t)=>(gn=sn.pb)(e,t),bn=()=>(bn=sn.qb)(),yn=(e,t)=>(yn=sn.rb)(e,t),vn=e=>(vn=sn.sb)(e),wn=e=>(wn=sn.tb)(e),jn=()=>(jn=sn.ub)(),_n=n.dynCall_ii=(e,t)=>(_n=n.dynCall_ii=sn.vb)(e,t);n.dynCall_vii=(e,t,a)=>(n.dynCall_vii=sn.dynCall_vii)(e,t,a),n.dynCall_iiiii=(e,t,a,r,s)=>(n.dynCall_iiiii=sn.dynCall_iiiii)(e,t,a,r,s),n.dynCall_iii=(e,t,a)=>(n.dynCall_iii=sn.dynCall_iii)(e,t,a),n.dynCall_iiiiii=(e,t,a,r,s,i)=>(n.dynCall_iiiiii=sn.dynCall_iiiiii)(e,t,a,r,s,i),n.dynCall_iiiiiiii=(e,t,a,r,s,i,o,l)=>(n.dynCall_iiiiiiii=sn.dynCall_iiiiiiii)(e,t,a,r,s,i,o,l),n.dynCall_iiiiiii=(e,t,a,r,s,i,o)=>(n.dynCall_iiiiiii=sn.dynCall_iiiiiii)(e,t,a,r,s,i,o),n.dynCall_vi=(e,t)=>(n.dynCall_vi=sn.dynCall_vi)(e,t),n.dynCall_iiii=(e,t,a,r)=>(n.dynCall_iiii=sn.dynCall_iiii)(e,t,a,r),n.dynCall_i=e=>(n.dynCall_i=sn.dynCall_i)(e),n.dynCall_viiiiiiii=(e,t,a,r,s,i,o,l,d)=>(n.dynCall_viiiiiiii=sn.dynCall_viiiiiiii)(e,t,a,r,s,i,o,l,d),n.dynCall_viii=(e,t,a,r)=>(n.dynCall_viii=sn.dynCall_viii)(e,t,a,r),n.dynCall_viijj=(e,t,a,r,s)=>(n.dynCall_viijj=sn.dynCall_viijj)(e,t,a,r,s),n.dynCall_viiiiii=(e,t,a,r,s,i,o)=>(n.dynCall_viiiiii=sn.dynCall_viiiiii)(e,t,a,r,s,i,o),n.dynCall_viiii=(e,t,a,r,s)=>(n.dynCall_viiii=sn.dynCall_viiii)(e,t,a,r,s),n.dynCall_viiiii=(e,t,a,r,s,i)=>(n.dynCall_viiiii=sn.dynCall_viiiii)(e,t,a,r,s,i),n.dynCall_vfiii=(e,t,a,r,s)=>(n.dynCall_vfiii=sn.dynCall_vfiii)(e,t,a,r,s),n.dynCall_viiiiff=(e,t,a,r,s,i,o)=>(n.dynCall_viiiiff=sn.dynCall_viiiiff)(e,t,a,r,s,i,o),n.dynCall_viiiiiff=(e,t,a,r,s,i,o,l)=>(n.dynCall_viiiiiff=sn.dynCall_viiiiiff)(e,t,a,r,s,i,o,l),n.dynCall_ffff=(e,t,a,r)=>(n.dynCall_ffff=sn.dynCall_ffff)(e,t,a,r),n.dynCall_viiff=(e,t,a,r,s)=>(n.dynCall_viiff=sn.dynCall_viiff)(e,t,a,r,s),n.dynCall_fffffff=(e,t,a,r,s,i,o)=>(n.dynCall_fffffff=sn.dynCall_fffffff)(e,t,a,r,s,i,o),n.dynCall_jjjjjjj=(e,t,a,r,s,i,o)=>(n.dynCall_jjjjjjj=sn.dynCall_jjjjjjj)(e,t,a,r,s,i,o),n.dynCall_jjjjjj=(e,t,a,r,s,i)=>(n.dynCall_jjjjjj=sn.dynCall_jjjjjj)(e,t,a,r,s,i),n.dynCall_iijjii=(e,t,a,r,s,i)=>(n.dynCall_iijjii=sn.dynCall_iijjii)(e,t,a,r,s,i),n.dynCall_viiiiiiiiiiiii=(e,t,a,r,s,i,o,l,d,c,u,m,p,h)=>(n.dynCall_viiiiiiiiiiiii=sn.dynCall_viiiiiiiiiiiii)(e,t,a,r,s,i,o,l,d,c,u,m,p,h),n.dynCall_viiiiiiiiii=(e,t,a,r,s,i,o,l,d,c,u)=>(n.dynCall_viiiiiiiiii=sn.dynCall_viiiiiiiiii)(e,t,a,r,s,i,o,l,d,c,u),n.dynCall_viiiiiiiiiii=(e,t,a,r,s,i,o,l,d,c,u,m)=>(n.dynCall_viiiiiiiiiii=sn.dynCall_viiiiiiiiiii)(e,t,a,r,s,i,o,l,d,c,u,m),n.dynCall_viiiiiiiiiiii=(e,t,a,r,s,i,o,l,d,c,u,m,p)=>(n.dynCall_viiiiiiiiiiii=sn.dynCall_viiiiiiiiiiii)(e,t,a,r,s,i,o,l,d,c,u,m,p),n.dynCall_viiiiiiiiiiiiiiiiii=(e,t,a,r,s,i,o,l,d,c,u,m,p,h,f,x,g,b,y)=>(n.dynCall_viiiiiiiiiiiiiiiiii=sn.dynCall_viiiiiiiiiiiiiiiiii)(e,t,a,r,s,i,o,l,d,c,u,m,p,h,f,x,g,b,y),n.dynCall_viiiiiiiii=(e,t,a,r,s,i,o,l,d,c)=>(n.dynCall_viiiiiiiii=sn.dynCall_viiiiiiiii)(e,t,a,r,s,i,o,l,d,c),n.dynCall_viiiiiiiiiiiiiiiiiii=(e,t,a,r,s,i,o,l,d,c,u,m,p,h,f,x,g,b,y,v)=>(n.dynCall_viiiiiiiiiiiiiiiiiii=sn.dynCall_viiiiiiiiiiiiiiiiiii)(e,t,a,r,s,i,o,l,d,c,u,m,p,h,f,x,g,b,y,v),n.dynCall_viiiiiii=(e,t,a,r,s,i,o,l)=>(n.dynCall_viiiiiii=sn.dynCall_viiiiiii)(e,t,a,r,s,i,o,l),n.dynCall_viiiiiiiiiiiiiii=(e,t,a,r,s,i,o,l,d,c,u,m,p,h,f,x)=>(n.dynCall_viiiiiiiiiiiiiii=sn.dynCall_viiiiiiiiiiiiiii)(e,t,a,r,s,i,o,l,d,c,u,m,p,h,f,x),n.dynCall_jiji=(e,t,a,r)=>(n.dynCall_jiji=sn.dynCall_jiji)(e,t,a,r),n.dynCall_v=e=>(n.dynCall_v=sn.dynCall_v)(e),n.dynCall_iidiiii=(e,t,a,r,s,i,o)=>(n.dynCall_iidiiii=sn.dynCall_iidiiii)(e,t,a,r,s,i,o),n.dynCall_iiiiiiiii=(e,t,a,r,s,i,o,l,d)=>(n.dynCall_iiiiiiiii=sn.dynCall_iiiiiiiii)(e,t,a,r,s,i,o,l,d),n.dynCall_iiij=(e,t,a,r)=>(n.dynCall_iiij=sn.dynCall_iiij)(e,t,a,r),n.dynCall_iiiiiiiiii=(e,t,a,r,s,i,o,l,d,c)=>(n.dynCall_iiiiiiiiii=sn.dynCall_iiiiiiiiii)(e,t,a,r,s,i,o,l,d,c),n.dynCall_iiiiiiiiiiiii=(e,t,a,r,s,i,o,l,d,c,u,m,p)=>(n.dynCall_iiiiiiiiiiiii=sn.dynCall_iiiiiiiiiiiii)(e,t,a,r,s,i,o,l,d,c,u,m,p),n.dynCall_iiiiiiiiiii=(e,t,a,r,s,i,o,l,d,c,u)=>(n.dynCall_iiiiiiiiiii=sn.dynCall_iiiiiiiiiii)(e,t,a,r,s,i,o,l,d,c,u),n.dynCall_ji=(e,t)=>(n.dynCall_ji=sn.dynCall_ji)(e,t),n.dynCall_iijii=(e,t,a,r,s)=>(n.dynCall_iijii=sn.dynCall_iijii)(e,t,a,r,s),n.dynCall_vij=(e,t,a)=>(n.dynCall_vij=sn.dynCall_vij)(e,t,a),n.dynCall_viiijii=(e,t,a,r,s,i,o)=>(n.dynCall_viiijii=sn.dynCall_viiijii)(e,t,a,r,s,i,o),n.dynCall_viijiiiiiiiiiiiiii=(e,t,a,r,s,i,o,l,d,c,u,m,p,h,f,x,g,b)=>(n.dynCall_viijiiiiiiiiiiiiii=sn.dynCall_viijiiiiiiiiiiiiii)(e,t,a,r,s,i,o,l,d,c,u,m,p,h,f,x,g,b),n.dynCall_viiiji=(e,t,a,r,s,i)=>(n.dynCall_viiiji=sn.dynCall_viiiji)(e,t,a,r,s,i),n.dynCall_fiii=(e,t,a,r)=>(n.dynCall_fiii=sn.dynCall_fiii)(e,t,a,r),n.dynCall_viijii=(e,t,a,r,s,i)=>(n.dynCall_viijii=sn.dynCall_viijii)(e,t,a,r,s,i),n.dynCall_viij=(e,t,a,r)=>(n.dynCall_viij=sn.dynCall_viij)(e,t,a,r),n.dynCall_jiij=(e,t,a,r)=>(n.dynCall_jiij=sn.dynCall_jiij)(e,t,a,r),n.dynCall_fi=(e,t)=>(n.dynCall_fi=sn.dynCall_fi)(e,t),n.dynCall_fii=(e,t,a)=>(n.dynCall_fii=sn.dynCall_fii)(e,t,a),n.dynCall_jii=(e,t,a)=>(n.dynCall_jii=sn.dynCall_jii)(e,t,a),n.dynCall_dii=(e,t,a)=>(n.dynCall_dii=sn.dynCall_dii)(e,t,a),n.dynCall_fiiii=(e,t,a,r,s)=>(n.dynCall_fiiii=sn.dynCall_fiiii)(e,t,a,r,s),n.dynCall_fif=(e,t,a)=>(n.dynCall_fif=sn.dynCall_fif)(e,t,a),n.dynCall_jfi=(e,t,a)=>(n.dynCall_jfi=sn.dynCall_jfi)(e,t,a),n.dynCall_viiiiiiiiiiiiii=(e,t,a,r,s,i,o,l,d,c,u,m,p,h,f)=>(n.dynCall_viiiiiiiiiiiiii=sn.dynCall_viiiiiiiiiiiiii)(e,t,a,r,s,i,o,l,d,c,u,m,p,h,f),n.dynCall_viiiiiiiiiiiiiiiiiiii=(e,t,a,r,s,i,o,l,d,c,u,m,p,h,f,x,g,b,y,v,w)=>(n.dynCall_viiiiiiiiiiiiiiiiiiii=sn.dynCall_viiiiiiiiiiiiiiiiiiii)(e,t,a,r,s,i,o,l,d,c,u,m,p,h,f,x,g,b,y,v,w),n.dynCall_viiiiiiiiiiiiiiii=(e,t,a,r,s,i,o,l,d,c,u,m,p,h,f,x,g)=>(n.dynCall_viiiiiiiiiiiiiiii=sn.dynCall_viiiiiiiiiiiiiiii)(e,t,a,r,s,i,o,l,d,c,u,m,p,h,f,x,g),n.dynCall_iif=(e,t,a)=>(n.dynCall_iif=sn.dynCall_iif)(e,t,a),n.dynCall_jiiii=(e,t,a,r,s)=>(n.dynCall_jiiii=sn.dynCall_jiiii)(e,t,a,r,s),n.dynCall_jiii=(e,t,a,r)=>(n.dynCall_jiii=sn.dynCall_jiii)(e,t,a,r),n.dynCall_viif=(e,t,a,r)=>(n.dynCall_viif=sn.dynCall_viif)(e,t,a,r),n.dynCall_viiij=(e,t,a,r,s)=>(n.dynCall_viiij=sn.dynCall_viiij)(e,t,a,r,s),n.dynCall_viiiijii=(e,t,a,r,s,i,o,l)=>(n.dynCall_viiiijii=sn.dynCall_viiiijii)(e,t,a,r,s,i,o,l),n.dynCall_iiiiij=(e,t,a,r,s,i)=>(n.dynCall_iiiiij=sn.dynCall_iiiiij)(e,t,a,r,s,i),n.dynCall_iiiiid=(e,t,a,r,s,i)=>(n.dynCall_iiiiid=sn.dynCall_iiiiid)(e,t,a,r,s,i),n.dynCall_iiiiijj=(e,t,a,r,s,i,o)=>(n.dynCall_iiiiijj=sn.dynCall_iiiiijj)(e,t,a,r,s,i,o),n.dynCall_iiiiiijj=(e,t,a,r,s,i,o,l)=>(n.dynCall_iiiiiijj=sn.dynCall_iiiiiijj)(e,t,a,r,s,i,o,l);var kn=e=>(kn=sn.wb)(e),Nn=()=>(Nn=sn.xb)(),$n=e=>($n=sn.yb)(e),Cn=()=>(Cn=sn.zb)();return function e(){if(0<X)Y=e;else if(o)t(n),G();else{for(;0<ae.length;)ae.shift()(n);0<X?Y=e:(n.calledRun=!0,O||(G(),t(n)))}}(),n.PTR_SIZE=4,r},gr=xr,br=globalThis.self?.name?.startsWith("em-pthread"),br&&xr()}),Jm=Ln(()=>{dr(),yr=typeof location>"u"?void 0:location.origin,vr=import.meta.url>"file:"&&import.meta.url<"file;",wr=()=>{if(vr){let e=URL;return new URL(new e("ort.bundle.min.mjs",import.meta.url).href,yr).href}return import.meta.url},jr=wr(),_r=()=>{if(jr&&!jr.startsWith("blob:"))return jr.substring(0,jr.lastIndexOf("/")+1)},kr=(e,t)=>{try{let a=t??jr;return(a?new URL(e,a):new URL(e)).origin===yr}catch{return!1}},Nr=(e,t)=>{let a=t??jr;try{return(a?new URL(e,a):new URL(e)).href}catch{return}},$r=(e,t)=>`${t??"./"}${e}`,Cr=async e=>{let t=await(await fetch(e,{credentials:"same-origin"})).blob();return URL.createObjectURL(t)},Sr=async e=>(await import(e)).default,Mr=(hr(),Wn(cr)).default,zr=async()=>{if(!jr)throw new Error("Failed to load proxy worker: cannot determine the script source URL.");if(kr(jr))return[void 0,Mr()];let e=await Cr(jr);return[e,Mr(e)]},Tr=(Qm(),Wn(fr)).default,Er=async(e,t,a,n)=>{let r=Tr&&!(e||t);if(r)if(jr)r=kr(jr);else{if(!n||a)throw new Error("cannot determine the script source URL.");r=!0}if(r)return[void 0,Tr];{let n="ort-wasm-simd-threaded.jsep.mjs",r=e??Nr(n,t),s=a&&r&&!kr(r,t),i=s?await Cr(r):r??$r(n,t);return[s?i:void 0,await Sr(i)]}}}),ep=Ln(()=>{Jm(),Ir=!1,Or=!1,Rr=!1,Vr=()=>{if(typeof SharedArrayBuffer>"u")return!1;try{return typeof MessageChannel<"u"&&(new MessageChannel).port1.postMessage(new SharedArrayBuffer(1)),WebAssembly.validate(new Uint8Array([0,97,115,109,1,0,0,0,1,4,1,96,0,0,3,2,1,0,5,4,1,3,1,1,10,11,1,9,0,65,0,254,16,2,0,26,11]))}catch{return!1}},Pr=()=>{try{return WebAssembly.validate(new Uint8Array([0,97,115,109,1,0,0,0,1,4,1,96,0,0,3,2,1,0,10,30,1,28,0,65,0,253,15,253,12,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,253,186,1,26,11]))}catch{return!1}},Dr=()=>{try{return WebAssembly.validate(new Uint8Array([0,97,115,109,1,0,0,0,1,5,1,96,0,1,123,3,2,1,0,10,19,1,17,0,65,1,253,15,65,2,253,15,65,3,253,15,253,147,2,11]))}catch{return!1}},Br=async e=>{if(Ir)return Promise.resolve();if(Or)throw new Error("multiple calls to 'initializeWebAssembly()' detected.");if(Rr)throw new Error("previous call to 'initializeWebAssembly()' failed.");Or=!0;let t=e.initTimeout,a=e.numThreads;if(!1!==e.simd)if("relaxed"===e.simd){if(!Dr())throw new Error("Relaxed WebAssembly SIMD is not supported in the current environment.")}else if(!Pr())throw new Error("WebAssembly SIMD is not supported in the current environment.");let n=Vr();a>1&&!n&&(typeof self<"u"&&self.crossOriginIsolated,e.numThreads=a=1);let r=e.wasmPaths,s="string"==typeof r?r:void 0,i=r?.mjs,o=i?.href??i,l=r?.wasm,d=l?.href??l,c=e.wasmBinary,[u,m]=await Er(o,s,a>1,!!c||!!d),p=!1,h=[];if(t>0&&h.push(new Promise(e=>{setTimeout(()=>{p=!0,e()},t)})),h.push(new Promise((e,t)=>{let n={numThreads:a};if(c)n.wasmBinary=c;else if(d||s)n.locateFile=e=>d??s+e;else if(o&&0!==o.indexOf("blob:"))n.locateFile=e=>new URL(e,o).href;else if(u){let e=_r();e&&(n.locateFile=t=>e+t)}m(n).then(t=>{Or=!1,Ir=!0,Ar=t,e(),u&&URL.revokeObjectURL(u)},e=>{Or=!1,Rr=!0,t(e)})})),await Promise.race(h),p)throw new Error(`WebAssembly backend initializing failed due to timeout: ${t}ms`)},Lr=()=>{if(Ir&&Ar)return Ar;throw new Error("WebAssembly is not initialized yet.")}}),tp=Ln(()=>{ep(),Fr=(e,t)=>{let a=Lr(),n=a.lengthBytesUTF8(e)+1,r=a._malloc(n);return a.stringToUTF8(e,r,n),t.push(r),r},Wr=(e,t,a,n)=>{if("object"==typeof e&&null!==e){if(a.has(e))throw new Error("Circular reference in options");a.add(e)}Object.entries(e).forEach(([e,r])=>{let s=t?t+e:e;if("object"==typeof r)Wr(r,s+".",a,n);else if("string"==typeof r||"number"==typeof r)n(s,r.toString());else{if("boolean"!=typeof r)throw new Error("Can't handle extra config type: "+typeof r);n(s,r?"1":"0")}})},Ur=e=>{let t=Lr(),a=t.stackSave();try{let a=t.PTR_SIZE,n=t.stackAlloc(2*a);t._OrtGetLastError(n,n+a);let r=Number(t.getValue(n,4===a?"i32":"i64")),s=t.getValue(n+a,"*"),i=s?t.UTF8ToString(s):"";throw new Error(`${e} ERROR_CODE: ${r}, ERROR_MESSAGE: ${i}`)}finally{t.stackRestore(a)}}}),ap=Ln(()=>{ep(),tp(),qr=e=>{let t=Lr(),a=0,n=[],r=e||{};try{if(void 0===e?.logSeverityLevel)r.logSeverityLevel=2;else if("number"!=typeof e.logSeverityLevel||!Number.isInteger(e.logSeverityLevel)||e.logSeverityLevel<0||e.logSeverityLevel>4)throw new Error(`log severity level is not valid: ${e.logSeverityLevel}`);if(void 0===e?.logVerbosityLevel)r.logVerbosityLevel=0;else if("number"!=typeof e.logVerbosityLevel||!Number.isInteger(e.logVerbosityLevel))throw new Error(`log verbosity level is not valid: ${e.logVerbosityLevel}`);void 0===e?.terminate&&(r.terminate=!1);let s=0;return void 0!==e?.tag&&(s=Fr(e.tag,n)),a=t._OrtCreateRunOptions(r.logSeverityLevel,r.logVerbosityLevel,!!r.terminate,s),0===a&&Ur("Can't create run options."),void 0!==e?.extra&&Wr(e.extra,"",new WeakSet,(e,r)=>{let s=Fr(e,n),i=Fr(r,n);0!==t._OrtAddRunConfigEntry(a,s,i)&&Ur(`Can't set a run config entry: ${e} - ${r}.`)}),[a,n]}catch(s){throw 0!==a&&t._OrtReleaseRunOptions(a),n.forEach(e=>t._free(e)),s}}}),np=Ln(()=>{ep(),tp(),Hr=e=>{switch(e){case"disabled":return 0;case"basic":return 1;case"extended":return 2;case"layout":return 3;case"all":return 99;default:throw new Error(`unsupported graph optimization level: ${e}`)}},Gr=e=>{switch(e){case"sequential":return 0;case"parallel":return 1;default:throw new Error(`unsupported execution mode: ${e}`)}},Kr=e=>{e.extra||(e.extra={}),e.extra.session||(e.extra.session={});let t=e.extra.session;t.use_ort_model_bytes_directly||(t.use_ort_model_bytes_directly="1"),e.executionProviders&&e.executionProviders.some(e=>"webgpu"===("string"==typeof e?e:e.name))&&(e.enableMemPattern=!1)},Xr=(e,t,a,n)=>{let r=Fr(t,n),s=Fr(a,n);0!==Lr()._OrtAddSessionConfigEntry(e,r,s)&&Ur(`Can't set a session config entry: ${t} - ${a}.`)},Yr=async(e,t,a)=>{for(let n of t){let t="string"==typeof n?n:n.name,r=[];switch(t){case"webnn":if(t="WEBNN","string"!=typeof n){let t=n?.deviceType;t&&Xr(e,"deviceType",t,a)}break;case"webgpu":if(t="JS","string"!=typeof n){let t=n;if(t?.preferredLayout){if("NCHW"!==t.preferredLayout&&"NHWC"!==t.preferredLayout)throw new Error(`preferredLayout must be either 'NCHW' or 'NHWC': ${t.preferredLayout}`);Xr(e,"preferredLayout",t.preferredLayout,a)}}break;case"wasm":case"cpu":continue;default:throw new Error(`not supported execution provider: ${t}`)}let s=Fr(t,a),i=r.length,o=0,l=0;if(i>0){o=Lr()._malloc(i*Lr().PTR_SIZE),a.push(o),l=Lr()._malloc(i*Lr().PTR_SIZE),a.push(l);for(let e=0;e<i;e++)Lr().setValue(o+e*Lr().PTR_SIZE,r[e][0],"*"),Lr().setValue(l+e*Lr().PTR_SIZE,r[e][1],"*")}0!==await Lr()._OrtAppendExecutionProvider(e,s,o,l,i)&&Ur(`Can't append execution provider: ${t}.`)}},Zr=async e=>{let t=Lr(),a=0,n=[],r=e||{};Kr(r);try{let e=Hr(r.graphOptimizationLevel??"all"),s=Gr(r.executionMode??"sequential"),i="string"==typeof r.logId?Fr(r.logId,n):0,o=r.logSeverityLevel??2;if(!Number.isInteger(o)||o<0||o>4)throw new Error(`log severity level is not valid: ${o}`);let l=r.logVerbosityLevel??0;if(!Number.isInteger(l)||l<0||l>4)throw new Error(`log verbosity level is not valid: ${l}`);let d="string"==typeof r.optimizedModelFilePath?Fr(r.optimizedModelFilePath,n):0;if(a=t._OrtCreateSessionOptions(e,!!r.enableCpuMemArena,!!r.enableMemPattern,s,!!r.enableProfiling,0,i,o,l,d),0===a&&Ur("Can't create session options."),r.executionProviders&&await Yr(a,r.executionProviders,n),void 0!==r.enableGraphCapture){if("boolean"!=typeof r.enableGraphCapture)throw new Error(`enableGraphCapture must be a boolean value: ${r.enableGraphCapture}`);Xr(a,"enableGraphCapture",r.enableGraphCapture.toString(),n)}if(r.freeDimensionOverrides)for(let[c,u]of Object.entries(r.freeDimensionOverrides)){if("string"!=typeof c)throw new Error(`free dimension override name must be a string: ${c}`);if("number"!=typeof u||!Number.isInteger(u)||u<0)throw new Error(`free dimension override value must be a non-negative integer: ${u}`);let e=Fr(c,n);0!==t._OrtAddFreeDimensionOverride(a,e,u)&&Ur(`Can't set a free dimension override: ${c} - ${u}.`)}return void 0!==r.extra&&Wr(r.extra,"",new WeakSet,(e,t)=>{Xr(a,e,t,n)}),[a,n]}catch(s){throw 0!==a&&0!==t._OrtReleaseSessionOptions(a)&&Ur("Can't release session options."),n.forEach(e=>t._free(e)),s}}}),rp=Ln(()=>{Qr=e=>{switch(e){case"int8":return 3;case"uint8":return 2;case"bool":return 9;case"int16":return 5;case"uint16":return 4;case"int32":return 6;case"uint32":return 12;case"float16":return 10;case"float32":return 1;case"float64":return 11;case"string":return 8;case"int64":return 7;case"uint64":return 13;case"int4":return 22;case"uint4":return 21;default:throw new Error(`unsupported data type: ${e}`)}},Jr=e=>{switch(e){case 3:return"int8";case 2:return"uint8";case 9:return"bool";case 5:return"int16";case 4:return"uint16";case 6:return"int32";case 12:return"uint32";case 10:return"float16";case 1:return"float32";case 11:return"float64";case 8:return"string";case 7:return"int64";case 13:return"uint64";case 22:return"int4";case 21:return"uint4";default:throw new Error(`unsupported data type: ${e}`)}},es=(e,t)=>{let a=[-1,4,1,1,2,2,4,8,-1,1,2,8,4,8,-1,-1,-1,-1,-1,-1,-1,.5,.5][e],n="number"==typeof t?t:t.reduce((e,t)=>e*t,1);return a>0?Math.ceil(n*a):void 0},ts=e=>{switch(e){case"float16":return typeof Float16Array<"u"&&Float16Array.from?Float16Array:Uint16Array;case"float32":return Float32Array;case"uint8":case"bool":return Uint8Array;case"int8":return Int8Array;case"uint16":return Uint16Array;case"int16":return Int16Array;case"int32":return Int32Array;case"float64":return Float64Array;case"uint32":return Uint32Array;case"int64":return BigInt64Array;case"uint64":return BigUint64Array;default:throw new Error(`unsupported type: ${e}`)}},as=e=>{switch(e){case"verbose":return 0;case"info":return 1;case"warning":return 2;case"error":return 3;case"fatal":return 4;default:throw new Error(`unsupported logging level: ${e}`)}},ns=e=>"float32"===e||"float16"===e||"int32"===e||"int64"===e||"uint32"===e||"uint8"===e||"bool"===e||"uint4"===e||"int4"===e,rs=e=>"float32"===e||"float16"===e||"int32"===e||"int64"===e||"uint32"===e||"uint64"===e||"int8"===e||"uint8"===e||"bool"===e||"uint4"===e||"int4"===e,ss=e=>{switch(e){case"none":return 0;case"cpu":return 1;case"cpu-pinned":return 2;case"texture":return 3;case"gpu-buffer":return 4;case"ml-tensor":return 5;default:throw new Error(`unsupported data location: ${e}`)}}}),sp=Ln(()=>{dr(),is=async e=>{if("string"==typeof e){let a=await fetch(e);if(!a.ok)throw new Error(`failed to load external data file: ${e}`);let n=a.headers.get("Content-Length"),r=n?parseInt(n,10):0;if(r<1073741824)return new Uint8Array(await a.arrayBuffer());{if(!a.body)throw new Error(`failed to load external data file: ${e}, no response body.`);let n,s=a.body.getReader();try{n=new ArrayBuffer(r)}catch(t){if(!(t instanceof RangeError))throw t;{let e=Math.ceil(r/65536);n=new WebAssembly.Memory({initial:e,maximum:e}).buffer}}let i=0;for(;;){let{done:e,value:t}=await s.read();if(e)break;let a=t.byteLength;new Uint8Array(n,i,a).set(t),i+=a}return new Uint8Array(n,0,r)}}return e instanceof Blob?new Uint8Array(await e.arrayBuffer()):e instanceof Uint8Array?e:new Uint8Array(e)}}),ip=Ln(()=>{rp(),ds=(e,t)=>{os=e,ls=t},cs=(e,t)=>{let a=as(e);a>=as(os)&&"function"==typeof t&&t()},us=(...e)=>{ls&&cs(...e)}}),op=Ln(()=>{ms=class{static calcMatMulShape(e,t){return e[1]!==t[0]?void 0:[e[0],t[1]]}},ps=class{static calcShape(e,t,a=!1){let n=e.length,r=t.length;if(0===n)return t;if(0===r)return e;let s=Math.max(e.length,t.length),i=new Array(s);if(a){if(n<2||r<2)return;let a=ms.calcMatMulShape([e[n-2],e[n-1]],[t[r-2],t[r-1]]);if(void 0===a)return;[i[s-2],i[s-1]]=a}for(let o=a?3:1;o<=s;o++){let a=n-o<0?1:e[n-o],l=r-o<0?1:t[r-o];if(a!==l&&a>1&&l>1)return;let d=Math.max(a,l);if(a&&l)i[s-o]=Math.max(a,l);else{if(d>1)return;i[s-o]=0}}return i}static isValidBroadcast(e,t){let a=e.length,n=t.length;if(a>n)return!1;for(let r=1;r<=a;r++)if(1!==e[a-r]&&e[a-r]!==t[n-r])return!1;return!0}},hs=class e{static size(t){return e.getSizeFromDimensionRange(t,0,t.length)}static convertShape(e,t=4){let a=e.length;if(0===a)return[];let n=new Array(a),r=a-1;for(;r>=0;){if(e[r]%t===0){n[r]=e[r]/t;break}if(t%e[r]!==0)throw new Error("cannot convert shape");n[r]=1,t/=e[r],r--}for(r--;r>=0;r--)n[r]=e[r];return n}static sizeFromDimension(t,a){if(a<0||a>t.length)throw new Error(`invalid dimension of ${a} for sizeFromDimension as Tensor has ${t.length} dimensions.`);return e.getSizeFromDimensionRange(t,a,t.length)}static sizeToDimension(t,a){if(a<0||a>t.length)throw new Error(`invalid dimension of ${a} for sizeToDimension as Tensor has ${t.length} dimensions.`);return e.getSizeFromDimensionRange(t,0,a)}static getSizeFromDimensionRange(e,t,a){let n=1;for(let r=t;r<a;r++){if(e[r]<0)throw new Error("cannot get valid size from specified dimension range. Most likely the range contains negative values in them.");n*=Number(e[r])}return n}static computeStrides(e){let t=e.length;if(0===t)return[];if(1===t)return[1];let a=new Array(t);a[t-1]=1,a[t-2]=e[t-1];for(let n=t-3;n>=0;--n)a[n]=a[n+1]*e[n+1];return a}static normalizeAxis(e,t){if(e<-t&&e>=t)throw new Error("unsupported axis for this operation.");return e<0?e+t:e}static normalizeAxes(e,t){return e.map(a=>this.normalizeAxis(a,t??e.length))}static sortBasedOnPerm(e,t){return t?t.map(t=>e[t]):e.slice().reverse()}static padShape(e,t){let a=e.length;return e.map((e,n)=>e+t[n]+t[n+a])}static areEqual(e,t){return e.length===t.length&&e.every((e,a)=>e===t[a])}},fs=class e{static adjustPoolAttributes(e,t,a,n,r,s){if(!e&&a.length!==t.length-2)throw new Error("length of specified kernel shapes should be 2 less than length of input dimensions");if(e)for(let i=0;i<t.length-2;i++)i>=a.length?a.push(t[i+2]):a[i]=t[i+2];for(let i=0;i<a.length;i++)if(i<n.length){if(n[i]<0)throw new Error("strides should be greater than or equal to 1")}else n.push(1);for(let i=0;i<a.length;i++)if(i<r.length){if(r[i]<0)throw new Error("dilations should be greater than or equal to 1")}else r.push(1);for(let i=0;i<2*a.length;i++)if(i<s.length){if(s[i]<0)throw new Error("pad should be greater than or equal to 1")}else s.push(0);for(let i=0;i<a.length;i++){if(a[i]<=0)throw new Error("kernel shapes need to be greater than 0");if(s[i]>=a[i]||s[i+a.length]>=a[i])throw new Error("pads should be smaller than kernel")}}static adjustPadsBasedOnAutoPad(t,a,n,r,s,i,o){if(o){if(s.length!==2*(t.length-2))throw new Error("length of pads should be twice the length of data dimensions");if(a.length!==t.length-2)throw new Error("length of strides should be the length of data dimensions");if(r.length!==t.length-2)throw new Error("length of kernel shapes should be the length of data dimensions");for(let l=0;l<t.length-2;l++)e.adjustPadAndReturnShape(t[l+(i?1:2)],a[l],n[l],r[l],s,l,l+t.length-2,o)}}static computePoolOutputShape(t,a,n,r,s,i,o){if(a.length<=0)throw new Error("input shape must be of size greater than 0");let l=[a[0],a[1]];return e.computeShapeHelper(t,a,l,n,r,s,i,o),l}static computeConvOutputShape(t,a,n,r,s,i,o){if(t.length<=0||a.length<=0)throw new Error("invalid input tensor dims or invalid filter tensor dims");let l=[t[0],a[0]];return e.computeShapeHelper(!1,t,l,n,r,s,i,o),l}static computeShapeHelper(t,a,n,r,s,i,o,l){if(t)for(let e=0;e<a.length-2;e++)n.push(1);else for(let d=0;d<a.length-2;d++)n.push(e.adjustPadAndReturnShape(a[d+2],r[d],s[d],i[d],o,d,d+a.length-2,l))}static adjustPadAndReturnShape(e,t,a,n,r,s,i,o){let l=a*(n-1)+1;if(!o||"NOTSET"===o)return Math.floor((e+r[s]+r[i]-l)/t+1);switch(o){case"VALID":return r[s]=0,r[i]=0,Math.floor((e-l)/t+1);case"SAME_LOWER":case"SAME_UPPER":if(1!==a)throw new Error("Dilation not supported for SAME_UPPER or SAME_LOWER");{let a=((e+t-1)/t-1)*t+n-e;return r[s]=Math.floor("SAME_LOWER"===o?(a+1)/2:a/2),r[i]=a-r[s],Math.floor((e+a-n)/t+1)}default:throw new Error("Unsupported AutoPad type")}}},xs=class{static getShapeOfGemmResult(e,t,a,n,r){if(2!==e.length||2!==a.length)throw new Error("shape need to be of size 2");let s,i,o;t?(s=e[1],i=e[0]):(s=e[0],i=e[1]);let l=-1;if(n?(o=a[0],l=1):(o=a[1],l=0),a[l]!==i)throw new Error("dimension mismatch");if(s<=0||o<=0||i<=0)throw new Error("invalid shape specified");if(r&&!ps.isValidBroadcast(r,[s,o]))throw new Error("gemm: invalid bias shape for broadcast");return[s,o,i]}},gs=-34028234663852886e22,bs=34028234663852886e22}),lp=Ln(()=>{rp(),ys=(e,t)=>new(ts(t))(e)}),dp=Ln(()=>{rp(),ip(),vs=new Map([["float32",32],["float16",16],["int32",32],["uint32",32],["int64",64],["uint64",64],["int8",8],["uint8",8],["int4",4],["uint4",4]]),ws=(e,t)=>{if("int32"===t)return e;let a=vs.get(t);if(!a)throw new Error(`WebNN backend does not support data type: ${t}`);let n=a/8;if(e.byteLength%n!==0)throw new Error(`Invalid Uint8Array length - must be a multiple of ${n}.`);let r=e.byteLength/n,s=new(ts(t))(e.buffer,e.byteOffset,r);switch(t){case"int64":case"uint64":{let e=new Int32Array(r);for(let t=0;t<r;t++){let a=s[t];if(a>2147483647n||a<-2147483648n)throw new Error("Can not convert int64 data to int32 - value out of range.");e[t]=Number(a)}return new Uint8Array(e.buffer)}case"int8":case"uint8":case"uint32":{if("uint32"===t&&s.some(e=>e>2147483647))throw new Error("Can not convert uint32 data to int32 - value out of range.");let e=Int32Array.from(s,Number);return new Uint8Array(e.buffer)}default:throw new Error(`Unsupported data conversion from ${t} to 'int32'`)}},js=(e,t)=>{if("int32"===t)return e;if(e.byteLength%4!=0)throw new Error("Invalid Uint8Array length - must be a multiple of 4 (int32).");let a=e.byteLength/4,n=new Int32Array(e.buffer,e.byteOffset,a);switch(t){case"int64":{let e=BigInt64Array.from(n,BigInt);return new Uint8Array(e.buffer)}case"uint64":{if(n.some(e=>e<0))throw new Error("Can not convert int32 data to uin64 - negative value found.");let e=BigUint64Array.from(n,BigInt);return new Uint8Array(e.buffer)}case"int8":{if(n.some(e=>e<-128||e>127))throw new Error("Can not convert int32 data to int8 - value out of range.");let e=Int8Array.from(n,Number);return new Uint8Array(e.buffer)}case"uint8":if(n.some(e=>e<0||e>255))throw new Error("Can not convert int32 data to uint8 - value out of range.");return Uint8Array.from(n,Number);case"uint32":{if(n.some(e=>e<0))throw new Error("Can not convert int32 data to uint32 - negative value found.");let e=Uint32Array.from(n,Number);return new Uint8Array(e.buffer)}default:throw new Error(`Unsupported data conversion from 'int32' to ${t}`)}},_s=1,ks=()=>_s++,Ns=new Map([["int8","int32"],["uint8","int32"],["uint32","int32"],["int64","int32"]]),$s=(e,t)=>{let a=vs.get(e);if(!a)throw new Error(`WebNN backend does not support data type: ${e}`);return t.length>0?Math.ceil(t.reduce((e,t)=>e*t)*a/8):0},Cs=class{constructor(e){this.isDataConverted=!1;let{sessionId:t,context:a,tensor:n,dataType:r,shape:s,fallbackDataType:i}=e;this.sessionId=t,this.mlContext=a,this.mlTensor=n,this.dataType=r,this.tensorShape=s,this.fallbackDataType=i}get tensor(){return this.mlTensor}get type(){return this.dataType}get fallbackType(){return this.fallbackDataType}get shape(){return this.tensorShape}get byteLength(){return $s(this.dataType,this.tensorShape)}destroy(){us("verbose",()=>"[WebNN] TensorWrapper.destroy"),this.mlTensor.destroy()}write(e){this.mlContext.writeTensor(this.mlTensor,e)}async read(e){if(this.fallbackDataType){let t=await this.mlContext.readTensor(this.mlTensor),a=js(new Uint8Array(t),this.dataType);return e?void(e instanceof ArrayBuffer?new Uint8Array(e):new Uint8Array(e.buffer,e.byteOffset,e.byteLength)).set(a):a.buffer}return e?this.mlContext.readTensor(this.mlTensor,e):this.mlContext.readTensor(this.mlTensor)}canReuseTensor(e,t,a){return this.mlContext===e&&this.dataType===t&&this.tensorShape.length===a.length&&this.tensorShape.every((e,t)=>e===a[t])}setIsDataConverted(e){this.isDataConverted=e}},Ss=class{constructor(e,t){this.tensorManager=e,this.wrapper=t}get tensorWrapper(){return this.wrapper}releaseTensor(){this.tensorWrapper&&(this.tensorManager.releaseTensor(this.tensorWrapper),this.wrapper=void 0)}async ensureTensor(e,t,a,n){let r,s=this.tensorManager.getMLContext(e);if(!s.opSupportLimits().input.dataTypes.includes(t)){if(r=Ns.get(t),!r||!s.opSupportLimits().input.dataTypes.includes(r))throw new Error(`WebNN backend does not support data type: ${t}`);us("verbose",()=>`[WebNN] TensorIdTracker.ensureTensor: fallback dataType from ${t} to ${r}`)}if(this.wrapper){if(this.wrapper.canReuseTensor(s,t,a))return this.wrapper.tensor;if(n){if(this.wrapper.byteLength!==$s(t,a))throw new Error("Unable to copy data to tensor with different size.");this.activeUpload=new Uint8Array(await this.wrapper.read())}this.tensorManager.releaseTensor(this.wrapper)}let i=typeof MLTensorUsage>"u"?void 0:MLTensorUsage.READ|MLTensorUsage.WRITE;return this.wrapper=await this.tensorManager.getCachedTensor(e,t,a,i,!0,!0,r),n&&this.activeUpload&&(this.wrapper.write(this.activeUpload),this.activeUpload=void 0),this.wrapper.tensor}upload(e){let t=e;if(this.wrapper){if(this.wrapper.fallbackType){if("int32"!==this.wrapper.fallbackType)throw new Error(`Unsupported fallback data type: ${this.wrapper.fallbackType}`);t=ws(e,this.wrapper.type),this.wrapper.setIsDataConverted(!0)}if(e.byteLength===this.wrapper.byteLength)return void this.wrapper.write(t);us("verbose",()=>"Data size does not match tensor size. Releasing tensor."),this.releaseTensor()}this.activeUpload?this.activeUpload.set(t):this.activeUpload=new Uint8Array(t)}async download(e){if(this.activeUpload){let t=this.wrapper?.isDataConverted?js(this.activeUpload,this.wrapper?.type):this.activeUpload;return e?void(e instanceof ArrayBuffer?new Uint8Array(e).set(t):new Uint8Array(e.buffer,e.byteOffset,e.byteLength).set(t)):t.buffer}if(!this.wrapper)throw new Error("Tensor has not been created.");return e?this.wrapper.read(e):this.wrapper.read()}},Ms=class{constructor(e){this.backend=e,this.tensorTrackersById=new Map,this.freeTensors=[],this.externalTensors=new Set}getMLContext(e){let t=this.backend.getMLContext(e);if(!t)throw new Error("MLContext not found for session.");return t}reserveTensorId(){let e=ks();return this.tensorTrackersById.set(e,new Ss(this)),e}releaseTensorId(e){let t=this.tensorTrackersById.get(e);t&&(this.tensorTrackersById.delete(e),t.tensorWrapper&&this.releaseTensor(t.tensorWrapper))}async ensureTensor(e,t,a,n,r){us("verbose",()=>`[WebNN] TensorManager.ensureTensor {tensorId: ${t}, dataType: ${a}, shape: ${n}, copyOld: ${r}}`);let s=this.tensorTrackersById.get(t);if(!s)throw new Error("Tensor not found.");return s.ensureTensor(e,a,n,r)}upload(e,t){let a=this.tensorTrackersById.get(e);if(!a)throw new Error("Tensor not found.");a.upload(t)}async download(e,t){us("verbose",()=>`[WebNN] TensorManager.download {tensorId: ${e}, dstBuffer: ${t?.byteLength}}`);let a=this.tensorTrackersById.get(e);if(!a)throw new Error("Tensor not found.");return a.download(t)}releaseTensorsForSession(e){for(let t of this.freeTensors)t.sessionId===e&&t.destroy();this.freeTensors=this.freeTensors.filter(t=>t.sessionId!==e)}registerTensor(e,t,a,n){let r=this.getMLContext(e),s=ks(),i=new Cs({sessionId:e,context:r,tensor:t,dataType:a,shape:n});return this.tensorTrackersById.set(s,new Ss(this,i)),this.externalTensors.add(i),s}async getCachedTensor(e,t,a,n,r,s,i){let o=this.getMLContext(e);for(let[d,c]of this.freeTensors.entries())if(c.canReuseTensor(o,t,a)){us("verbose",()=>`[WebNN] Reusing tensor {dataType: ${t}, ${i?`fallbackDataType: ${i},`:""} shape: ${a}`);let n=this.freeTensors.splice(d,1)[0];return n.sessionId=e,n}us("verbose",()=>`[WebNN] MLContext.createTensor {dataType: ${t}, ${i?`fallbackDataType: ${i},`:""} shape: ${a}}`);let l=await o.createTensor({dataType:i??t,shape:a,dimensions:a,usage:n,writable:r,readable:s});return new Cs({sessionId:e,context:o,tensor:l,dataType:t,shape:a,fallbackDataType:i})}releaseTensor(e){this.externalTensors.has(e)&&this.externalTensors.delete(e),this.freeTensors.push(e)}},zs=(...e)=>new Ms(...e)}),cp=Ln(()=>{rp(),ep(),lp(),dp(),ip(),Ts=new Map([[1,"float32"],[10,"float16"],[6,"int32"],[12,"uint32"],[7,"int64"],[13,"uint64"],[22,"int4"],[21,"uint4"],[3,"int8"],[2,"uint8"],[9,"uint8"]]),Es=(e,t)=>{if(e===t)return!0;if(void 0===e||void 0===t)return!1;let a=Object.keys(e).sort(),n=Object.keys(t).sort();return a.length===n.length&&a.every((a,r)=>a===n[r]&&e[a]===t[a])},As=class{constructor(e){this.tensorManager=zs(this),this.mlContextBySessionId=new Map,this.sessionIdsByMLContext=new Map,this.mlContextCache=[],this.sessionGraphInputs=new Map,this.sessionGraphOutputs=new Map,this.temporaryGraphInputs=[],this.temporaryGraphOutputs=[],this.temporarySessionTensorIds=new Map,ds(e.logLevel,!!e.debug)}get currentSessionId(){if(void 0===this.activeSessionId)throw new Error("No active session");return this.activeSessionId}onRunStart(e){us("verbose",()=>`[WebNN] onRunStart {sessionId: ${e}}`),this.activeSessionId=e}onRunEnd(e){us("verbose",()=>`[WebNN] onRunEnd {sessionId: ${e}}`);let t=this.temporarySessionTensorIds.get(e);if(t){for(let e of t)us("verbose",()=>`[WebNN] releasing temporary tensor {tensorId: ${e}}`),this.tensorManager.releaseTensorId(e);this.temporarySessionTensorIds.delete(e),this.activeSessionId=void 0}}async createMLContext(e){if(e instanceof GPUDevice){let t=this.mlContextCache.findIndex(t=>t.gpuDevice===e);if(-1!==t)return this.mlContextCache[t].mlContext;{let t=await navigator.ml.createContext(e);return this.mlContextCache.push({gpuDevice:e,mlContext:t}),t}}if(void 0===e){let e=this.mlContextCache.findIndex(e=>void 0===e.options&&void 0===e.gpuDevice);if(-1!==e)return this.mlContextCache[e].mlContext;{let e=await navigator.ml.createContext();return this.mlContextCache.push({mlContext:e}),e}}let t=this.mlContextCache.findIndex(t=>Es(t.options,e));if(-1!==t)return this.mlContextCache[t].mlContext;{let t=await navigator.ml.createContext(e);return this.mlContextCache.push({options:e,mlContext:t}),t}}registerMLContext(e,t){this.mlContextBySessionId.set(e,t);let a=this.sessionIdsByMLContext.get(t);a||(a=new Set,this.sessionIdsByMLContext.set(t,a)),a.add(e),this.temporaryGraphInputs.length>0&&(this.sessionGraphInputs.set(e,this.temporaryGraphInputs),this.temporaryGraphInputs=[]),this.temporaryGraphOutputs.length>0&&(this.sessionGraphOutputs.set(e,this.temporaryGraphOutputs),this.temporaryGraphOutputs=[])}onReleaseSession(e){this.sessionGraphInputs.delete(e),this.sessionGraphOutputs.delete(e);let t=this.mlContextBySessionId.get(e);if(!t)return;this.tensorManager.releaseTensorsForSession(e),this.mlContextBySessionId.delete(e);let a=this.sessionIdsByMLContext.get(t);if(a.delete(e),0===a.size){this.sessionIdsByMLContext.delete(t);let e=this.mlContextCache.findIndex(e=>e.mlContext===t);-1!==e&&this.mlContextCache.splice(e,1)}}getMLContext(e){return this.mlContextBySessionId.get(e)}reserveTensorId(){return this.tensorManager.reserveTensorId()}releaseTensorId(e){us("verbose",()=>`[WebNN] releaseTensorId {tensorId: ${e}}`),this.tensorManager.releaseTensorId(e)}async ensureTensor(e,t,a,n,r){let s=Ts.get(a);if(!s)throw new Error(`Unsupported ONNX data type: ${a}`);return this.tensorManager.ensureTensor(e??this.currentSessionId,t,s,n,r)}async createTemporaryTensor(e,t,a){us("verbose",()=>`[WebNN] createTemporaryTensor {onnxDataType: ${t}, shape: ${a}}`);let n=Ts.get(t);if(!n)throw new Error(`Unsupported ONNX data type: ${t}`);let r=this.tensorManager.reserveTensorId();await this.tensorManager.ensureTensor(e,r,n,a,!1);let s=this.temporarySessionTensorIds.get(e);return s?s.push(r):this.temporarySessionTensorIds.set(e,[r]),r}uploadTensor(e,t){if(!Lr().shouldTransferToMLTensor)throw new Error("Trying to upload to a MLTensor while shouldTransferToMLTensor is false");us("verbose",()=>`[WebNN] uploadTensor {tensorId: ${e}, data: ${t.byteLength}}`),this.tensorManager.upload(e,t)}async downloadTensor(e,t){return this.tensorManager.download(e,t)}createMLTensorDownloader(e,t){return async()=>{let a=await this.tensorManager.download(e);return ys(a,t)}}registerMLTensor(e,t,a,n){let r=Ts.get(a);if(!r)throw new Error(`Unsupported ONNX data type: ${a}`);let s=this.tensorManager.registerTensor(e,t,r,n);return us("verbose",()=>`[WebNN] registerMLTensor {tensor: ${t}, dataType: ${r}, dimensions: ${n}} -> {tensorId: ${s}}`),s}registerMLConstant(e,t,a,n,r,s,i=!1){if(!s)throw new Error("External mounted files are not available.");let o=e;e.startsWith("./")&&(o=e.substring(2));let l=s.get(o);if(!l)throw new Error(`File with name ${o} not found in preloaded files.`);if(t+a>l.byteLength)throw new Error("Out of bounds: data offset and length exceed the external file data size.");let d,c=l.slice(t,t+a).buffer;switch(r.dataType){case"float32":d=new Float32Array(c);break;case"float16":d=typeof Float16Array<"u"&&Float16Array.from?new Float16Array(c):new Uint16Array(c);break;case"int32":d=new Int32Array(c);break;case"uint32":d=new Uint32Array(c);break;case"int64":if(i){let e=ws(new Uint8Array(c),"int64");d=new Int32Array(e.buffer),r.dataType="int32"}else d=new BigInt64Array(c);break;case"uint64":d=new BigUint64Array(c);break;case"int8":d=new Int8Array(c);break;case"int4":case"uint4":case"uint8":d=new Uint8Array(c);break;default:throw new Error(`Unsupported data type: ${r.dataType} in creating WebNN Constant from external data.`)}return us("verbose",()=>`[WebNN] registerMLConstant {dataType: ${r.dataType}, shape: ${r.shape}}} ${i?"(Note: it was int64 data type and registered to int32 as workaround)":""}`),n.constant(r,d)}registerGraphInput(e){this.temporaryGraphInputs.push(e)}registerGraphOutput(e){this.temporaryGraphOutputs.push(e)}isGraphInput(e,t){let a=this.sessionGraphInputs.get(e);return!!a&&a.includes(t)}isGraphOutput(e,t){let a=this.sessionGraphOutputs.get(e);return!!a&&a.includes(t)}isGraphInputOutputTypeSupported(e,t,a=!0){let n=this.mlContextBySessionId.get(e),r=Ts.get(Qr(t));return!(typeof r>"u")&&(a?!!n?.opSupportLimits().input.dataTypes.includes(r):!!n?.opSupportLimits().output.dataTypes.includes(r))}flush(){}}}),up=Ln(()=>{}),mp=Ln(()=>{ip(),up(),Is=new Map([[64,250],[128,200],[256,200],[512,200],[2048,230],[4096,200],[8192,50],[16384,50],[32768,50],[65536,50],[131072,50],[262144,50],[524288,50],[1048576,50],[2097152,30],[4194304,20],[8388608,10],[12582912,10],[16777216,10],[26214400,15],[33554432,22],[44236800,2],[58982400,6],[67108864,6],[134217728,6],[167772160,6]]),Os=[],Rs=e=>16*Math.ceil(Number(e)/16),Vs=e=>{for(let t=0;t<Os.length;t++){let a=Os[t];if(e<=a)return a}return 16*Math.ceil(e/16)},Ps=1,Ds=()=>Ps++,Bs=async(e,t,a,n)=>{let r=Rs(a),s=e.device.createBuffer({size:r,usage:GPUBufferUsage.COPY_DST|GPUBufferUsage.MAP_READ});try{let i=e.getCommandEncoder();e.endComputePass(),i.copyBufferToBuffer(t,0,s,0,r),e.flush(),await s.mapAsync(GPUMapMode.READ);let o=s.getMappedRange();if(n){let e=n();return e.set(new Uint8Array(o,0,a)),e}return new Uint8Array(o.slice(0,a))}finally{s.destroy()}},Ls=class{constructor(e){this.backend=e,this.storageCache=new Map,this.freeBuffers=new Map,this.freeUniformBuffers=new Map,this.buffersPending=[],this.capturedPendingBuffers=new Map;for(let[t]of Is)Os.push(t),this.freeBuffers.set(t,[]),this.freeUniformBuffers.set(t,[]);this.sessionCount=0}upload(e,t){let a=t.buffer,n=t.byteOffset,r=t.byteLength,s=Rs(r),i=this.storageCache.get(e);if(!i)throw new Error("gpu data for uploading does not exist");if(Number(i.originalSize)!==r)throw new Error(`inconsistent data size. gpu data size=${i.originalSize}, data size=${r}`);let o=this.backend.device.createBuffer({mappedAtCreation:!0,size:s,usage:GPUBufferUsage.MAP_WRITE|GPUBufferUsage.COPY_SRC}),l=o.getMappedRange();new Uint8Array(l).set(new Uint8Array(a,n,r)),o.unmap();let d=this.backend.device.createCommandEncoder();d.copyBufferToBuffer(o,0,i.gpuData.buffer,0,s),this.backend.device.queue.submit([d.finish()]),o.destroy(),us("verbose",()=>`[WebGPU] GpuDataManager.upload(id=${e})`)}memcpy(e,t){let a=this.storageCache.get(e);if(!a)throw new Error("source gpu data for memcpy does not exist");let n=this.storageCache.get(t);if(!n)throw new Error("destination gpu data for memcpy does not exist");if(a.originalSize!==n.originalSize)throw new Error("inconsistent source and destination gpu data size");let r=Rs(a.originalSize),s=this.backend.getCommandEncoder();this.backend.endComputePass(),s.copyBufferToBuffer(a.gpuData.buffer,0,n.gpuData.buffer,0,r)}registerExternalBuffer(e,t,a){let n;if(a){if(n=a[0],e===a[1])return us("verbose",()=>`[WebGPU] GpuDataManager.registerExternalBuffer(size=${t}) => id=${n}, buffer is the same, skip.`),n;if(this.backend.capturedCommandList.has(this.backend.currentSessionId))throw new Error("Registering a different external buffer under graph capture mode is not supported yet.\n             Please use the previous external buffer!")}else n=Ds();return this.storageCache.set(n,{gpuData:{id:n,type:0,buffer:e},originalSize:t}),us("verbose",()=>`[WebGPU] GpuDataManager.registerExternalBuffer(size=${t}) => id=${n}, registered.`),n}unregisterExternalBuffer(e){void 0!==e&&(this.storageCache.delete(e),us("verbose",()=>`[WebGPU] GpuDataManager.unregisterExternalBuffer() => id=${e}`))}create(e,t=GPUBufferUsage.STORAGE|GPUBufferUsage.COPY_SRC|GPUBufferUsage.COPY_DST){let a,n=Vs(e),r=(t&GPUBufferUsage.STORAGE)===GPUBufferUsage.STORAGE,s=(t&GPUBufferUsage.UNIFORM)===GPUBufferUsage.UNIFORM;if(r||s){let e=(r?this.freeBuffers:this.freeUniformBuffers).get(n);a=e&&e.length>0?e.pop():this.backend.device.createBuffer({size:n,usage:t})}else a=this.backend.device.createBuffer({size:n,usage:t});let i={id:Ds(),type:0,buffer:a};return this.storageCache.set(i.id,{gpuData:i,originalSize:Number(e)}),us("verbose",()=>`[WebGPU] GpuDataManager.create(size=${e}) => id=${i.id}`),i}get(e){return this.storageCache.get(e)?.gpuData}release(e){let t="bigint"==typeof e?Number(e):e,a=this.storageCache.get(t);if(!a){if(0===this.storageCache.size)return 0;throw new Error("releasing data does not exist")}return us("verbose",()=>`[WebGPU] GpuDataManager.release(id=${t}), gpuDataId=${a.gpuData.id}`),this.storageCache.delete(t),this.buffersPending.push(a.gpuData.buffer),a.originalSize}async download(e,t){let a=this.storageCache.get(Number(e));if(!a)throw new Error("data does not exist");await Bs(this.backend,a.gpuData.buffer,a.originalSize,t)}refreshPendingBuffers(){if(0!==this.buffersPending.length)if("default"===this.backend.sessionStatus){for(let e of this.buffersPending){let t=Is.get(e.size);if((e.usage&GPUBufferUsage.STORAGE)===GPUBufferUsage.STORAGE){let a=this.freeBuffers.get(e.size)||[];void 0===t||a.length>=t?e.destroy():a.push(e)}else if((e.usage&GPUBufferUsage.UNIFORM)===GPUBufferUsage.UNIFORM){let a=this.freeUniformBuffers.get(e.size)||[];void 0===t||a.length>=t?e.destroy():a.push(e)}else e.destroy()}this.buffersPending=[]}else{let e=this.capturedPendingBuffers.get(this.backend.currentSessionId);e||(e=[],this.capturedPendingBuffers.set(this.backend.currentSessionId,e));for(let t of this.buffersPending)e.push(t);this.buffersPending=[]}}dispose(){this.freeBuffers.forEach(e=>{e.forEach(e=>{e.destroy()})}),this.freeUniformBuffers.forEach(e=>{e.forEach(e=>{e.destroy()})}),this.storageCache.forEach(e=>{e.gpuData.buffer.destroy()}),this.capturedPendingBuffers.forEach(e=>{e.forEach(e=>{e.destroy()})}),this.storageCache=new Map,this.freeBuffers=new Map,this.freeUniformBuffers=new Map,this.capturedPendingBuffers=new Map}onCreateSession(){this.sessionCount+=1}onReleaseSession(e){let t=this.capturedPendingBuffers.get(e);t&&(t.forEach(e=>{e.destroy()}),this.capturedPendingBuffers.delete(e)),this.sessionCount-=1,0===this.sessionCount&&(us("warning",()=>"[WebGPU] Clearing webgpu buffer cache"),this.storageCache.forEach(e=>{e.gpuData.buffer.destroy()}),this.storageCache=new Map)}},Fs=(...e)=>new Ls(...e)}),pp=Ln(()=>{Ws=class{constructor(e){Object.assign(this,e)}get cacheKey(){return this.key||(this.key=Object.getOwnPropertyNames(this).sort().map(e=>`${this[e]}`).join(";")),this.key}},Us=e=>new Ws(e)}),hp=Ln(()=>{rp(),op(),qs=64,Hs=(e,t)=>{if(3===t)throw new Error("vec3 has same alignment as vec4, use vec4 instead");switch(Number(e)){case 10:return t>1?`vec${t}<f16>`:"f16";case 1:return t>1?`vec${t}<f32>`:"f32";case 6:return t>1?`vec${t}<i32>`:"i32";case 12:return t>1?`vec${t}<u32>`:"u32";case 7:if(t>1)throw new Error("currently not supported vecX of uint64 yet");return["vec2<u32>","i32"];case 13:if(t>1)throw new Error("currently not supported vecX of uint64 yet");return["vec2<u32>","u32"];case 9:if(4!==t)throw new Error("bool must be vec4");return["u32","vec4<bool>"];case 22:return"i32";case 21:return"u32";default:throw new Error(`Unknown data type: ${e}`)}},Gs=(e,t=1)=>{let a=Hs(e,t);return"string"==typeof a?a:a[0]},Ks=(e,t=1)=>{let a=Hs(e,t);return"string"==typeof a?a:a[1]},Xs=(...e)=>{let t=[];return e.forEach(e=>{0!==e.length&&t.push({type:12,data:e},{type:12,data:hs.computeStrides(e)})}),t},Ys=e=>e%4==0?4:e%2==0?2:1,Zs=(e="f32",t,a="0")=>t&&1!==t?`vec${t}<${e}>(${a})`:`${e}(${a})`,Qs=(e,t,a)=>"f32"===e?a:1===t?`f32(${a})`:`vec${t}<f32>(${a})`,Js=(e,t)=>4===t?`(${e}.x + ${e}.y + ${e}.z + ${e}.w)`:2===t?`(${e}.x + ${e}.y)`:3===t?`(${e}.x + ${e}.y + ${e}.z)`:e,ei=(e,t,a,n)=>e.startsWith("uniforms.")&&a>4?"string"==typeof t?"f16"===n?`${e}[(${t}) / 8][(${t}) % 8 / 4][(${t}) % 8 % 4]`:`${e}[(${t}) / 4][(${t}) % 4]`:"f16"===n?`${e}[${Math.floor(t/8)}][${Math.floor(t%8/4)}][${t%8%4}]`:`${e}[${Math.floor(t/4)}][${t%4}]`:a>1?`${e}[${t}]`:e,ti=(e,t,a,n,r)=>{let s="number"==typeof a,i=s?a:a.length,o=[...new Array(i).keys()],l=i<2?"u32":i<=4?`vec${i}<u32>`:`array<u32, ${i}>`,d=Hs(t,r),c="string"==typeof d?d:d[1],u="string"==typeof d?d:d[0],m={indices:l,value:c,storage:u,tensor:t},p=e=>"string"==typeof e?e:`${e}u`,h={offsetToIndices:!1,indicesToOffset:!1,broadcastedIndicesToOffset:!1,set:!1,setByIndices:!1,get:!1,getByIndices:!1},f=s?"uniforms.":"",x=`${f}${e}_shape`,g=`${f}${e}_strides`,b="";for(let T=0;T<i-1;T++)b+=`\n    let dim${T} = current / ${ei(g,T,i)};\n    let rest${T} = current % ${ei(g,T,i)};\n    indices[${T}] = dim${T};\n    current = rest${T};\n    `;b+=`indices[${i-1}] = current;`;let y=i<2?"":`\n  fn o2i_${e}(offset: u32) -> ${m.indices} {\n    var indices: ${m.indices};\n    var current = offset;\n    ${b}\n    return indices;\n  }`,v=[];if(i>=2)for(let T=i-1;T>=0;T--)v.push(`${ei(g,T,i)} * (indices[${T}])`);let w=i<2?"":`\n  fn i2o_${e}(indices: ${m.indices}) -> u32 {\n    return ${v.join("+")};\n  }`,j=(...e)=>0===i?"0u":`${m.indices}(${e.map(p).join(",")})`,_=(e,t)=>i<2?`${e}`:`${ei(e,t,i)}`,k={},N=(t,a)=>(()=>{if(m.storage===m.value)return`${e}[${t}]=${a};`;if("vec2<u32>"===m.storage&&"i32"===m.value)return`${e}[${t}]=vec2<u32>(u32(${a}), select(0u, 0xFFFFFFFFu, ${a} < 0));`;if("vec2<u32>"===m.storage&&"u32"===m.value)return`${e}[${t}]=vec2<u32>(u32(${a}), 0u);`;if("u32"===m.storage&&"vec4<bool>"===m.value)return`${e}[${t}]=dot(vec4<u32>(0x1, 0x100, 0x10000, 0x1000000), vec4<u32>(${a}));`;throw new Error(`not supported combination of storage type ${m.storage} and value type ${m.value} yet`)})(),$=t=>(()=>{if(m.storage===m.value)return`${e}[${t}]`;if("vec2<u32>"===m.storage&&"i32"===m.value)return`i32(${e}[${t}].x)`;if("vec2<u32>"===m.storage&&"u32"===m.value)return`u32(${e}[${t}].x)`;if("u32"===m.storage&&"vec4<bool>"===m.value)return`vec4<bool>(bool(${e}[${t}] & 0xFFu), bool(${e}[${t}] & 0xFF00u), bool(${e}[${t}] & 0xFF0000u), bool(${e}[${t}] & 0xFF000000u))`;throw new Error(`not supported combination of storage type ${m.storage} and value type ${m.value} yet`)})(),C=i<2?"":`\n  fn get_${e}ByIndices(indices: ${m.indices}) -> ${c} {\n    return ${$(`i2o_${e}(indices)`)};\n  }`,S=i<2?"":(()=>{let t=o.map(e=>`d${e}: u32`).join(", "),a=o.map(e=>`d${e}`).join(", ");return`\n  fn get_${e}(${t}) -> ${c} {\n    return get_${e}ByIndices(${j(a)});\n  }`})(),M=i<2?"":`\n  fn set_${e}ByIndices(indices: ${m.indices}, value: ${c}) {\n    ${N(`i2o_${e}(indices)`,"value")}\n  }`,z=i<2?"":(()=>{let t=o.map(e=>`d${e}: u32`).join(", "),a=o.map(e=>`d${e}`).join(", ");return`\n  fn set_${e}(${t}, value: ${c}) {\n    set_${e}ByIndices(${j(a)}, value);\n  }`})();return{impl:()=>{let e=[],t=!1;return h.offsetToIndices&&(e.push(y),t=!0),h.indicesToOffset&&(e.push(w),t=!0),h.broadcastedIndicesToOffset&&(Object.values(k).forEach(t=>e.push(t)),t=!0),h.set&&(e.push(z),t=!0),h.setByIndices&&(e.push(M),t=!0),h.get&&(e.push(S),t=!0),h.getByIndices&&(e.push(C),t=!0),!s&&t&&e.unshift(`const ${x} = ${m.indices}(${a.join(",")});`,`const ${g} = ${m.indices}(${hs.computeStrides(a).join(",")});`),e.join("\n")},type:m,offsetToIndices:t=>(h.offsetToIndices=!0,i<2?t:`o2i_${e}(${t})`),indicesToOffset:t=>(h.indicesToOffset=!0,i<2?t:`i2o_${e}(${t})`),broadcastedIndicesToOffset:(t,a)=>{h.broadcastedIndicesToOffset=!0;let n=`${a.name}broadcastedIndicesTo${e}Offset`;if(n in k)return`${n}(${t})`;let r=[];for(let e=i-1;e>=0;e--){let t=a.indicesGet("outputIndices",e+a.rank-i);r.push(`${_(g,e)} * (${t} % ${_(x,e)})`)}return k[n]=`fn ${n}(outputIndices: ${a.type.indices}) -> u32 {\n             return ${r.length>0?r.join("+"):"0u"};\n           }`,`${n}(${t})`},indices:j,indicesGet:_,indicesSet:(e,t,a)=>i<2?`${e}=${a};`:`${ei(e,t,i)}=${a};`,set:(...t)=>{if(t.length!==i+1)throw new Error(`indices length must be ${i}`);let a=t[i];if("string"!=typeof a)throw new Error("value must be string");let n=t.slice(0,i).map(p).join(",");return 0===i?N("0u",a):1===i?N(n[0],a):(h.set=!0,h.setByIndices=!0,h.indicesToOffset=!0,`set_${e}(${n}, ${a})`)},setByOffset:N,setByIndices:(t,a)=>i<2?N(t,a):(h.setByIndices=!0,h.indicesToOffset=!0,`set_${e}ByIndices(${t}, ${a});`),get:(...t)=>{if(t.length!==i)throw new Error(`indices length must be ${i}`);let a=t.map(p).join(",");return 0===i?$("0u"):1===i?$(a[0]):(h.get=!0,h.getByIndices=!0,h.indicesToOffset=!0,`get_${e}(${a})`)},getByOffset:$,getByIndices:t=>i<2?$(t):(h.getByIndices=!0,h.indicesToOffset=!0,`get_${e}ByIndices(${t})`),usage:n,name:e,strides:g,shape:x,rank:i}},ai=(e,t,a,n=1)=>ti(e,t,a,"input",n),ni=(e,t,a,n=1)=>ti(e,t,a,"output",n),ri=(e,t,a)=>ti(e,t,a,"atomicOutput",1),si=(e,t,a,n=1)=>ti(e,t,a,"internal",n),ii=class{constructor(e,t){this.normalizedDispatchGroup=e,this.limits=t,this.internalVariables=[],this.variables=[],this.uniforms=[],this.variableIndex=0}guardAgainstOutOfBoundsWorkgroupSizes(e){return`if (global_idx >= ${"number"==typeof e?`${e}u`:e}) { return; }`}mainStart(e=qs){let t="number"==typeof e?e:e[0],a="number"==typeof e?1:e[1],n="number"==typeof e?1:e[2];if(t>this.limits.maxComputeWorkgroupSizeX||a>this.limits.maxComputeWorkgroupSizeY||n>this.limits.maxComputeWorkgroupSizeZ)throw new Error(`workgroup size [${t}, ${a}, ${n}] exceeds the maximum workgroup size [${this.limits.maxComputeWorkgroupSizeX}, ${this.limits.maxComputeWorkgroupSizeY}, ${this.limits.maxComputeWorkgroupSizeZ}].`);if(t*a*n>this.limits.maxComputeInvocationsPerWorkgroup)throw new Error(`workgroup size [${t}, ${a}, ${n}] exceeds the maximum workgroup invocations ${this.limits.maxComputeInvocationsPerWorkgroup}.`);let r=1===this.normalizedDispatchGroup[1]&&1===this.normalizedDispatchGroup[2];return`@compute @workgroup_size(${t}, ${a}, ${n})\n  fn main(${r?"@builtin(global_invocation_id) global_id : vec3<u32>,\n    @builtin(workgroup_id) workgroup_id : vec3<u32>,\n    @builtin(local_invocation_index) local_idx : u32,\n    @builtin(local_invocation_id) local_id : vec3<u32>":"@builtin(global_invocation_id) global_id : vec3<u32>,\n                                             @builtin(local_invocation_id) local_id : vec3<u32>,\n    @builtin(local_invocation_index) local_idx : u32,\n    @builtin(workgroup_id) workgroup_id : vec3<u32>,\n    @builtin(num_workgroups) num_workgroups : vec3<u32>"}) {\n    ${r?"let global_idx = global_id.x;\n         let workgroup_index = workgroup_id.x;":`let workgroup_index = workgroup_id.z * num_workgroups[0] * num_workgroups[1] +\n             workgroup_id.y * num_workgroups[0] + workgroup_id.x;\n         let global_idx = workgroup_index * ${t*a*n}u + local_idx;`}\n  `}appendVariableUniforms(e){0!==e.rank&&(e.shape.startsWith("uniforms.")&&this.uniforms.push({name:e.shape.replace("uniforms.",""),type:"u32",length:e.rank}),e.strides.startsWith("uniforms.")&&this.uniforms.push({name:e.strides.replace("uniforms.",""),type:"u32",length:e.rank}))}declareVariable(e,t){if("internal"===e.usage)throw new Error("cannot use internal variable with declareVariable(). use registerInternalVariables() instead.");this.variables.push(e),this.appendVariableUniforms(e);let a="input"===e.usage?"read":"read_write",n="atomicOutput"===e.usage?"atomic<i32>":e.type.storage;return`@group(0) @binding(${t}) var<storage, ${a}> ${e.name}: array<${n}>;`}declareVariables(...e){return e.map(e=>this.declareVariable(e,this.variableIndex++)).join("\n")}registerInternalVariable(e){if("internal"!==e.usage)throw new Error("cannot use input or output variable with registerInternalVariable(). use declareVariables() instead.");this.internalVariables.push(e),this.appendVariableUniforms(e)}registerInternalVariables(...e){return e.forEach(e=>this.registerInternalVariable(e)),this}registerUniform(e,t,a=1){return this.uniforms.push({name:e,type:t,length:a}),this}registerUniforms(e){return this.uniforms=this.uniforms.concat(e),this}uniformDeclaration(){if(0===this.uniforms.length)return"";let e=[];for(let{name:t,type:a,length:n}of this.uniforms)if(n&&n>4)"f16"===a?e.push(`@align(16) ${t}:array<mat2x4<${a}>, ${Math.ceil(n/8)}>`):e.push(`${t}:array<vec4<${a}>, ${Math.ceil(n/4)}>`);else{let r=null==n||1===n?a:`vec${n}<${a}>`;e.push(`${t}:${r}`)}return`\n      struct Uniforms { ${e.join(", ")} };\n      @group(0) @binding(${this.variableIndex}) var<uniform> uniforms: Uniforms;`}get additionalImplementations(){return this.uniformDeclaration()+this.variables.map(e=>e.impl()).join("\n")+this.internalVariables.map(e=>e.impl()).join("\n")}get variablesInfo(){if(0===this.uniforms.length)return;let e=e=>[12,10,1,6][["u32","f16","f32","i32"].indexOf(e)];return this.uniforms.map(t=>[e(t.type),t.length??1])}},oi=(e,t)=>new ii(e,t)}),fp=Ln(()=>{rp(),op(),pp(),hp(),li=(e,t)=>{if(!e||1!==e.length)throw new Error("Transpose requires 1 input.");if(0!==t.length&&t.length!==e[0].dims.length)throw new Error(`perm size ${t.length} does not match input rank ${e[0].dims.length}`)},di=(e,t)=>0!==t.length?t:[...new Array(e).keys()].reverse(),ci=(e,t)=>hs.sortBasedOnPerm(e,di(e.length,t)),ui=(e,t,a,n)=>{let r=`fn perm(i: ${n.type.indices}) -> ${a.type.indices} {\n    var a: ${a.type.indices};`;for(let s=0;s<t;++s)r+=`a[${e[s]}]=i[${s}];`;return r+"return a;}"},mi=(e,t)=>{let a=[],n=[];for(let r=0;r<e.length;++r)1!==e[r]&&a.push(e[r]),1!==e[t[r]]&&n.push(t[r]);return{newShape:a,newPerm:n}},pi=(e,t)=>{let a=0;for(let n=0;n<e.length;++n)if(1!==t[e[n]]){if(e[n]<a)return!1;a=e[n]}return!0},hi=(e,t)=>{let a,n=e.dataType,r=e.dims.length,s=di(r,t),i=ci(e.dims,s),o=e.dims,l=i;if(r<2||pi(s,e.dims))return a=e=>{let t=ai("input",n,o,4),a=ni("output",n,l,4);return`\n  ${e.registerUniform("output_size","u32").declareVariables(t,a)}\n  ${e.mainStart()}\n    ${e.guardAgainstOutOfBoundsWorkgroupSizes("uniforms.output_size")}\n    output[global_idx] = input[global_idx];\n  }`},{name:"TransposeCopy",shaderCache:{inputDependencies:["type"]},getRunData:()=>{let t=hs.size(i);return{outputs:[{dims:i,dataType:e.dataType}],dispatchGroup:{x:Math.ceil(t/64/4)},programUniforms:[{type:12,data:Math.ceil(t/4)}]}},getShaderSource:a};let{newShape:d,newPerm:c}=mi(e.dims,s),u=hs.areEqual(c,[2,3,1]),m=hs.areEqual(c,[3,1,2]);if(2===d.length||u||m){o=u?[d[0],d[1]*d[2]]:m?[d[0]*d[1],d[2]]:d,l=[o[1],o[0]];let t=16;return a=e=>{let a=ai("a",n,o.length),r=ni("output",n,l.length);return`\n  ${e.registerUniform("output_size","u32").declareVariables(a,r)}\n  var<workgroup> tile : array<array<${r.type.value}, ${t+1}>, ${t}>;\n  ${e.mainStart([t,t,1])}\n    let stride = (uniforms.output_shape[1] - 1) / ${t} + 1;\n    let workgroup_id_x = workgroup_index % stride;\n    let workgroup_id_y = workgroup_index / stride;\n    let input_col = workgroup_id_y * ${t}u + local_id.x;\n    let input_row = workgroup_id_x * ${t}u + local_id.y;\n    if (input_row < uniforms.a_shape[0] && input_col < uniforms.a_shape[1]) {\n      tile[local_id.y][local_id.x] = ${a.getByIndices(`${a.type.indices}(input_row, input_col)`)};\n    }\n    workgroupBarrier();\n\n    let output_col = workgroup_id_x * ${t}u + local_id.x;\n    let output_row = workgroup_id_y * ${t}u + local_id.y;\n    if (output_row < uniforms.output_shape[0] && output_col < uniforms.output_shape[1]) {\n      ${r.setByIndices(`${r.type.indices}(output_row, output_col)`,"tile[local_id.x][local_id.y]")}\n    }\n  }`},{name:"TransposeShared",shaderCache:{inputDependencies:["type"]},getRunData:()=>{let a=hs.size(i);return{outputs:[{dims:i,dataType:e.dataType}],dispatchGroup:{x:Math.ceil(l[1]/t),y:Math.ceil(l[0]/t)},programUniforms:[{type:12,data:a},...Xs(o,l)]}},getShaderSource:a}}return a=e=>{let t=ai("a",n,o.length),a=ni("output",n,l.length);return`\n  ${e.registerUniform("output_size","u32").declareVariables(t,a)}\n\n  ${ui(s,r,t,a)}\n\n  ${e.mainStart()}\n    ${e.guardAgainstOutOfBoundsWorkgroupSizes("uniforms.output_size")}\n\n    let indices = ${a.offsetToIndices("global_idx")};\n    let aIndices = perm(indices);\n\n    ${a.setByOffset("global_idx",t.getByIndices("aIndices"))}\n  }`},{name:"Transpose",shaderCache:{hint:`${t}`,inputDependencies:["rank"]},getRunData:()=>{let t=hs.size(i);return{outputs:[{dims:i,dataType:e.dataType}],dispatchGroup:{x:Math.ceil(t/64)},programUniforms:[{type:12,data:t},...Xs(o,l)]}},getShaderSource:a}},fi=(e,t)=>{li(e.inputs,t.perm),e.compute(hi(e.inputs[0],t.perm))},xi=e=>Us({perm:e.perm})}),xp=Ln(()=>{rp(),op(),hp(),gp(),fp(),gi={max:"select(bestValue, candidate, candidate > bestValue)",min:"select(bestValue, candidate, candidate < bestValue)",mean:"bestValue + candidate",sum:"bestValue + candidate",prod:"bestValue * candidate",sumSquare:"bestValue + candidate * candidate",logSumExp:"bestValue + exp(candidate)",l1:"bestValue + abs(candidate)",l2:"bestValue + candidate * candidate",logSum:"bestValue + candidate"},bi={max:"select(bestValue, candidate, candidate > bestValue)",min:"select(bestValue, candidate, candidate < bestValue)",mean:"bestValue + candidate",sum:"bestValue + candidate",prod:"bestValue * candidate",sumSquare:"bestValue + candidate",logSumExp:"bestValue + candidate",l1:"bestValue + candidate",l2:"bestValue + candidate",logSum:"bestValue + candidate"},yi={max:"_A[offset]",min:"_A[offset]",mean:"0",sum:"0",prod:"1",sumSquare:"0",logSumExp:"0",l1:"0",l2:"0",logSum:"0"},vi={max:"bestValue",min:"bestValue",sum:"bestValue",prod:"bestValue",sumSquare:"bestValue",logSumExp:"log(bestValue)",l1:"bestValue",l2:"sqrt(bestValue)",logSum:"log(bestValue)"},wi=(e,t)=>{let a=[];for(let n=t-e;n<t;++n)a.push(n);return a},ji=(e,t)=>{let a=[],n=e.length;for(let r=0;r<n;r++)-1===t.indexOf(r)&&a.push(e[r]);return[a,t.map(t=>e[t])]},_i=(e,t)=>{let a=e.length+t.length,n=[],r=0;for(let s=0;s<a;s++)-1===t.indexOf(s)?n.push(e[r++]):n.push(1);return n},ki=(e,t)=>{for(let a=0;a<e.length;++a)if(e[e.length-a-1]!==t-1-a)return!1;return!0},Ni=(e,t)=>{let a=[];if(!ki(e,t)){for(let n=0;n<t;++n)-1===e.indexOf(n)&&a.push(n);e.forEach(e=>a.push(e))}return a},$i=(e,t,a,n,r,s,i)=>{let o=a[0].dims,l=hs.size(s),d=hs.size(i),c=ai("_A",a[0].dataType,o),u=ni("output",r,s),m=64;1===l&&(m=256);let p=`\n          var<workgroup> aBestValues : array<f32, ${m}>;\n       `;return{name:e,shaderCache:{hint:`${t};${m}`,inputDependencies:["type"]},getShaderSource:e=>`\n        ${e.registerUniform("reduceSize","u32").declareVariables(c,u)}\n        ${p}\n        fn DIV_CEIL(a : u32, b : u32) -> u32 {\n          return ((a - 1u) / b + 1u);\n         }\n         ${e.mainStart(m)}\n\n          let outputIndex = global_idx / ${m};\n          let offset = outputIndex * uniforms.reduceSize;\n\n          var bestValue = f32(${yi[n]});\n          let Length = uniforms.reduceSize;\n          for (var k = local_idx; k < Length; k = k + ${m}) {\n           let candidate = f32(${c.getByOffset("offset + k")});\n           bestValue = ${gi[n]};\n          }\n          aBestValues[local_idx] = bestValue;\n          workgroupBarrier();\n\n         var reduceSize = min(Length, ${m}u);\n         for (var currentSize = reduceSize / 2u; reduceSize > 1u;\n             currentSize = reduceSize / 2u) {\n           let interval = DIV_CEIL(reduceSize, 2u);\n           if (local_idx < currentSize) {\n            let candidate = aBestValues[local_idx + interval];\n            bestValue = ${bi[n]};\n            aBestValues[local_idx] = bestValue;\n           }\n           reduceSize = interval;\n           workgroupBarrier();\n         }\n\n         if (local_idx == 0u) {\n          ${u.setByOffset("outputIndex",""+("mean"===n?`${u.type.storage}(bestValue / f32(uniforms.reduceSize))`:`${u.type.storage}(${vi[n]})`))};\n         }\n        }`,getRunData:()=>({outputs:[{dims:s,dataType:r}],dispatchGroup:{x:l},programUniforms:[{type:12,data:d}]})}},Ci=(e,t,a,n)=>{let r=1===e.inputs.length?a:Li(e.inputs,a),s=r.axes;0===s.length&&!r.noopWithEmptyAxes&&(s=e.inputs[0].dims.map((e,t)=>t));let i=hs.normalizeAxes(s,e.inputs[0].dims.length),o=i,l=e.inputs[0],d=Ni(o,e.inputs[0].dims.length);d.length>0&&(l=e.compute(hi(e.inputs[0],d),{inputs:[0],outputs:[-1]})[0],o=wi(o.length,l.dims.length));let[c,u]=ji(l.dims,o),m=c;r.keepDims&&(m=_i(c,i)),e.compute($i(t,r.cacheKey,[l],n,e.inputs[0].dataType,m,u),{inputs:[l]})},Si=(e,t)=>{Ci(e,"ReduceMeanShared",t,"mean")},Mi=(e,t)=>{Ci(e,"ReduceL1Shared",t,"l1")},zi=(e,t)=>{Ci(e,"ReduceL2Shared",t,"l2")},Ti=(e,t)=>{Ci(e,"ReduceLogSumExpShared",t,"logSumExp")},Ei=(e,t)=>{Ci(e,"ReduceMaxShared",t,"max")},Ai=(e,t)=>{Ci(e,"ReduceMinShared",t,"min")},Ii=(e,t)=>{Ci(e,"ReduceProdShared",t,"prod")},Oi=(e,t)=>{Ci(e,"ReduceSumShared",t,"sum")},Ri=(e,t)=>{Ci(e,"ReduceSumSquareShared",t,"sumSquare")},Vi=(e,t)=>{Ci(e,"ReduceLogSumShared",t,"logSum")}}),gp=Ln(()=>{rp(),op(),pp(),hp(),xp(),Pi=e=>{if(!e||0===e.length||e.length>2)throw new Error("Reduce op requires 1 or 2 inputs.");if(2===e.length&&1!==e[1].dims.length)throw new Error("Invalid axes input dims.")},Di=e=>["","",`var value = ${e.getByIndices("input_indices")};`,""],Bi=(e,t,a,n,r,s,i=!1,o=!1)=>{let l=[],d=a[0].dims,c=d.length,u=hs.normalizeAxes(r,c),m=!o&&0===u.length;d.forEach((e,t)=>{m||u.indexOf(t)>=0?i&&l.push(1):l.push(e)});let p=l.length,h=hs.size(l);return{name:e,shaderCache:t,getShaderSource:e=>{let t=[],r=ai("_A",a[0].dataType,c),o=ni("output",s,p),l=n(r,o,u),h=l[2];for(let a=0,n=0;a<c;a++)m||u.indexOf(a)>=0?(i&&n++,h=`for(var j${a}: u32 = 0; j${a} < ${d[a]}; j${a}++) {\n                  ${l[2].includes("last_index")?`let last_index = j${a};`:""}\n                  ${r.indicesSet("input_indices",a,`j${a}`)}\n                  ${h}\n                }`):(t.push(`${r.indicesSet("input_indices",a,o.indicesGet("output_indices",n))};`),n++);return`\n\n        ${e.registerUniform("output_size","u32").declareVariables(r,o)}\n\n        ${e.mainStart()}\n          ${e.guardAgainstOutOfBoundsWorkgroupSizes("uniforms.output_size")}\n          var input_indices: ${r.type.indices};\n          let output_indices = ${o.offsetToIndices("global_idx")};\n\n          ${t.join("\n")}\n          ${l[0]}       // init ops for reduce max/min\n          ${l[1]}\n          ${h}\n          ${l[3]}\n          ${4===l.length?o.setByOffset("global_idx","value"):l.slice(4).join("\n")}\n        }`},getRunData:()=>({outputs:[{dims:l,dataType:s}],dispatchGroup:{x:Math.ceil(h/64)},programUniforms:[{type:12,data:h},...Xs(d,l)]})}},Li=(e,t)=>{let a=[];return e[1].dims[0]>0&&e[1].getBigInt64Array().forEach(e=>a.push(Number(e))),Us({axes:a,keepDims:t.keepDims,noopWithEmptyAxes:t.noopWithEmptyAxes})},Fi=(e,t,a,n)=>{let r=e.inputs,s=1===r.length?a:Li(r,a);e.compute(Bi(t,{hint:s.cacheKey,inputDependencies:["rank"]},[r[0]],s.noopWithEmptyAxes&&0===s.axes.length?Di:n,s.axes,r[0].dataType,s.keepDims,s.noopWithEmptyAxes),{inputs:[0]})},Wi=(e,t)=>{Pi(e.inputs),Fi(e,"ReduceLogSum",t,(e,t)=>[`var value = ${t.type.storage}(0);`,"",`value += ${e.getByIndices("input_indices")};`,"value = log(value);"])},Ui=(e,t)=>{Pi(e.inputs),Fi(e,"ReduceL1",t,(e,t)=>[`var value = ${t.type.storage}(0);`,"",`value += abs(${e.getByIndices("input_indices")});`,""])},qi=(e,t)=>{Pi(e.inputs),Fi(e,"ReduceL2",t,(e,t)=>[`var t = ${t.type.value}(0); var value = ${t.type.value}(0);`,"",`t = ${e.getByIndices("input_indices")}; value += (t * t);`,"value = sqrt(value);"])},Hi=(e,t)=>{Pi(e.inputs),Fi(e,"ReduceLogSumExp",t,(e,t)=>[`var value = ${t.type.storage}(0);`,"",`value += exp(${e.getByIndices("input_indices")});`,"value = log(value);"])},Gi=(e,t)=>{Pi(e.inputs),Fi(e,"ReduceMax",t,(e,t,a)=>{let n=[];for(let r=0;r<e.rank;r++)(a.indexOf(r)>=0||0===a.length)&&n.push(e.indicesSet("input_indices",r,0));return[`${n.join("\n")}`,`var value = ${e.getByIndices("input_indices")};`,`value = max(value, ${e.getByIndices("input_indices")});`,""]})},Ki=(e,t)=>{Pi(e.inputs),Fi(e,"ReduceMean",t,(t,a,n)=>{let r=1;for(let s=0;s<t.rank;s++)(n.indexOf(s)>=0||0===n.length)&&(r*=e.inputs[0].dims[s]);return["var sum = f32(0);","",`sum += f32(${t.getByIndices("input_indices")});`,`let value = ${a.type.value}(sum / ${r});`]})},Xi=(e,t)=>{Pi(e.inputs),Fi(e,"ReduceMin",t,(e,t,a)=>{let n=[];for(let r=0;r<e.rank;r++)(a.indexOf(r)>=0||0===a.length)&&n.push(`input_indices[${r}] = 0;`);return[`${n.join("\n")}`,`var value = ${e.getByIndices("input_indices")};`,`value = min(value, ${e.getByIndices("input_indices")});`,""]})},Yi=(e,t)=>{Pi(e.inputs),Fi(e,"ReduceProd",t,(e,t)=>[`var value = ${t.type.storage}(1);`,"",`value *= ${e.getByIndices("input_indices")};`,""])},Zi=(e,t)=>{Pi(e.inputs),Fi(e,"ReduceSum",t,(e,t)=>[`var value = ${t.type.storage}(0);`,"",`value += ${e.getByIndices("input_indices")};`,""])},Qi=(e,t)=>{Pi(e.inputs),Fi(e,"ReduceSumSquare",t,(e,t)=>[`var t = ${t.type.value}(0); var value = ${t.type.value}(0);`,"",`t = ${e.getByIndices("input_indices")}; value += t * t;`,""])},Ji=(e,t,a)=>{if(0===t.length)return a;let n=1,r=1;for(let s=0;s<t.length;s++)-1===t.indexOf(s)?n*=e[s]:r*=e[s];return r<32&&n>1024},eo=(e,t)=>{Ji(e.inputs[0].dims,t.axes,t.noopWithEmptyAxes)?Ki(e,t):Si(e,t)},to=(e,t)=>{Ji(e.inputs[0].dims,t.axes,t.noopWithEmptyAxes)?Ui(e,t):Mi(e,t)},ao=(e,t)=>{Ji(e.inputs[0].dims,t.axes,t.noopWithEmptyAxes)?qi(e,t):zi(e,t)},no=(e,t)=>{Ji(e.inputs[0].dims,t.axes,t.noopWithEmptyAxes)?Hi(e,t):Ti(e,t)},ro=(e,t)=>{Ji(e.inputs[0].dims,t.axes,t.noopWithEmptyAxes)?Gi(e,t):Ei(e,t)},so=(e,t)=>{Ji(e.inputs[0].dims,t.axes,t.noopWithEmptyAxes)?Xi(e,t):Ai(e,t)},io=(e,t)=>{Ji(e.inputs[0].dims,t.axes,t.noopWithEmptyAxes)?Yi(e,t):Ii(e,t)},oo=(e,t)=>{Ji(e.inputs[0].dims,t.axes,t.noopWithEmptyAxes)?Zi(e,t):Oi(e,t)},lo=(e,t)=>{Ji(e.inputs[0].dims,t.axes,t.noopWithEmptyAxes)?Qi(e,t):Ri(e,t)},co=(e,t)=>{Ji(e.inputs[0].dims,t.axes,t.noopWithEmptyAxes)?Wi(e,t):Vi(e,t)}}),bp=Ln(()=>{rp(),pp(),gp(),uo=e=>{if(!e||0===e.length||e.length>2)throw new Error("ArgMinMaxOp op requires 1 or 2 inputs.");if(1!==e[0].dataType)throw new Error("Invalid input type.")},mo=(e,t)=>{uo(e.inputs);e.compute(Bi("ArgMin",{hint:t.cacheKey,inputDependencies:["rank"]},[e.inputs[0]],(e,a,n)=>{let r=[];for(let t=0;t<e.rank;t++)(n.indexOf(t)>=0||0===n.length)&&r.push(`input_indices[${t}] = 0;`);return[`${r.join("\n")}`,`var value = ${e.getByIndices("input_indices")};\nvar best_index : i32 = 0;`,`if (${e.getByIndices("input_indices")} ${t.selectLastIndex>0?"<=":"<"} value) {\n         value = ${e.getByIndices("input_indices")};\n         best_index = i32(last_index);\n       }`,"",a.setByOffset("global_idx","best_index")]},[t.axis],7,t.keepDims),{inputs:[0]})},po=(e,t)=>{uo(e.inputs);e.compute(Bi("argMax",{hint:t.cacheKey,inputDependencies:["rank"]},[e.inputs[0]],(e,a,n)=>{let r=[];for(let t=0;t<e.rank;t++)(n.indexOf(t)>=0||0===n.length)&&r.push(`input_indices[${t}] = 0;`);return[`${r.join("\n")}`,`var value = ${e.getByIndices("input_indices")};\nvar best_index : i32 = 0;`,`if (${e.getByIndices("input_indices")} ${t.selectLastIndex>0?">=":">"} value) {\n         value = ${e.getByIndices("input_indices")};\n         best_index = i32(last_index);\n       }`,"",a.setByOffset("global_idx","best_index")]},[t.axis],7,t.keepDims),{inputs:[0]})},ho=e=>Us(e)}),yp=Ln(()=>{rp(),op(),up(),hp(),fo=(e,t)=>{let a=e[0],n=e[1],r=e[2],s=e[3],i=e[4],o=e[5];if(i&&o)throw new Error("Attention cannot have both past and attention_bias");if(3!==a.dims.length)throw new Error('Input "input" must have 3 dimensions');let l=a.dims[0],d=a.dims[1],c=a.dims[2];if(1!==r.dims.length)throw new Error('Input "bias" is expected to have 1 dimensions');if(2!==n.dims.length)throw new Error('Input "weights" is expected to have 2 dimensions');if(n.dims[0]!==c)throw new Error("Input 1 dimension 0 should have same length as dimension 2 of input 0");if(r.dims[0]!==n.dims[1])throw new Error('Input "bias" dimension 0 should have same length as dimension 1 of input "weights"');let u=r.dims[0]/3,m=u,p=m;if(t.qkvHiddenSizes.length>0){if(3!==t.qkvHiddenSizes.length)throw new Error("qkv_hidden_sizes attribute should have 3 elements");for(let e of t.qkvHiddenSizes)if(e%t.numHeads!==0)throw new Error("qkv_hidden_sizes should be divisible by num_heads");u=t.qkvHiddenSizes[0],m=t.qkvHiddenSizes[1],p=t.qkvHiddenSizes[2]}let h=d;if(u!==m)throw new Error("qkv_hidden_sizes first element should be same as the second");if(r.dims[0]!==u+m+p)throw new Error('Input "bias" dimension 0 should have same length as sum of Q/K/V hidden sizes');let f=0;if(i){if(m!==p)throw new Error('Input "past" expect k_hidden_size == v_hidden_size');if(5!==i.dims.length)throw new Error('Input "past" must have 5 dimensions');if(2!==i.dims[0])throw new Error('Input "past" first dimension must be 2');if(i.dims[1]!==l)throw new Error('Input "past" second dimension must be batch_size');if(i.dims[2]!==t.numHeads)throw new Error('Input "past" third dimension must be num_heads');if(i.dims[4]!==m/t.numHeads)throw new Error('Input "past" fifth dimension must be k_hidden_size / num_heads');t.pastPresentShareBuffer||(f=i.dims[3])}let x=h+f;if(s)throw new Error("Mask not supported");if(i)throw new Error("past is not supported");if(o){if(4!==o.dims.length)throw new Error('Input "attention_bias" must have 4 dimensions');if(o.dims[0]!==l||o.dims[1]!==t.numHeads||o.dims[2]!==d||o.dims[3]!==x)throw new Error('Expect "attention_bias" shape (batch_size, num_heads, sequence_length, total_sequence_length)')}return{batchSize:l,sequenceLength:d,pastSequenceLength:f,kvSequenceLength:h,totalSequenceLength:x,maxSequenceLength:-1,inputHiddenSize:c,hiddenSize:u,vHiddenSize:p,headSize:Math.floor(u/t.numHeads),vHeadSize:Math.floor(p/t.numHeads),numHeads:t.numHeads,isUnidirectional:!1,pastPresentShareBuffer:!1,maskFilterValue:t.maskFilterValue,maskType:0,scale:t.scale,broadcastResPosBias:!1,passPastInKv:!1,qkvFormat:1}},xo=(e,t,a)=>t&&e?`\n      let total_sequence_length_input = u32(${t.getByOffset("0")});\n      let present_sequence_length = max(total_sequence_length_input, uniforms.past_sequence_length);\n      let is_subsequent_prompt: bool = sequence_length > 1 && sequence_length != total_sequence_length_input;\n      let is_first_prompt: bool = is_subsequent_prompt == false && sequence_length == total_sequence_length_input;\n      total_sequence_length = u32(${e?.getByOffset("batchIdx")}) + 1;\n      var past_sequence_length: u32 = 0;\n      if (is_first_prompt == false) {\n        past_sequence_length = total_sequence_length - sequence_length;\n      }\n       `:`\n    ${a?"let past_sequence_length = uniforms.past_sequence_length":""};\n    let present_sequence_length = total_sequence_length;\n    `,go=(e,t,a,n,r,s,i,o)=>{let l=Ys(i?1:s),d=64,c=s/l;c<d&&(d=32);let u=Math.ceil(s/l/d),m=[{type:12,data:t},{type:12,data:a},{type:12,data:n},{type:12,data:r},{type:12,data:c},{type:12,data:u}],p=Gs(e.dataType,l),h=Ks(1,l),f=["type"];i&&f.push("type"),o&&f.push("type");return{name:"AttentionProbsSoftmax",shaderCache:{hint:`${d};${p};${l}`,inputDependencies:f},getShaderSource:t=>{let a=ni("x",e.dataType,e.dims,l),n=[a],r=i?ai("seq_lens",i.dataType,i.dims):void 0;r&&n.push(r);let s=o?ai("total_sequence_length_input",o.dataType,o.dims):void 0;s&&n.push(s);let c=Ks(e.dataType);return`\n  var<workgroup> thread_max: array<f32, ${d}>;\n  var<workgroup> thread_sum: array<f32, ${d}>;\n  ${t.registerUniforms([{name:"batch_size",type:"u32"},{name:"num_heads",type:"u32"},{name:"past_sequence_length",type:"u32"},{name:"sequence_length",type:"u32"},{name:"total_sequence_length",type:"u32"},{name:"elements_per_thread",type:"u32"}]).declareVariables(...n)}\n  ${t.mainStart([d,1,1])}\n    let batchIdx = workgroup_id.z / uniforms.num_heads;\n    let headIdx = workgroup_id.z % uniforms.num_heads;\n    let sequence_length = uniforms.sequence_length;\n    var total_sequence_length = uniforms.total_sequence_length;\n    ${xo(r,s,!1)}\n    let local_offset = local_idx * uniforms.elements_per_thread;\n    let offset = (global_idx / ${d}) * uniforms.total_sequence_length + local_offset;\n    let seq_causal_length = ${i?"u32(past_sequence_length + workgroup_id.y + 1)":"total_sequence_length"};\n    var thread_max_vector = ${h}(-3.402823e+38f);\n    for (var i: u32 = 0; i < uniforms.elements_per_thread && i + local_offset < seq_causal_length; i++) {\n      thread_max_vector = max(${h}(x[offset + i]), thread_max_vector);\n    }\n    thread_max[local_idx] = ${(()=>{switch(l){case 1:return"thread_max_vector";case 2:return"max(thread_max_vector.x, thread_max_vector.y)";case 4:return"max(max(thread_max_vector.x, thread_max_vector.y), max(thread_max_vector.z, thread_max_vector.w))";default:throw new Error(`Unsupported components: ${l}`)}})()};\n    workgroupBarrier();\n\n    var max_value =  f32(-3.402823e+38f);\n    for (var i = 0u; i < ${d}; i++) {\n      max_value = max(thread_max[i], max_value);\n    }\n\n    var sum_vector = ${h}(0);\n    for (var i: u32 = 0; i < uniforms.elements_per_thread && i + local_offset < seq_causal_length; i++) {\n      sum_vector += exp(${h}(x[offset + i]) - max_value);\n    }\n    thread_sum[local_idx] = ${(()=>{switch(l){case 1:return"sum_vector";case 2:return"sum_vector.x + sum_vector.y";case 4:return"sum_vector.x + sum_vector.y + sum_vector.z + sum_vector.w";default:throw new Error(`Unsupported components: ${l}`)}})()};\n    workgroupBarrier();\n\n    var sum: f32 = 0;\n    for (var i = 0u; i < ${d}; i++) {\n      sum += thread_sum[i];\n    }\n\n    if (sum == 0) {\n      for (var i: u32 = 0; i < uniforms.elements_per_thread && i + local_offset < seq_causal_length; i++) {\n        x[offset + i] = ${a.type.value}(${c}(1.0) / ${c}(seq_causal_length));\n      }\n    } else {\n      for (var i: u32 = 0; i < uniforms.elements_per_thread && i + local_offset < seq_causal_length; i++) {\n        var f32input = ${h}(x[offset + i]);\n        x[offset + i] = ${a.type.value}(exp(f32input - max_value) / sum);\n      }\n    }\n      ${i?`\n        for (var total_seq_id: u32 = seq_causal_length; total_seq_id + local_offset < uniforms.total_sequence_length; total_seq_id++) {\n          x[offset + total_seq_id] = ${a.type.value}(${c}(0));\n        }`:""};\n  }`},getRunData:()=>({outputs:[],dispatchGroup:{x:1,y:r,z:t*a},programUniforms:m})}},bo=(e,t,a,n,r,s,i,o,l)=>{let d=i+s.kvSequenceLength,c=[s.batchSize,s.numHeads,s.sequenceLength,d],u=e>1&&n,m=s.kvNumHeads?s.kvNumHeads:s.numHeads,p=u?[s.batchSize,m,d,s.headSize]:void 0,h=s.nReps?s.nReps:1,f=0===s.scale?1/Math.sqrt(s.headSize):s.scale,x=Ys(s.headSize),g=s.headSize/x,b=12,y={x:Math.ceil(d/b),y:Math.ceil(s.sequenceLength/b),z:s.batchSize*s.numHeads},v=[{type:12,data:s.sequenceLength},{type:12,data:g},{type:12,data:d},{type:12,data:s.numHeads},{type:12,data:s.headSize},{type:1,data:f},{type:12,data:i},{type:12,data:s.kvSequenceLength},{type:12,data:h}],w=u&&n&&hs.size(n.dims)>0,j=["type","type"];w&&j.push("type"),r&&j.push("type"),o&&j.push("type"),l&&j.push("type");let _=[{dims:c,dataType:t.dataType,gpuDataType:0}];u&&_.push({dims:p,dataType:t.dataType,gpuDataType:0});return{name:"AttentionProbs",shaderCache:{hint:`${x};${void 0!==r};${void 0!==n};${e}`,inputDependencies:j},getRunData:()=>({outputs:_,dispatchGroup:y,programUniforms:v}),getShaderSource:e=>{let s=ai("q",t.dataType,t.dims,x),i=[s,ai("key",a.dataType,a.dims,x)];if(w){let e=ai("past_key",n.dataType,n.dims,x);i.push(e)}r&&i.push(ai("attention_bias",r.dataType,r.dims));let d=o?ai("seq_lens",o.dataType,o.dims):void 0;d&&i.push(d);let m=l?ai("total_sequence_length_input",l.dataType,l.dims):void 0;m&&i.push(m);let f=ni("output",t.dataType,c),g=[f];u&&g.push(ni("present_key",t.dataType,p,x));let y=Ks(1,x);return`\n  const TILE_SIZE = 12u;\n\n  var<workgroup> tileQ: array<${s.type.storage}, 144>;\n  var<workgroup> tileK: array<${s.type.storage}, 144>;\n  ${e.registerUniforms([{name:"M",type:"u32"},{name:"K",type:"u32"},{name:"N",type:"u32"},{name:"num_heads",type:"u32"},{name:"head_size",type:"u32"},{name:"alpha",type:"f32"},{name:"past_sequence_length",type:"u32"},{name:"kv_sequence_length",type:"u32"},{name:"n_reps",type:"u32"}]).declareVariables(...i,...g)}\n  ${e.mainStart([b,b,1])}\n    // x holds the N and y holds the M\n    let headIdx = workgroup_id.z % uniforms.num_heads;\n    let kvHeadIdx = ${1===h?"headIdx":"headIdx / uniforms.n_reps"};\n    let kv_num_heads = ${1===h?"uniforms.num_heads":"uniforms.num_heads / uniforms.n_reps"};\n    let batchIdx = workgroup_id.z / uniforms.num_heads;\n    let m = workgroup_id.y * TILE_SIZE;\n    let n = workgroup_id.x * TILE_SIZE;\n    let sequence_length = uniforms.M;\n    var total_sequence_length = uniforms.N;\n    ${xo(d,m,!0)}\n    let absKvHeadIdx = batchIdx * kv_num_heads + kvHeadIdx;\n    let qOffset = workgroup_id.z * uniforms.M * uniforms.K + m * uniforms.K;\n    ${w&&u?"let pastKeyOffset = absKvHeadIdx * uniforms.past_sequence_length * uniforms.K;":""};\n    let kOffset = absKvHeadIdx * uniforms.kv_sequence_length * uniforms.K;\n    ${u?"let presentKeyOffset = absKvHeadIdx * uniforms.N * uniforms.K;":""}\n    var value = ${y}(0);\n    for (var w: u32 = 0u; w < uniforms.K; w += TILE_SIZE) {\n      if (global_id.y < uniforms.M && w + local_id.x < uniforms.K) {\n        tileQ[TILE_SIZE * local_id.y + local_id.x] = q[qOffset + local_id.y * uniforms.K + w + local_id.x];\n      }\n      if (n + local_id.y < uniforms.N && w + local_id.x < uniforms.K) {\n        var idx = TILE_SIZE * local_id.y + local_id.x;\n      ${w&&u?"\n              if (n + local_id.y < past_sequence_length) {\n                tileK[idx] = past_key[pastKeyOffset + (n + local_id.y) * uniforms.K + w + local_id.x];\n              } else if (n + local_id.y - past_sequence_length < uniforms.kv_sequence_length) {\n                tileK[idx] = key[kOffset + (n + local_id.y - past_sequence_length) * uniforms.K + w + local_id.x];\n              }":"\n          if (n + local_id.y < uniforms.kv_sequence_length) {\n            tileK[idx] = key[kOffset + (n + local_id.y) * uniforms.K + w + local_id.x];\n          }"}\n      ${u?"if (n + local_id.y < present_sequence_length) {\n        present_key[presentKeyOffset + (n + local_id.y) * uniforms.K + w + local_id.x] = tileK[idx];\n      }":""}\n      }\n      workgroupBarrier();\n\n      for (var k: u32 = 0u; k < TILE_SIZE && w+k < uniforms.K; k++) {\n          value += ${y}(tileQ[TILE_SIZE * local_id.y + k] * tileK[TILE_SIZE * local_id.x + k]);\n      }\n\n      workgroupBarrier();\n    }\n\n    if (global_id.y < uniforms.M && global_id.x < total_sequence_length) {\n      let headOffset = workgroup_id.z * uniforms.M * uniforms.N;\n      let outputIdx = headOffset + global_id.y * uniforms.N + global_id.x;\n      var sum: f32 = ${(()=>{switch(x){case 1:return"value";case 2:return"value.x + value.y";case 4:return"value.x + value.y + value.z + value.w";default:throw new Error(`Unsupported components: ${x}`)}})()};\n        output[outputIdx] = ${f.type.value} (sum * uniforms.alpha) + ${r?"attention_bias[outputIdx]":"0.0"};\n    }\n  }`}}},yo=(e,t,a,n,r,s,i=void 0,o=void 0)=>{let l=s+r.kvSequenceLength,d=r.nReps?r.nReps:1,c=r.vHiddenSize*d,u=e>1&&n,m=r.kvNumHeads?r.kvNumHeads:r.numHeads,p=u?[r.batchSize,m,l,r.headSize]:void 0,h=[r.batchSize,r.sequenceLength,c],f=12,x={x:Math.ceil(r.vHeadSize/f),y:Math.ceil(r.sequenceLength/f),z:r.batchSize*r.numHeads},g=[{type:12,data:r.sequenceLength},{type:12,data:l},{type:12,data:r.vHeadSize},{type:12,data:r.numHeads},{type:12,data:r.headSize},{type:12,data:c},{type:12,data:s},{type:12,data:r.kvSequenceLength},{type:12,data:d}],b=u&&n&&hs.size(n.dims)>0,y=["type","type"];b&&y.push("type"),i&&y.push("type"),o&&y.push("type");let v=[{dims:h,dataType:t.dataType,gpuDataType:0}];u&&v.push({dims:p,dataType:t.dataType,gpuDataType:0});return{name:"AttentionScore",shaderCache:{hint:`${void 0!==n};${e}`,inputDependencies:y},getRunData:()=>({outputs:v,dispatchGroup:x,programUniforms:g}),getShaderSource:e=>{let r=ai("probs",t.dataType,t.dims),s=[r,ai("v",a.dataType,a.dims)];b&&s.push(ai("past_value",n.dataType,n.dims));let l=i?ai("seq_lens",i.dataType,i.dims):void 0;i&&s.push(l);let c=o?ai("total_sequence_length_input",o.dataType,o.dims):void 0;o&&s.push(c);let m=[ni("output",t.dataType,h)];u&&m.push(ni("present_value",t.dataType,p));return`\n  const TILE_SIZE = 12u;\n  var<workgroup> tileQ: array<${r.type.value}, 144>;\n  var<workgroup> tileV: array<${r.type.value}, 144>;\n  ${e.registerUniforms([{name:"M",type:"u32"},{name:"K",type:"u32"},{name:"N",type:"u32"},{name:"num_heads",type:"u32"},{name:"head_size",type:"u32"},{name:"v_hidden_size",type:"u32"},{name:"past_sequence_length",type:"u32"},{name:"kv_sequence_length",type:"u32"},{name:"n_reps",type:"u32"}]).declareVariables(...s,...m)}\n  ${e.mainStart([f,f,1])}\n   let headIdx = workgroup_id.z % uniforms.num_heads;\n   let batchIdx = workgroup_id.z / uniforms.num_heads;\n   let kvHeadIdx = ${1===d?"headIdx":"headIdx / uniforms.n_reps"};\n   let kv_num_heads = ${1===d?"uniforms.num_heads":"uniforms.num_heads / uniforms.n_reps"};\n   let m = global_id.y;\n   let n = global_id.x;\n   let sequence_length = uniforms.M;\n   var total_sequence_length = uniforms.K;\n   ${xo(l,c,!0)}\n   let offsetA = workgroup_id.z * uniforms.M * uniforms.K + m * uniforms.K;\n   let absKvHeadIdx = batchIdx * kv_num_heads + kvHeadIdx; // kvHeadIdx is relative to the batch\n   ${b&&u?"let pastValueOffset = absKvHeadIdx * uniforms.N * uniforms.past_sequence_length + n;":""};\n   let vOffset = absKvHeadIdx * uniforms.N * uniforms.kv_sequence_length + n;\n   ${u?"let presentValueOffset = absKvHeadIdx * uniforms.N * uniforms.K + n;":""}\n   var value = ${r.type.storage}(0);\n   for (var w: u32 = 0u; w < uniforms.K; w += TILE_SIZE) {\n      if (m < uniforms.M && w + local_id.x < uniforms.K) {\n        tileQ[TILE_SIZE * local_id.y + local_id.x] = probs[offsetA + w + local_id.x];\n      }\n      if (n < uniforms.N && w + local_id.y < uniforms.K) {\n        var idx = TILE_SIZE * local_id.y + local_id.x;\n        ${b&&u?"\n        if (w + local_id.y < past_sequence_length) {\n          tileV[idx] = past_value[pastValueOffset + (w + local_id.y) * uniforms.N];\n        } else if (w + local_id.y - past_sequence_length < uniforms.kv_sequence_length) {\n          tileV[idx] = v[vOffset + (w + local_id.y - past_sequence_length) * uniforms.N];\n        }\n      ":"\n            if (w + local_id.y < uniforms.kv_sequence_length) {\n              tileV[idx] = v[vOffset + (w + local_id.y) * uniforms.N];\n            }"}\n        ${u?"\n            if (w + local_id.y < present_sequence_length) {\n          present_value[presentValueOffset + (w + local_id.y) * uniforms.N] = tileV[idx];\n        }":""}\n      }\n     workgroupBarrier();\n     for (var k: u32 = 0u; k < TILE_SIZE && w+k < total_sequence_length; k++) {\n       value += tileQ[TILE_SIZE * local_id.y + k] * tileV[TILE_SIZE * k + local_id.x];\n     }\n     workgroupBarrier();\n   }\n\n   // we need to transpose output from BNSH_v to BSND_v\n   if (m < uniforms.M && n < uniforms.N) {\n     let outputIdx = batchIdx * uniforms.M * uniforms.v_hidden_size + m * uniforms.v_hidden_size\n       + headIdx * uniforms.N + n;\n     output[outputIdx] = value;\n   }\n  }`}}},vo=(e,t,a,n,r,s,i,o,l,d,c=void 0,u=void 0)=>{let m=Math.min(e.outputCount,1+(i?1:0)+(o?1:0)),p=m>1?d.pastSequenceLength:0,h=p+d.kvSequenceLength,f=l&&hs.size(l.dims)>0?l:void 0,x=[t,a];m>1&&i&&hs.size(i.dims)>0&&x.push(i),f&&x.push(f),c&&x.push(c),u&&x.push(u);let g=e.compute(bo(m,t,a,i,f,d,p,c,u),{inputs:x,outputs:m>1?[-1,1]:[-1]})[0];e.compute(go(g,d.batchSize,d.numHeads,p,d.sequenceLength,h,c,u),{inputs:c&&u?[g,c,u]:[g],outputs:[]});let b=[g,n];m>1&&o&&hs.size(o.dims)>0&&b.push(o),c&&b.push(c),u&&b.push(u),e.compute(yo(m,g,n,o,d,p,c,u),{inputs:b,outputs:m>1?[0,2]:[0]})},wo=(e,t)=>{let a=[t.batchSize,t.numHeads,t.sequenceLength,t.headSize],n=t.sequenceLength,r=t.inputHiddenSize,s=t.headSize,i=12,o={x:Math.ceil(t.headSize/i),y:Math.ceil(t.sequenceLength/i),z:t.batchSize*t.numHeads},l=[e.inputs[0],e.inputs[1],e.inputs[2]],d=[{type:12,data:n},{type:12,data:r},{type:12,data:s},{type:12,data:t.numHeads},{type:12,data:t.headSize},{type:12,data:t.hiddenSize},{type:12,data:t.hiddenSize+t.hiddenSize+t.vHiddenSize}];return e.compute({name:"AttentionPrepare",shaderCache:{inputDependencies:["type","type","type"]},getRunData:()=>({outputs:[{dims:a,dataType:e.inputs[0].dataType,gpuDataType:0},{dims:a,dataType:e.inputs[0].dataType,gpuDataType:0},{dims:a,dataType:e.inputs[0].dataType,gpuDataType:0}],dispatchGroup:o,programUniforms:d}),getShaderSource:e=>{let t=ni("output_q",l[0].dataType,a),n=ni("output_k",l[0].dataType,a),r=ni("output_v",l[0].dataType,a),s=ai("input",l[0].dataType,l[0].dims),o=ai("weight",l[1].dataType,l[1].dims),d=ai("bias",l[2].dataType,l[2].dims),c=s.type.storage;return`\n  const TILE_SIZE = 12u;\n  var<workgroup> tileInput: array<${c}, 144>;\n  var<workgroup> tileWeightQ: array<${c}, 144>;\n  var<workgroup> tileWeightK: array<${c}, 144>;\n  var<workgroup> tileWeightV: array<${c}, 144>;\n  ${e.registerUniforms([{name:"M",type:"u32"},{name:"K",type:"u32"},{name:"N",type:"u32"},{name:"num_heads",type:"u32"},{name:"head_size",type:"u32"},{name:"hidden_size",type:"u32"},{name:"ldb",type:"u32"}]).declareVariables(s,o,d,t,n,r)}\n  ${e.mainStart([i,i,1])}\n    let batchIndex = workgroup_id.z / uniforms.num_heads;\n    let headNumber = workgroup_id.z % uniforms.num_heads;\n    let m = global_id.y;\n    let n = global_id.x;\n\n    let inputOffset = batchIndex * (uniforms.M * uniforms.K) + m * uniforms.K;\n    let biasOffsetQ = headNumber * uniforms.head_size;\n    let biasOffsetK = uniforms.hidden_size + biasOffsetQ;\n    let biasOffsetV = uniforms.hidden_size + biasOffsetK;\n\n    var valueQ = ${c}(0);\n    var valueK = ${c}(0);\n    var valueV = ${c}(0);\n    for (var w: u32 = 0u; w < uniforms.K; w += TILE_SIZE) {\n      if (m < uniforms.M && w + local_id.x < uniforms.K) {\n        tileInput[TILE_SIZE * local_id.y + local_id.x] = input[inputOffset + w + local_id.x];\n      }\n      if (n < uniforms.N && w + local_id.y < uniforms.K) {\n        let offset = n + (w + local_id.y) * uniforms.ldb;\n        tileWeightQ[TILE_SIZE * local_id.y + local_id.x] = weight[biasOffsetQ + offset];\n        tileWeightK[TILE_SIZE * local_id.y + local_id.x] = weight[biasOffsetK + offset];\n        tileWeightV[TILE_SIZE * local_id.y + local_id.x] = weight[biasOffsetV + offset];\n      }\n      workgroupBarrier();\n      for (var k: u32 = 0u; k<TILE_SIZE && w+k < uniforms.K; k++) {\n        let inputTileOffset = TILE_SIZE * local_id.y + k;\n        let weightTileOffset = TILE_SIZE * k + local_id.x;\n        valueQ += tileInput[inputTileOffset] * tileWeightQ[weightTileOffset];\n        valueK += tileInput[inputTileOffset] * tileWeightK[weightTileOffset];\n        valueV += tileInput[inputTileOffset] * tileWeightV[weightTileOffset];\n      }\n\n      workgroupBarrier();\n    }\n\n    let headOffset = (m * uniforms.N + n) % uniforms.head_size;\n    valueQ += bias[headOffset + biasOffsetQ];\n    valueK += bias[headOffset + biasOffsetK];\n    valueV += bias[headOffset + biasOffsetV];\n\n    let offset = workgroup_id.z * uniforms.M * uniforms.N;\n    if (m < uniforms.M && n < uniforms.N) {\n      let outputIdx = offset + m * uniforms.N + n;\n      output_q[outputIdx] = valueQ;\n      output_k[outputIdx] = valueK;\n      output_v[outputIdx] = valueV;\n    }\n  }`}},{inputs:l,outputs:[-1,-1,-1]})},jo=(e,t)=>{let a=fo(e.inputs,t),[n,r,s]=wo(e,a);return vo(e,n,r,s,e.inputs[4],void 0,void 0,void 0,e.inputs[5],a)}}),vp=Ln(()=>{lr(),rp(),op(),pp(),hp(),_o=(e,t)=>{if(!e||5!==e.length)throw new Error("BatchNormalization requires 5 inputs");let a=(e,t,a)=>{let n=t.length;if(n!==e.length)throw new Error(`${a}: num dimensions != ${n}`);t.forEach((t,n)=>{if(t!==e[n])throw new Error(`${a}: dim[${n}] do not match`)})};if(e[0].dims.length>1){let n="NHWC"===t.format?t.spatial?e[0].dims.slice(-1):e[0].dims.slice(-1).concat(e[0].dims.slice(1,e[0].dims.length-1)):e[0].dims.slice(1,t.spatial?2:void 0);a(e[1].dims,n,"Invalid input scale"),a(e[2].dims,n,"Invalid input B"),a(e[3].dims,n,"Invalid input mean"),a(e[4].dims,n,"Invalid input var")}else a(e[1].dims,[1],"Invalid input scale"),a(e[2].dims,[1],"Invalid input B"),a(e[3].dims,[1],"Invalid input mean"),a(e[4].dims,[1],"Invalid input var")},ko=(e,t)=>{let{epsilon:a,spatial:n,format:r}=t,s=e[0].dims,i=n?Ys(s[s.length-1]):1,o="NHWC"===r&&s.length>1?i:1,l=hs.size(s)/i,d=n,c=d?s.length:s,u=ai("x",e[0].dataType,e[0].dims,i),m=ai("scale",e[1].dataType,e[1].dims,o),p=ai("bias",e[2].dataType,e[2].dims,o),h=ai("inputMean",e[3].dataType,e[3].dims,o),f=ai("inputVar",e[4].dataType,e[4].dims,o),x=ni("y",e[0].dataType,c,i);return{name:"BatchNormalization",shaderCache:{hint:`${t.epsilon}_${t.format}_${n}_${i}`,inputDependencies:d?["rank","type","type","type","type"]:void 0},getShaderSource:e=>`\n  const epsilon = ${a};\n  ${e.registerUniform("outputSize","u32").declareVariables(u,m,p,h,f,x)}\n  ${e.mainStart()}\n  ${e.guardAgainstOutOfBoundsWorkgroupSizes("uniforms.outputSize")}\n    var outputIndices = ${x.offsetToIndices(`global_idx * ${i}`)};\n    ${(()=>{let e="";if(n)e=`let cOffset = ${1===s.length?"0u":"NHWC"===r?`outputIndices[${s.length-1}] / ${i}`:"outputIndices[1]"};`;else if("NCHW"===r)e=`\n            ${x.indicesSet("outputIndices","0","0")}\n            let cOffset = ${x.indicesToOffset("outputIndices")};`;else{e=`var cIndices = ${m.type.indices}(0);\n                       cIndices[0] = outputIndices[${s.length-1}];`;for(let t=1;t<m.rank;t++)e+=`cIndices[${t}] = outputIndices[${t}];`;e+=`let cOffset = ${m.indicesToOffset("cIndices")};`}return e})()}\n    let scale = ${m.getByOffset("cOffset")};\n    let bias = ${p.getByOffset("cOffset")};\n    let inputMean = ${h.getByOffset("cOffset")};\n    let inputVar = ${f.getByOffset("cOffset")};\n    let x = ${u.getByOffset("global_idx")};\n    let value = (x - inputMean) * inverseSqrt(inputVar + epsilon) * scale + bias;\n    ${x.setByOffset("global_idx","value")}\n  }`,getRunData:()=>({outputs:[{dims:e[0].dims,dataType:e[0].dataType}],dispatchGroup:{x:Math.ceil(l/64)},programUniforms:d?[{type:12,data:l},...Xs(s)]:[{type:12,data:l}]})}},No=e=>Us(e),$o=(e,t)=>{let{inputs:a,outputCount:n}=e,r=No({...t,outputCount:n});if(un.webgpu.validateInputContent&&_o(a,r),t.trainingMode)throw new Error("BatchNormalization trainingMode is not supported yet.");e.compute(ko(a,r))}}),wp=Ln(()=>{op(),hp(),Co=e=>{if(3!==e[0].dims.length)throw new Error("input should have 3 dimensions");if(![320,640,1280].includes(e[0].dims[2]))throw new Error("number of channels should be 320, 640 or 1280");if(1!==e[1].dims.length)throw new Error("bias is expected to have 1 dimensions");if(e[0].dims[2]!==e[1].dims[0])throw new Error("last dimension of input and bias are not the same")},So=e=>{let t=e[0].dims,a=e[0].dims[2],n=hs.size(t)/4,r=e[0].dataType,s=ai("input",r,t,4),i=ai("bias",r,[a],4),o=ai("residual",r,t,4),l=ni("output",r,t,4);return{name:"BiasAdd",getRunData:()=>({outputs:[{dims:t,dataType:e[0].dataType}],dispatchGroup:{x:Math.ceil(n/64)}}),getShaderSource:e=>`\n  const channels = ${a}u / 4;\n  ${e.declareVariables(s,i,o,l)}\n\n  ${e.mainStart()}\n    ${e.guardAgainstOutOfBoundsWorkgroupSizes(n)}\n    let value = ${s.getByOffset("global_idx")}\n      + ${i.getByOffset("global_idx % channels")} + ${o.getByOffset("global_idx")};\n    ${l.setByOffset("global_idx","value")}\n  }`}},Mo=e=>{Co(e.inputs),e.compute(So(e.inputs))}}),jp=Ln(()=>{rp(),op(),pp(),hp(),zo=(e,t,a,n,r,s,i)=>{let o=Math.ceil(t/4),l="";l="string"==typeof r?`${r}(a)`:r("a");let d=ai("inputData",a,[o],4),c=ni("outputData",n,[o],4),u=[{name:"vec_size",type:"u32"}];return i&&u.push(...i),`\n      ${e.registerUniforms(u).declareVariables(d,c)}\n\n  ${s??""}\n\n  ${e.mainStart()}\n    ${e.guardAgainstOutOfBoundsWorkgroupSizes("uniforms.vec_size")}\n\n    let a = ${d.getByOffset("global_idx")};\n    ${c.setByOffset("global_idx",l)}\n  }`},To=(e,t,a,n,r,s=e.dataType,i,o)=>{let l=[{type:12,data:Math.ceil(hs.size(e.dims)/4)}];return i&&l.push(...i),{name:t,shaderCache:{hint:r,inputDependencies:["type"]},getShaderSource:t=>zo(t,hs.size(e.dims),e.dataType,s,a,n,o),getRunData:t=>({outputs:[{dims:e.dims,dataType:s}],dispatchGroup:{x:Math.ceil(hs.size(t[0].dims)/64/4)},programUniforms:l})}},Eo=e=>{e.compute(To(e.inputs[0],"Abs","abs"))},Ao=e=>{e.compute(To(e.inputs[0],"Acos","acos"))},Io=e=>{e.compute(To(e.inputs[0],"Acosh","acosh"))},Oo=e=>{e.compute(To(e.inputs[0],"Asin","asin"))},Ro=e=>{e.compute(To(e.inputs[0],"Asinh","asinh"))},Vo=e=>{e.compute(To(e.inputs[0],"Atan","atan"))},Po=e=>{e.compute(To(e.inputs[0],"Atanh","atanh"))},Do=e=>Us(e),Bo=(e,t)=>{let a;switch(t.to){case 10:a="vec4<f16>";break;case 1:a="vec4<f32>";break;case 12:a="vec4<u32>";break;case 6:a="vec4<i32>";break;case 9:a="vec4<bool>";break;default:throw new RangeError(`not supported type (specified in attribute 'to' from 'Cast' operator): ${t.to}`)}e.compute(To(e.inputs[0],"Cast",a,void 0,t.cacheKey,t.to))},Lo=e=>{let t,a,n=e.length>=2&&0!==e[1].data,r=e.length>=3&&0!==e[2].data;switch(e[0].dataType){case 1:t=n?e[1].getFloat32Array()[0]:-34028234663852886e22,a=r?e[2].getFloat32Array()[0]:34028234663852886e22;break;case 10:t=n?e[1].getUint16Array()[0]:64511,a=r?e[2].getUint16Array()[0]:31743;break;default:throw new Error("Unsupport data type")}return Us({min:t,max:a})},Fo=(e,t)=>{let a=t||Lo(e.inputs),n=Ks(e.inputs[0].dataType);e.compute(To(e.inputs[0],"Clip",e=>`clamp(${e}, vec4<${n}>(uniforms.min), vec4<${n}>(uniforms.max))`,void 0,a.cacheKey,void 0,[{type:e.inputs[0].dataType,data:a.min},{type:e.inputs[0].dataType,data:a.max}],[{name:"min",type:n},{name:"max",type:n}]),{inputs:[0]})},Wo=e=>{e.compute(To(e.inputs[0],"Ceil","ceil"))},Uo=e=>{e.compute(To(e.inputs[0],"Cos","cos"))},qo=e=>{e.compute(To(e.inputs[0],"Cosh","cosh"))},Ho=e=>Us(e),Go=(e,t)=>{let a=Ks(e.inputs[0].dataType);e.compute(To(e.inputs[0],"Elu",e=>`elu_vf32(${e})`,`\n  const elu_alpha_ = ${a}(${t.alpha});\n\n  fn elu_f32(a: ${a}) -> ${a} {\n  return select((exp(a) - 1.0) * elu_alpha_, a, a >= 0.0);\n  }\n\n  fn elu_vf32(v: vec4<${a}>) -> vec4<${a}> {\n  return vec4(elu_f32(v.x), elu_f32(v.y), elu_f32(v.z), elu_f32(v.w));\n  }`,t.cacheKey))},Ko=(e="f32")=>`\nconst r0: ${e} = 0.3275911;\nconst r1: ${e} = 0.254829592;\nconst r2: ${e} = -0.284496736;\nconst r3: ${e} = 1.421413741;\nconst r4: ${e} = -1.453152027;\nconst r5: ${e} = 1.061405429;\n\nfn erf_vf32(v: vec4<${e}>) -> vec4<${e}> {\n  let absv = abs(v);\n  let x = 1.0 / (1.0 + r0 * absv);\n  return sign(v) * (1.0 - ((((r5 * x + r4) * x + r3) * x + r2) * x + r1) * x * exp(-absv * absv));\n}`,Xo=e=>{let t=Ks(e.inputs[0].dataType);e.compute(To(e.inputs[0],"Erf",e=>`erf_vf32(${e})`,Ko(t)))},Yo=e=>{e.compute(To(e.inputs[0],"Exp","exp"))},Zo=e=>{e.compute(To(e.inputs[0],"Floor","floor"))},Qo=e=>{let t=Ks(e.inputs[0].dataType);e.compute(To(e.inputs[0],"Gelu",e=>`0.5 * ${e} * (1.0 + erf_vf32(${e} * 0.7071067811865475))`,Ko(t)))},Jo=(e,t)=>{let a=Ks(e.inputs[0].dataType);e.compute(To(e.inputs[0],"LeakyRelu",e=>`select(leaky_relu_alpha_ * ${e}, ${e}, ${e} >= vec4<${a}>(0.0))`,`const leaky_relu_alpha_ = ${a}(${t.alpha});`,t.cacheKey))},el=e=>{e.compute(To(e.inputs[0],"Not",e=>`!${e}`))},tl=e=>{e.compute(To(e.inputs[0],"Neg",e=>`-${e}`))},al=e=>{e.compute(To(e.inputs[0],"Reciprocal",e=>`1.0/${e}`))},nl=e=>{let t=Ks(e.inputs[0].dataType);e.compute(To(e.inputs[0],"Relu",e=>`select(vec4<${t}>(0.0), ${e}, ${e} > vec4<${t}>(0.0))`))},rl=e=>{e.compute(To(e.inputs[0],"Sigmoid",e=>`(1.0 / (1.0 + exp(-${e})))`))},sl=e=>Us(e),il=(e,t)=>{let a=Ks(e.inputs[0].dataType);e.compute(To(e.inputs[0],"HardSigmoid",e=>`max(vec4<${a}>(0.0), min(vec4<${a}>(1.0), ${t.alpha} * ${e} + vec4<${a}>(${t.beta})))`,void 0,t.cacheKey))},ol=e=>{e.compute(To(e.inputs[0],"Sin","sin"))},ll=e=>{e.compute(To(e.inputs[0],"Sinh","sinh"))},dl=e=>{e.compute(To(e.inputs[0],"Sqrt","sqrt"))},cl=e=>{e.compute(To(e.inputs[0],"Tan","tan"))},ul=e=>`sign(${e}) * (1 - exp(-2 * abs(${e}))) / (1 + exp(-2 * abs(${e})))`,ml=e=>{e.compute(To(e.inputs[0],"Tanh",ul))},pl=(e="f32")=>`\nconst fast_gelu_a: ${e} = 0.5;\nconst fast_gelu_b: ${e} = 0.7978845608028654;\nconst fast_gelu_c: ${e} = 0.035677408136300125;\n\nfn tanh_v(v: vec4<${e}>) -> vec4<${e}> {\n  return ${ul("v")};\n}\n`,hl=e=>`(fast_gelu_a + fast_gelu_a * tanh_v(${e} * (fast_gelu_c * ${e} * ${e} + fast_gelu_b))) * ${e}`,fl=e=>{let t=Ks(e.inputs[0].dataType);e.compute(To(e.inputs[0],"FastGelu",hl,pl(t),void 0,e.inputs[0].dataType))},xl=(e,t)=>{let a=Ks(e.inputs[0].dataType);return e.compute(To(e.inputs[0],"ThresholdedRelu",e=>`select(vec4<${a}>(0.0), ${e}, ${e} > thresholded_relu_alpha_)`,`const thresholded_relu_alpha_ = vec4<${a}>(${t.alpha});`,t.cacheKey)),0},gl=e=>{e.compute(To(e.inputs[0],"Log","log"))},bl=(e,t)=>`\nconst alpha = vec4<${e}>(${t});\nconst one = ${e}(1.0);\nconst zero = ${e}(0.0);\n\nfn quick_gelu_impl(x: vec4<${e}>) -> vec4<${e}> {\n  let v = x *alpha;\n  var x1 : vec4<${e}>;\n  for (var i = 0; i < 4; i = i + 1) {\n    if (v[i] >= zero) {\n      x1[i] = one / (one + exp(-v[i]));\n    } else {\n      x1[i] = one - one / (one + exp(v[i]));\n    }\n  }\n  return x * x1;\n}\n`,yl=e=>`quick_gelu_impl(${e})`,vl=(e,t)=>{let a=Ks(e.inputs[0].dataType);e.compute(To(e.inputs[0],"QuickGelu",yl,bl(a,t.alpha),t.cacheKey,e.inputs[0].dataType))}}),_p=Ln(()=>{op(),hp(),jp(),wl=e=>{if(3!==e[0].dims.length)throw new Error("input should have 3 dimensions");if(![2560,5120,10240].includes(e[0].dims[2]))throw new Error("hidden state should be 2560, 5120 or 10240");if(1!==e[1].dims.length)throw new Error("bias is expected to have 1 dimensions");if(e[0].dims[2]!==e[1].dims[0])throw new Error("last dimension of input and bias are not the same")},jl=e=>{let t=e[0].dims.slice();t[2]=t[2]/2;let a=ai("input",e[0].dataType,e[0].dims,4),n=ai("bias",e[0].dataType,[e[0].dims[2]],4),r=ni("output",e[0].dataType,t,4),s=hs.size(t)/4,i=Gs(e[0].dataType);return{name:"BiasSplitGelu",getRunData:()=>({outputs:[{dims:t,dataType:e[0].dataType}],dispatchGroup:{x:Math.ceil(s/64)}}),getShaderSource:t=>`\n  const M_SQRT2 = sqrt(2.0);\n  const halfChannels = ${e[0].dims[2]/4/2}u;\n\n  ${t.declareVariables(a,n,r)}\n\n  ${Ko(i)}\n\n  ${t.mainStart()}\n    ${t.guardAgainstOutOfBoundsWorkgroupSizes(s)}\n    let biasIdx = global_idx % halfChannels;\n    let batchIndex = global_idx / halfChannels;\n    let inputOffset = biasIdx + batchIndex * halfChannels * 2;\n    let valueLeft = input[inputOffset] + bias[biasIdx];\n    let valueRight = input[inputOffset + halfChannels] + bias[biasIdx + halfChannels];\n    let geluRight = valueRight * 0.5 * (erf_vf32(valueRight / M_SQRT2) + 1);\n\n    ${r.setByOffset("global_idx","valueLeft * geluRight")}\n  }`}},_l=e=>{wl(e.inputs),e.compute(jl(e.inputs))}}),kp=Ln(()=>{rp(),op(),hp(),kl=(e,t,a,n,r,s,i,o,l,d,c,u)=>{let m,p;"string"==typeof o?m=p=(e,t)=>`${o}((${e}),(${t}))`:"function"==typeof o?m=p=o:(m=o.scalar,p=o.vector);let h,f=ni("outputData",c,n.length,4),x=ai("aData",l,t.length,4),g=ai("bData",d,a.length,4);if(r)if(s){let e=1===hs.size(t),n=1===hs.size(a),r=t.length>0&&t[t.length-1]%4==0,s=a.length>0&&a[a.length-1]%4==0;h=e||n?f.setByOffset("global_idx",p(e?`${x.type.value}(${x.getByOffset("0")}.x)`:x.getByOffset("global_idx"),n?`${g.type.value}(${g.getByOffset("0")}.x)`:g.getByOffset("global_idx"))):`\n            let outputIndices = ${f.offsetToIndices("global_idx * 4u")};\n            let offsetA = ${x.broadcastedIndicesToOffset("outputIndices",f)};\n            let offsetB = ${g.broadcastedIndicesToOffset("outputIndices",f)};\n            ${f.setByOffset("global_idx",p(i||r?x.getByOffset("offsetA / 4u"):`${x.type.value}(${x.getByOffset("offsetA / 4u")}[offsetA % 4u])`,i||s?g.getByOffset("offsetB / 4u"):`${g.type.value}(${g.getByOffset("offsetB / 4u")}[offsetB % 4u])`))}\n          `}else h=f.setByOffset("global_idx",p(x.getByOffset("global_idx"),g.getByOffset("global_idx")));else{if(!s)throw new Error("no necessary to use scalar implementation for element-wise binary op implementation.");let e=(e,t,a="")=>{let n=`aData[indexA${t}][componentA${t}]`,r=`bData[indexB${t}][componentB${t}]`;return`\n            let outputIndices${t} = ${f.offsetToIndices(`global_idx * 4u + ${t}u`)};\n            let offsetA${t} = ${x.broadcastedIndicesToOffset(`outputIndices${t}`,f)};\n            let offsetB${t} = ${g.broadcastedIndicesToOffset(`outputIndices${t}`,f)};\n            let indexA${t} = offsetA${t} / 4u;\n            let indexB${t} = offsetB${t} / 4u;\n            let componentA${t} = offsetA${t} % 4u;\n            let componentB${t} = offsetB${t} % 4u;\n            ${e}[${t}] = ${a}(${m(n,r)});\n          `};h=9===c?`\n            var data = vec4<u32>(0);\n            ${e("data",0,"u32")}\n            ${e("data",1,"u32")}\n            ${e("data",2,"u32")}\n            ${e("data",3,"u32")}\n            outputData[global_idx] = dot(vec4<u32>(0x1, 0x100, 0x10000, 0x1000000), vec4<u32>(data));`:`\n            ${e("outputData[global_idx]",0)}\n            ${e("outputData[global_idx]",1)}\n            ${e("outputData[global_idx]",2)}\n            ${e("outputData[global_idx]",3)}\n          `}return`\n        ${e.registerUniform("vec_size","u32").declareVariables(x,g,f)}\n\n        ${u??""}\n\n        ${e.mainStart()}\n        ${e.guardAgainstOutOfBoundsWorkgroupSizes("uniforms.vec_size")}\n        ${h}\n      }`},Nl=(e,t,a,n,r,s,i=a.dataType)=>{let o=a.dims.map(e=>Number(e)??1),l=n.dims.map(e=>Number(e)??1),d=!hs.areEqual(o,l),c=o,u=hs.size(o),m=!1,p=!1,h=[d];if(d){let e=ps.calcShape(o,l,!1);if(!e)throw new Error("Can't perform binary op on the given tensors");c=e.slice(),u=hs.size(c);let t=1===hs.size(o),a=1===hs.size(l),n=o.length>0&&o[o.length-1]%4==0,r=l.length>0&&l[l.length-1]%4==0;h.push(t),h.push(a),h.push(n),h.push(r);let s=1;for(let i=1;i<c.length;i++){let e=o[o.length-i];if(e!==l[l.length-i])break;s*=e}s%4==0?(p=!0,m=!0):(t||a||n||r)&&(m=!0)}else m=!0;return h.push(m),{name:e,shaderCache:{hint:t+h.map(e=>e.toString()).join("_"),inputDependencies:["rank","rank"]},getShaderSource:e=>kl(e,o,l,c,m,d,p,r,a.dataType,n.dataType,i,s),getRunData:()=>({outputs:[{dims:c,dataType:i}],dispatchGroup:{x:Math.ceil(u/64/4)},programUniforms:[{type:12,data:Math.ceil(hs.size(c)/4)},...Xs(o,l,c)]})}},$l=(e,t,a,n,r,s)=>{e.compute(Nl(t,r??"",e.inputs[0],e.inputs[1],a,n,s))},Cl=e=>{$l(e,"Add",(e,t)=>`${e}+${t}`)},Sl=e=>{$l(e,"Div",(e,t)=>`${e}/${t}`)},Ml=e=>{$l(e,"Equal",{scalar:(e,t)=>`u32(${e}==${t})`,vector:(e,t)=>`vec4<u32>(${e}==${t})`},void 0,void 0,9)},zl=e=>{$l(e,"Mul",(e,t)=>`${e}*${t}`)},Tl=e=>{let t=ai("input",e.inputs[0].dataType,e.inputs[0].dims).type.value;$l(e,"Pow",{scalar:(e,t)=>`pow_custom(${e},${t})`,vector:(e,t)=>`pow_vector_custom(${e},${t})`},`\n    fn pow_custom(a : ${t}, b : ${t}) -> ${t} {\n      if (b == ${t}(0.0)) {\n        return ${t}(1.0);\n      } else if (a < ${t}(0.0) && f32(b) != floor(f32(b))) {\n        return ${t}(pow(f32(a), f32(b))); // NaN\n      }\n      return select(sign(a), ${t}(1.0), round(f32(abs(b) % ${t}(2.0))) != 1.0) * ${t}(${"i32"===t?"round":""}(pow(f32(abs(a)), f32(b))));\n    }\n    fn pow_vector_custom(a : vec4<${t}>, b : vec4<${t}>) -> vec4<${t}> {\n      // TODO: implement vectorized pow\n      return vec4<${t}>(pow_custom(a.x, b.x), pow_custom(a.y, b.y), pow_custom(a.z, b.z), pow_custom(a.w, b.w));\n    }\n      `)},El=e=>{$l(e,"Sub",(e,t)=>`${e}-${t}`)},Al=e=>{$l(e,"Greater",{scalar:(e,t)=>`u32(${e}>${t})`,vector:(e,t)=>`vec4<u32>(${e}>${t})`},void 0,void 0,9)},Il=e=>{$l(e,"Less",{scalar:(e,t)=>`u32(${e}<${t})`,vector:(e,t)=>`vec4<u32>(${e}<${t})`},void 0,void 0,9)},Ol=e=>{$l(e,"GreaterOrEqual",{scalar:(e,t)=>`u32(${e}>=${t})`,vector:(e,t)=>`vec4<u32>(${e}>=${t})`},void 0,void 0,9)},Rl=e=>{$l(e,"LessOrEqual",{scalar:(e,t)=>`u32(${e}<=${t})`,vector:(e,t)=>`vec4<u32>(${e}<=${t})`},void 0,void 0,9)}}),Np=Ln(()=>{rp(),op(),pp(),hp(),Vl=(e,t)=>{if(!e||e.length<1)throw new Error("too few inputs");let a=e[0],n=a.dataType,r=a.dims.length;e.forEach((e,s)=>{if(0!==s){if(e.dataType!==n)throw new Error("input tensors should be one type");if(e.dims.length!==r)throw new Error("input tensors should have the same shape");e.dims.forEach((e,n)=>{if(n!==t&&e!==a.dims[n])throw new Error("non concat dimensions must match")})}})},Pl=(e,t)=>`\n  fn calculateInputIndex(index: u32) -> u32 {\n    let sizeInConcatAxis = array<u32, ${e}u>(${t});\n    for (var i: u32 = 0u; i < ${e}; i += 1u ) {\n      if (index < sizeInConcatAxis[i]) {\n        return i;\n      }\n    }\n    return ${e}u;\n  }`,Dl=(e,t)=>{let a=e.length,n=[];for(let r=0;r<a;++r){let s=t.setByOffset("global_idx",e[r].getByIndices("indices"));1===a?n.push(s):0===r?n.push(`if (inputIndex == ${r}u) { ${s} }`):r===a-1?n.push(`else { ${s} }`):n.push(`else if (inputIndex == ${r}) { ${s} }`)}return n.join("\n")},Bl=(e,t,a,n)=>{let r=hs.size(a),s=new Array(e.length),i=new Array(e.length),o=0,l=[],d=[],c=[{type:12,data:r}];for(let h=0;h<e.length;++h)o+=e[h].dims[t],s[h]=o,d.push(e[h].dims.length),i[h]=ai(`input${h}`,n,d[h]),l.push("rank"),c.push({type:12,data:s[h]});for(let h=0;h<e.length;++h)c.push(...Xs(e[h].dims));c.push(...Xs(a));let u=ni("output",n,a.length),m=u.indicesGet("indices",t),p=Array.from(Array(s.length).keys()).map(e=>`uniforms.sizeInConcatAxis${e}`).join(",");return{name:"Concat",shaderCache:{hint:`${t}`,inputDependencies:l},getRunData:()=>({outputs:[{dims:a,dataType:n}],dispatchGroup:{x:Math.ceil(r/64)},programUniforms:c}),getShaderSource:t=>`\n\n  ${(()=>{t.registerUniform("outputSize","u32");for(let a=0;a<e.length;a++)t.registerUniform(`sizeInConcatAxis${a}`,"u32");return t.declareVariables(...i,u)})()}\n\n  ${Pl(s.length,p)}\n\n  ${t.mainStart()}\n    ${t.guardAgainstOutOfBoundsWorkgroupSizes("uniforms.outputSize")}\n\n    var indices = ${u.offsetToIndices("global_idx")};\n\n    let inputIndex = calculateInputIndex(${m});\n    if (inputIndex != 0u) {\n      let sizeInConcatAxis = array<u32, ${s.length}u>(${p});\n      ${m} -= sizeInConcatAxis[inputIndex - 1u];\n    }\n\n    ${Dl(i,u)}\n  }`}},Ll=(e,t)=>{let a=e.inputs,n=a[0].dims,r=hs.normalizeAxis(t.axis,n.length);Vl(a,r);let s=n.slice();s[r]=a.reduce((e,t)=>e+(t.dims.length>r?t.dims[r]:0),0);let i=a.filter(e=>hs.size(e.dims)>0);e.compute(Bl(i,r,s,a[0].dataType),{inputs:i})},Fl=e=>Us({axis:e.axis})}),$p=Ln(()=>{rp(),op(),Wl=(e,t,a="f32")=>{switch(e.activation){case"Relu":return`value = max(value, ${t}(0.0));`;case"Sigmoid":return`value = (${t}(1.0) / (${t}(1.0) + exp(-value)));`;case"Clip":return`value = clamp(value, ${t}(${a}(uniforms.clip_min)), ${t}(${a}(uniforms.clip_max)));`;case"HardSigmoid":return`value = max(${t}(0.0), min(${t}(1.0), ${a}(uniforms.alpha) * value + ${a}(uniforms.beta)));`;case"LeakyRelu":return`value = select(${a}(uniforms.alpha) * value, value, value >= ${t}(0.0));`;case"Tanh":return"let e2x = exp(-2.0 * abs(value));\n              value = sign(value) * (1.0 - e2x) / (1.0 + e2x);\n        ";case"":return"";default:throw new Error(`Unsupported activation ${e.activation}`)}},Ul=(e,t)=>{"Clip"===e.activation?t.push({type:1,data:e.clipMax},{type:1,data:e.clipMin}):"HardSigmoid"===e.activation?t.push({type:1,data:e.alpha},{type:1,data:e.beta}):"LeakyRelu"===e.activation&&t.push({type:1,data:e.alpha})},ql=(e,t)=>{"Clip"===e.activation?t.push({name:"clip_max",type:"f32"},{name:"clip_min",type:"f32"}):"HardSigmoid"===e.activation?t.push({name:"alpha",type:"f32"},{name:"beta",type:"f32"}):"LeakyRelu"===e.activation&&t.push({name:"alpha",type:"f32"})},Hl=e=>{let t=e?.activation||"";if("HardSigmoid"===t){let[a,n]=e?.activation_params||[.2,.5];return{activation:t,alpha:a,beta:n}}if("Clip"===t){let[a,n]=e?.activation_params||[gs,bs];return{activation:t,clipMax:n,clipMin:a}}if("LeakyRelu"===t){let[a]=e?.activation_params||[.01];return{activation:t,alpha:a}}return{activation:t}}}),Cp=Ln(()=>{Gl=(e,t)=>{switch(e){case 1:return t;case 2:return`vec2<${t}>`;case 3:return`vec3<${t}>`;case 4:return`vec4<${t}>`;default:throw new Error(`${e}-component is not supported.`)}},Kl=e=>`\n      ${e?"value = value + getBiasByOutputCoords(coords);":""}\n      `}),Sp=Ln(()=>{Xl=e=>`\nfn getIndexFromCoords4D(coords : vec4<i32>, shape : vec4<i32>) -> i32 {\n  return dot(coords, vec4<i32>(\n      shape.y * shape.z * shape.w, shape.z * shape.w, shape.w, 1));\n}\nfn getOutputIndexFromCoords(coords : vec4<i32>) -> i32 {\n  return dot(coords, vec4<i32>(\n    i32(${e}.x), i32(${e}.y), i32(${e}.z), 1));\n}\n`}),Mp=Ln(()=>{rp(),op(),hp(),$p(),Yl=(e,t,a,n,r)=>{let s=n-a;return`\n      ${Array.from({length:a}).map((a,i)=>`\n      if (${ei(t.shape,i,t.rank)} != 1) {\n        ${t.indicesSet(e,i,ei(r,i+s,n))}\n      } else {\n        ${t.indicesSet(e,i,0)}\n      }`).join("")}\n`},Zl=(e,t,a,n,r=!1,s)=>{let i=e[0].dims,o=e[1].dims,l=i[i.length-2],d=o[o.length-1],c=i[i.length-1],u=Ys(d),m=Ys(c),p=Ys(l),h=hs.size(a)/u/p,f=e.length>2,x=n?n.slice(0,-2):a.slice(0,-2),g=[hs.size(x),l,d],b=[{type:12,data:h},{type:12,data:l},{type:12,data:d},{type:12,data:c}];Ul(t,b),b.push(...Xs(x,i,o)),f&&b.push(...Xs(e[2].dims)),b.push(...Xs(g));return{name:"MatMulNaive",shaderCache:{hint:`${t.activation};${u};${m};${p};${r}`,inputDependencies:f?["rank","rank","rank"]:["rank","rank"]},getRunData:()=>({outputs:[{dims:s?s(a):a,dataType:e[0].dataType}],dispatchGroup:{x:Math.ceil(h/64)},programUniforms:b}),getShaderSource:n=>{let s=si("batch_dims",e[0].dataType,x.length),l=ai("a",e[0].dataType,i.length,m),d=ai("b",e[1].dataType,o.length,u),c=ni("output",e[0].dataType,g.length,u),h=Gs(c.type.tensor),b=Wl(t,c.type.value,h),y=[l,d],v="";if(f){let t=r?u:1;y.push(ai("bias",e[2].dataType,e[2].dims.length,t)),v=""+(r?`value += bias[col / ${t}];`:`value += ${c.type.value}(bias[row + i]);`)}let w=[{name:"output_size",type:"u32"},{name:"M",type:"u32"},{name:"N",type:"u32"},{name:"K",type:"u32"}];ql(t,w);return`\n  ${n.registerUniforms(w).registerInternalVariables(s).declareVariables(...y,c)}\n  ${n.mainStart()}\n    ${n.guardAgainstOutOfBoundsWorkgroupSizes("uniforms.output_size")}\n    let col = (global_idx % (uniforms.N / ${u})) * ${u};\n    var index1 = global_idx / (uniforms.N / ${u});\n    let stride1 = uniforms.M / ${p};\n    let row = (index1 % stride1) * ${p};\n    let batch = index1 / stride1;\n\n    ${2===a.length?"":`let batch_indices = ${s.offsetToIndices("batch")};`}\n\n    var a_indices: ${l.type.indices};\n    ${Yl("a_indices",l,l.rank-2,s.rank,"batch_indices")}\n    ${l.indicesSet("a_indices",l.rank-2,0)}\n    ${l.indicesSet("a_indices",l.rank-1,0)}\n    let a_offset = ${l.indicesToOffset("a_indices")};\n\n    var b_indices: ${d.type.indices};\n    ${Yl("b_indices",d,d.rank-2,s.rank,"batch_indices")}\n    ${d.indicesSet("b_indices",d.rank-2,0)}\n    ${d.indicesSet("b_indices",d.rank-1,0)}\n    let b_offset = ${d.indicesToOffset("b_indices")};\n    var values: array<${c.type.value}, ${p}>;\n    for (var k: u32 = 0u; k < uniforms.K; k = k + ${m}) {\n      ${(()=>{let e=`var a_data: ${l.type.value};`;for(let t=0;t<m;t++)e+=`\n              let b_data${t} = b[(b_offset + (k + ${t}) * uniforms.N + col) / ${u}];`;for(let t=0;t<p;t++){e+=`a_data = a[(a_offset + (row + ${t}) * uniforms.K + k) / ${m}];`;for(let a=0;a<m;a++)e+=`\n            values[${t}] = fma(${d.type.value}(a_data${1===m?"":`[${a}]`}), b_data${a}, values[${t}]);\n`}return e})()}\n    }\n    for (var i = 0u; i < ${p}u; i++) {\n      var value = values[i];\n      ${v}\n      ${b}\n      let cur_indices = ${c.type.indices}(batch, row + i, col);\n      let offset = ${c.indicesToOffset("cur_indices")};\n      ${c.setByOffset(`offset / ${u}`,"value")};\n    }\n  }\n  `}}}}),zp=Ln(()=>{rp(),op(),hp(),$p(),Mp(),Cp(),Ql=(e,t)=>e?`\n        mm_Asub[inputRow][inputCol] = mm_readA(batch,\n          kStart + inputRow,\n          globalRowStart / innerElementSize + inputCol${t?", batchIndices":""});\n        `:`\n        mm_Asub[inputRow][inputCol] = mm_readA(batch,\n          globalRow + innerRow,\n          kStart / innerElementSize + inputCol${t?", batchIndices":""});\n        `,Jl=(e,t)=>e?`\n        let ACached0 = mm_Asub[k * innerElementSize][localRow];\n        let ACached1 = mm_Asub[k * innerElementSize + 1][localRow];\n        let ACached2 = mm_Asub[k * innerElementSize + 2][localRow];\n        ${3===t?"":"let ACached3 = mm_Asub[k * innerElementSize + 3][localRow];"}\n        for (var i = 0; i < rowPerThread; i = i + 1) {\n          acc[i] = BCached0 * ACached0[i] + acc[i];\n          acc[i] = BCached1 * ACached1[i] + acc[i];\n          acc[i] = BCached2 * ACached2[i] + acc[i];\n          ${3===t?"":"acc[i] = BCached3 * ACached3[i] + acc[i];"}\n        }`:`\n        for (var i = 0; i < rowPerThread; i = i + 1) {\n          let ACached = mm_Asub[tileRow + i][k];\n          acc[i] = BCached0 * ACached.x + acc[i];\n          acc[i] = BCached1 * ACached.y + acc[i];\n          acc[i] = BCached2 * ACached.z + acc[i];\n          ${3===t?"":"acc[i] = BCached3 * ACached.w + acc[i];"}\n        }`,ed=(e,t,a="f32",n,r=!1,s=32,i=!1,o=32)=>{let l=t[1]*e[1],d=t[0]*e[0],c=r?l:s,u=r?s:l,m=c/t[0],p=s/t[1];if((!r||4!==m||4!==e[1])&&(r||3!==m&&4!==m)||c%t[0]!==0||s%t[1]!==0||4!==e[0])throw new Error(`If transposeA ${r} is true, innerElementSize ${m} and workPerThread[1] ${e[1]} must be 4.\n      Otherwise, innerElementSize ${m} must be 3 or 4.\n  tileAWidth ${c} must be divisible by workgroupSize[0]${t[0]}. tileInner ${s} must be divisible by workgroupSize[1] ${t[1]}. colPerThread ${e[0]} must be 4.`);return`\nvar<workgroup> mm_Asub: array<array<vec${m}<${a}>, ${c/m}>, ${u}>;\nvar<workgroup> mm_Bsub: array<array<vec4<${a}>, ${d/e[0]}>, ${s}>;\n\nconst rowPerThread = ${e[1]};\nconst colPerThread = ${e[0]};\nconst innerElementSize = ${m};\nconst tileInner = ${s};\n\n@compute @workgroup_size(${t[0]}, ${t[1]}, ${t[2]})\nfn main(@builtin(local_invocation_id) localId : vec3<u32>,\n        @builtin(global_invocation_id) globalId : vec3<u32>,\n        @builtin(workgroup_id) workgroupId : vec3<u32>) {\n  let localRow = i32(localId.y);\n  let tileRow = localRow * rowPerThread;\n  let tileCol = i32(localId.x);\n\n  let globalRow =i32(globalId.y) * rowPerThread;\n  let globalCol = i32(globalId.x);\n  let batch = ${i?"0":"i32(globalId.z)"};\n  ${n?`let batchIndices = ${n.offsetToIndices("u32(batch)")};`:""}\n  let globalRowStart = i32(workgroupId.y) * ${l};\n\n  let num_tiles = ${i?`${Math.ceil(o/s)}`:"(uniforms.dim_inner - 1) / tileInner + 1"};\n  var kStart = ${i?`i32(globalId.z) * ${o}`:"0"};\n\n  var acc: array<vec4<${a}>, rowPerThread>;\n\n  // Loop over shared dimension.\n  let tileRowB = localRow * ${p};\n  for (var t = 0; t < num_tiles; t = t + 1) {\n      // Load one tile of A into local memory.\n      for (var innerRow = 0; innerRow < rowPerThread; innerRow = innerRow + 1) {\n          let inputRow = tileRow + innerRow;\n          let inputCol = tileCol;\n          ${Ql(r,n)}\n      }\n\n      // Load one tile of B into local memory.\n      for (var innerRow = 0; innerRow < ${p}; innerRow = innerRow + 1) {\n          let inputRow = tileRowB + innerRow;\n          let inputCol = tileCol;\n          mm_Bsub[inputRow][inputCol] = mm_readB(batch, kStart + inputRow, globalCol${n?", batchIndices":""});\n      }\n      kStart = kStart + tileInner;\n      workgroupBarrier();\n\n      // Compute acc values for a single thread.\n      for (var k = 0; k < tileInner / innerElementSize; k = k + 1) {\n          let BCached0 = mm_Bsub[k * innerElementSize][tileCol];\n          let BCached1 = mm_Bsub[k * innerElementSize + 1][tileCol];\n          let BCached2 = mm_Bsub[k * innerElementSize + 2][tileCol];\n          ${3===m?"":"let BCached3 = mm_Bsub[k * innerElementSize + 3][tileCol];"}\n\n          ${Jl(r,m)}\n      }\n\n      workgroupBarrier();\n  }\n\n  for (var innerRow = 0; innerRow < rowPerThread; innerRow = innerRow + 1) {\n      mm_write(batch, globalRow + innerRow, globalCol, acc[innerRow]);\n  }\n}`},td=(e,t)=>e?`\n            mm_Asub[inputRow][inputCol] = mm_readA(batch,\n              kStart + inputRow,\n              globalRowStart + inputCol${t?", batchIndices":""});\n            `:`\n            mm_Asub[inputRow][inputCol] = mm_readA(batch,\n              globalRowStart + inputRow,\n              kStart + inputCol${t?", batchIndices":""});\n            `,ad=e=>e?"let ACached = mm_Asub[k][tileRow + innerRow];":"let ACached = mm_Asub[tileRow + innerRow][k];",nd=(e,t,a="f32",n,r=!1,s=32,i=!1,o=32,l=!1)=>{let d=e[1]*t[1],c=e[0]*t[0],u=r?d:s,m=r?s:d;if(m%t[1]!==0||u%t[0]!==0||s%t[1]!==0)throw new Error(`tileAHight ${m} must be divisible by workgroupSize[1]${t[1]}, tileAWidth ${u} must be divisible by workgroupSize[0]${t[0]}, tileInner ${s} must be divisible by workgroupSize[1]${t[1]}`);let p=m/t[1],h=u/t[0],f=s/t[1],x=l?`\n    let localRow = i32(localId.y);\n    let localCol = i32(localId.x);\n    let globalRowStart = i32(workgroupId.y) * ${d};\n    let globalColStart = i32(workgroupId.x) * ${c};\n\n    // Loop over shared dimension.\n    for (var t = 0; t < num_tiles; t = t + 1) {\n      // Load one tile of A into local memory.\n      for (var inputRow = localRow; inputRow < ${m}; inputRow = inputRow + ${t[1]}) {\n        for (var inputCol = localCol; inputCol < ${u}; inputCol = inputCol + ${t[0]}) {\n          ${td(r,n)}\n        }\n      }\n      // Load one tile of B into local memory.\n      for (var inputRow = localRow; inputRow < ${s}; inputRow = inputRow + ${t[1]}) {\n            for (var inputCol = localCol; inputCol < ${c}; inputCol = inputCol + ${t[0]}) {\n          mm_Bsub[inputRow][inputCol] = mm_readB(batch,\n            kStart + inputRow,\n            globalColStart + inputCol${n?", batchIndices":""});\n        }\n      }\n      kStart = kStart + tileInner;\n      workgroupBarrier();\n\n      // Compute acc values for a single thread.\n      var BCached : array<${a}, colPerThread>;\n      for (var k = 0; k < tileInner; k = k + 1) {\n        for (var inner = 0; inner < colPerThread; inner = inner + 1) {\n          BCached[inner] = mm_Bsub[k][localCol + inner * ${t[0]}];\n        }\n        for (var innerRow = 0; innerRow < rowPerThread; innerRow = innerRow + 1) {\n          let ACached = ${r?`mm_Asub[k][localRow + innerRow * ${t[1]}];`:`mm_Asub[localRow + innerRow * ${t[1]}][k];`}\n          for (var innerCol = 0; innerCol < colPerThread; innerCol = innerCol + 1) {\n            acc[innerRow][innerCol] = acc[innerRow][innerCol] +\n                ACached * BCached[innerCol];\n          }\n        }\n      }\n      workgroupBarrier();\n    }\n    for (var innerRow = 0; innerRow < rowPerThread; innerRow = innerRow + 1) {\n      let gRow = globalRowStart + localRow + innerRow * ${t[1]};\n      for (var innerCol = 0; innerCol < colPerThread; innerCol = innerCol + 1) {\n        let gCol = globalColStart + localCol + innerCol * ${t[0]};\n        mm_write(batch, gRow, gCol, acc[innerRow][innerCol]);\n      }\n    }\n    `:`\nlet tileRow = i32(localId.y) * rowPerThread;\nlet tileCol = i32(localId.x) * colPerThread;\n\nlet globalRow = i32(globalId.y) * rowPerThread;\nlet globalCol = i32(globalId.x) * colPerThread;\nlet globalRowStart = i32(workgroupId.y) * ${d};\n\nlet tileRowA = i32(localId.y) * ${p};\nlet tileColA = i32(localId.x) * ${h};\nlet tileRowB = i32(localId.y) * ${f};\n// Loop over shared dimension.\nfor (var t = 0; t < num_tiles; t = t + 1) {\n  // Load one tile of A into local memory.\n  for (var innerRow = 0; innerRow < ${p}; innerRow = innerRow + 1) {\n    for (var innerCol = 0; innerCol < ${h}; innerCol = innerCol + 1) {\n      let inputRow = tileRowA + innerRow;\n      let inputCol = tileColA + innerCol;\n      ${td(r,n)}\n    }\n  }\n\n  // Load one tile of B into local memory.\n  for (var innerRow = 0; innerRow < ${f}; innerRow = innerRow + 1) {\n    for (var innerCol = 0; innerCol < colPerThread; innerCol = innerCol + 1) {\n      let inputRow = tileRowB + innerRow;\n      let inputCol = tileCol + innerCol;\n      mm_Bsub[inputRow][inputCol] = mm_readB(batch,\n        kStart + inputRow,\n        globalCol + innerCol${n?", batchIndices":""});\n    }\n  }\n  kStart = kStart + tileInner;\n  workgroupBarrier();\n\n  // Compute acc values for a single thread.\n  var BCached : array<${a}, colPerThread>;\n  for (var k = 0; k < tileInner; k = k + 1) {\n    for (var inner = 0; inner < colPerThread; inner = inner + 1) {\n      BCached[inner] = mm_Bsub[k][tileCol + inner];\n    }\n\n    for (var innerRow = 0; innerRow < rowPerThread; innerRow = innerRow + 1) {\n      ${ad(r)}\n      for (var innerCol = 0; innerCol < colPerThread; innerCol = innerCol + 1) {\n        acc[innerRow][innerCol] = acc[innerRow][innerCol] + ACached * BCached[innerCol];\n      }\n    }\n  }\n\n  workgroupBarrier();\n}\n\nfor (var innerRow = 0; innerRow < rowPerThread; innerRow = innerRow + 1) {\n  for (var innerCol = 0; innerCol < colPerThread; innerCol = innerCol + 1) {\n    mm_write(batch, globalRow + innerRow, globalCol + innerCol,\n        acc[innerRow][innerCol]);\n  }\n}\n`;return`\n  var<workgroup> mm_Asub : array<array<${a}, ${u}>, ${m}>;\n  var<workgroup> mm_Bsub : array<array<${a}, ${c}>, ${s}>;\n  const rowPerThread = ${e[1]};\n  const colPerThread = ${e[0]};\n  const tileInner = ${s};\n\n@compute @workgroup_size(${t[0]}, ${t[1]}, ${t[2]})\nfn main(@builtin(local_invocation_id) localId : vec3<u32>,\n        @builtin(global_invocation_id) globalId : vec3<u32>,\n        @builtin(workgroup_id) workgroupId : vec3<u32>) {\n    let batch = ${i?"0":"i32(globalId.z)"};\n    ${n?`let batchIndices = ${n.offsetToIndices("u32(batch)")};`:""}\n    let num_tiles = ${i?`${Math.ceil(o/s)}`:"(uniforms.dim_inner - 1) / tileInner + 1"};\n    var kStart = ${i?`i32(globalId.z) * ${o}`:"0"};\n\n    var acc : array<array<${a}, colPerThread>, rowPerThread>;\n    ${x}\n  }\n`},rd=(e,t,a,n,r=!1)=>{let[s,i,o,l]=n,d=Gs(n[0].type.tensor);return`\n    fn mm_readA(batch: i32, row: i32, colIn: i32, batchIndices: ${s.type.indices}) -> ${Gl(e,d)} {\n      var value = ${Gl(e,d)}(0.0);\n      let col = colIn * ${e};\n      if(row < uniforms.dim_a_outer && col < uniforms.dim_inner)\n      {\n        var aIndices: ${i.type.indices};\n        ${Yl("aIndices",i,i.rank-2,s.rank,"batchIndices")}\n        ${i.indicesSet("aIndices",i.rank-2,"u32(row)")}\n        ${i.indicesSet("aIndices",i.rank-1,"u32(colIn)")}\n        value = ${i.getByIndices("aIndices")};\n      }\n      return value;\n    }\n\n    fn mm_readB(batch: i32, row: i32, colIn: i32, batchIndices: ${s.type.indices}) -> ${Gl(e,d)} {\n      var value = ${Gl(e,d)}(0.0);\n      let col = colIn * ${e};\n      if(row < uniforms.dim_inner && col < uniforms.dim_b_outer)\n      {\n        var bIndices: ${o.type.indices};\n        ${Yl("bIndices",o,o.rank-2,s.rank,"batchIndices")}\n        ${o.indicesSet("bIndices",o.rank-2,"u32(row)")}\n        ${o.indicesSet("bIndices",o.rank-1,"u32(colIn)")}\n        value = ${o.getByIndices("bIndices")};\n      }\n      return value;\n    }\n\n    fn mm_write(batch: i32, row: i32, colIn: i32, valueIn: ${Gl(e,d)}) {\n      let col = colIn * ${e};\n      if (row < uniforms.dim_a_outer && col < uniforms.dim_b_outer) {\n        var value = valueIn;\n        let coords = vec3<i32>(batch, row, colIn);\n        ${t?`value = value + ${r?"bias[colIn]":`${Gl(e,d)}(bias[row])`};`:""}\n        ${a}\n        ${l.setByIndices("vec3<u32>(coords)","value")}\n      }\n    }\n    `},sd=(e,t,a,n,r=!1,s)=>{let i=e[0].dims,o=e[1].dims,l=i.slice(0,-2),d=o.slice(0,-2),c=n?n.slice(0,-2):a.slice(0,-2),u=hs.size(c),m=i[i.length-2],p=i[i.length-1],h=o[o.length-1],f=p%4==0&&h%4==0,x=m<=8?[4,1,1]:[4,4,1],g=[8,8,1],b=[Math.ceil(h/g[0]/x[0]),Math.ceil(m/g[1]/x[1]),Math.ceil(u/g[2]/x[2])],y=f?4:1,v=[...l,m,p/y],w=v.length,j=[...d,p,h/y],_=j.length,k=[u,m,h/y],N=[{type:6,data:m},{type:6,data:h},{type:6,data:p}];Ul(t,N),N.push(...Xs(c,v,j));let $=["rank","rank"],C=e.length>2;C&&(N.push(...Xs(e[2].dims)),$.push("rank")),N.push(...Xs(k));return{name:"MatMul",shaderCache:{hint:`${x};${t.activation};${f};${r}`,inputDependencies:$},getRunData:()=>({outputs:[{dims:s?s(a):a,dataType:e[0].dataType}],dispatchGroup:{x:b[0],y:b[1],z:b[2]},programUniforms:N}),getShaderSource:a=>{let n=c.length,s=si("batchDims",e[0].dataType,n,1),i=Gs(e[0].dataType),o=ai("a",e[0].dataType,w,y),l=ai("b",e[1].dataType,_,y),d=ni("result",e[0].dataType,k.length,y),u=[o,l];if(C){let t=r?y:1;u.push(ai("bias",e[2].dataType,e[2].dims.length,t))}let m=[{name:"dim_a_outer",type:"i32"},{name:"dim_b_outer",type:"i32"},{name:"dim_inner",type:"i32"}];ql(t,m);let p=Gs(d.type.tensor),h=Wl(t,d.type.value,p),b=rd(y,C,h,[s,o,l,d],r);return`\n  ${a.registerUniforms(m).registerInternalVariables(s).declareVariables(...u,d)}\n  ${b}\n  ${f?ed(x,g,i,s):nd(x,g,i,s)}\n                   `}}}}),Tp=Ln(()=>{rp(),ip(),hp(),$p(),Cp(),Sp(),zp(),id=(e,t,a,n,r=!1,s,i=4,o=4,l=4,d="f32")=>{let c=e=>{switch(e){case 1:return"return w[row * i32(uniforms.w_shape[3]) + colIn];";case 4:return"return w[row * i32(uniforms.w_shape[3]) / 4 + colIn];";default:throw new Error(`innerElementSize ${e} is not supported.`)}},u=e?"\n    let coord = vec4<i32>(batch, xRow, xCol, xCh);\n    ":"\n    let coord = vec4<i32>(batch, xCh, xRow, xCol);\n    ",m=e?"\n    let coords = vec4<i32>(\n      batch,\n      row / outWidth,\n      row % outWidth,\n      col);\n    ":"\n    let coords = vec4<i32>(\n      batch,\n      row,\n      col / outWidth,\n      col % outWidth);\n    ",p=e?"i32(uniforms.x_shape[1])":"i32(uniforms.x_shape[2])",h=e?"i32(uniforms.x_shape[2])":"i32(uniforms.x_shape[3])",f=e?"row":"col",x=e?"col":"row",g=`\n    let inChannels = i32(uniforms.w_shape[2]);\n    let outWidth = ${e?"i32(uniforms.result_shape[2])":"i32(uniforms.result_shape[3])"};\n    let outRow = ${f} / outWidth;\n    let outCol = ${f} % outWidth;\n\n    let WRow = ${x} / (i32(uniforms.w_shape[1]) * inChannels);\n    let WCol = ${x} / inChannels % i32(uniforms.w_shape[1]);\n    let xRow = outRow * uniforms.stride[0] + uniforms.dilation[0] * WRow - uniforms.pad[0];\n    let xCol = outCol * uniforms.stride[1] + uniforms.dilation[1] * WCol - uniforms.pad[1];\n    let xCh = ${x} % inChannels;\n    var resData = ${Gl(i,d)}(0.0);\n    // The bounds checking is always needed since we use it to pad zero for\n    // the 'same' padding type.\n    if (xRow >= 0 && xRow < ${p} && xCol >= 0 && xCol < ${h}) {\n      ${u}\n      let xIndex = getIndexFromCoords4D(coord, vec4<i32>(uniforms.x_shape));\n      ${(e=>{switch(e){case 1:return"resData = x[xIndex];";case 3:return`resData = vec3<${d}>(x[xIndex], x[xIndex + 1], x[xIndex + 2]);`;case 4:return"resData = x[xIndex / 4];";default:throw new Error(`innerElementSize ${e} is not supported.`)}})(i)}\n    }\n    return resData;`,b=e?t&&n?`\n    let col = colIn * ${i};\n    ${g}`:`\n    let col = colIn * ${i};\n    if (row < uniforms.dim_a_outer && col < uniforms.dim_inner) {\n      ${g}\n    }\n    return ${Gl(i,d)}(0.0);`:n&&a?`\n    let col = colIn * ${i};\n    ${g}`:`\n    let col = colIn * ${i};\n    if (row < uniforms.dim_inner && col < uniforms.dim_b_outer) {\n      ${g}\n    }\n    return ${Gl(i,d)}(0.0);`,y=e?n&&a?c(o):`\n    let col = colIn * ${o};\n    if (row < uniforms.dim_inner && col < uniforms.dim_b_outer) {\n      ${c(o)}\n    }\n    return ${Gl(o,d)}(0.0);`:`\n    let col = colIn * ${o};\n    if (row < uniforms.dim_inner && col < uniforms.dim_a_outer) {\n      ${c(o)}\n    }\n    return ${Gl(o,d)}(0.0);`,v=Gl(l,d),w=Gl(e?i:o,d),j=Gl(e?o:i,d),_=Wl(s,v,d);return`\n    fn mm_readA(batch: i32, row : i32, colIn : i32) -> ${w} {\n      ${e?b:y}\n    }\n\n    fn mm_readB(batch: i32, row : i32, colIn : i32) -> ${j} {\n      ${e?y:b}\n    }\n\n    fn mm_write(batch: i32, row : i32, colIn : i32, valueIn : ${v}) {\n      let col = colIn * ${l};\n      if (row < uniforms.dim_a_outer && col < uniforms.dim_b_outer)\n      {\n      var value = valueIn;\n      let outWidth = ${e?"i32(uniforms.result_shape[2])":"i32(uniforms.result_shape[3])"};\n      ${m}\n      ${Kl(r)}\n      ${_}\n      setOutputAtCoords(coords[0], coords[1], coords[2], coords[3], value);\n      }\n    }`},od=(e,t,a,n,r,s,i,o,l)=>{let d="NHWC"===t.format,c=d?e[0].dims[3]:e[0].dims[1],u=a[0],m=d?a[2]:a[3],p=d?a[1]:a[2],h=d?a[3]:a[1],f=d&&(c%4==0||c%3==0)&&h%4==0,x=d?h:m*p,g=d?m*p:h,b=[8,8,1],y=n<=8?[4,1,1]:[4,4,1],v=[Math.ceil(x/b[0]/y[0]),Math.ceil(g/b[1]/y[1]),Math.ceil(u/b[2]/y[2])];us("verbose",()=>`[conv2d_mm_webgpu] dispatch = ${v}`);let w=f?d&&c%4!=0?3:4:1,j=b[1]*y[1],_=b[0]*y[0],k=Math.max(b[0]*w,b[1]),N=n%j===0,$=r%_===0,C=s%k===0,S=f?[w,4,4]:[1,1,1],M=[{type:6,data:n},{type:6,data:r},{type:6,data:s},{type:6,data:[t.pads[0],t.pads[1]]},{type:6,data:t.strides},{type:6,data:t.dilations}];Ul(t,M),M.push(...Xs(e[0].dims,e[1].dims));let z=["rank","rank"];i&&(M.push(...Xs(e[2].dims)),z.push("rank")),M.push(...Xs(a));return{name:"Conv2DMatMul",shaderCache:{hint:`${t.cacheKey};${w};${f};${N};${$};${C};${j};${_};${k}`,inputDependencies:z},getRunData:()=>({outputs:[{dims:l?l(a):a,dataType:e[0].dataType}],dispatchGroup:{x:v[0],y:v[1],z:v[2]},programUniforms:M}),getShaderSource:n=>{let r=[{name:"dim_a_outer",type:"i32"},{name:"dim_b_outer",type:"i32"},{name:"dim_inner",type:"i32"},{name:"pad",type:"i32",length:2},{name:"stride",type:"i32",length:2},{name:"dilation",type:"i32",length:2}];ql(t,r);let s=f?4:1,l=Gs(e[0].dataType),c=`\n      fn setOutputAtIndex(flatIndex : i32, value : ${f?`vec4<${l}>`:l}) {\n        result[flatIndex] = ${f?`vec4<${l}>`:l}(value);\n      }\n      fn setOutputAtCoords(d0 : i32, d1 : i32, d2 : i32, d3 : i32, value : ${f?`vec4<${l}>`:l}) {\n        let flatIndex = getOutputIndexFromCoords(vec4<i32>(d0, d1, d2, d3));\n        setOutputAtIndex(flatIndex ${f?"/ 4":""}, value);\n      }`,u=[ai("x",e[0].dataType,e[0].dims.length,3===w?1:w),ai("w",e[1].dataType,e[1].dims.length,s)],m=ni("result",e[0].dataType,a.length,s);if(i){let t=ai("bias",e[2].dataType,e[2].dims.length,s);u.push(t),c+=`\n        fn getBiasByOutputCoords(coords : vec4<i32>) -> ${f?`vec4<${l}>`:l} {\n          return bias[coords.${d?"w":"y"}${f?"/ 4":""}];\n        }`}return`\n        ${Xl("uniforms.result_strides")}\n        //struct Uniforms { xShape : vec4<i32>, wShape : vec4<i32>, outShape : vec4<i32>,\n        //  outShapeStrides: vec3<i32>, filterDims : vec2<i32>, pad : vec2<i32>, stride : vec2<i32>,\n        //  dilation : vec2<i32>, dimAOuter : i32, dimBOuter : i32, dimInner : i32 };\n        ${n.registerUniforms(r).declareVariables(...u,m)}\n        ${c}\n        ${id(d,N,$,C,i,t,S[0],S[1],S[2],l)}\n        ${f?ed(y,b,l,void 0,!d,k):nd(y,b,l,void 0,!d,k,!1,void 0,o)}`}}}}),Ep=Ln(()=>{rp(),ip(),op(),hp(),$p(),Cp(),ld=e=>{let t=1;for(let a=0;a<e.length;a++)t*=e[a];return t},dd=e=>"number"==typeof e?[e,e,e]:e,cd=(e,t)=>t<=1?e:e+(e-1)*(t-1),ud=(e,t,a,n=1)=>{let r=cd(t,n);return Math.floor((e[0]*(a-1)-a+r)/2)},md=(e,t,a,n,r)=>{null==r&&(r=ud(e,t[0],n[0]));let s=[0,0,0,a];for(let i=0;i<3;i++)e[i]+2*r>=t[i]&&(s[i]=Math.trunc((e[i]-t[i]+2*r)/n[i]+1));return s},pd=(e,t,a,n,r,s,i,o,l,d)=>{let c,u,m,p;if("VALID"===e&&(e=0),"number"==typeof e){c={top:e,bottom:e,left:e,right:e,front:e,back:e};let h=md([t,a,n,1],[o,l,d],1,[r,s,i],e);u=h[0],m=h[1],p=h[2]}else if(Array.isArray(e)){if(!e.every((e,t,a)=>e===a[0]))throw Error(`Unsupported padding parameter: ${e}`);c={top:e[0],bottom:e[1],left:e[2],right:e[3],front:e[4],back:e[5]};let h=md([t,a,n,1],[o,l,d],1,[r,s,i],e[0]);u=h[0],m=h[1],p=h[2]}else{if("SAME_UPPER"!==e)throw Error(`Unknown padding parameter: ${e}`);{u=Math.ceil(t/r),m=Math.ceil(a/s),p=Math.ceil(n/i);let e=(u-1)*r+o-t,h=(m-1)*s+l-a,f=(p-1)*i+d-n,x=Math.floor(e/2),g=e-x,b=Math.floor(h/2),y=h-b,v=Math.floor(f/2);c={top:b,bottom:y,left:v,right:f-v,front:x,back:g}}}return{padInfo:c,outDepth:u,outHeight:m,outWidth:p}},hd=(e,t,a,n,r,s=!1,i="channelsLast")=>{let o,l,d,c,u;if("channelsLast"===i)[o,l,d,c,u]=e;else{if("channelsFirst"!==i)throw new Error(`Unknown dataFormat ${i}`);[o,u,l,d,c]=e}let[m,,p,h,f]=t,[x,g,b]=dd(a),[y,v,w]=dd(n),j=cd(p,y),_=cd(h,v),k=cd(f,w),{padInfo:N,outDepth:$,outHeight:C,outWidth:S}=pd(r,l,d,c,x,g,b,j,_,k),M=s?m*u:m,z=[0,0,0,0,0];return"channelsFirst"===i?z=[o,M,$,C,S]:"channelsLast"===i&&(z=[o,$,C,S,M]),{batchSize:o,dataFormat:i,inDepth:l,inHeight:d,inWidth:c,inChannels:u,outDepth:$,outHeight:C,outWidth:S,outChannels:M,padInfo:N,strideDepth:x,strideHeight:g,strideWidth:b,filterDepth:p,filterHeight:h,filterWidth:f,effectiveFilterDepth:j,effectiveFilterHeight:_,effectiveFilterWidth:k,dilationDepth:y,dilationHeight:v,dilationWidth:w,inShape:e,outShape:z,filterShape:t}},fd=(e,t,a,n,r,s)=>{let i="channelsLast"===s;i?e[0].dims[3]:e[0].dims[1];let o={x:a.map((e,t)=>t)},l=[Math.ceil(ld(o.x.map(e=>a[e]))/64),1,1];us("verbose",()=>`[conv3d_naive_webgpu] dispatch = ${l}`);let d=[{type:12,data:hs.size(a)},{type:12,data:n},{type:12,data:r},{type:12,data:t.strides},{type:12,data:t.dilations}];Ul(t,d),d.push(...Xs(e[0].dims,e[1].dims));let c=["rank","rank"],u=3===e.length;u&&(d.push(...Xs(e[2].dims)),c.push("rank")),d.push(...Xs(a));return{name:"Conv3DNaive",shaderCache:{hint:`${t.cacheKey};${i};1;${u}`,inputDependencies:c},getRunData:()=>({outputs:[{dims:a,dataType:e[0].dataType}],dispatchGroup:{x:l[0],y:l[1],z:l[2]},programUniforms:d}),getShaderSource:s=>{let o=[{name:"output_size",type:"u32"},{name:"filter_dims",type:"u32",length:n.length},{name:"pads",type:"u32",length:r.length},{name:"strides",type:"u32",length:t.strides.length},{name:"dilations",type:"u32",length:t.dilations.length}];ql(t,o);let l=Gs(e[0].dataType),d=ai("x",e[0].dataType,e[0].dims.length,1),c=ai("W",e[1].dataType,e[1].dims.length,1),m=[d,c],p=ni("result",e[0].dataType,a.length,1),h="";if(u){let t=ai("bias",e[2].dataType,e[2].dims.length,1);m.push(t),h+=`\n        fn getBiasByOutputCoords(coords : array<u32, 5>) -> ${l} {\n          return bias[${ei("coords",i?4:1,5)}];\n        }`}let f=Gl(1,l),x=Wl(t,f,l);return`\n            ${h}\n            fn getX(d0 : u32, d1 : u32, d2 : u32, d3 : u32, d4 : u32) -> f32 {\n              let aIndices = array<u32, 5>(d0, d1, d2, d3, d4);\n              return ${d.getByIndices("aIndices")};\n            }\n            fn getW(d0 : u32, d1 : u32, d2 : u32, d3 : u32, d4 : u32) -> f32 {\n              let aIndices = array<u32, 5>(d0, d1, d2, d3, d4);\n              return ${c.getByIndices("aIndices")};\n            }\n          ${s.registerUniforms(o).declareVariables(...m,p)}\n          ${s.mainStart()}\n          ${s.guardAgainstOutOfBoundsWorkgroupSizes("uniforms.output_size")}\n              let coords = ${p.offsetToIndices("global_idx")};\n              let batch = ${ei("coords",0,d.rank)};\n              let d2 = ${ei("coords",i?d.rank-1:1,d.rank)};\n              let xFRCCorner = vec3<u32>(${ei("coords",i?1:2,d.rank)},\n              ${ei("coords",i?2:3,d.rank)},\n              ${ei("coords",i?3:4,d.rank)}) * uniforms.strides - uniforms.pads;\n              let xFCorner = xFRCCorner.x;\n              let xRCorner = xFRCCorner.y;\n              let xCCorner = xFRCCorner.z;\n              let xShapeY = ${ei("uniforms.x_shape",i?1:2,d.rank)};\n              let xShapeZ = ${ei("uniforms.x_shape",i?2:3,d.rank)};\n              let xShapeW = ${ei("uniforms.x_shape",i?3:4,d.rank)};\n              let xShapeU = ${ei("uniforms.x_shape",i?4:1,d.rank)};\n              let inputDepthNearestVec4 = (xShapeU / 4) * 4;\n              let inputDepthVec4Remainder = xShapeU % 4;\n\n              var value = 0.0;\n              for (var wF = 0u; wF < uniforms.filter_dims[0]; wF++) {\n                let xF = xFCorner + wF * uniforms.dilations[0];\n                if (xF < 0 || xF >= xShapeY) {\n                  continue;\n                }\n\n                for (var wR = 0u; wR < uniforms.filter_dims[1]; wR++) {\n                  let xR = xRCorner + wR * uniforms.dilations[1];\n                  if (xR < 0 || xR >= xShapeZ) {\n                    continue;\n                  }\n\n                  for (var wC = 0u; wC < uniforms.filter_dims[2]; wC++) {\n                    let xC = xCCorner + wC * uniforms.dilations[2];\n                    if (xC < 0 || xC >= xShapeW) {\n                      continue;\n                    }\n\n                    for (var d1 = 0u; d1 < inputDepthNearestVec4; d1 += 4) {\n                      ${i?"let xValues = vec4<f32>(\n                               getX(batch, xF, xR, xC, d1),\n                               getX(batch, xF, xR, xC, d1 + 1),\n                               getX(batch, xF, xR, xC, d1 + 2),\n                               getX(batch, xF, xR, xC, d1 + 3));\n                            ":"let xValues = vec4<f32>(\n                               getX(batch, d1, xF, xR, xC),\n                               getX(batch, d1 + 1, xF, xR, xC),\n                               getX(batch, d1 + 2, xF, xR, xC),\n                               getX(batch, d1 + 3, xF, xR, xC));\n                            "}\n                            let wValues = vec4<f32>(\n                              getW(d2, d1, wF, wR, wC),\n                              getW(d2, d1 + 1, wF, wR, wC),\n                              getW(d2, d1 + 2, wF, wR, wC),\n                              getW(d2, d1 + 3, wF, wR, wC));\n                      value += dot(xValues, wValues);\n                    }\n                    if (inputDepthVec4Remainder == 1) {\n                        ${i?"value += getX(batch, xF, xR, xC, inputDepthNearestVec4)\n                          * getW(d2, inputDepthNearestVec4, wF, wR, wC);":"value += getX(batch, inputDepthNearestVec4, xF, xR, xC)\n                          * getW(d2, inputDepthNearestVec4, wF, wR, wC);"}\n                    } else if (inputDepthVec4Remainder == 2) {\n                      ${i?"let xValues = vec2<f32>(\n                        getX(batch, xF, xR, xC, inputDepthNearestVec4),\n                        getX(batch, xF, xR, xC, inputDepthNearestVec4 + 1));\n                      ":"let xValues = vec2<f32>(\n                        getX(batch, inputDepthNearestVec4, xF, xR, xC),\n                        getX(batch, inputDepthNearestVec4 + 1, xF, xR, xC));\n                    "}\n                    let wValues = vec2<f32>(\n                      getW(d2, inputDepthNearestVec4, wF, wR, wC),\n                      getW(d2, inputDepthNearestVec4 + 1, wF, wR, wC));\n                      value += dot(xValues, wValues);\n                    } else if (inputDepthVec4Remainder == 3) {\n                      ${i?"let xValues = vec3<f32>(\n                        getX(batch, xF, xR, xC, inputDepthNearestVec4),\n                        getX(batch, xF, xR, xC, inputDepthNearestVec4 + 1),\n                        getX(batch, xF, xR, xC, inputDepthNearestVec4 + 2));\n                      ":"let xValues = vec3<f32>(\n                        getX(batch, inputDepthNearestVec4, xF, xR, xC),\n                        getX(batch, inputDepthNearestVec4 + 1, xF, xR, xC),\n                        getX(batch, inputDepthNearestVec4 + 2, xF, xR, xC));\n                    "}\n                    let wValues = vec3<f32>(\n                      getW(d2, inputDepthNearestVec4, wF, wR, wC),\n                      getW(d2, inputDepthNearestVec4 + 1, wF, wR, wC),\n                      getW(d2, inputDepthNearestVec4 + 2, wF, wR, wC));\n                      value += dot(xValues, wValues);\n                    }\n                  }\n                }\n              }\n              ${u?"value = value + getBiasByOutputCoords(coords)":""};\n              ${x}\n              result[global_idx] = f32(value);\n          }`}}}}),Ap=Ln(()=>{rp(),op(),hp(),$p(),xd=(e,t,a,n)=>{let r=e.length>2,s=r?"value += b[output_channel];":"",i=e[0].dims,o=e[1].dims,l="NHWC"===t.format,d=l?a[3]:a[1],c=d/t.group,u=l&&c>=4?Ys(d):1,m=hs.size(a)/u,p=[{type:12,data:m},{type:12,data:t.dilations},{type:12,data:[t.strides[0],t.strides[1]]},{type:12,data:[t.pads[0],t.pads[1]]},{type:12,data:c}];Ul(t,p),p.push(...Xs(i,[o[0],o[1],o[2],o[3]/u]));let h=r?["rank","rank","rank"]:["rank","rank"];p.push(...Xs([a[0],a[1],a[2],a[3]/u]));return{name:"GroupedConv",shaderCache:{hint:`${t.cacheKey}_${u}`,inputDependencies:h},getRunData:()=>({outputs:[{dims:n?n(a):a,dataType:e[0].dataType}],dispatchGroup:{x:Math.ceil(m/64)},programUniforms:p}),getShaderSource:n=>{let d=ni("output",e[0].dataType,a.length,u),c=Gs(d.type.tensor),m=Wl(t,d.type.value,c),p=ai("x",e[0].dataType,i.length),h=ai("w",e[1].dataType,o.length,u),f=[p,h];r&&f.push(ai("b",e[2].dataType,e[2].dims,u));let x=[{name:"output_size",type:"u32"},{name:"dilations",type:"u32",length:t.dilations.length},{name:"strides",type:"u32",length:2},{name:"pads",type:"u32",length:2},{name:"output_channels_per_group",type:"u32"}];ql(t,x);let g=l?`\n      for (var wHeight: u32 = 0u; wHeight < uniforms.w_shape[0]; wHeight++) {\n        let xHeight = xRCCorner.x + wHeight * uniforms.dilations[0];\n\n        if (xHeight < 0u || xHeight >= uniforms.x_shape[1]) {\n          continue;\n        }\n\n        for (var wWidth: u32 = 0u; wWidth < uniforms.w_shape[1]; wWidth++) {\n          let xWidth = xRCCorner.y + wWidth * uniforms.dilations[1];\n          if (xWidth < 0u || xWidth >= uniforms.x_shape[2]) {\n            continue;\n          }\n\n          for (var wInChannel: u32 = 0u; wInChannel < uniforms.w_shape[2]; wInChannel++) {\n            let input_channel = in_channel_offset + wInChannel;\n            let xVal = ${p.get("batch","xHeight","xWidth","input_channel")};\n            let wVal = ${h.get("wHeight","wWidth","wInChannel","output_channel")};\n            value += xVal * wVal;\n          }\n        }\n      }\n      `:`\n      for (var wInChannel: u32 = 0u; wInChannel < uniforms.w_shape[1]; wInChannel++) {\n        let input_channel = in_channel_offset + wInChannel;\n        for (var wHeight: u32 = 0u; wHeight < uniforms.w_shape[2]; wHeight++) {\n          let xHeight = xRCCorner.x + wHeight * uniforms.dilations[0];\n\n          if (xHeight < 0u || xHeight >= uniforms.x_shape[2]) {\n            continue;\n          }\n\n          for (var wWidth: u32 = 0u; wWidth < uniforms.w_shape[3]; wWidth++) {\n            let xWidth = xRCCorner.y + wWidth * uniforms.dilations[1];\n            if (xWidth < 0u || xWidth >= uniforms.x_shape[3]) {\n              continue;\n            }\n\n            let xVal = ${p.get("batch","input_channel","xHeight","xWidth")};\n            let wVal = ${h.get("output_channel","wInChannel","wHeight","wWidth")};\n            value += xVal * wVal;\n          }\n        }\n      }\n      `;return`\n  ${n.registerUniforms(x).declareVariables(...f,d)}\n\n  ${n.mainStart()}\n    ${n.guardAgainstOutOfBoundsWorkgroupSizes("uniforms.output_size")}\n\n    let outputIndices = ${d.offsetToIndices("global_idx")};\n    let batch: u32 = outputIndices[0];\n    let output_channel: u32 = outputIndices[${l?3:1}];\n    let xRCCorner: vec2<u32> = vec2<u32>(outputIndices[${l?1:2}], outputIndices[${l?2:3}]) * uniforms.strides - uniforms.pads;\n    let group_id: u32 = output_channel * ${u} / uniforms.output_channels_per_group;\n    var in_channel_offset = group_id * uniforms.w_shape[${l?2:1}];\n\n    var value: ${d.type.value} = ${d.type.value}(0);\n    ${g}\n    ${s}\n    ${m}\n    ${d.setByOffset("global_idx","value")}\n  }`}}},gd=(e,t,a,n)=>{let r=e.length>2,s=Ys(a[3]),i=Ys(a[2]),o=hs.size(a)/s/i,l=[e[0].dims[0],e[0].dims[1],e[0].dims[2],e[0].dims[3]/s],d=[e[1].dims[0],e[1].dims[1],e[1].dims[2],e[1].dims[3]/s],c=[a[0],a[1],a[2],a[3]/s],u=[{type:12,data:o},{type:6,data:[t.strides[0],t.strides[1]]},{type:6,data:[t.pads[0],t.pads[1]]}];Ul(t,u),u.push(...Xs(l,d,c));let m=(i-1)*t.strides[1]+d[1];return{name:"GroupedConv-Vectorize",shaderCache:{hint:`${t.cacheKey};${s};${i};${m};${d[0]};${d[1]}`,inputDependencies:r?["rank","rank","type"]:["rank","rank"]},getRunData:()=>({outputs:[{dims:n?n(a):a,dataType:e[0].dataType}],dispatchGroup:{x:Math.ceil(o/64)},programUniforms:u}),getShaderSource:a=>{let n=ni("output",e[0].dataType,c.length,s),o=Gs(n.type.tensor),u=Wl(t,n.type.value,o),p=ai("x",e[0].dataType,l.length,s),h=ai("w",e[1].dataType,d.length,s),f=[p,h];r&&f.push(ai("b",e[2].dataType,e[2].dims,s));let x=r?"value += b[output_channel];":"",g=[{name:"output_size",type:"u32"},{name:"strides",type:"i32",length:2},{name:"pads",type:"i32",length:2}];return ql(t,g),`\n  ${a.registerUniforms(g).declareVariables(...f,n)}\n  ${a.mainStart()}\n    ${a.guardAgainstOutOfBoundsWorkgroupSizes("uniforms.output_size")}\n    let width0 = uniforms.output_shape[3];\n    let output_channel = global_idx % width0;\n    var index1 = global_idx / width0;\n    let width1 = uniforms.output_shape[2] / ${i}u;\n    let col = (index1 % width1) * ${i}u;\n    index1 = index1 / width1;\n    let row = index1 % uniforms.output_shape[1];\n    let batch = index1 / uniforms.output_shape[1];\n\n    let x_corner = vec2<i32>(i32(row), i32(col)) * uniforms.strides - uniforms.pads;\n\n    var x_vals: array<${p.type.value}, ${m}>;\n    var values: array<${n.type.value}, ${i}>;\n    let input_channel = output_channel;\n    // Use constant instead of uniform can give better performance for w's height/width.\n    for (var w_height: u32 = 0u; w_height < ${d[0]}; w_height++) {\n      let x_height = x_corner.x + i32(w_height);\n      if (x_height >= 0 && u32(x_height) < uniforms.x_shape[1]) {\n        for (var i = 0; i < ${m}; i++) {\n          let x_width = x_corner.y + i;\n          if (x_width >= 0 && u32(x_width) < uniforms.x_shape[2]) {\n            x_vals[i] = ${p.get("batch","u32(x_height)","u32(x_width)","input_channel")};\n          } else {\n            x_vals[i] = ${p.type.value}(0);\n          }\n        }\n        for (var w_width: u32 = 0u; w_width < ${d[1]}; w_width++) {\n          let w_val = ${h.get("w_height","w_width","0","output_channel")};\n          for (var i = 0u; i < ${i}u; i++) {\n            values[i] = fma(x_vals[i * u32(uniforms.strides[1]) + w_width], w_val, values[i]);\n          }\n        }\n      }\n    }\n\n    for (var i = 0u; i < ${i}u; i++) {\n      var value = values[i];\n      ${x}\n      ${u}\n      ${n.set("batch","row","col + i","output_channel","value")};\n    }\n  }`}}}}),Ip=Ln(()=>{op(),Tp(),Ep(),zp(),Ap(),$p(),Mp(),fp(),bd=(e,t,a,n,r,s)=>{let i=e[0],o=e.slice(s?1:2,s?3:4),l=o.length,d=t[0],c=t.slice(2).map((e,t)=>e+(e-1)*(a[t]-1)),u=o.map((e,t)=>e+n[t]+n[t+l]).map((e,t)=>Math.floor((e-c[t]+r[t])/r[t]));return u.splice(0,0,i),u.splice(s?3:1,0,d),u},yd=[2,3,1,0],vd=(e,t)=>{if(!e||2!==e.length&&3!==e.length)throw new Error("Conv requires 2 or 3 inputs");if(e[0].dims.length>5)throw new Error("greater than 5D is not supported");if(e[0].dims.length!==e[1].dims.length)throw new Error("filter does not have same dimension as input");if(e[0].dims["NHWC"===t.format?e[0].dims.length-1:1]!==e[1].dims[1]*t.group)throw new Error("FILTER_IN_CHANNEL should be equal to DATA_CHANNEL");if(3===e.length&&(1!==e[2].dims.length||e[1].dims[0]!==e[2].dims[0]))throw new Error("invalid bias");let a=e[0].dims.length-2;if(t.dilations.length!==a)throw new Error(`dilations should be ${a}D`);if(t.strides.length!==a)throw new Error(`strides should be ${a}D`);if(t.pads.length!==2*a)throw new Error(`pads should be ${2*a}D`);if(0!==t.kernelShape.length&&t.kernelShape.length!==e[1].dims.length-2)throw new Error("invalid kernel shape")},wd=(e,t)=>{let a=e.kernelShape.slice();a.length<t[1].dims.length-2&&a.push(...Array(t[1].dims.length-2-a.length).fill(0));for(let s=2;s<t[1].dims.length;++s)0===a[s-2]&&(a[s-2]=t[1].dims[s]);let n=e.pads.slice();fs.adjustPadsBasedOnAutoPad(t[0].dims,e.strides,e.dilations,a,n,"NHWC"===e.format,e.autoPad);let r=Object.assign({},e);return Object.assign(r,{kernelShape:a,pads:n}),r},jd=e=>{let t=Hl(e),a=e.format;return{autoPad:["NOTSET","VALID","SAME_UPPER","SAME_LOWER"][e.auto_pad],format:a,dilations:e.dilations,group:e.group,kernelShape:e.kernel_shape,pads:e.pads,strides:e.strides,wIsConst:e.w_is_const(),...t,cacheKey:`${e.format};${t.activation};`}},_d=(e,t,a,n)=>{let r="NHWC"===a.format,s=bd(t[0].dims,t[1].dims,a.dilations,a.pads,a.strides,r);if(1!==a.group){let i=[t[0]];if(r){let n=e.kernelCustomData.wT??e.compute(hi(t[1],yd),{inputs:[1],outputs:[a.wIsConst?-2:-1]})[0];a.wIsConst&&!e.kernelCustomData.wT&&(e.kernelCustomData.wT=n),i.push(n)}else i.push(t[1]);return 3===t.length&&i.push(t[2]),void(!e.adapterInfo.isArchitecture("ampere")&&r&&t[1].dims[0]===a.group&&1===t[1].dims[1]&&1===a.dilations[0]&&1===a.dilations[1]?e.compute(gd(i,a,s,n),{inputs:i}):e.compute(xd(i,a,s,n),{inputs:i}))}let i=3===t.length,o=t[0].dims[r?1:2],l=t[0].dims[r?2:3],d=t[0].dims[r?3:1],c=t[1].dims[2],u=t[1].dims[3],m=s[r?1:2],p=s[r?2:3],h=s[r?3:1],f=r&&c===o&&u===l&&0===a.pads[0]&&0===a.pads[1];if(f||1===c&&1===u&&1===a.dilations[0]&&1===a.dilations[1]&&1===a.strides[0]&&1===a.strides[1]&&0===a.pads[0]&&0===a.pads[1]){let c,u,x,g=s[0],b=[];if(r){let n=e.kernelCustomData.wT??e.compute(hi(t[1],yd),{inputs:[1],outputs:[a.wIsConst?-2:-1]})[0];if(a.wIsConst&&!e.kernelCustomData.wT&&(e.kernelCustomData.wT=n),f){let e=o*l*d;c=t[0].reshape([1,g,e]),u=n.reshape([1,e,h]),x=[1,g,h]}else c=t[0].reshape([g,o*l,d]),u=n.reshape([1,d,h]),x=[g,m*p,h];b.push(c),b.push(u)}else c=t[0].reshape([g,d,o*l]),u=t[1].reshape([1,h,d]),x=[g,h,m*p],b.push(u),b.push(c);i&&b.push(t[2]);let y=x[2],v=b[0].dims[b[0].dims.length-1];return void(y<8&&v<8?e.compute(Zl(b,a,s,x,r,n),{inputs:b}):e.compute(sd(b,a,s,x,r,n),{inputs:b}))}let x=e.kernelCustomData.wT??e.compute(hi(t[1],yd),{inputs:[1],outputs:[a.wIsConst?-2:-1]})[0];a.wIsConst&&!e.kernelCustomData.wT&&(e.kernelCustomData.wT=x);let g=[t[0],x];i&&g.push(t[2]);let b=r?m*p:h,y=r?h:m*p,v=c*u*d;e.compute(od(g,a,s,b,y,v,i,!0,n),{inputs:g})},kd=(e,t)=>{let a="NHWC"===t.format,n=[e.inputs[0].reshape(a?[e.inputs[0].dims[0],1,e.inputs[0].dims[1],e.inputs[0].dims[2]]:[e.inputs[0].dims[0],e.inputs[0].dims[1],1,e.inputs[0].dims[2]]),e.inputs[1].reshape([e.inputs[1].dims[0],e.inputs[1].dims[1],1,e.inputs[1].dims[2]])];3===e.inputs.length&&n.push(e.inputs[2]);let r=[0,t.pads[0],0,t.pads[1]],s=[1].concat(t.strides),i=[1].concat(t.dilations),o=[1].concat(t.kernelShape),l=wd({...t,pads:r,strides:s,dilations:i,kernelShape:o},n);_d(e,n,l,e=>a?[e[0],e[2],e[3]]:[e[0],e[1],e[3]])},Nd=(e,t,a)=>{let n="NHWC"===a.format?"channelsLast":"channelsFirst",r=wd(a,t),s="NOTSET"===a.autoPad?a.pads:a.autoPad,i=hd(t[0].dims,t[1].dims,a.strides,a.dilations,s,!1,n);e.compute(fd(t,r,i.outShape,[i.filterDepth,i.filterHeight,i.filterWidth],[i.padInfo.front,i.padInfo.top,i.padInfo.left],n))},$d=(e,t)=>{if(vd(e.inputs,t),3===e.inputs[0].dims.length)kd(e,t);else if(5===e.inputs[0].dims.length)Nd(e,e.inputs,t);else{let a=wd(t,e.inputs);_d(e,e.inputs,a)}}}),Op=Ln(()=>{rp(),ip(),op(),hp(),Cd=(e,t,a)=>{let n=e.length>2,r=t.outputShape,s="NHWC"===t.format,i=t.group,o=e[1].dims,l=o[2]/i,d=o[3],c=s?Ys(l):1,u=s&&1===d&&l>=4,m=u?4*Math.floor(l/4):Math.floor(l/c)*c,p=l-m,h=s?Ys(d):1,f=s?1===d?c:h:1,x=hs.size(r)/h,g=[Math.ceil(x/64),1,1];us("verbose",()=>`[conv2d_backprop_webgpu] dispatch = ${g}`);let b=["rank","rank"],y=[t.strides[0],t.strides[1]],v=[t.kernelShape[s?1:2],t.kernelShape[s?2:3]],w=[t.dilations[0],t.dilations[1]],j=[v[0]+(t.dilations[0]<=1?0:(t.kernelShape[s?1:2]-1)*(t.dilations[0]-1)),v[1]+(t.dilations[1]<=1?0:(t.kernelShape[s?2:3]-1)*(t.dilations[1]-1))],_=[j[0]-1-Math.floor((t.pads[0]+t.pads[2])/2),j[1]-1-Math.floor((t.pads[1]+t.pads[3])/2)],k=[{type:12,data:x},{type:12,data:y},{type:12,data:v},{type:12,data:w},{type:12,data:j},{type:6,data:_},{type:12,data:m},{type:12,data:l},{type:12,data:d},...Xs(e[0].dims,e[1].dims)];n&&(k.push(...Xs(e[2].dims)),b.push("rank")),k.push(...Xs(r));return{name:"ConvTranspose2D",shaderCache:{hint:`${t.cacheKey};${c}${f}${h}${u}${p}`,inputDependencies:b},getRunData:()=>({dispatchGroup:{x:g[0],y:g[1],z:g[2]},outputs:[{dims:a?a(r):r,dataType:e[0].dataType}],programUniforms:k}),getShaderSource:t=>{let a=[{name:"output_size",type:"u32"},{name:"strides",type:"u32",length:y.length},{name:"filter_dims",type:"u32",length:v.length},{name:"dilations",type:"u32",length:v.length},{name:"effective_filter_dims",type:"u32",length:j.length},{name:"pads",type:"i32",length:_.length},{name:"input_channels_per_group_int",type:"u32"},{name:"input_channels_per_group",type:"u32"},{name:"output_channels_per_group",type:"u32"}],i=Gs(e[0].dataType),o=s?1:2,l=s?2:3,d=s?3:1,m=ai("W",e[1].dataType,e[1].dims.length,f),x=ai("Dy",e[0].dataType,e[0].dims.length,c),g=[x,m];n&&g.push(ai("bias",e[2].dataType,[r[d]].length,h));let b=ni("result",e[0].dataType,r.length,h),w=`\n            let outputIndices = ${b.offsetToIndices(`global_idx * ${h}`)};\n            let batch = ${b.indicesGet("outputIndices",0)};\n            let d1 = ${b.indicesGet("outputIndices",d)};\n            let r = ${b.indicesGet("outputIndices",o)};\n            let c = ${b.indicesGet("outputIndices",l)};\n            let dyCorner = vec2<i32>(i32(r), i32(c)) - uniforms.pads;\n            let dyRCorner = dyCorner.x;\n            let dyCCorner = dyCorner.y;\n            let groupId = d1 / uniforms.output_channels_per_group;\n            let wOutChannel = d1 - groupId * uniforms.output_channels_per_group;\n            // Convolve dy(?, ?, d2) with w(:, :, d1, d2) to compute dx(xR, xC, d1).\n            // ? = to be determined. : = across all values in that axis.\n            var dotProd = ${b.type.value}(0.0);\n            var wR: u32 = 0;\n            if (uniforms.dilations.x == 1) {\n              // Minimum wR >= 0 that satisfies (dyRCorner + wR) % (uniforms.strides.x) == 0\n              wR = u32(((dyRCorner + i32(uniforms.strides.x) - 1) / i32(uniforms.strides.x)) * i32(uniforms.strides.x) - dyRCorner);\n            }\n            for (; wR < uniforms.effective_filter_dims.x; wR = wR + 1) {\n              if (wR % uniforms.dilations.x != 0) {\n                continue;\n              }\n              let dyR = (${i}(dyRCorner) + ${i}(wR)) / ${i}(uniforms.strides[0]);\n              let wRPerm = uniforms.filter_dims.x - 1 - wR / uniforms.dilations.x;\n              if (dyR < 0.0 || dyR >= ${i}(uniforms.Dy_shape[${o}]) || fract(dyR) > 0.0 ||\n                  wRPerm < 0) {\n                continue;\n              }\n              let idyR: u32 = u32(dyR);\n              var wC: u32 = 0;\n              if (uniforms.dilations.y == 1) {\n                // Minimum wC >= 0 that satisfies (dyCCorner + wC) % (uniforms.strides.y) == 0\n                wC = u32(((dyCCorner + i32(uniforms.strides.y) - 1) / i32(uniforms.strides.y)) * i32(uniforms.strides.y) - dyCCorner);\n              }\n              for (; wC < uniforms.effective_filter_dims.y; wC = wC + 1) {\n                if (wC % uniforms.dilations.y != 0) {\n                  continue;\n                }\n                let dyC = (${i}(dyCCorner) + ${i}(wC)) / ${i}(uniforms.strides.y);\n                let wCPerm = uniforms.filter_dims.y - 1 - wC / uniforms.dilations.y;\n                if (dyC < 0.0 || dyC >= ${i}(uniforms.Dy_shape[${l}]) ||\n                    fract(dyC) > 0.0 || wCPerm < 0) {\n                  continue;\n                }\n                let idyC: u32 = u32(dyC);\n                var inputChannel = groupId * uniforms.input_channels_per_group;\n                ${u?`\n                var x_offset = ${x.indicesToOffset(`${x.type.indices}(batch, idyR, idyC, inputChannel)`)} / ${c};\n                var w_offset = ${m.indicesToOffset(`${m.type.indices}(wRPerm, wCPerm, inputChannel, wOutChannel)`)} / ${f};\n                  `:""}\n                for (var d2: u32 = 0; d2 < uniforms.input_channels_per_group_int; d2 = d2 + ${u?4:c}) {\n                  ${(()=>{let e="";if(u)4===c?e+=`\n        let xValue = ${x.getByOffset("x_offset")};\n        let wValue = ${m.getByOffset("w_offset")};\n        dotProd = dotProd + dot(xValue, wValue);\n        x_offset += 1u;\n        w_offset += 1u;`:2===c?e+=`\n          dotProd = dotProd + dot(vec4<${i}>(${x.getByOffset("x_offset")}, ${x.getByOffset("x_offset + 1u")}), vec4<${i}>(${m.getByOffset("w_offset")}, ${m.getByOffset("w_offset + 1u")}));\n          x_offset += 2u;\n          w_offset += 2u;`:1===c&&(e+=`\n          dotProd = dotProd + dot(vec4<${i}>(${x.getByOffset("x_offset")}, ${x.getByOffset("x_offset + 1u")}, ${x.getByOffset("x_offset + 2u")}, ${x.getByOffset("x_offset + 3u")}), vec4<${i}>(${m.getByOffset("w_offset")}, ${m.getByOffset("w_offset + 1u")}, ${m.getByOffset("w_offset + 2u")}, ${m.getByOffset("w_offset + 3u")}));\n          x_offset += 4u;\n          w_offset += 4u;`);else if(e+=`\n                  let xValue = ${s?x.getByOffset(`${x.indicesToOffset(`${x.type.indices}(batch, idyR, idyC, inputChannel)`)} / ${c}`):x.get("batch","inputChannel","idyR","idyC")};\n        `,1===c)e+=`\n          let w_offset = ${m.indicesToOffset(`${m.type.indices}(u32(wRPerm), u32(wCPerm), inputChannel, wOutChannel)`)};\n          let wValue = ${m.getByOffset(`w_offset / ${f}`)};\n          dotProd = dotProd + xValue * wValue;`;else for(let t=0;t<c;t++)e+=`\n            let wValue${t} = ${m.getByOffset(`${m.indicesToOffset(`${m.type.indices}(u32(wRPerm), u32(wCPerm), inputChannel + ${t}, wOutChannel)`)} / ${f}`)};\n            dotProd = dotProd + xValue[${t}] * wValue${t};`;return e})()}\n                  inputChannel = inputChannel + ${u?4:c};\n                }\n                ${(()=>{if(0===p)return"";if(!u)throw new Error(`packInputAs4 ${u} is not true.`);let e="";if(1===c){e+="dotProd = dotProd";for(let t=0;t<p;t++)e+=`\n            + ${x.getByOffset(`x_offset + ${t}`)} * ${m.getByOffset(`w_offset + ${t}`)}`;e+=";"}else if(2===c){if(2!==p)throw new Error(`Invalid inputChannelsRemainder ${p}.`);e+=`\n          let xValue = ${x.getByOffset("x_offset")};\n          let wValue = ${m.getByOffset("w_offset")};\n          dotProd = dotProd + dot(xValue, wValue);`}return e})()}\n                wC = wC + uniforms.strides.y - 1;\n              }\n              wR = wR + uniforms.strides[0] - 1;\n            }\n            let value = dotProd${n?` + bias[d1 / ${h}]`:""};\n            ${b.setByOffset("global_idx","value")};\n          `;return`\n    ${t.registerUniforms(a).declareVariables(...g,b)}\n      ${t.mainStart()}\n      ${t.guardAgainstOutOfBoundsWorkgroupSizes("uniforms.output_size")};\n    ${w}}`}}}}),Rp=Ln(()=>{Op(),$p(),fp(),Sd=(e,t,a,n,r,s)=>(e-1)*t+a+(n-1)*r+1-s,Md=(e,t,a,n,r)=>{let s=Math.floor(e/2);"SAME_UPPER"===t?(a[n]=s,a[r]=e-s):"SAME_LOWER"===t&&(a[n]=e-s,a[r]=s)},zd=(e,t,a,n,r,s,i,o,l,d)=>{let c=e.length-2,u=0===d.length;l.length<c&&l.push(...Array(c-l.length).fill(0));let m=e[0],p=t[o?3:1]*r;for(let h=0,f=e.length-c-(o?1:0);h<c;++h,++f){let r=e[f],o=u?r*i[h]:d[h],m=Sd(r,i[h],s[h],t[f],a[h],o);Md(m,n,s,h,h+c),u&&d.push(i[h]*(r-1)+l[h]+(t[f]-1)*a[h]+1-s[h]-s[h+c])}d.splice(0,0,m),d.splice(o?3:1,0,p)},Td=(e,t)=>{let a=e.kernelShape.slice();if(0===e.kernelShape.length||0===e.kernelShape.reduce((e,t)=>e*t,1)){a.length=0;for(let e=2;e<t[1].dims.length;++e)a.push(t[1].dims[e])}let n="NHWC"===e.format;a.splice(0,0,t[1].dims[0]),a.splice(n?3:1,0,t[1].dims[1]);let r=e.pads.slice(),s=e.outputShape.slice(),i=e.outputPadding.slice(),o=t[0].dims,l=e.dilations.slice();if(0===l.reduce((e,t)=>e+t,0)){let e=t[0].dims.length-2;l=new Array(e).fill(1)}let d=e.strides.slice();if(0===d.reduce((e,t)=>e+t,0)){let e=t[0].dims.length-2;d=new Array(e).fill(1)}zd(o,a,l,e.autoPad,e.group,r,d,n,i,s);let c=Object.assign({},e);return Object.assign(c,{kernelShape:a,pads:r,outputPadding:i,outputShape:s,dilations:l,strides:d}),c},Ed=e=>{let t=Hl(e),a=e.format,n=["NOTSET","VALID","SAME_UPPER","SAME_LOWER"][typeof e.autoPad>"u"?0:e.autoPad],r=e.dilations,s=e.group,i=e.kernelShape,o=e.pads,l=e.strides,d=e.wIsConst();return{autoPad:n,format:a,dilations:r,group:s,kernelShape:i,outputPadding:e.outputPadding,outputShape:e.outputShape,pads:o,strides:l,wIsConst:d,...t,cacheKey:`${e.format};${t.activation};`}},Ad=(e,t)=>{if(!e||2!==e.length&&3!==e.length)throw new Error("Conv requires 2 or 3 inputs");if(4!==e[0].dims.length&&3!==e[0].dims.length)throw new Error("currently only support 2-dimensional conv");if(e[0].dims.length!==e[1].dims.length)throw new Error("filter does not have same dimension as input");if(e[0].dims["NHWC"===t.format?e[0].dims.length-1:1]!==e[1].dims[0])throw new Error("FILTER_IN_CHANNEL should be equal to DATA_CHANNEL");let a=e[1].dims[1]*t.group;if(3===e.length&&(1!==e[2].dims.length||e[2].dims[0]!==a))throw new Error("invalid bias");let n=e[0].dims.length-2;if(t.dilations.reduce((e,t)=>e+t,0)>0&&t.dilations.length!==n)throw new Error(`dilations should be ${n}D`);if(t.strides.reduce((e,t)=>e+t,0)>0&&t.strides.length!==n)throw new Error(`strides should be ${n}D`);if(t.pads.reduce((e,t)=>e+t,0)>0&&t.pads.length!==2*n)throw new Error(`pads should be ${2*n}D`);if(t.outputPadding.length!==n&&0!==t.outputPadding.length)throw new Error(`output_padding should be ${n}D`);if(t.kernelShape.reduce((e,t)=>e+t,0)>0&&0!==t.kernelShape.length&&t.kernelShape.length!==e[1].dims.length-2)throw new Error("invalid kernel shape");if(0!==t.outputShape.length&&t.outputShape.length!==e[0].dims.length-2)throw new Error("invalid output shape")},Id=(e,t,a,n)=>{let r=e.kernelCustomData.wT??e.compute(hi(t[1],[2,3,0,1]),{inputs:[1],outputs:[a.wIsConst?-2:-1]})[0];a.wIsConst&&!e.kernelCustomData.wT&&(e.kernelCustomData.wT=r);let s=[t[0],r];3===t.length&&s.push(t[2]),e.compute(Cd(s,a,n),{inputs:s})},Od=(e,t)=>{let a="NHWC"===t.format,n=[e.inputs[0].reshape(a?[e.inputs[0].dims[0],1,e.inputs[0].dims[1],e.inputs[0].dims[2]]:[e.inputs[0].dims[0],e.inputs[0].dims[1],1,e.inputs[0].dims[2]]),e.inputs[1].reshape([e.inputs[1].dims[0],e.inputs[1].dims[1],1,e.inputs[1].dims[2]])];3===e.inputs.length&&n.push(e.inputs[2]);let r=t.kernelShape;(0===r.length||0===r[0])&&(r=[e.inputs[1].dims[2]]);let s=t.dilations;(0===s.length||0===s[0])&&(s=[1]);let i=t.strides;(0===i.length||0===i[0])&&(i=[1]);let o=t.pads;0===o.length&&(o=[0,0]),o=[0,o[0],0,o[1]],i=[1].concat(i),s=[1].concat(s),r=[1].concat(r);let l=t.outputPadding;l=[0].concat(l);let d=Td({...t,pads:o,strides:i,dilations:s,kernelShape:r,outputPadding:l},n);Id(e,n,d,e=>a?[e[0],e[2],e[3]]:[e[0],e[1],e[3]])},Rd=(e,t)=>{if(Ad(e.inputs,t),3===e.inputs[0].dims.length)Od(e,t);else{let a=Td(t,e.inputs);Id(e,e.inputs,a)}}}),Vp=Ln(()=>{rp(),op(),pp(),hp(),Vd=(e,t,a,n)=>{let r=hs.size(t),s=t.length,i=ai("input",e,s),o=ni("output",e,s),l=6===a.dataType?a.getInt32Array()[0]:Number(a.getBigInt64Array()[0]),d=hs.normalizeAxis(l,s);return{name:"CumSum",shaderCache:{hint:n.cacheKey,inputDependencies:["rank"]},getRunData:()=>({outputs:[{dims:t,dataType:e}],dispatchGroup:{x:Math.ceil(r/64)},programUniforms:[{type:12,data:r},{type:12,data:d},...Xs(t,t)]}),getShaderSource:e=>{let t=` i32(${i.indicesGet("inputIndices","uniforms.axis")}) `,a=ei("uniforms.input_shape","uniforms.axis",s),r=n.reverse?t+(n.exclusive?" + 1":""):"0",l=n.reverse?a:t+(n.exclusive?"":" + 1");return`\n                ${e.registerUniform("outputSize","u32").registerUniform("axis","u32").declareVariables(i,o)}\n                ${e.mainStart()}\n                  ${e.guardAgainstOutOfBoundsWorkgroupSizes("uniforms.outputSize")}\n                  var inputIndices = ${o.offsetToIndices("global_idx")};\n                  var sum = ${o.type.value}(0);\n                  let first : i32 = ${r};\n                  let last : i32 = ${l};\n                  for (var i : i32 = first; i < last; i++) {\n                    ${i.indicesSet("inputIndices","uniforms.axis","u32(i)")};\n                    sum = sum + ${i.getByIndices("inputIndices")};\n                  }\n                  ${o.setByOffset("global_idx","sum")};\n                }`}}},Pd=(e,t)=>{let a=e.inputs[0].dims,n=e.inputs[0].dataType,r=e.inputs[1];e.compute(Vd(n,a,r,t),{inputs:[0]})},Dd=e=>{let t=1===e.exclusive,a=1===e.reverse;return Us({exclusive:t,reverse:a})}}),Pp=Ln(()=>{rp(),op(),pp(),hp(),Bd=e=>{if(!e||1!==e.length)throw new Error("DepthToSpace requires 1 input.");if(4!==e[0].dims.length)throw new Error("DepthToSpace requires 4D input.")},Ld=(e,t,a,n)=>{let r=[];r.push(`fn perm(i: ${n.type.indices}) -> ${a.type.indices} {\n    var a: ${a.type.indices};`);for(let s=0;s<t;++s)r.push(a.indicesSet("a",e[s],`i[${s}]`));return r.push("return a;}"),r.join("\n")},Fd=(e,t)=>{let a,n,r,s,i,o,l="NHWC"===t.format,d=t.blocksize,c="DCR"===t.mode;l?([a,n,r,s]=e.dims,i=c?[a,n,r,d,d,s/d**2]:[a,n,r,s/d**2,d,d],o=c?[0,1,3,2,4,5]:[0,1,4,2,5,3]):([a,n,r,s]=[e.dims[0],e.dims[2],e.dims[3],e.dims[1]],i=c?[a,d,d,s/d**2,n,r]:[a,s/d**2,d,d,n,r],o=c?[0,3,4,1,5,2]:[0,1,4,2,5,3]);let u=e.reshape(i),m=u.dims.length,p=e.dataType,h=ai("a",p,m),f=ni("output",p,m);return{name:"DepthToSpace",shaderCache:{hint:`${e.dims};${t.blocksize};${t.mode}`,inputDependencies:["rank"]},getRunData:e=>{let t=l?[a,n*d,r*d,s/d**2]:[a,s/d**2,n*d,r*d],i=hs.size(t),c=u.dims,m=hs.sortBasedOnPerm(c,o);return{outputs:[{dims:t,dataType:e[0].dataType}],dispatchGroup:{x:Math.ceil(i/64)},programUniforms:[{type:12,data:i},...Xs(c,m)]}},getShaderSource:e=>`\n  ${e.registerUniform("output_size","u32").declareVariables(h,f)}\n\n  ${Ld(o,m,h,f)}\n\n  ${e.mainStart()}\n    ${e.guardAgainstOutOfBoundsWorkgroupSizes("uniforms.output_size")}\n\n    let indices = ${f.offsetToIndices("global_idx")};\n    let aIndices = perm(indices);\n\n    ${f.setByOffset("global_idx",h.getByIndices("aIndices"))}\n  }`}},Wd=(e,t)=>{Bd(e.inputs),e.compute(Fd(e.inputs[0],t))},Ud=e=>Us({blocksize:e.blocksize,mode:e.mode,format:e.format})}),Dp=Ln(()=>{rp(),op(),pp(),hp(),Gd="^"+(Hd="("+(qd="[a-zA-Z]|\\.\\.\\.")+")+")+"$",Kd="^"+("("+Hd+",)*"+Hd)+"$",Xd=class{constructor(e=-1){this.symbolToIndices=new Map,this.inputIndex=e}addSymbol(e,t){let a=this.symbolToIndices.get(e);void 0===a?a=[t]:a.push(t),this.symbolToIndices.set(e,a)}},Yd=class{constructor(e,t){this.equation=t,this.hasEllipsis=!1,this.symbolToInfo=new Map,this.lhs=new Array,this.outputDims=[];let[a,n]=t.includes("->")?t.split("->",2):[t,""];if(!a.match(RegExp(Kd)))throw new Error("Invalid LHS term");if(a.split(",").forEach((t,a)=>{let n=e[a].dims.slice();if(!t.match(RegExp(Gd)))throw new Error("Invalid LHS term");let r=this.processTerm(t,!0,n,a);this.lhs.push(r)}),""===n)n+=[...this.symbolToInfo.entries()].filter(([e,t])=>1===t.count||"..."===e).map(([e])=>e).join("");else if(!n.match(RegExp(Hd)))throw new Error("Invalid RHS");n.match(RegExp(qd,"g"))?.forEach(e=>{if("..."===e)this.outputDims=this.outputDims.concat(this.ellipsisDims);else{let t=this.symbolToInfo.get(e);if(void 0===t)throw new Error("Invalid RHS symbol");this.outputDims.push(t.dimValue)}}),this.rhs=this.processTerm(n,!1,this.outputDims)}addSymbol(e,t,a){let n=this.symbolToInfo.get(e);if(void 0!==n){if(n.dimValue!==t&&1!==n.count)throw new Error("Dimension mismatch");n.count++,n.inputIndices.push(a)}else n={count:1,dimValue:t,inputIndices:[a]};this.symbolToInfo.set(e,n)}processTerm(e,t,a,n=-1){let r=a.length,s=!1,i=[],o=0;if(!e.match(RegExp(Gd))&&!t&&""!==e)throw new Error("Invalid LHS term");let l=e.match(RegExp(qd,"g")),d=new Xd(n);return l?.forEach((e,c)=>{if("..."===e){if(s)throw new Error("Only one ellipsis is allowed per input term");s=!0;let e=r-l.length+1;if(e<0)throw new Error("Ellipsis out of bounds");if(i=a.slice(o,o+e),this.hasEllipsis){if(this.ellipsisDims.length!==i.length||this.ellipsisDims.toString()!==i.toString())throw new Error("Ellipsis dimensions mismatch")}else{if(!t)throw new Error("Ellipsis must be specified in the LHS");this.hasEllipsis=!0,this.ellipsisDims=i}for(let t=0;t<i.length;t++){let e=String.fromCharCode(48+t);d.addSymbol(e,c+t),this.addSymbol(e,a[o++],n)}}else d.addSymbol(e,c+(this.hasEllipsis?this.ellipsisDims.length-1:0)),this.addSymbol(e,a[o++],n)}),d}},Zd=e=>e+"_max",Qd=(e,t,a,n)=>{let r=e.map(e=>e.length).map((e,a)=>ai(`input${a}`,t,e)),s=hs.size(n),i=ni("output",t,n.length),o=[...a.symbolToInfo.keys()].filter(e=>!a.rhs.symbolToIndices.has(e));return{name:"Einsum",shaderCache:{hint:a.equation,inputDependencies:e.map(()=>"rank")},getRunData:()=>{let r=o.filter(e=>a.symbolToInfo.has(e)).map(e=>({type:12,data:a.symbolToInfo.get(e)?.dimValue||0}));r.push({type:12,data:s});let i=e.map((e,t)=>[...Xs(e)]).reduce((e,t)=>e.concat(t),r);return i.push(...Xs(n)),{outputs:[{dims:n,dataType:t}],dispatchGroup:{x:Math.ceil(s/64)},programUniforms:i}},getShaderSource:e=>{let t=[],n=[],s=[],l=[],d=[],c=a.symbolToInfo.size===a.rhs.symbolToIndices.size;a.symbolToInfo.forEach((e,o)=>{if(a.rhs.symbolToIndices.has(o)){let n=a.rhs.symbolToIndices.get(o)?.[0];void 0!==n&&a.lhs.forEach((a,s)=>{if(e.inputIndices.includes(s)){let e=a.symbolToIndices.get(o);if(void 0===e)throw new Error("Invalid symbol error");e.forEach(e=>{t.push(`${r[s].indicesSet(`input${s}Indices`,e,i.indicesGet("outputIndices",n))}`)})}})}else a.lhs.forEach((t,a)=>{if(e.inputIndices.includes(a)){let e=t.symbolToIndices.get(o);if(void 0===e)throw new Error("Invalid symbol error");e.forEach(e=>{n.push(`${r[a].indicesSet(`input${a}Indices`,e,`${o}`)}`)}),d.push(`prod *= ${r[a].getByIndices(`input${a}Indices`)};`)}}),s.push(`for(var ${o}: u32 = 0; ${o} < uniforms.${Zd(o)}; ${o}++) {`),l.push("}")});let u=c?[...t,`let sum = ${r.map((e,t)=>e.getByIndices(`input${t}Indices`)).join(" * ")};`]:[...t,"var sum = 0.0;",...s,...n,"var prod = 1.0;",...d,"sum += prod;",...l];return`\n            ${e.registerUniforms(o.map(e=>({name:`${Zd(e)}`,type:"u32"}))).registerUniform("outputSize","u32").declareVariables(...r,i)}\n\n            ${e.mainStart()}\n            ${e.guardAgainstOutOfBoundsWorkgroupSizes("uniforms.outputSize")}\n            var outputIndices = ${i.offsetToIndices("global_idx")};\n            ${r.map((e,t)=>`var input${t}Indices: ${r[t].type.indices};`).join("\n")}\n            ${u.join("\n")};\n            ${i.setByOffset("global_idx","sum")};\n          }`}}},Jd=(e,t)=>{let a=new Yd(e.inputs,t.equation),n=a.outputDims,r=e.inputs.map((e,t)=>e.dims);e.compute(Qd(r,e.inputs[0].dataType,a,n))},ec=e=>{let t=e.equation.replace(/\s+/g,"");return Us({equation:t})}}),Bp=Ln(()=>{rp(),op(),hp(),tc=e=>{if(!e||2!==e.length)throw new Error("Expand requires 2 input.");let t=e[0].dims,a=Array.from(e[1].getBigInt64Array(),Number),n=a.length<t.length?0:a.length-t.length,r=t.length<a.length?0:t.length-a.length;for(;n<a.length&&r<t.length;++n,++r)if(a[n]!==t[r]&&1!==a[n]&&1!==t[r])throw new Error("Expand requires shape to be broadcastable to input")},ac=(e,t)=>{let a=e.length-t.length,n=[];for(let r=0;r<a;++r)n.push(e[r]);for(let r=0;r<t.length;++r)n.push(1===t[r]?e[r+a]:t[r]);return n},nc=(e,t)=>e.length>t.length?ac(e,t):ac(t,e),rc=e=>{let t=e[0].dims,a=Array.from(e[1].getBigInt64Array(),Number),n=nc(t,a),r=e[0].dataType,s=9===r||1===hs.size(t),i=9===r||t.length>0&&t[t.length-1]%4==0?4:1,o=s||n.length>0&&n[n.length-1]%4==0?4:1,l=Math.ceil(hs.size(n)/o),d=[{type:12,data:l},...Xs(t,n)];return{name:"Expand",shaderCache:{hint:`${n.length};${i}${o}`,inputDependencies:["rank"]},getShaderSource:e=>{let a,s=ai("input",r,t.length,i),l=ni("output",r,n.length,o);if(9===r){let e=(e,t,a="")=>`\n          let outputIndices${t} = ${l.offsetToIndices(`outputOffset + ${t}u`)};\n          let offset${t} = ${s.broadcastedIndicesToOffset(`outputIndices${t}`,l)};\n          let index${t} = offset${t} / 4u;\n          let component${t} = offset${t} % 4u;\n          ${e}[${t}] = ${a}(${s.getByOffset(`index${t}`)}[component${t}]);\n        `;a=`\n        let outputOffset = global_idx * ${o};\n        var data = vec4<u32>(0);\n        ${e("data",0,"u32")}\n        ${e("data",1,"u32")}\n        ${e("data",2,"u32")}\n        ${e("data",3,"u32")}\n        ${l.setByOffset("global_idx","data")}\n      }`}else a=`\n        let outputIndices = ${l.offsetToIndices(`global_idx * ${o}`)};\n        let inputOffset = ${s.broadcastedIndicesToOffset("outputIndices",l)};\n        let data = ${l.type.value}(${s.getByOffset(`inputOffset / ${i}`)});\n        ${l.setByOffset("global_idx","data")}\n      }`;return`\n    ${e.registerUniform("vec_size","u32").declareVariables(s,l)}\n    ${e.mainStart()}\n    ${e.guardAgainstOutOfBoundsWorkgroupSizes("uniforms.vec_size")}\n    ${a}`},getRunData:()=>({outputs:[{dims:n,dataType:e[0].dataType}],dispatchGroup:{x:Math.ceil(l/64)},programUniforms:d})}},sc=e=>{tc(e.inputs),e.compute(rc(e.inputs),{inputs:[0]})}}),Lp=Ln(()=>{rp(),op(),hp(),jp(),ic=e=>{let t=e[0].dataType,a=hs.size(e[0].dims),n=hs.size(e[1].dims),r=n%4==0;return{name:"FastGeluWithBias",shaderCache:{hint:`${r}`,inputDependencies:["type","type"]},getShaderSource:e=>{let a=ai("x",t,[1],4),n=ai("bias",t,[1],4),s=ni("y",t,[1],4),i=e=>`\n      let bias${e}_offset: u32 = (global_idx * 4 + ${e}) % uniforms.bias_size;\n      let bias${e} = ${n.getByOffset(`bias${e}_offset / 4`)}[bias${e}_offset % 4];`,o=r?`\n      let bias = ${n.getByOffset("global_idx % (uniforms.bias_size / 4)")};`:`${i(0)}${i(1)}${i(2)}${i(3)}\n      let bias = ${a.type.value}(bias0, bias1, bias2, bias3);`;return`${e.registerUniforms([{name:"output_vec_size",type:"u32"},{name:"bias_size",type:"u32"}]).declareVariables(a,n,s)}\n\n    ${pl(Ks(t))}\n\n    ${e.mainStart(qs)}\n      ${e.guardAgainstOutOfBoundsWorkgroupSizes("uniforms.output_vec_size")}\n\n      let x = ${a.getByOffset("global_idx")};\n      ${o}\n      let x_in = x + bias;\n      ${s.setByOffset("global_idx",hl("x_in"))}\n    }`},getRunData:e=>({outputs:[{dims:e[0].dims,dataType:e[0].dataType}],programUniforms:[{type:12,data:Math.ceil(a/4)},{type:12,data:n}],dispatchGroup:{x:Math.ceil(a/qs/4)}})}},oc=e=>{e.inputs.length<2||0===hs.size(e.inputs[1].dims)?fl(e):e.compute(ic(e.inputs))}}),Fp=Ln(()=>{rp(),op(),pp(),hp(),lc=e=>{if(!e||2!==e.length)throw new Error("Gather requires 2 inputs.")},dc=(e,t)=>{let a=e[0].dims,n=e[1].dims,r=a.length,s=hs.normalizeAxis(t.axis,r),i=a.slice(0);i.splice(s,1,...n);let o=a[s],l=9===e[0].dataType?4:1,d=Math.ceil(hs.size(i)/l),c=[{type:12,data:d},{type:6,data:o},{type:12,data:s},...Xs(e[0].dims,e[1].dims,i)];return{name:"Gather",shaderCache:{hint:t.cacheKey,inputDependencies:["rank","rank"]},getRunData:()=>({outputs:[{dims:i,dataType:e[0].dataType}],dispatchGroup:{x:Math.ceil(d/64)},programUniforms:c}),getShaderSource:t=>{let a,o=ai("data",e[0].dataType,e[0].dims.length,l),d=ai("inputIndices",e[1].dataType,e[1].dims.length),c=ni("output",e[0].dataType,i.length,l),u=e=>{let t=n.length,a=`var indicesIndices${e}  = ${d.type.indices}(0);`;for(let n=0;n<t;n++)a+=`${t>1?`indicesIndices${e}[${n}]`:`indicesIndices${e}`} = ${i.length>1?`outputIndices${e}[uniforms.axis + ${n}]`:`outputIndices${e}`};`;a+=`\n          var idx${e} = ${d.getByIndices(`indicesIndices${e}`)};\n          if (idx${e} < 0) {\n            idx${e} = idx${e} + uniforms.axisDimLimit;\n          }\n          var dataIndices${e} : ${o.type.indices};\n        `;for(let n=0,o=0;n<r;n++)n===s?(a+=`${r>1?`dataIndices${e}[${n}]`:`dataIndices${e}`} = u32(idx${e});`,o+=t):(a+=`${r>1?`dataIndices${e}[${n}]`:`dataIndices${e}`} = ${i.length>1?`outputIndices${e}[${o}]`:`outputIndices${e}`};`,o++);return a};if(9===e[0].dataType){let e=(e,t,a="")=>`\n          let outputIndices${t} = ${c.offsetToIndices(`outputOffset + ${t}u`)};\n          ${u(t)};\n          let offset${t} = ${o.indicesToOffset(`dataIndices${t}`)};\n          let index${t} = offset${t} / 4u;\n          let component${t} = offset${t} % 4u;\n          ${e}[${t}] = ${a}(${o.getByOffset(`index${t}`)}[component${t}]);\n        `;a=`\n        let outputOffset = global_idx * ${l};\n        var value = vec4<u32>(0);\n        ${e("value",0,"u32")}\n        ${e("value",1,"u32")}\n        ${e("value",2,"u32")}\n        ${e("value",3,"u32")}\n        ${c.setByOffset("global_idx","value")}\n      `}else a=`\n      let outputIndices = ${c.offsetToIndices("global_idx")};\n      ${u("")};\n      let value = ${o.getByIndices("dataIndices")};\n      ${c.setByOffset("global_idx","value")};\n      `;return`\n      ${t.registerUniform("outputSize","u32").registerUniform("axisDimLimit","i32").registerUniform("axis","u32").declareVariables(o,d,c)}\n      ${t.mainStart()}\n        ${t.guardAgainstOutOfBoundsWorkgroupSizes("uniforms.outputSize")}\n        ${a}\n      }`}}},cc=e=>Us({axis:e.axis}),uc=(e,t)=>{let a=e.inputs;lc(a),e.compute(dc(e.inputs,t))}}),Wp=Ln(()=>{rp(),op(),hp(),mc=(e,t,a,n,r,s,i,o,l)=>{let d=[{type:12,data:s},{type:12,data:n},{type:12,data:r},{type:12,data:a},{type:12,data:i},{type:12,data:o},{type:12,data:l}],c=[s];d.push(...Xs(t.dims,c));return e.compute({name:"computeSliceOffsets",shaderCache:{hint:`${r.length}_${a.length}`,inputDependencies:["rank"]},getRunData:()=>({outputs:[{dims:c,dataType:e.inputs[1].dataType}],dispatchGroup:{x:Math.ceil(s/64)},programUniforms:d}),getShaderSource:e=>{let n=[ai("indices_data",t.dataType,t.dims.length),ni("input_slice_offsets_data",12,1,1)],s=[{name:"output_size",type:"u32"},{name:"batch_dims",type:"u32"},{name:"input_dims",type:"u32",length:r.length},{name:"sizes_from_slice_dims_data",type:"u32",length:a.length},{name:"num_slices_per_batch",type:"u32"},{name:"input_batch_stride",type:"u32"},{name:"num_slice_dims",type:"u32"}];return`\n  ${e.registerUniforms(s).declareVariables(...n)}\n  ${e.mainStart()}\n    ${e.guardAgainstOutOfBoundsWorkgroupSizes("uniforms.output_size")}\n    let batch_idx = global_idx / uniforms.num_slices_per_batch;\n    let base_offset = batch_idx * uniforms.input_batch_stride;\n\n    let slice_indices_base_offset = global_idx * uniforms.num_slice_dims;\n    var relative_slice_offset = 0;\n    for (var dim_idx = 0u; dim_idx < uniforms.num_slice_dims; dim_idx ++) {\n      var index = i32(indices_data[dim_idx + slice_indices_base_offset].x);\n      let input_dim_idx = uniforms.batch_dims + dim_idx;\n      if (index < 0) {\n        ${1===r.length?"index += i32(uniforms.input_dims);":"index += i32(uniforms.input_dims[input_dim_idx]);"}\n      }\n      ${1===a.length?"relative_slice_offset += index * i32(uniforms.sizes_from_slice_dims_data);":"relative_slice_offset += index * i32(uniforms.sizes_from_slice_dims_data[dim_idx]);"}\n    }\n\n    input_slice_offsets_data[global_idx] =  base_offset + u32(relative_slice_offset);\n  }`}},{inputs:[t],outputs:[-1]})[0]},pc=(e,t)=>{let a=e.inputs,n=a[0].dims,r=a[0].dataType,s=a[1].dims,i=s[s.length-1],o=hs.sizeToDimension(s,s.length-1),l=hs.sizeFromDimension(n,t.batchDims+i),d=hs.sizeToDimension(n,t.batchDims),c=hs.sizeFromDimension(n,t.batchDims),u=o/d,m=new Array(i),p=l;for(let y=0;y<i;++y)m[i-1-y]=p,p*=n[t.batchDims+i-1-y];let h=mc(e,a[1],m,t.batchDims,n,o,u,c,i),f=t.batchDims+i;if(f>n.length)throw new Error("last dimension of indices must not be larger than rank of input tensor");let x=s.slice(0,-1).concat(n.slice(f)),g=hs.size(x),b=[{type:12,data:g},{type:12,data:l},...Xs(a[0].dims,h.dims,x)];e.compute({name:"GatherND",shaderCache:{hint:t.cacheKey,inputDependencies:["rank","rank"]},getRunData:()=>({outputs:[{dims:x,dataType:r}],dispatchGroup:{x:Math.ceil(g/64)},programUniforms:b}),getShaderSource:e=>{let t=ai("data",a[0].dataType,a[0].dims.length),n=ai("slice_offsets",12,h.dims.length),r=ni("output",a[0].dataType,x.length);return`\n          ${e.registerUniform("output_size","u32").registerUniform("slice_size","u32").declareVariables(t,n,r)}\n            ${e.mainStart()}\n            ${e.guardAgainstOutOfBoundsWorkgroupSizes("uniforms.output_size")}\n          let slice_offset = slice_offsets[global_idx / uniforms.slice_size];\n          output[global_idx] = data[u32(slice_offset) + global_idx % uniforms.slice_size];\n        }`}},{inputs:[a[0],h]})},hc=e=>({batchDims:e.batch_dims,cacheKey:""})}),Up=Ln(()=>{rp(),op(),pp(),hp(),fc=(e,t)=>{if(e.length<3||e.length>4)throw new Error("GatherBlockQuantized requires 3 or 4 inputs.");let a=hs.normalizeAxis(t.quantizeAxis,e[0].dims.length),n=t.blockSize,r=e[0],s=e[2],i=4===e.length?e[3]:void 0;if(s.dims.length!==r.dims.length||!r.dims.map((e,t)=>t===a?Math.ceil(e/n)===s.dims[t]:e===s.dims[t]).reduce((e,t)=>e&&t,!0))throw new Error("Scales must have the same rank as the input tensor and the dims should match except on gatherAxis.");if(i){if(i.dataType!==r.dataType)throw new Error("Zero point must have the same data type as the input tensor.");if(i.dims.length!==s.dims.length||!i.dims.map((e,t)=>e===s.dims[t]).reduce((e,t)=>e&&t,!0))throw new Error("Zero point must have the same rank as the input tensor and the dims should match except on quantizeAxis.")}},xc=(e,t)=>{let a=e[0].dims,n=e[1].dims,r=a.length,s=hs.normalizeAxis(t.gatherAxis,r),i=hs.normalizeAxis(t.quantizeAxis,r),o=a.slice(0);o.splice(s,1,...n);let l=hs.size(o),d=e[2].dataType,c=22===e[0].dataType,u=[{type:12,data:l},{type:12,data:i},{type:12,data:s},{type:12,data:t.blockSize},...Xs(...e.map((e,t)=>e.dims),o)];return{name:"GatherBlockQuantized",shaderCache:{hint:`${t.cacheKey};${e.filter((e,t)=>1!==t).map(e=>e.dims.join("_")).join(";")}`,inputDependencies:Array.from({length:e.length},(e,t)=>"rank")},getRunData:()=>({outputs:[{dims:o,dataType:d}],dispatchGroup:{x:Math.ceil(l/64)},programUniforms:u}),getShaderSource:t=>{let r=ai("data",e[0].dataType,e[0].dims.length),i=ai("inputIndices",e[1].dataType,e[1].dims.length),l=ai("scales",e[2].dataType,e[2].dims.length),u=e.length>3?ai("zeroPoint",e[3].dataType,e[3].dims.length):void 0,m=ni("output",d,o.length),p=[r,i,l];u&&p.push(u);return`\n        ${t.registerUniforms([{name:"output_size",type:"u32"},{name:"quantize_axis",type:"u32"},{name:"gather_axis",type:"u32"},{name:"block_size",type:"u32"}]).declareVariables(...p,m)}\n        ${t.mainStart()}\n        let output_indices = ${m.offsetToIndices("global_idx")};\n        var indices_indices = ${i.type.indices}(0);\n        ${n.length>1?`\n          for (var i: u32 = 0; i < ${n.length}; i++) {\n            let index = ${m.indicesGet("output_indices","uniforms.gather_axis + i")};\n            ${i.indicesSet("indices_indices","i","index")};\n          }`:`indices_indices = ${m.indicesGet("output_indices","uniforms.gather_axis")};`};\n        var data_indices = ${r.type.indices}(0);\n        for (var i: u32 = 0; i < uniforms.gather_axis; i++) {\n          let index = ${m.indicesGet("output_indices","i")};\n          ${r.indicesSet("data_indices","i","index")};\n        }\n        var index_from_indices = ${i.getByIndices("indices_indices")};\n        if (index_from_indices < 0) {\n          index_from_indices += ${a[s]};\n        }\n        ${r.indicesSet("data_indices","uniforms.gather_axis","u32(index_from_indices)")};\n        for (var i = uniforms.gather_axis + 1; i < ${o.length}; i++) {\n          let index = ${m.indicesGet("output_indices",`i + ${n.length} - 1`)};\n          ${r.indicesSet("data_indices","i","index")};\n        }\n        let data_offset = ${r.indicesToOffset("data_indices")};\n        let data_index = data_offset % 8;\n        // Convert 4-bit packed data to 8-bit packed data.\n        let packed_4bit_quantized_data = ${r.getByOffset("data_offset / 8")};\n        let packed_8bit_quantized_data = (packed_4bit_quantized_data >> (4 * (data_index % 2))) & 0x0f0f0f0f;\n        let quantized_data_vec = ${c?"unpack4xI8":"unpack4xU8"}(u32(packed_8bit_quantized_data));\n        let quantized_data = quantized_data_vec[data_index / 2];\n        var scale_indices = data_indices;\n        let quantize_axis_index = ${l.indicesGet("data_indices","uniforms.quantize_axis")} / uniforms.block_size;\n        ${l.indicesSet("scale_indices","uniforms.quantize_axis","quantize_axis_index")};\n        var scale = ${l.getByIndices("scale_indices")};\n        ${u?`\n              let zero_point_indices = scale_indices;\n              let zero_point_offset = ${u.indicesToOffset("zero_point_indices")};\n              let zero_point_index = zero_point_offset % 8;\n              let packed_4bit_zero_points = ${u.getByOffset("zero_point_offset / 8")};\n              let packed_8bit_zero_points = (packed_4bit_zero_points >> (4 * (zero_point_index % 2))) & 0x0f0f0f0f;\n              let zero_point_vec = ${c?"unpack4xI8":"unpack4xU8"}(u32(packed_8bit_zero_points));\n              let zero_point = zero_point_vec[zero_point_index / 2];`:"var zero_point = 0"};\n        let dequantized_data = ${Ks(d)}(quantized_data - zero_point) * scale;\n        ${m.setByOffset("global_idx","dequantized_data")};\n    }`}}},gc=(e,t)=>{let a=e.inputs;fc(a,t),e.compute(xc(e.inputs,t))},bc=e=>Us({blockSize:e.blockSize,gatherAxis:e.gatherAxis,quantizeAxis:e.quantizeAxis})}),qp=Ln(()=>{rp(),op(),pp(),hp(),yc=e=>{if(!e||2!==e.length)throw new Error("GatherElements requires 2 inputs.");if(e[0].dims.length<1)throw new Error("GatherElements requires that the data input be rank >= 1.");if(e[0].dims.length!==e[1].dims.length)throw new Error("GatherElements requires that the data input and\n                     indices input tensors be of same rank.")},vc=(e,t)=>{let a=e[0].dims,n=e[0].dataType,r=a.length,s=e[1].dims,i=e[1].dataType,o=hs.normalizeAxis(t.axis,r),l=a[o],d=s.slice(0),c=hs.size(d),u=ai("input",n,r),m=ai("indicesInput",i,s.length),p=ni("output",n,d.length),h=[{type:12,data:c},{type:6,data:l},{type:12,data:o}];return h.push(...Xs(a,s,d)),{name:"GatherElements",shaderCache:{inputDependencies:["rank","rank"]},getRunData:()=>({outputs:[{dims:d,dataType:e[0].dataType}],dispatchGroup:{x:Math.ceil(c/64)},programUniforms:h}),getShaderSource:e=>`\n      ${e.registerUniform("outputSize","u32").registerUniform("axisDimLimit","i32").registerUniform("axis","u32").declareVariables(u,m,p)}\n      ${e.mainStart()}\n      ${e.guardAgainstOutOfBoundsWorkgroupSizes("uniforms.outputSize")}\n\n      let outputIndices = ${p.offsetToIndices("global_idx")};\n\n      var idx = ${m.getByOffset("global_idx")};\n      if (idx < 0) {\n        idx = idx + uniforms.axisDimLimit;\n      }\n      var inputIndices = ${u.type.indices}(outputIndices);\n      ${u.indicesSet("inputIndices","uniforms.axis","u32(idx)")};\n      let value = ${u.getByIndices("inputIndices")};\n\n      ${p.setByOffset("global_idx","value")};\n  }`}},wc=e=>Us({axis:e.axis}),jc=(e,t)=>{let a=e.inputs;yc(a),e.compute(vc(e.inputs,t))}}),Hp=Ln(()=>{rp(),op(),hp(),_c=e=>{if(!e)throw new Error("Input is missing");if(e.length<2||e.length>3)throw new Error("Invaid input number.");if(3===e.length&&e[2].dims.length>2)throw new Error("Invalid input shape of C");if(e[0].dataType!==e[1].dataType||3===e.length&&e[0].dataType!==e[2].dataType)throw new Error("Input types are mismatched")},kc=(e,t)=>{let a=e[0].dims.slice(),n=e[1].dims.slice(),[r,s,i]=xs.getShapeOfGemmResult(a,t.transA,n,t.transB,3===e.length?e[2].dims:void 0),o=[r,s];if(!o)throw new Error("Can't use gemm on the given tensors");let l=16,d=Math.ceil(s/l),c=Math.ceil(r/l),u=(hs.size(o),[{type:12,data:d},{type:12,data:r},{type:12,data:s},{type:12,data:i},{type:1,data:t.alpha},{type:1,data:t.beta}]),m=["type","type"];3===e.length&&(u.push(...Xs(e[2].dims)),m.push("rank")),u.push(...Xs(o));return{name:"GemmShared",shaderCache:{hint:`${t.cacheKey}`,inputDependencies:m},getRunData:()=>({outputs:[{dims:o,dataType:e[0].dataType}],dispatchGroup:{x:d*c},programUniforms:u}),getShaderSource:a=>{let n=ai("a",e[0].dataType,e[0].dims),r=ai("b",e[1].dataType,e[1].dims),s=null,i=[n,r];3===e.length&&(s=ai("c",e[2].dataType,e[2].dims.length),i.push(s));let d=ni("output",e[0].dataType,o.length);i.push(d);let c="",u="";t.transA&&t.transB?(u=`\n      var col = tile_row_start + local_id.x;\n      var row = k_start + local_id.y;\n      if (col < uniforms.M && row < uniforms.K) {\n        tile_a[local_id.y][local_id.x] = a[row * uniforms.M + col];\n      } else {\n        tile_a[local_id.y][local_id.x] = ${n.type.value}(0);\n      }\n\n      col = k_start + local_id.x;\n      row = tile_col_start + local_id.y;\n      if (col < uniforms.K && row < uniforms.N) {\n        tile_b[local_id.y][local_id.x] = b[row * uniforms.K + col];\n      } else {\n        tile_b[local_id.y][local_id.x] = ${r.type.value}(0);\n      }\n      `,c="value += tile_a[k][local_id.y] * tile_b[local_id.x][k];"):t.transA&&!t.transB?(u=`\n      var col = tile_row_start + local_id.x;\n      var row = k_start + local_id.y;\n      if (col < uniforms.M && row < uniforms.K) {\n        tile_a[local_id.y][local_id.x] = a[row * uniforms.M + col];\n      } else {\n        tile_a[local_id.y][local_id.x] = ${n.type.value}(0);\n      }\n\n      col = tile_col_start + local_id.x;\n      row = k_start + local_id.y;\n      if (col < uniforms.N && row < uniforms.K) {\n        tile_b[local_id.y][local_id.x] = b[row * uniforms.N + col];\n      } else {\n        tile_b[local_id.y][local_id.x] = ${r.type.value}(0);\n      }\n      `,c="value += tile_a[k][local_id.y] * tile_b[k][local_id.x];"):!t.transA&&t.transB?(u=`\n      var col = k_start + local_id.x;\n      var row = tile_row_start + local_id.y;\n      if (col < uniforms.K && row < uniforms.M) {\n        tile_a[local_id.y][local_id.x] = a[row * uniforms.K + col];\n      } else {\n        tile_a[local_id.y][local_id.x] = ${n.type.value}(0);\n      }\n\n      col = k_start + local_id.x;\n      row = tile_col_start + local_id.y;\n      if (col < uniforms.K && row < uniforms.N) {\n        tile_b[local_id.y][local_id.x] = b[row * uniforms.K + col];\n      } else {\n        tile_b[local_id.y][local_id.x] = ${r.type.value}(0);\n      }\n      `,c="value += tile_a[local_id.y][k] * tile_b[local_id.x][k];"):!t.transA&&!t.transB&&(u=`\n      var col = k_start + local_id.x;\n      var row = tile_row_start + local_id.y;\n      if (col < uniforms.K && row < uniforms.M) {\n        tile_a[local_id.y][local_id.x] = a[row * uniforms.K + col];\n      } else {\n        tile_a[local_id.y][local_id.x] = ${n.type.value}(0);\n      }\n\n      col = tile_col_start + local_id.x;\n      row = k_start + local_id.y;\n      if (col < uniforms.N && row < uniforms.K) {\n        tile_b[local_id.y][local_id.x] = b[row * uniforms.N + col];\n      } else {\n        tile_b[local_id.y][local_id.x] = ${r.type.value}(0);\n      }\n      `,c="value += tile_a[local_id.y][k] * tile_b[k][local_id.x];");let m=1===t.alpha?"":"value *= uniforms.alpha;";return`\n  ${a.registerUniforms([{name:"num_tile_n",type:"u32"},{name:"M",type:"u32"},{name:"N",type:"u32"},{name:"K",type:"u32"},{name:"alpha",type:"f32"},{name:"beta",type:"f32"}]).declareVariables(...i)}\n  var<workgroup> tile_a: array<array<${n.type.storage}, 16>, 16>;\n  var<workgroup> tile_b: array<array<${r.type.storage}, 16>, 16>;\n  ${a.mainStart([l,l,1])}\n    let tile_col_start = (workgroup_index % uniforms.num_tile_n) * 16;\n    let tile_row_start = (workgroup_index / uniforms.num_tile_n) * 16;\n    let num_tiles = (uniforms.K - 1) / 16 + 1;\n    var k_start = 0u;\n    var value = ${d.type.value}(0);\n    for (var t: u32 = 0u; t < num_tiles; t++) {\n      ${u}\n      k_start = k_start + 16;\n      workgroupBarrier();\n\n      for (var k: u32 = 0u; k < 16; k++) {\n        ${c}\n      }\n      workgroupBarrier();\n    }\n\n    ${m}\n    let m = tile_row_start + local_id.y;\n    let n = tile_col_start + local_id.x;\n    ${null!=s?`let cOffset = ${s.broadcastedIndicesToOffset("vec2(m, n)",d)}; value += ${d.type.value}(uniforms.beta) * ${s.getByOffset("cOffset")};`:""}\n    if (m < uniforms.M && n < uniforms.N) {\n      output[m * uniforms.N + n] = value;\n    }\n  }`}}},Nc=e=>({transA:e.transA,transB:e.transB,alpha:e.alpha,beta:e.beta,cacheKey:`${e.transA};${e.transB};${1===e.alpha}`}),$c=(e,t)=>{_c(e.inputs),e.compute(kc(e.inputs,t))}}),Gp=Ln(()=>{rp(),op(),pp(),hp(),[Cc,Sc,Mc,zc]=[0,1,2,3],Tc=e=>{if(4!==e[0].dims.length)throw new Error("only 4-D tensor is supported.");if(e[0].dims.length!==e[1].dims.length)throw new Error("input dimensions must be equal to grid dimensions");if(e[0].dims.length-2!==e[1].dims[e[1].dims.length-1])throw new Error("last dimension of grid must be equal to "+(e[0].dims.length-2));if(e[0].dims[0]!==e[1].dims[0])throw new Error("grid batch size must match input batch size")},Ec=e=>`\n  fn gs_bicubic_interpolate(p: mat4x4<${e}>, x: f32, y: f32) -> ${e} {\n    var v: vec4<f32>;\n    var coeffs = gs_get_cubic_coeffs(x);\n    for (var i = 0; i < 4; i++) {\n      v[i] = coeffs[0] * p[i][0] + coeffs[1] * p[i][1] + coeffs[2] * p[i][2] + coeffs[3] * p[i][3];\n    }\n    coeffs = gs_get_cubic_coeffs(y);\n    let pixel = ${e}(coeffs[0] * v[0] + coeffs[1] * v[1] + coeffs[2] * v[2] + coeffs[3] * v[3]);\n    return pixel;\n  }\n`,Ac=e=>`\n  fn gs_denormalize(n: f32, length: i32) -> f32 {\n    ${0===e.alignCorners?"\n    // alignCorners: false => [-1, 1] to [-0.5, length - 0.5]\n    return ((n + 1.0) * f32(length) - 1.0) / 2.0;\n    ":"\n    // alignCorners: true => [-1, 1] to [0, length - 1]\n    return (n + 1.0) / 2.0 * (f32(length - 1));\n    "}\n  }\n`,Ic=e=>`\n  ${"reflection"===e.paddingMode?"\n      fn gs_reflect(x: i32, x_min: f32, x_max: f32) -> u32 {\n        var dx = 0.0;\n        var fx = f32(x);\n        let range = x_max - x_min;\n        if (fx < x_min) {\n          dx = x_min - fx;\n          let n = u32(dx / range);\n          let r = dx - f32(n) * range;\n          if (n % 2 == 0) {\n            fx = x_min + r;\n          } else {\n            fx = x_max - r;\n          }\n        } else if (fx > x_max) {\n          dx = fx - x_max;\n          let n = u32(dx / range);\n          let r = dx - f32(n) * range;\n          if (n % 2 == 0) {\n            fx = x_max - r;\n          } else {\n            fx = x_min + r;\n          }\n        }\n        return u32(fx);\n      }":""}\n`,Oc=(e,t,a)=>`\n  fn pixel_at_grid(r: i32, c: i32, H: i32, W: i32, batch: u32, channel: u32, border: vec4<f32>) -> ${t} {\n     var pixel = ${t}(0);\n     var indices = vec4<u32>(0);\n     indices[${Cc}] = batch;\n     indices[${Sc}] = channel;`+(()=>{switch(a.paddingMode){case"zeros":return`\n          if (r >= 0 && r < H && c >=0 && c < W) {\n            indices[${Mc}] = u32(r);\n            indices[${zc}] = u32(c);\n          } else {\n            return ${t}(0);\n          }\n        `;case"border":return`\n          indices[${Mc}] = u32(clamp(r, 0, H - 1));\n          indices[${zc}] = u32(clamp(c, 0, W - 1));\n        `;case"reflection":return`\n          indices[${Mc}] = gs_reflect(r, border[1], border[3]);\n          indices[${zc}] = gs_reflect(c, border[0], border[2]);\n        `;default:throw new Error(`padding mode ${a.paddingMode} is not supported`)}})()+`\n    return ${e.getByIndices("indices")};\n  }\n`,Rc=(e,t,a)=>(()=>{switch(a.mode){case"nearest":return`\n          let result = pixel_at_grid(i32(round(y)), i32(round(x)), H_in, W_in, indices[${Cc}], indices[${Sc}], border);\n        `;case"bilinear":return`\n          let x1 = i32(floor(x));\n          let y1 = i32(floor(y));\n          let x2 = x1 + 1;\n          let y2 = y1 + 1;\n\n          let p11 = pixel_at_grid(y1, x1, H_in, W_in, indices[${Cc}], indices[${Sc}], border);\n          let p12 = pixel_at_grid(y1, x2, H_in, W_in, indices[${Cc}], indices[${Sc}], border);\n          let p21 = pixel_at_grid(y2, x1, H_in, W_in, indices[${Cc}], indices[${Sc}], border);\n          let p22 = pixel_at_grid(y2, x2, H_in, W_in, indices[${Cc}], indices[${Sc}], border);\n\n          let dx2 = ${t}(f32(x2) - x);\n          let dx1 = ${t}(x - f32(x1));\n          let dy2 = ${t}(f32(y2) - y);\n          let dy1 = ${t}(y - f32(y1));\n          let result = dy2 * (dx2 * p11 + dx1 * p12) + dy1 * (dx2 * p21 + dx1 * p22);\n        `;case"bicubic":return`\n          let x0 = i32(floor(x)) - 1;\n          let y0 = i32(floor(y)) - 1;\n          var p: mat4x4<${t}>;\n          for (var h = 0; h < 4; h++) {\n            for (var w = 0; w < 4; w++) {\n              p[h][w] = pixel_at_grid(h + y0, w + x0, H_in, W_in, indices[${Cc}], indices[${Sc}], border);\n            }\n          }\n\n          let dx = x - f32(x0 + 1);\n          let dy = y - f32(y0 + 1);\n          let result = gs_bicubic_interpolate(p, dx, dy);\n        `;default:throw new Error(`mode ${a.mode} is not supported`)}})()+`${e.setByOffset("global_idx","result")}`,Vc=(e,t)=>{let a=ai("x",e[0].dataType,e[0].dims.length),n=[e[1].dims[0],e[1].dims[1],e[1].dims[2]],r=ai("grid",e[1].dataType,n.length,2),s=[e[0].dims[0],e[0].dims[1],e[1].dims[1],e[1].dims[2]];"NHWC"===t.format&&(s=[e[0].dims[0],e[1].dims[1],e[1].dims[2],e[0].dims[3]],[Cc,Sc,Mc,zc]=[0,3,1,2]);let i=ni("output",e[0].dataType,s.length),o=a.type.value,l=[{type:12,data:hs.size(s)},...Xs(e[0].dims,n,s)];return{name:"GridSample",shaderCache:{hint:`${t.cacheKey}`,inputDependencies:["type","type"]},getRunData:e=>{let t=hs.size(s);return{outputs:[{dims:s,dataType:e[0].dataType}],dispatchGroup:{x:Math.ceil(t/64)},programUniforms:l}},getShaderSource:e=>`\n  ${e.registerUniform("output_size","u32").declareVariables(a,r,i)}\n  \n  fn gs_get_cubic_coeffs(x: f32) -> vec4<f32> {\n    let cubic_alpha = -0.75f;\n    let x_abs = abs(x);\n    var coeffs: vec4<f32>;\n    coeffs[0] = (((cubic_alpha * (x_abs + 1) - 5 * cubic_alpha) * (x_abs + 1) + 8 * cubic_alpha) * (x_abs + 1) - 4 * cubic_alpha);\n    coeffs[1] = (((cubic_alpha + 2) * x_abs - (cubic_alpha + 3)) * x_abs * x_abs + 1);\n    coeffs[2] = (((cubic_alpha + 2) * (1 - x_abs) - (cubic_alpha + 3)) * (1 - x_abs) * (1 - x_abs) + 1);\n    coeffs[3] = (((cubic_alpha * (2 - x_abs) - 5 * cubic_alpha) * (2 - x_abs) + 8 * cubic_alpha) * (2 - x_abs) - 4 * cubic_alpha);\n    return coeffs;\n  }\n\n  ${Ec(o)}\n  ${Ac(t)}\n  ${Ic(t)}\n  ${Oc(a,o,t)}\n\n  ${e.mainStart()}\n    ${e.guardAgainstOutOfBoundsWorkgroupSizes("uniforms.output_size")}\n      let H_in = i32(uniforms.x_shape[${Mc}]);\n      let W_in = i32(uniforms.x_shape[${zc}]);\n\n      ${0===t.alignCorners?"\n      let x_min = -0.5;\n      let x_max = f32(W_in) - 0.5;\n      let y_min = -0.5;\n      let y_max = f32(H_in) - 0.5;\n      ":"\n      let x_min = 0.0;\n      let x_max = f32(W_in) - 1.0;\n      let y_min = 0.0;\n      let y_max = f32(H_in) - 1.0;\n      "};\n      let border = vec4<f32>(x_min, y_min, x_max, y_max);\n\n      let indices = ${i.offsetToIndices("global_idx")};\n      var grid_indices = vec3<u32>(indices[${Cc}], indices[${Mc}], indices[${zc}]);\n      let nxy = ${r.getByIndices("grid_indices")};\n      var x = gs_denormalize(f32(nxy[0]), W_in);\n      var y = gs_denormalize(f32(nxy[1]), H_in);\n\n      ${Rc(i,o,t)}\n  }`}},Pc=(e,t)=>{Tc(e.inputs),e.compute(Vc(e.inputs,t))},Dc=e=>Us({alignCorners:e.align_corners,mode:e.mode,paddingMode:e.padding_mode,format:e.format})}),Kp=Ln(()=>{rp(),op(),pp(),up(),yp(),hp(),fp(),Bc=(e,t)=>e.length>t&&e[t].dims.length>0?e[t]:void 0,Lc=(e,t)=>{let a=e[0],n=Bc(e,1),r=Bc(e,2),s=Bc(e,3),i=Bc(e,4),o=Bc(e,5),l=Bc(e,6),d=Bc(e,7);if(3!==a.dims.length&&5!==a.dims.length)throw new Error("Input query is expected to have 3 or 5 dimensions");let c,u=a.dims[0],m=a.dims[1],p=3===a.dims.length?a.dims[2]:t.numHeads*a.dims[4],h=m,f=0,x=0,g=Math.floor(p/t.numHeads);if(l&&d&&hs.size(l.dims)&&hs.size(d.dims)){if(4!==l.dims.length)throw new Error('Input "past_key" is expected to have 4 dimensions');if(l.dims[0]!==u||l.dims[1]!==t.numHeads||l.dims[3]!==g)throw new Error('Input "past_key" shape (batch_size, num_heads, past_sequence_length, head_size)');if(d.dims[0]!==u||d.dims[1]!==t.numHeads||d.dims[3]!==g)throw new Error('Input "past_value" shape (batch_size, num_heads, past_sequence_length, head_size)');if(l.dims[2]!==d.dims[2])throw new Error('Input "past_key" and "past_value" shall have same dim 2 (past_sequence_length)');if(4!==d.dims.length)throw new Error('Input "past_value" is expected to have 4 dimensions');f=l.dims[2],x=l.dims[2]}else if(l&&hs.size(l.dims)||d&&hs.size(d.dims))throw new Error('Input "past_key" and "past_value" shall be both present or both absent');if(n&&hs.size(n.dims)>0){if(3!==a.dims.length)throw new Error('Input "query" is expected to have 3 dimensions when key is given');if(n.dims.length<3||n.dims.length>5)throw new Error('Input "key" is expected to have 3, 4, or 5 dimensions');if(a.dims[0]!==n.dims[0])throw new Error('Input "query" and "key" shall have same dim 0 (batch size)');if(3===n.dims.length){if(n.dims[2]!==a.dims[2])throw new Error('Input "query" and "key" shall have same dim 2 (hidden_size)');c=2,h=n.dims[1]}else if(5===n.dims.length){if(n.dims[2]!==t.numHeads||2!==n.dims[3]||n.dims[4]!==g)throw new Error('Expect "key" shape (batch_size, kv_sequence_length, num_heads, 2, head_size) for packed kv');if(r)throw new Error('Expect "value" be none when "key" has packed kv format.');c=5,h=n.dims[1]}else{if(n.dims[1]!==t.numHeads||n.dims[3]!==g)throw new Error('Expect "key" shape (batch_size, num_heads, kv_sequence_length, head_size) for past_key');c=0,h=n.dims[2]}}else{if(5!==a.dims.length)throw new Error('Input "query" is expected to have 5 dimensions when key is empty');if(a.dims[2]!==t.numHeads||3!==a.dims[3])throw new Error('Expect "query" shape (batch_size, kv_sequence_length, num_heads, 3, head_size) for packed kv');c=3}if(s&&hs.size(s.dims)>0){if(1!==s.dims.length)throw new Error('Input "bias" is expected to have 1 dimension');if(n&&5===n.dims.length&&2===n.dims[3])throw new Error("bias is not allowed for packed kv.")}let b=f+h,y=0;if(i&&hs.size(i.dims)>0){y=8;let e=i.dims;throw 1===e.length?e[0]===u?y=1:e[0]===3*u+2&&(y=3):2===e.length&&e[0]===u&&e[1]===b&&(y=5),8===y?new Error('Input "key_padding_mask" shape shall be (batch_size) or (batch_size, total_sequence_length)'):new Error("Mask not supported")}let v=!1,w=p;if(r&&hs.size(r.dims)>0){if(3!==r.dims.length&&4!==r.dims.length)throw new Error('Input "value" is expected to have 3 or 4 dimensions');if(a.dims[0]!==r.dims[0])throw new Error('Input "query" and "value" shall have same dim 0 (batch_size)');if(3===r.dims.length){if(h!==r.dims[1])throw new Error('Input "key" and "value" shall have the same dim 1 (kv_sequence_length)');w=r.dims[2]}else{if(h!==r.dims[2])throw new Error('Input "key" and "value" shall have the same dim 2 (kv_sequence_length)');w=r.dims[1]*r.dims[3],v=!0}}if(i&&hs.size(i.dims)>0)throw new Error("Key padding mask is not supported");if(o&&hs.size(o.dims)>0){if(4!==o.dims.length)throw new Error('Input "attention_bias" is expected to have 4 dimensions');if(o.dims[0]!==u||o.dims[1]!==t.numHeads||o.dims[2]!==m||o.dims[3]!==b)throw new Error('Expect "attention_bias" shape (batch_size, num_heads, sequence_length, total_sequence_length)')}return{batchSize:u,sequenceLength:m,pastSequenceLength:f,kvSequenceLength:h,totalSequenceLength:b,maxSequenceLength:x,inputHiddenSize:0,hiddenSize:p,vHiddenSize:w,headSize:g,vHeadSize:Math.floor(w/t.numHeads),numHeads:t.numHeads,isUnidirectional:!1,pastPresentShareBuffer:!1,maskFilterValue:t.maskFilterValue,maskType:y,scale:t.scale,broadcastResPosBias:!1,passPastInKv:v,qkvFormat:c}},Fc=e=>Us({...e}),Wc=Us({perm:[0,2,1,3]}),Uc=(e,t,a,n,r,s,i)=>{let o=[n,r,s],l=hs.size(o),d=[{type:12,data:l},{type:12,data:i},{type:12,data:s}];return e.compute({name:"MultiHeadAttentionAddBias",shaderCache:{inputDependencies:["type","type"]},getRunData:()=>({outputs:[{dims:o,dataType:t.dataType,gpuDataType:0}],dispatchGroup:{x:Math.ceil(l/64)},programUniforms:d}),getShaderSource:e=>{let n=ni("qkv_with_bias",t.dataType,o),r=ai("qkv",t.dataType,o),s=ai("bias",a.dataType,o);return`\n  ${e.registerUniforms([{name:"output_size",type:"u32"},{name:"bias_offset",type:"u32"},{name:"hidden_size",type:"u32"}]).declareVariables(r,s,n)}\n  ${e.mainStart()}\n    ${e.guardAgainstOutOfBoundsWorkgroupSizes("uniforms.output_size")}\n    let bias_offset_idx = (global_idx % uniforms.hidden_size) + uniforms.bias_offset;\n\n    qkv_with_bias[global_idx] = qkv[global_idx] + bias[bias_offset_idx];\n  }`}},{inputs:[t,a],outputs:[-1]})[0]},qc=(e,t,a,n,r,s,i,o)=>{let l=s;if(i&&hs.size(i.dims)>0){if(1===n)throw new Error("AddBiasReshape is not implemented. Please export your model with packed QKV or KV");return l=Uc(e,s,i,t,n,a*r,o),l=l.reshape([t,n,a,r]),1===a||1===n?l:e.compute(hi(l,Wc.perm),{inputs:[l],outputs:[-1]})[0]}return 3===s.dims.length&&(l=s.reshape([t,n,a,r])),1===a||1===n?l:e.compute(hi(l,Wc.perm),{inputs:[l],outputs:[-1]})[0]},Hc=(e,t)=>{let a=Lc(e.inputs,t),n=e.inputs[0],r=Bc(e.inputs,1),s=Bc(e.inputs,2),i=Bc(e.inputs,3),o=Bc(e.inputs,4),l=Bc(e.inputs,5),d=Bc(e.inputs,6),c=Bc(e.inputs,7);if(5===n.dims.length)throw new Error("Packed QKV is not implemented");if(5===r?.dims.length)throw new Error("Packed KV is not implemented");let u=r&&s&&4===r.dims.length&&4===s.dims.length,m=qc(e,a.batchSize,a.numHeads,a.sequenceLength,a.headSize,n,i,0);if(u)return vo(e,m,r,s,o,void 0,d,c,l,a);if(!r||!s)throw new Error("key and value must be provided");let p=qc(e,a.batchSize,a.numHeads,a.kvSequenceLength,a.headSize,r,i,a.hiddenSize),h=qc(e,a.batchSize,a.numHeads,a.kvSequenceLength,a.vHeadSize,s,i,2*a.hiddenSize);vo(e,m,p,h,o,void 0,d,c,l,a)}}),Xp=Ln(()=>{rp(),op(),pp(),hp(),Gc=e=>{if(!e||e.length<1)throw new Error("too few inputs")},Kc=(e,t)=>{let a=[],n=t.numOutputs;return e[1].dims[0]>0&&(e[1].getBigInt64Array().forEach(e=>a.push(Number(e))),n=a.length),Us({numOutputs:n,axis:t.axis,splitSizes:a})},Xc=e=>`\nfn calculateOutputIndex(index: u32) -> u32 {\n    for (var i: u32 = 0u; i < ${e}u; i += 1u ) {\n    if (index < ${ei("uniforms.size_in_split_axis","i",e)}) {\n        return i;\n    }\n    }\n    return ${e}u;\n}`,Yc=e=>{let t=e.length,a=[];for(let n=0;n<t;++n){let r=e[n].setByIndices("indices","input[global_idx]");1===t?a.push(r):0===n?a.push(`if (output_number == ${n}u) { ${r} }`):n===t-1?a.push(`else { ${r} }`):a.push(`else if (output_number == ${n}) { ${r} }`)}return`\n      fn writeBufferData(output_number: u32, indices: ${e[0].type.indices}, global_idx: u32) {\n        ${a.join("\n")}\n      }`},Zc=(e,t)=>{let a=e[0].dims,n=hs.size(a),r=e[0].dataType,s=hs.normalizeAxis(t.axis,a.length),i=new Array(t.numOutputs),o=ai("input",r,a.length),l=new Array(t.numOutputs),d=[],c=[],u=0,m=[{type:12,data:n}];for(let p=0;p<t.numOutputs;p++){u+=t.splitSizes[p],l[p]=u;let n=a.slice();n[s]=t.splitSizes[p],c.push(n),i[p]=ni(`output${p}`,r,n.length),d.push({dims:c[p],dataType:e[0].dataType})}m.push({type:12,data:l},...Xs(a,...c));return{name:"Split",shaderCache:{hint:t.cacheKey,inputDependencies:["rank"]},getShaderSource:e=>`\n  ${e.registerUniform("input_size","u32").registerUniform("size_in_split_axis","u32",l.length).declareVariables(o,...i)}\n  ${Xc(l.length)}\n  ${Yc(i)}\n\n  ${e.mainStart()}\n    ${e.guardAgainstOutOfBoundsWorkgroupSizes("uniforms.input_size")}\n\n    var indices = ${o.offsetToIndices("global_idx")};\n    var index = ${o.indicesGet("indices",s)};\n    let output_number = calculateOutputIndex(index);\n    if (output_number != 0) {\n      index -= ${ei("uniforms.size_in_split_axis","output_number - 1u",l.length)};\n      ${o.indicesSet("indices",s,"index")};\n    }\n    writeBufferData(output_number, indices, global_idx);\n  }`,getRunData:()=>({outputs:d,dispatchGroup:{x:Math.ceil(n/64)},programUniforms:m})}},Qc=(e,t)=>{Gc(e.inputs);let a=1===e.inputs.length?t:Kc(e.inputs,t);e.compute(Zc(e.inputs,a),{inputs:[0]})},Jc=e=>{let t=e.axis,a=e.splitSizes,n=e.numOutputs<0?a.length:e.numOutputs;if(n!==a.length)throw new Error("numOutputs and splitSizes length must be equal");return Us({axis:t,numOutputs:n,splitSizes:a})}}),Yp=Ln(()=>{rp(),op(),pp(),hp(),eu=(e,t)=>{let[a,n,r,s]=e,{numHeads:i,rotaryEmbeddingDim:o}=t;if(3!==a.dims.length&&4!==a.dims.length)throw new Error(`Input 'x' is expected to have 3 or 4 dimensions, got ${a.dims.length}`);if(!hs.areEqual(n.dims,[])&&!hs.areEqual(n.dims,[1])&&2!==n.dims.length)throw new Error(`Input 'position_ids' is expected to have 0, 1, or 2 dimensions, got ${n.dims.length}`);if(2!==r.dims.length)throw new Error(`Input 'cos_cache' is expected to have 2 dimensions, got ${r.dims.length}`);if(2!==s.dims.length)throw new Error(`Input 'sin_cache' is expected to have 2 dimensions, got ${s.dims.length}`);if(!hs.areEqual(r.dims,s.dims))throw new Error("Inputs 'cos_cache' and 'sin_cache' are expected to have the same shape");if(o>0&&0===i)throw new Error("num_heads must be provided if rotary_embedding_dim is specified");let l=a.dims[0],d=a.dims[a.dims.length-2],c=r.dims[0],u=hs.sizeFromDimension(a.dims,1)/d,m=0===o?2*r.dims[1]:u/i;if(o>m)throw new Error("rotary_embedding_dim must be less than or equal to head_size");if(2===n.dims.length){if(l!==n.dims[0])throw new Error(`Input 'position_ids' dimension 0 should be of size batch_size, got ${n.dims[0]}`);if(d!==n.dims[1])throw new Error(`Input 'position_ids' dimension 1 should be of size sequence_length, got ${n.dims[1]}`)}if(m/2!==r.dims[1]&&o/2!==r.dims[1])throw new Error(`Input 'cos_cache' dimension 1 should be same as head_size / 2 or rotary_embedding_dim / 2, got ${r.dims[1]}`);if(d>c)throw new Error("Updating cos_cache and sin_cache in RotaryEmbedding is not currently supported")},tu=(e,t)=>{let{interleaved:a,numHeads:n,rotaryEmbeddingDim:r,scale:s}=t,i=e[0].dims[0],o=hs.sizeFromDimension(e[0].dims,1),l=e[0].dims[e[0].dims.length-2],d=o/l,c=e[2].dims[1],u=0===r?2*c:d/n,m=new Array(i,l,d/u,u-c),p=hs.computeStrides(m),h=[{type:1,data:s},{type:12,data:m},{type:12,data:p},...3===e[0].dims.length?new Array({type:12,data:[o,d,u,1]}):[],...4===e[0].dims.length?new Array({type:12,data:[o,u,l*u,1]}):[],...Xs(e[0].dims,e[1].dims,e[2].dims,e[3].dims,e[0].dims)];return{name:"RotaryEmbedding",shaderCache:{hint:Us({interleaved:a}).cacheKey,inputDependencies:["rank","rank","rank","rank"]},getShaderSource:t=>{let n=ai("input",e[0].dataType,e[0].dims.length),r=ai("position_ids",e[1].dataType,e[1].dims.length),s=ai("cos_cache",e[2].dataType,e[2].dims.length),i=ai("sin_cache",e[3].dataType,e[3].dims.length),o=ni("output",e[0].dataType,e[0].dims.length);return t.registerUniforms([{name:"scale",type:"f32"},{name:"global_shape",type:"u32",length:m.length},{name:"global_strides",type:"u32",length:p.length},{name:"input_output_strides",type:"u32",length:p.length}]),`\n        ${t.declareVariables(n,r,s,i,o)}\n\n        ${t.mainStart(qs)}\n          let half_rotary_emb_dim = uniforms.${s.name}_shape[1];\n          let bsnh = global_idx / uniforms.global_strides % uniforms.global_shape;\n          let size = uniforms.global_shape[0] * uniforms.global_strides[0];\n          ${t.guardAgainstOutOfBoundsWorkgroupSizes("size")}\n\n          if (bsnh[3] < half_rotary_emb_dim) {\n            let position_ids_idx =\n                ${r.broadcastedIndicesToOffset("bsnh.xy",ni("",r.type.tensor,2))};\n            let position_id =\n                u32(${r.getByOffset("position_ids_idx")}) + select(0, bsnh[1], position_ids_idx == 0);\n            let i = dot(bsnh, uniforms.input_output_strides) + select(0, bsnh[3], ${a});\n            let j = i + select(half_rotary_emb_dim, 1, ${a});\n            let re = ${n.getByOffset("i")} * ${s.get("position_id","bsnh[3]")} -\n                ${n.getByOffset("j")} * ${i.get("position_id","bsnh[3]")};\n            ${o.setByOffset("i","re")}\n            let im = ${n.getByOffset("i")} * ${i.get("position_id","bsnh[3]")} +\n                ${n.getByOffset("j")} * ${s.get("position_id","bsnh[3]")};\n            ${o.setByOffset("j","im")}\n          } else {\n            let k = dot(bsnh, uniforms.input_output_strides) + half_rotary_emb_dim;\n            ${o.setByOffset("k",n.getByOffset("k"))}\n          }\n        }`},getRunData:()=>({outputs:[{dims:e[0].dims,dataType:e[0].dataType}],dispatchGroup:{x:Math.ceil(hs.size(m)/qs)},programUniforms:h})}},au=(e,t)=>{eu(e.inputs,t),e.compute(tu(e.inputs,t))}}),Zp=Ln(()=>{pp(),rp(),yp(),Kp(),Xp(),fp(),Yp(),hp(),nu=(e,t)=>{if(t.doRotary&&e.length<=7)throw new Error("cos_cache and sin_cache inputs are required if do_rotary is specified");let a=e[0],n=e[1],r=e[2],s=e[3],i=e[4];if(0!==t.doRotary&&e.length<=7)throw new Error("cos_cast and sin_cache are expected if do_rotary attribute is non-zero");if(-1!==t.localWindowSize)throw new Error("Local attention is not supported");if(0!==t.softcap)throw new Error("Softcap is not supported");if(0!==t.rotaryInterleaved)throw new Error("Rotary interleaved is not supported");if(t.smoothSoftmax)throw new Error("Smooth softmax is not supported");if(3!==a.dims.length&&5!==a.dims.length)throw new Error("Input query is expected to have 3 or 5 dimensions");let o=a.dims[0],l=a.dims[1],d=3===a.dims.length?a.dims[2]:t.numHeads*a.dims[4],c=l,u=0,m=!n||0===n.dims.length,p=Math.floor(m?d/(t.numHeads+2*t.kvNumHeads):d/t.numHeads);m&&(d=p*t.numHeads);let h=s&&0!==s.dims.length,f=i&&0!==i.dims.length;if(h&&4===s.dims.length&&s.dims[0]===o&&s.dims[1]!==t.kvNumHeads&&s.dims[2]===t.kvNumHeads&&s.dims[3]===p)throw new Error("BSNH pastKey/pastValue is not supported");if(h&&f){if(4!==s.dims.length)throw new Error('Input "past_key" is expected to have 4 dimensions');if(4!==i.dims.length)throw new Error('Input "past_value" is expected to have 4 dimensions');u=s.dims[2]}else if(h||f)throw new Error('Input "past_key" and "past_value" shall be both present or both absent');let x=1;if(n&&n.dims.length>0){if(3!==a.dims.length)throw new Error('Input "query" is expected to have 3 dimensions when key is given');if(n.dims.length<3||n.dims.length>5)throw new Error('Input "key" is expected to have 3, 4, or 5 dimensions');if(a.dims[0]!==n.dims[0])throw new Error('Input "query" and "key" shall have same dim 0 (batch size)');if(3===n.dims.length){if(a.dims[2]%n.dims[2]!==0)throw new Error('Dimension 2 of "query" should be a multiple of "key"');c=n.dims[1]}else if(5===n.dims.length){if(n.dims[2]!==t.numHeads||2!==n.dims[3]||n.dims[4]!==p)throw new Error('Expect "key" shape (batch_size, kv_sequence_length, num_heads, 2, head_size) for packed kv');if(r)throw new Error('Expect "value" be none when "key" has packed kv format.');c=n.dims[1]}else{if(n.dims[1]!==t.numHeads||n.dims[3]!==p)throw new Error('Expect "key" shape (batch_size, num_heads, kv_sequence_length, head_size) for past_key');c=n.dims[2]}}else{if(3!==a.dims.length&&5!==a.dims.length)throw new Error('Input "query" is expected to have 3 or 5 dimensions when key is empty');if(5===a.dims.length&&(a.dims[2]!==t.numHeads||3!==a.dims[3]))throw new Error('Expect "query" shape (batch_size, kv_sequence_length, num_heads, 3, head_size) for packed kv');x=3}let g=!1,b=t.kvNumHeads?p*t.kvNumHeads:d;if(r&&r.dims.length>0){if(3!==r.dims.length&&4!==r.dims.length)throw new Error('Input "value" is expected to have 3 or 4 dimensions');if(a.dims[0]!==r.dims[0])throw new Error('Input "query" and "value" shall have same dim 0 (batch_size)');if(3===r.dims.length){if(c!==r.dims[1])throw new Error('Input "key" and "value" shall have the same dim 1 (kv_sequence_length)');b=r.dims[2]}else{if(c!==r.dims[2])throw new Error('Input "past_key" and "past_value" shall have the same dim 2 (kv_sequence_length)');b=r.dims[1]*r.dims[3],g=!0}}let y=e.length>4?e[5]:void 0;if(y&&1!==y.dims.length&&y.dims[0]!==o)throw new Error('Input "seqlens" is expected to have 1 dimension and the same dim 0 as batch_size');return{batchSize:o,sequenceLength:l,pastSequenceLength:u,kvSequenceLength:c,totalSequenceLength:-1,maxSequenceLength:-1,inputHiddenSize:0,hiddenSize:d,vHiddenSize:b,headSize:p,vHeadSize:Math.floor(b/t.kvNumHeads),numHeads:t.numHeads,kvNumHeads:t.kvNumHeads,nReps:t.numHeads/t.kvNumHeads,pastPresentShareBuffer:!1,maskType:0,scale:t.scale,broadcastResPosBias:!1,passPastInKv:g,qkvFormat:x}},ru=Us({perm:[0,2,1,3]}),su=(e,t,a)=>{let n=t,r=a.kvNumHeads;return 3===t.dims.length&&0!==a.kvSequenceLength&&(n=t.reshape([a.batchSize,a.kvSequenceLength,r,a.headSize]),n=e.compute(hi(n,ru.perm),{inputs:[n],outputs:[-1]})[0]),n},iu=(e,t,a,n)=>{let r=[e*t],s=e*t,i=[{type:12,data:s},{type:12,data:t},{type:12,data:e}];return{name:"GeneratePositionIds",shaderCache:{hint:`${e};${t}`,inputDependencies:["type","type"]},getRunData:()=>({outputs:[{dims:r,dataType:7}],dispatchGroup:{x:Math.ceil(s/64)},programUniforms:i}),getShaderSource:e=>{let t=ai("seq_lens",a.dataType,a.dims),s=ai("total_seq_lens",n.dataType,n.dims),i=ni("pos_ids",7,r);return`\n  ${e.registerUniforms([{name:"output_size",type:"u32"},{name:"sequence_length",type:"u32"},{name:"batch_size",type:"u32"}]).declareVariables(t,s,i)}\n  ${e.mainStart()}\n    ${e.guardAgainstOutOfBoundsWorkgroupSizes("uniforms.output_size")}\n    let total_sequence_length = u32(${s.getByOffset("0")});\n    let is_subsequent_prompt = uniforms.sequence_length > 1 && uniforms.sequence_length != total_sequence_length;\n    let is_first_prompt = !is_subsequent_prompt && uniforms.sequence_length == total_sequence_length;\n    let batch_idx = global_idx / uniforms.sequence_length;\n    let sequence_idx = i32(global_idx % uniforms.sequence_length);\n    var pos_id: i32 = 0;\n    let seqlen = ${t.getByOffset("batch_idx")};\n    let total_seqlen = seqlen + 1;\n    if (is_first_prompt) {\n      if (sequence_idx < total_seqlen) {\n        pos_id = sequence_idx;\n      } else {\n        pos_id = 1;\n      }\n      ${i.setByOffset("global_idx","pos_id")}\n    } else if (is_subsequent_prompt) {\n      let past_seqlen = total_seqlen - i32(uniforms.sequence_length);\n      if (past_seqlen + sequence_idx < total_seqlen) {\n        pos_id = past_seqlen + sequence_idx;\n      } else {\n        pos_id = 1;\n      }\n      ${i.setByOffset("global_idx","pos_id")}\n    } else if (global_idx < uniforms.batch_size) {\n      ${i.setByOffset("global_idx","seqlen")}\n    };\n  }\n  `}}},ou=(e,t)=>{let a=nu(e.inputs,t);if(5===e.inputs[0].dims.length)throw new Error("Packed QKV is not implemented");if(5===e.inputs[1]?.dims.length)throw new Error("Packed KV is not implemented");let n,r,s=e.inputs[0],i=e.inputs[1]&&e.inputs[1].dims.length>0?e.inputs[1]:void 0,o=e.inputs[2]&&e.inputs[2].dims.length>0?e.inputs[2]:void 0,l=e.inputs[3]&&0!==e.inputs[3].dims.length?e.inputs[3]:void 0,d=e.inputs[4]&&0!==e.inputs[4].dims.length?e.inputs[4]:void 0,c=e.inputs.length>4?e.inputs[5]:void 0,u=e.inputs.length>5?e.inputs[6]:void 0,m=a.kvNumHeads?a.kvNumHeads:a.numHeads,p=Us({axis:2,numOutputs:3,splitSizes:[a.numHeads*a.headSize,m*a.headSize,m*a.headSize]}),[h,f,x]=i||o?[s,i,o]:e.compute(Zc([s],p),{inputs:[s],outputs:[-1,-1,-1]});if(t.doRotary){let s=e.compute(iu(a.batchSize,a.sequenceLength,c,u),{inputs:[c,u],outputs:[-1]})[0],i=e.inputs[7],o=e.inputs[8],l=Us({interleaved:0!==t.rotaryInterleaved,numHeads:a.numHeads,rotaryEmbeddingDim:0,scale:t.scale}),d=[h,s,i,o],m=[-1];n=e.compute(tu(d,l),{inputs:d,outputs:m})[0],d.splice(0,1,f);let p=Us({interleaved:0!==t.rotaryInterleaved,numHeads:a.kvNumHeads,rotaryEmbeddingDim:0,scale:t.scale});r=e.compute(tu(d,p),{inputs:d,outputs:m})[0]}let g=qc(e,a.batchSize,a.numHeads,a.sequenceLength,a.headSize,t.doRotary?n:h,void 0,0),b=su(e,t.doRotary?r:f,a),y=su(e,x,a);vo(e,g,b,y,void 0,void 0,l,d,void 0,a,c,u)}}),Qp=Ln(()=>{rp(),op(),fp(),hp(),lu=(e,t,a,n,r,s,i,o)=>{let l=Ys(s),d=1===l?"f32":`vec${l}f`,c=1===l?"vec2f":`mat2x${l}f`,u=r*i,m=64;1===u&&(m=256);let p=[r,i,s/l],h=[r,i,2],f=[];f.push(...Xs(p,h));return e.compute({name:"InstanceNormComputeChannelScaleShift",shaderCache:{hint:`${l};${o};${m}`,inputDependencies:["rank","type","type"]},getRunData:()=>({outputs:[{dims:h,dataType:1}],dispatchGroup:{x:u},programUniforms:f}),getShaderSource:e=>{let r=ai("x",t.dataType,3,l),s=[r,ai("scale",a.dataType,a.dims),ai("bias",n.dataType,n.dims),ni("output",1,3,2)];return`\n  var<workgroup> workgroup_shared : array<${c}, ${m}>;\n  const workgroup_size = ${m}u;\n  ${e.declareVariables(...s)}\n  ${e.mainStart(m)}\n    let batch = workgroup_index / uniforms.x_shape[1];\n    let channel = workgroup_index % uniforms.x_shape[1];\n    let hight = uniforms.x_shape[2];\n    // initialize workgroup memory\n    var sum = ${d}(0);\n    var squared_sum = ${d}(0);\n    for (var h = local_idx; h < hight; h += workgroup_size) {\n      let value = ${d}(${r.get("batch","channel","h")});\n      sum += value;\n      squared_sum += value * value;\n    }\n    workgroup_shared[local_idx] = ${c}(sum, squared_sum);\n    workgroupBarrier();\n\n    for (var currSize = workgroup_size >> 1;  currSize > 0; currSize = currSize >> 1) {\n      if (local_idx < currSize) {\n        workgroup_shared[local_idx] = workgroup_shared[local_idx] + workgroup_shared[local_idx + currSize];\n      }\n      workgroupBarrier();\n    }\n    if (local_idx == 0) {\n      let sum_final = ${Js("workgroup_shared[0][0]",l)} / f32(hight * ${l});\n      let squared_sum_final = ${Js("workgroup_shared[0][1]",l)} / f32(hight * ${l});\n\n      let inv_std_dev = inverseSqrt(squared_sum_final - sum_final * sum_final + f32(${o}));\n      let channel_scale = inv_std_dev * f32(scale[channel]);\n      let channel_shift = f32(bias[channel]) - sum_final * channel_scale;\n      output[workgroup_index] = vec2f(channel_scale, channel_shift);\n    }\n  }`}},{inputs:[t,a,n],outputs:[-1]})[0]},du=(e,t,a)=>{let n=t[0].dims,r=n,s=n[0],i=n[1],o=hs.sizeFromDimension(n,2),l=Ys(o),d=hs.size(r)/l,c=lu(e,t[0],t[1],t[2],s,o,i,a.epsilon),u=[s,i,o/l],m=[s,i];e.compute({name:"InstanceNormalization",shaderCache:{hint:`${l}`,inputDependencies:["type","none"]},getRunData:()=>({outputs:[{dims:r,dataType:t[0].dataType}],dispatchGroup:{x:Math.ceil(d/64)},programUniforms:[{type:12,data:d},...Xs(u,m,u)]}),getShaderSource:e=>{let a=ai("x",t[0].dataType,u.length,l),n=ai("scale_shift",1,m.length,2),r=ni("output",t[0].dataType,u.length,l),s=[a,n,r];return`\n  ${e.registerUniform("output_size","u32").declareVariables(...s)}\n  ${e.mainStart()}\n  ${e.guardAgainstOutOfBoundsWorkgroupSizes("uniforms.output_size")}\n      let outputIndices = ${r.offsetToIndices("global_idx")};\n      let batch = outputIndices[0];\n      let channel = outputIndices[1];\n      let scale_shift = ${n.getByIndices("vec2<u32>(batch, channel)")};\n      let value = ${a.getByOffset("global_idx")} * ${r.type.value}(scale_shift.x) + ${r.type.value}(scale_shift.y);\n      ${r.setByOffset("global_idx","value")};\n  }`}},{inputs:[t[0],c]})},cu=(e,t,a)=>{let n=t[0].dims,r=n,s=n[0],i=n[n.length-1],o=hs.sizeFromDimension(n,1)/i,l=Ys(i),d=hs.size(r)/l,c=[{type:12,data:o},{type:12,data:Math.floor(i/l)}],u=!1,m=[0,n.length-1];for(let f=0;f<n.length-2;f++)u=u||1!==n[f+1],m.push(f+1);u=u&&1!==n[n.length-1];let p=u?e.compute(hi(e.inputs[0],m),{inputs:[e.inputs[0]],outputs:[-1]})[0]:e.inputs[0].reshape(Array.from({length:n.length},(e,t)=>n[m[t]])),h=lu(e,p,t[1],t[2],s,o,i,a.epsilon);e.compute({name:"InstanceNormalizationNHWC",shaderCache:{hint:`${l}`,inputDependencies:["type","type"]},getRunData:()=>({outputs:[{dims:r,dataType:t[0].dataType}],dispatchGroup:{x:Math.ceil(d/64)},programUniforms:c}),getShaderSource:e=>{let a=Gs(t[0].dataType),n=1===l?"vec2f":`mat${l}x2f`,s=e=>{let t=0===e?"x":"y",n=1===l?"f32":`vec${l}f`;switch(l){case 1:return`${a}(${n}(scale.${t}))`;case 2:return`vec2<${a}>(${n}(scale[0].${t}, scale[1].${t}))`;case 4:return`vec4<${a}>(${n}(scale[0].${t}, scale[1].${t}, scale[2].${t}, scale[3].${t}))`;default:throw new Error(`Not supported compoents ${l}`)}},i=ai("input",t[0].dataType,t[0].dims,l),o=ni("output",t[0].dataType,r,l);return`\n  @group(0) @binding(0) var<storage, read> input : array<${i.type.storage}>;\n  @group(0) @binding(1) var<storage, read> scale_input : array<${n}>;\n  @group(0) @binding(2) var<storage, read_write> output : array<${o.type.storage}>;\n  struct Uniforms {H: u32, C : u32};\n  @group(0) @binding(3) var<uniform> uniforms: Uniforms;\n\n  ${e.mainStart()}\n    let current_image_number = global_idx / (uniforms.C * uniforms.H);\n    let current_channel_number = global_idx % uniforms.C;\n\n    let scale_offset = current_image_number * uniforms.C + current_channel_number;\n    let scale = scale_input[scale_offset];\n    output[global_idx] = fma(input[global_idx], ${s(0)}, ${s(1)});\n  }`}},{inputs:[t[0],h]})},uu=(e,t)=>{"NHWC"===t.format?cu(e,e.inputs,t):du(e,e.inputs,t)}}),Jp=Ln(()=>{rp(),op(),hp(),mu=e=>{if(!e||e.length<2)throw new Error("layerNorm requires at least 2 inputs.")},pu=(e,t,a)=>{let n=t.simplified,r=e[0].dims,s=e[1],i=!n&&e[2],o=r,l=hs.normalizeAxis(t.axis,r.length),d=hs.sizeToDimension(r,l),c=hs.sizeFromDimension(r,l),u=hs.size(s.dims),m=i?hs.size(i.dims):0;if(u!==c||i&&m!==c)throw new Error(`Size of X.shape()[axis:] == ${c}.\n       Size of scale and bias (if provided) must match this.\n       Got scale size of ${u} and bias size of ${m}`);let p=[];for(let v=0;v<r.length;++v)v<l?p.push(r[v]):p.push(1);let h=Ys(c),f=["type","type"],x=[{type:12,data:d},{type:1,data:c},{type:12,data:Math.floor(c/h)},{type:1,data:t.epsilon}];i&&f.push("type");let g=a>1,b=a>2,y=[{dims:o,dataType:e[0].dataType}];return g&&y.push({dims:p,dataType:1}),b&&y.push({dims:p,dataType:1}),{name:"LayerNormalization",shaderCache:{hint:`${h};${a};${n}`,inputDependencies:f},getRunData:()=>({outputs:y,dispatchGroup:{x:Math.ceil(d/64)},programUniforms:x}),getShaderSource:t=>{let a=Gs(e[0].dataType),r=[ai("x",e[0].dataType,e[0].dims,h),ai("scale",s.dataType,s.dims,h)];i&&r.push(ai("bias",i.dataType,i.dims,h)),r.push(ni("output",e[0].dataType,o,h)),g&&r.push(ni("mean_data_output",1,p)),b&&r.push(ni("inv_std_output",1,p));return`\n  ${t.registerUniforms([{name:"norm_count",type:"u32"},{name:"norm_size",type:"f32"},{name:"norm_size_vectorized",type:"u32"},{name:"epsilon",type:"f32"}]).declareVariables(...r)}\n  ${t.mainStart()}\n    ${t.guardAgainstOutOfBoundsWorkgroupSizes("uniforms.norm_count")}\n    let offset = global_idx * uniforms.norm_size_vectorized;\n    var mean_vector = ${Zs("f32",h)};\n    var mean_square_vector = ${Zs("f32",h)};\n\n    for (var h: u32 = 0u; h < uniforms.norm_size_vectorized; h++) {\n      let value = ${Qs(a,h,"x[h + offset]")};\n      mean_vector += value;\n      mean_square_vector += value * value;\n    }\n    let mean = ${Js("mean_vector",h)} / uniforms.norm_size;\n    let inv_std_dev = inverseSqrt(${Js("mean_square_vector",h)} / uniforms.norm_size ${n?"":"- mean * mean"} + uniforms.epsilon);\n\n    for (var j: u32 = 0; j < uniforms.norm_size_vectorized; j++) {\n      let f32input = ${Qs(a,h,"x[j + offset]")};\n      let f32scale = ${Qs(a,h,"scale[j]")};\n      output[j + offset] = ${r[0].type.value}((f32input ${n?"":"- mean"}) * inv_std_dev * f32scale\n        ${i?`+ ${Qs(a,h,"bias[j]")}`:""}\n      );\n    }\n\n    ${g?"mean_data_output[global_idx] = mean":""};\n    ${b?"inv_std_output[global_idx] = inv_std_dev":""};\n  }`}}},hu=(e,t)=>{mu(e.inputs),e.compute(pu(e.inputs,t,e.outputCount))}}),eh=Ln(()=>{op(),Mp(),zp(),fu=e=>{if(!e||2!==e.length)throw new Error("MatMul requires 2 inputs.");if(e[0].dims[e[0].dims.length-1]!==e[1].dims[e[1].dims.length-2])throw new Error("shared dimension does not match.")},xu=e=>{fu(e.inputs);let t=ps.calcShape(e.inputs[0].dims,e.inputs[1].dims,!0);if(!t)throw new Error("Can't use matmul on the given tensors");let a=t[t.length-1],n=e.inputs[0].dims[e.inputs[0].dims.length-1];if(a<8&&n<8)e.compute(Zl(e.inputs,{activation:""},t));else{let r=t[t.length-2],s=hs.size(e.inputs[0].dims.slice(0,-2)),i=hs.size(e.inputs[1].dims.slice(0,-2));if(1!==s&&1===r&&1===i){let r=[1,s,a],i=[e.inputs[0].reshape([1,s,n]),e.inputs[1].reshape([1,n,a])];e.compute(sd(i,{activation:""},t,r),{inputs:i})}else e.compute(sd(e.inputs,{activation:""},t))}}}),th=Ln(()=>{rp(),op(),pp(),hp(),gu=(e,t)=>{if(e.length<3||e.length>4)throw new Error("MatMulNBits requires 3 or 4 inputs");let a=e[0],n=a.dims.length;if(a.dims[n-1]!==t.k)throw new Error("The last dim of input shape does not match the k value");let r=Math.floor((t.k+t.blockSize-1)/t.blockSize),s=t.blockSize/8*t.bits,i=e[1];if(!hs.areEqual(i.dims,[t.n,r,s]))throw new Error("The second inputs must be 3D tensor with shape N X nBlocksPerCol X blobSize");let o=e[2].dims;if(hs.size(o)!==t.n*r)throw new Error("scales input size error.");if(4===e.length){let a=e[3].dims,n=t.n*(8===t.bits?r:Math.floor((r*t.bits+7)/8));if(hs.size(a)!==n)throw new Error("zeroPoints input size error.")}},bu=(e,t)=>{let a=e[0].dims,n=a.length,r=a[n-2],s=t.k,i=t.n,o=a.slice(0,n-2),l=hs.size(o),d=e[1].dims[2]/4,c=e[0].dataType,u=Ys(t.k),m=Ys(d),p=Ys(i),h=o.concat([r,i]),f=r>1&&i/p%2==0?2:1,x=hs.size(h)/p/f,g=64,b=[],y=[l,r,s/u],v=hs.convertShape(e[1].dims).slice();v.splice(-1,1,d/m),b.push(...Xs(y)),b.push(...Xs(v)),b.push(...Xs(e[2].dims)),4===e.length&&b.push(...Xs(hs.convertShape(e[3].dims)));let w=[l,r,i/p];b.push(...Xs(w));return{name:"MatMulNBits",shaderCache:{hint:`${t.blockSize};${t.bits};${u};${m};${p};${f};64`,inputDependencies:Array(e.length).fill("rank")},getRunData:()=>({outputs:[{dims:h,dataType:c}],dispatchGroup:{x:x},programUniforms:b}),getShaderSource:a=>{let n=y.length,r=ai("a",e[0].dataType,n,u),s=ai("b",12,v.length,m),i=ai("scales",e[2].dataType,e[2].dims.length),o=[r,s,i],l=4===e.length?ai("zero_points",12,e[3].dims.length):void 0;l&&o.push(l);let c=w.length,h=ni("output",e[0].dataType,c,p),x=Gs(e[0].dataType),b=(()=>{switch(u){case 1:return`array<${x}, 8>`;case 2:return`mat4x2<${x}>`;case 4:return`mat2x4<${x}>`;default:throw new Error(`${u}-component is not supported.`)}})();return`\n        var<workgroup> workgroup_shared: array<${h.type.value}, ${f*g}>;\n        ${a.declareVariables(...o,h)}\n        ${a.mainStart([g,1,1])}\n          let output_indices = ${h.offsetToIndices(`(global_idx / 64) * ${f}`)};\n          let col = output_indices[2];\n          let row = output_indices[1];\n          let batch = output_indices[0];\n          let nBlocksPerCol = uniforms.b_shape[1];\n\n          for (var block = local_id.x; block < nBlocksPerCol; block += 64) {\n            //process one block\n            var word_offset: u32 = block * ${t.blockSize/u};\n            ${(()=>{let e=`\n            var col_index = col * ${p};\n            ${l?"\n            let zero_point_bytes_per_col = (nBlocksPerCol + 1) / 2;\n            var zero_point_byte_count: u32;\n            var zero_point_word_index: u32;\n            var zero_point_byte_offset: u32;\n            let zero_point_nibble_offset: u32 = block & 0x1u;\n            var zero_point_bits_offset: u32;\n            var zero_point_word: u32;":`\n            // The default zero point is 8 for unsigned 4-bit quantization.\n            let zero_point = ${x}(8);`}\n            `;for(let t=0;t<p*f;t++)e+=`\n            let scale${t} = ${i.getByOffset("col_index * nBlocksPerCol + block")};\n            ${l?`\n            zero_point_byte_count = col_index * zero_point_bytes_per_col + (block >> 0x1u);\n            zero_point_word_index = zero_point_byte_count >> 0x2u;\n            zero_point_byte_offset = zero_point_byte_count & 0x3u;\n            zero_point_bits_offset = (zero_point_byte_offset << 3) + (zero_point_nibble_offset << 2);\n            zero_point_word = ${l.getByOffset("zero_point_word_index")} >> zero_point_bits_offset;\n            let zero_point${t} = ${x}((zero_point_word) & 0xFu);`:""}\n            col_index += 1;`;return e})()}\n            for (var word: u32 = 0; word < ${d}; word += ${m}) {\n              ${(()=>{let e=`col_index = col * ${p};`;for(let t=0;t<p*f;t++)e+=`\n            let b${t}_data = ${s.getByIndices(`${s.type.indices}(col_index, block, word)`)};\n            col_index += 1;`;return e+=`\n            var b_value: u32;\n            let b_mask: u32 = 0x0F0F0F0Fu;\n            var b_value_lower: vec4<u32>;\n            var b_value_upper: vec4<u32>;\n            var b_quantized_values: ${b};\n            var b_dequantized_values: ${b};`,e})()}\n              for (var i: u32 = 0; i < ${m}; i++) {\n                ${(()=>{let e=`\n          // reuse a data\n            var input_offset = ${r.indicesToOffset(`${r.type.indices}(batch, row, word_offset)`)};\n            var a_data: ${b};\n            for (var j: u32 = 0; j < ${8/u}; j++) {\n              a_data[j] = ${r.getByOffset("input_offset")};\n              input_offset++;\n            }\n          `;for(let t=0;t<p*f;t++)e+=`\n            b_value = ${1===m?`b${t}_data`:`b${t}_data[i]`};\n            b_value_lower = unpack4xU8(b_value & b_mask);\n            b_value_upper = unpack4xU8((b_value >> 4) & b_mask);\n            b_quantized_values = ${b}(${Array.from({length:4},(e,t)=>`${x}(b_value_lower[${t}]), ${x}(b_value_upper[${t}])`).join(", ")});\n            b_dequantized_values = ${1===u?`${b}(${Array.from({length:8},(e,a)=>`(b_quantized_values[${a}] - ${l?`zero_point${t}`:"zero_point"}) * scale${t}`).join(", ")});`:`(b_quantized_values - ${b}(${Array(8).fill(""+(l?`zero_point${t}`:"zero_point")).join(",")})) * scale${t};`};\n            workgroup_shared[local_id.x * ${f} + ${Math.floor(t/p)}]${p>1?`[${t%p}]`:""} += ${Array.from({length:8/u},(e,t)=>""+(1===u?`a_data[${t}] * b_dequantized_values[${t}]`:`dot(a_data[${t}], b_dequantized_values[${t}])`)).join(" + ")};\n          `;return e})()}\n                word_offset += ${8/u};\n              }\n            }\n          }\n          workgroupBarrier();\n\n          if (local_id.x < ${f}) {\n            var output_value: ${h.type.value} = ${h.type.value}(0);\n            var workgroup_shared_offset: u32 = local_id.x;\n            for (var b: u32 = 0u; b < 64u; b++) {\n              output_value += workgroup_shared[workgroup_shared_offset];\n              workgroup_shared_offset += ${f};\n            }\n            ${h.setByIndices(`${h.type.indices}(batch, row, col + local_id.x)`,"output_value")};\n          }\n        }`}}},yu=(e,t)=>{let a=e[0].dims,n=a.length,r=a[n-2],s=t.k,i=t.n,o=a.slice(0,n-2),l=hs.size(o),d=e[1].dims[2]/4,c=e[0].dataType,u=Ys(t.k),m=Ys(d),p=o.concat([r,i]),h=i%8==0?8:i%4==0?4:1,f=128/h,x=f*m*8,g=x/u,b=x/t.blockSize,y=hs.size(p)/h,v=[],w=[l,r,s/u],j=hs.convertShape(e[1].dims).slice();j.splice(-1,1,d/m),v.push(...Xs(w)),v.push(...Xs(j)),v.push(...Xs(e[2].dims)),4===e.length&&v.push(...Xs(hs.convertShape(e[3].dims)));let _=[l,r,i];v.push(...Xs(_));return{name:"BlockwiseMatMulNBits32",shaderCache:{hint:`${t.blockSize};${u};${m};${f};${h}`,inputDependencies:Array(e.length).fill("rank")},getRunData:()=>({outputs:[{dims:p,dataType:c}],dispatchGroup:{x:y},programUniforms:v}),getShaderSource:a=>{let n=w.length,r=ai("a",e[0].dataType,n,u),s=ai("b",12,j.length,m),i=ai("scales",e[2].dataType,e[2].dims.length),o=[r,s,i],l=4===e.length?ai("zero_points",12,e[3].dims.length):void 0;l&&o.push(l);let d=_.length,c=ni("output",e[0].dataType,d),p=Gs(e[0].dataType);return`\n        var<workgroup> sub_a: array<${r.type.value}, ${g}>;\n        var<workgroup> inter_results: array<array<${c.type.value}, ${f}>, ${h}>;\n        ${a.declareVariables(...o,c)}\n        ${a.mainStart([f,h,1])}\n          let output_indices = ${c.offsetToIndices(`workgroup_index * ${h}`)};\n          let col = output_indices[2];\n          let row = output_indices[1];\n          let batch = output_indices[0];\n          let n_blocks_per_col = uniforms.b_shape[1];\n          let num_tiles =  (n_blocks_per_col - 1) / ${b} + 1;\n\n          // Loop over shared dimension.\n          for (var tile: u32 = 0; tile < num_tiles; tile += 1) {\n            let a_col_start = tile * ${g};\n            // load one tile A data into shared memory.\n            for (var a_offset = local_idx; a_offset < ${g}; a_offset += 128)\n            {\n              let a_col = a_col_start + a_offset;\n              if (a_col < uniforms.a_shape[2])\n              {\n                sub_a[a_offset] = ${r.getByIndices(`${r.type.indices}(batch, row, a_col)`)};\n              } else {\n                sub_a[a_offset] = ${r.type.value}(0);\n              }\n            }\n            workgroupBarrier();\n\n            // each thread process one block\n            let b_row = col + local_id.y;\n            let block = tile * ${b} + local_id.x;\n            ${l?`\n            let zero_point_bytes_per_col = (n_blocks_per_col + 1) / 2;\n            let zero_point_byte_count = b_row * zero_point_bytes_per_col + (block >> 0x1u);\n            let zero_point_word_index = zero_point_byte_count >> 0x2u;\n            let zero_point_byte_offset = zero_point_byte_count & 0x3u;\n            let zero_point_nibble_offset: u32 = block & 0x1u;\n            let zero_point_bits_offset = (zero_point_byte_offset << 3) + (zero_point_nibble_offset << 2);\n            let zero_point_word = ${l.getByOffset("zero_point_word_index")} >> zero_point_bits_offset;\n            let zero_point = ${p}((zero_point_word) & 0xFu);`:`\n            // The default zero point is 8 for unsigned 4-bit quantization.\n            let zero_point = ${p}(8);`}\n            let scale = ${i.getByOffset("b_row * n_blocks_per_col + block")};\n            let b_data = ${s.getByIndices(`${s.type.indices}(b_row, block, 0)`)};\n            var word_offset = local_id.x * ${t.blockSize/u};\n            for (var i: u32 = 0; i < ${m}; i++) {\n              ${(()=>{switch(u){case 1:return`\n          let a_data0 = vec4<${p}>(sub_a[word_offset], sub_a[word_offset + 1], sub_a[word_offset + 2], sub_a[word_offset + 3]);\n          let a_data1 = vec4<${p}>(sub_a[word_offset + 4], sub_a[word_offset + 5], sub_a[word_offset + 6], sub_a[word_offset + 7]);`;case 2:return`\n          let a_data0 = vec4<${p}>(sub_a[word_offset], sub_a[word_offset + 1]);\n          let a_data1 = vec4<${p}>(sub_a[word_offset + 2], sub_a[word_offset + 3]);`;case 4:return"\n          let a_data0 = sub_a[word_offset];\n          let a_data1 = sub_a[word_offset + 1];";default:throw new Error(`${u}-component is not supported.`)}})()}\n              let b_value = ${1===m?"b_data":"b_data[i]"};\n              let b_value_lower = unpack4xU8(b_value & 0x0F0F0F0Fu);\n              let b_value_upper = unpack4xU8((b_value >> 4) & 0x0F0F0F0Fu);\n              let b_quantized_values = mat2x4<${p}>(${Array.from({length:4},(e,t)=>`${p}(b_value_lower[${t}]), ${p}(b_value_upper[${t}])`).join(", ")});\n              let b_dequantized_values = (b_quantized_values - mat2x4<${p}>(${Array(8).fill("zero_point").join(",")})) * scale;\n              inter_results[local_id.y][local_id.x] += ${Array.from({length:2},(e,t)=>`dot(a_data${t}, b_dequantized_values[${t}])`).join(" + ")};\n              word_offset += ${8/u};\n            }\n            workgroupBarrier();\n          }\n\n          if (local_idx < ${h}) {\n            var output_value: ${c.type.value} = ${c.type.value}(0);\n            for (var b = 0u; b < ${f}; b++) {\n              output_value += inter_results[local_idx][b];\n            }\n            if (col + local_idx < uniforms.output_shape[2])\n            {\n              ${c.setByIndices(`${c.type.indices}(batch, row, col + local_idx)`,"output_value")}\n            }\n          }\n        }`}}},vu=(e,t)=>{gu(e.inputs,t),32===t.blockSize&&e.adapterInfo.isVendor("intel")&&e.adapterInfo.isArchitecture("gen-12lp")?e.compute(yu(e.inputs,t)):e.compute(bu(e.inputs,t))},wu=e=>Us(e)}),ah=Ln(()=>{rp(),op(),hp(),ju=e=>{if(!e||e.length<1)throw new Error("Too few inputs");if(1!==e[0].dataType&&10!==e[0].dataType)throw new Error("Input type must be float or float16.");if(e.length>=2){let t=2*e[0].dims.length===e[1].dims[0];if(4===e.length&&(t=2*e[3].dims[0]===e[1].dims[0]),!t)throw new Error("The pads should be a 1D tensor of shape [2 * input_rank] or [2 * num_axes].")}},_u=(e,t,a)=>{let n="";for(let r=t-1;r>=0;--r)n+=`\n            k = i32(${e.indicesGet("indices",r)}) - ${ei("uniforms.pads",r,a)};\n            if (k < 0) {\n              break;\n            }\n            if (k >= i32(${ei("uniforms.x_shape",r,t)})) {\n              break;\n            }\n            offset += k * i32(${ei("uniforms.x_strides",r,t)});\n        `;return`\n          value = ${e.type.value}(uniforms.constant_value);\n          for (var i = 0; i < 1; i++) {\n            var offset = 0;\n            var k = 0;\n            ${n}\n            value = x[offset];\n          }\n      `},ku=(e,t,a)=>{let n="";for(let r=t-1;r>=0;--r)n+=`\n                k = i32(${e.indicesGet("indices",r)}) - ${ei("uniforms.pads",r,a)};\n                if (k < 0) {\n                  k = -k;\n                }\n                {\n                  let _2n_1 = 2 * (i32(${ei("uniforms.x_shape",r,t)}) - 1);\n                  k = k % _2n_1;\n                  if(k >= i32(${ei("uniforms.x_shape",r,t)})) {\n                    k = _2n_1 - k;\n                  }\n                }\n                offset += k * i32(${ei("uniforms.x_strides",r,t)});\n            `;return`\n              var offset = 0;\n              var k = 0;\n              ${n}\n              value = x[offset];\n          `},Nu=(e,t,a)=>{let n="";for(let r=t-1;r>=0;--r)n+=`\n                k = i32(${e.indicesGet("indices",r)}) - ${ei("uniforms.pads",r,a)};\n                if (k < 0) {\n                  k = 0;\n                }\n                if (k >= i32(${ei("uniforms.x_shape",r,t)})) {\n                  k = i32(${ei("uniforms.x_shape",r,t)}) - 1;\n                }\n                offset += k * i32(${ei("uniforms.x_strides",r,t)});\n            `;return`\n              var offset = 0;\n              var k = 0;\n              ${n}\n              value = x[offset];\n          `},$u=(e,t,a)=>{let n="";for(let r=t-1;r>=0;--r)n+=`\n                k = i32(${e.indicesGet("indices",r)}) - ${ei("uniforms.pads",r,a)};\n                if (k < 0)  {\n                  k += i32(${ei("uniforms.x_shape",r,t)}]);\n                }\n                if (k >= i32(${ei("uniforms.x_shape",r,t)})) {\n                  k -= i32(${ei("uniforms.x_shape",r,t)});\n                }\n                offset += k * i32(${ei("uniforms.x_strides",r,t)});\n            `;return`\n              var offset = 0;\n              var k = 0;\n              ${n}\n              value = x[offset];\n          `},Cu=(e,t,a)=>{switch(a.mode){case 0:return _u(e,t,a.pads.length);case 1:return ku(e,t,a.pads.length);case 2:return Nu(e,t,a.pads.length);case 3:return $u(e,t,a.pads.length);default:throw new Error("Invalid mode")}},Su=(e,t)=>{let a=hs.padShape(e[0].dims.slice(),t.pads),n=e[0].dims,r=[{type:12,data:hs.size(a)},{type:6,data:t.pads}],s=e.length>=3&&e[2].data;0===t.mode&&r.push({type:s?e[2].dataType:1,data:t.value}),r.push(...Xs(e[0].dims,a));return{name:"Pad",shaderCache:{hint:`${t.mode}${s}`,inputDependencies:["rank"]},getRunData:()=>({outputs:[{dims:a,dataType:e[0].dataType}],dispatchGroup:{x:Math.ceil(hs.size(a)/64)},programUniforms:r}),getShaderSource:r=>{let i=ni("output",e[0].dataType,a.length),o=ai("x",e[0].dataType,n.length),l=o.type.value,d=Cu(i,n.length,t),c=[{name:"output_size",type:"u32"},{name:"pads",type:"i32",length:t.pads.length}];return 0===t.mode&&c.push({name:"constant_value",type:s?l:"f32"}),`\n            ${r.registerUniforms(c).declareVariables(o,i)}\n            ${r.mainStart()}\n            ${r.guardAgainstOutOfBoundsWorkgroupSizes("uniforms.output_size")}\n\n            let indices = ${i.offsetToIndices("global_idx")};\n\n            var value = ${l}(0);\n            ${d}\n            output[global_idx] = value;\n        }`}}},Mu=(e,t)=>{if(e.length>1){let a=e[1].getBigInt64Array(),n=e.length>=3&&e[2].data?10===e[2].dataType?e[2].getUint16Array()[0]:e[2].getFloat32Array()[0]:0,r=e[0].dims.length,s=new Int32Array(2*r).fill(0);if(e.length>=4){let t=e[3].getBigInt64Array();for(let e=0;e<t.length;e++)s[Number(t[e])]=Number(a[e]),s[Number(t[e])+r]=Number(a[e+t.length])}else a.forEach((e,t)=>s[Number(t)]=Number(e));let i=[];return s.forEach(e=>i.push(e)),{mode:t.mode,value:n,pads:i}}return t},zu=(e,t)=>{ju(e.inputs);let a=Mu(e.inputs,t);e.compute(Su(e.inputs,a),{inputs:[0]})}}),nh=Ln(()=>{lr(),rp(),op(),hp(),Tu=e=>{if(un.webgpu.validateInputContent&&(!e||1!==e.length))throw new Error("Pool ops requires 1 input.")},Eu=(e,t,a)=>{let n="NHWC"===t.format,r=e.dims.slice();n&&r.splice(1,0,r.pop());let s=Object.hasOwnProperty.call(t,"dilations"),i=t.kernelShape.slice(),o=t.strides.slice(),l=s?t.dilations.slice():[],d=t.pads.slice();fs.adjustPoolAttributes(a,r,i,o,l,d);let c=fs.computePoolOutputShape(a,r,o,l,i,d,t.autoPad),u=Object.assign({},t);s?Object.assign(u,{kernelShape:i,strides:o,pads:d,dilations:l,cacheKey:t.cacheKey}):Object.assign(u,{kernelShape:i,strides:o,pads:d,cacheKey:t.cacheKey});let m=c.slice();return m.push(m.splice(1,1)[0]),[u,n?m:c]},Au=(e,t)=>{let a="NHWC"===t.format,n=[{type:12,data:hs.size(e)},{type:12,data:hs.size(t.kernelShape)}],r=[{name:"outputSize",type:"u32"},{name:"kernelSize",type:"u32"}];if(t.kernelShape.length<=2){let e=t.kernelShape[t.kernelShape.length-1],a=t.strides[t.strides.length-1],s=t.pads[t.pads.length/2-1],i=t.pads[t.pads.length-1],o=!!(s+i);n.push({type:12,data:e},{type:12,data:a},{type:12,data:s},{type:12,data:i}),r.push({name:"kw",type:"u32"},{name:"sw",type:"u32"},{name:"pwStart",type:"u32"},{name:"pwEnd",type:"u32"});let l=!1;if(2===t.kernelShape.length){let e=t.kernelShape[t.kernelShape.length-2],a=t.strides[t.strides.length-2],s=t.pads[t.pads.length/2-2],i=t.pads[t.pads.length-2];l=!!(s+i),n.push({type:12,data:e},{type:12,data:a},{type:12,data:s},{type:12,data:i}),r.push({name:"kh",type:"u32"},{name:"sh",type:"u32"},{name:"phStart",type:"u32"},{name:"phEnd",type:"u32"})}return[n,r,!0,o,l]}{if(a)throw new Error("Pooling with kernelShape.length > 2 is not supported for NHWC format.");let e=hs.computeStrides(t.kernelShape);return n.push({type:12,data:e},{type:12,data:t.pads},{type:12,data:t.strides}),r.push({name:"kernelStrides",type:"u32",length:e.length},{name:"pads",type:"u32",length:t.pads.length},{name:"strides",type:"u32",length:t.strides.length}),[n,r,!!t.pads.reduce((e,t)=>e+t),!1,!1]}},Iu=(e,t,a,n,r,s,i,o,l,d,c,u)=>{let m="NHWC"===r.format,p=t.type.value,h=ni("output",t.type.tensor,n);if(r.kernelShape.length<=2){let n="",d="",f="",x=a-(m?2:1);if(n=c?`\n                for (var i: u32 = 0u; i < uniforms.kw; i++) {\n                  xIndices[${x}] = indices[${x}] * uniforms.sw - uniforms.pwStart + i;\n                  if (xIndices[${x}] < 0 || xIndices[${x}]\n                      >= uniforms.x_shape[${x}]) {\n                    pad++;\n                    continue;\n                  }\n                  let x_val = x[${t.indicesToOffset("xIndices")}];\n                  ${s}\n                }`:`\n                for (var i: u32 = 0u; i < uniforms.kw; i++) {\n                  xIndices[${x}] = indices[${x}] * uniforms.sw - uniforms.pwStart + i;\n                  let x_val = x[${t.indicesToOffset("xIndices")}];\n                  ${s}\n                }`,2===r.kernelShape.length){let e=a-(m?3:2);d=u?`\n                for (var j: u32 = 0u; j < uniforms.kh; j++) {\n                  xIndices[${e}] = indices[${e}] * uniforms.sh - uniforms.phStart + j;\n                  if (xIndices[${e}] < 0 || xIndices[${e}] >= uniforms.x_shape[${e}]) {\n                    pad += i32(uniforms.kw);\n                    continue;\n                  }\n              `:`\n                for (var j: u32 = 0u; j < uniforms.kh; j++) {\n                  xIndices[${e}] = indices[${e}] * uniforms.sh - uniforms.phStart + j;\n                `,f="\n              }\n            "}return`\n            ${e.registerUniforms(l).declareVariables(t,h)}\n\n            ${e.mainStart()}\n              ${e.guardAgainstOutOfBoundsWorkgroupSizes("uniforms.outputSize")}\n\n              let indices = ${h.offsetToIndices("global_idx")};\n              var xIndices = ${h.offsetToIndices("global_idx")};\n\n              var value = ${p}(${o});\n              var pad = 0;\n              ${d}\n              ${n}\n              ${f}\n              ${i}\n\n              output[global_idx] = value;\n            }`}{if(m)throw new Error("Pooling with kernelShape.length > 2 is not supported for NHWC format.");let n=r.kernelShape.length,c=r.pads.length,u="";return u=d?`\n                if (xIndices[j] >= uniforms.x_shape[j]) {\n                  pad++;\n                  isPad = true;\n                  break;\n                }\n              }\n              if (!isPad) {\n                let x_val = x[${t.indicesToOffset("xIndices")}];\n                ${s}\n              }`:`\n              }\n              let x_val = x[${t.indicesToOffset("xIndices")}];\n              ${s}\n            `,`\n            ${e.registerUniforms(l).declareVariables(t,h)}\n\n            ${e.mainStart()}\n              ${e.guardAgainstOutOfBoundsWorkgroupSizes("uniforms.outputSize")}\n              let indices = ${h.offsetToIndices("global_idx")};\n              var xIndices = ${h.offsetToIndices("global_idx")};\n\n              var offsets: array<u32, ${n}>;\n\n              var value = ${p}(${o});\n              var pad = 0;\n              var isPad = false;\n\n              for (var i: u32 = 0u; i < uniforms.kernelSize; i++) {\n                var offset = i;\n                for (var j = 0u; j < ${n-1}u; j++) {\n                  offsets[j] = offset / ${ei("uniforms.kernelStrides","j",n)};\n                  offset -= offsets[j] * ${ei("uniforms.kernelStrides","j",n)};\n                }\n                offsets[${n-1}] = offset;\n\n                isPad = false;\n                for (var j = ${a-n}u; j < ${a}u; j++) {\n                  xIndices[j] = indices[j] * ${ei("uniforms.strides",`j - ${a-n}u`,n)}\n                    + offsets[j - ${a-n}u] - ${ei("uniforms.pads","j - 2u",c)};\n                  ${u}\n              }\n              ${i}\n\n              output[global_idx] = value;\n            }`}},Ou=e=>`${e.format};${e.ceilMode};${e.autoPad};${e.kernelShape.length}`,Ru=e=>`${Ou(e)};${e.countIncludePad}`,Vu=e=>`${Ou(e)};${e.storageOrder};${e.dilations}`,Pu=e=>({format:e.format,autoPad:["NOTSET","VALID","SAME_UPPER","SAME_LOWER"][e.auto_pad],ceilMode:e.ceil_mode,kernelShape:e.kernel_shape,strides:e.strides,pads:e.pads}),Du=(e,t,a,n)=>{let[r,s]=Eu(t,n,a),i=ai("x",t.dataType,t.dims.length),o=i.type.value,l="";r.countIncludePad?l+=`value /= ${o}(uniforms.kernelSize);`:l+=`value /= ${o}(i32(uniforms.kernelSize) - pad);`;let[d,c,u,m,p]=Au(s,r);d.push(...Xs(t.dims,s));return{name:e,shaderCache:{hint:`${n.cacheKey};${u};${m};${p}`,inputDependencies:["rank"]},getRunData:()=>({outputs:[{dims:s,dataType:t.dataType}],dispatchGroup:{x:Math.ceil(hs.size(s)/64)},programUniforms:d}),getShaderSource:e=>Iu(e,i,t.dims.length,s.length,r,"value += x_val;",l,0,c,u,m,p)}},Bu=e=>{let t=0!==e.count_include_pad,a=Pu(e);if(0!==a.ceilMode)throw new Error("using ceil() in shape computation is not yet supported for AveragePool");let n={countIncludePad:t,...a,cacheKey:""};return{...n,cacheKey:Ru(n)}},Lu=(e,t)=>{Tu(e.inputs),e.compute(Du("AveragePool",e.inputs[0],!1,t))},Fu={autoPad:"",ceilMode:0,countIncludePad:!1,kernelShape:[],strides:[],pads:[],storageOrder:0,dilations:[]},Wu=e=>{let t=e.format;return{format:t,...Fu,cacheKey:t}},Uu=(e,t)=>{Tu(e.inputs),e.compute(Du("GlobalAveragePool",e.inputs[0],!0,t))},qu=(e,t,a,n)=>{let[r,s]=Eu(t,n,a),i=ai("x",t.dataType,t.dims.length),[o,l,d,c,u]=Au(s,r);return o.push(...Xs(t.dims,s)),{name:e,shaderCache:{hint:`${n.cacheKey};${d};${c};${u}`,inputDependencies:["rank"]},getRunData:()=>({outputs:[{dims:s,dataType:t.dataType}],dispatchGroup:{x:Math.ceil(hs.size(s)/64)},programUniforms:o}),getShaderSource:e=>Iu(e,i,t.dims.length,s.length,r,"\n      value = max(x_val, value);\n    ","",10===t.dataType?-65504:-1e5,l,d,c,u)}},Hu=(e,t)=>{Tu(e.inputs),e.compute(qu("MaxPool",e.inputs[0],!1,t))},Gu=e=>{let t=e.storage_order,a=e.dilations,n=Pu(e);if(0!==t)throw new Error("column major storage order is not yet supported for MaxPool");if(0!==n.ceilMode)throw new Error("using ceil() in shape computation is not yet supported for MaxPool");let r={storageOrder:t,dilations:a,...n,cacheKey:""};return{...r,cacheKey:Vu(r)}},Ku=e=>{let t=e.format;return{format:t,...Fu,cacheKey:t}},Xu=(e,t)=>{Tu(e.inputs),e.compute(qu("GlobalMaxPool",e.inputs[0],!0,t))}}),rh=Ln(()=>{rp(),op(),pp(),hp(),Yu=(e,t)=>{if(e.length<2||e.length>3)throw new Error("DequantizeLinear requires 2 or 3 inputs.");if(3===e.length&&e[1].dims===e[2].dims)throw new Error("x-scale and x-zero-point must have the same shape.");if(3===e.length&&e[0].dataType!==e[2].dataType)throw new Error("x and x-zero-point must have the same data type.");if(6===e[0].dataType&&e.length>2)throw new Error("In the case of dequantizing int32 there is no zero point.");if(0!==e[1].dims.length&&1!==e[1].dims.length&&e[1].dims.length!==e[0].dims.length)throw new Error("scale input must be a scalar, a 1D tensor, or have the same rank as the input tensor.");if(e.length>2){if(e[0].dataType!==e[2].dataType)throw new Error("x and x-zero-point must have the same data type.");if(e[1].dims.length!==e[2].dims.length)throw new Error("scale and zero-point inputs must have the same rank.");if(!e[1].dims.map((t,a)=>t===e[2].dims[a]).reduce((e,t)=>e&&t,!0))throw new Error("scale and zero-point inputs must have the same shape.")}if(t.blockSize>0){if(0===e[1].dims.length||1===e[1].dims.length&&1===e[1].dims[0])throw new Error("blockSize must be set only for block quantization.");if(!e[1].dims.map((a,n)=>n===t.axis||a===e[0].dims[n]).reduce((e,t)=>e&&t,!0))throw new Error("For block qunatization, scale input shape to match the input shape except for the axis");if(e[1].dims.length!==e[0].dims.length)throw new Error("For block qunatization the scale input rank must be the same as the x rank.");let a=e[0].dims[t.axis],n=e[1].dims[t.axis];if(t.blockSize<Math.ceil(a/n)||t.blockSize>Math.ceil(a/(n-1)-1))throw new Error("blockSize must be with in the range [ceil(dI / Si), ceil(dI / (Si - 1) - 1)].")}},Zu=(e,t)=>{let a=hs.normalizeAxis(t.axis,e[0].dims.length),n=e[0].dataType,r=3===n,s=e[0].dims,i=e[1].dataType,o=hs.size(s),l=3===n||2===n,d=l?[Math.ceil(hs.size(e[0].dims)/4)]:e[0].dims,c=e[1].dims,u=e.length>2?e[2]:void 0,m=u?l?[Math.ceil(hs.size(u.dims)/4)]:u.dims:void 0,p=0===c.length||1===c.length&&1===c[0],h=!1===p&&1===c.length,f=Ys(o),x=p&&(!l||4===f),g=x?f:1,b=x&&!l?f:1,y=ai("input",l?12:n,d.length,b),v=ai("scale",i,c.length),w=u?ai("zero_point",l?12:n,m.length):void 0,j=ni("output",i,s.length,g),_=[y,v];w&&_.push(w);let k=[d,c];u&&k.push(m);let N=[{type:12,data:o/g},{type:12,data:a},{type:12,data:t.blockSize},...Xs(...k,s)];return{name:"DequantizeLinear",shaderCache:{hint:t.cacheKey,inputDependencies:w?["rank","rank","rank"]:["rank","rank"]},getShaderSource:e=>`\n      ${e.registerUniforms([{name:"output_size",type:"u32"},{name:"axis",type:"u32"},{name:"block_size",type:"u32"}]).declareVariables(..._,j)}\n      ${e.mainStart()}\n          ${e.guardAgainstOutOfBoundsWorkgroupSizes("uniforms.output_size")}\n          let output_indices = ${j.offsetToIndices("global_idx")};\n\n          // Set input x\n          ${l?`\n            let input = ${y.getByOffset("global_idx / 4")};\n            let x_vec = ${r?"unpack4xI8(input)":"unpack4xU8(input)"};\n            let x_value = ${1===g?"x_vec[global_idx % 4]":"x_vec"};`:`let x_value = ${y.getByOffset("global_idx")};`};\n\n          // Set scale input\n          ${p?`let scale_value= ${v.getByOffset("0")}`:h?`\n            let scale_index = ${j.indicesGet("output_indices","uniforms.axis")};\n            let scale_value= ${v.getByOffset("scale_index")};`:`\n            var scale_indices: ${v.type.indices} = output_indices;\n            let index = ${v.indicesGet("scale_indices","uniforms.axis")} / uniforms.block_size;\n            ${v.indicesSet("scale_indices","uniforms.axis","index")};\n            let scale_value= ${v.getByIndices("scale_indices")};`};\n\n          // Set zero-point input\n          ${w?p?l?`\n                let zero_point_input = ${w.getByOffset("0")};\n                let zero_point_vec =  ${r?"unpack4xI8(zero_point_input)":"unpack4xU8(zero_point_input)"};\n                let zero_point_value= zero_point_vec[0]`:`let zero_point_value = ${w.getByOffset("0")}`:h?l?`\n                let zero_point_index = ${j.indicesGet("output_indices","uniforms.axis")};\n                let zero_point_input = ${w.getByOffset("zero_point_index / 4")};\n                let zero_point_vec =  ${r?"unpack4xI8(zero_point_input)":"unpack4xU8(zero_point_input)"};\n                let zero_point_value = zero_point_vec[zero_point_index % 4]`:`\n                let zero_point_index = ${j.indicesGet("output_indices","uniforms.axis")};\n                let zero_point_value = ${w.getByOffset("zero_point_index")};`:l?`\n                let zero_point_offset = ${v.indicesToOffset("scale_indices")};\n                let zero_point_input = ${w.getByOffset("zero_point_offset / 4")};\n                let zero_point_vec = ${r?"unpack4xI8(zero_point_input)":"unpack4xU8(zero_point_input)"};\n                let zero_point_value = zero_point_vec[zero_point_offset % 4];`:`let zero_point_value = ${w.getByIndices("scale_indices")};`:`let zero_point_value = ${l?r?"i32":"u32":y.type.value}(0);`};\n      // Compute and write output\n      ${j.setByOffset("global_idx",`${j.type.value}(x_value - zero_point_value) * scale_value`)};\n      }`,getRunData:()=>({outputs:[{dims:s,dataType:i}],dispatchGroup:{x:Math.ceil(o/g/64),y:1,z:1},programUniforms:N})}},Qu=(e,t)=>{Yu(e.inputs,t),e.compute(Zu(e.inputs,t))},Ju=e=>Us({axis:e.axis,blockSize:e.blockSize})}),sh=Ln(()=>{lr(),rp(),hp(),em=(e,t,a)=>{if(e===t||e<t&&a<0||e>t&&a>0)throw new Error("Range these inputs' contents are invalid.")},tm=(e,t,a,n)=>{let r=Math.abs(Math.ceil((t-e)/a)),s=[r],i=r,o=[{type:12,data:i},{type:n,data:e},{type:n,data:a},...Xs(s)];return{name:"Range",shaderCache:{hint:`${n}`},getShaderSource:e=>{let t=ni("output",n,s.length),a=t.type.value,r=[{name:"outputSize",type:"u32"},{name:"start",type:a},{name:"delta",type:a}];return`\n        ${e.registerUniforms(r).declareVariables(t)}\n        ${e.mainStart()}\n        ${e.guardAgainstOutOfBoundsWorkgroupSizes("uniforms.outputSize")}\n        output[global_idx] = uniforms.start + ${a}(global_idx) * uniforms.delta;\n      }`},getRunData:()=>({outputs:[{dims:s,dataType:n}],dispatchGroup:{x:Math.ceil(i/64)},programUniforms:o})}},am=e=>{let t=0,a=0,n=0;6===e.inputs[0].dataType?(t=e.inputs[0].getInt32Array()[0],a=e.inputs[1].getInt32Array()[0],n=e.inputs[2].getInt32Array()[0]):1===e.inputs[0].dataType&&(t=e.inputs[0].getFloat32Array()[0],a=e.inputs[1].getFloat32Array()[0],n=e.inputs[2].getFloat32Array()[0]),un.webgpu.validateInputContent&&em(t,a,n),e.compute(tm(t,a,n,e.inputs[0].dataType),{inputs:[]})}}),ih=Ln(()=>{rp(),op(),pp(),hp(),nm=(e,t,a,n)=>{if("none"!==e&&"i32"!==n&&"u32"!==n&&"f32"!==n)throw new Error(`Input ${n} is not supported with reduction ${e}.`);let r="{\n                var oldValue = 0;\n                loop {\n                  let newValueF32 =",s=`;\n                  let newValue = bitcast<i32>(newValueF32);\n                  let res = atomicCompareExchangeWeak(&${t}, oldValue, newValue);\n                  if res.exchanged {\n                    break;\n                  }\n                  oldValue = res.old_value;\n                }\n              }`;switch(e){case"none":return`${t}=${a};`;case"add":return"i32"===n||"u32"===n?`atomicAdd(&${t}, bitcast<${n}>(${a}));`:`\n              ${r}bitcast<${n}>(oldValue) + (${a})${s}`;case"max":return"i32"===n||"u32"===n?`atomicMax(&${t}, bitcast<${n}>(${a}));`:`\n                ${r}max(bitcast<f32>(oldValue), (${a}))${s}`;case"min":return"i32"===n||"u32"===n?`atomicMin(&${t}, bitcast<${n}>(${a}));`:`${r}min(bitcast<${n}>(oldValue), (${a}))${s}`;case"mul":return`${r}(bitcast<${n}>(oldValue) * (${a}))${s}`;default:throw new Error(`Reduction ${e} is not supported.`)}},rm=(e,t)=>{let a=e[0].dims,n=e[1].dims,r=a,s=Math.ceil(hs.sizeToDimension(n,n.length-1)/1),i=n[n.length-1],o=hs.sizeFromDimension(a,i),l=[{type:12,data:s},{type:12,data:i},{type:12,data:o},...Xs(e[1].dims,e[2].dims,r)];return{name:"ScatterND",shaderCache:{hint:`${t.cacheKey}_${t.reduction}`,inputDependencies:["rank","rank"]},getRunData:()=>({outputs:[{dims:r,dataType:e[0].dataType}],dispatchGroup:{x:Math.ceil(s/64)},programUniforms:l}),getShaderSource:a=>{let n=ai("indices",e[1].dataType,e[1].dims.length),s=ai("updates",e[2].dataType,e[2].dims.length,1),i="none"!==t.reduction&&""!==t.reduction?ri("output",e[0].dataType,r.length):ni("output",e[0].dataType,r.length,1);return`\n      ${a.registerUniform("output_size","u32").registerUniform("last_index_dimension","u32").registerUniform("num_updates_elements","u32").declareVariables(n,s,i)}\n      ${a.mainStart()}\n        ${a.guardAgainstOutOfBoundsWorkgroupSizes("uniforms.output_size")}\n  var data_offset = 0u;\n  let indices_start = uniforms.last_index_dimension * global_idx;\n  let indices_end = indices_start + uniforms.last_index_dimension;\n  for (var i = indices_start; i < indices_end; i++) {\n    var index = i32(indices[i].x);\n    ${1===e[0].dims.length?"\n    let element_count_dim = uniforms.output_strides;\n    let dim_value = uniforms.output_shape;":"\n    let element_count_dim = uniforms.output_strides[i - indices_start];\n    let dim_value = uniforms.output_shape[i - indices_start];"}\n    if (index >= 0) {\n      if (index >= i32(dim_value)) {\n        index = i32(dim_value - 1);\n      }\n    } else {\n      if (index < -i32(dim_value)) {\n        index = 0;\n      } else {\n        index += i32(dim_value);\n      }\n    }\n    data_offset += u32((u32(index) * element_count_dim));\n  }\n\n  for (var i = 0u; i < uniforms.num_updates_elements; i++) {\n    let value = updates[uniforms.num_updates_elements * global_idx + i];\n    ${nm(t.reduction,"output[data_offset + i]","value",i.type.value)}\n  }\n\n      }`}}},sm=e=>Us({reduction:e.reduction}),im=(e,t)=>{e.compute(rm(e.inputs,t),{inputs:[e.inputs[1],e.inputs[2]],outputs:[]})}}),oh=Ln(()=>{rp(),op(),pp(),hp(),om=(e,t)=>{if(e.every(e=>e>0||(()=>{throw new Error("Resize requires scales input values to be positive")})),e.length>0)if("linear"===t.mode){if(!(2===e.length||3===e.length||4===e.length&&1===e[0]&&1===e[1]||4===e.length&&1===e[0]&&1===e[3]||5===e.length&&1===e[0]&&1===e[1]))throw new Error("For linear mode, Resize requires scales to be 2D, 3D, 4D with either two outermost or one innermost and\n            one outermost scale values equal to 1, or 5D with two outermost scale values equal to 1")}else if("cubic"===t.mode&&!(2===e.length||4===e.length&&1===e[0]&&1===e[1]||4===e.length&&1===e[0]&&1===e[3]))throw new Error("Resize requires scales input size to be 2 or 4 for cubic mode")},lm=(e,t,a)=>{t.every(e=>e>=0&&e<a||(()=>{throw new Error("Resize requires axes input values to be positive and less than rank")}));let n=new Array(a).fill(1);return t.forEach((t,a)=>n[t]=e[a]),n},dm=(e,t,a,n,r,s)=>{let[i,o,l]=a>10?[1,2,3]:[-1,e.length>1?1:-1,-1],d=e[0].dims.length;if(i>0&&e.length>i&&e[i].dims.length>0)e[i].getFloat32Array().forEach(e=>s.push(e));else if("tf_crop_and_resize"===t.coordinateTransformMode)throw new Error("Resize requires RoI input to be specified when coordinateTransformMode is tfCropAndResize");if(o>0&&e.length>o&&1===e[o].dims.length&&e[o].dims[0]>0){if(e[o].getFloat32Array().forEach(e=>n.push(e)),0!==n.length&&n.length!==d&&a>=18&&n.length!==t.axes.length)throw new Error("Resize requires scales input size to be same as input rank or axes size for opset 18 and up");om(n,t),t.axes.length>0&&lm(n,t.axes,d).forEach((e,t)=>n[t]=e)}if(l>0&&e.length>l&&1===e[l].dims.length&&e[l].dims[0]>0&&(e[l].getBigInt64Array().forEach(e=>r.push(Number(e))),0!==r.length&&r.length!==d&&a>=18&&r.length!==t.axes.length))throw new Error("Resize requires sizes input size to be same as input rank or axes size for opset 18 and up");if(t.axes.length>0){if(0!==n.length&&n.length!==t.axes.length)throw new Error('Resize requires "scales" input size to be of axes rank when axes attributes is specified');if(0!==r.length&&r.length!==t.axes.length)throw new Error('Resize requires "sizes" input size to be of rank axes rank when axes attributes is specified')}if(typeof n<"u"&&typeof r<"u"&&n.length>0&&r.length>d)throw new Error("Resize requires only of scales or sizes to be specified")},cm=(e,t,a,n)=>`\n  // The whole part and the fractional part are calculated separately due to inaccuracy of floating\n  // point division. As an example, f32(21) / f32(7) may evaluate to 2.99... instead of 3, causing an\n  // offset-by-one error later in floor().\n  let big = (${e}) * (${t});\n  let whole = ${n}(big / (${a}));\n  let fract = ${n}(big % (${a})) / ${n}(${a});\n  return whole + fract;\n`,um=(e,t)=>`fn getOriginalCoordinateFromResizedCoordinate(xResized: u32, xScale: f32, lengthResized: u32,\n     lengthOriginal: u32, roiStart: f32, roiEnd: f32) -> ${t} { `+(()=>{switch(e){case"asymmetric":return`\n          if (xScale < 1.0 || floor(xScale) != xScale) {\n            return ${t}(xResized) / ${t}(xScale);\n          } else {\n            ${cm("xResized","lengthOriginal","lengthResized",t)}\n          }\n        `;case"pytorch_half_pixel":return`if (lengthResized > 1) {\n                    return (${t}(xResized) + 0.5) / ${t}(xScale) - 0.5;\n                  } else {\n                    return 0.0;\n                  }`;case"tf_half_pixel_for_nn":return`return (${t}(xResized) + 0.5) / ${t}(xScale);`;case"align_corners":return`if (lengthResized == 1) {\n                    return 0.0;\n                  } else {\n                    ${cm("xResized","lengthOriginal - 1","lengthResized - 1",t)}\n                  }`;case"tf_crop_and_resize":return`if (lengthResized > 1) {\n                    return ${t}(roiStart) * ${t}(lengthOriginal - 1) +\n                        (${t}(xResized) * ${t}(roiEnd - roiStart) * ${t}(lengthOriginal - 1)) /\n                        ${t}(lengthResized - 1);\n                  } else {\n                    return 0.5 * ${t}(roiStart + roiEnd) * ${t}(lengthOriginal - 1);\n                  }`;case"half_pixel_symmetric":return`const outputWidth = ${t}xScale * ${t}(lengthResized);\n                  const adjustment = ${t}(lengthResized) / outputWidth;\n                  const center = ${t}(lengthOriginal) / 2;\n                  const offset = center * (1 - adjustment);\n                  return offset + ((${t}(xResized) + 0.5) / ${t}(xScale)) - 0.5;`;case"half_pixel":return`return ((${t}(xResized) + 0.5) / ${t}(xScale)) - 0.5;`;default:throw new Error(`Coordinate transform mode ${e} is not supported`)}})()+"}",mm=(e,t,a)=>`fn getNearestPixelFromOriginal(xOriginal: ${a}, isDownSample: bool) -> ${a} {`+(()=>{switch(e){case"round_prefer_ceil":return"if (fract(xOriginal) == 0.5) {             return ceil(xOriginal);           } else {             return round(xOriginal);           }";case"floor":return"return floor(xOriginal);";case"ceil":return"return ceil(xOriginal);";case"round_prefer_floor":return"if (fract(xOriginal) == 0.5) {                     return floor(xOriginal);                   } else {                     return round(xOriginal);                   }";default:if(t<11)return"if (isDownSample)                     {                       return ceil(xOriginal);                     } else {                       return xOriginal;                     }";throw new Error(`Nearest mode ${e} is not supported`)}})()+"}",pm=(e,t,a)=>{let n=new Array(a).fill(0).concat(new Array(a).fill(1)),r=0===e.length?n:e.slice();return t.length>0?(t.forEach((e,s)=>{n[e]=r[s],n[s+a]=r[t.length+s]}),n):r},hm=(e,t,a,n)=>{let r=[];if(a.length>0)if(n.length>0){if(e.forEach(e=>r.push(e)),Math.max(...n)>e.length)throw new Error("axes is out of bound");n.forEach((e,t)=>r[e]=a[t])}else a.forEach(e=>r.push(e));else{if(0===t.length)throw new Error("Resize requires either scales or sizes.");r=e.map((e,a)=>Math.round(e*t[a]))}return r},fm=(e,t,a)=>{let n=(()=>{switch(a.keepAspectRatioPolicy){case"not_larger":return a.axes.length>0?Math.min(...a.axes.map(e=>t[e]),Number.MAX_VALUE):Math.min(...t,Number.MAX_VALUE);case"not_smaller":return a.axes.length>0?Math.max(...a.axes.map(e=>t[e]),Number.MIN_VALUE):Math.max(...t,Number.MIN_VALUE);default:throw new Error(`Keep aspect ratio policy ${a.keepAspectRatioPolicy} is not supported`)}})();t.fill(1,0,t.length);let r=e.slice();return a.axes.length>0?(a.axes.forEach(e=>t[e]=n),a.axes.forEach(a=>r[a]=Math.round(e[a]*t[a]))):(t.fill(n,0,t.length),r.forEach((e,a)=>r[a]=Math.round(e*t[a]))),r},xm=(e,t,a,n,r)=>`\n    fn calculateOriginalIndicesFromOutputIndices(output_indices: ${e.type.indices}) -> array<${e.type.value}, ${a.length}> {\n      var original_indices: array<${e.type.value}, ${a.length}>;\n      for (var i:u32 = 0; i < ${a.length}; i++) {\n        var output_index = ${e.indicesGet("output_indices","i")};\n        var scale = ${ei("uniforms.scales","i",n)};\n        var roi_low = ${ei("uniforms.roi","i",r)};\n        var roi_hi = ${ei("uniforms.roi",`i + ${t.length}`,r)};\n        if (scale == 1.0) {\n          original_indices[i] = ${e.type.value}(output_index);\n        } else {\n          var input_shape_i = ${ei("uniforms.input_shape","i",t.length)};\n          var output_shape_i = ${ei("uniforms.output_shape","i",a.length)};\n          original_indices[i] = getOriginalCoordinateFromResizedCoordinate(output_index, scale, output_shape_i,\n                                                                           input_shape_i, roi_low, roi_hi);\n        }\n      }\n      return original_indices;\n    }`,gm=(e,t,a,n,r,s,i)=>`\n    fn calculateInputIndicesFromOutputIndices(output_indices: ${t.type.indices}) -> ${e.type.indices} {\n      var input_indices: ${e.type.indices};\n      for (var i:u32 = 0; i < ${n.length}; i++) {\n        var output_index = ${t.indicesGet("output_indices","i")};\n        var input_index: u32;\n        var scale = ${ei("uniforms.scales","i",r)};\n        if (scale == 1.0) {\n          input_index = output_index;\n        } else {\n          var roi_low = ${ei("uniforms.roi","i",s)};\n          var roi_hi = ${ei("uniforms.roi",`i + ${a.length}`,s)};\n          var input_shape_i = ${ei("uniforms.input_shape","i",a.length)};\n          var output_shape_i = ${ei("uniforms.output_shape","i",n.length)};\n          var original_idx = getOriginalCoordinateFromResizedCoordinate(output_index, scale, output_shape_i,\n                                                                        input_shape_i, roi_low, roi_hi);\n          if (!${i} || (original_idx >= 0 && original_idx < ${t.type.value}(input_shape_i))) {\n            if (original_idx < 0) {\n              input_index = 0;\n            } else if (original_idx > ${t.type.value}(input_shape_i - 1)) {\n              input_index = input_shape_i - 1;\n            } else {\n              input_index = u32(getNearestPixelFromOriginal(original_idx, scale < 1));\n            }\n          } else {\n            input_index = u32(original_idx);\n          }\n        }\n        ${e.indicesSet("input_indices","i","input_index")}\n      }\n      return input_indices;\n    }`,bm=(e,t)=>`\n    fn checkInputIndices(input_indices: ${e.type.indices}) -> bool {\n      for (var i:u32 = 0; i < ${t.length}; i++) {\n        var input_index = ${e.indicesGet("input_indices","i")};\n        if (input_index < 0 || input_index >= ${ei("uniforms.input_shape","i",t.length)}) {\n          return false;\n        }\n      }\n      return true;\n    }`,ym=(e,t,a,n)=>e.rank>n?`\n    ${e.indicesSet("input_indices",t,"channel")};\n    ${e.indicesSet("input_indices",a,"batch")};\n`:"",vm=(e,t,a,n,r)=>{let[s,i,o,l]=2===a.length?[-1,0,1,-1]:[0,2,3,1],d=e.type.value;return`\n    fn getInputValue(batch: u32, channel: u32, row: u32, col: u32) -> ${d} {\n      var input_indices: ${e.type.indices};\n      ${e.indicesSet("input_indices",i,`max(0, min(row, ${a[i]} - 1))`)};\n      ${e.indicesSet("input_indices",o,`max(0, min(col, ${a[o]} - 1))`)};\n      ${ym(e,l,s,2)}\n      return ${e.getByIndices("input_indices")};\n    }\n\n    fn bilinearInterpolation(output_indices: ${t.type.indices}) -> ${d} {\n      var originalIndices = calculateOriginalIndicesFromOutputIndices(output_indices);\n      var row:${d} = originalIndices[${i}];\n      var col:${d} = originalIndices[${o}];\n      ${n?`if (row < 0 || row > (${a[i]} - 1) || col < 0 || col > (${a[o]} - 1)) {\n        return ${r};\n      }`:""};\n      row = max(0, min(row, ${a[i]} - 1));\n      col = max(0, min(col, ${a[o]} - 1));\n      var row1: u32 = u32(row);\n      var col1: u32 = u32(col);\n      var row2: u32 = u32(row + 1);\n      var col2: u32 = u32(col + 1);\n      var channel: u32 = ${a.length>2?`u32(originalIndices[${l}])`:"0"};\n      var batch: u32 =  ${a.length>2?`u32(originalIndices[${s}])`:"0"};\n      var x11: ${d} = getInputValue(batch, channel, row1, col1);\n      var x12: ${d} = getInputValue(batch, channel, row1, col2);\n      var x21: ${d} = getInputValue(batch, channel, row2, col1);\n      var x22: ${d} = getInputValue(batch, channel, row2, col2);\n      var dx1: ${d} = abs(row - ${d}(row1));\n      var dx2: ${d} = abs(${d}(row2) - row);\n      var dy1: ${d} = abs(col - ${d}(col1));\n      var dy2: ${d} = abs(${d}(col2) - col);\n      if (row1 == row2) {\n        dx1 = 0.5;\n        dx2 = 0.5;\n      }\n      if (col1 == col2) {\n        dy1 = 0.5;\n        dy2 = 0.5;\n      }\n      return (x11 * dx2 * dy2 + x12 * dx2 * dy1 + x21 * dx1 * dy2 + x22 * dx1 * dy1);\n    }`},wm=(e,t,a,n,r,s,i,o,l,d)=>{let c=2===a.length,[u,m]=c?[0,1]:[2,3],p=e.type.value,h=i=>{let c=i===u?"row":"col";return`\n      fn ${c}CubicInterpolation(input_indices: ${e.type.indices}, output_indices: ${t.type.indices}) -> ${p} {\n        var output_index = ${t.indicesGet("output_indices",i)};\n        var originalIdx: ${p} = getOriginalCoordinateFromResizedCoordinate(output_index, ${r[i]},\n        ${n[i]}, ${a[i]}, ${s[i]}, ${s[i]} + ${a.length});\n        var fractOriginalIdx: ${p} = originalIdx - floor(originalIdx);\n        var coefs = getCubicInterpolationCoefs(fractOriginalIdx);\n\n        if (${o} && (originalIdx < 0 || originalIdx > (${a[i]} - 1))) {\n          return ${l};\n        }\n        var data: array<${p}, 4> = array<${p}, 4>(0.0, 0.0, 0.0, 0.0);\n        for (var i: i32 = -1; i < 3; i++) {\n          var ${c}: ${p} = originalIdx + ${p}(i);\n          if (${c} < 0 || ${c} >= ${a[i]}) {\n            ${d?"coefs[i + 1] = 0.0;\n                        continue;":o?`return ${l};`:`${c} = max(0, min(${c}, ${a[i]} - 1));`};\n          }\n        var input_indices_copy: ${e.type.indices} = input_indices;\n          ${e.indicesSet("input_indices_copy",i,`u32(${c})`)};\n          data[i + 1] = ${i===u?e.getByIndices("input_indices_copy"):"rowCubicInterpolation(input_indices_copy, output_indices)"};\n        }\n        return cubicInterpolation1D(data, coefs);\n      }`};return`\n    ${h(u)};\n    ${h(m)};\n  fn getCubicInterpolationCoefs(s: ${p}) -> array<${p}, 4> {\n    var absS = abs(s);\n    var coeffs: array<${p}, 4> = array<${p}, 4>(0.0, 0.0, 0.0, 0.0);\n    var oneMinusAbsS: ${p} = 1.0 - absS;\n    var twoMinusAbsS: ${p} = 2.0 - absS;\n    var onePlusAbsS: ${p} = 1.0 + absS;\n    coeffs[0] = ((${i} * onePlusAbsS - 5 * ${i}) * onePlusAbsS + 8 * ${i}) * onePlusAbsS - 4 * ${i};\n    coeffs[1] = ((${i} + 2) * absS - (${i} + 3)) * absS * absS + 1;\n    coeffs[2] = ((${i} + 2) * oneMinusAbsS - (${i} + 3)) * oneMinusAbsS * oneMinusAbsS + 1;\n    coeffs[3] = ((${i} * twoMinusAbsS - 5 * ${i}) * twoMinusAbsS + 8 * ${i}) * twoMinusAbsS - 4 * ${i};\n    return coeffs;\n  }\n\n  fn cubicInterpolation1D(x: array<${p}, 4>, coefs: array<${p}, 4>) -> ${p} {\n    var coefsSum: ${p} = coefs[0] + coefs[1] + coefs[2] + coefs[3];\n    return (x[0] * coefs[0] + x[1] * coefs[1]+ x[2] * coefs[2]+ x[3] * coefs[3]) / coefsSum;\n  }\n\n  fn bicubicInterpolation(output_indices: ${t.type.indices}) -> ${p} {\n    var input_indices: ${e.type.indices} = output_indices;\n    return colCubicInterpolation(input_indices, output_indices);\n  }\n    `},jm=(e,t,a,n,r)=>{let[s,i,o,l,d]=3===a.length?[-1,0,1,2,-1]:[0,2,3,4,1],c=e.type.value;return`\n    fn getInputValue(batch: u32, channel: u32, depth:u32, height: u32, width: u32) -> ${c} {\n      var input_indices: ${e.type.indices};\n      ${e.indicesSet("input_indices",i,`max(0, min(depth, ${a[i]} - 1))`)};\n      ${e.indicesSet("input_indices",o,`max(0, min(height, ${a[o]} - 1))`)};\n      ${e.indicesSet("input_indices",l,`max(0, min(width, ${a[l]} - 1))`)};\n      ${ym(e,d,s,3)}\n      return ${e.getByIndices("input_indices")};\n    }\n\n    fn trilinearInterpolation(output_indices: ${t.type.indices}) -> ${c} {\n      var originalIndices = calculateOriginalIndicesFromOutputIndices(output_indices);\n      var depth:${c} = originalIndices[${i}];\n      var height:${c} = originalIndices[${o}];\n      var width:${c} = originalIndices[${l}];\n      ${n?`if (depth < 0 || depth > (${a[i]} - 1) || height < 0 || height > (${a[o]} - 1) || width < 0 || (width > ${a[l]} - 1)) {\n      return ${r};\n        }`:""};\n\n    depth = max(0, min(depth, ${a[i]} - 1));\n      height = max(0, min(height, ${a[o]} - 1));\n      width = max(0, min(width, ${a[l]} - 1));\n      var depth1: u32 = u32(depth);\n      var height1: u32 = u32(height);\n      var width1: u32 = u32(width);\n      var depth2: u32 = u32(depth + 1);\n      var height2: u32 = u32(height + 1);\n      var width2: u32 = u32(width + 1);\n      var channel: u32 = ${a.length>3?`u32(originalIndices[${d}])`:"0"};\n      var batch: u32 =  ${a.length>3?`u32(originalIndices[${s}])`:"0"};\n\n      var x111: ${c} = getInputValue(batch, channel, depth1, height1, width1);\n      var x112: ${c} = getInputValue(batch, channel, depth1, height1, width2);\n      var x121: ${c} = getInputValue(batch, channel, depth1, height2, width1);\n      var x122: ${c} = getInputValue(batch, channel, depth1, height2, width2);\n      var x211: ${c} = getInputValue(batch, channel, depth2, height1, width1);\n      var x212: ${c} = getInputValue(batch, channel, depth2, height1, width2);\n      var x221: ${c} = getInputValue(batch, channel, depth2, height2, width1);\n      var x222: ${c} = getInputValue(batch, channel, depth2, height2, width2);\n      var dx1: ${c} = abs(depth - ${c}(depth1));\n      var dx2: ${c} = abs(${c}(depth2) - depth);\n      var dy1: ${c} = abs(height - ${c}(height1));\n      var dy2: ${c} = abs(${c}(height2) - height);\n      var dz1: ${c} = abs(width - ${c}(width1));\n      var dz2: ${c} = abs(${c}(width2) - width);\n      if (depth1 == depth2) {\n        dx1 = 0.5;\n        dx2 = 0.5;\n      }\n      if (height1 == height2) {\n        dy1 = 0.5;\n        dy2 = 0.5;\n      }\n      if (width1 == width2) {\n        dz1 = 0.5;\n        dz2 = 0.5;\n      }\n      return (x111 * dx2 * dy2 * dz2 + x112 * dx2 * dy2 * dz1 + x121 * dx2 * dy1 *dz2 + x122 * dx2 * dy1 * dz1 +\n              x211 * dx1 * dy2 * dz2 + x212 * dx1 * dy2 * dz1 + x221 * dx1 * dy1 *dz2 + x222 * dx1 * dy1 * dz1);\n    }`},_m=(e,t,a,n,r,s)=>{let i=e.dims,o=pm(s,t.axes,i.length),l=hm(i,n,r,t.axes),d=n.slice();0===n.length&&(d=i.map((e,t)=>0===e?1:l[t]/e),"stretch"!==t.keepAspectRatioPolicy&&(l=fm(i,d,t)));let c=ni("output",e.dataType,l.length),u=ai("input",e.dataType,i.length),m=hs.size(l),p=i.length===l.length&&i.every((e,t)=>e===l[t]),h="tf_crop_and_resize"===t.coordinateTransformMode,f=t.extrapolationValue,x=u.type.value;return{name:"Resize",shaderCache:{hint:`${t.cacheKey}|${a}|${d.length>0?"cubic"===t.mode?d:d.length:""}|${r.length>0?r:""}|${o.length>0?o:""}|${p}|${"nearest"===t.mode?i.length:i}`,inputDependencies:["rank"]},getShaderSource:e=>`\n      ${p?"":`\n      ${um(t.coordinateTransformMode,x)};\n      ${(()=>{switch(t.mode){case"nearest":return`\n              ${bm(u,i)};\n              ${mm(t.nearestMode,a,x)};\n              ${gm(u,c,i,l,d.length,o.length,h)};\n              `;case"linear":return`\n              ${xm(c,i,l,d.length,o.length)};\n              ${(()=>{if(2===i.length||4===i.length)return`${vm(u,c,i,h,f)}`;if(3===i.length||5===i.length)return`${jm(u,c,i,h,f)}`;throw Error("Linear mode only supports input dims 2, 3, 4 and 5 are supported in linear mode.")})()};\n            `;case"cubic":return`\n            ${(()=>{if(2===i.length||4===i.length)return`${wm(u,c,i,l,d,o,t.cubicCoeffA,h,t.extrapolationValue,t.excludeOutside)}`;throw Error("Cubic mode only supports input dims 2 and 4 are supported in linear mode.")})()};\n            `;default:throw Error("Invalid resize mode")}})()};\n      `}\n      ${e.registerUniform("output_size","u32").registerUniform("scales","f32",d.length).registerUniform("roi","f32",o.length).declareVariables(u,c)}\n      ${e.mainStart()}\n        ${e.guardAgainstOutOfBoundsWorkgroupSizes("uniforms.output_size")}\n        ${p?"output[global_idx] = input[global_idx];":`\n        let output_indices = ${c.offsetToIndices("global_idx")};\n        var input_indices: ${u.type.indices};\n        ${(()=>{switch(t.mode){case"nearest":return`input_indices = calculateInputIndicesFromOutputIndices(output_indices);\n                if (checkInputIndices(input_indices)) {\n                  output[global_idx] = ${u.getByIndices("input_indices")};\n                } else {\n                  output[global_idx] = ${t.extrapolationValue};\n                }`;case"linear":return`output[global_idx] = ${2===i.length||4===i.length?"bilinearInterpolation":"trilinearInterpolation"}(output_indices);`;case"cubic":return"output[global_idx] = bicubicInterpolation(output_indices);";default:throw Error(`Unsupported resize mode: ${t.mode}`)}})()};\n`}\n      }`,getRunData:()=>({outputs:[{dims:l,dataType:e.dataType}],dispatchGroup:{x:Math.ceil(m/64)},programUniforms:[{type:12,data:m},{type:1,data:d},{type:1,data:o},...Xs(i,l)]})}},km=e=>{let t=e.customDataBuffer;return new Uint32Array(t,t.byteOffset,1)[0]},Nm=(e,t)=>{let a=[],n=[],r=[],s=km(e);if(0!==t.antialias)throw Error("Only default value (0) for Antialias attribute is supported");dm(e.inputs,t,s,a,n,r),e.compute(_m(e.inputs[0],t,s,a,n,r),{inputs:[0]})},$m=e=>{let t=e.antialias,a=e.axes,n=e.coordinateTransformMode,r=e.cubicCoeffA,s=0!==e.excludeOutside,i=e.extrapolationValue,o=e.keepAspectRatioPolicy,l=e.mode,d=""===e.nearestMode?"simple":e.nearestMode;return Us({antialias:t,axes:a,coordinateTransformMode:n,cubicCoeffA:r,excludeOutside:s,extrapolationValue:i,keepAspectRatioPolicy:o,mode:l,nearestMode:d})}}),lh=Ln(()=>{rp(),op(),hp(),Cm=e=>{if(!e||e.length<3)throw new Error("layerNorm requires at least 3 inputs.");let t=e[0],a=e[1],n=e[2];if(t.dataType!==a.dataType||t.dataType!==n.dataType)throw new Error("All inputs must have the same data type");if(3!==t.dims.length&&2!==t.dims.length)throw new Error("Input must be 2D or 3D");if(3!==a.dims.length&&2!==a.dims.length)throw new Error("Skip must be 2D or 3D");let r=t.dims[t.dims.length-1],s=t.dims[t.dims.length-2];if(a.dims[a.dims.length-1]!==r)throw new Error("Skip must have the same hidden size as input");if(a.dims[a.dims.length-2]!==s)throw new Error("Skip must have the same sequence length as input");if(1!==n.dims.length)throw new Error("Gamma must be 1D");if(n.dims[n.dims.length-1]!==r)throw new Error("Gamma must have the same hidden size as input");if(e.length>3){let t=e[3];if(1!==t.dims.length)throw new Error("Beta must be 1D");if(t.dims[t.dims.length-1]!==r)throw new Error("Beta must have the same hidden size as input")}if(e.length>4){let t=e[4];if(1!==t.dims.length)throw new Error("Bias must be 1D");if(t.dims[t.dims.length-1]!==r)throw new Error("Bias must have the same hidden size as input")}},Sm=(e,t,a,n)=>{let r=t.simplified,s=e[0].dims,i=hs.size(s),o=s,l=i,d=s.slice(-1)[0],c=n?s.slice(0,-1).concat(1):[],u=!r&&e.length>3,m=e.length>4,p=n&&a>1,h=n&&a>2,f=a>3,x=64,g=Ys(d),b=[{type:12,data:l},{type:12,data:g},{type:12,data:d},{type:1,data:t.epsilon}],y=[{dims:o,dataType:e[0].dataType}];return a>1&&y.push({dims:c,dataType:1}),a>2&&y.push({dims:c,dataType:1}),a>3&&y.push({dims:s,dataType:e[0].dataType}),{name:"SkipLayerNormalization",shaderCache:{hint:`${g};${p};${h};${f}`,inputDependencies:e.map((e,t)=>"type")},getShaderSource:t=>{let a=[ai("x",e[0].dataType,e[0].dims,g),ai("skip",e[1].dataType,e[1].dims,g),ai("gamma",e[2].dataType,e[2].dims,g)];u&&a.push(ai("beta",e[3].dataType,e[3].dims,g)),m&&a.push(ai("bias",e[4].dataType,e[4].dims,g)),a.push(ni("output",e[0].dataType,o,g)),p&&a.push(ni("mean_output",1,c)),h&&a.push(ni("inv_std_output",1,c)),f&&a.push(ni("input_skip_bias_sum",e[0].dataType,o,g));let n=Gs(e[0].dataType),s=Gs(1,g);return`\n\n      ${t.registerUniforms([{name:"output_size",type:"u32"},{name:"components",type:"u32"},{name:"hidden_size",type:"u32"},{name:"epsilon",type:"f32"}]).declareVariables(...a)}\n      var<workgroup> sum_shared : array<${s}, 64>;\n      var<workgroup> sum_squared_shared : array<${s}, 64>;\n\n      ${t.mainStart([x,1,1])}\n        let ix = local_id.x;\n        let iy = global_id.x / 64;\n\n        let hidden_size_vectorized: u32 = uniforms.hidden_size / uniforms.components;\n        var stride = hidden_size_vectorized / 64;\n        let offset = ix * stride + iy * hidden_size_vectorized;\n        let offset1d = stride * ix;\n        if (ix == 63) {\n          stride = hidden_size_vectorized - stride * ix;\n        }\n        for (var i: u32 = 0; i < stride; i++) {\n          let skip_value = skip[offset + i];\n          let bias_value = ${m?"bias[offset1d + i]":n+"(0.0)"};\n          let input_value = x[offset + i];\n          let value = input_value + skip_value + bias_value;\n          ${f?"input_skip_bias_sum[offset + i] = value;":""}\n          output[offset + i] = value;\n          let f32_value = ${Qs(n,g,"value")};\n          sum_shared[ix] += f32_value;\n          sum_squared_shared[ix] += f32_value * f32_value;\n        }\n        workgroupBarrier();\n\n        var reduce_size : u32 = 64;\n        for (var curr_size = reduce_size >> 1;  curr_size > 0; curr_size = reduce_size >> 1) {\n          reduce_size = curr_size + (reduce_size & 1);\n          if (ix < curr_size) {\n            sum_shared[ix] += sum_shared[ix + reduce_size];\n            sum_squared_shared[ix] += sum_squared_shared[ix + reduce_size];\n          }\n          workgroupBarrier();\n        }\n\n        let sum = sum_shared[0];\n        let square_sum = sum_squared_shared[0];\n        let mean = ${Js("sum",g)} / f32(uniforms.hidden_size);\n        let inv_std_dev = inverseSqrt(${Js("square_sum",g)} / f32(uniforms.hidden_size) ${r?"":"- mean * mean"} + uniforms.epsilon);\n        ${p?"mean_output[global_idx] = mean;":""}\n        ${h?"inv_std_output[global_idx] = inv_std_dev;":""}\n\n        for (var i: u32 = 0; i < stride; i++) {\n          output[offset + i] = (output[offset + i] ${r?"":`- ${n}(mean)`}) *\n            ${n}(inv_std_dev) * gamma[offset1d + i]\n            ${u?"+ beta[offset1d + i]":""};\n        }\n      }`},getRunData:()=>({outputs:y,dispatchGroup:{x:Math.ceil(l/d)},programUniforms:b})}},Mm=(e,t)=>{Cm(e.inputs);let a=[0];e.outputCount>1&&a.push(-3),e.outputCount>2&&a.push(-3),e.outputCount>3&&a.push(3),e.compute(Sm(e.inputs,t,e.outputCount,!1),{outputs:a})}}),dh=Ln(()=>{rp(),op(),pp(),hp(),zm=(e,t)=>{if(!e||e.length<1)throw new Error("too few inputs");if(0!==t.axes.length){if(t.axes.length!==t.starts.length||t.axes.length!==t.ends.length)throw new Error("axes, starts and ends must have the same length")}else if(t.starts.length!==t.ends.length)throw new Error("starts and ends must have the same length");e.slice(1).forEach((t,a)=>{if(6!==e[a+1].dataType&&7!==e[a+1].dataType)throw new Error(`Input ${a} must be an array of int32 or int64`)})},Tm=(e,t)=>{let a=[];if(e.length>t)if(7===e[t].dataType)e[t].getBigInt64Array().forEach(e=>a.push(Number(e)));else{if(6!==e[t].dataType)throw new Error(`Input ${t} must be an array of int32 or int64`);e[t].getInt32Array().forEach(e=>a.push(Number(e)))}return a},Em=(e,t)=>{if(e.length>1){let t=Tm(e,1),a=Tm(e,2),n=Tm(e,3);return 0===n.length&&(n=[...Array(e[0].dims.length).keys()]),Us({starts:t,ends:a,axes:n})}return t},Am=(e,t,a,n,r)=>{let s=e;return e<0&&(s+=a[n[t]]),r[t]<0?Math.max(0,Math.min(s,a[n[t]]-1)):Math.max(0,Math.min(s,a[n[t]]))},Im=(e,t,a)=>`fn calculateInputIndices(output_indices: ${t.type.indices}) -> ${e.type.indices} {\n          var input_indices: ${e.type.indices};\n          var carry = 0u;\n          for (var i = ${a.length-1}; i >= 0; i--) {\n            let input_shape_i = ${ei("uniforms.input_shape","i",a.length)};\n            let steps_i = ${ei("uniforms.steps","i",a.length)};\n            let signs_i = ${ei("uniforms.signs","i",a.length)};\n            let starts_i = ${ei("uniforms.starts","i",a.length)};\n            var output_index = ${t.indicesGet("output_indices","i")};\n            var input_index = output_index * steps_i + starts_i + carry;\n            carry = input_index / input_shape_i;\n            input_index = input_index % input_shape_i;\n            if (signs_i < 0) {\n              input_index = input_shape_i - input_index - 1u + starts_i;\n            }\n            ${e.indicesSet("input_indices","i","input_index")};\n          }\n          return input_indices;\n      }`,Om=(e,t)=>{let a=e[0].dims,n=hs.size(a),r=t.axes.length>0?hs.normalizeAxes(t.axes,a.length):[...Array(a.length).keys()],s=Tm(e,4);s.forEach(e=>0!==e||(()=>{throw new Error("step cannot be 0")})),0===s.length&&(s=Array(r.length).fill(1));let i=t.starts.map((e,t)=>Am(e,t,a,r,s)),o=t.ends.map((e,t)=>Am(e,t,a,r,s));if(r.length!==i.length||r.length!==o.length)throw new Error("start, ends and axes should have the same number of elements");if(r.length!==a.length)for(let x=0;x<a.length;++x)r.includes(x)||(i.splice(x,0,0),o.splice(x,0,a[x]),s.splice(x,0,1));let l=s.map(e=>Math.sign(e));s.forEach((e,t,a)=>{if(e<0){let n=(o[t]-i[t])/e,r=i[t],l=r+n*s[t];i[t]=l,o[t]=r,a[t]=-e}});let d=a.slice(0);r.forEach((e,t)=>{d[e]=Math.ceil((o[e]-i[e])/s[e])});let c={dims:d,dataType:e[0].dataType},u=ni("output",e[0].dataType,d.length),m=ai("input",e[0].dataType,e[0].dims.length),p=hs.size(d),h=[{name:"outputSize",type:"u32"},{name:"starts",type:"u32",length:i.length},{name:"signs",type:"i32",length:l.length},{name:"steps",type:"u32",length:s.length}],f=[{type:12,data:p},{type:12,data:i},{type:6,data:l},{type:12,data:s},...Xs(e[0].dims,d)];return{name:"Slice",shaderCache:{hint:`${l.length}_${i.length}_${s.length}`,inputDependencies:["rank"]},getShaderSource:e=>`\n      ${e.registerUniforms(h).declareVariables(m,u)}\n        ${Im(m,u,a)}\n        ${e.mainStart()}\n          ${e.guardAgainstOutOfBoundsWorkgroupSizes("uniforms.outputSize")}\n          let output_indices = ${u.offsetToIndices("global_idx")};\n          let input_indices = calculateInputIndices(output_indices);\n          ${u.setByOffset("global_idx",m.getByIndices("input_indices"))}\n      }`,getRunData:()=>({outputs:[c],dispatchGroup:{x:Math.ceil(n/64)},programUniforms:f})}},Rm=(e,t)=>{zm(e.inputs,t);let a=Em(e.inputs,t);e.compute(Om(e.inputs,a),{inputs:[0]})},Vm=e=>{let t=e.starts,a=e.ends,n=e.axes;return Us({starts:t,ends:a,axes:n})}}),ch=Ln(()=>{rp(),op(),pp(),fp(),hp(),Pm=e=>{if(!e||1!==e.length)throw new Error("Softmax op requires 1 input.")},Dm=(e,t)=>{let a,n=e.inputs[0],r=n.dims,s=hs.size(r),i=r.length,o=hs.normalizeAxis(t.axis,i),l=o<r.length-1,d=[];l?(d=Array.from({length:i},(e,t)=>t),d[o]=i-1,d[i-1]=o,a=e.compute(hi(n,d),{inputs:[n],outputs:[-1]})[0]):a=n;let c=a.dims,u=c[i-1],m=s/u,p=Ys(u),h=u/p,f=64;1===m&&(f=256);let x=ai("x",a.dataType,a.dims,p),g=ni("result",a.dataType,a.dims,p),b=x.type.value,y="f32"===Gs(a.dataType)?`var threadMax = ${b}(-3.402823e+38f);`:`var threadMax = ${b}(-65504.0h);`,v=e.compute({name:"Softmax",shaderCache:{hint:`${p};${f}`,inputDependencies:["type"]},getRunData:()=>({outputs:[{dims:c,dataType:a.dataType}],dispatchGroup:{x:m},programUniforms:[{type:6,data:h}]}),getShaderSource:e=>`\n      var<workgroup> rowMaxShared : ${b};\n      var<workgroup> rowSumShared : ${b};\n      var<workgroup> threadShared : array<${b}, ${f}>;\n\n      fn getValue(row: i32, col: i32, row_stride: i32) -> ${b} {\n        let index = row * row_stride + col;\n        return x[index];\n      }\n\n      fn setValue(row: i32, col: i32, row_stride: i32, value: ${b}) {\n        let index = row * row_stride + col;\n        result[index] = value;\n      }\n      ${e.registerUniform("packedCols","i32").declareVariables(x,g)}\n      ${e.mainStart(f)}\n        let gindex = i32(global_idx);\n        let lindex = i32(local_idx);\n        const wg = ${f};\n        let row = gindex / wg;\n        let cols = uniforms.packedCols;\n        let row_stride : i32 = uniforms.packedCols;\n\n        // find the rows max\n        ${y}\n        for (var col = lindex; col < cols; col += wg) {\n          let value = getValue(row, col, row_stride);\n          threadMax = max(threadMax, value);\n        }\n        if (lindex < cols) {\n          threadShared[lindex] = threadMax;\n        }\n        workgroupBarrier();\n\n        var reduceSize = min(cols, wg);\n        for (var currSize = reduceSize >> 1;  currSize > 0; currSize = reduceSize >> 1) {\n          reduceSize = currSize + (reduceSize & 1);\n          if (lindex < currSize) {\n            threadShared[lindex] = max(threadShared[lindex], threadShared[lindex + reduceSize]);\n          }\n          workgroupBarrier();\n        }\n        if (lindex == 0) {\n          rowMaxShared = ${b}(${((e,t)=>4===t?`max(max(${e}.x, ${e}.y), max(${e}.z, ${e}.w))`:2===t?`max(${e}.x, ${e}.y)`:3===t?`max(max(${e}.x, ${e}.y), ${e}.z)`:e)("threadShared[0]",p)});\n        }\n        workgroupBarrier();\n\n        // find the rows sum\n        var threadSum = ${b}(0.0);\n        for (var col = lindex; col < cols; col += wg) {\n          let subExp = exp(getValue(row, col, row_stride) - rowMaxShared);\n          threadSum += subExp;\n        }\n        threadShared[lindex] = threadSum;\n        workgroupBarrier();\n\n        for (var currSize = wg >> 1;  currSize > 0; currSize = currSize >> 1) {\n          if (lindex < currSize) {\n            threadShared[lindex] = threadShared[lindex] + threadShared[lindex + currSize];\n          }\n          workgroupBarrier();\n        }\n        if (lindex == 0) {\n          rowSumShared = ${b}(${Js("threadShared[0]",p)});\n        }\n        workgroupBarrier();\n\n        // calculate final value for each element in the row\n        for (var col = lindex; col < cols; col += wg) {\n          var value = exp(getValue(row, col, row_stride) - rowMaxShared) / rowSumShared;\n          // max operation protects against NaN since all values should be >=0\n          value = max(value, ${b}(0.0));\n          setValue(row, col, row_stride, value);\n        }\n      }`},{inputs:[a],outputs:[l?-1:0]})[0];l&&e.compute(hi(v,d),{inputs:[v]})},Bm=(e,t)=>{Pm(e.inputs),Dm(e,t)},Lm=e=>Us({axis:e.axis})}),uh=Ln(()=>{rp(),op(),hp(),Fm=e=>Array.from(e.getBigInt64Array(),Number),Wm=e=>{if(!e||2!==e.length)throw new Error("Tile requires 2 inputs.");if(1!==e[0].dataType&&10!==e[0].dataType&&6!==e[0].dataType&&12!==e[0].dataType)throw new Error("Tile only support float, float16, int32, and uint32 data types");if(7!==e[1].dataType)throw new Error("Tile `repeats` input should be of int64 data type");if(1!==e[1].dims.length)throw new Error("Tile `repeats` input should be 1-D");if(Fm(e[1]).length!==e[0].dims.length)throw new Error("Tile `repeats` input should have same number of elements as rank of input data tensor")},Um=(e,t)=>{let a=[];for(let n=0;n<e.length;++n)a.push(e[n]*t[n]);return a},qm=(e,t)=>{let a=e[0].dims,n=t??Fm(e[1]),r=Um(a,n),s=hs.size(r),i=e[0].dataType,o=ai("input",i,a.length),l=ni("output",i,r.length);return{name:"Tile",shaderCache:{hint:`${n}`,inputDependencies:["rank"]},getRunData:()=>({outputs:[{dims:r,dataType:e[0].dataType}],dispatchGroup:{x:Math.ceil(s/64)},programUniforms:[{type:12,data:s},...Xs(e[0].dims,r)]}),getShaderSource:e=>`\n      const inputShape = ${o.indices(...a)};\n      ${e.registerUniform("output_size","u32").declareVariables(o,l)}\n      ${e.mainStart()}\n      ${e.guardAgainstOutOfBoundsWorkgroupSizes("uniforms.output_size")}\n      let output_indices = ${l.offsetToIndices("global_idx")};\n      var input_indices: ${o.type.indices};\n      for (var i = 0; i < ${a.length}; i++) {\n        let input_dim_i = ${o.indicesGet("uniforms.input_shape","i")};\n        let input_dim_value = ${l.indicesGet("output_indices","i")}  % input_dim_i;\n\n        ${o.indicesSet("input_indices","i","input_dim_value")}\n      }\n      ${l.setByOffset("global_idx",o.getByIndices("input_indices"))}\n    }`}},Hm=e=>{Wm(e.inputs),e.compute(qm(e.inputs),{inputs:[0]})}}),mh=Ln(()=>{rp(),op(),hp(),Gm=(e,t,a,n,r)=>{let s,i=ni("output_data",r,a.length,4),o=ai("a_data",t[1].dataType,t[1].dims.length,4),l=ai("b_data",t[2].dataType,t[2].dims.length,4),d=ai("c_data",t[0].dataType,t[0].dims.length,4),c=(e,t,a)=>`select(${t}, ${e}, ${a})`;if(n){let e=(e,t,a="")=>{let n=`a_data[index_a${t}][component_a${t}]`,r=`b_data[index_b${t}][component_b${t}]`,s=`bool(c_data[index_c${t}] & (0xffu << (component_c${t} * 8)))`;return`\n            let output_indices${t} = ${i.offsetToIndices(`global_idx * 4u + ${t}u`)};\n            let offset_a${t} = ${o.broadcastedIndicesToOffset(`output_indices${t}`,i)};\n            let offset_b${t} = ${l.broadcastedIndicesToOffset(`output_indices${t}`,i)};\n            let offset_c${t} = ${d.broadcastedIndicesToOffset(`output_indices${t}`,i)};\n            let index_a${t} = offset_a${t} / 4u;\n            let index_b${t} = offset_b${t} / 4u;\n            let index_c${t} = offset_c${t} / 4u;\n            let component_a${t} = offset_a${t} % 4u;\n            let component_b${t} = offset_b${t} % 4u;\n            let component_c${t} = offset_c${t} % 4u;\n            ${e}[${t}] = ${a}(${c(n,r,s)});\n          `};s=9===r?`\n            var data = vec4<u32>(0);\n            ${e("data",0,"u32")}\n            ${e("data",1,"u32")}\n            ${e("data",2,"u32")}\n            ${e("data",3,"u32")}\n            output_data[global_idx] = dot(vec4<u32>(0x1, 0x100, 0x10000, 0x1000000), vec4<u32>(data));`:`\n            ${e("output_data[global_idx]",0)}\n            ${e("output_data[global_idx]",1)}\n            ${e("output_data[global_idx]",2)}\n            ${e("output_data[global_idx]",3)}\n          `}else s=i.setByOffset("global_idx",c(o.getByOffset("global_idx"),l.getByOffset("global_idx"),d.getByOffset("global_idx")));return`\n        ${e.registerUniform("vec_size","u32").declareVariables(d,o,l,i)}\n        ${e.mainStart()}\n        ${e.guardAgainstOutOfBoundsWorkgroupSizes("uniforms.vec_size")}\n        ${s}\n      }`},Km=e=>{let t=e[1].dims,a=e[2].dims,n=e[0].dims,r=e[1].dataType,s=!(hs.areEqual(t,a)&&hs.areEqual(a,n)),i=t,o=hs.size(t);if(s){let e=ps.calcShape(ps.calcShape(t,a,!1),n,!1);if(!e)throw new Error("Can't perform where op on the given tensors");i=e,o=hs.size(i)}let l=Math.ceil(o/4);return{name:"Where",shaderCache:{inputDependencies:["rank","rank","rank"]},getShaderSource:t=>Gm(t,e,i,s,r),getRunData:()=>({outputs:[{dims:i,dataType:r}],dispatchGroup:{x:Math.ceil(o/64/4)},programUniforms:[{type:12,data:l},...Xs(n,t,a,i)]})}},Xm=e=>{e.compute(Km(e.inputs))}}),ph=Ln(()=>{bp(),yp(),vp(),wp(),_p(),kp(),Np(),Ip(),Rp(),Vp(),Pp(),Dp(),Bp(),Lp(),Fp(),Wp(),Up(),qp(),Hp(),Gp(),Zp(),Qp(),Jp(),eh(),th(),Kp(),ah(),nh(),rh(),sh(),ih(),gp(),oh(),Yp(),lh(),dh(),ch(),Xp(),uh(),fp(),jp(),mh(),Ym=new Map([["Abs",[Eo]],["Acos",[Ao]],["Acosh",[Io]],["Add",[Cl]],["ArgMax",[po,ho]],["ArgMin",[mo,ho]],["Asin",[Oo]],["Asinh",[Ro]],["Atan",[Vo]],["Atanh",[Po]],["Attention",[jo]],["AveragePool",[Lu,Bu]],["BatchNormalization",[$o]],["BiasAdd",[Mo]],["BiasSplitGelu",[_l]],["Cast",[Bo,Do]],["Ceil",[Wo]],["Clip",[Fo]],["Concat",[Ll,Fl]],["Conv",[$d,jd]],["ConvTranspose",[Rd,Ed]],["Cos",[Uo]],["Cosh",[qo]],["CumSum",[Pd,Dd]],["DepthToSpace",[Wd,Ud]],["DequantizeLinear",[Qu,Ju]],["Div",[Sl]],["Einsum",[Jd,ec]],["Elu",[Go,Ho]],["Equal",[Ml]],["Erf",[Xo]],["Exp",[Yo]],["Expand",[sc]],["FastGelu",[oc]],["Floor",[Zo]],["FusedConv",[$d,jd]],["Gather",[uc,cc]],["GatherElements",[jc,wc]],["GatherBlockQuantized",[gc,bc]],["GatherND",[pc,hc]],["Gelu",[Qo]],["Gemm",[$c,Nc]],["GlobalAveragePool",[Uu,Wu]],["GlobalMaxPool",[Xu,Ku]],["Greater",[Al]],["GreaterOrEqual",[Ol]],["GridSample",[Pc,Dc]],["GroupQueryAttention",[ou]],["HardSigmoid",[il,sl]],["InstanceNormalization",[uu]],["LayerNormalization",[hu]],["LeakyRelu",[Jo,Ho]],["Less",[Il]],["LessOrEqual",[Rl]],["Log",[gl]],["MatMul",[xu]],["MatMulNBits",[vu,wu]],["MaxPool",[Hu,Gu]],["Mul",[zl]],["MultiHeadAttention",[Hc,Fc]],["Neg",[tl]],["Not",[el]],["Pad",[zu]],["Pow",[Tl]],["QuickGelu",[vl,Ho]],["Range",[am]],["Reciprocal",[al]],["ReduceMin",[so]],["ReduceMean",[eo]],["ReduceMax",[ro]],["ReduceSum",[oo]],["ReduceProd",[io]],["ReduceL1",[to]],["ReduceL2",[ao]],["ReduceLogSum",[co]],["ReduceLogSumExp",[no]],["ReduceSumSquare",[lo]],["Relu",[nl]],["Resize",[Nm,$m]],["RotaryEmbedding",[au]],["ScatterND",[im,sm]],["Sigmoid",[rl]],["Sin",[ol]],["Sinh",[ll]],["Slice",[Rm,Vm]],["SkipLayerNormalization",[Mm]],["Split",[Qc,Jc]],["Sqrt",[dl]],["Softmax",[Bm,Lm]],["Sub",[El]],["Tan",[cl]],["Tanh",[ml]],["ThresholdedRelu",[xl,Ho]],["Tile",[Hm]],["Transpose",[fi,xi]],["Where",[Xm]]])}),hh=Ln(()=>{lr(),ip(),hp(),Zm=class{constructor(e){this.backend=e,this.repo=new Map,this.attributesBound=!1}getArtifact(e){return this.repo.get(e)}setArtifact(e,t){this.repo.set(e,t)}run(e,t,a,n,r){zn(e.programInfo.name);let s=this.backend.device,i=this.backend.getComputePassEncoder();this.backend.writeTimestamp(2*this.backend.pendingDispatchNumber);let o=[];for(let d of t)o.push({binding:o.length,resource:{buffer:d.buffer}});for(let d of a)o.push({binding:o.length,resource:{buffer:d.buffer}});r&&o.push({binding:o.length,resource:r});let l=s.createBindGroup({layout:e.computePipeline.getBindGroupLayout(0),entries:o,label:e.programInfo.name});if("capturing"===this.backend.sessionStatus){let t={kernelId:this.backend.currentKernelId,computePipeline:e.computePipeline,bindGroup:l,dispatchGroup:n};this.backend.capturedCommandList.get(this.backend.currentSessionId).push(t)}i.setPipeline(e.computePipeline),i.setBindGroup(0,l),i.dispatchWorkgroups(...n),this.backend.writeTimestamp(2*this.backend.pendingDispatchNumber+1),this.backend.pendingDispatchNumber++,(this.backend.pendingDispatchNumber>=this.backend.maxDispatchNumber||"at-passes"===this.backend.queryType)&&this.backend.endComputePass(),this.backend.pendingDispatchNumber>=this.backend.maxDispatchNumber&&this.backend.flush(),Tn(e.programInfo.name)}dispose(){}build(e,t){zn(e.name);let a=this.backend.device,n=[];[{feature:"shader-f16",extension:"f16"},{feature:"subgroups",extension:"subgroups"}].forEach(e=>{a.features.has(e.feature)&&n.push(`enable ${e.extension};`)});let r=oi(t,this.backend.device.limits),s=e.getShaderSource(r),i=`${n.join("\n")}\n${r.additionalImplementations}\n${s}`,o=a.createShaderModule({code:i,label:e.name});us("verbose",()=>`[WebGPU] ${e.name} shader code: ${i}`);let l=a.createComputePipeline({compute:{module:o,entryPoint:"main"},layout:"auto",label:e.name});return Tn(e.name),{programInfo:e,computePipeline:l,uniformVariablesInfo:r.variablesInfo}}normalizeDispatchGroupSize(e){let t="number"==typeof e?e:e.x,a="number"==typeof e?1:e.y||1,n="number"==typeof e?1:e.z||1,r=this.backend.device.limits.maxComputeWorkgroupsPerDimension;if(t<=r&&a<=r&&n<=r)return[t,a,n];let s=t*a*n,i=Math.ceil(Math.sqrt(s));if(i>r){if(i=Math.ceil(Math.cbrt(s)),i>r)throw new Error("Total dispatch size exceeds WebGPU maximum.");return[i,i,i]}return[i,i,1]}}}),fh={};Fn(fh,{WebGpuBackend:()=>yh});var xh,gh,bh,yh,vh=Ln(()=>{lr(),rp(),ip(),lp(),mp(),ph(),hh(),xh=(e,t)=>{if(t.length!==e.length)throw new Error(`inputDependencies length ${t.length} is not equal to inputTensors length ${e.length}.`);let a=[];for(let n=0;n<e.length;++n){let r=e[n].dataType;switch(t[n]){case"none":a.push("");break;case"type":a.push(`${r}`);break;case"rank":{let t=e[n].dims.length;a.push(`${r};${t}`);break}case"dims":{let t=e[n].dims.join(",");a.push(`${r};${t}`);break}default:throw new Error(`unsupported input dependency: ${t[n]}`)}}return a.join("|")},gh=(e,t,a)=>{let n=e.name;return e.shaderCache?.hint&&(n+="["+e.shaderCache.hint+"]"),n+=":"+a+`:${xh(t,e.shaderCache?.inputDependencies??new Array(t.length).fill("dims"))}`,n},bh=class{constructor(e){e&&(this.architecture=e.architecture,this.vendor=e.vendor)}isArchitecture(e){return this.architecture===e}isVendor(e){return this.vendor===e}},yh=class{constructor(){this.currentSessionId=null,this.currentKernelId=null,this.commandEncoder=null,this.computePassEncoder=null,this.maxDispatchNumber=16,this.pendingDispatchNumber=0,this.pendingKernels=[],this.pendingQueries=new Map,this.sessionStatus="default",this.capturedCommandList=new Map,this.capturedPendingKernels=new Map,this.sessionExternalDataMapping=new Map}get currentKernelCustomData(){if(null===this.currentKernelId)throw new Error("currentKernelCustomData(): currentKernelId is null. (should not happen)");let e=this.kernelCustomData.get(this.currentKernelId);return e||(e={},this.kernelCustomData.set(this.currentKernelId,e)),e}async initialize(e,t){this.env=e;let a=[],n={requiredLimits:{maxComputeWorkgroupStorageSize:t.limits.maxComputeWorkgroupStorageSize,maxComputeWorkgroupsPerDimension:t.limits.maxComputeWorkgroupsPerDimension,maxStorageBufferBindingSize:t.limits.maxStorageBufferBindingSize,maxBufferSize:t.limits.maxBufferSize,maxComputeInvocationsPerWorkgroup:t.limits.maxComputeInvocationsPerWorkgroup,maxComputeWorkgroupSizeX:t.limits.maxComputeWorkgroupSizeX,maxComputeWorkgroupSizeY:t.limits.maxComputeWorkgroupSizeY,maxComputeWorkgroupSizeZ:t.limits.maxComputeWorkgroupSizeZ},requiredFeatures:a},r=e=>t.features.has(e)&&a.push(e)&&!0;r("chromium-experimental-timestamp-query-inside-passes")||r("timestamp-query"),r("shader-f16"),r("subgroups"),this.device=await t.requestDevice(n),this.adapterInfo=new bh(t.info||await t.requestAdapterInfo()),this.gpuDataManager=Fs(this),this.programManager=new Zm(this),this.kernels=new Map,this.kernelPersistentData=new Map,this.kernelCustomData=new Map,ds(e.logLevel,!!e.debug),this.device.onuncapturederror=e=>{e.error,GPUValidationError},Object.defineProperty(this.env.webgpu,"device",{value:this.device,writable:!1,enumerable:!0,configurable:!1}),Object.defineProperty(this.env.webgpu,"adapter",{value:t,writable:!1,enumerable:!0,configurable:!1}),this.setQueryType()}dispose(){typeof this.querySet<"u"&&this.querySet.destroy(),this.gpuDataManager.dispose()}getCommandEncoder(){return this.commandEncoder||(this.commandEncoder=this.device.createCommandEncoder()),this.commandEncoder}getComputePassEncoder(){if(!this.computePassEncoder){let e=this.getCommandEncoder(),t={};"at-passes"===this.queryType&&(t.timestampWrites={querySet:this.querySet,beginningOfPassWriteIndex:2*this.pendingDispatchNumber,endOfPassWriteIndex:2*this.pendingDispatchNumber+1}),this.computePassEncoder=e.beginComputePass(t)}return this.computePassEncoder}endComputePass(){this.computePassEncoder&&(this.computePassEncoder.end(),this.computePassEncoder=null)}flush(){if(!this.commandEncoder)return;let e;zn(),this.endComputePass(),"none"!==this.queryType&&(this.commandEncoder.resolveQuerySet(this.querySet,0,2*this.pendingDispatchNumber,this.queryResolveBuffer,0),e=this.device.createBuffer({size:2*this.pendingDispatchNumber*8,usage:GPUBufferUsage.MAP_READ|GPUBufferUsage.COPY_DST}),this.pendingQueries.set(e,this.pendingKernels),this.pendingKernels=[],this.commandEncoder.copyBufferToBuffer(this.queryResolveBuffer,0,e,0,2*this.pendingDispatchNumber*8)),this.device.queue.submit([this.commandEncoder.finish()]),this.gpuDataManager.refreshPendingBuffers(),this.commandEncoder=null,this.pendingDispatchNumber=0,"none"!==this.queryType&&e.mapAsync(GPUMapMode.READ).then(()=>{let t=new BigUint64Array(e.getMappedRange()),a=this.pendingQueries.get(e);for(let e=0;e<t.length/2;e++){let n=a[e],r=n.kernelId,s=this.kernels.get(r),i=s.kernelType,o=s.kernelName,l=n.programName,d=n.inputTensorViews,c=n.outputTensorViews,u=t[2*e],m=t[2*e+1];typeof this.queryTimeBase>"u"&&(this.queryTimeBase=u);let p=Number(u-this.queryTimeBase),h=Number(m-this.queryTimeBase);if(!Number.isSafeInteger(p)||!Number.isSafeInteger(h))throw new RangeError("incorrect timestamp range");if(this.env.webgpu.profiling?.ondata)this.env.webgpu.profiling.ondata({version:1,inputsMetadata:d.map(e=>({dims:e.dims,dataType:Jr(e.dataType)})),outputsMetadata:c.map(e=>({dims:e.dims,dataType:Jr(e.dataType)})),kernelId:r,kernelType:i,kernelName:o,programName:l,startTime:p,endTime:h});else{let e="";d.forEach((t,a)=>{e+=`input[${a}]: [${t.dims}] | ${Jr(t.dataType)}, `});let t="";c.forEach((e,a)=>{t+=`output[${a}]: [${e.dims}] | ${Jr(e.dataType)}, `})}Sn("GPU",`${l}::${u}::${m}`)}e.unmap(),this.pendingQueries.delete(e)}),Tn()}run(e,t,a,n,r,s){zn(e.name);let i=[];for(let b=0;b<t.length;++b){let e=t[b].data;if(0===e)continue;let a=this.gpuDataManager.get(e);if(!a)throw new Error(`no GPU data for input: ${e}`);i.push(a)}let{outputs:o,dispatchGroup:l,programUniforms:d}=e.getRunData(t),c=0===a.length?o.map((e,t)=>t):a;if(c.length!==o.length)throw new Error(`Output size ${c.length} must be equal to ${o.length}.`);let u,m=[],p=[];for(let b=0;b<o.length;++b){if(!Number.isInteger(c[b])||c[b]<-3||c[b]>=s)throw new Error(`Invalid output index: ${c[b]}`);if(-3===c[b])continue;let e=-1===c[b],t=-2===c[b],a=e||t?r(o[b].dataType,o[b].dims):n(c[b],o[b].dataType,o[b].dims);if(m.push(a),0===a.data)continue;let i=this.gpuDataManager.get(a.data);if(!i)throw new Error(`no GPU data for output: ${a.data}`);if(e&&this.temporaryData.push(i),t){let e=this.kernelPersistentData.get(this.currentKernelId);e||(e=[],this.kernelPersistentData.set(this.currentKernelId,e)),e.push(i)}p.push(i)}if(i.length!==t.length||p.length!==m.length){if(0===p.length)return Tn(e.name),m;throw new Error(`Program ${e.name} has zero-sized tensor(s) in inputs or outputs. This is not supported now.`)}if(d){let e=0,t=[];d.forEach(a=>{let n="number"==typeof a.data?[a.data]:a.data;if(0===n.length)return;let r,s,i=10===a.type?2:4;10===a.type?(s=n.length>4?16:n.length>2?8:n.length*i,r=n.length>4?16:i*n.length):(s=n.length<=2?n.length*i:16,r=16),e=Math.ceil(e/s)*s,t.push(e);let o=10===a.type?8:4;e+=n.length>4?Math.ceil(n.length/o)*r:n.length*i});let a=16;e=Math.ceil(e/a)*a;let n=new ArrayBuffer(e);d.forEach((e,a)=>{let r=t[a],s="number"==typeof e.data?[e.data]:e.data;if(6===e.type)new Int32Array(n,r,s.length).set(s);else if(12===e.type)new Uint32Array(n,r,s.length).set(s);else if(10===e.type)new Uint16Array(n,r,s.length).set(s);else{if(1!==e.type)throw new Error(`Unsupported uniform type: ${Jr(e.type)}`);new Float32Array(n,r,s.length).set(s)}});let r=this.gpuDataManager.create(e,GPUBufferUsage.COPY_DST|GPUBufferUsage.UNIFORM);this.device.queue.writeBuffer(r.buffer,0,n,0,e),this.gpuDataManager.release(r.id),u={offset:0,size:e,buffer:r.buffer}}let h=this.programManager.normalizeDispatchGroupSize(l),f=1===h[1]&&1===h[2],x=gh(e,t,f),g=this.programManager.getArtifact(x);if(g||(g=this.programManager.build(e,h),this.programManager.setArtifact(x,g),us("info",()=>`[artifact] key: ${x}, programName: ${e.name}`)),d&&g.uniformVariablesInfo){if(d.length!==g.uniformVariablesInfo.length)throw new Error(`Uniform variables count mismatch: expect ${g.uniformVariablesInfo.length}, got ${d.length} in program "${g.programInfo.name}".`);for(let e=0;e<d.length;e++){let t=d[e],a=t.type,n="number"==typeof t.data?1:t.data.length,[r,s]=g.uniformVariablesInfo[e];if(a!==r||n!==s)throw new Error(`Uniform variable ${e} mismatch: expect type ${r} with size ${s}, got type ${a} with size ${n} in program "${g.programInfo.name}".`)}}if(us("info",()=>`[ProgramManager] run "${e.name}" (key=${x}) with ${h[0]}x${h[1]}x${h[2]}`),"none"!==this.queryType||"capturing"===this.sessionStatus){let e={kernelId:this.currentKernelId,programName:g.programInfo.name,inputTensorViews:t,outputTensorViews:m};this.pendingKernels.push(e),"capturing"===this.sessionStatus&&this.capturedPendingKernels.get(this.currentSessionId).push(e)}return this.programManager.run(g,i,p,h,u),Tn(e.name),m}upload(e,t){this.gpuDataManager.upload(e,t)}memcpy(e,t){this.gpuDataManager.memcpy(e,t)}async download(e,t){await this.gpuDataManager.download(e,t)}alloc(e){return this.gpuDataManager.create(e).id}free(e){return this.gpuDataManager.release(e)}createKernel(e,t,a,n){let r=Ym.get(e);if(!r)throw new Error(`kernel not implemented: ${e}`);let s={kernelType:e,kernelName:n,kernelEntry:r[0],attributes:[r[1],a]};this.kernels.set(t,s)}releaseKernel(e){let t=this.kernelPersistentData.get(e);if(t){for(let e of t)this.gpuDataManager.release(e.id);this.kernelPersistentData.delete(e)}this.kernelCustomData.delete(e),this.kernels.delete(e)}computeKernel(e,t,a){let n=this.kernels.get(e);if(!n)throw new Error(`kernel not created: ${e}`);let r=n.kernelType,s=n.kernelName,i=n.kernelEntry,o=n.attributes;if(null!==this.currentKernelId)throw new Error(`kernel "[${r}] ${s}" is not allowed to be called recursively`);this.currentKernelId=e,o[0]&&(o[1]=o[0](o[1]),o[0]=void 0),us("info",()=>`[WebGPU] Start to run kernel "[${r}] ${s}"...`);let l=this.env.debug;this.temporaryData=[];try{return l&&this.device.pushErrorScope("validation"),i(t,o[1]),0}catch(d){return a.push(Promise.resolve(`[WebGPU] Kernel "[${r}] ${s}" failed. ${d}`)),1}finally{l&&a.push(this.device.popErrorScope().then(e=>e?`GPU validation error for kernel "[${r}] ${s}": ${e.message}`:null));for(let e of this.temporaryData)this.gpuDataManager.release(e.id);this.temporaryData=[],this.currentKernelId=null}}registerBuffer(e,t,a,n){let r=this.sessionExternalDataMapping.get(e);r||(r=new Map,this.sessionExternalDataMapping.set(e,r));let s=r.get(t),i=this.gpuDataManager.registerExternalBuffer(a,n,s);return r.set(t,[i,a]),i}unregisterBuffers(e){let t=this.sessionExternalDataMapping.get(e);t&&(t.forEach(e=>this.gpuDataManager.unregisterExternalBuffer(e[0])),this.sessionExternalDataMapping.delete(e))}getBuffer(e){let t=this.gpuDataManager.get(e);if(!t)throw new Error(`no GPU data for buffer: ${e}`);return t.buffer}createDownloader(e,t,a){return async()=>{let n=await Bs(this,e,t);return ys(n.buffer,a)}}writeTimestamp(e){"inside-passes"===this.queryType&&this.computePassEncoder.writeTimestamp(this.querySet,e)}setQueryType(){this.queryType="none",("default"===this.env.webgpu.profiling?.mode||(typeof this.env.trace>"u"?this.env.wasm.trace:this.env.trace))&&(this.device.features.has("chromium-experimental-timestamp-query-inside-passes")?this.queryType="inside-passes":this.device.features.has("timestamp-query")&&(this.queryType="at-passes"),"none"!==this.queryType&&typeof this.querySet>"u"&&(this.querySet=this.device.createQuerySet({type:"timestamp",count:2*this.maxDispatchNumber}),this.queryResolveBuffer=this.device.createBuffer({size:2*this.maxDispatchNumber*8,usage:GPUBufferUsage.COPY_SRC|GPUBufferUsage.QUERY_RESOLVE})))}captureBegin(){us("info","captureBegin"),this.capturedCommandList.get(this.currentSessionId)||this.capturedCommandList.set(this.currentSessionId,[]),this.capturedPendingKernels.get(this.currentSessionId)||this.capturedPendingKernels.set(this.currentSessionId,[]),this.flush(),this.sessionStatus="capturing"}captureEnd(){us("info","captureEnd"),this.flush(),this.sessionStatus="default"}replay(){us("info","replay"),this.sessionStatus="replaying";let e=this.capturedCommandList.get(this.currentSessionId),t=this.capturedPendingKernels.get(this.currentSessionId),a=e.length;this.pendingKernels=[];for(let n=0;n<a;n++){let a=this.getComputePassEncoder(),r=e[n];this.writeTimestamp(2*this.pendingDispatchNumber),a.setPipeline(r.computePipeline),a.setBindGroup(0,r.bindGroup),a.dispatchWorkgroups(...r.dispatchGroup),this.writeTimestamp(2*this.pendingDispatchNumber+1),this.pendingDispatchNumber++,"none"!==this.queryType&&this.pendingKernels.push(t[n]),(this.pendingDispatchNumber>=this.maxDispatchNumber||"at-passes"===this.queryType)&&this.endComputePass(),this.pendingDispatchNumber>=this.maxDispatchNumber&&this.flush()}this.flush(),this.sessionStatus="default"}onCreateSession(){this.gpuDataManager.onCreateSession()}onReleaseSession(e){this.unregisterBuffers(e),this.capturedCommandList.has(e)&&this.capturedCommandList.delete(e),this.capturedPendingKernels.has(e)&&this.capturedPendingKernels.delete(e),this.gpuDataManager.onReleaseSession(e)}onRunStart(e){this.currentSessionId=e,this.setQueryType()}}}),wh={};Fn(wh,{init:()=>kh});var jh,_h,kh,Nh,$h,Ch,Sh,Mh,zh,Th,Eh,Ah,Ih,Oh,Rh,Vh,Ph,Dh,Bh,Lh,Fh,Wh,Uh,qh,Hh,Gh,Kh,Xh,Yh,Zh,Qh,Jh,ef,tf,af,nf,rf,sf=Ln(()=>{rp(),ip(),op(),cp(),jh=class e{constructor(e,t,a,n){this.module=e,this.dataType=t,this.data=a,this.dims=n}getFloat32Array(){if(1!==this.dataType)throw new Error("Invalid data type");let e=hs.size(this.dims);return 0===e?new Float32Array:new Float32Array(this.module.HEAP8.buffer,this.data,e)}getBigInt64Array(){if(7!==this.dataType)throw new Error("Invalid data type");let e=hs.size(this.dims);return 0===e?new BigInt64Array:new BigInt64Array(this.module.HEAP8.buffer,this.data,e)}getInt32Array(){if(6!==this.dataType)throw new Error("Invalid data type");let e=hs.size(this.dims);return 0===e?new Int32Array:new Int32Array(this.module.HEAP8.buffer,this.data,e)}getUint16Array(){if(10!==this.dataType&&4!==this.dataType)throw new Error("Invalid data type");let e=hs.size(this.dims);return 0===e?new Uint16Array:new Uint16Array(this.module.HEAP8.buffer,this.data,e)}reshape(t){if(hs.size(t)!==hs.size(this.dims))throw new Error("Invalid new shape");return new e(this.module,this.dataType,this.data,t)}},_h=class{constructor(e,t,a){this.module=e,this.backend=t,this.customDataOffset=0,this.customDataSize=0,this.adapterInfo=t.adapterInfo;let n=e.PTR_SIZE,r=a/e.PTR_SIZE,s=4===n?"i32":"i64";this.opKernelContext=Number(e.getValue(n*r++,s));let i=Number(e.getValue(n*r++,s));this.outputCount=Number(e.getValue(n*r++,s)),this.customDataOffset=Number(e.getValue(n*r++,"*")),this.customDataSize=Number(e.getValue(n*r++,s));let o=[];for(let l=0;l<i;l++){let t=Number(e.getValue(n*r++,s)),a=Number(e.getValue(n*r++,"*")),i=Number(e.getValue(n*r++,s)),l=[];for(let o=0;o<i;o++)l.push(Number(e.getValue(n*r++,s)));o.push(new jh(e,t,a,l))}this.inputs=o}get kernelCustomData(){return this.backend.currentKernelCustomData}get customDataBuffer(){return this.module.HEAPU8.subarray(this.customDataOffset,this.customDataOffset+this.customDataSize)}compute(e,t){let a=t?.inputs?.map(e=>"number"==typeof e?this.inputs[e]:e)??this.inputs,n=t?.outputs??[];return this.backend.run(e,a,n,(e,t,a)=>new jh(this.module,t,this.output(e,a),a),(e,t)=>{let a=es(e,t);if(!a)throw new Error(`Unsupported data type: ${e}`);let n=a>0?this.backend.gpuDataManager.create(a).id:0;return new jh(this.module,e,n,t)},this.outputCount)}output(e,t){let a=this.module.stackSave();try{let a=this.module.PTR_SIZE,n=4===a?"i32":"i64",r=this.module.stackAlloc((1+t.length)*a);this.module.setValue(r,t.length,n);for(let e=0;e<t.length;e++)this.module.setValue(r+a*(e+1),t[e],n);return this.module._JsepOutput(this.opKernelContext,e,r)}catch(n){throw new Error(`Failed to generate kernel's output[${e}] with dims [${t}]. If you are running with pre-allocated output, please make sure the output type/dims are correct. Error: ${n}`)}finally{this.module.stackRestore(a)}}},kh=async(e,t,a,n)=>{let r=t.jsepInit;if(!r)throw new Error("Failed to initialize JSEP. The WebAssembly module is not built with JSEP support.");if("webgpu"===e){let e=new(0,(vh(),Wn(fh)).WebGpuBackend);await e.initialize(a,n),r("webgpu",[e,t=>e.alloc(Number(t)),t=>e.free(t),(a,n,r,s=!1)=>{if(s)us("verbose",()=>`[WebGPU] jsepCopyGpuToGpu: src=${Number(a)}, dst=${Number(n)}, size=${Number(r)}`),e.memcpy(Number(a),Number(n));else{us("verbose",()=>`[WebGPU] jsepCopyCpuToGpu: dataOffset=${Number(a)}, gpuDataId=${Number(n)}, size=${Number(r)}`);let s=t.HEAPU8.subarray(Number(a>>>0),Number(a>>>0)+Number(r));e.upload(Number(n),s)}},async(a,n,r)=>{us("verbose",()=>`[WebGPU] jsepCopyGpuToCpu: gpuDataId=${a}, dataOffset=${n}, size=${r}`),await e.download(Number(a),()=>t.HEAPU8.subarray(Number(n)>>>0,Number(n+r)>>>0))},(a,n,r)=>e.createKernel(a,Number(n),r,t.UTF8ToString(t._JsepGetNodeName(Number(n)))),t=>e.releaseKernel(t),(a,n,r,s)=>{us("verbose",()=>`[WebGPU] jsepRun: sessionHandle=${r}, kernel=${a}, contextDataOffset=${n}`);let i=new _h(t,e,Number(n));return e.computeKernel(Number(a),i,s)},()=>e.captureBegin(),()=>e.captureEnd(),()=>e.replay()])}else{let e=new As(a);r("webnn",[e,()=>e.reserveTensorId(),t=>e.releaseTensorId(t),async(t,a,n,r,s)=>e.ensureTensor(t,a,n,r,s),(t,a)=>{e.uploadTensor(t,a)},async(t,a)=>e.downloadTensor(t,a),(t,a)=>e.registerMLContext(t,a),!!a.trace])}}}),of=Ln(()=>{lr(),ap(),np(),rp(),ep(),tp(),sp(),Nh=(e,t)=>{0!==Lr()._OrtInit(e,t)&&Ur("Can't initialize onnxruntime.")},$h=async e=>{Nh(e.wasm.numThreads,as(e.logLevel))},Ch=async(e,t)=>{Lr().asyncInit?.();let a=e.webgpu.adapter;if("webgpu"===t){if(typeof navigator>"u"||!navigator.gpu)throw new Error("WebGPU is not supported in current environment");if(a){if("object"!=typeof a.limits||"object"!=typeof a.features||"function"!=typeof a.requestDevice)throw new Error("Invalid GPU adapter set in `env.webgpu.adapter`. It must be a GPUAdapter object.")}else{let t=e.webgpu.powerPreference;if(void 0!==t&&"low-power"!==t&&"high-performance"!==t)throw new Error(`Invalid powerPreference setting: "${t}"`);let n=e.webgpu.forceFallbackAdapter;if(void 0!==n&&"boolean"!=typeof n)throw new Error(`Invalid forceFallbackAdapter setting: "${n}"`);if(a=await navigator.gpu.requestAdapter({powerPreference:t,forceFallbackAdapter:n}),!a)throw new Error('Failed to get GPU adapter. You may need to enable flag "--enable-unsafe-webgpu" if you are using Chrome.')}}if("webnn"===t&&(typeof navigator>"u"||!navigator.ml))throw new Error("WebNN is not supported in current environment");{let n=(sf(),Wn(wh)).init;"webgpu"===t&&await n("webgpu",Lr(),e,a),"webnn"===t&&await n("webnn",Lr(),e)}},Sh=new Map,Mh=e=>{let t=Lr(),a=t.stackSave();try{let a=t.PTR_SIZE,n=t.stackAlloc(2*a);0!==t._OrtGetInputOutputCount(e,n,n+a)&&Ur("Can't get session input/output count.");let r=4===a?"i32":"i64";return[Number(t.getValue(n,r)),Number(t.getValue(n+a,r))]}finally{t.stackRestore(a)}},zh=(e,t)=>{let a=Lr(),n=a.stackSave(),r=0;try{let n=a.PTR_SIZE,s=a.stackAlloc(2*n);0!==a._OrtGetInputOutputMetadata(e,t,s,s+n)&&Ur("Can't get session input/output metadata.");let i=Number(a.getValue(s,"*"));r=Number(a.getValue(s+n,"*"));let o=a.HEAP32[r/4];if(0===o)return[i,0];let l=a.HEAPU32[r/4+1],d=[];for(let e=0;e<l;e++){let t=Number(a.getValue(r+8+e*n,"*"));d.push(0!==t?a.UTF8ToString(t):Number(a.getValue(r+8+(e+l)*n,"*")))}return[i,o,d]}finally{a.stackRestore(n),0!==r&&a._OrtFree(r)}},Th=e=>{let t=Lr(),a=t._malloc(e.byteLength);if(0===a)throw new Error(`Can't create a session. failed to allocate a buffer of size ${e.byteLength}.`);return t.HEAPU8.set(e,a),[a,e.byteLength]},Eh=async(e,t)=>{let a,n,r=Lr();Array.isArray(e)?[a,n]=e:e.buffer===r.HEAPU8.buffer?[a,n]=[e.byteOffset,e.byteLength]:[a,n]=Th(e);let s=0,i=0,o=0,l=[],d=[],c=[];try{if([i,l]=await Zr(t),t?.externalData&&r.mountExternalData){let e=[];for(let a of t.externalData){let t="string"==typeof a?a:a.path;e.push(is("string"==typeof a?a:a.data).then(e=>{r.mountExternalData(t,e)}))}await Promise.all(e)}for(let a of t?.executionProviders??[])if("webnn"===("string"==typeof a?a:a.name)){if(r.shouldTransferToMLTensor=!1,"string"!=typeof a){let e=a,t=e?.context,n=e?.gpuDevice,s=e?.deviceType,i=e?.powerPreference;r.currentContext=t||(n?await r.webnnCreateMLContext(n):await r.webnnCreateMLContext({deviceType:s,powerPreference:i}))}else r.currentContext=await r.webnnCreateMLContext();break}s=await r._OrtCreateSession(a,n,i),r.webgpuOnCreateSession?.(s),0===s&&Ur("Can't create a session."),r.jsepOnCreateSession?.(),r.currentContext&&(r.webnnRegisterMLContext(s,r.currentContext),r.currentContext=void 0,r.shouldTransferToMLTensor=!0);let[e,u]=Mh(s),m=!!t?.enableGraphCapture,p=[],h=[],f=[],x=[],g=[];for(let t=0;t<e;t++){let[e,a,n]=zh(s,t);0===e&&Ur("Can't get an input name."),d.push(e);let i=r.UTF8ToString(e);p.push(i),f.push(0===a?{name:i,isTensor:!1}:{name:i,isTensor:!0,type:Jr(a),shape:n})}for(let a=0;a<u;a++){let[n,i,o]=zh(s,a+e);0===n&&Ur("Can't get an output name."),c.push(n);let l=r.UTF8ToString(n);h.push(l),x.push(0===i?{name:l,isTensor:!1}:{name:l,isTensor:!0,type:Jr(i),shape:o});{if(m&&void 0===t?.preferredOutputLocation){g.push("gpu-buffer");continue}let e="string"==typeof t?.preferredOutputLocation?t.preferredOutputLocation:t?.preferredOutputLocation?.[l]??"cpu",a=r.webnnIsGraphOutput;if("cpu"===e&&a&&a(s,l)){g.push("ml-tensor-cpu-output");continue}if("cpu"!==e&&"cpu-pinned"!==e&&"gpu-buffer"!==e&&"ml-tensor"!==e)throw new Error(`Not supported preferred output location: ${e}.`);if(m&&"gpu-buffer"!==e)throw new Error(`Not supported preferred output location: ${e}. Only 'gpu-buffer' location is supported when enableGraphCapture is true.`);g.push(e)}}let b=null;return g.some(e=>"gpu-buffer"===e||"ml-tensor"===e||"ml-tensor-cpu-output"===e)&&(o=r._OrtCreateBinding(s),0===o&&Ur("Can't create IO binding."),b={handle:o,outputPreferredLocations:g,outputPreferredLocationsEncoded:g.map(e=>"ml-tensor-cpu-output"===e?"ml-tensor":e).map(e=>ss(e))}),Sh.set(s,[s,d,c,b,m,!1]),[s,p,h,f,x]}catch(u){throw d.forEach(e=>r._OrtFree(e)),c.forEach(e=>r._OrtFree(e)),0!==o&&0!==r._OrtReleaseBinding(o)&&Ur("Can't release IO binding."),0!==s&&0!==r._OrtReleaseSession(s)&&Ur("Can't release session."),u}finally{r._free(a),0!==i&&0!==r._OrtReleaseSessionOptions(i)&&Ur("Can't release session options."),l.forEach(e=>r._free(e)),r.unmountExternalData?.()}},Ah=e=>{let t=Lr(),a=Sh.get(e);if(!a)throw new Error(`cannot release session. invalid session id: ${e}`);let[n,r,s,i,o]=a;i&&(o&&0!==t._OrtClearBoundOutputs(i.handle)&&Ur("Can't clear bound outputs."),0!==t._OrtReleaseBinding(i.handle)&&Ur("Can't release IO binding.")),t.jsepOnReleaseSession?.(e),t.webnnOnReleaseSession?.(e),t.webgpuOnReleaseSession?.(e),r.forEach(e=>t._OrtFree(e)),s.forEach(e=>t._OrtFree(e)),0!==t._OrtReleaseSession(n)&&Ur("Can't release session."),Sh.delete(e)},Ih=async(e,t,a,n,r,s,i=!1)=>{if(!e)return void t.push(0);let o,l,d=Lr(),c=d.PTR_SIZE,u=e[0],m=e[1],p=e[3],h=p;if("string"===u&&("gpu-buffer"===p||"ml-tensor"===p))throw new Error("String tensor is not supported on GPU.");if(i&&"gpu-buffer"!==p)throw new Error(`External buffer must be provided for input/output index ${s} when enableGraphCapture is true.`);if("gpu-buffer"===p){let t=e[2].gpuBuffer;l=es(Qr(u),m);{let e=d.jsepRegisterBuffer;if(!e)throw new Error('Tensor location "gpu-buffer" is not supported without using WebGPU.');o=e(n,s,t,l)}}else if("ml-tensor"===p){let t=e[2].mlTensor;l=es(Qr(u),m);let a=d.webnnRegisterMLTensor;if(!a)throw new Error('Tensor location "ml-tensor" is not supported without using WebNN.');o=a(n,t,Qr(u),m)}else{let t=e[2];if(Array.isArray(t)){l=c*t.length,o=d._malloc(l),a.push(o);for(let e=0;e<t.length;e++){if("string"!=typeof t[e])throw new TypeError(`tensor data at index ${e} is not a string`);d.setValue(o+e*c,Fr(t[e],a),"*")}}else{let e=d.webnnIsGraphInput,s=d.webnnIsGraphOutput;if("string"!==u&&e&&s){let i=d.UTF8ToString(r);if(e(n,i)||s(n,i)){let e=Qr(u);l=es(e,m),h="ml-tensor";let a=d.webnnCreateTemporaryTensor,r=d.webnnUploadTensor;if(!a||!r)throw new Error('Tensor location "ml-tensor" is not supported without using WebNN.');let s=await a(n,e,m);r(s,new Uint8Array(t.buffer,t.byteOffset,t.byteLength)),o=s}else l=t.byteLength,o=d._malloc(l),a.push(o),d.HEAPU8.set(new Uint8Array(t.buffer,t.byteOffset,l),o)}else l=t.byteLength,o=d._malloc(l),a.push(o),d.HEAPU8.set(new Uint8Array(t.buffer,t.byteOffset,l),o)}}let f=d.stackSave(),x=d.stackAlloc(4*m.length);try{m.forEach((e,t)=>d.setValue(x+t*c,e,4===c?"i32":"i64"));let e=d._OrtCreateTensor(Qr(u),o,l,x,m.length,ss(h));0===e&&Ur(`Can't create tensor for input/output. session=${n}, index=${s}.`),t.push(e)}finally{d.stackRestore(f)}},Oh=async(e,t,a,n,r,s)=>{let i=Lr(),o=i.PTR_SIZE,l=Sh.get(e);if(!l)throw new Error(`cannot run inference. invalid session id: ${e}`);let d=l[0],c=l[1],u=l[2],m=l[3],p=l[4],h=l[5],f=t.length,x=n.length,g=0,b=[],y=[],v=[],w=[],j=i.stackSave(),_=i.stackAlloc(f*o),k=i.stackAlloc(f*o),N=i.stackAlloc(x*o),$=i.stackAlloc(x*o);try{[g,b]=qr(s),En("wasm prepareInputOutputTensor");for(let n=0;n<f;n++)await Ih(a[n],y,w,e,c[t[n]],t[n],p);for(let t=0;t<x;t++)await Ih(r[t],v,w,e,u[n[t]],f+n[t],p);An("wasm prepareInputOutputTensor");for(let e=0;e<f;e++)i.setValue(_+e*o,y[e],"*"),i.setValue(k+e*o,c[t[e]],"*");for(let e=0;e<x;e++)i.setValue(N+e*o,v[e],"*"),i.setValue($+e*o,u[n[e]],"*");if(m&&!h){let{handle:a,outputPreferredLocations:s,outputPreferredLocationsEncoded:o}=m;if(c.length!==f)throw new Error(`input count from feeds (${f}) is expected to be always equal to model's input count (${c.length}).`);En("wasm bindInputsOutputs");for(let n=0;n<f;n++){let r=t[n];0!==await i._OrtBindInput(a,c[r],y[n])&&Ur(`Can't bind input[${n}] for session=${e}.`)}for(let t=0;t<x;t++){let l=n[t];r[t]?.[3]?0!==i._OrtBindOutput(a,u[l],v[t],0)&&Ur(`Can't bind pre-allocated output[${t}] for session=${e}.`):0!==i._OrtBindOutput(a,u[l],0,o[l])&&Ur(`Can't bind output[${t}] to ${s[t]} for session=${e}.`)}An("wasm bindInputsOutputs"),Sh.set(e,[d,c,u,m,p,!0])}let l;i.jsepOnRunStart?.(d),i.webnnOnRunStart?.(d),l=m?await i._OrtRunWithBinding(d,m.handle,x,N,g):await i._OrtRun(d,k,_,f,$,x,N,g),0!==l&&Ur("failed to call OrtRun().");let j=[],C=[];En("wasm ProcessOutputTensor");for(let t=0;t<x;t++){let a=Number(i.getValue(N+t*o,"*"));if(a===v[t]){j.push(r[t]);continue}let s,l=i.stackSave(),d=i.stackAlloc(4*o),c=!1,u=0;try{0!==i._OrtGetTensorData(a,d,d+o,d+2*o,d+3*o)&&Ur(`Can't access output tensor data on index ${t}.`);let r=4===o?"i32":"i64",l=Number(i.getValue(d,r));u=i.getValue(d+o,"*");let p=i.getValue(d+2*o,"*"),h=Number(i.getValue(d+3*o,r)),f=[];for(let e=0;e<h;e++)f.push(Number(i.getValue(p+e*o,r)));0!==i._OrtFree(p)&&Ur("Can't free memory for tensor dims.");let x=f.reduce((e,t)=>e*t,1);s=Jr(l);let g=m?.outputPreferredLocations[n[t]];if("string"===s){if("gpu-buffer"===g||"ml-tensor"===g)throw new Error("String tensor is not supported on GPU.");let e=[];for(let t=0;t<x;t++){let a=i.getValue(u+t*o,"*"),n=i.getValue(u+(t+1)*o,"*"),r=t===x-1?void 0:n-a;e.push(i.UTF8ToString(a,r))}j.push([s,f,e,"cpu"])}else if("gpu-buffer"===g&&x>0){let e=i.jsepGetBuffer;if(!e)throw new Error('preferredLocation "gpu-buffer" is not supported without using WebGPU.');let t=e(u),n=es(l,x);if(void 0===n||!ns(s))throw new Error(`Unsupported data type: ${s}`);c=!0,j.push([s,f,{gpuBuffer:t,download:i.jsepCreateDownloader(t,n,s),dispose:()=>{0!==i._OrtReleaseTensor(a)&&Ur("Can't release tensor.")}},"gpu-buffer"])}else if("ml-tensor"===g&&x>0){let t=i.webnnEnsureTensor,n=i.webnnIsGraphInputOutputTypeSupported;if(!t||!n)throw new Error('preferredLocation "ml-tensor" is not supported without using WebNN.');if(void 0===es(l,x)||!rs(s))throw new Error(`Unsupported data type: ${s}`);if(!n(e,s,!1))throw new Error(`preferredLocation "ml-tensor" for ${s} output is not supported by current WebNN Context.`);let r=await t(e,u,l,f,!1);c=!0,j.push([s,f,{mlTensor:r,download:i.webnnCreateMLTensorDownloader(u,s),dispose:()=>{i.webnnReleaseTensorId(u),i._OrtReleaseTensor(a)}},"ml-tensor"])}else if("ml-tensor-cpu-output"===g&&x>0){let e=i.webnnCreateMLTensorDownloader(u,s)(),t=j.length;c=!0,C.push((async()=>{let n=[t,await e];return i.webnnReleaseTensorId(u),i._OrtReleaseTensor(a),n})()),j.push([s,f,[],"cpu"])}else{let e=new(ts(s))(x);new Uint8Array(e.buffer,e.byteOffset,e.byteLength).set(i.HEAPU8.subarray(u,u+e.byteLength)),j.push([s,f,e,"cpu"])}}finally{i.stackRestore(l),"string"===s&&u&&i._free(u),c||i._OrtReleaseTensor(a)}}m&&!p&&(0!==i._OrtClearBoundOutputs(m.handle)&&Ur("Can't clear bound outputs."),Sh.set(e,[d,c,u,m,p,!1]));for(let[e,t]of await Promise.all(C))j[e][2]=t;return An("wasm ProcessOutputTensor"),j}finally{i.webnnOnRunEnd?.(d),i.stackRestore(j),y.forEach(e=>i._OrtReleaseTensor(e)),v.forEach(e=>i._OrtReleaseTensor(e)),w.forEach(e=>i._free(e)),0!==g&&i._OrtReleaseRunOptions(g),b.forEach(e=>i._free(e))}},Rh=e=>{let t=Lr(),a=Sh.get(e);if(!a)throw new Error("invalid session id");let n=a[0],r=t._OrtEndProfiling(n);0===r&&Ur("Can't get an profile file name."),t._OrtFree(r)},Vh=e=>{let t=[];for(let a of e){let e=a[2];!Array.isArray(e)&&"buffer"in e&&t.push(e.buffer)}return t}}),lf=Ln(()=>{lr(),of(),ep(),Jm(),Ph=()=>!!un.wasm.proxy&&typeof document<"u",Bh=!1,Lh=!1,Fh=!1,qh=new Map,Hh=(e,t)=>{let a=qh.get(e);a?a.push(t):qh.set(e,[t])},Gh=()=>{if(Bh||!Lh||Fh||!Dh)throw new Error("worker not ready")},Kh=e=>{switch(e.data.type){case"init-wasm":Bh=!1,e.data.err?(Fh=!0,Uh[1](e.data.err)):(Lh=!0,Uh[0]()),Wh&&(URL.revokeObjectURL(Wh),Wh=void 0);break;case"init-ep":case"copy-from":case"create":case"release":case"run":case"end-profiling":{let t=qh.get(e.data.type);e.data.err?t.shift()[1](e.data.err):t.shift()[0](e.data.out);break}}},Xh=async()=>{if(!Lh){if(Bh)throw new Error("multiple calls to 'initWasm()' detected.");if(Fh)throw new Error("previous call to 'initWasm()' failed.");if(Bh=!0,Ph())return new Promise((e,t)=>{Dh?.terminate(),zr().then(([a,n])=>{try{(Dh=n).onerror=e=>t(e),Dh.onmessage=Kh,Uh=[e,t];let r={type:"init-wasm",in:un};!r.in.wasm.wasmPaths&&(a||vr)&&(r.in.wasm.wasmPaths={wasm:new URL("/DEViLBOX/assets/ort-wasm-simd-threaded.jsep-BGTZ4Y7F.wasm",import.meta.url).href}),Dh.postMessage(r),Wh=a}catch(r){t(r)}},t)});try{await Br(un.wasm),await $h(un),Lh=!0}catch(tn){throw Fh=!0,tn}finally{Bh=!1}}},Yh=async e=>{if(Ph())return Gh(),new Promise((t,a)=>{Hh("init-ep",[t,a]);let n={type:"init-ep",in:{epName:e,env:un}};Dh.postMessage(n)});await Ch(un,e)},Zh=async e=>Ph()?(Gh(),new Promise((t,a)=>{Hh("copy-from",[t,a]);let n={type:"copy-from",in:{buffer:e}};Dh.postMessage(n,[e.buffer])})):Th(e),Qh=async(e,t)=>{if(Ph()){if(t?.preferredOutputLocation)throw new Error('session option "preferredOutputLocation" is not supported for proxy.');return Gh(),new Promise((a,n)=>{Hh("create",[a,n]);let r={type:"create",in:{model:e,options:{...t}}},s=[];e instanceof Uint8Array&&s.push(e.buffer),Dh.postMessage(r,s)})}return Eh(e,t)},Jh=async e=>{if(Ph())return Gh(),new Promise((t,a)=>{Hh("release",[t,a]);let n={type:"release",in:e};Dh.postMessage(n)});Ah(e)},ef=async(e,t,a,n,r,s)=>{if(Ph()){if(a.some(e=>"cpu"!==e[3]))throw new Error("input tensor on GPU is not supported for proxy.");if(r.some(e=>e))throw new Error("pre-allocated output tensor is not supported for proxy.");return Gh(),new Promise((r,i)=>{Hh("run",[r,i]);let o=a,l={type:"run",in:{sessionId:e,inputIndices:t,inputs:o,outputIndices:n,options:s}};Dh.postMessage(l,Vh(o))})}return Oh(e,t,a,n,r,s)},tf=async e=>{if(Ph())return Gh(),new Promise((t,a)=>{Hh("end-profiling",[t,a]);let n={type:"end-profiling",in:e};Dh.postMessage(n)});Rh(e)}}),df=Ln(()=>{lr(),lf(),rp(),dr(),sp(),af=(e,t)=>{switch(e.location){case"cpu":return[e.type,e.dims,e.data,"cpu"];case"gpu-buffer":return[e.type,e.dims,{gpuBuffer:e.gpuBuffer},"gpu-buffer"];case"ml-tensor":return[e.type,e.dims,{mlTensor:e.mlTensor},"ml-tensor"];default:throw new Error(`invalid data location: ${e.location} for ${t()}`)}},nf=e=>{switch(e[3]){case"cpu":return new Cn(e[0],e[2],e[1]);case"gpu-buffer":{let t=e[0];if(!ns(t))throw new Error(`not supported data type: ${t} for deserializing GPU tensor`);let{gpuBuffer:a,download:n,dispose:r}=e[2];return Cn.fromGpuBuffer(a,{dataType:t,dims:e[1],download:n,dispose:r})}case"ml-tensor":{let t=e[0];if(!rs(t))throw new Error(`not supported data type: ${t} for deserializing MLTensor tensor`);let{mlTensor:a,download:n,dispose:r}=e[2];return Cn.fromMLTensor(a,{dataType:t,dims:e[1],download:n,dispose:r})}default:throw new Error(`invalid data location: ${e[3]}`)}},rf=class{async fetchModelAndCopyToWasmMemory(e){return Zh(await is(e))}async loadModel(e,t){let a;zn(),a="string"==typeof e?await this.fetchModelAndCopyToWasmMemory(e):e,[this.sessionId,this.inputNames,this.outputNames,this.inputMetadata,this.outputMetadata]=await Qh(a,t),Tn()}async dispose(){return Jh(this.sessionId)}async run(e,t,a){zn();let n=[],r=[];Object.entries(e).forEach(e=>{let t=e[0],a=e[1],s=this.inputNames.indexOf(t);if(-1===s)throw new Error(`invalid input '${t}'`);n.push(a),r.push(s)});let s=[],i=[];Object.entries(t).forEach(e=>{let t=e[0],a=e[1],n=this.outputNames.indexOf(t);if(-1===n)throw new Error(`invalid output '${t}'`);s.push(a),i.push(n)});let o=n.map((e,t)=>af(e,()=>`input "${this.inputNames[r[t]]}"`)),l=s.map((e,t)=>e?af(e,()=>`output "${this.outputNames[i[t]]}"`):null),d=await ef(this.sessionId,r,o,i,l,a),c={};for(let u=0;u<d.length;u++)c[this.outputNames[i[u]]]=s[u]??nf(d[u]);return Tn(),c}startProfiling(){}endProfiling(){tf(this.sessionId)}}}),cf={};Fn(cf,{OnnxruntimeWebAssemblyBackend:()=>mf,initializeFlags:()=>uf,wasmBackend:()=>pf});var uf,mf,pf,hf=Ln(()=>{lr(),lf(),df(),uf=()=>{("number"!=typeof un.wasm.initTimeout||un.wasm.initTimeout<0)&&(un.wasm.initTimeout=0);let e=un.wasm.simd;if("boolean"!=typeof e&&void 0!==e&&"fixed"!==e&&"relaxed"!==e&&(un.wasm.simd=!1),"boolean"!=typeof un.wasm.proxy&&(un.wasm.proxy=!1),"boolean"!=typeof un.wasm.trace&&(un.wasm.trace=!1),"number"!=typeof un.wasm.numThreads||!Number.isInteger(un.wasm.numThreads)||un.wasm.numThreads<=0)if(typeof self<"u"&&!self.crossOriginIsolated)un.wasm.numThreads=1;else{let e=typeof navigator>"u"?Bn("node:os").cpus().length:navigator.hardwareConcurrency;un.wasm.numThreads=Math.min(4,Math.ceil((e||1)/2))}},pf=new(mf=class{async init(e){uf(),await Xh(),await Yh(e)}async createInferenceSessionHandler(e,t){let a=new rf;return await a.loadModel(e,t),a}})});lr(),lr(),lr();{let e=(hf(),Wn(cf)).wasmBackend;rn("webgpu",e,5),rn("webnn",e,5),rn("cpu",e,10),rn("wasm",e,10)}Object.defineProperty(un.versions,"web",{value:"1.23.2",enumerable:!0});const ff={executionProviders:["webgpu","wasm"],graphOptimizationLevel:"all"};let xf=null;async function gf(e,t){const a=Math.max(e.sampleRate,44100);try{const t=await async function(){if(xf)return xf;try{const e="/DEViLBOX/models/enhancement/resurrect.onnx";return xf=await On.create(e,ff),xf}catch(e){throw e}}(),n=e.getChannelData(0),r={input:new Cn("float32",n,[1,1,n.length])},s=(await t.run(r)).output.data,i=s instanceof Float32Array?s:new Float32Array(s),o=new AudioBuffer({length:i.length,numberOfChannels:1,sampleRate:a});o.copyToChannel(i,0);return{buffer:o,dataUrl:await Ja(o)}}catch(n){const a=await async function(e,t){const a=44100,n=Math.ceil(e.duration*a),r=new OfflineAudioContext(1,n,a),s=r.createBufferSource();s.buffer=e;const i=r.createBiquadFilter();i.type="highpass",i.frequency.value=4e3;const o=r.createWaveShaper();o.curve=bf(.4);const l=r.createBiquadFilter();l.type="highpass",l.frequency.value=8e3;const d=r.createWaveShaper();d.curve=bf(.7);const c=r.createGain();c.gain.value=.12*t.strength;const u=r.createGain();u.gain.value=.08*t.strength;const m=r.createGain();return m.gain.value=1,s.connect(m),m.connect(r.destination),s.connect(i),i.connect(o),o.connect(c),c.connect(r.destination),s.connect(l),l.connect(d),d.connect(u),u.connect(r.destination),s.start(0),await r.startRendering()}(e,t);return{buffer:a,dataUrl:await Ja(a)}}}function bf(e){const t=4096,a=new Float32Array(t);for(let n=0;n<t;n++){const r=2*n/t-1;a[n]=r+(Math.pow(r,3)-r)*e}return a}const yf=({audioBuffer:e,onBufferProcessed:a,isLoading:n})=>{const[r,i]=he.useState(!1),[o,l]=he.useState(40),[d,c]=he.useState(30),[u,m]=he.useState(4e3),[p,h]=he.useState(-60),[f,x]=he.useState(20),[g,b]=he.useState(30),y=he.useCallback(async t=>{if(e){i(!0);try{let n;switch(await new Promise(e=>setTimeout(e,50)),t){case"exciter":n=await async function(e,t){const{drive:a,mix:n,frequency:r}=t,s=Math.max(e.sampleRate,44100),i=Math.ceil(e.duration*s),o=new OfflineAudioContext(e.numberOfChannels,i,s),l=o.createBufferSource();l.buffer=e;const d=o.createBiquadFilter();d.type="highpass",d.frequency.value=r,d.Q.value=.707;const c=o.createWaveShaper(),u=8192,m=new Float32Array(u),p=a/5;for(let y=0;y<u;y++){const e=2*y/u-1;m[y]=(1+p)*e/(1+p*Math.abs(e))}c.curve=m;const h=o.createBiquadFilter();h.type="highshelf",h.frequency.value=8e3,h.gain.value=4;const f=o.createGain(),x=n/100;f.gain.value=x;const g=o.createGain();g.gain.value=Math.sqrt(1-x),l.connect(g),g.connect(o.destination),l.connect(d),d.connect(c),c.connect(h),h.connect(f),f.connect(o.destination),l.start(0);const b=await o.startRendering();return{buffer:b,dataUrl:await Ja(b)}}(e,{drive:o,mix:d,frequency:u});break;case"denoise":n=await async function(e,t){const a=new OfflineAudioContext(e.numberOfChannels,e.length,e.sampleRate),n=a.createBufferSource();n.buffer=e;const r=a.createWaveShaper(),s=8192,i=new Float32Array(s),o=Math.pow(10,t/20),l=.2*o;for(let c=0;c<s;c++){const e=2*c/s-1,t=Math.abs(e),a=e<0?-1:1;if(t<o-l)i[c]=0;else if(t<o+l){const n=(t-(o-l))/(2*l);i[c]=a*e*(n*n)}else i[c]=e}r.curve=i,n.connect(r),r.connect(a.destination),n.start(0);const d=await a.startRendering();return{buffer:d,dataUrl:await Ja(d)}}(e,p);break;case"stereo":n=await async function(e,t){const a=new OfflineAudioContext(2,e.length,e.sampleRate),n=a.createBufferSource();n.buffer=e;const r=a.createGain(),s=a.createGain(),i=a.createDelay(.1);i.delayTime.value=.01+t/100*.025,n.connect(r),r.connect(a.destination),n.connect(i),i.connect(s),s.connect(a.destination),n.start(0);const o=await a.startRendering();return{buffer:o,dataUrl:await Ja(o)}}(e,f);break;case"punch":n=await async function(e,t){const a=new OfflineAudioContext(e.numberOfChannels,e.length,e.sampleRate),n=a.createBufferSource();n.buffer=e;const r=a.createBiquadFilter();r.type="highpass",r.frequency.value=3e3,r.Q.value=1.5;const s=a.createGain();s.gain.value=t/100*1.5;const i=a.createGain();i.gain.value=1,n.connect(i),i.connect(a.destination),n.connect(r),r.connect(s),s.connect(a.destination),n.start(0);const o=await a.startRendering();return{buffer:o,dataUrl:await Ja(o)}}(e,g);break;case"neural":n=await gf(e,{modelType:"resurrect",strength:1});break;case"normalize":n=await async function(e){const t=e.numberOfChannels,a=e.length;let n=0;for(let d=0;d<t;d++){const t=e.getChannelData(d);for(let e=0;e<a;e++){const a=Math.abs(t[e]);a>n&&(n=a)}}if(0===n)return{buffer:e,dataUrl:await Ja(e)};const r=.99/n,s=new OfflineAudioContext(t,a,e.sampleRate),i=s.createBufferSource();i.buffer=e;const o=s.createGain();o.gain.value=r,i.connect(o),o.connect(s.destination),i.start(0);const l=await s.startRendering();return{buffer:l,dataUrl:await Ja(l)}}(e);break;case"trim":n=await async function(e,t=-60){const a=e.numberOfChannels,n=e.length,r=Math.pow(10,t/20);let s=n,i=0;for(let u=0;u<a;u++){const t=e.getChannelData(u);let a=0;for(;a<n&&Math.abs(t[a])<r;)a++;a<s&&(s=a);let o=n-1;for(;o>0&&Math.abs(t[o])<r;)o--;o>i&&(i=o)}const o=i-s+1;if(o<=0)return{buffer:e,dataUrl:await Ja(e)};const l=new OfflineAudioContext(a,o,e.sampleRate),d=l.createBufferSource();d.buffer=e,d.connect(l.destination),d.start(0,s/e.sampleRate);const c=await l.startRendering();return{buffer:c,dataUrl:await Ja(c)}}(e);break;case"reverse":n=await async function(e){const t=e.numberOfChannels,a=e.length,n=new AudioBuffer({length:a,numberOfChannels:t,sampleRate:e.sampleRate});for(let r=0;r<t;r++){const t=e.getChannelData(r),s=n.getChannelData(r);for(let e=0;e<a;e++)s[e]=t[a-1-e]}return{buffer:n,dataUrl:await Ja(n)}}(e);break;default:return}a(n),D.success(`Sample processed: ${t.toUpperCase()}`)}catch(n){D.error("Processing failed")}finally{i(!1)}}},[e,o,d,u,p,f,g,a]);return t.jsxs("div",{className:"bg-dark-bgSecondary border border-dark-border rounded-lg overflow-hidden mb-4",children:[t.jsxs("div",{className:"bg-accent-primary/10 border-b border-dark-border px-4 py-2 flex items-center justify-between",children:[t.jsxs("h4",{className:"font-mono text-xs font-bold text-accent-primary flex items-center gap-2",children:[t.jsx(Qe,{size:12}),"ENHANCEMENT ENGINE"]}),r&&t.jsxs("div",{className:"flex items-center gap-2 text-[10px] text-accent-primary animate-pulse",children:[t.jsx(Je,{size:10,className:"animate-spin"}),"PROCESSING..."]})]}),t.jsxs("div",{className:"p-4 grid grid-cols-1 md:grid-cols-3 gap-6",children:[t.jsxs("div",{className:"space-y-6",children:[t.jsxs("div",{className:"space-y-3",children:[t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx(Se,{size:14,className:"text-yellow-400"}),t.jsx("span",{className:"text-[10px] font-bold text-text-muted uppercase tracking-wider",children:"Harmonic Exciter"})]}),t.jsxs("div",{className:"grid grid-cols-3 gap-2",children:[t.jsx(I,{label:"DRIVE",value:o,min:0,max:100,onChange:l,size:"sm",color:"var(--color-accent)"}),t.jsx(I,{label:"FREQ",value:u,min:2e3,max:1e4,unit:"Hz",onChange:m,size:"sm",color:"var(--color-accent-secondary)"}),t.jsx(I,{label:"MIX",value:d,min:0,max:100,unit:"%",onChange:c,size:"sm",color:"#10b981"})]}),t.jsx(s,{variant:"primary",size:"sm",fullWidth:!0,onClick:()=>y("exciter"),disabled:r||n,icon:t.jsx(Fe,{size:12}),children:"Apply Exciter"})]}),t.jsxs("div",{className:"space-y-3 pt-4 border-t border-dark-border/50",children:[t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx(et,{size:14,className:"text-cyan-400"}),t.jsx("span",{className:"text-[10px] font-bold text-text-muted uppercase tracking-wider",children:"Quantization Denoise"})]}),t.jsx(I,{label:"THRESH",value:p,min:-100,max:-20,unit:"dB",onChange:h,size:"sm",color:"var(--color-synth-modulation)"}),t.jsx(s,{variant:"default",size:"sm",fullWidth:!0,onClick:()=>y("denoise"),disabled:r||n,icon:t.jsx(et,{size:12}),children:"Clean 8-bit Noise"})]})]}),t.jsxs("div",{className:"space-y-6",children:[t.jsxs("div",{className:"space-y-3",children:[t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx(tt,{size:14,className:"text-orange-400"}),t.jsx("span",{className:"text-[10px] font-bold text-text-muted uppercase tracking-wider",children:"Transient Punch"})]}),t.jsx(I,{label:"PUNCH",value:g,min:0,max:100,onChange:b,size:"sm",color:"var(--color-accent)"}),t.jsx(s,{variant:"default",size:"sm",fullWidth:!0,onClick:()=>y("punch"),disabled:r||n,icon:t.jsx(tt,{size:12}),children:"Sharpen Attacks"})]}),t.jsxs("div",{className:"space-y-3 pt-4 border-t border-dark-border/50",children:[t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx(at,{size:14,className:"text-blue-400"}),t.jsx("span",{className:"text-[10px] font-bold text-text-muted uppercase tracking-wider",children:"Pseudo Stereo"})]}),t.jsx(I,{label:"WIDTH",value:f,min:0,max:100,onChange:x,size:"sm",color:"var(--color-synth-pan)"}),t.jsx(s,{variant:"default",size:"sm",fullWidth:!0,onClick:()=>y("stereo"),disabled:r||n,icon:t.jsx(at,{size:12}),children:"Make Stereo"})]})]}),t.jsxs("div",{className:"space-y-6",children:[t.jsxs("div",{className:"space-y-3",children:[t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx(Ge,{size:14,className:"text-green-400"}),t.jsx("span",{className:"text-[10px] font-bold text-text-muted uppercase tracking-wider",children:"Basic Editing"})]}),t.jsxs("div",{className:"grid grid-cols-1 gap-2",children:[t.jsx(s,{variant:"default",size:"sm",fullWidth:!0,onClick:()=>y("normalize"),disabled:r||n,icon:t.jsx(Ge,{size:12}),children:"Normalize (0dB Peak)"}),t.jsx(s,{variant:"default",size:"sm",fullWidth:!0,onClick:()=>y("trim"),disabled:r||n,icon:t.jsx(nt,{size:12}),children:"Trim Silence"}),t.jsx(s,{variant:"default",size:"sm",fullWidth:!0,onClick:()=>y("reverse"),disabled:r||n,icon:t.jsx(Pe,{size:12}),children:"Destructive Reverse"})]})]}),t.jsx("div",{className:"p-3 bg-dark-bg border border-dark-border rounded text-[9px] text-text-muted font-mono leading-tight",children:"NOTE: These edits permanently modify the sample buffer. Use Normalize after Exciter to avoid clipping."})]}),t.jsxs("div",{className:"md:col-span-3 pt-4 border-t border-dark-border space-y-3",children:[t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx(Qe,{size:14,className:"text-violet-400"}),t.jsx("span",{className:"text-[10px] font-bold text-text-muted uppercase tracking-wider",children:"Tier 1: Neural Super-Res (BEST)"})]}),t.jsxs("div",{className:"flex flex-col md:flex-row items-center gap-4",children:[t.jsx("div",{className:"flex-1",children:t.jsxs("p",{className:"text-[10px] text-text-muted leading-relaxed",children:["Uses Deep Learning to hallucinate missing high frequencies and remove 8-bit noise.",t.jsx("span",{className:"text-violet-400 block mt-1 font-bold",children:"WebGPU Acceleration Enabled"})]})}),t.jsx("div",{className:"w-full md:w-48",children:t.jsx(s,{variant:"ft2",size:"sm",fullWidth:!0,onClick:()=>y("neural"),disabled:r||n,icon:t.jsx(Qe,{size:12}),children:"AI Resurrect"})})]}),t.jsx("div",{className:"p-2 bg-dark-bg border border-dark-border rounded text-[9px] text-text-muted font-mono leading-tight",children:"PRO TIP: Chain these tools! Denoise first, then AI Resurrect, then add Stereo Width."})]})]})]})},vf=["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"],wf=[1,2,3,4,5,6,7],jf=({instrument:e,onChange:a})=>{const{updateInstrument:n,reverseSample:r,normalizeSample:s,invertLoopSample:i}=T(),o=he.useCallback((e,t)=>{a?a(t):n(e,t)},[a,n]),l=he.useRef(null),d=he.useRef(null),c=he.useRef(null),u=he.useRef(null),m=he.useRef(null),[p,h]=he.useState(null),[f,x]=he.useState(!1),[g,b]=he.useState(!1),[y,v]=he.useState(!1),[w,j]=he.useState(null),[k,N]=he.useState(1),[$,C]=he.useState(0),[S,M]=he.useState(!1),z=e.parameters?.sampleUrl||e.granular?.sampleUrl||null,E=e.parameters?.sampleInfo||null,A=e.parameters?.startTime??0,I=e.parameters?.endTime??1,O=e.parameters?.loopEnabled??!1,R=e.parameters?.loopStart??0,V=e.parameters?.loopEnd??1,P=e.parameters?.baseNote??"C4",B=e.parameters?.playbackRate??1,L=e.parameters?.reverse??!1,F=e.granular,W="GranularSynth"===e.synthType;he.useEffect(()=>{if(!z)return void h(null);return(async()=>{b(!0);try{const t=await fetch(z),a=await t.arrayBuffer(),n=new(window.AudioContext||window.webkitAudioContext),r=await n.decodeAudioData(a);h(r),E||o(e.id,{parameters:{...e.parameters,sampleInfo:{name:"Sample",duration:r.duration,size:a.byteLength,sampleRate:r.sampleRate,channels:r.numberOfChannels}}}),u.current&&u.current.dispose(),u.current=new Ot(z).toDestination()}catch(t){j("Failed to load audio file")}finally{b(!1)}})(),()=>{u.current&&(u.current.dispose(),u.current=null),m.current&&cancelAnimationFrame(m.current)}},[z]),he.useEffect(()=>{const e=d.current;if(!e)return;const t=e.getContext("2d");if(!t)return;const a=window.devicePixelRatio||1,n=1120;e.width!==n*a&&(e.width=n*a,e.height=300*a,t.scale(a,a));const r=n,s=300,i=150;t.fillStyle="#0f0c0c",t.fillRect(0,0,r,s),t.strokeStyle="#1d1818",t.lineWidth=1;for(let d=1;d<4;d++)t.beginPath(),t.moveTo(0,75*d),t.lineTo(r,75*d),t.stroke();if(t.strokeStyle="#2f2525",t.beginPath(),t.moveTo(0,i),t.lineTo(r,i),t.stroke(),!p)return t.fillStyle="#888080",t.font='bold 24px "JetBrains Mono", "Consolas", monospace',t.textAlign="center",t.fillText("Drop audio file here or click to upload",560,135),t.fillStyle="#585050",t.font='18px "JetBrains Mono", "Consolas", monospace',void t.fillText("WAV, MP3, OGG, FLAC supported",560,175);const o=p.getChannelData(0),l=o.length,c=Math.floor(l/k)/r;t.strokeStyle="#ef4444",t.lineWidth=1,t.beginPath();for(let d=0;d<r;d++){const e=Math.floor(d*c),a=Math.floor((d+1)*c);let n=1,r=-1;for(let t=e;t<a&&t<l;t++){const e=o[t];e<n&&(n=e),e>r&&(r=e)}const s=i-n*i*.85,u=i-r*i*.85;0===d&&t.moveTo(d,s),t.lineTo(d,s),t.lineTo(d,u)}t.stroke();const u=A*r,m=I*r;if(t.fillStyle="rgba(0, 0, 0, 0.6)",t.fillRect(0,0,u,s),t.fillRect(m,0,r-m,s),t.strokeStyle="#10b981",t.lineWidth=2,t.beginPath(),t.moveTo(u,0),t.lineTo(u,s),t.stroke(),t.fillStyle="#10b981",t.font="10px sans-serif",t.fillText("S",u+3,12),t.strokeStyle="#f97316",t.lineWidth=2,t.beginPath(),t.moveTo(m,0),t.lineTo(m,s),t.stroke(),t.fillStyle="#f97316",t.fillText("E",m-10,12),O){const e=R*r,a=V*r;t.fillStyle="rgba(59, 130, 246, 0.15)",t.fillRect(e,0,a-e,s),t.strokeStyle="#3b82f6",t.lineWidth=1,t.setLineDash([4,4]),t.beginPath(),t.moveTo(e,0),t.lineTo(e,s),t.moveTo(a,0),t.lineTo(a,s),t.stroke(),t.setLineDash([])}if(W&&F){const e=F.scanPosition/100*r;t.strokeStyle="#a855f7",t.lineWidth=3,t.beginPath(),t.moveTo(e,0),t.lineTo(e,s),t.stroke(),t.fillStyle="#a855f7",t.font="10px sans-serif",t.fillText("G",e+3,296)}if(f&&$>0){const e=$*r;t.strokeStyle="#fbbf24",t.lineWidth=2,t.beginPath(),t.moveTo(e,0),t.lineTo(e,s),t.stroke()}},[p,k,A,I,O,R,V,f,$,W,F]);const U=he.useCallback((t,a)=>{o(e.id,{parameters:{...e.parameters,[t]:a}})},[e.id,e.parameters,o]),q=he.useCallback((t,a)=>{o(e.id,{granular:{..._,...e.granular,[t]:a}})},[e.id,e.granular,o]),H=he.useCallback(async t=>{if(t.type.startsWith("audio/")||t.name.match(/\.(wav|mp3|ogg|flac|webm)$/i))if(t.size>15728640)j("File too large. Maximum size is 15MB.");else{b(!0),j(null);try{const a=await new Promise((e,a)=>{const n=new FileReader;n.onload=()=>e(n.result),n.onerror=a,n.readAsDataURL(t)}),n=await new Promise((e,t)=>{const n=new Audio;n.onloadedmetadata=()=>e(n.duration),n.onerror=t,n.src=a}),r={parameters:{...e.parameters,sampleUrl:a,sampleInfo:{name:t.name,duration:n,size:t.size},startTime:0,endTime:1,loopStart:0,loopEnd:1}};W&&(r.granular={..._,...e.granular,sampleUrl:a}),o(e.id,r)}catch(a){j("Failed to load audio file")}finally{b(!1)}}else j("Invalid file type. Please upload an audio file.")},[e,o,W]);return t.jsxs("div",{className:"space-y-4",children:[t.jsxs("div",{className:"flex items-center justify-between",children:[t.jsxs("h3",{className:"font-mono text-text-primary text-sm font-bold flex items-center gap-2",children:[W?t.jsx(Qe,{size:16,className:"text-violet-400"}):t.jsx(ve,{size:16,className:"text-accent-primary"}),W?"GRANULAR SAMPLE":"SAMPLE"]}),t.jsxs("div",{className:"flex items-center gap-2",children:[p&&t.jsxs("button",{onClick:()=>M(!S),className:"flex items-center gap-1.5 px-2 py-1 rounded text-[10px] font-bold uppercase transition-colors "+(S?"bg-accent-primary text-text-inverse":"bg-accent-primary/10 text-accent-primary border border-accent-primary/30 hover:bg-accent-primary/20"),children:[t.jsx(Fe,{size:12}),S?"Hide Enhancer":"Enhance"]}),E&&t.jsx("span",{className:"text-xs text-text-muted font-mono truncate max-w-[180px]",children:E.name})]})]}),S&&p&&t.jsx(yf,{audioBuffer:p,isLoading:g,onBufferProcessed:async t=>{const{buffer:a,dataUrl:n}=t;h(a),o(e.id,{parameters:{...e.parameters,sampleUrl:n,sampleInfo:{name:E?.name?E.name.startsWith("Enhanced_")?E.name:`Enhanced_${E.name}`:"Enhanced Sample",duration:a.duration,size:Math.round(3*n.split(",")[1].length/4),sampleRate:a.sampleRate,channels:a.numberOfChannels}}})}}),w&&t.jsxs("div",{className:"flex items-center gap-2 p-3 bg-accent-error/20 border border-accent-error/40 rounded text-accent-error text-sm",children:[t.jsx(rt,{size:16}),w]}),t.jsxs("div",{ref:c,className:`relative rounded-lg overflow-hidden border-2 transition-colors ${y?"border-accent-primary border-dashed bg-accent-primary/10":"border-dark-border"} ${p?"":"cursor-pointer hover:border-accent-primary/50"}`,onDragOver:e=>{e.preventDefault(),v(!0)},onDragLeave:()=>{v(!1)},onDrop:e=>{e.preventDefault(),v(!1);const t=e.dataTransfer.files[0];t&&H(t)},onClick:()=>!p&&l.current?.click(),children:[t.jsx("canvas",{ref:d,width:1120,height:300,className:"w-full h-[150px] cursor-crosshair",style:{imageRendering:"pixelated"},onClick:e=>{if(e.stopPropagation(),!p)return void l.current?.click();const t=d.current;if(!t)return;const a=t.getBoundingClientRect(),n=(e.clientX-a.left)/a.width;e.shiftKey?U("endTime",Math.max(n,A+.01)):e.altKey&&O?e.ctrlKey||e.metaKey?U("loopEnd",Math.max(n,R+.01)):U("loopStart",Math.min(n,V-.01)):W&&e.ctrlKey?q("scanPosition",100*n):U("startTime",Math.min(n,I-.01))}}),g&&t.jsx("div",{className:"absolute inset-0 bg-dark-bg/80 flex items-center justify-center",children:t.jsx("div",{className:"animate-spin w-8 h-8 border-2 border-accent-primary border-t-transparent rounded-full"})}),y&&t.jsx("div",{className:"absolute inset-0 bg-accent-primary/20 flex items-center justify-center",children:t.jsx(st,{size:32,className:"text-accent-primary animate-bounce"})})]}),t.jsx("input",{ref:l,type:"file",accept:"audio/*,.wav,.mp3,.ogg,.flac,.webm",onChange:e=>{const t=e.target.files?.[0];t&&H(t),l.current&&(l.current.value="")},className:"hidden"}),p&&E&&t.jsxs(t.Fragment,{children:[t.jsxs("div",{className:"flex items-center justify-between text-xs font-mono text-text-muted",children:[t.jsxs("span",{children:["Duration: ",(K=E.duration,`${Math.floor(K/60)}:${(K%60).toFixed(2).padStart(5,"0")}`)]}),t.jsxs("span",{children:["Size: ",(G=E.size,G<1024?`${G} B`:G<1048576?`${(G/1024).toFixed(1)} KB`:`${(G/1048576).toFixed(2)} MB`)]}),t.jsxs("span",{children:[E.sampleRate?`${(E.sampleRate/1e3).toFixed(1)}kHz`:"",1===E.channels?" Mono":2===E.channels?" Stereo":""]})]}),t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsxs("button",{onClick:()=>l.current?.click(),className:"flex items-center gap-2 px-3 py-2 bg-accent-primary/20 text-accent-primary rounded hover:bg-accent-primary/30 transition-colors text-sm",children:[t.jsx(st,{size:14}),"Replace"]}),t.jsx("button",{onClick:async()=>{if(!u.current||!p)return;if(await Rt(),f)return u.current.stop(),x(!1),C(0),void(m.current&&cancelAnimationFrame(m.current));u.current.playbackRate=B,u.current.reverse=L;const e=A*p.duration,t=(I-A)*p.duration;u.current.start(Vt(),e,t),x(!0);const a=Vt(),n=()=>{const e=Vt()-a,t=A+e/p.duration*(I-A)/B;if(t>=I)return x(!1),void C(0);C(t),m.current=requestAnimationFrame(n)};n()},className:"p-2 rounded transition-colors "+(f?"bg-accent-error/20 text-accent-error":"bg-accent-success/20 text-accent-success"),title:f?"Stop":"Play preview",children:f?t.jsx(it,{size:16}):t.jsx(ot,{size:16})}),t.jsx("button",{onClick:()=>{f&&(u.current?.stop(),x(!1)),h(null),o(e.id,{parameters:{...e.parameters,sampleUrl:null,sampleInfo:null},...W?{granular:{..._,...e.granular,sampleUrl:""}}:{}})},className:"p-2 bg-accent-error/20 text-accent-error rounded hover:bg-accent-error/30 transition-colors",title:"Remove sample",children:t.jsx(We,{size:16})}),t.jsx("div",{className:"flex-1"}),t.jsxs("div",{className:"flex items-center gap-1 bg-dark-bgSecondary p-1 rounded-lg border border-dark-border",children:[t.jsx("button",{onClick:async()=>{b(!0);try{await r(e.id),D.success("Sample reversed destructively")}catch(tn){D.error("Failed to reverse sample")}finally{b(!1)}},className:"p-1.5 hover:bg-white/10 rounded transition-colors text-text-secondary",title:"Reverse Buffer (Destructive)",children:t.jsx(lt,{size:14,className:"-scale-x-100"})}),t.jsx("button",{onClick:async()=>{b(!0);try{await s(e.id),D.success("Sample normalized")}catch(tn){D.error("Failed to normalize sample")}finally{b(!1)}},className:"p-1.5 hover:bg-white/10 rounded transition-colors text-text-secondary",title:"Normalize Buffer (Destructive)",children:t.jsx(dt,{size:14})}),t.jsx("button",{onClick:async()=>{b(!0);try{await i(e.id),D.success("Loop area inverted (Funk Repeat)")}catch(tn){D.error("Failed to invert loop")}finally{b(!1)}},disabled:!O,className:"p-1.5 hover:bg-white/10 rounded transition-colors text-text-secondary disabled:opacity-30",title:"Invert Loop Phase (Destructive EFx)",children:t.jsx(ct,{size:14})})]}),t.jsx("button",{onClick:()=>N(Math.max(1,k/1.5)),disabled:k<=1,className:"p-2 bg-dark-bgTertiary text-text-secondary rounded hover:bg-dark-bgHover disabled:opacity-30",title:"Zoom out",children:t.jsx(ut,{size:14})}),t.jsxs("span",{className:"text-xs font-mono text-text-muted w-10 text-center",children:[k.toFixed(1),"x"]}),t.jsx("button",{onClick:()=>N(Math.min(16,1.5*k)),disabled:k>=16,className:"p-2 bg-dark-bgTertiary text-text-secondary rounded hover:bg-dark-bgHover disabled:opacity-30",title:"Zoom in",children:t.jsx(mt,{size:14})})]}),t.jsxs("div",{className:"panel p-4 rounded-lg space-y-4",children:["Sampler"===e.synthType&&t.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[t.jsxs("div",{children:[t.jsx("label",{className:"block font-mono text-text-muted text-xs mb-2",children:"BASE NOTE"}),t.jsxs("div",{className:"flex gap-1",children:[t.jsx("select",{value:P.replace(/\d/,""),onChange:e=>{const t=P.match(/\d/)?.[0]||"4";U("baseNote",e.target.value+t)},className:"input flex-1",children:vf.map(e=>t.jsx("option",{value:e,children:e},e))}),t.jsx("select",{value:P.match(/\d/)?.[0]||"4",onChange:e=>{const t=P.replace(/\d/,"");U("baseNote",t+e.target.value)},className:"input w-14",children:wf.map(e=>t.jsx("option",{value:e,children:e},e))})]})]}),t.jsxs("div",{children:[t.jsxs("label",{className:"block font-mono text-text-muted text-xs mb-2",children:["PLAYBACK: ",t.jsxs("span",{className:"text-accent-primary",children:[B.toFixed(2),"x"]})]}),t.jsx("input",{type:"range",min:"0.25",max:"4",step:"0.01",value:B,onChange:e=>U("playbackRate",parseFloat(e.target.value)),className:"w-full"})]})]}),t.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[t.jsxs("div",{children:[t.jsxs("label",{className:"block font-mono text-text-muted text-xs mb-2",children:["START: ",t.jsxs("span",{className:"text-accent-success",children:[(100*A).toFixed(1),"%"]})]}),t.jsx("input",{type:"range",min:"0",max:"0.99",step:"0.001",value:A,onChange:e=>U("startTime",Math.min(parseFloat(e.target.value),I-.01)),className:"w-full"})]}),t.jsxs("div",{children:[t.jsxs("label",{className:"block font-mono text-text-muted text-xs mb-2",children:["END: ",t.jsxs("span",{className:"text-accent-secondary",children:[(100*I).toFixed(1),"%"]})]}),t.jsx("input",{type:"range",min:"0.01",max:"1",step:"0.001",value:I,onChange:e=>U("endTime",Math.max(parseFloat(e.target.value),A+.01)),className:"w-full"})]})]}),t.jsx("div",{className:"flex items-center gap-4",children:t.jsxs("label",{className:"flex items-center gap-2 cursor-pointer",children:[t.jsx("input",{type:"checkbox",checked:L,onChange:e=>U("reverse",e.target.checked),className:"w-4 h-4 rounded"}),t.jsx("span",{className:"font-mono text-text-secondary text-xs",children:"REVERSE"})]})}),t.jsxs("div",{className:"border-t border-dark-border pt-4",children:[t.jsxs("label",{className:"flex items-center gap-2 cursor-pointer mb-3",children:[t.jsx("input",{type:"checkbox",checked:O,onChange:e=>U("loopEnabled",e.target.checked),className:"w-4 h-4 rounded"}),t.jsx(Re,{size:14,className:"text-blue-400"}),t.jsx("span",{className:"font-mono text-text-secondary text-xs",children:"ENABLE LOOP"})]}),O&&t.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[t.jsxs("div",{children:[t.jsxs("label",{className:"block font-mono text-text-muted text-xs mb-2",children:["LOOP START: ",t.jsxs("span",{className:"text-blue-400",children:[(100*R).toFixed(1),"%"]})]}),t.jsx("input",{type:"range",min:"0",max:"0.99",step:"0.001",value:R,onChange:e=>U("loopStart",Math.min(parseFloat(e.target.value),V-.01)),className:"w-full"})]}),t.jsxs("div",{children:[t.jsxs("label",{className:"block font-mono text-text-muted text-xs mb-2",children:["LOOP END: ",t.jsxs("span",{className:"text-blue-400",children:[(100*V).toFixed(1),"%"]})]}),t.jsx("input",{type:"range",min:"0.01",max:"1",step:"0.001",value:V,onChange:e=>U("loopEnd",Math.max(parseFloat(e.target.value),R+.01)),className:"w-full"})]})]})]}),W&&F&&t.jsxs("div",{className:"border-t border-dark-border pt-4 space-y-4",children:[t.jsxs("h4",{className:"font-mono text-violet-400 text-xs font-bold flex items-center gap-2",children:[t.jsx(Qe,{size:12}),"GRANULAR CONTROLS"]}),t.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[t.jsxs("div",{children:[t.jsxs("label",{className:"block font-mono text-text-muted text-xs mb-2",children:["GRAIN SIZE: ",t.jsxs("span",{className:"text-violet-400",children:[F.grainSize,"ms"]})]}),t.jsx("input",{type:"range",min:"10",max:"500",step:"1",value:F.grainSize,onChange:e=>q("grainSize",parseInt(e.target.value)),className:"w-full"})]}),t.jsxs("div",{children:[t.jsxs("label",{className:"block font-mono text-text-muted text-xs mb-2",children:["OVERLAP: ",t.jsxs("span",{className:"text-violet-400",children:[F.grainOverlap,"%"]})]}),t.jsx("input",{type:"range",min:"0",max:"100",step:"1",value:F.grainOverlap,onChange:e=>q("grainOverlap",parseInt(e.target.value)),className:"w-full"})]})]}),t.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[t.jsxs("div",{children:[t.jsxs("label",{className:"block font-mono text-text-muted text-xs mb-2",children:["SCAN POS: ",t.jsxs("span",{className:"text-violet-400",children:[F.scanPosition.toFixed(0),"%"]})]}),t.jsx("input",{type:"range",min:"0",max:"100",step:"0.1",value:F.scanPosition,onChange:e=>q("scanPosition",parseFloat(e.target.value)),className:"w-full"})]}),t.jsxs("div",{children:[t.jsxs("label",{className:"block font-mono text-text-muted text-xs mb-2",children:["SCAN SPEED: ",t.jsxs("span",{className:"text-violet-400",children:[F.scanSpeed,"%"]})]}),t.jsx("input",{type:"range",min:"-100",max:"100",step:"1",value:F.scanSpeed,onChange:e=>q("scanSpeed",parseInt(e.target.value)),className:"w-full"})]})]}),t.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[t.jsxs("div",{children:[t.jsxs("label",{className:"block font-mono text-text-muted text-xs mb-2",children:["DENSITY: ",t.jsx("span",{className:"text-violet-400",children:F.density})]}),t.jsx("input",{type:"range",min:"1",max:"16",step:"1",value:F.density,onChange:e=>q("density",parseInt(e.target.value)),className:"w-full"})]}),t.jsxs("div",{children:[t.jsxs("label",{className:"block font-mono text-text-muted text-xs mb-2",children:["PITCH RAND: ",t.jsxs("span",{className:"text-violet-400",children:[F.randomPitch,"%"]})]}),t.jsx("input",{type:"range",min:"0",max:"100",step:"1",value:F.randomPitch,onChange:e=>q("randomPitch",parseInt(e.target.value)),className:"w-full"})]})]}),t.jsx("div",{className:"flex items-center gap-4",children:t.jsxs("label",{className:"flex items-center gap-2 cursor-pointer",children:[t.jsx("input",{type:"checkbox",checked:F.reverse,onChange:e=>q("reverse",e.target.checked),className:"w-4 h-4 rounded"}),t.jsx("span",{className:"font-mono text-text-secondary text-xs",children:"REVERSE GRAINS"})]})})]})]}),t.jsxs("div",{className:"text-xs text-text-muted space-y-1",children:[t.jsxs("p",{children:[t.jsx("span",{className:"text-text-secondary",children:"Click"})," waveform = set start | ",t.jsx("span",{className:"text-text-secondary",children:"Shift+Click"})," = set end"]}),O&&t.jsxs("p",{children:[t.jsx("span",{className:"text-text-secondary",children:"Alt+Click"})," = loop start | ",t.jsx("span",{className:"text-text-secondary",children:"Alt+Ctrl+Click"})," = loop end"]}),W&&t.jsxs("p",{children:[t.jsx("span",{className:"text-text-secondary",children:"Ctrl+Click"})," = set granular scan position"]})]})]}),!p&&t.jsxs("div",{className:"text-center text-text-muted text-sm py-2",children:["Sampler"===e.synthType&&"Sampler maps the sample to C4 and pitches across the keyboard","Player"===e.synthType&&"Player plays the full sample as a one-shot or loop","GranularSynth"===e.synthType&&"Granular breaks the sample into tiny grains for texture and pads"]})]});var G,K},_f=({config:e,instrumentId:a,onChange:n})=>{const[r,s]=he.useState("main"),i=he.useRef(e);i.current=e;const o="cyan-lineart"===B(e=>e.currentThemeId),l=o?"#00ffff":"#ff4444",c=o?"#00ffff":"#ff8888",u=o?"bg-[#051515] border-cyan-900/50":"bg-[#1a1a1a] border-gray-800",m=e=>{n({oscillator:{...i.current.oscillator,...e}})},p=e=>{n({lfo:{...i.current.lfo,...e}})},h=e=>{void 0!==e.time&&(e.time=Math.max(0,Math.min(1,e.time))),n({delay:{...i.current.delay,...e}})},f=e=>{n({reverb:{...i.current.reverb,...e}})},x=e=>{n({filter:{...i.current.filter,...e}})},g=t=>{const n=d(),r=e.delay.enabled?e.delay.wet:0;n.throwInstrumentToEffect(a,"SpaceEcho",t?1:r)},b=(e,a,n)=>t.jsxs("div",{className:"flex flex-col gap-2",children:[t.jsx("div",{className:"text-xs font-bold text-gray-500 uppercase tracking-wide text-center",children:n}),t.jsx("div",{className:"flex gap-2 justify-center",children:["sine","square","sawtooth","triangle"].map(n=>t.jsxs("button",{onClick:()=>a(n),className:`\n              w-10 h-10 rounded border transition-all flex items-center justify-center\n              ${e===n?"bg-[#2a2a2a]":"bg-[#1a1a1a] border-gray-700 hover:border-gray-500"}\n            `,style:e===n?{borderColor:l,boxShadow:`0 0 10px ${l}40`}:void 0,title:n,children:["sine"===n&&t.jsx(Be,{size:16,color:e===n?l:"#666"}),"square"===n&&t.jsx("div",{className:"w-4 h-4 border-t-2 border-r-2 border-b-0 border-l-2",style:{borderColor:e===n?l:"#666"}}),"sawtooth"===n&&t.jsx(Ee,{size:16,color:e===n?l:"#666"}),"triangle"===n&&t.jsx("div",{className:"w-0 h-0 border-l-[6px] border-r-[6px] border-b-[10px] border-transparent border-b-current",style:{color:e===n?l:"#666"}})]},n))})]});return t.jsxs("div",{className:"flex flex-col h-full",children:[t.jsxs("div",{className:"flex border-b border-gray-800 bg-[#151515]",children:[t.jsx("button",{onClick:()=>s("main"),className:`\n            flex-1 py-3 text-xs font-bold uppercase tracking-wider transition-colors\n            ${"main"===r?"bg-[#252525] border-b-2":"text-gray-500 hover:text-gray-300"}\n          `,style:"main"===r?{color:l,borderColor:l}:void 0,children:"Oscillator & LFO"}),t.jsx("button",{onClick:()=>s("fx"),className:`\n            flex-1 py-3 text-xs font-bold uppercase tracking-wider transition-colors\n            ${"fx"===r?"bg-[#252525] border-b-2":"text-gray-500 hover:text-gray-300"}\n          `,style:"fx"===r?{color:l,borderColor:l}:void 0,children:"Effects & Filter"})]}),t.jsx("div",{className:"flex-1 overflow-y-auto",children:"main"===r?t.jsxs("div",{className:"flex flex-col gap-4 p-4",children:[t.jsxs("div",{className:`p-4 rounded-xl border ${u}`,children:[t.jsxs("div",{className:"flex items-center gap-2 mb-4",children:[t.jsx(pt,{size:16,className:o?"text-cyan-500":"text-red-500"}),t.jsx("h3",{className:"font-bold "+(o?"text-cyan-400":"text-red-400"),children:"OSCILLATOR"})]}),t.jsxs("div",{className:"flex flex-col md:flex-row gap-6 items-center gap-6",children:[b(e.oscillator.type,e=>m({type:e}),"Waveform"),t.jsx(I,{value:e.oscillator.frequency,min:60,max:1e3,onChange:e=>m({frequency:e}),label:"Freq",color:c,formatValue:e=>`${Math.round(e)}Hz`})]})]}),t.jsxs("div",{className:`p-4 rounded-xl border ${u}`,children:[t.jsxs("div",{className:"flex items-center justify-between mb-4",children:[t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx(Ee,{size:16,className:o?"text-cyan-500":"text-red-500"}),t.jsx("h3",{className:"font-bold "+(o?"text-cyan-400":"text-red-400"),children:"LFO MODULATION"})]}),t.jsxs("label",{className:"flex items-center gap-2 cursor-pointer",children:[t.jsx("span",{className:"text-xs text-gray-500",children:"Enable"}),t.jsx("input",{type:"checkbox",checked:e.lfo.enabled,onChange:e=>p({enabled:e.target.checked}),className:"w-4 h-4 rounded border-2 bg-transparent cursor-pointer "+(o?"border-cyan-500 checked:bg-cyan-500":"border-red-500 checked:bg-red-500")})]})]}),t.jsx("div",{className:"transition-opacity "+(e.lfo.enabled?"opacity-100":"opacity-40 pointer-events-none"),children:t.jsxs("div",{className:"flex flex-col md:flex-row gap-6 items-center gap-6",children:[b(e.lfo.type,e=>p({type:e}),"LFO Shape"),t.jsx(I,{value:e.lfo.rate,min:.1,max:20,onChange:e=>p({rate:e}),label:"Rate",color:c,formatValue:e=>`${e.toFixed(1)}Hz`}),t.jsx(I,{value:e.lfo.depth,min:0,max:500,onChange:e=>p({depth:e}),label:"Depth",color:c,formatValue:e=>`${Math.round(e)}`})]})})]})]}):t.jsxs("div",{className:"flex flex-col gap-4 p-4",children:[t.jsxs("div",{className:`p-4 rounded-xl border ${u}`,children:[t.jsxs("div",{className:"flex items-center justify-between mb-4",children:[t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx(Re,{size:16,className:o?"text-cyan-500":"text-red-500"}),t.jsx("h3",{className:"font-bold "+(o?"text-cyan-400":"text-red-400"),children:"DELAY"})]}),t.jsxs("label",{className:"flex items-center gap-2 cursor-pointer",children:[t.jsx("span",{className:"text-xs text-gray-500",children:"Enable"}),t.jsx("input",{type:"checkbox",checked:e.delay.enabled,onChange:e=>h({enabled:e.target.checked}),className:"w-4 h-4 rounded border-2 bg-transparent cursor-pointer "+(o?"border-cyan-500 checked:bg-cyan-500":"border-red-500 checked:bg-red-500")})]})]}),t.jsxs("div",{className:"flex gap-6 transition-opacity "+(e.delay.enabled?"opacity-100":"opacity-40 pointer-events-none"),children:[t.jsx(I,{value:e.delay.time,min:.01,max:1,onChange:e=>h({time:e}),label:"Time",color:c,formatValue:e=>`${(1e3*e).toFixed(0)}ms`}),t.jsx(I,{value:e.delay.feedback,min:0,max:.95,onChange:e=>h({feedback:e}),label:"Fdbk",color:c,formatValue:e=>`${Math.round(100*e)}%`}),t.jsx(I,{value:e.delay.wet,min:0,max:1,onChange:e=>h({wet:e}),label:"Mix",color:c,formatValue:e=>`${Math.round(100*e)}%`}),t.jsxs("div",{className:"flex flex-col items-center gap-2",children:[t.jsx("span",{className:"text-[10px] font-bold text-gray-500 uppercase",children:"Throw"}),t.jsx("button",{onMouseDown:()=>g(!0),onMouseUp:()=>g(!1),onMouseLeave:()=>g(!1),onTouchStart:()=>g(!0),onTouchEnd:()=>g(!1),className:`\n                w-12 h-12 rounded-full flex items-center justify-center transition-all active:scale-95\n                ${o?"bg-cyan-500/20 border-2 border-cyan-500 text-cyan-400":"bg-red-500/20 border-2 border-red-500 text-red-500"}\n                hover:shadow-[0_0_15px_rgba(239,68,68,0.4)]\n              `,title:"Momentary Delay Throw (Dub Style)",children:t.jsx(ht,{size:20})})]})]})]}),t.jsxs("div",{className:`p-4 rounded-xl border ${u}`,children:[t.jsxs("div",{className:"flex items-center justify-between mb-4",children:[t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx(ft,{size:16,className:o?"text-cyan-500":"text-red-500"}),t.jsx("h3",{className:"font-bold "+(o?"text-cyan-400":"text-red-400"),children:"FILTER"})]}),t.jsxs("label",{className:"flex items-center gap-2 cursor-pointer",children:[t.jsx("span",{className:"text-xs text-gray-500",children:"Enable"}),t.jsx("input",{type:"checkbox",checked:e.filter.enabled,onChange:e=>x({enabled:e.target.checked}),className:"w-4 h-4 rounded border-2 bg-transparent cursor-pointer "+(o?"border-cyan-500 checked:bg-cyan-500":"border-red-500 checked:bg-red-500")})]})]}),t.jsxs("div",{className:"flex flex-col items-center gap-4 transition-opacity "+(e.filter.enabled?"opacity-100":"opacity-40 pointer-events-none"),children:[t.jsx("div",{className:"flex gap-2",children:["lowpass","highpass","bandpass","notch"].map(a=>t.jsx("button",{onClick:()=>x({type:a}),className:`\n                  px-3 py-1 text-xs font-bold rounded border uppercase\n                  ${e.filter.type===a?"bg-[#2a2a2a]":"bg-[#1a1a1a] border-gray-700 text-gray-500 hover:border-gray-500"}\n                `,style:e.filter.type===a?{borderColor:l,color:l}:void 0,children:a},a))}),t.jsx(I,{value:e.filter.frequency,min:20,max:1e4,onChange:e=>x({frequency:e}),label:"Cutoff",color:c,formatValue:e=>`${Math.round(e)}Hz`})]})]}),t.jsxs("div",{className:`p-4 rounded-xl border ${u}`,children:[t.jsxs("div",{className:"flex items-center justify-between mb-4",children:[t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx(Be,{size:16,className:o?"text-cyan-500":"text-red-500"}),t.jsx("h3",{className:"font-bold "+(o?"text-cyan-400":"text-red-400"),children:"REVERB"})]}),t.jsxs("label",{className:"flex items-center gap-2 cursor-pointer",children:[t.jsx("span",{className:"text-xs text-gray-500",children:"Enable"}),t.jsx("input",{type:"checkbox",checked:e.reverb.enabled,onChange:e=>f({enabled:e.target.checked}),className:"w-4 h-4 rounded border-2 bg-transparent cursor-pointer "+(o?"border-cyan-500 checked:bg-cyan-500":"border-red-500 checked:bg-red-500")})]})]}),t.jsxs("div",{className:"flex gap-6 transition-opacity "+(e.reverb.enabled?"opacity-100":"opacity-40 pointer-events-none"),children:[t.jsx(I,{value:e.reverb.decay,min:.1,max:10,onChange:e=>f({decay:e}),label:"Decay",color:c,formatValue:e=>`${e.toFixed(1)}s`}),t.jsx(I,{value:e.reverb.wet,min:0,max:1,onChange:e=>f({wet:e}),label:"Mix",color:c,formatValue:e=>`${Math.round(100*e)}%`})]})]})]})})]})},kf=({config:e,onChange:a})=>{const[n,r]=he.useState("laser"),s=he.useRef(e);s.current=e;const i="cyan-lineart"===B(e=>e.currentThemeId),o=i?"#00ffff":"#00ff00",l=i?"#00ffff":"#88ff88",d=i?"bg-[#051515] border-cyan-900/50":"bg-[#1a1a1a] border-gray-800",c=e=>{a({laser:{...s.current.laser,...e}})},u=e=>{a({fm:{...s.current.fm,...e}})},m=e=>{a({noise:{...s.current.noise,...e}})},p=e=>{a({delay:{...s.current.delay,...e}})},h=e=>{a({reverb:{...s.current.reverb,...e}})},f=e=>{a({filter:{...s.current.filter,...e}})};return t.jsxs("div",{className:"flex flex-col h-full",children:[t.jsxs("div",{className:"flex border-b border-gray-800 bg-[#151515]",children:[t.jsx("button",{onClick:()=>r("laser"),className:`\n            flex-1 py-3 text-xs font-bold uppercase tracking-wider transition-colors\n            ${"laser"===n?"bg-[#252525] border-b-2":"text-gray-500 hover:text-gray-300"}\n          `,style:"laser"===n?{color:o,borderColor:o}:void 0,children:"Laser & Noise"}),t.jsx("button",{onClick:()=>r("fm"),className:`\n            flex-1 py-3 text-xs font-bold uppercase tracking-wider transition-colors\n            ${"fm"===n?"bg-[#252525] border-b-2":"text-gray-500 hover:text-gray-300"}\n          `,style:"fm"===n?{color:o,borderColor:o}:void 0,children:"FM & Filter"}),t.jsx("button",{onClick:()=>r("fx"),className:`\n            flex-1 py-3 text-xs font-bold uppercase tracking-wider transition-colors\n            ${"fx"===n?"bg-[#252525] border-b-2":"text-gray-500 hover:text-gray-300"}\n          `,style:"fx"===n?{color:o,borderColor:o}:void 0,children:"Space FX"})]}),t.jsx("div",{className:"flex-1 overflow-y-auto",children:"laser"===n?t.jsxs("div",{className:"flex flex-col gap-4 p-4",children:[t.jsxs("div",{className:`p-4 rounded-xl border ${d}`,children:[t.jsxs("div",{className:"flex items-center gap-2 mb-4",children:[t.jsx(Se,{size:16,className:i?"text-cyan-500":"text-green-500"}),t.jsx("h3",{className:"font-bold "+(i?"text-cyan-400":"text-green-400"),children:"LASER SWEEP"})]}),t.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-4 gap-6 items-center gap-6",children:[t.jsx(I,{value:e.laser.startFreq,min:100,max:1e4,onChange:e=>c({startFreq:e}),label:"Start",color:l,formatValue:e=>`${Math.round(e)}Hz`}),t.jsx(I,{value:e.laser.endFreq,min:20,max:2e3,onChange:e=>c({endFreq:e}),label:"End",color:l,formatValue:e=>`${Math.round(e)}Hz`}),t.jsx(I,{value:e.laser.sweepTime,min:10,max:2e3,onChange:e=>c({sweepTime:e}),label:"Time",color:l,formatValue:e=>`${Math.round(e)}ms`}),t.jsxs("div",{className:"flex flex-col items-center gap-2",children:[t.jsx("span",{className:"text-[10px] font-bold text-gray-500 uppercase",children:"Curve"}),t.jsx("div",{className:"flex gap-1",children:["exponential","linear"].map(a=>t.jsx("button",{onClick:()=>c({sweepCurve:a}),className:`\n                    px-2 py-1 text-[10px] font-bold rounded border uppercase\n                    ${e.laser.sweepCurve===a?"bg-[#2a2a2a]":"bg-[#1a1a1a] border-gray-700 text-gray-500 hover:border-gray-500"}\n                  `,style:e.laser.sweepCurve===a?{borderColor:o,color:o}:void 0,children:a.slice(0,3)},a))})]})]})]}),t.jsxs("div",{className:`p-4 rounded-xl border ${d}`,children:[t.jsxs("div",{className:"flex items-center gap-2 mb-4",children:[t.jsx(ht,{size:16,className:i?"text-cyan-500":"text-green-500"}),t.jsx("h3",{className:"font-bold "+(i?"text-cyan-400":"text-green-400"),children:"NOISE GRIT"})]}),t.jsxs("div",{className:"flex gap-6 items-center",children:[t.jsx(I,{value:e.noise.amount,min:0,max:100,onChange:e=>m({amount:e}),label:"Amount",color:l,formatValue:e=>`${Math.round(e)}%`}),t.jsxs("div",{className:"flex flex-col items-center gap-2",children:[t.jsx("span",{className:"text-[10px] font-bold text-gray-500 uppercase",children:"Type"}),t.jsx("div",{className:"flex gap-1",children:["white","pink","brown"].map(a=>t.jsx("button",{onClick:()=>m({type:a}),className:`\n                    px-2 py-1 text-[10px] font-bold rounded border uppercase\n                    ${e.noise.type===a?"bg-[#2a2a2a]":"bg-[#1a1a1a] border-gray-700 text-gray-500 hover:border-gray-500"}\n                  `,style:e.noise.type===a?{borderColor:o,color:o}:void 0,children:a[0]},a))})]})]})]})]}):"fm"===n?t.jsxs("div",{className:"flex flex-col gap-4 p-4",children:[t.jsxs("div",{className:`p-4 rounded-xl border ${d}`,children:[t.jsxs("div",{className:"flex items-center gap-2 mb-4",children:[t.jsx(Ee,{size:16,className:i?"text-cyan-500":"text-green-500"}),t.jsx("h3",{className:"font-bold "+(i?"text-cyan-400":"text-green-400"),children:"FM MODULATION"})]}),t.jsxs("div",{className:"flex gap-6 items-center",children:[t.jsx(I,{value:e.fm.amount,min:0,max:100,onChange:e=>u({amount:e}),label:"Index",color:l,formatValue:e=>`${Math.round(e)}`}),t.jsx(I,{value:e.fm.ratio,min:.5,max:16,onChange:e=>u({ratio:e}),label:"Ratio",color:l,formatValue:e=>`${e.toFixed(2)}`})]})]}),t.jsxs("div",{className:`p-4 rounded-xl border ${d}`,children:[t.jsxs("div",{className:"flex items-center gap-2 mb-4",children:[t.jsx(ft,{size:16,className:i?"text-cyan-500":"text-green-500"}),t.jsx("h3",{className:"font-bold "+(i?"text-cyan-400":"text-green-400"),children:"FILTER"})]}),t.jsxs("div",{className:"flex flex-col items-center gap-4",children:[t.jsx("div",{className:"flex gap-2",children:["lowpass","highpass","bandpass","notch"].map(a=>t.jsx("button",{onClick:()=>f({type:a}),className:`\n                  px-3 py-1 text-xs font-bold rounded border uppercase\n                  ${e.filter.type===a?"bg-[#2a2a2a]":"bg-[#1a1a1a] border-gray-700 text-gray-500 hover:border-gray-500"}\n                `,style:e.filter.type===a?{borderColor:o,color:o}:void 0,children:a.slice(0,4)},a))}),t.jsxs("div",{className:"flex gap-6 w-full",children:[t.jsx(I,{value:e.filter.cutoff,min:20,max:15e3,onChange:e=>f({cutoff:e}),label:"Cutoff",color:l,formatValue:e=>`${Math.round(e)}Hz`}),t.jsx(I,{value:e.filter.resonance,min:0,max:100,onChange:e=>f({resonance:e}),label:"Reso",color:l,formatValue:e=>`${Math.round(e)}%`})]})]})]})]}):t.jsxs("div",{className:"flex flex-col gap-4 p-4",children:[t.jsxs("div",{className:`p-4 rounded-xl border ${d}`,children:[t.jsxs("div",{className:"flex items-center justify-between mb-4",children:[t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx(Re,{size:16,className:i?"text-cyan-500":"text-green-500"}),t.jsx("h3",{className:"font-bold "+(i?"text-cyan-400":"text-green-400"),children:"SPACE DELAY"})]}),t.jsx("input",{type:"checkbox",checked:e.delay.enabled,onChange:e=>p({enabled:e.target.checked}),className:"w-4 h-4 rounded border-2 bg-transparent cursor-pointer "+(i?"border-cyan-500 checked:bg-cyan-500":"border-green-500 checked:bg-green-500")})]}),t.jsxs("div",{className:"flex gap-6 transition-opacity "+(e.delay.enabled?"opacity-100":"opacity-40 pointer-events-none"),children:[t.jsx(I,{value:e.delay.time,min:.01,max:1,onChange:e=>p({time:e}),label:"Time",color:l,formatValue:e=>`${(1e3*e).toFixed(0)}ms`}),t.jsx(I,{value:e.delay.feedback,min:0,max:.95,onChange:e=>p({feedback:e}),label:"Fdbk",color:l,formatValue:e=>`${Math.round(100*e)}%`}),t.jsx(I,{value:e.delay.wet,min:0,max:1,onChange:e=>p({wet:e}),label:"Mix",color:l,formatValue:e=>`${Math.round(100*e)}%`})]})]}),t.jsxs("div",{className:`p-4 rounded-xl border ${d}`,children:[t.jsxs("div",{className:"flex items-center justify-between mb-4",children:[t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx(Be,{size:16,className:i?"text-cyan-500":"text-green-500"}),t.jsx("h3",{className:"font-bold "+(i?"text-cyan-400":"text-green-400"),children:"COSMIC REVERB"})]}),t.jsx("input",{type:"checkbox",checked:e.reverb.enabled,onChange:e=>h({enabled:e.target.checked}),className:"w-4 h-4 rounded border-2 bg-transparent cursor-pointer "+(i?"border-cyan-500 checked:bg-cyan-500":"border-green-500 checked:bg-green-500")})]}),t.jsxs("div",{className:"flex gap-6 transition-opacity "+(e.reverb.enabled?"opacity-100":"opacity-40 pointer-events-none"),children:[t.jsx(I,{value:e.reverb.decay,min:.1,max:10,onChange:e=>h({decay:e}),label:"Decay",color:l,formatValue:e=>`${e.toFixed(1)}s`}),t.jsx(I,{value:e.reverb.wet,min:0,max:1,onChange:e=>h({wet:e}),label:"Mix",color:l,formatValue:e=>`${Math.round(100*e)}%`})]})]})]})})]})},Nf=({config:e,onChange:a})=>{const[n,r]=he.useState("osc"),s=he.useRef(e);s.current=e;const i="cyan-lineart"===B(e=>e.currentThemeId),o=i?"#00ffff":"#ffaa00",l=i?"#00ffff":"#ffcc33",d=i?"bg-[#051515] border-cyan-900/50":"bg-[#1a1a1a] border-gray-800",c=e=>{a({osc1:{...s.current.osc1,...e}})},u=e=>{a({osc2:{...s.current.osc2,...e}})},m=e=>{a({osc3:{...s.current.osc3,...e}})},p=e=>{a({filter1:{...s.current.filter1,...e}})},h=e=>{a({filter2:{...s.current.filter2,...e}})},f=e=>{a({routing:{...s.current.routing,...e}})},x=e=>{a({envelope:{...s.current.envelope,...e}})},g=t=>{a({envelope2:{...e.envelope2,...t}})},b=t=>{a({lfo1:{...e.lfo1,...t}})},y=["Off","Saw/Tri","Pulse","Sin","Noise","XX","AuxA","AuxB"],v=["Off","Tri","Pul","Sin","Noi","FM","AuxA","AuxB"],w=["Off","Low","Band","High","Notch","All","MoogL","MoogH"],j=["Single","Serial","Parallel"];return t.jsxs("div",{className:"flex flex-col h-full",children:[t.jsx("div",{className:"flex border-b border-gray-800 bg-[#151515]",children:[{id:"osc",label:"Oscillators",icon:Ee},{id:"filter",label:"Filters",icon:ft},{id:"env",label:"Envelopes",icon:Se},{id:"mod",label:"Modulation",icon:Ee}].map(e=>t.jsxs("button",{onClick:()=>r(e.id),className:`\n              flex-1 py-3 text-xs font-bold uppercase tracking-wider transition-colors flex items-center justify-center gap-2\n              ${n===e.id?"bg-[#252525] border-b-2":"text-gray-500 hover:text-gray-300"}\n            `,style:n===e.id?{color:o,borderColor:o}:void 0,children:[t.jsx(e.icon,{size:12}),t.jsx("span",{className:"hidden sm:inline",children:e.label})]},e.id))}),t.jsx("div",{className:"flex-1 overflow-y-auto",children:"osc"===n?t.jsxs("div",{className:"flex flex-col gap-4 p-4",children:[t.jsxs("div",{className:`p-4 rounded-xl border ${d}`,children:[t.jsxs("div",{className:"flex items-center justify-between mb-4",children:[t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx(Ee,{size:16,className:"text-amber-500"}),t.jsx("h3",{className:"font-bold text-amber-400 uppercase tracking-tight",children:"OSCILLATOR 1"})]}),t.jsx("select",{value:e.osc1.mode,onChange:e=>c({mode:parseInt(e.target.value)}),className:"bg-gray-900 border border-gray-700 text-xs text-amber-400 rounded px-2 py-1",children:y.map((e,a)=>t.jsx("option",{value:a,children:e},e))})]}),t.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-4 gap-6 items-center gap-6",children:[t.jsx(I,{value:e.osc1.transpose,min:-64,max:63,onChange:e=>c({transpose:e}),label:"Trans",color:l,formatValue:e=>`${e>0?"+":""}${Math.round(e)}`}),t.jsx(I,{value:e.osc1.detune,min:-64,max:63,onChange:e=>c({detune:e}),label:"Detune",color:l,formatValue:e=>`${Math.round(e)}c`}),t.jsx(I,{value:e.osc1.color,min:0,max:127,onChange:e=>c({color:e}),label:"Color",color:l}),t.jsx(I,{value:e.osc1.level,min:0,max:127,onChange:e=>c({level:e}),label:"Level",color:l})]})]}),t.jsxs("div",{className:`p-4 rounded-xl border ${d}`,children:[t.jsxs("div",{className:"flex items-center justify-between mb-4",children:[t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx(Ee,{size:16,className:"text-amber-500"}),t.jsx("h3",{className:"font-bold text-amber-400 uppercase tracking-tight",children:"OSCILLATOR 2"})]}),t.jsxs("div",{className:"flex items-center gap-3",children:[t.jsxs("label",{className:"flex items-center gap-1 cursor-pointer",children:[t.jsx("span",{className:"text-[10px] text-gray-500 uppercase",children:"Ring"}),t.jsx("input",{type:"checkbox",checked:e.osc2.ringMod,onChange:e=>u({ringMod:e.target.checked}),className:"w-3 h-3 rounded border-gray-700 bg-transparent"})]}),t.jsx("select",{value:e.osc2.mode,onChange:e=>u({mode:parseInt(e.target.value)}),className:"bg-gray-900 border border-gray-700 text-xs text-amber-400 rounded px-2 py-1",children:v.map((e,a)=>t.jsx("option",{value:a,children:e},e))})]})]}),t.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-4 gap-6 items-center gap-6",children:[t.jsx(I,{value:e.osc2.transpose,min:-64,max:63,onChange:e=>u({transpose:e}),label:"Trans",color:l,formatValue:e=>`${e>0?"+":""}${Math.round(e)}`}),t.jsx(I,{value:e.osc2.detune,min:-64,max:63,onChange:e=>u({detune:e}),label:"Detune",color:l,formatValue:e=>`${Math.round(e)}c`}),t.jsx(I,{value:e.osc2.color,min:0,max:127,onChange:e=>u({color:e}),label:"Color",color:l}),t.jsx(I,{value:e.osc2.level,min:0,max:127,onChange:e=>u({level:e}),label:"Level",color:l})]})]}),t.jsxs("div",{className:`p-4 rounded-xl border ${d}`,children:[t.jsxs("div",{className:"flex items-center justify-between mb-4",children:[t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx(Ee,{size:16,className:"text-amber-500"}),t.jsx("h3",{className:"font-bold text-amber-400 uppercase tracking-tight",children:"OSCILLATOR 3"})]}),t.jsxs("div",{className:"flex items-center gap-3",children:[t.jsxs("label",{className:"flex items-center gap-1 cursor-pointer",children:[t.jsx("span",{className:"text-[10px] text-gray-500 uppercase",children:"Ring"}),t.jsx("input",{type:"checkbox",checked:e.osc3.ringMod,onChange:e=>m({ringMod:e.target.checked}),className:"w-3 h-3 rounded border-gray-700 bg-transparent"})]}),t.jsx("select",{value:e.osc3.mode,onChange:e=>m({mode:parseInt(e.target.value)}),className:"bg-gray-900 border border-gray-700 text-xs text-amber-400 rounded px-2 py-1",children:v.map((e,a)=>t.jsx("option",{value:a,children:e},e))})]})]}),t.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-4 gap-6 items-center gap-6",children:[t.jsx(I,{value:e.osc3.transpose,min:-64,max:63,onChange:e=>m({transpose:e}),label:"Trans",color:l,formatValue:e=>`${e>0?"+":""}${Math.round(e)}`}),t.jsx(I,{value:e.osc3.detune,min:-64,max:63,onChange:e=>m({detune:e}),label:"Detune",color:l,formatValue:e=>`${Math.round(e)}c`}),t.jsx(I,{value:e.osc3.color,min:0,max:127,onChange:e=>m({color:e}),label:"Color",color:l}),t.jsx(I,{value:e.osc3.level,min:0,max:127,onChange:e=>m({level:e}),label:"Level",color:l})]})]})]}):"filter"===n?t.jsxs("div",{className:"flex flex-col gap-4 p-4",children:[t.jsxs("div",{className:`p-4 rounded-xl border ${d}`,children:[t.jsxs("div",{className:"flex items-center justify-between mb-4",children:[t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx(ft,{size:16,className:"text-amber-500"}),t.jsx("h3",{className:"font-bold text-amber-400 uppercase tracking-tight",children:"VCF 1"})]}),t.jsx("select",{value:e.filter1.mode,onChange:e=>p({mode:parseInt(e.target.value)}),className:"bg-gray-900 border border-gray-700 text-xs text-amber-400 rounded px-2 py-1",children:w.map((e,a)=>t.jsx("option",{value:a,children:e},e))})]}),t.jsxs("div",{className:"grid grid-cols-2 gap-6 items-center gap-6",children:[t.jsx(I,{value:e.filter1.cutoff,min:0,max:127,onChange:e=>p({cutoff:e}),label:"Cutoff",color:l}),t.jsx(I,{value:e.filter1.resonance,min:0,max:127,onChange:e=>p({resonance:e}),label:"Reso",color:l})]})]}),t.jsxs("div",{className:`p-4 rounded-xl border ${d}`,children:[t.jsxs("div",{className:"flex items-center justify-between mb-4",children:[t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx(ft,{size:16,className:"text-amber-500"}),t.jsx("h3",{className:"font-bold text-amber-400 uppercase tracking-tight",children:"VCF 2"})]}),t.jsx("select",{value:e.filter2.mode,onChange:e=>h({mode:parseInt(e.target.value)}),className:"bg-gray-900 border border-gray-700 text-xs text-amber-400 rounded px-2 py-1",children:w.map((e,a)=>t.jsx("option",{value:a,children:e},e))})]}),t.jsxs("div",{className:"grid grid-cols-2 gap-6 items-center gap-6",children:[t.jsx(I,{value:e.filter2.cutoff,min:0,max:127,onChange:e=>h({cutoff:e}),label:"Cutoff",color:l}),t.jsx(I,{value:e.filter2.resonance,min:0,max:127,onChange:e=>h({resonance:e}),label:"Reso",color:l})]})]}),t.jsxs("div",{className:`p-4 rounded-xl border ${d}`,children:[t.jsxs("div",{className:"flex items-center justify-between mb-4",children:[t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx(Se,{size:16,className:"text-amber-500"}),t.jsx("h3",{className:"font-bold text-amber-400 uppercase tracking-tight",children:"ROUTING"})]}),t.jsx("select",{value:e.routing.mode,onChange:e=>f({mode:parseInt(e.target.value)}),className:"bg-gray-900 border border-gray-700 text-xs text-amber-400 rounded px-2 py-1",children:j.map((e,a)=>t.jsx("option",{value:a,children:e},e))})]}),t.jsx("div",{className:"flex gap-6 items-center",children:t.jsx(I,{value:e.routing.balance,min:0,max:127,onChange:e=>f({balance:e}),label:"Balance",color:l,formatValue:e=>e<64?`F1:${Math.round((64-e)/64*100)}%`:`F2:${Math.round((e-64)/64*100)}%`})})]})]}):"env"===n?t.jsxs("div",{className:"flex flex-col gap-4 p-4",children:[t.jsxs("div",{className:`p-4 rounded-xl border ${d}`,children:[t.jsxs("div",{className:"flex items-center gap-2 mb-4",children:[t.jsx(Se,{size:16,className:"text-amber-500"}),t.jsx("h3",{className:"font-bold text-amber-400 uppercase tracking-tight",children:"AMP ENVELOPE (EG 1)"})]}),t.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-4 gap-6 items-center gap-6",children:[t.jsx(I,{value:e.envelope.attack,min:0,max:127,onChange:e=>x({attack:e}),label:"Attack",color:l}),t.jsx(I,{value:e.envelope.decay,min:0,max:127,onChange:e=>x({decay:e}),label:"Decay",color:l}),t.jsx(I,{value:e.envelope.sustain,min:0,max:127,onChange:e=>x({sustain:e}),label:"Sustain",color:l}),t.jsx(I,{value:e.envelope.release,min:0,max:127,onChange:e=>x({release:e}),label:"Release",color:l})]})]}),t.jsxs("div",{className:`p-4 rounded-xl border ${d}`,children:[t.jsxs("div",{className:"flex items-center gap-2 mb-4",children:[t.jsx(Se,{size:16,className:"text-amber-500"}),t.jsx("h3",{className:"font-bold text-amber-400 uppercase tracking-tight",children:"MOD ENVELOPE (EG 2)"})]}),t.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-4 gap-6 items-center gap-6",children:[t.jsx(I,{value:e.envelope2.attack,min:0,max:127,onChange:e=>g({attack:e}),label:"Attack",color:l}),t.jsx(I,{value:e.envelope2.decay,min:0,max:127,onChange:e=>g({decay:e}),label:"Decay",color:l}),t.jsx(I,{value:e.envelope2.sustain,min:0,max:127,onChange:e=>g({sustain:e}),label:"Sustain",color:l}),t.jsx(I,{value:e.envelope2.release,min:0,max:127,onChange:e=>g({release:e}),label:"Release",color:l})]})]})]}):t.jsx("div",{className:"flex flex-col gap-4 p-4",children:t.jsxs("div",{className:`p-4 rounded-xl border ${d}`,children:[t.jsxs("div",{className:"flex items-center gap-2 mb-4",children:[t.jsx(Ee,{size:16,className:"text-amber-500"}),t.jsx("h3",{className:"font-bold text-amber-400 uppercase tracking-tight",children:"LFO 1"})]}),t.jsxs("div",{className:"grid grid-cols-2 gap-6 items-center gap-6",children:[t.jsx(I,{value:e.lfo1.rate,min:0,max:127,onChange:e=>b({rate:e}),label:"Rate",color:l}),t.jsx(I,{value:e.lfo1.depth,min:0,max:127,onChange:e=>b({depth:e}),label:"Depth",color:l})]})]})})})]})},$f=({config:e,onChange:a})=>{const[n,r]=he.useState(!1),s=he.useRef(e);s.current=e;const i="cyan-lineart"===B(e=>e.currentThemeId),o=i?"#00ffff":"#ffcc33",l=i?"bg-[#051515] border-cyan-900/50":"bg-[#1a1a1a] border-gray-800";return t.jsxs("div",{className:"flex flex-col gap-4 p-4 h-full overflow-y-auto scrollbar-modern",children:[t.jsxs("div",{className:`p-4 rounded-xl border ${l}`,children:[t.jsxs("div",{className:"flex items-center justify-between mb-4",children:[t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx(xt,{size:16,className:"text-amber-500"}),t.jsx("h3",{className:"font-bold text-amber-400 uppercase tracking-tight",children:"V2 SPEECH TEXT"})]}),t.jsxs("label",{className:"flex items-center gap-1.5 cursor-pointer",children:[t.jsx("input",{type:"checkbox",checked:e.singMode,onChange:e=>a({singMode:e.target.checked}),className:"w-3 h-3 rounded border-gray-700 bg-transparent"}),t.jsx("span",{className:"text-[10px] text-gray-500 uppercase font-bold",title:"Enables MIDI note-to-pitch tracking",children:"Sing Mode"})]})]}),t.jsxs("div",{className:"flex gap-2",children:[t.jsx("input",{type:"text",value:e.text,onChange:e=>a({text:e.target.value}),className:"flex-1 bg-black/40 border border-gray-700 rounded-lg px-4 py-3 font-mono text-amber-500 focus:border-amber-500/50 outline-none",placeholder:"HELLO WORLD"}),t.jsxs("button",{onClick:()=>{try{const e=L.convert(s.current.text);e&&a({text:e})}catch(tn){}},className:"px-4 py-2 rounded-lg bg-amber-500/10 border border-amber-500/20 text-amber-500 hover:bg-amber-500/20 transition-all flex flex-col items-center justify-center min-w-[80px]",title:"Convert plain text to phonemes",children:[t.jsx(Fe,{size:16,className:"mb-1"}),t.jsx("span",{className:"text-[8px] font-black uppercase tracking-tighter",children:"Convert"})]})]}),t.jsx("p",{className:"text-[10px] text-gray-500 mt-2 uppercase",children:"Type plain text and click Convert, or enter phonemes directly (e.g., DHAX KWIHK BRAUN FAHKS)"})]}),t.jsxs("div",{className:`p-4 rounded-xl border ${l}`,children:[t.jsxs("div",{className:"flex items-center gap-2 mb-4",children:[t.jsx(Ee,{size:16,className:"text-amber-500"}),t.jsx("h3",{className:"font-bold text-amber-400 uppercase tracking-tight",children:"VOICE PARAMETERS"})]}),t.jsxs("div",{className:"grid grid-cols-3 gap-6",children:[t.jsx(I,{value:e.speed,min:0,max:127,onChange:e=>a({speed:e}),label:"Speed",color:o}),t.jsx(I,{value:e.pitch,min:0,max:127,onChange:e=>a({pitch:e}),label:"Pitch",color:o}),t.jsx(I,{value:e.formantShift,min:0,max:127,onChange:e=>a({formantShift:e}),label:"Formant",color:o})]})]}),t.jsxs("div",{className:`rounded-xl border ${l} overflow-hidden transition-all`,children:[t.jsxs("button",{onClick:()=>r(!n),className:"w-full p-3 flex items-center justify-between hover:bg-white/5 transition-colors",children:[t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx(gt,{size:14,className:"text-amber-500"}),t.jsx("span",{className:"text-[10px] font-bold text-gray-400 uppercase tracking-widest",children:"Phoneme Reference"})]}),n?t.jsx(bt,{size:14}):t.jsx(we,{size:14})]}),n&&t.jsx("div",{className:"p-4 grid grid-cols-2 sm:grid-cols-4 gap-2 border-t border-gray-800 bg-black/20",children:[{code:"IY",example:"beet"},{code:"IH",example:"bit"},{code:"EH",example:"bet"},{code:"AE",example:"bat"},{code:"AA",example:"hot"},{code:"AH",example:"but"},{code:"AO",example:"bought"},{code:"OH",example:"bone"},{code:"UH",example:"book"},{code:"UW",example:"boot"},{code:"RR",example:"bird"},{code:"LL",example:"lull"},{code:"WW",example:"we"},{code:"YY",example:"yes"}].map(e=>t.jsxs("div",{className:"flex flex-col p-1.5 rounded bg-gray-900/50 border border-gray-800",children:[t.jsx("span",{className:"text-[10px] font-bold text-amber-500 font-mono",children:e.code}),t.jsx("span",{className:"text-[8px] text-gray-500 uppercase",children:e.example})]},e.code))})]}),t.jsx("div",{className:"bg-amber-500/5 border border-amber-500/10 rounded-lg p-3",children:t.jsxs("div",{className:"flex items-start gap-2",children:[t.jsx(Se,{size:14,className:"text-amber-400 mt-0.5"}),t.jsx("p",{className:"text-[10px] text-amber-400/70 leading-relaxed uppercase",children:"V2 Speech uses the SAM engine. Sing Mode tracks keyboard notes to change pitch. Formant shift adjusts voice character from male to female."})]})})]})},Cf=({config:e,onChange:a})=>{const[n,r]=he.useState(!1),s=he.useRef(e);s.current=e;const i="cyan-lineart"===B(e=>e.currentThemeId),o=i?"#00ffff":"#ffcc33",l=i?"bg-[#051515] border-cyan-900/50":"bg-[#1a1a1a] border-gray-800";return t.jsxs("div",{className:"flex flex-col gap-4 p-4 h-full overflow-y-auto scrollbar-modern",children:[t.jsxs("div",{className:`p-4 rounded-xl border ${l}`,children:[t.jsxs("div",{className:"flex items-center justify-between mb-4",children:[t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx(xt,{size:16,className:"text-amber-500"}),t.jsx("h3",{className:"font-bold text-amber-400 uppercase tracking-tight",children:"SAM TEXT"})]}),t.jsxs("div",{className:"flex items-center gap-3",children:[t.jsxs("label",{className:"flex items-center gap-1.5 cursor-pointer",children:[t.jsx("input",{type:"checkbox",checked:e.phonetic,onChange:e=>a({phonetic:e.target.checked}),className:"w-3 h-3 rounded border-gray-700 bg-transparent"}),t.jsx("span",{className:"text-[10px] text-gray-500 uppercase font-bold",children:"Phonetic"})]}),t.jsxs("label",{className:"flex items-center gap-1.5 cursor-pointer",children:[t.jsx("input",{type:"checkbox",checked:e.singmode,onChange:e=>a({singmode:e.target.checked}),className:"w-3 h-3 rounded border-gray-700 bg-transparent"}),t.jsx("span",{className:"text-[10px] text-gray-500 uppercase font-bold",title:"Adjusts pitch based on MIDI notes",children:"Sing"})]})]})]}),t.jsxs("div",{className:"flex gap-2",children:[t.jsx("input",{type:"text",value:e.text,onChange:e=>{return t=e.target.value,void a({text:t});var t},className:"flex-1 bg-black/40 border border-gray-700 rounded-lg px-4 py-3 font-mono text-amber-500 focus:border-amber-500/50 outline-none",placeholder:"COMMODORE SIXTY FOUR"}),t.jsxs("button",{onClick:()=>{try{const e=L.convert(s.current.text);e&&a({text:e,phonetic:!0})}catch(tn){}},className:"px-4 py-2 rounded-lg bg-amber-500/10 border border-amber-500/20 text-amber-500 hover:bg-amber-500/20 transition-all flex flex-col items-center justify-center min-w-[80px]",title:"Convert plain text to SAM phonemes",children:[t.jsx(Fe,{size:16,className:"mb-1"}),t.jsx("span",{className:"text-[8px] font-black uppercase tracking-tighter",children:"Convert"})]})]})]}),t.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[t.jsxs("div",{className:`p-4 rounded-xl border ${l} flex flex-col items-center`,children:[t.jsxs("div",{className:"flex items-center gap-2 mb-4 w-full",children:[t.jsx(Ee,{size:16,className:"text-amber-500"}),t.jsx("h3",{className:"font-bold text-amber-400 uppercase tracking-tight",children:"VOCAL CHARACTER"})]}),t.jsxs("div",{className:"w-40 h-40 bg-black/60 rounded-lg border border-gray-700 relative cursor-crosshair overflow-hidden",onMouseMove:e=>{if(1===e.buttons){const t=e.currentTarget.getBoundingClientRect(),n=Math.max(0,Math.min(255,(e.clientX-t.left)/t.width*255)),r=Math.max(0,Math.min(255,255*(1-(e.clientY-t.top)/t.height)));a({mouth:Math.round(n),throat:Math.round(r)})}},onClick:e=>{const t=e.currentTarget.getBoundingClientRect(),n=Math.max(0,Math.min(255,(e.clientX-t.left)/t.width*255)),r=Math.max(0,Math.min(255,255*(1-(e.clientY-t.top)/t.height)));a({mouth:Math.round(n),throat:Math.round(r)})},children:[t.jsxs("div",{className:"absolute inset-0 flex items-center justify-center opacity-10 pointer-events-none",children:[t.jsx("div",{className:"w-full h-[1px] bg-amber-500"}),t.jsx("div",{className:"h-full w-[1px] bg-amber-500"})]}),t.jsx("div",{className:"absolute w-3 h-3 bg-amber-500 rounded-full shadow-[0_0_10px_rgba(245,158,11,0.8)] -translate-x-1/2 translate-y-1/2",style:{left:e.mouth/255*100+"%",bottom:e.throat/255*100+"%"}}),t.jsx("div",{className:"absolute bottom-1 left-2 text-[8px] text-gray-500 uppercase font-bold",children:"Mouth (X)"}),t.jsx("div",{className:"absolute top-2 left-1 text-[8px] text-gray-500 uppercase font-bold origin-left rotate-90",children:"Throat (Y)"})]}),t.jsxs("div",{className:"flex flex-wrap gap-4 mt-4",children:[t.jsxs("div",{className:"text-center",children:[t.jsx("div",{className:"text-[10px] text-gray-500 uppercase font-bold",children:"Mouth"}),t.jsx("div",{className:"text-xs text-amber-500 font-mono font-bold",children:e.mouth})]}),t.jsxs("div",{className:"text-center",children:[t.jsx("div",{className:"text-[10px] text-gray-500 uppercase font-bold",children:"Throat"}),t.jsx("div",{className:"text-xs text-amber-500 font-mono font-bold",children:e.throat})]})]})]}),t.jsxs("div",{className:`p-4 rounded-xl border ${l}`,children:[t.jsxs("div",{className:"flex items-center gap-2 mb-4",children:[t.jsx(Se,{size:16,className:"text-amber-500"}),t.jsx("h3",{className:"font-bold text-amber-400 uppercase tracking-tight",children:"PERFORMANCE"})]}),t.jsxs("div",{className:"grid grid-cols-2 gap-6 items-center justify-center h-40",children:[t.jsx(I,{value:e.pitch,min:0,max:255,onChange:e=>a({pitch:e}),label:"Pitch",color:o}),t.jsx(I,{value:e.speed,min:0,max:255,onChange:e=>a({speed:e}),label:"Speed",color:o})]})]})]}),t.jsxs("div",{className:`rounded-xl border ${l} overflow-hidden transition-all`,children:[t.jsxs("button",{onClick:()=>r(!n),className:"w-full p-3 flex items-center justify-between hover:bg-white/5 transition-colors",children:[t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx(gt,{size:14,className:"text-amber-500"}),t.jsx("span",{className:"text-[10px] font-bold text-gray-400 uppercase tracking-widest",children:"Phoneme Reference"})]}),n?t.jsx(bt,{size:14}):t.jsx(we,{size:14})]}),n&&t.jsx("div",{className:"p-4 grid grid-cols-2 sm:grid-cols-4 gap-2 border-t border-gray-800 bg-black/20",children:[{code:"IY",example:"beet"},{code:"IH",example:"bit"},{code:"EH",example:"bet"},{code:"AE",example:"bat"},{code:"AA",example:"hot"},{code:"AH",example:"but"},{code:"AO",example:"bought"},{code:"OH",example:"bone"},{code:"UH",example:"book"},{code:"UW",example:"boot"},{code:"RR",example:"bird"},{code:"LL",example:"lull"},{code:"WW",example:"we"},{code:"YY",example:"yes"}].map(e=>t.jsxs("div",{className:"flex flex-col p-1.5 rounded bg-gray-900/50 border border-gray-800",children:[t.jsx("span",{className:"text-[10px] font-bold text-amber-500 font-mono",children:e.code}),t.jsx("span",{className:"text-[8px] text-gray-500 uppercase",children:e.example})]},e.code))})]}),t.jsx("div",{className:"bg-amber-500/5 border border-amber-500/10 rounded-lg p-3",children:t.jsxs("div",{className:"flex items-start gap-2",children:[t.jsx(Se,{size:14,className:"text-amber-400 mt-0.5"}),t.jsx("p",{className:"text-[10px] text-amber-400/70 leading-relaxed uppercase",children:"SAM renders a new buffer on every change. Sing mode allows melodic playback via keyboard."})]})})]})},Sf=({config:e,instrumentId:a,onChange:n})=>{const[r,s]=he.useState("main"),i=he.useRef(e);i.current=e;const o="cyan-lineart"===B(e=>e.currentThemeId),l=o?"#00ffff":"#ffcc00",c=o?"#00ffff":"#ff9900",u=o?"bg-[#030808]":"bg-gradient-to-b from-[#1e1e1e] to-[#151515]",m=o?"bg-[#051515] border-cyan-900/50":"bg-[#1a1a1a] border-gray-800",p=o?"bg-[#041010] border-b-2 border-cyan-500":"bg-gradient-to-r from-[#2a2a2a] to-[#1a1a1a] border-b-4 border-[#ffcc00]",h=e=>{n({filter:{...i.current.filter,...e}})},f=e=>{n({sweep:{...i.current.sweep,...e}})},x=e=>{d().throwInstrumentToEffect(a,"Reverb",e?.9:.3)};return t.jsxs("div",{className:`synth-editor-container ${u} flex flex-col h-full`,children:[t.jsx("div",{className:`synth-editor-header px-4 py-3 ${p}`,children:t.jsxs("div",{className:"flex items-center gap-3",children:[t.jsx("div",{className:"p-2 rounded-lg bg-gradient-to-br from-yellow-500 to-orange-700 shadow-lg text-black",children:t.jsx(Ke,{size:24})}),t.jsxs("div",{children:[t.jsx("h2",{className:"text-xl font-black tracking-tight",style:{color:l},children:"SYNARE 3"}),t.jsx("p",{className:"text-[10px] uppercase tracking-widest "+(o?"text-cyan-600":"text-gray-400"),children:"Electronic Percussion"})]})]})}),t.jsx("div",{className:"flex border-b border-gray-800 bg-[#151515]",children:["main","mod"].map(e=>t.jsx("button",{onClick:()=>s(e),className:`\n              flex-1 py-3 text-xs font-bold uppercase tracking-wider transition-colors\n              ${r===e?"bg-[#252525] border-b-2":"text-gray-500 hover:text-gray-300"}\n            `,style:r===e?{color:l,borderColor:l}:void 0,children:"main"===e?"Synth & Sweep":"Filter & LFO"},e))}),t.jsx("div",{className:"flex-1 overflow-y-auto",children:"main"===r?t.jsxs("div",{className:"flex flex-col gap-4 p-4",children:[t.jsxs("div",{className:`p-4 rounded-xl border ${m}`,children:[t.jsxs("div",{className:"flex items-center gap-2 mb-4",children:[t.jsx(pt,{size:16,className:o?"text-cyan-500":"text-yellow-500"}),t.jsx("h3",{className:"font-bold "+(o?"text-cyan-400":"text-yellow-400"),children:"PITCH & TONE"})]}),t.jsxs("div",{className:"flex flex-wrap gap-6 items-end",children:[t.jsx(I,{value:e.oscillator.tune,min:40,max:1e3,onChange:e=>{return t={tune:e},void n({oscillator:{...i.current.oscillator,...t}});var t},label:"Tune",color:c,formatValue:e=>`${Math.round(e)}Hz`}),t.jsx(I,{value:e.oscillator2.enabled?e.oscillator2.mix:0,min:0,max:1,onChange:e=>{return t={enabled:e>0,mix:e},void n({oscillator2:{...i.current.oscillator2,...t}});var t},label:"Osc 2",color:c,formatValue:e=>`${Math.round(100*e)}%`}),t.jsx(I,{value:e.noise.mix,min:0,max:1,onChange:e=>{return t={mix:e},void n({noise:{...i.current.noise,...t}});var t},label:"Noise",color:c,formatValue:e=>`${Math.round(100*e)}%`}),t.jsx(I,{value:e.envelope.decay,min:10,max:2e3,onChange:e=>{return t={decay:e},void n({envelope:{...i.current.envelope,...t}});var t},label:"Decay",color:c,formatValue:e=>`${Math.round(e)}ms`})]})]}),t.jsxs("div",{className:`p-4 rounded-xl border ${m}`,children:[t.jsxs("div",{className:"flex items-center justify-between mb-4",children:[t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx(yt,{size:16,className:o?"text-cyan-500":"text-yellow-500"}),t.jsx("h3",{className:"font-bold "+(o?"text-cyan-400":"text-yellow-400"),children:"PITCH SWEEP"})]}),t.jsxs("label",{className:"flex items-center gap-2 cursor-pointer",children:[t.jsx("span",{className:"text-xs text-gray-500",children:"Enable"}),t.jsx("input",{type:"checkbox",checked:e.sweep.enabled,onChange:e=>f({enabled:e.target.checked}),className:"w-4 h-4 rounded border-2 bg-transparent cursor-pointer "+(o?"border-cyan-500 checked:bg-cyan-500":"border-yellow-500 checked:bg-yellow-500")})]})]}),t.jsxs("div",{className:"flex flex-wrap gap-6 transition-opacity "+(e.sweep.enabled?"opacity-100":"opacity-40 pointer-events-none"),children:[t.jsx(I,{value:e.sweep.amount,min:0,max:48,onChange:e=>f({amount:e}),label:"Range",color:c,formatValue:e=>`${Math.round(e)}st`}),t.jsx(I,{value:e.sweep.time,min:10,max:1e3,onChange:e=>f({time:e}),label:"Time",color:c,formatValue:e=>`${Math.round(e)}ms`})]})]})]}):t.jsxs("div",{className:"flex flex-col gap-4 p-4",children:[t.jsxs("div",{className:`p-4 rounded-xl border ${m}`,children:[t.jsxs("div",{className:"flex items-center gap-2 mb-4",children:[t.jsx(Ee,{size:16,className:o?"text-cyan-500":"text-yellow-500"}),t.jsx("h3",{className:"font-bold "+(o?"text-cyan-400":"text-yellow-400"),children:"FILTER"})]}),t.jsxs("div",{className:"flex flex-wrap gap-6 items-end",children:[t.jsx(I,{value:e.filter.cutoff,min:20,max:1e4,onChange:e=>h({cutoff:e}),label:"Cutoff",color:c,formatValue:e=>`${Math.round(e)}Hz`}),t.jsx(I,{value:e.filter.resonance,min:0,max:100,onChange:e=>h({resonance:e}),label:"Reso",color:c,formatValue:e=>`${Math.round(e)}%`}),t.jsx(I,{value:e.filter.envMod,min:0,max:100,onChange:e=>h({envMod:e}),label:"Env Mod",color:c,formatValue:e=>`${Math.round(e)}%`}),t.jsx(I,{value:e.filter.decay,min:10,max:2e3,onChange:e=>h({decay:e}),label:"F-Decay",color:c,formatValue:e=>`${Math.round(e)}ms`})]})]}),t.jsxs("div",{className:`p-4 rounded-xl border ${m}`,children:[t.jsxs("div",{className:"flex items-center justify-between mb-4",children:[t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx(Be,{size:16,className:o?"text-cyan-500":"text-yellow-500"}),t.jsx("h3",{className:"font-bold "+(o?"text-cyan-400":"text-yellow-400"),children:"MODULATION"})]}),t.jsxs("label",{className:"flex items-center gap-2 cursor-pointer",children:[t.jsx("span",{className:"text-xs text-gray-500",children:"Enable"}),t.jsx("input",{type:"checkbox",checked:e.lfo.enabled,onChange:t=>n({lfo:{...e.lfo,enabled:t.target.checked}}),className:"w-4 h-4 rounded border-2 bg-transparent cursor-pointer "+(o?"border-cyan-500 checked:bg-cyan-500":"border-yellow-500 checked:bg-yellow-500")})]})]}),t.jsxs("div",{className:"flex flex-wrap gap-6 transition-opacity "+(e.lfo.enabled?"opacity-100":"opacity-40 pointer-events-none"),children:[t.jsx(I,{value:e.lfo.rate,min:.1,max:20,onChange:t=>n({lfo:{...e.lfo,rate:t}}),label:"Rate",color:c,formatValue:e=>`${e.toFixed(1)}Hz`}),t.jsx(I,{value:e.lfo.depth,min:0,max:100,onChange:t=>n({lfo:{...e.lfo,depth:t}}),label:"Depth",color:c,formatValue:e=>`${Math.round(e)}%`}),t.jsxs("div",{className:"flex flex-col items-center gap-2",children:[t.jsx("span",{className:"text-[10px] font-bold text-gray-500 uppercase",children:"Target"}),t.jsxs("select",{value:e.lfo.target,onChange:t=>n({lfo:{...e.lfo,target:t.target.value}}),className:"bg-[#151515] border border-gray-700 text-xs text-text-primary rounded px-1 py-0.5",children:[t.jsx("option",{value:"pitch",children:"Pitch"}),t.jsx("option",{value:"filter",children:"Filter"}),t.jsx("option",{value:"both",children:"Both"})]})]}),t.jsxs("div",{className:"flex flex-col items-center gap-2",children:[t.jsx("span",{className:"text-[10px] font-bold text-gray-500 uppercase",children:"Throw"}),t.jsx("button",{onMouseDown:()=>x(!0),onMouseUp:()=>x(!1),onMouseLeave:()=>x(!1),onTouchStart:()=>x(!0),onTouchEnd:()=>x(!1),className:`\n                w-12 h-12 rounded-full flex items-center justify-center transition-all active:scale-95\n                ${o?"bg-cyan-500/20 border-2 border-cyan-500 text-cyan-400":"bg-yellow-500/20 border-2 border-yellow-500 text-yellow-500"}\n                hover:shadow-[0_0_15px_rgba(255,204,0,0.4)]\n              `,title:"Momentary Reverb Throw",children:t.jsx(ht,{size:20})})]})]})]})]})})]})},Mf=({k1:e,k2:a,width:n=160,height:r=64,color:s="#ec4899"})=>{const i=he.useMemo(()=>{const t=[],s=a/255,i=e/255;for(let e=0;e<=40;e++){const a=e/40*n,o=e/40,l=1/(.1+5*Math.abs(o-i)+2*(1-s)),d=r-Math.min(.9,.5*l)*r-5;t.push(`${a},${d}`)}return t.join(" ")},[e,a,n,r]);return t.jsxs("div",{className:"relative bg-black/40 rounded border border-white/5 overflow-hidden",style:{width:n,height:r},children:[t.jsxs("svg",{width:n,height:r,className:"absolute inset-0",children:[t.jsx("path",{d:`M 0,${r} L ${i} L ${n},${r} Z`,fill:`${s}20`,stroke:s,strokeWidth:"2",strokeLinejoin:"round"}),t.jsx("line",{x1:e/255*n,y1:"0",x2:e/255*n,y2:r,stroke:"white",strokeWidth:"1",strokeDasharray:"2,2",opacity:"0.3"})]}),t.jsx("div",{className:"absolute top-1 left-1 text-[7px] text-text-muted font-bold uppercase tracking-tighter",children:"VFX SVF Response"})]})},zf=({handle:e,accentColor:a,knobColor:n,panelBg:r})=>{const s=F.getInstance(),[i,o]=he.useState(0),[l,d]=he.useState(new Array(32).fill(!1)),[c,u]=he.useState({});he.useEffect(()=>{if(0===e)return;const t=setInterval(()=>{const t=[],a=s.read(e,120);for(let r=0;r<32;r++){s.write(e,120,r);const a=s.read(e,0);t.push(!(1&a))}s.write(e,120,a),d(t),s.write(e,120,i);const n={};for(let r=0;r<16;r++)n[r]=s.read(e,r);u(n),s.write(e,120,a)},100);return()=>clearInterval(t)},[s,e,i]);const m=he.useCallback((t,a)=>{if(0===e)return;const n=s.read(e,120);s.write(e,120,i),s.write(e,t,a),s.write(e,120,n)},[s,e,i]),p=he.useCallback(async t=>{const a=t.target.files?.[0];if(!a||0===e)return;const n=await a.arrayBuffer(),r=new Uint8Array(n);s.addMidiEvent(e,r)},[s,e]);return t.jsxs("div",{className:"space-y-4",children:[t.jsxs("div",{className:`p-3 rounded border ${r} flex items-center justify-between`,children:[t.jsxs("div",{className:"flex items-center gap-3",children:[t.jsx("div",{className:"p-2 bg-purple-500/20 rounded",children:t.jsx(Le,{className:"text-purple-400",size:18})}),t.jsxs("div",{children:[t.jsx("h4",{className:"text-xs font-bold uppercase tracking-wider text-text-primary",children:"SysEx Bank Loader"}),t.jsx("p",{className:"text-[9px] text-text-muted",children:"Import original .SYX patches"})]})]}),t.jsxs("label",{className:"cursor-pointer text-[10px] bg-purple-500/10 hover:bg-purple-500/20 text-purple-400 px-3 py-1.5 rounded border border-purple-500/30 transition-colors font-bold uppercase",children:["Load .SYX",t.jsx("input",{type:"file",className:"hidden",accept:".syx",onChange:p})]})]}),t.jsxs("div",{className:"flex items-center gap-2 text-text-secondary",children:[t.jsx(je,{size:16}),t.jsx("span",{className:"text-xs font-bold uppercase text-text-primary",children:"Voice Matrix (32 Oscillators)"})]}),t.jsx("div",{className:`grid grid-cols-8 gap-1 p-2 rounded border ${r}`,children:Array.from({length:32}).map((e,n)=>t.jsxs("button",{onClick:()=>o(n),className:`\n              relative h-8 flex items-center justify-center rounded text-[10px] font-mono transition-all\n              ${i===n?"bg-accent-primary text-black font-bold border-white/50 shadow-lg shadow-accent-primary/20":"bg-dark-bgSecondary/50 text-text-muted hover:bg-dark-bgHover"}\n              border border-transparent\n            `,children:[n.toString().padStart(2,"0"),l[n]&&t.jsx("span",{className:"absolute top-1 right-1 w-1.5 h-1.5 rounded-full animate-pulse",style:{backgroundColor:i===n?"black":a}})]},n))}),t.jsxs("div",{className:`p-4 rounded border ${r} space-y-4`,children:[t.jsxs("div",{className:"flex items-center justify-between border-b border-white/5 pb-2",children:[t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx(qe,{size:14,className:"text-text-muted"}),t.jsxs("span",{className:"text-[10px] font-bold uppercase tracking-widest text-text-secondary",children:["Editing Voice ",i.toString().padStart(2,"0")]})]}),t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx("span",{className:"text-[9px] text-text-muted uppercase font-mono",children:"Status:"}),t.jsx("span",{className:"text-[9px] font-bold font-mono "+(l[i]?"text-green-400":"text-red-400"),children:l[i]?"RUNNING":"STOPPED"})]})]}),t.jsxs("div",{className:"grid grid-cols-4 md:grid-cols-8 gap-4 place-items-center",children:[t.jsx(I,{size:"sm",label:"VOL L",min:0,max:255,value:c[16]||0,onChange:e=>m(16,e),color:n}),t.jsx(I,{size:"sm",label:"VOL R",min:0,max:255,value:c[32]||0,onChange:e=>m(32,e),color:n}),t.jsx(I,{size:"sm",label:"FREQ L",min:0,max:255,value:c[8]||0,onChange:e=>m(8,e),color:n}),t.jsx(I,{size:"sm",label:"FREQ H",min:0,max:255,value:c[9]||0,onChange:e=>m(9,e),color:n}),t.jsx(I,{size:"sm",label:"K1",min:0,max:255,value:c[72]||0,onChange:e=>m(72,e),color:n}),t.jsx(I,{size:"sm",label:"K2",min:0,max:255,value:c[56]||0,onChange:e=>m(56,e),color:n}),t.jsx(I,{size:"sm",label:"ECOUNT",min:0,max:255,value:c[48]||0,onChange:e=>m(48,e),color:n}),t.jsx(I,{size:"sm",label:"CTRL",min:0,max:255,value:c[0]||0,onChange:e=>m(0,e),color:n})]}),t.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[t.jsxs("div",{className:"bg-black/20 p-2 rounded border border-white/5 space-y-1",children:[t.jsx("div",{className:"text-[8px] text-text-muted uppercase font-bold tracking-tighter",children:"Wavetable Offset"}),t.jsxs("div",{className:"flex justify-between text-[10px] font-mono",children:[t.jsx("span",{className:"text-text-muted",children:"START:"}),t.jsxs("span",{className:"text-accent-primary",children:["0x",(c[136]||0).toString(16).toUpperCase().padStart(4,"0")]})]}),t.jsxs("div",{className:"flex justify-between text-[10px] font-mono",children:[t.jsx("span",{className:"text-text-muted",children:"END:"}),t.jsxs("span",{className:"text-accent-primary",children:["0x",(c[144]||0).toString(16).toUpperCase().padStart(4,"0")]})]})]}),t.jsx("div",{className:"flex justify-center",children:t.jsx(Mf,{k1:c[72]||0,k2:c[56]||0,width:180,height:50,color:a})})]})]})]})},Tf=({handle:e,knobColor:a,panelBg:n})=>{const r=F.getInstance(),[s,i]=he.useState(0),[o,l]=he.useState(new Array(32).fill(!1)),[d,c]=he.useState({});he.useEffect(()=>{if(0===e)return;const t=setInterval(()=>{const t=[];for(let n=0;n<32;n++){const a=r.read(e,128+n);t.push(!(1&a))}l(t);const a={};a[0]=r.read(e,0+s),a[32]=r.read(e,32+s),a[64]=r.read(e,64+s),a[128]=r.read(e,128+s),a[160]=r.read(e,160+s),a[192]=r.read(e,192+s),c(a)},100);return()=>clearInterval(t)},[r,e,s]);const u=he.useCallback((t,a)=>{0!==e&&r.write(e,t+s,a)},[r,e,s]);return t.jsxs("div",{className:"space-y-4",children:[t.jsxs("div",{className:"flex items-center gap-2 text-text-secondary",children:[t.jsx(je,{size:16}),t.jsx("span",{className:"text-xs font-bold uppercase text-text-primary",children:"DOC Oscillator Matrix (32 Voices)"})]}),t.jsx("div",{className:`grid grid-cols-8 gap-1 p-2 rounded border ${n}`,children:Array.from({length:32}).map((e,a)=>t.jsxs("button",{onClick:()=>i(a),className:`\n              relative h-8 flex items-center justify-center rounded text-[10px] font-mono transition-all\n              ${s===a?"bg-amber-500 text-black font-bold border-white/50 shadow-lg shadow-amber-500/20":"bg-dark-bgSecondary/50 text-text-muted hover:bg-dark-bgHover"}\n              border border-transparent\n            `,children:[a.toString().padStart(2,"0"),o[a]&&t.jsx("span",{className:"absolute top-1 right-1 w-1.5 h-1.5 rounded-full animate-pulse bg-amber-400"})]},a))}),t.jsxs("div",{className:`p-4 rounded border ${n} space-y-4 shadow-inner`,children:[t.jsxs("div",{className:"flex items-center justify-between border-b border-white/5 pb-2",children:[t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx(qe,{size:14,className:"text-text-muted"}),t.jsxs("span",{className:"text-[10px] font-bold uppercase tracking-widest text-text-secondary",children:["Editing Oscillator ",s.toString().padStart(2,"0")]})]}),t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx("span",{className:"text-[9px] text-text-muted uppercase font-mono",children:"Status:"}),t.jsx("span",{className:"text-[9px] font-bold font-mono "+(o[s]?"text-green-400":"text-red-400"),children:o[s]?"RUNNING":"HALTED"})]})]}),t.jsxs("div",{className:"grid grid-cols-4 md:grid-cols-6 gap-4 place-items-center",children:[t.jsx(I,{size:"sm",label:"FREQ L",min:0,max:255,value:d[0]||0,onChange:e=>u(0,e),color:a}),t.jsx(I,{size:"sm",label:"FREQ H",min:0,max:255,value:d[32]||0,onChange:e=>u(32,e),color:a}),t.jsx(I,{size:"sm",label:"VOLUME",min:0,max:255,value:d[64]||0,onChange:e=>u(64,e),color:a}),t.jsx(I,{size:"sm",label:"CTRL",min:0,max:255,value:d[128]||0,onChange:e=>u(128,e),color:a}),t.jsx(I,{size:"sm",label:"W-SIZE",min:0,max:255,value:d[160]||0,onChange:e=>u(160,e),color:a}),t.jsx(I,{size:"sm",label:"W-PTR",min:0,max:255,value:d[192]||0,onChange:e=>u(192,e),color:a})]}),t.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[t.jsxs("div",{className:"bg-black/20 p-2 rounded border border-white/5 space-y-1",children:[t.jsx("div",{className:"text-[8px] text-text-muted uppercase font-bold tracking-tighter",children:"Register State (HEX)"}),t.jsxs("div",{className:"flex justify-between text-[10px] font-mono",children:[t.jsx("span",{className:"text-text-muted",children:"FREQ:"}),t.jsxs("span",{className:"text-amber-400",children:["0x",(d[32]||0).toString(16).toUpperCase().padStart(2,"0"),(d[0]||0).toString(16).toUpperCase().padStart(2,"0")]})]}),t.jsxs("div",{className:"flex justify-between text-[10px] font-mono",children:[t.jsx("span",{className:"text-text-muted",children:"WAVE:"}),t.jsxs("span",{className:"text-amber-400",children:["PTR: 0x",(d[192]||0).toString(16).toUpperCase().padStart(2,"0")," | SZ: 0x",(d[160]||0).toString(16).toUpperCase().padStart(2,"0")]})]})]}),t.jsxs("div",{className:"bg-black/20 p-2 rounded border border-white/5 flex flex-col justify-center italic text-[9px] text-text-muted",children:[t.jsx("div",{children:"• ES5503 (DOC) - Gritty 8-bit wavetable engine."}),t.jsx("div",{children:"• HALT bit must be cleared (0) for audio to play."})]})]})]})]})},Ef=({handle:e,knobColor:a,panelBg:n})=>{const r=F.getInstance(),[s,i]=he.useState(0),[o,l]=he.useState(0),[d,c]=he.useState(new Array(16).fill(!1)),[u,m]=he.useState({}),[p,h]=he.useState({});he.useEffect(()=>{if(0===e)return;const t=setInterval(()=>{const t=[];for(let s=0;s<16;s++){const a=256*s+0,n=r.read(e,a+5);t.push(n>0)}c(t);const a={},n=256*s+16*o;for(let s=0;s<8;s++)a[s]=r.read(e,n+s);m(a)},100);return()=>clearInterval(t)},[r,e,s,o]);const f=he.useCallback((t,a)=>{if(0===e)return;const n=256*s+16*o;r.write(e,n+t,a)},[r,e,s,o]),x=he.useCallback(async(t,a)=>{const n=t.target.files?.[0];if(!n)return;const s=await n.arrayBuffer(),i=new Uint8Array(s),o={...p,[a]:i};h(o),o.ic5&&o.ic6&&o.ic7&&r.rsaLoadRoms(e,o.ic5,o.ic6,o.ic7)},[r,e,p]);return t.jsxs("div",{className:"space-y-4",children:[t.jsxs("div",{className:`p-4 border rounded ${n} space-y-3`,children:[t.jsxs("div",{className:"flex items-center gap-2 text-text-secondary",children:[t.jsx(vt,{size:16}),t.jsx("span",{className:"text-xs font-bold uppercase text-text-primary",children:"Roland SA Sample ROMs"})]}),t.jsx("div",{className:"grid grid-cols-3 gap-2",children:["ic5","ic6","ic7"].map(e=>{const a=!!p[e];return t.jsxs("label",{className:`\n                flex flex-col items-center justify-center p-2 rounded border border-dashed transition-all cursor-pointer\n                ${a?"bg-sky-500/10 border-sky-500/50":"bg-dark-bgSecondary/50 border-dark-border hover:border-text-muted"}\n              `,children:[t.jsx("span",{className:"text-[9px] font-bold "+(a?"text-sky-400":"text-text-muted"),children:e.toUpperCase()}),t.jsx("span",{className:"text-[8px] text-text-muted",children:a?"READY":"UPLOAD"}),t.jsx("input",{type:"file",className:"hidden",onChange:t=>x(t,e)})]},e)})}),!(p.ic5&&p.ic6&&p.ic7)&&t.jsx("p",{className:"text-[8px] text-text-muted italic",children:"Note: RSA engine requires all 3 ROMs (MKS-20 set) to produce sound."})]}),t.jsxs("div",{className:"flex items-center gap-2 text-text-secondary",children:[t.jsx(je,{size:16}),t.jsx("span",{className:"text-xs font-bold uppercase text-text-primary",children:"Roland SA Voice Matrix (16 Voices / 10 Parts)"})]}),t.jsx("div",{className:`grid grid-cols-8 gap-1 p-2 rounded border ${n}`,children:Array.from({length:16}).map((e,a)=>t.jsxs("button",{onClick:()=>i(a),className:`\n              relative h-8 flex items-center justify-center rounded text-[10px] font-mono transition-all\n              ${s===a?"bg-sky-500 text-black font-bold border-white/50 shadow-lg shadow-sky-500/20":"bg-dark-bgSecondary/50 text-text-muted hover:bg-dark-bgHover"}\n              border border-transparent\n            `,children:["V",a.toString().padStart(2,"0"),d[a]&&t.jsx("span",{className:"absolute top-1 right-1 w-1.5 h-1.5 rounded-full animate-pulse bg-sky-400"})]},a))}),t.jsx("div",{className:"flex items-center gap-1 overflow-x-auto pb-1",children:Array.from({length:10}).map((e,a)=>t.jsxs("button",{onClick:()=>l(a),className:`\n              px-2 py-1 rounded text-[9px] font-bold uppercase transition-all\n              ${o===a?"bg-sky-500/20 text-sky-400 border border-sky-500/30":"bg-dark-bgSecondary text-text-muted hover:text-text-primary"}\n            `,children:["PART ",a]},a))}),t.jsxs("div",{className:`p-4 rounded border ${n} space-y-4 shadow-inner`,children:[t.jsx("div",{className:"flex items-center justify-between border-b border-white/5 pb-2",children:t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx(qe,{size:14,className:"text-text-muted"}),t.jsxs("span",{className:"text-[10px] font-bold uppercase tracking-widest text-text-secondary",children:["Voice ",s," | Part ",o," Parameters"]})]})}),t.jsxs("div",{className:"grid grid-cols-4 md:grid-cols-7 gap-4 place-items-center",children:[t.jsx(I,{size:"sm",label:"PITCH L",min:0,max:255,value:u[0]||0,onChange:e=>f(0,e),color:a}),t.jsx(I,{size:"sm",label:"PITCH H",min:0,max:255,value:u[1]||0,onChange:e=>f(1,e),color:a}),t.jsx(I,{size:"sm",label:"W-LOOP",min:0,max:255,value:u[2]||0,onChange:e=>f(2,e),color:a}),t.jsx(I,{size:"sm",label:"W-HIGH",min:0,max:255,value:u[3]||0,onChange:e=>f(3,e),color:a}),t.jsx(I,{size:"sm",label:"E-DEST",min:0,max:255,value:u[4]||0,onChange:e=>f(4,e),color:a}),t.jsx(I,{size:"sm",label:"E-SPD",min:0,max:255,value:u[5]||0,onChange:e=>f(5,e),color:a}),t.jsx(I,{size:"sm",label:"E-OFFS",min:0,max:255,value:u[7]||0,onChange:e=>f(7,e),color:a})]}),t.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[t.jsxs("div",{className:"bg-black/20 p-2 rounded border border-white/5 space-y-1",children:[t.jsx("div",{className:"text-[8px] text-text-muted uppercase font-bold tracking-tighter",children:"Hardware Info (SA Engine)"}),t.jsxs("div",{className:"flex justify-between text-[10px] font-mono",children:[t.jsx("span",{className:"text-text-muted",children:"PITCH:"}),t.jsxs("span",{className:"text-sky-400",children:["0x",(u[1]||0).toString(16).toUpperCase().padStart(2,"0"),(u[0]||0).toString(16).toUpperCase().padStart(2,"0")]})]}),t.jsxs("div",{className:"flex justify-between text-[10px] font-mono",children:[t.jsx("span",{className:"text-text-muted",children:"WAVE:"}),t.jsxs("span",{className:"text-sky-400",children:["HI: 0x",(u[3]||0).toString(16).toUpperCase().padStart(2,"0")," | LP: 0x",(u[2]||0).toString(16).toUpperCase().padStart(2,"0")]})]})]}),t.jsxs("div",{className:"bg-black/20 p-2 rounded border border-white/5 flex flex-col justify-center italic text-[9px] text-text-muted",children:[t.jsx("div",{children:"• Structured Adaptive (SA) - Ultra-accurate 80s piano synthesis."}),t.jsx("div",{children:'• Each voice is composed of 10 "Parts" (harmonic components).'})]})]})]})]})},Af={vfx:"vfx.zip (or fsd1.zip)",doc:"esq1.zip (or csd1.zip)",rsa:"mks20.zip",swp30:"mu100.zip (swp30 ROMs)"},If=({config:e,handle:a,onChange:n})=>{const r=F.getInstance(),s=Af[e.type]||"roms.zip",i="swp30"===e.type?64:"rsa"===e.type?16:32,o=he.useRef(e);o.current=e;const l="cyan-lineart"===B(e=>e.currentThemeId),d=l?"#00ffff":"#ff4444",c=l?"#00ffff":"#ff8888",u=l?"bg-[#051515] border-cyan-900/50":"bg-[#1a1a1a] border-gray-800",m=he.useCallback(async(e,t)=>{const a=e.target.files?.[0];if(a)if(a.name.toLowerCase().endsWith(".zip"))try{const e=new W,s=await e.loadAsync(a),i=[];s.forEach((e,t)=>{const a=e.toLowerCase().match(/\.(txt|md|txt|pdf|url|inf)$/);t.dir||a||i.push({name:e,entry:t})}),i.sort((e,t)=>e.name.localeCompare(t.name,void 0,{numeric:!0,sensitivity:"base"}));for(let a=0;a<i.length;a++){const e=t+a,n=await i[a].entry.async("uint8array");r.setRom(e,n)}n({romsLoaded:!0})}catch(s){}else{const e=await a.arrayBuffer(),s=new Uint8Array(e);r.setRom(t,s),n({romsLoaded:!0})}},[r,n]),p=he.useCallback((e,t)=>{if(0===a)return;r.write(a,e,t);const s={...o.current.registers,[e]:t};n({registers:s})},[a,r,n]);return t.jsxs("div",{className:"space-y-6",children:[t.jsxs("div",{className:`flex items-center justify-between p-3 rounded border ${u}`,children:[t.jsxs("div",{className:"flex items-center gap-3",children:[t.jsx("div",{className:"p-2 bg-accent-primary/20 rounded",children:t.jsx(Ue,{style:{color:d},size:20})}),t.jsxs("div",{children:[t.jsxs("h3",{className:"text-sm font-bold uppercase tracking-wider text-text-primary",children:["MAME ",e.type.toUpperCase()," ENGINE"]}),t.jsx("p",{className:"text-[10px] text-text-muted",children:"vfx"===e.type?"ES5506 (OTTO) 32-Voice Wavetable":"doc"===e.type?"ES5503 (DOC) 32-Voice Wavetable":"swp30"===e.type?"Yamaha SWP30 (AWM2) ROMpler/DSP":"Roland SA CPU-B Synthesis"})]})]}),t.jsxs("div",{className:"flex items-center gap-2 px-2 py-1 rounded text-[10px] font-mono "+(e.romsLoaded?"bg-green-500/20 text-green-400":"bg-red-500/20 text-red-400"),children:[t.jsx(wt,{size:12}),e.romsLoaded?"ROMS READY":"ROMS MISSING"]})]}),t.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[t.jsxs("div",{className:`p-4 border rounded ${u}`,children:[t.jsxs("div",{className:"flex items-center justify-between mb-1 text-text-secondary",children:[t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx(vt,{size:16}),t.jsx("span",{className:"text-xs font-bold uppercase",children:"ROM Banks"})]}),t.jsxs("label",{className:"cursor-pointer text-[10px] bg-accent-primary/10 hover:bg-accent-primary/20 text-accent-primary px-2 py-1 rounded border border-accent-primary/30 transition-colors",children:["UPLOAD ZIP",t.jsx("input",{type:"file",className:"hidden",accept:".zip",onChange:e=>m(e,0)})]})]}),t.jsxs("div",{className:"text-[9px] text-text-muted mb-3 flex items-center gap-1",children:[t.jsx(wt,{size:10}),"EXPECTS: ",t.jsx("span",{className:"font-mono",style:{color:d},children:s})]}),t.jsx("div",{className:"space-y-2",children:[0,1,2,3].map(e=>t.jsxs("div",{className:"flex items-center justify-between text-[10px]",children:[t.jsxs("span",{className:"text-text-muted",children:["BANK ",e]}),t.jsxs("label",{className:"cursor-pointer hover:underline",style:{color:d},children:["UPLOAD",t.jsx("input",{type:"file",className:"hidden",onChange:t=>m(t,e)})]})]},e))})]}),t.jsxs("div",{className:`p-4 border rounded ${u}`,children:[t.jsxs("div",{className:"flex items-center gap-2 mb-3 text-text-secondary",children:[t.jsx(Ee,{size:16}),t.jsx("span",{className:"text-xs font-bold uppercase",children:"Status"})]}),t.jsxs("div",{className:"space-y-1 font-mono text-[10px]",children:[t.jsxs("div",{className:"flex justify-between",children:[t.jsx("span",{className:"text-text-muted",children:"CLOCK"}),t.jsxs("span",{className:"text-text-primary",children:[(e.clock/1e6).toFixed(2)," MHz"]})]}),t.jsxs("div",{className:"flex justify-between",children:[t.jsx("span",{className:"text-text-muted",children:"VOICES"}),t.jsx("span",{className:"text-text-primary",children:i})]}),t.jsxs("div",{className:"flex justify-between",children:[t.jsx("span",{className:"text-text-muted",children:"ACCURACY"}),t.jsx("span",{className:"text-accent-primary",children:"SAMPLE PERFECT"})]})]})]})]}),"vfx"===e.type&&t.jsxs("div",{className:"space-y-4",children:[t.jsxs("div",{className:"flex items-center gap-2 text-text-secondary",children:[t.jsx(xe,{size:16}),t.jsx("span",{className:"text-xs font-bold uppercase",children:"Common Registers"})]}),t.jsxs("div",{className:"grid grid-cols-4 md:grid-cols-8 gap-4 place-items-center",children:[t.jsx(I,{size:"sm",label:"PAGE",min:0,max:255,value:e.registers[0]||0,onChange:e=>p(0,e),color:c}),t.jsx(I,{size:"sm",label:"ACTIVE",min:0,max:31,value:e.registers[1]||31,onChange:e=>p(1,e),color:c}),t.jsx(I,{size:"sm",label:"MODE",min:0,max:255,value:e.registers[2]||0,onChange:e=>p(2,e),color:c})]}),t.jsx("p",{className:"text-[9px] text-text-muted italic p-2 rounded bg-black/20",children:"Note: You are directly editing the Ensoniq OTTO registers. Consult the ES5506 datasheet for mapping."})]}),"vfx"===e.type&&0!==a&&t.jsx(zf,{handle:a,accentColor:d,knobColor:c,panelBg:u}),"doc"===e.type&&0!==a&&t.jsx(Tf,{handle:a,knobColor:c,panelBg:u}),"rsa"===e.type&&0!==a&&t.jsx(Ef,{handle:a,knobColor:c,panelBg:u}),t.jsxs("div",{className:"space-y-3",children:[t.jsxs("div",{className:"flex items-center gap-2 text-text-secondary",children:[t.jsx(Ee,{size:16}),t.jsx("span",{className:"text-xs font-bold uppercase",children:"Register Live View (HEX)"})]}),t.jsx("div",{className:"grid grid-cols-8 md:grid-cols-16 gap-1 p-2 bg-black/40 rounded border border-dark-border font-mono text-[9px]",children:Array.from({length:32}).map((e,n)=>{const s=0!==a?r.read(a,n):0;return t.jsxs("div",{className:"flex flex-col items-center p-1 bg-dark-bgSecondary/30 rounded",children:[t.jsx("span",{className:"text-text-muted mb-1",children:n.toString(16).toUpperCase().padStart(2,"0")}),t.jsx("span",{style:{color:d},children:s.toString(16).toUpperCase().padStart(2,"0")})]},n)})})]})]})},Of={MAMEAstrocade:{synthType:"MAMEAstrocade",name:"Astrocade",subtitle:"Bally Astrocade Custom I/O (1977)",color:"#a855f7",presetCount:8,presetNames:["Clean Square","Vibrato Square","Wide Vibrato","Fast Vibrato","Noise+Tone","Noise Modulated","Arcade Siren","Pure Noise"],parameters:[{key:"volume",label:"Volume",group:"Output",type:"knob",min:0,max:1,step:.01,default:.8,formatValue:"percent"},{key:"vibrato_speed",label:"Vibrato Speed",group:"Vibrato",type:"select",min:0,max:3,default:0,formatValue:"int",options:[{value:0,label:"Fastest"},{value:1,label:"Fast"},{value:2,label:"Slow"},{value:3,label:"Slowest"}]},{key:"vibrato_depth",label:"Vibrato Depth",group:"Vibrato",type:"knob",min:0,max:63,step:1,default:0,formatValue:"int"},{key:"noise_am",label:"Noise AM",group:"Noise",type:"toggle",min:0,max:1,default:0},{key:"noise_mod",label:"Noise Mod",group:"Noise",type:"toggle",min:0,max:1,default:0},{key:"noise_vol",label:"Noise Volume",group:"Noise",type:"knob",min:0,max:255,step:1,default:0,formatValue:"int"},{key:"master_freq",label:"Master Freq",group:"Oscillator",type:"knob",min:0,max:1,step:.01,default:.5,formatValue:"percent"},{key:"stereo_width",label:"Stereo Width",group:"Output",type:"knob",min:0,max:1,step:.01,default:.5,formatValue:"percent"}]},MAMESN76477:{synthType:"MAMESN76477",name:"SN76477",subtitle:"TI Complex Sound Generator (1978)",color:"#ef4444",presetCount:5,presetNames:["UFO","Laser","Explosion","Siren","Engine"],parameters:[{key:"vco_freq",label:"VCO Freq",group:"VCO",type:"knob",min:0,max:1,step:.01,default:.5,formatValue:"percent"},{key:"slf_freq",label:"SLF Freq",group:"SLF",type:"knob",min:0,max:1,step:.01,default:.5,formatValue:"percent"},{key:"noise_freq",label:"Noise Freq",group:"Noise",type:"knob",min:0,max:1,step:.01,default:.5,formatValue:"percent"},{key:"vco_duty_cycle",label:"VCO Duty",group:"VCO",type:"knob",min:.18,max:1,step:.01,default:.5,formatValue:"percent"},{key:"mixer_mode",label:"Mixer Mode",group:"Mixer",type:"select",min:0,max:7,default:0,formatValue:"int",options:[{value:0,label:"VCO"},{value:1,label:"SLF"},{value:2,label:"Noise"},{value:3,label:"VCO+Noise"},{value:4,label:"SLF+Noise"},{value:5,label:"SLF+VCO+Noise"},{value:6,label:"SLF+VCO"},{value:7,label:"Inhibit"}]},{key:"envelope_mode",label:"Envelope Mode",group:"Envelope",type:"select",min:0,max:3,default:0,formatValue:"int",options:[{value:0,label:"VCO"},{value:1,label:"One-Shot"},{value:2,label:"Mixer Only"},{value:3,label:"VCO Alt"}]},{key:"attack_time",label:"Attack",group:"Envelope",type:"knob",min:.001,max:10,step:.001,default:.1,unit:"s",formatValue:"seconds",logarithmic:!0},{key:"decay_time",label:"Decay",group:"Envelope",type:"knob",min:.001,max:10,step:.001,default:.5,unit:"s",formatValue:"seconds",logarithmic:!0},{key:"one_shot_time",label:"One-Shot",group:"Envelope",type:"knob",min:.001,max:10,step:.001,default:.2,unit:"s",formatValue:"seconds",logarithmic:!0},{key:"noise_filter_freq",label:"Noise Filter",group:"Noise",type:"knob",min:0,max:1,step:.01,default:.5,formatValue:"percent"},{key:"amplitude",label:"Amplitude",group:"Output",type:"knob",min:0,max:1,step:.01,default:.8,formatValue:"percent"},{key:"vco_mode",label:"VCO Mode",group:"VCO",type:"select",min:0,max:1,default:0,formatValue:"int",options:[{value:0,label:"External"},{value:1,label:"SLF Modulates"}]},{key:"enable",label:"Enable",group:"Output",type:"toggle",min:0,max:1,default:0}]},MAMEASC:{synthType:"MAMEASC",name:"ASC",subtitle:"Apple Sound Chip (1987)",color:"#10b981",presetCount:8,presetNames:["Sine Pad","Triangle Lead","Saw Bass","Square Retro","Pulse Nasal","Organ","Piano","Strings"],parameters:[{key:"volume",label:"Volume",group:"Output",type:"knob",min:0,max:1,step:.01,default:.8,formatValue:"percent"},{key:"waveform",label:"Waveform",group:"Oscillator",type:"select",min:0,max:7,default:0,formatValue:"int",options:[{value:0,label:"Sine"},{value:1,label:"Saw"},{value:2,label:"Square"},{value:3,label:"Triangle"},{value:4,label:"Noise"},{value:5,label:"Pulse 25%"},{value:6,label:"Organ"},{value:7,label:"Random"}]},{key:"attack",label:"Attack",group:"Envelope",type:"knob",min:0,max:1,step:.01,default:.01,formatValue:"percent"},{key:"decay",label:"Decay",group:"Envelope",type:"knob",min:0,max:1,step:.01,default:.3,formatValue:"percent"},{key:"sustain",label:"Sustain",group:"Envelope",type:"knob",min:0,max:1,step:.01,default:.7,formatValue:"percent"},{key:"release",label:"Release",group:"Envelope",type:"knob",min:0,max:1,step:.01,default:.3,formatValue:"percent"},{key:"stereo_width",label:"Stereo Width",group:"Output",type:"knob",min:0,max:1,step:.01,default:.5,formatValue:"percent"},{key:"detune",label:"Detune",group:"Oscillator",type:"knob",min:0,max:1,step:.01,default:0,formatValue:"percent"}]},MAMEES5503:{synthType:"MAMEES5503",name:"ES5503",subtitle:"Ensoniq DOC 32-Voice Wavetable (1986)",color:"#3b82f6",presetCount:0,parameters:[{key:"waveform",label:"Waveform",group:"Oscillator",type:"select",min:0,max:7,default:0,formatValue:"int",options:[{value:0,label:"Sine"},{value:1,label:"Saw"},{value:2,label:"Square"},{value:3,label:"Triangle"},{value:4,label:"Noise"},{value:5,label:"Pulse 25%"},{value:6,label:"Pulse 12%"},{value:7,label:"Organ"}]},{key:"wave_size",label:"Wave Size",group:"Oscillator",type:"select",min:0,max:7,default:2,formatValue:"int",options:[{value:0,label:"256"},{value:1,label:"512"},{value:2,label:"1024"},{value:3,label:"2048"},{value:4,label:"4096"},{value:5,label:"8192"},{value:6,label:"16384"},{value:7,label:"32768"}]},{key:"resolution",label:"Resolution",group:"Oscillator",type:"select",min:0,max:7,default:7,formatValue:"int",options:[{value:0,label:"Coarse"},{value:1,label:"1"},{value:2,label:"2"},{value:3,label:"3"},{value:4,label:"4"},{value:5,label:"5"},{value:6,label:"6"},{value:7,label:"Fine"}]},{key:"osc_mode",label:"Osc Mode",group:"Oscillator",type:"select",min:0,max:3,default:0,formatValue:"int",options:[{value:0,label:"Free Run"},{value:1,label:"One Shot"},{value:2,label:"Sync/AM"},{value:3,label:"Swap"}]},{key:"volume",label:"Volume",group:"Output",type:"knob",min:0,max:1,step:.01,default:.8,formatValue:"percent"},{key:"num_oscillators",label:"Oscillators",group:"Oscillator",type:"knob",min:1,max:32,step:1,default:8,formatValue:"int"},{key:"attack_time",label:"Attack",group:"Envelope",type:"knob",min:.001,max:5,step:.001,default:.01,unit:"s",formatValue:"seconds",logarithmic:!0},{key:"release_time",label:"Release",group:"Envelope",type:"knob",min:.001,max:5,step:.001,default:.3,unit:"s",formatValue:"seconds",logarithmic:!0}]},MAMEMEA8000:{synthType:"MAMEMEA8000",name:"MEA8000",subtitle:"Philips MEA8000 LPC Speech Synthesizer",color:"#f59e0b",presetCount:8,presetNames:["AH","EE","IH","OH","OO","AE","UH","ER"],parameters:[{key:"volume",label:"Volume",group:"Output",type:"knob",min:0,max:1,step:.01,default:.8,formatValue:"percent"},{key:"noise_mode",label:"Noise Mode",group:"Excitation",type:"toggle",min:0,max:1,default:0},{key:"f1_index",label:"F1 Index",group:"Formants",type:"knob",min:0,max:7,step:1,default:3,formatValue:"int"},{key:"f2_index",label:"F2 Index",group:"Formants",type:"knob",min:0,max:7,step:1,default:4,formatValue:"int"},{key:"f3_index",label:"F3 Index",group:"Formants",type:"knob",min:0,max:7,step:1,default:5,formatValue:"int"},{key:"bw_index",label:"Bandwidth",group:"Formants",type:"select",min:0,max:3,default:0,formatValue:"int",options:[{value:0,label:"Wide (726Hz)"},{value:1,label:"Medium (309Hz)"},{value:2,label:"Narrow (125Hz)"},{value:3,label:"V.Narrow (50Hz)"}]},{key:"amplitude",label:"Amplitude",group:"Output",type:"knob",min:0,max:1,step:.01,default:.8,formatValue:"percent"},{key:"stereo_width",label:"Stereo Width",group:"Output",type:"knob",min:0,max:1,step:.01,default:.5,formatValue:"percent"},{key:"interp_time",label:"Interp Time",group:"Formants",type:"knob",min:.1,max:10,step:.1,default:1,unit:"s",formatValue:"seconds",logarithmic:!0}]},MAMEMSM5232:{synthType:"MAMEMSM5232",name:"MSM5232",subtitle:"OKI MSM5232 8-Voice Organ",color:"#8b5cf6",presetCount:8,presetNames:["Full Organ","Flute 8'","Principal 16'","Piccolo","Percussive","Strings","Noise Perc","Bass 16'"],parameters:[{key:"volume",label:"Volume",group:"Output",type:"knob",min:0,max:1,step:.01,default:.8,formatValue:"percent"},{key:"feet_mix",label:"Feet Mix",group:"Voicing",type:"select",min:0,max:3,default:0,formatValue:"int",options:[{value:0,label:"All Feet"},{value:1,label:"8'+16'"},{value:2,label:"8' Only"},{value:3,label:"16' Only"}]},{key:"attack_rate",label:"Attack Rate",group:"Envelope",type:"knob",min:0,max:7,step:1,default:4,formatValue:"int"},{key:"decay_rate",label:"Decay Rate",group:"Envelope",type:"knob",min:0,max:15,step:1,default:8,formatValue:"int"},{key:"noise_enable",label:"Noise",group:"Voicing",type:"toggle",min:0,max:1,default:0},{key:"stereo_width",label:"Stereo Width",group:"Output",type:"knob",min:0,max:1,step:.01,default:.5,formatValue:"percent"},{key:"reverb",label:"Reverb",group:"Output",type:"knob",min:0,max:1,step:.01,default:0,formatValue:"percent"},{key:"arm_mode",label:"ARM Mode",group:"Voicing",type:"toggle",min:0,max:1,default:0}]},MAMESNKWave:{synthType:"MAMESNKWave",name:"SNK Wave",subtitle:"SNK Programmable Waveform Generator",color:"#06b6d4",presetCount:8,presetNames:["Sine","Sawtooth","Square","Triangle","Pulse 25%","Organ","Buzz","Soft Bell"],parameters:[{key:"volume",label:"Volume",group:"Output",type:"knob",min:0,max:1,step:.01,default:.8,formatValue:"percent"},{key:"waveform",label:"Waveform",group:"Oscillator",type:"select",min:0,max:7,default:0,formatValue:"int",options:[{value:0,label:"Sine"},{value:1,label:"Saw"},{value:2,label:"Square"},{value:3,label:"Triangle"},{value:4,label:"Pulse 25%"},{value:5,label:"Organ"},{value:6,label:"Buzz"},{value:7,label:"Soft Bell"}]},{key:"stereo_width",label:"Stereo Width",group:"Output",type:"knob",min:0,max:1,step:.01,default:.5,formatValue:"percent"},{key:"detune",label:"Detune",group:"Oscillator",type:"knob",min:0,max:1,step:.01,default:0,formatValue:"percent"}]},MAMESP0250:{synthType:"MAMESP0250",name:"SP0250",subtitle:"GI SP0250 Digital LPC Speech Synthesizer",color:"#f97316",presetCount:8,presetNames:["AH","EE","IH","OH","OO","NN","ZZ","HH"],parameters:[{key:"volume",label:"Volume",group:"Output",type:"knob",min:0,max:1,step:.01,default:.8,formatValue:"percent"},{key:"vowel",label:"Vowel",group:"Formants",type:"select",min:0,max:7,default:0,formatValue:"int",options:[{value:0,label:"AH"},{value:1,label:"EE"},{value:2,label:"IH"},{value:3,label:"OH"},{value:4,label:"OO"},{value:5,label:"NN"},{value:6,label:"ZZ"},{value:7,label:"HH"}]},{key:"voiced",label:"Voiced",group:"Excitation",type:"toggle",min:0,max:1,default:1},{key:"brightness",label:"Brightness",group:"Formants",type:"knob",min:0,max:1,step:.01,default:.5,formatValue:"percent"},{key:"stereo_width",label:"Stereo Width",group:"Output",type:"knob",min:0,max:1,step:.01,default:.5,formatValue:"percent"},{key:"filter_mix",label:"Filter Mix",group:"Formants",type:"knob",min:0,max:1,step:.01,default:.5,formatValue:"percent"}]},MAMETMS36XX:{synthType:"MAMETMS36XX",name:"TMS36XX",subtitle:"TI TMS36XX Tone Matrix Organ",color:"#84cc16",presetCount:8,presetNames:["Full Organ","Flute 8'","Principal","Mixture","Foundation","Bright","Diapason","Percussive"],parameters:[{key:"volume",label:"Volume",group:"Output",type:"knob",min:0,max:1,step:.01,default:.8,formatValue:"percent"},{key:"stop_enable",label:"Stop Enable",group:"Voicing",type:"knob",min:0,max:63,step:1,default:63,formatValue:"int"},{key:"decay_rate",label:"Decay Rate",group:"Envelope",type:"knob",min:0,max:1,step:.01,default:.5,formatValue:"percent"},{key:"octave",label:"Octave",group:"Oscillator",type:"knob",min:-2,max:2,step:1,default:0,formatValue:"int",bipolar:!0},{key:"stereo_width",label:"Stereo Width",group:"Output",type:"knob",min:0,max:1,step:.01,default:.5,formatValue:"percent"},{key:"detune",label:"Detune",group:"Oscillator",type:"knob",min:0,max:1,step:.01,default:0,formatValue:"percent"}]},MAMEVotrax:{synthType:"MAMEVotrax",name:"Votrax SC-01",subtitle:"Votrax SC-01 Formant Speech (64 Phonemes)",color:"#ec4899",presetCount:8,presetNames:["AH","EE","OH","OO","SH","ZH","NG","PA"],parameters:[{key:"volume",label:"Volume",group:"Output",type:"knob",min:0,max:1,step:.01,default:.8,formatValue:"percent"},{key:"phoneme",label:"Phoneme",group:"Speech",type:"knob",min:0,max:63,step:1,default:0,formatValue:"int"},{key:"inflection",label:"Inflection",group:"Speech",type:"select",min:0,max:3,default:0,formatValue:"int",options:[{value:0,label:"Normal"},{value:1,label:"Rising"},{value:2,label:"Falling"},{value:3,label:"Emphasis"}]},{key:"f1_override",label:"F1 Override",group:"Formants",type:"knob",min:-1,max:15,step:1,default:-1,formatValue:"int"},{key:"f2_override",label:"F2 Override",group:"Formants",type:"knob",min:-1,max:15,step:1,default:-1,formatValue:"int"},{key:"f3_override",label:"F3 Override",group:"Formants",type:"knob",min:-1,max:15,step:1,default:-1,formatValue:"int"},{key:"stereo_width",label:"Stereo Width",group:"Output",type:"knob",min:0,max:1,step:.01,default:.5,formatValue:"percent"}]},MAMEYMOPQ:{synthType:"MAMEYMOPQ",name:"YM3806 OPQ",subtitle:"Yamaha YM3806 4-Operator FM Synthesizer",color:"#3b82f6",presetCount:8,presetNames:["E.Piano","Brass","Strings","Bass","Organ","Lead","Pad","Bell"],operatorCount:4,parameters:[{key:"algorithm",label:"Algorithm",group:"FM",type:"select",min:0,max:7,default:0,formatValue:"int",options:[{value:0,label:"Serial"},{value:1,label:"(1+2)->3->4"},{value:2,label:"(1+(2->3))->4"},{value:3,label:"((1->2)+3)->4"},{value:4,label:"Dual Serial"},{value:5,label:"Branching"},{value:6,label:"(1->2)+3+4"},{value:7,label:"All Carriers"}]},{key:"feedback",label:"Feedback",group:"FM",type:"knob",min:0,max:7,step:1,default:0,formatValue:"int"},{key:"lfo_rate",label:"LFO Rate",group:"LFO",type:"knob",min:0,max:7,step:1,default:0,formatValue:"int"},{key:"lfo_pm_sens",label:"LFO PM Sens",group:"LFO",type:"knob",min:0,max:7,step:1,default:0,formatValue:"int"},{key:"lfo_am_sens",label:"LFO AM Sens",group:"LFO",type:"knob",min:0,max:3,step:1,default:0,formatValue:"int"},{key:"reverb",label:"Reverb",group:"Output",type:"knob",min:0,max:1,step:.01,default:0,formatValue:"percent"},{key:"volume",label:"Volume",group:"Output",type:"knob",min:0,max:1,step:.01,default:.8,formatValue:"percent"}],operatorParams:[{key:"total_level",label:"Total Level",group:"Operator",type:"knob",min:0,max:127,step:1,default:0,formatValue:"int"},{key:"attack_rate",label:"Attack Rate",group:"Operator",type:"knob",min:0,max:31,step:1,default:31,formatValue:"int"},{key:"decay_rate",label:"Decay Rate",group:"Operator",type:"knob",min:0,max:31,step:1,default:0,formatValue:"int"},{key:"sustain_rate",label:"Sustain Rate",group:"Operator",type:"knob",min:0,max:31,step:1,default:0,formatValue:"int"},{key:"sustain_level",label:"Sustain Level",group:"Operator",type:"knob",min:0,max:15,step:1,default:0,formatValue:"int"},{key:"release_rate",label:"Release Rate",group:"Operator",type:"knob",min:0,max:15,step:1,default:7,formatValue:"int"},{key:"multiple",label:"Multiple",group:"Operator",type:"knob",min:0,max:15,step:1,default:1,formatValue:"int"},{key:"detune",label:"Detune",group:"Operator",type:"knob",min:0,max:7,step:1,default:0,formatValue:"int"},{key:"waveform",label:"Waveform",group:"Operator",type:"select",min:0,max:1,default:0,formatValue:"int",options:[{value:0,label:"Sine"},{value:1,label:"Half Sine"}]},{key:"ksr",label:"Key Scale Rate",group:"Operator",type:"knob",min:0,max:3,step:1,default:0,formatValue:"int"},{key:"am_enable",label:"AM Enable",group:"Operator",type:"toggle",min:0,max:1,default:0}]},MAMETIA:{synthType:"MAMETIA",name:"TIA",subtitle:"Atari 2600 Television Interface Adaptor",color:"#f59e0b",presetCount:8,presetNames:["Constant","Poly4 Buzz","Div31 Rumble","Poly5+4 Noise","Pure Square","Pure Alt","Div31 Bass","Engine Rumble"],parameters:[{key:"volume",label:"Volume",group:"Output",type:"knob",min:0,max:1,step:.01,default:.8,formatValue:"percent"},{key:"audc_mode",label:"AUDC Mode",group:"Oscillator",type:"knob",min:0,max:15,step:1,default:4,formatValue:"int"},{key:"audf_fine",label:"Freq Fine",group:"Oscillator",type:"knob",min:0,max:1,step:.01,default:.5,formatValue:"percent"},{key:"stereo_width",label:"Stereo Width",group:"Output",type:"knob",min:0,max:1,step:.01,default:.5,formatValue:"percent"},{key:"detune",label:"Detune",group:"Oscillator",type:"knob",min:0,max:1,step:.01,default:0,formatValue:"percent"},{key:"poly_reset",label:"Poly Reset",group:"Oscillator",type:"toggle",min:0,max:1,default:0}]},MAMEUPD931:{synthType:"MAMEUPD931",name:"uPD931",subtitle:"NEC uPD931 Casio Keyboard Voice (1981)",color:"#14b8a6",presetCount:8,presetNames:["Organ","Piano","Strings","Brass","Reed","Bell","Bass","Synth Lead"],parameters:[{key:"volume",label:"Volume",group:"Output",type:"knob",min:0,max:1,step:.01,default:.8,formatValue:"percent"},{key:"wave_a",label:"Wave A",group:"Oscillator",type:"select",min:0,max:7,default:0,formatValue:"int",options:[{value:0,label:"Sine"},{value:1,label:"Saw"},{value:2,label:"Square"},{value:3,label:"Triangle"},{value:4,label:"Pulse 25%"},{value:5,label:"Pulse 12%"},{value:6,label:"Organ"},{value:7,label:"Noise"}]},{key:"wave_b",label:"Wave B",group:"Oscillator",type:"select",min:0,max:7,default:1,formatValue:"int",options:[{value:0,label:"Sine"},{value:1,label:"Saw"},{value:2,label:"Square"},{value:3,label:"Triangle"},{value:4,label:"Pulse 25%"},{value:5,label:"Pulse 12%"},{value:6,label:"Organ"},{value:7,label:"Noise"}]},{key:"mirror",label:"Mirror",group:"Oscillator",type:"toggle",min:0,max:1,default:0},{key:"invert",label:"Invert",group:"Oscillator",type:"toggle",min:0,max:1,default:0},{key:"mode_a",label:"Mode A",group:"Oscillator",type:"select",min:0,max:3,default:0,formatValue:"int",options:[{value:0,label:"Always"},{value:1,label:"Alternating"},{value:2,label:"Attack Only"},{value:3,label:"Sustain Only"}]},{key:"mode_b",label:"Mode B",group:"Oscillator",type:"select",min:0,max:3,default:0,formatValue:"int",options:[{value:0,label:"Always"},{value:1,label:"Alternating"},{value:2,label:"Attack Only"},{value:3,label:"Sustain Only"}]},{key:"key_scaling",label:"Key Scaling",group:"Oscillator",type:"knob",min:0,max:1,step:.01,default:0,formatValue:"percent"}]},MAMEUPD933:{synthType:"MAMEUPD933",name:"uPD933",subtitle:"NEC uPD933 CZ Phase Distortion Synthesis",color:"#6366f1",presetCount:8,presetNames:["Brass","Strings","E.Piano","Bass","Organ","Pad","Lead","Bell"],parameters:[{key:"volume",label:"Volume",group:"Output",type:"knob",min:0,max:1,step:.01,default:.8,formatValue:"percent"},{key:"waveform1",label:"Waveform 1",group:"Oscillator",type:"select",min:0,max:7,default:0,formatValue:"int",options:[{value:0,label:"Sawtooth"},{value:1,label:"Square"},{value:2,label:"Pulse"},{value:3,label:"Silent"},{value:4,label:"Double Sine"},{value:5,label:"Saw+Pulse"},{value:6,label:"Resonance"},{value:7,label:"Double Pulse"}]},{key:"waveform2",label:"Waveform 2",group:"Oscillator",type:"select",min:0,max:7,default:0,formatValue:"int",options:[{value:0,label:"Sawtooth"},{value:1,label:"Square"},{value:2,label:"Pulse"},{value:3,label:"Silent"},{value:4,label:"Double Sine"},{value:5,label:"Saw+Pulse"},{value:6,label:"Resonance"},{value:7,label:"Double Pulse"}]},{key:"window",label:"Window",group:"Oscillator",type:"select",min:0,max:3,default:0,formatValue:"int",options:[{value:0,label:"None"},{value:1,label:"Half"},{value:2,label:"Rise"},{value:3,label:"Fall"}]},{key:"dcw_depth",label:"DCW Depth",group:"Envelope",type:"knob",min:0,max:1,step:.01,default:.5,formatValue:"percent"},{key:"dca_rate",label:"DCA Rate",group:"Envelope",type:"knob",min:0,max:1,step:.01,default:.5,formatValue:"percent"},{key:"dcw_rate",label:"DCW Rate",group:"Envelope",type:"knob",min:0,max:1,step:.01,default:.5,formatValue:"percent"},{key:"dco_rate",label:"DCO Rate",group:"Envelope",type:"knob",min:0,max:1,step:.01,default:0,formatValue:"percent"},{key:"dco_depth",label:"DCO Depth",group:"Envelope",type:"knob",min:0,max:1,step:.01,default:0,formatValue:"percent"},{key:"ring_mod",label:"Ring Mod",group:"Oscillator",type:"toggle",min:0,max:1,default:0},{key:"stereo_width",label:"Stereo Width",group:"Output",type:"knob",min:0,max:1,step:.01,default:.5,formatValue:"percent"}]},MAMETMS5220:{synthType:"MAMETMS5220",name:"TMS5220",subtitle:"TI TMS5220 LPC Speech (Speak & Spell)",color:"#d946ef",presetCount:8,presetNames:["AH","EE","IH","OH","OO","AE","UH","SH"],parameters:[{key:"volume",label:"Volume",group:"Output",type:"knob",min:0,max:1,step:.01,default:.8,formatValue:"percent"},{key:"chirp_type",label:"Chirp Type",group:"Excitation",type:"select",min:0,max:2,default:0,formatValue:"int",options:[{value:0,label:"TMS5220"},{value:1,label:"TMS5200"},{value:2,label:"TI99"}]},{key:"k1_index",label:"K1 Index",group:"Formants",type:"knob",min:0,max:31,step:1,default:15,formatValue:"int"},{key:"k2_index",label:"K2 Index",group:"Formants",type:"knob",min:0,max:31,step:1,default:15,formatValue:"int"},{key:"k3_index",label:"K3 Index",group:"Formants",type:"knob",min:0,max:31,step:1,default:15,formatValue:"int"},{key:"energy_index",label:"Energy",group:"Excitation",type:"knob",min:0,max:15,step:1,default:10,formatValue:"int"},{key:"pitch_index",label:"Pitch",group:"Excitation",type:"knob",min:0,max:63,step:1,default:32,formatValue:"int"},{key:"noise_mode",label:"Noise Mode",group:"Excitation",type:"toggle",min:0,max:1,default:0},{key:"stereo_width",label:"Stereo Width",group:"Output",type:"knob",min:0,max:1,step:.01,default:.5,formatValue:"percent"},{key:"brightness",label:"Brightness",group:"Formants",type:"knob",min:0,max:1,step:.01,default:.5,formatValue:"percent"}]},MAMEYMF271:{synthType:"MAMEYMF271",name:"YMF271 OPX",subtitle:"Yamaha OPX 4-Operator FM+PCM Synthesizer",color:"#2563eb",presetCount:8,presetNames:["E.Piano","Brass","Strings","Bass","Organ","Lead","Pad","Bell"],parameters:[{key:"volume",label:"Volume",group:"Output",type:"knob",min:0,max:1,step:.01,default:.8,formatValue:"percent"},{key:"algorithm",label:"Algorithm",group:"FM",type:"knob",min:0,max:15,step:1,default:0,formatValue:"int"},{key:"feedback",label:"Feedback",group:"FM",type:"knob",min:0,max:7,step:1,default:0,formatValue:"int"},{key:"waveform",label:"Waveform",group:"FM",type:"knob",min:0,max:7,step:1,default:0,formatValue:"int"},{key:"tl",label:"Total Level",group:"Operator",type:"knob",min:0,max:127,step:1,default:0,formatValue:"int"},{key:"ar",label:"Attack Rate",group:"Envelope",type:"knob",min:0,max:31,step:1,default:31,formatValue:"int"},{key:"d1r",label:"Decay 1 Rate",group:"Envelope",type:"knob",min:0,max:31,step:1,default:0,formatValue:"int"},{key:"d2r",label:"Decay 2 Rate",group:"Envelope",type:"knob",min:0,max:31,step:1,default:0,formatValue:"int"},{key:"rr",label:"Release Rate",group:"Envelope",type:"knob",min:0,max:15,step:1,default:7,formatValue:"int"},{key:"d1l",label:"Decay 1 Level",group:"Envelope",type:"knob",min:0,max:15,step:1,default:0,formatValue:"int"},{key:"multiple",label:"Multiple",group:"FM",type:"knob",min:0,max:15,step:1,default:1,formatValue:"int"},{key:"detune",label:"Detune",group:"FM",type:"knob",min:0,max:7,step:1,default:0,formatValue:"int"},{key:"lfo_freq",label:"LFO Freq",group:"LFO",type:"knob",min:0,max:7,step:1,default:0,formatValue:"int"},{key:"lfo_wave",label:"LFO Wave",group:"LFO",type:"knob",min:0,max:3,step:1,default:0,formatValue:"int"},{key:"pms",label:"Pitch Mod Sens",group:"LFO",type:"knob",min:0,max:7,step:1,default:0,formatValue:"int"},{key:"ams",label:"Amp Mod Sens",group:"LFO",type:"knob",min:0,max:3,step:1,default:0,formatValue:"int"}]},MAMETR707:{synthType:"MAMETR707",name:"TR-707",subtitle:"Roland TR-707 Drum Machine (1984)",color:"#dc2626",presetCount:0,parameters:[{key:"volume",label:"Volume",group:"Master",type:"knob",min:0,max:1,step:.01,default:.8,formatValue:"percent"},{key:"bass",label:"Bass",group:"Levels",type:"knob",min:0,max:1,step:.01,default:.8,formatValue:"percent"},{key:"snare",label:"Snare",group:"Levels",type:"knob",min:0,max:1,step:.01,default:.8,formatValue:"percent"},{key:"low_tom",label:"Low Tom",group:"Levels",type:"knob",min:0,max:1,step:.01,default:.8,formatValue:"percent"},{key:"mid_tom",label:"Mid Tom",group:"Levels",type:"knob",min:0,max:1,step:.01,default:.8,formatValue:"percent"},{key:"hi_tom",label:"Hi Tom",group:"Levels",type:"knob",min:0,max:1,step:.01,default:.8,formatValue:"percent"},{key:"rimshot",label:"Rimshot",group:"Levels",type:"knob",min:0,max:1,step:.01,default:.8,formatValue:"percent"},{key:"handclap",label:"Handclap",group:"Levels",type:"knob",min:0,max:1,step:.01,default:.8,formatValue:"percent"},{key:"hihat",label:"Hi-Hat",group:"Levels",type:"knob",min:0,max:1,step:.01,default:.8,formatValue:"percent"},{key:"crash",label:"Crash",group:"Levels",type:"knob",min:0,max:1,step:.01,default:.8,formatValue:"percent"},{key:"ride",label:"Ride",group:"Levels",type:"knob",min:0,max:1,step:.01,default:.8,formatValue:"percent"},{key:"accent",label:"Accent",group:"Master",type:"knob",min:0,max:1,step:.01,default:.5,formatValue:"percent"},{key:"decay",label:"Decay",group:"Master",type:"knob",min:0,max:1,step:.01,default:.5,formatValue:"percent"}]},MAMEVASynth:{synthType:"MAMEVASynth",name:"VA Synth",subtitle:"Virtual Analog Subtractive Synthesizer",color:"#7c3aed",presetCount:8,presetNames:["Bass","Lead","Pad","Brass","Strings","Pluck","Keys","FX"],parameters:[{key:"volume",label:"Volume",group:"Output",type:"knob",min:0,max:1,step:.01,default:.8,formatValue:"percent"},{key:"osc1_wave",label:"Osc 1 Wave",group:"Oscillator",type:"select",min:0,max:3,default:0,formatValue:"int",options:[{value:0,label:"Saw"},{value:1,label:"Square"},{value:2,label:"Triangle"},{value:3,label:"Noise"}]},{key:"osc2_wave",label:"Osc 2 Wave",group:"Oscillator",type:"select",min:0,max:3,default:0,formatValue:"int",options:[{value:0,label:"Saw"},{value:1,label:"Square"},{value:2,label:"Triangle"},{value:3,label:"Noise"}]},{key:"osc_mix",label:"Osc Mix",group:"Oscillator",type:"knob",min:0,max:1,step:.01,default:.5,formatValue:"percent"},{key:"osc2_detune",label:"Osc 2 Detune",group:"Oscillator",type:"knob",min:0,max:1,step:.01,default:0,formatValue:"percent"},{key:"filter_cutoff",label:"Filter Cutoff",group:"Filter",type:"knob",min:0,max:1,step:.01,default:.8,formatValue:"percent"},{key:"filter_res",label:"Filter Res",group:"Filter",type:"knob",min:0,max:1,step:.01,default:0,formatValue:"percent"},{key:"filter_env_depth",label:"Filter Env",group:"Filter",type:"knob",min:0,max:1,step:.01,default:0,formatValue:"percent"}]},CEM3394:{synthType:"CEM3394",name:"CEM3394",subtitle:"Curtis Electromusic Analog Synth Voice (1984)",color:"#f43f5e",presetCount:0,parameters:[{key:"volume",label:"Volume",group:"Output",type:"knob",min:0,max:1,step:.01,default:.8,formatValue:"percent"},{key:"vco_frequency",label:"VCO Freq",group:"VCO",type:"knob",min:0,max:1,step:.01,default:.5,formatValue:"percent"},{key:"modulation",label:"Modulation",group:"VCO",type:"knob",min:0,max:1,step:.01,default:0,formatValue:"percent"},{key:"wave_select",label:"Wave Select",group:"VCO",type:"knob",min:0,max:7,step:1,default:2,formatValue:"int"},{key:"pulse_width",label:"Pulse Width",group:"VCO",type:"knob",min:0,max:1,step:.01,default:.5,formatValue:"percent"},{key:"mixer_balance",label:"Mixer Balance",group:"Mixer",type:"knob",min:0,max:1,step:.01,default:.5,formatValue:"percent"},{key:"resonance",label:"Resonance",group:"Filter",type:"knob",min:0,max:1,step:.01,default:0,formatValue:"percent"},{key:"cutoff",label:"Cutoff",group:"Filter",type:"knob",min:0,max:1,step:.01,default:.8,formatValue:"percent"}]},SCSP:{synthType:"SCSP",name:"SCSP",subtitle:"Sega Saturn YMF292-F Sound Processor",color:"#475569",presetCount:0,parameters:[{key:"volume",label:"Volume",group:"Output",type:"knob",min:0,max:1,step:.01,default:.8,formatValue:"percent"}]},MAMEAICA:{synthType:"MAMEAICA",name:"AICA",subtitle:"Sega Dreamcast Sound Processor",color:"#0ea5e9",presetCount:0,parameters:[{key:"volume",label:"Volume",group:"Output",type:"knob",min:0,max:1,step:.01,default:.8,formatValue:"percent"}]},MAMEICS2115:{synthType:"MAMEICS2115",name:"ICS2115",subtitle:"ICS WaveFront 32-Voice Synthesizer",color:"#64748b",presetCount:0,parameters:[{key:"volume",label:"Volume",group:"Output",type:"knob",min:0,max:1,step:.01,default:.8,formatValue:"percent"},{key:"active_osc",label:"Active Voices",group:"Oscillator",type:"knob",min:1,max:32,step:1,default:8,formatValue:"int"}]},MAMEK054539:{synthType:"MAMEK054539",name:"K054539",subtitle:"Konami K054539 PCM/ADPCM (8-Channel)",color:"#78716c",presetCount:0,parameters:[{key:"volume",label:"Volume",group:"Output",type:"knob",min:0,max:1,step:.01,default:.8,formatValue:"percent"},{key:"reverb_enable",label:"Reverb",group:"Effects",type:"toggle",min:0,max:1,default:0}]},MAMEC352:{synthType:"MAMEC352",name:"C352",subtitle:"Namco C352 32-Voice PCM",color:"#94a3b8",presetCount:0,parameters:[{key:"volume",label:"Volume",group:"Output",type:"knob",min:0,max:1,step:.01,default:.8,formatValue:"percent"}]},MAMERF5C400:{synthType:"MAMERF5C400",name:"RF5C400",subtitle:"Ricoh RF5C400 32-Voice PCM",color:"#6b7280",presetCount:0,parameters:[{key:"volume",label:"Volume",group:"Output",type:"knob",min:0,max:1,step:.01,default:.8,formatValue:"percent"}]},CZ101:{synthType:"CZ101",name:"CZ-101",subtitle:"Casio Phase Distortion Synthesizer (1984)",color:"#8b5cf6",presetCount:4,presetNames:["Brass 1","E.Piano","Synth Bass","Pad"],parameters:[{key:"volume",label:"Volume",group:"Output",type:"knob",min:0,max:1,step:.01,default:.8,formatValue:"percent"}]},MAMERSA:{synthType:"MAMERSA",name:"Roland D-50",subtitle:"Roland SA Linear Arithmetic (requires ROM)",color:"#6b7280",presetCount:0,parameters:[{key:"volume",label:"Volume",group:"Output",type:"knob",min:0,max:1,step:.01,default:.8,formatValue:"percent"}],romConfig:{requiredZip:"mks20.zip (Roland D-50 / MKS-20 ROMs: IC5, IC6, IC7)",bankCount:3,romType:"rsa"}},MAMESWP30:{synthType:"MAMESWP30",name:"Yamaha MU-2000",subtitle:"SWP30 Wavetable (requires ROM)",color:"#6b7280",presetCount:0,parameters:[{key:"volume",label:"Volume",group:"Output",type:"knob",min:0,max:1,step:.01,default:.8,formatValue:"percent"}],romConfig:{requiredZip:"mu100.zip (Yamaha MU-100/MU-2000 wave ROM)",bankCount:1,romType:"swp30"}}};function Rf(e){return Of[e]}const Vf=({synthType:e,parameters:a,instrumentId:n,onParamChange:r,onTextChange:s,onLoadPreset:i,onRomUpload:o})=>{const l="cyan-lineart"===B(e=>e.currentThemeId),d=he.useMemo(()=>Rf(e),[e]),[c,u]=he.useState(0);if(he.useRef(a).current=a,!d)return null;const m=he.useMemo(()=>{const e={};for(const t of d.parameters)e[t.group]||(e[t.group]=[]),e[t.group].push(t);return e},[d]),p=he.useCallback((e,t)=>{if("percent"===e.formatValue)return`${Math.round(100*t)}%`;if("int"===e.formatValue)return String(Math.round(t));if("hz"===e.formatValue)return`${Math.round(t)} Hz`;if("db"===e.formatValue)return`${t.toFixed(1)} dB`;if("seconds"===e.formatValue)return`${t.toFixed(3)}s`;if(e.options){const a=e.options.find(e=>e.value===Math.round(t));return a?a.label:String(Math.round(t))}return t.toFixed(2)},[]),h=l?"#00ffff":d.color,f=l?"#00ffff":d.color,x=l?"rgba(0, 20, 20, 0.4)":"rgba(0,0,0,0.3)",g=l?"#00ffff":"#e2e8f0",b=l?"#006060":"#94a3b8",y=l?"rgba(0, 255, 255, 0.2)":"rgba(255,255,255,0.08)",v=he.useCallback(async(e,t)=>{const a=e.target.files?.[0];if(a&&o){if(a.name.toLowerCase().endsWith(".zip"))try{const e=new W,n=await e.loadAsync(a),s=[];n.forEach((e,t)=>{const a=e.toLowerCase().match(/\.(txt|md|pdf|url|inf)$/);t.dir||a||s.push({name:e,entry:t})}),s.sort((e,t)=>e.name.localeCompare(t.name,void 0,{numeric:!0,sensitivity:"base"}));for(let a=0;a<s.length;a++){const e=t+a,n=await s[a].entry.async("uint8array");o(e,n)}r("_romsLoaded",1)}catch(n){}else{const e=await a.arrayBuffer(),n=new Uint8Array(e);o(t,n),r("_romsLoaded",1)}e.target.value=""}},[o,r]),w=(e,n,i="")=>t.jsxs("div",{style:{background:x,border:`1px solid ${y}`,borderRadius:8,padding:"8px 12px",marginBottom:8},children:[t.jsx("div",{style:{fontSize:10,fontWeight:600,color:h,textTransform:"uppercase",letterSpacing:"0.05em",marginBottom:8},children:e}),t.jsx("div",{style:{display:"flex",flexWrap:"wrap",gap:12,justifyContent:"flex-start",alignItems:"flex-end"},children:n.map(e=>((e,n="")=>{const i=n?`${n}${e.key}`:e.key,o=a[i]??e.default;if("toggle"===e.type)return t.jsxs("div",{style:{display:"flex",flexDirection:"column",alignItems:"center",gap:4},children:[t.jsx("button",{onClick:()=>r(i,o?0:1),style:{width:48,height:24,borderRadius:12,background:o?h:l?"#0a1a1a":"#334155",border:`1px solid ${o?h:y}`,cursor:"pointer",position:"relative",transition:"background 0.2s"},children:t.jsx("div",{style:{width:18,height:18,borderRadius:9,background:l?"#030808":"#fff",position:"absolute",top:2,left:o?27:3,transition:"left 0.2s",boxShadow:o?`0 0 6px ${h}`:"none"}})}),t.jsx("span",{style:{fontSize:10,color:b},children:e.label})]},i);if("text"===e.type){const n=a[i]??e.defaultText??"";return t.jsxs("div",{style:{display:"flex",flexDirection:"column",gap:4,flex:"1 1 100%"},children:[t.jsx("span",{style:{fontSize:10,color:b,textTransform:"uppercase",fontWeight:600},children:e.label}),t.jsx("input",{type:"text",value:n,onChange:e=>s?.(i,e.target.value),placeholder:e.placeholder||"",style:{background:l?"#041010":"#0d1117",color:l?"#00ffff":h,border:`1px solid ${y}`,borderRadius:6,padding:"8px 12px",fontSize:13,fontFamily:"Monaco, Menlo, monospace",outline:"none",width:"100%"}})]},i)}return"select"===e.type&&e.options?t.jsxs("div",{style:{display:"flex",flexDirection:"column",alignItems:"center",gap:4},children:[t.jsx("select",{value:Math.round(o),onChange:e=>r(i,Number(e.target.value)),style:{background:l?"#041010":"#1e293b",color:g,border:`1px solid ${y}`,borderRadius:6,padding:"4px 8px",fontSize:11,cursor:"pointer",minWidth:80},children:e.options.map(e=>t.jsx("option",{value:e.value,children:e.label},e.value))}),t.jsx("span",{style:{fontSize:10,color:b},children:e.label})]},i):t.jsx(I,{value:o,min:e.min??0,max:e.max??1,step:e.step??.01,onChange:e=>r(i,e),label:e.label,color:f,size:"sm",defaultValue:e.default,logarithmic:e.logarithmic,bipolar:e.bipolar,formatValue:t=>p(e,t)},i)})(e,i))})]},e),j=null!=d.operatorCount&&d.operatorCount>0&&d.operatorParams;return t.jsxs("div",{style:{padding:"8px 0"},children:[t.jsxs("div",{style:{display:"flex",alignItems:"center",gap:8,marginBottom:8},children:[t.jsx("span",{style:{fontSize:14,fontWeight:700,color:h},children:d.name}),t.jsx("span",{style:{fontSize:11,color:b},children:d.subtitle})]}),d.romConfig&&o&&t.jsxs("div",{style:{background:x,border:"1px solid "+(a._romsLoaded?l?"rgba(0,255,128,0.3)":"rgba(34,197,94,0.3)":l?"rgba(255,100,100,0.3)":"rgba(239,68,68,0.3)"),borderRadius:8,padding:"8px 12px",marginBottom:8},children:[t.jsxs("div",{style:{display:"flex",alignItems:"center",justifyContent:"space-between",marginBottom:6},children:[t.jsx("div",{style:{fontSize:10,fontWeight:600,color:h,textTransform:"uppercase",letterSpacing:"0.05em"},children:"ROM Banks"}),t.jsx("div",{style:{fontSize:9,fontWeight:600,padding:"2px 6px",borderRadius:4,background:a._romsLoaded?l?"rgba(0,255,128,0.15)":"rgba(34,197,94,0.15)":l?"rgba(255,100,100,0.15)":"rgba(239,68,68,0.15)",color:a._romsLoaded?l?"#00ff80":"#22c55e":l?"#ff6464":"#ef4444"},children:a._romsLoaded?"ROMS READY":"ROMS MISSING"})]}),t.jsxs("div",{style:{fontSize:9,color:b,marginBottom:8},children:["Expects: ",t.jsx("span",{style:{fontFamily:"Monaco, Menlo, monospace",color:h},children:d.romConfig.requiredZip})]}),t.jsxs("div",{style:{display:"flex",gap:8,flexWrap:"wrap",alignItems:"center"},children:[t.jsxs("label",{style:{fontSize:10,fontWeight:600,padding:"4px 10px",borderRadius:4,border:`1px solid ${h}33`,background:`${h}11`,color:h,cursor:"pointer",transition:"background 0.15s"},children:["UPLOAD ZIP",t.jsx("input",{type:"file",accept:".zip",style:{display:"none"},onChange:e=>v(e,0)})]}),Array.from({length:d.romConfig.bankCount},(e,a)=>t.jsxs("label",{style:{fontSize:9,padding:"3px 8px",borderRadius:4,border:`1px solid ${y}`,background:l?"#041010":"#1e293b",color:h,cursor:"pointer"},children:["BANK ",a,t.jsx("input",{type:"file",style:{display:"none"},onChange:e=>v(e,a)})]},a))]})]}),d.presetCount>0&&t.jsxs("div",{style:{background:x,border:`1px solid ${y}`,borderRadius:8,padding:"8px 12px",marginBottom:8},children:[t.jsx("div",{style:{fontSize:10,fontWeight:600,color:h,textTransform:"uppercase",letterSpacing:"0.05em",marginBottom:8},children:"Chip Presets"}),t.jsx("div",{style:{display:"flex",flexWrap:"wrap",gap:4},children:Array.from({length:d.presetCount},(e,n)=>t.jsx("button",{onClick:()=>i(n),style:{padding:"4px 10px",borderRadius:4,border:`1px solid ${a._program===n?h:y}`,background:a._program===n?`${h}22`:l?"#041010":"#1e293b",color:a._program===n?h:g,fontSize:11,cursor:"pointer",fontWeight:a._program===n?600:400,transition:"all 0.15s"},children:d.presetNames?.[n]??`Preset ${n+1}`},n))})]}),j&&t.jsxs("div",{style:{display:"flex",gap:2,marginBottom:8},children:[t.jsx("button",{onClick:()=>u(0),style:{padding:"4px 12px",borderRadius:"6px 6px 0 0",border:`1px solid ${y}`,borderBottom:0===c?`2px solid ${h}`:`1px solid ${y}`,background:0===c?x:"transparent",color:0===c?h:b,fontSize:11,fontWeight:600,cursor:"pointer"},children:"Global"}),Array.from({length:d.operatorCount},(e,a)=>t.jsxs("button",{onClick:()=>u(a+1),style:{padding:"4px 12px",borderRadius:"6px 6px 0 0",border:`1px solid ${y}`,borderBottom:c===a+1?`2px solid ${h}`:`1px solid ${y}`,background:c===a+1?x:"transparent",color:c===a+1?h:b,fontSize:11,fontWeight:600,cursor:"pointer"},children:["Op ",a+1]},a+1))]}),(!j||0===c)&&Object.entries(m).map(([e,t])=>w(e,t)),j&&c>0&&d.operatorParams&&(()=>{const e=d.operatorParams,t={};for(const a of e)t[a.group]||(t[a.group]=[]),t[a.group].push(a);return Object.entries(t).map(([e,t])=>w(e,t,`op${c}_`))})()]})},Pf=["6→5→4→3→2→1","6→5→4→3→2+1","6→5→4→3+2→1","6→5→4+3→2→1","6→5→4→3→2→1","6→5→4→3→2+1","6+5→4→3→2→1","6→5+4→3→2→1","6→5→4→3→2+1","6→5→4+3→2+1","6→5→4→3+2→1","6→5→4+3+2→1","6→5→4→3→2+1","6→5→4→3+2+1","6→5→4+3→2+1","6→5+4→3+2→1","6→5→4→3→2+1","6→5+4→3→2+1","6+5→4→3→2+1","6→5+4+3→2+1","6+5→4→3+2→1","6+5→4→3+2+1","6+5+4→3→2+1","6+5+4→3+2+1","6+5+4→3+2→1","6+5+4+3→2+1","6+5+4→3+2+1","6+5+4+3+2→1","6+5+4+3+2→1","6+5+4+3+2+1","6+5+4+3+2+1","6+5+4+3+2+1"],Df=["triangle","sawDown","sawUp","square","sine","sampleHold"],Bf=["Triangle","Saw Down","Saw Up","Square","Sine","S&H"],Lf=({config:e,onChange:a})=>{const[n,r]=he.useState("global"),s=he.useRef(e);s.current=e;const i="cyan-lineart"===B(e=>e.currentThemeId),o=i?"#00ffff":"#3b82f6",l=i?"#00ffff":"#60a5fa",d=i?"bg-[#051515] border-cyan-900/50":"bg-[#1a1a2e] border-blue-900/50",c=(e,t)=>{const n=[...s.current.operators||[]];for(;n.length<=e;)n.push({level:99,coarse:1,fine:0,detune:7,mode:"ratio",egRates:[99,99,99,99],egLevels:[99,99,99,0],breakPoint:0,leftDepth:0,rightDepth:0,leftCurve:0,rightCurve:0,rateScaling:0,ampModSens:0,velocitySens:0});n[e]={...n[e],...t},a({operators:n})},u=a=>{const n=e.operators?.[a]||{level:99,coarse:1,fine:0,detune:7,egRates:[99,99,99,99],egLevels:[99,99,99,0]},r=n.egRates||[99,99,99,99],s=n.egLevels||[99,99,99,0];return t.jsxs("div",{className:"flex flex-col gap-4 p-4",children:[t.jsxs("div",{className:`p-4 rounded-xl border ${d}`,children:[t.jsxs("div",{className:"flex items-center gap-2 mb-4",children:[t.jsx(ve,{size:16,style:{color:o}}),t.jsxs("h3",{className:"font-bold uppercase tracking-tight",style:{color:o},children:["OPERATOR ",a+1," - FREQUENCY"]})]}),t.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-4 gap-6",children:[t.jsx(I,{value:n.level??99,min:0,max:99,onChange:e=>c(a,{level:Math.round(e)}),label:"Level",color:l,size:"sm"}),t.jsx(I,{value:n.coarse??1,min:0,max:31,onChange:e=>c(a,{coarse:Math.round(e)}),label:"Coarse",color:l,size:"sm"}),t.jsx(I,{value:n.fine??0,min:0,max:99,onChange:e=>c(a,{fine:Math.round(e)}),label:"Fine",color:l,size:"sm"}),t.jsx(I,{value:n.detune??7,min:0,max:14,onChange:e=>c(a,{detune:Math.round(e)}),label:"Detune",color:l,size:"sm"})]})]}),t.jsxs("div",{className:`p-4 rounded-xl border ${d}`,children:[t.jsx("h3",{className:"font-bold uppercase tracking-tight mb-4",style:{color:o},children:"ENVELOPE RATES"}),t.jsx("div",{className:"grid grid-cols-4 gap-6",children:["R1","R2","R3","R4"].map((e,n)=>t.jsx(I,{value:r[n],min:0,max:99,onChange:e=>{const t=[...r];t[n]=Math.round(e),c(a,{egRates:t})},label:e,color:l,size:"sm"},e))})]}),t.jsxs("div",{className:`p-4 rounded-xl border ${d}`,children:[t.jsx("h3",{className:"font-bold uppercase tracking-tight mb-4",style:{color:o},children:"ENVELOPE LEVELS"}),t.jsx("div",{className:"grid grid-cols-4 gap-6",children:["L1","L2","L3","L4"].map((e,n)=>t.jsx(I,{value:s[n],min:0,max:99,onChange:e=>{const t=[...s];t[n]=Math.round(e),c(a,{egLevels:t})},label:e,color:l,size:"sm"},e))})]})]})};return t.jsxs("div",{className:"flex flex-col h-full",children:[t.jsx("div",{className:"flex border-b border-gray-800 bg-gray-900/50",children:[{id:"global",label:"Global"},{id:"op1",label:"OP1"},{id:"op2",label:"OP2"},{id:"op3",label:"OP3"},{id:"op4",label:"OP4"},{id:"op5",label:"OP5"},{id:"op6",label:"OP6"}].map(e=>t.jsx("button",{onClick:()=>r(e.id),className:"px-4 py-2 text-xs font-bold uppercase tracking-wider transition-all "+(n===e.id?"border-b-2 text-blue-400":"text-gray-500 hover:text-gray-300"),style:n===e.id?{borderColor:o,color:o}:{},children:e.label},e.id))}),t.jsxs("div",{className:"flex-1 overflow-y-auto",children:["global"===n&&t.jsxs("div",{className:"flex flex-col gap-4 p-4",children:[t.jsxs("div",{className:`p-4 rounded-xl border ${d}`,children:[t.jsxs("div",{className:"flex items-center gap-2 mb-4",children:[t.jsx(qe,{size:16,style:{color:o}}),t.jsx("h3",{className:"font-bold uppercase tracking-tight",style:{color:o},children:"ALGORITHM"})]}),t.jsx("div",{className:"flex flex-wrap gap-2 mb-4",children:Array.from({length:32},(n,r)=>t.jsx("button",{onClick:()=>a({algorithm:r}),className:"w-8 h-8 text-xs rounded border transition-all "+(e.algorithm===r?"border-blue-400 bg-blue-500/30 text-blue-300":"border-gray-700 bg-gray-800 text-gray-400 hover:border-gray-600"),children:r+1},r))}),t.jsx("div",{className:"text-xs text-gray-400 text-center font-mono",children:Pf[e.algorithm||0]})]}),t.jsxs("div",{className:`p-4 rounded-xl border ${d}`,children:[t.jsxs("div",{className:"flex items-center gap-2 mb-4",children:[t.jsx(Se,{size:16,style:{color:o}}),t.jsx("h3",{className:"font-bold uppercase tracking-tight",style:{color:o},children:"FEEDBACK & LFO"})]}),t.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-4 gap-6",children:[t.jsx(I,{value:e.feedback||0,min:0,max:7,onChange:e=>a({feedback:Math.round(e)}),label:"Feedback",color:l,size:"sm"}),t.jsx(I,{value:e.lfoSpeed||35,min:0,max:99,onChange:e=>a({lfoSpeed:Math.round(e)}),label:"LFO Speed",color:l,size:"sm"}),t.jsx(I,{value:e.lfoPitchModDepth||0,min:0,max:99,onChange:e=>a({lfoPitchModDepth:Math.round(e)}),label:"Pitch Mod",color:l,size:"sm"}),t.jsx(I,{value:e.lfoAmpModDepth||0,min:0,max:99,onChange:e=>a({lfoAmpModDepth:Math.round(e)}),label:"Amp Mod",color:l,size:"sm"})]}),t.jsxs("div",{className:"mt-4",children:[t.jsx("label",{className:"text-xs text-gray-400 block mb-2",children:"LFO Waveform"}),t.jsx("select",{value:e.lfoWave||"triangle",onChange:e=>a({lfoWave:e.target.value}),className:"bg-gray-900 border border-gray-700 text-xs rounded px-2 py-1 w-full",style:{color:o},children:Df.map((e,a)=>t.jsx("option",{value:e,children:Bf[a]},e))})]})]}),t.jsxs("div",{className:`p-4 rounded-xl border ${d}`,children:[t.jsxs("div",{className:"flex items-center gap-2 mb-4",children:[t.jsx(Be,{size:16,style:{color:o}}),t.jsx("h3",{className:"font-bold uppercase tracking-tight",style:{color:o},children:"OPERATOR LEVELS"})]}),t.jsx("div",{className:"grid grid-cols-6 gap-4",children:[0,1,2,3,4,5].map(a=>t.jsx("div",{className:"text-center",children:t.jsx(I,{value:e.operators?.[a]?.level??99,min:0,max:99,onChange:e=>c(a,{level:Math.round(e)}),label:`OP${a+1}`,color:l,size:"sm"})},a))})]})]}),"op1"===n&&u(0),"op2"===n&&u(1),"op3"===n&&u(2),"op4"===n&&u(3),"op5"===n&&u(4),"op6"===n&&u(5)]})]})},Ff=["saw","pulse","triangle","noise"],Wf=["sine","triangle","saw","square","sampleHold"],Uf=({config:e,onChange:a})=>{const[n,r]=he.useState("osc");he.useRef(e).current=e;const s="cyan-lineart"===B(e=>e.currentThemeId),i=s?"#00ffff":"#ff8c00",o=s?"#00ffff":"#ffa500",l=s?"bg-[#051515] border-cyan-900/50":"bg-[#1a1a1a] border-amber-900/50";return t.jsxs("div",{className:"flex flex-col h-full",children:[t.jsx("div",{className:"flex border-b border-gray-800 bg-gray-900/50",children:[{id:"osc",label:"Oscillators"},{id:"filter",label:"Filter"},{id:"env",label:"Envelope"},{id:"mod",label:"Modulation"}].map(e=>t.jsx("button",{onClick:()=>r(e.id),className:"px-4 py-2 text-xs font-bold uppercase tracking-wider transition-all "+(n===e.id?"border-b-2 text-amber-400":"text-gray-500 hover:text-gray-300"),style:n===e.id?{borderColor:i,color:i}:{},children:e.label},e.id))}),t.jsxs("div",{className:"flex-1 overflow-y-auto",children:["osc"===n&&t.jsxs("div",{className:"flex flex-col gap-4 p-4",children:[t.jsxs("div",{className:`p-4 rounded-xl border ${l}`,children:[t.jsxs("div",{className:"flex items-center gap-2 mb-4",children:[t.jsx(Be,{size:16,style:{color:i}}),t.jsx("h3",{className:"font-bold uppercase tracking-tight",style:{color:i},children:"OSCILLATOR 1"})]}),t.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-5 gap-4",children:[t.jsxs("div",{className:"col-span-2",children:[t.jsx("label",{className:"text-xs text-gray-400 block mb-2",children:"Waveform"}),t.jsx("select",{value:e.osc1Waveform||"saw",onChange:e=>a({osc1Waveform:e.target.value}),className:"bg-gray-900 border border-gray-700 text-xs rounded px-2 py-1 w-full",style:{color:i},children:Ff.map(e=>t.jsx("option",{value:e,children:e.charAt(0).toUpperCase()+e.slice(1)},e))})]}),t.jsx(I,{value:e.osc1Octave??0,min:-2,max:2,onChange:e=>a({osc1Octave:Math.round(e)}),label:"Octave",color:o,size:"sm"}),t.jsx(I,{value:e.osc1Detune??0,min:-1,max:1,onChange:e=>a({osc1Detune:e}),label:"Detune",color:o,size:"sm"}),t.jsx(I,{value:e.osc1Level??1,min:0,max:1,onChange:e=>a({osc1Level:e}),label:"Level",color:o,size:"sm"})]}),t.jsx("div",{className:"mt-4",children:t.jsx(I,{value:e.osc1PulseWidth??.5,min:0,max:1,onChange:e=>a({osc1PulseWidth:e}),label:"Pulse Width",color:o,size:"sm"})})]}),t.jsxs("div",{className:`p-4 rounded-xl border ${l}`,children:[t.jsxs("div",{className:"flex items-center gap-2 mb-4",children:[t.jsx(Be,{size:16,style:{color:i}}),t.jsx("h3",{className:"font-bold uppercase tracking-tight",style:{color:i},children:"OSCILLATOR 2"})]}),t.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-5 gap-4",children:[t.jsxs("div",{className:"col-span-2",children:[t.jsx("label",{className:"text-xs text-gray-400 block mb-2",children:"Waveform"}),t.jsx("select",{value:e.osc2Waveform||"saw",onChange:e=>a({osc2Waveform:e.target.value}),className:"bg-gray-900 border border-gray-700 text-xs rounded px-2 py-1 w-full",style:{color:i},children:Ff.map(e=>t.jsx("option",{value:e,children:e.charAt(0).toUpperCase()+e.slice(1)},e))})]}),t.jsx(I,{value:e.osc2Octave??0,min:-2,max:2,onChange:e=>a({osc2Octave:Math.round(e)}),label:"Octave",color:o,size:"sm"}),t.jsx(I,{value:e.osc2Detune??0,min:-1,max:1,onChange:e=>a({osc2Detune:e}),label:"Detune",color:o,size:"sm"}),t.jsx(I,{value:e.osc2Level??.7,min:0,max:1,onChange:e=>a({osc2Level:e}),label:"Level",color:o,size:"sm"})]}),t.jsx("div",{className:"mt-4",children:t.jsx(I,{value:e.osc2PulseWidth??.5,min:0,max:1,onChange:e=>a({osc2PulseWidth:e}),label:"Pulse Width",color:o,size:"sm"})})]}),t.jsxs("div",{className:`p-4 rounded-xl border ${l}`,children:[t.jsx("h3",{className:"font-bold uppercase tracking-tight mb-4",style:{color:i},children:"OPTIONS"}),t.jsxs("div",{className:"flex gap-4",children:[t.jsxs("label",{className:"flex items-center gap-2 cursor-pointer",children:[t.jsx("input",{type:"checkbox",checked:e.oscSync||!1,onChange:e=>a({oscSync:e.target.checked}),className:"w-4 h-4 rounded"}),t.jsx("span",{className:"text-xs text-gray-300",children:"OSC Sync"})]}),t.jsxs("label",{className:"flex items-center gap-2 cursor-pointer",children:[t.jsx("input",{type:"checkbox",checked:e.oscXor||!1,onChange:e=>a({oscXor:e.target.checked}),className:"w-4 h-4 rounded"}),t.jsx("span",{className:"text-xs text-gray-300",children:"Ring Mod (XOR)"})]}),t.jsxs("label",{className:"flex items-center gap-2 cursor-pointer",children:[t.jsx("input",{type:"checkbox",checked:e.unison||!1,onChange:e=>a({unison:e.target.checked}),className:"w-4 h-4 rounded"}),t.jsx("span",{className:"text-xs text-gray-300",children:"Unison"})]})]}),e.unison&&t.jsx("div",{className:"mt-4",children:t.jsx(I,{value:e.unisonDetune??.1,min:0,max:1,onChange:e=>a({unisonDetune:e}),label:"Unison Detune",color:o,size:"sm"})})]})]}),"filter"===n&&t.jsxs("div",{className:"flex flex-col gap-4 p-4",children:[t.jsxs("div",{className:`p-4 rounded-xl border ${l}`,children:[t.jsxs("div",{className:"flex items-center gap-2 mb-4",children:[t.jsx(ft,{size:16,style:{color:i}}),t.jsx("h3",{className:"font-bold uppercase tracking-tight",style:{color:i},children:"FILTER"})]}),t.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-4 gap-6",children:[t.jsx(I,{value:e.filterCutoff??.7,min:0,max:1,onChange:e=>a({filterCutoff:e}),label:"Cutoff",color:o,size:"md"}),t.jsx(I,{value:e.filterResonance??.3,min:0,max:1,onChange:e=>a({filterResonance:e}),label:"Resonance",color:o,size:"md"}),t.jsx(I,{value:e.filterEnvAmount??.5,min:0,max:1,onChange:e=>a({filterEnvAmount:e}),label:"Env Amount",color:o,size:"md"}),t.jsx(I,{value:e.filterKeyTrack??0,min:0,max:1,onChange:e=>a({filterKeyTrack:e}),label:"Key Track",color:o,size:"md"})]}),t.jsxs("div",{className:"mt-4",children:[t.jsx("label",{className:"text-xs text-gray-400 block mb-2",children:"Filter Type"}),t.jsxs("select",{value:e.filterType||"lp24",onChange:e=>a({filterType:e.target.value}),className:"bg-gray-900 border border-gray-700 text-xs rounded px-2 py-1",style:{color:i},children:[t.jsx("option",{value:"lp24",children:"LP 24dB"}),t.jsx("option",{value:"lp12",children:"LP 12dB"}),t.jsx("option",{value:"hp",children:"HP"}),t.jsx("option",{value:"bp",children:"BP"}),t.jsx("option",{value:"notch",children:"Notch"})]})]})]}),t.jsxs("div",{className:`p-4 rounded-xl border ${l}`,children:[t.jsx("h3",{className:"font-bold uppercase tracking-tight mb-4",style:{color:i},children:"FILTER ENVELOPE"}),t.jsxs("div",{className:"grid grid-cols-4 gap-6",children:[t.jsx(I,{value:e.filterAttack??.01,min:0,max:1,onChange:e=>a({filterAttack:e}),label:"Attack",color:o,size:"sm"}),t.jsx(I,{value:e.filterDecay??.3,min:0,max:1,onChange:e=>a({filterDecay:e}),label:"Decay",color:o,size:"sm"}),t.jsx(I,{value:e.filterSustain??.3,min:0,max:1,onChange:e=>a({filterSustain:e}),label:"Sustain",color:o,size:"sm"}),t.jsx(I,{value:e.filterRelease??.3,min:0,max:1,onChange:e=>a({filterRelease:e}),label:"Release",color:o,size:"sm"})]})]})]}),"env"===n&&t.jsxs("div",{className:"flex flex-col gap-4 p-4",children:[t.jsxs("div",{className:`p-4 rounded-xl border ${l}`,children:[t.jsxs("div",{className:"flex items-center gap-2 mb-4",children:[t.jsx(Se,{size:16,style:{color:i}}),t.jsx("h3",{className:"font-bold uppercase tracking-tight",style:{color:i},children:"AMP ENVELOPE"})]}),t.jsxs("div",{className:"grid grid-cols-4 gap-6",children:[t.jsx(I,{value:e.ampAttack??.01,min:0,max:1,onChange:e=>a({ampAttack:e}),label:"Attack",color:o,size:"md"}),t.jsx(I,{value:e.ampDecay??.2,min:0,max:1,onChange:e=>a({ampDecay:e}),label:"Decay",color:o,size:"md"}),t.jsx(I,{value:e.ampSustain??.7,min:0,max:1,onChange:e=>a({ampSustain:e}),label:"Sustain",color:o,size:"md"}),t.jsx(I,{value:e.ampRelease??.3,min:0,max:1,onChange:e=>a({ampRelease:e}),label:"Release",color:o,size:"md"})]})]}),t.jsxs("div",{className:`p-4 rounded-xl border ${l}`,children:[t.jsxs("div",{className:"flex items-center gap-2 mb-4",children:[t.jsx(Ge,{size:16,style:{color:i}}),t.jsx("h3",{className:"font-bold uppercase tracking-tight",style:{color:i},children:"GLOBAL"})]}),t.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-4 gap-6",children:[t.jsx(I,{value:e.masterVolume??.7,min:0,max:1,onChange:e=>a({masterVolume:e}),label:"Volume",color:o,size:"md"}),t.jsx(I,{value:e.portamento??0,min:0,max:1,onChange:e=>a({portamento:e}),label:"Portamento",color:o,size:"md"}),t.jsx(I,{value:e.velocitySensitivity??.5,min:0,max:1,onChange:e=>a({velocitySensitivity:e}),label:"Velocity Sens",color:o,size:"md"}),t.jsx(I,{value:e.panSpread??.3,min:0,max:1,onChange:e=>a({panSpread:e}),label:"Pan Spread",color:o,size:"md"})]})]})]}),"mod"===n&&t.jsxs("div",{className:"flex flex-col gap-4 p-4",children:[t.jsxs("div",{className:`p-4 rounded-xl border ${l}`,children:[t.jsxs("div",{className:"flex items-center gap-2 mb-4",children:[t.jsx(Ee,{size:16,style:{color:i}}),t.jsx("h3",{className:"font-bold uppercase tracking-tight",style:{color:i},children:"LFO"})]}),t.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-4 gap-6",children:[t.jsx(I,{value:e.lfoRate??.2,min:0,max:1,onChange:e=>a({lfoRate:e}),label:"Rate",color:o,size:"md"}),t.jsxs("div",{children:[t.jsx("label",{className:"text-xs text-gray-400 block mb-2",children:"Waveform"}),t.jsx("select",{value:e.lfoWaveform||"sine",onChange:e=>a({lfoWaveform:e.target.value}),className:"bg-gray-900 border border-gray-700 text-xs rounded px-2 py-1 w-full",style:{color:i},children:Wf.map(e=>t.jsx("option",{value:e,children:"sampleHold"===e?"S&H":e.charAt(0).toUpperCase()+e.slice(1)},e))})]}),t.jsx(I,{value:e.lfoDelay??0,min:0,max:1,onChange:e=>a({lfoDelay:e}),label:"Delay",color:o,size:"md"})]}),t.jsxs("div",{className:"mt-4",children:[t.jsx("h4",{className:"text-xs text-gray-400 mb-4",children:"LFO ROUTING"}),t.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-4 gap-6",children:[t.jsx(I,{value:e.lfoOscAmount??0,min:0,max:1,onChange:e=>a({lfoOscAmount:e}),label:"→ Pitch",color:o,size:"sm"}),t.jsx(I,{value:e.lfoFilterAmount??0,min:0,max:1,onChange:e=>a({lfoFilterAmount:e}),label:"→ Filter",color:o,size:"sm"}),t.jsx(I,{value:e.lfoAmpAmount??0,min:0,max:1,onChange:e=>a({lfoAmpAmount:e}),label:"→ Amp",color:o,size:"sm"}),t.jsx(I,{value:e.lfoPwAmount??0,min:0,max:1,onChange:e=>a({lfoPwAmount:e}),label:"→ PW",color:o,size:"sm"})]})]})]}),t.jsxs("div",{className:`p-4 rounded-xl border ${l}`,children:[t.jsx("h3",{className:"font-bold uppercase tracking-tight mb-4",style:{color:i},children:"ADDITIONAL"}),t.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-4 gap-6",children:[t.jsx(I,{value:e.noiseLevel??0,min:0,max:1,onChange:e=>a({noiseLevel:e}),label:"Noise",color:o,size:"sm"}),t.jsx(I,{value:e.subOscLevel??0,min:0,max:1,onChange:e=>a({subOscLevel:e}),label:"Sub Osc",color:o,size:"sm"}),t.jsx(I,{value:e.drift??0,min:0,max:1,onChange:e=>a({drift:e}),label:"Drift",color:o,size:"sm"})]})]})]})]})]})},qf=({instrument:e,onChange:a})=>{const[n,r]=he.useState(e.wam?.moduleUrl||""),[s,i]=he.useState(!1),[o,l]=he.useState(null),[c,u]=he.useState(null),[m,p]=he.useState({}),[h,f]=he.useState(!1),x=he.useRef(null),g=d(),b=he.useCallback((t,a)=>{p(e=>({...e,[t]:a}));const n=g.getInstrument(e.id,e,-1);n instanceof U&&n.setParameter(t,a)},[g,e]);he.useEffect(()=>{let t=!0,a=null;return(async()=>{if(x.current&&(x.current.innerHTML="",u(null),f(!1),e.wam?.moduleUrl))try{i(!0),l(null);const r=g.getInstrument(e.id,e,-1);if(!(r instanceof U)){const t=`Instrument ${e.id} is not a WAMSynth (got ${r?.constructor.name})`;return void l(t)}if(await r.ensureInitialized(),!t)return;const s=await r.createGui();if(s&&t)a=s,f(!0),x.current.appendChild(s);else if(!s&&t)try{const e=await r.getParameters();if(e&&Object.keys(e).length>0&&t){u(e);const t={};Object.entries(e).forEach(([e,a])=>{t[e]=a.defaultValue??a.minValue??0}),p(t)}else t&&(x.current.innerHTML='<div class="text-text-muted text-xs p-4 italic">Plugin does not provide a GUI or discoverable parameters</div>')}catch(n){t&&x.current&&(x.current.innerHTML='<div class="text-text-muted text-xs p-4 italic">Plugin does not provide a native GUI</div>')}}catch(r){const e=r instanceof Error?r.message:String(r);t&&l(e)}finally{t&&i(!1)}})(),()=>{t=!1,a&&a.parentElement&&a.parentElement.removeChild(a)}},[e.id,e.wam?.moduleUrl,g]);return t.jsxs("div",{className:"flex flex-col h-full bg-dark-bgSecondary p-4 space-y-4 overflow-hidden",children:[t.jsxs("div",{className:"flex flex-col gap-2",children:[t.jsxs("label",{className:"text-xs font-bold text-text-muted uppercase tracking-wider flex items-center gap-2",children:[t.jsx(jt,{size:14}),"WAM Module URL"]}),t.jsxs("form",{onSubmit:t=>{t.preventDefault();const r=n.trim();r&&(a({wam:{...e.wam,moduleUrl:r,pluginState:null}}),g.invalidateInstrument(e.id))},className:"flex gap-2",children:[t.jsx("input",{type:"text",value:n,onChange:e=>r(e.target.value),placeholder:"https://cdn.example.com/wam/plugin/index.js",className:"flex-1 bg-dark-bg border border-dark-border rounded px-3 py-1.5 text-sm text-text-primary focus:outline-none focus:border-accent-primary transition-colors"}),t.jsx("button",{type:"submit",disabled:s,className:"bg-accent-primary hover:bg-accent-primary/90 disabled:opacity-50 text-text-inverse px-4 py-1.5 rounded text-sm font-bold transition-all flex items-center gap-2",children:s?t.jsx(Je,{size:14,className:"animate-spin"}):"LOAD"})]}),t.jsxs("div",{className:"text-[10px] text-text-muted space-y-0.5",children:[t.jsx("p",{className:"italic",children:"Enter a WAM 2.0 module URL above. Example sources:"}),t.jsxs("ul",{className:"list-disc list-inside pl-1",children:[t.jsxs("li",{children:[t.jsx("a",{href:"https://github.com/webaudiomodules",target:"_blank",rel:"noreferrer",className:"text-accent-primary hover:underline",children:"github.com/webaudiomodules"})," — Official WAM ecosystem"]}),t.jsxs("li",{children:[t.jsx("a",{href:"https://mainline.i3s.unice.fr/wam2/",target:"_blank",rel:"noreferrer",className:"text-accent-primary hover:underline",children:"mainline.i3s.unice.fr/wam2"})," — WAM 2.0 demo host"]})]})]})]}),o&&t.jsxs("div",{className:"bg-accent-error/10 border border-accent-error/30 rounded-lg p-4 flex items-start gap-3",children:[t.jsx(rt,{size:18,className:"text-accent-error flex-shrink-0 mt-0.5"}),t.jsxs("div",{className:"flex-1",children:[t.jsx("h4",{className:"text-sm font-bold text-accent-error uppercase",children:"Loading Error"}),t.jsx("p",{className:"text-xs text-text-secondary mt-1",children:o})]})]}),s&&!o&&t.jsxs("div",{className:"flex-1 flex flex-col items-center justify-center gap-3 bg-dark-bg/20 rounded-xl border border-dark-border border-dashed",children:[t.jsx(Je,{size:32,className:"text-accent-primary animate-spin"}),t.jsx("p",{className:"text-sm text-text-muted font-mono animate-pulse",children:"Initializing Web Audio Module..."})]}),!s&&!o&&e.wam?.moduleUrl&&(h||!c)&&t.jsxs("div",{className:"flex-1 flex flex-col min-h-0",children:[t.jsxs("div",{className:"flex items-center justify-between mb-2",children:[t.jsx("span",{className:"text-xs font-bold text-text-muted uppercase",children:"Plugin Interface"}),t.jsxs("button",{onClick:()=>g.invalidateInstrument(e.id),className:"text-[10px] text-text-muted hover:text-text-primary flex items-center gap-1",children:[t.jsx(Je,{size:10})," Reload"]})]}),t.jsx("div",{ref:x,className:"flex-1 bg-black rounded-lg border border-dark-border overflow-auto flex items-center justify-center min-h-[300px]"})]}),c&&!h&&!s&&!o&&t.jsxs("div",{className:"flex-1 flex flex-col min-h-0",children:[t.jsxs("div",{className:"flex items-center justify-between mb-2",children:[t.jsxs("span",{className:"text-xs font-bold text-text-muted uppercase flex items-center gap-1.5",children:[t.jsx(_t,{size:12}),"Plugin Parameters"]}),t.jsxs("button",{onClick:()=>g.invalidateInstrument(e.id),className:"text-[10px] text-text-muted hover:text-text-primary flex items-center gap-1",children:[t.jsx(Je,{size:10})," Reload"]})]}),t.jsx("div",{className:"flex-1 overflow-auto space-y-1.5 p-3 bg-dark-bg rounded-lg border border-dark-border",children:Object.entries(c).map(([e,a])=>{const n=a.minValue??0,r=a.maxValue??1,s=r-n>10?1:.01,i=m[e]??a.defaultValue??n;return t.jsxs("div",{className:"flex items-center gap-3",children:[t.jsx("label",{className:"text-xs text-text-secondary w-32 truncate",title:a.label||e,children:a.label||e}),t.jsx("input",{type:"range",min:n,max:r,step:s,value:i,onChange:t=>b(e,parseFloat(t.target.value)),className:"flex-1 accent-accent-primary h-1.5"}),t.jsx("span",{className:"text-[10px] text-text-muted w-12 text-right font-mono",children:i.toFixed(2)})]},e)})}),t.jsx("div",{ref:x,className:"hidden"})]}),!e.wam?.moduleUrl&&!s&&t.jsxs("div",{className:"flex-1 flex flex-col items-center justify-center gap-4 text-center p-8 bg-dark-bg/10 rounded-xl border border-dark-border border-dashed",children:[t.jsx("div",{className:"p-4 rounded-full bg-dark-bgTertiary text-text-muted",children:t.jsx(jt,{size:48})}),t.jsxs("div",{children:[t.jsx("h3",{className:"text-lg font-bold text-text-primary",children:"No WAM Loaded"}),t.jsx("p",{className:"text-sm text-text-muted max-w-xs mx-auto mt-2",children:"Web Audio Modules are external plugins. Enter a URL above to load a synthesizer or effect."})]})]})]})};function Hf(e){const t=e.name.indexOf(":");return t>0?e.name.substring(t+1).trim():e.name}const Gf=({instrument:e,onChange:a})=>{const[n,r]=he.useState([]),[s,i]=he.useState(new Map),[o,l]=he.useState(!0),c=he.useRef(null),u="cyan-lineart"===B(e=>e.currentThemeId),m=u?"#00ffff":"#a78bfa",p=u?"#00ffff":"#a78bfa",h=u?"bg-[#051515] border-cyan-900/50":"bg-[#1a1a1a] border-purple-900/50";he.useEffect(()=>{let t=!1;const a=async()=>{try{const n=d(),s=`${e.id}--1`,o=n.instruments?.get(s);if(!o||!("getParams"in o))return void setTimeout(()=>{t||a()},500);"ensureInitialized"in o&&await o.ensureInitialized(),c.current=o;const u=o.getParams();if(!t){r(u);const e=new Map;for(const t of u)e.set(t.id,t.defaultValue);i(e),l(!1)}}catch(n){t||l(!1)}};return a(),()=>{t=!0}},[e.id]);const f=he.useCallback((e,t)=>{i(a=>{const n=new Map(a);return n.set(e,t),n}),c.current&&c.current.setParameter(e,t)},[]);if(o)return t.jsxs("div",{className:"flex items-center justify-center gap-2 p-8 text-gray-400",children:[t.jsx(kt,{size:16,className:"animate-spin"}),t.jsx("span",{children:"Loading parameters..."})]});if(0===n.length)return t.jsxs("div",{className:"flex items-center justify-center gap-2 p-8 text-gray-500",children:[t.jsx(_t,{size:16}),t.jsx("span",{children:"No parameters exposed by this synth"})]});const x=function(e){const t=new Map;for(const a of e){const e=a.name.indexOf(":"),n=e>0?a.name.substring(0,e):"Parameters";t.has(n)||t.set(n,[]),t.get(n).push(a)}return Array.from(t.entries()).map(([e,t])=>({name:e,params:t}))}(n);return t.jsx("div",{className:"flex flex-col gap-4 p-4 overflow-y-auto",children:x.map(e=>t.jsxs("div",{className:`p-4 rounded-xl border ${h}`,children:[t.jsxs("div",{className:"flex items-center gap-2 mb-4",children:[t.jsx(_t,{size:16,style:{color:m}}),t.jsx("h3",{className:"font-bold uppercase tracking-tight text-sm",style:{color:m},children:e.name})]}),t.jsx("div",{className:"grid grid-cols-3 md:grid-cols-5 lg:grid-cols-8 gap-3",children:e.params.map(e=>t.jsx(I,{label:Hf(e),value:s.get(e.id)??e.defaultValue,min:e.min,max:e.max,defaultValue:e.defaultValue,onChange:t=>f(e.id,t),size:"sm",color:p},e.id))})]},e.name))})},Kf=9,Xf=10,Yf=11,Zf=12,Qf=13,Jf=14,ex=15,tx=16,ax=["16'","5⅓'","8'","4'","2⅔'","2'","1⅗'","1⅓'","1'"],nx=["#a0522d","#a0522d","#f0f0f0","#f0f0f0","#222222","#f0f0f0","#222222","#222222","#f0f0f0"],rx=["V1","V2","V3","C1","C2","C3"],sx=["OFF","2ND","3RD"],ix=[8,8,8,0,0,0,0,0,0,0,1,0,.3,2,.5,0,.8],ox=({instrument:e,onChange:a})=>{const[n,r]=he.useState([...ix]),[s,i]=he.useState(!1),o=he.useRef(null),l="cyan-lineart"===B(e=>e.currentThemeId),c=l?"#00ffff":"#d4a017",u=l?"#00ffff":"#d4a017";he.useEffect(()=>{let t=!1;const a=async()=>{try{const n=d(),s=`${e.id}--1`,l=n.instruments?.get(s);if(!l||!("setParameter"in l))return void setTimeout(()=>{t||a()},500);if("ensureInitialized"in l&&await l.ensureInitialized(),o.current=l,"getParams"in l){const e=l.getParams().map(e=>e.defaultValue);t||(r(e),i(!0))}else t||i(!0)}catch(n){setTimeout(()=>{t||a()},1e3)}};return a(),()=>{t=!0}},[e.id]);const m=he.useCallback((e,t)=>{r(a=>{const n=[...a];return n[e]=t,n}),o.current&&o.current.setParameter(e,t)},[]);if(!s)return t.jsxs("div",{className:"flex flex-col gap-4 p-4",children:[t.jsxs("div",{className:"flex items-center justify-center gap-2 p-4 text-gray-400",children:[t.jsx(kt,{size:16,className:"animate-spin"}),t.jsx("span",{className:"text-sm",children:"Loading Tonewheel Organ..."})]}),t.jsx(Gf,{instrument:e,onChange:a})]});const p=l?"bg-[#051515] border-cyan-900/50":"bg-[#1a1a1a] border-amber-900/30";return t.jsxs("div",{className:"flex flex-col gap-4 p-4 overflow-y-auto",children:[t.jsxs("div",{className:`p-4 rounded-xl border ${p}`,children:[t.jsx("h3",{className:"font-bold uppercase tracking-tight text-sm mb-4",style:{color:c},children:"Drawbars"}),t.jsx("div",{className:"flex justify-center gap-1 sm:gap-2",children:ax.map((e,a)=>t.jsx(lx,{label:e,value:n[a],color:nx[a],accentColor:c,onChange:e=>m(a,e)},a))})]}),t.jsxs("div",{className:`p-4 rounded-xl border ${p}`,children:[t.jsx("h3",{className:"font-bold uppercase tracking-tight text-sm mb-3",style:{color:c},children:"Percussion"}),t.jsxs("div",{className:"flex flex-wrap items-center gap-4",children:[t.jsx("div",{className:"flex gap-1",children:sx.map((e,a)=>t.jsx("button",{onClick:()=>m(Kf,a),className:"px-3 py-1.5 text-xs font-bold rounded transition-all "+(Math.round(n[Kf])===a?"text-black":"bg-gray-800 text-gray-400 hover:bg-gray-700"),style:Math.round(n[Kf])===a?{backgroundColor:c}:{},children:e},e))}),t.jsx("div",{className:"w-px h-8 bg-gray-700"}),t.jsx("div",{className:"flex gap-1",children:["SLOW","FAST"].map((e,a)=>t.jsx("button",{onClick:()=>m(Xf,a),className:"px-3 py-1.5 text-xs font-bold rounded transition-all "+(Math.round(n[Xf])===a?"text-black":"bg-gray-800 text-gray-400 hover:bg-gray-700"),style:Math.round(n[Xf])===a?{backgroundColor:c}:{},children:e},e))}),t.jsx("div",{className:"w-px h-8 bg-gray-700"}),t.jsx("div",{className:"flex gap-1",children:["NORM","SOFT"].map((e,a)=>t.jsx("button",{onClick:()=>m(Yf,a),className:"px-3 py-1.5 text-xs font-bold rounded transition-all "+(Math.round(n[Yf])===a?"text-black":"bg-gray-800 text-gray-400 hover:bg-gray-700"),style:Math.round(n[Yf])===a?{backgroundColor:c}:{},children:e},e))})]})]}),t.jsxs("div",{className:`p-4 rounded-xl border ${p}`,children:[t.jsx("h3",{className:"font-bold uppercase tracking-tight text-sm mb-3",style:{color:c},children:"Vibrato / Chorus"}),t.jsxs("div",{className:"flex flex-wrap items-start gap-6",children:[t.jsx("div",{className:"flex gap-1",children:rx.map((e,a)=>t.jsx("button",{onClick:()=>m(Qf,a),className:"px-3 py-1.5 text-xs font-bold rounded transition-all "+(Math.round(n[Qf])===a?"text-black":"bg-gray-800 text-gray-400 hover:bg-gray-700"),style:Math.round(n[Qf])===a?{backgroundColor:c}:{},children:e},e))}),t.jsx(I,{label:"Depth",value:n[Jf],min:0,max:1,defaultValue:.5,onChange:e=>m(Jf,e),size:"sm",color:u})]})]}),t.jsxs("div",{className:`p-4 rounded-xl border ${p}`,children:[t.jsx("h3",{className:"font-bold uppercase tracking-tight text-sm mb-3",style:{color:c},children:"Tone & Output"}),t.jsxs("div",{className:"flex flex-wrap gap-4 justify-center",children:[t.jsx(I,{label:"Click",value:n[Zf],min:0,max:1,defaultValue:.3,onChange:e=>m(Zf,e),size:"sm",color:u}),t.jsx(I,{label:"Overdrive",value:n[ex],min:0,max:1,defaultValue:0,onChange:e=>m(ex,e),size:"sm",color:u}),t.jsx(I,{label:"Volume",value:n[tx],min:0,max:1,defaultValue:.8,onChange:e=>m(tx,e),size:"sm",color:u})]})]})]})},lx=fe.memo(({label:e,value:a,color:n,accentColor:r,onChange:s})=>{const i=he.useRef(null),o=he.useRef(!1),l=he.useCallback(e=>{o.current=!0,e.target.setPointerCapture(e.pointerId),u(e.clientY)},[]),d=he.useCallback(e=>{o.current&&u(e.clientY)},[]),c=he.useCallback(()=>{o.current=!1},[]),u=he.useCallback(e=>{if(!i.current)return;const t=i.current.getBoundingClientRect(),a=1-Math.max(0,Math.min(1,(e-t.top)/t.height)),n=Math.round(8*a);s(n)},[s]),m=a/8*100;return t.jsxs("div",{className:"flex flex-col items-center gap-1 select-none",children:[t.jsx("div",{className:"text-xs font-bold font-mono w-5 text-center",style:{color:r},children:Math.round(a)}),t.jsxs("div",{ref:i,className:"relative w-6 h-28 rounded bg-gray-900 border border-gray-700 cursor-pointer",onPointerDown:l,onPointerMove:d,onPointerUp:c,children:[t.jsx("div",{className:"absolute bottom-0 left-0 right-0 rounded-b transition-all duration-75",style:{height:`${m}%`,backgroundColor:n,opacity:.8}}),[1,2,3,4,5,6,7].map(e=>t.jsx("div",{className:"absolute left-0 right-0 h-px bg-gray-600 pointer-events-none",style:{bottom:e/8*100+"%"}},e)),t.jsx("div",{className:"absolute left-0 right-0 h-2 rounded transition-all duration-75",style:{bottom:`calc(${m}% - 4px)`,backgroundColor:n,boxShadow:`0 0 6px ${n}88`}})]}),t.jsx("div",{className:"text-[10px] text-gray-500 font-mono whitespace-nowrap",children:e})]})});lx.displayName="DrawbarSlider";const dx=0,cx=1,ux=2,mx=3,px=4,hx=5,fx=6,xx=7,gx=8,bx=9,yx=[.7,.5,4.5,.2,5,.15,.1,.15,.2,.8],vx=({instrument:e,onChange:a})=>{const[n,r]=he.useState([...yx]),[s,i]=he.useState(!1),o=he.useRef(null),l="cyan-lineart"===B(e=>e.currentThemeId),c=l?"#00ffff":"#2dd4bf",u=l?"#00ffff":"#2dd4bf";he.useEffect(()=>{let t=!1;const a=async()=>{try{const n=d(),s=`${e.id}--1`,l=n.instruments?.get(s);if(!l||!("setParameter"in l))return void setTimeout(()=>{t||a()},500);if("ensureInitialized"in l&&await l.ensureInitialized(),o.current=l,"getParams"in l){const e=l.getParams().map(e=>e.defaultValue);t||(r(e),i(!0))}else t||i(!0)}catch(n){setTimeout(()=>{t||a()},1e3)}};return a(),()=>{t=!0}},[e.id]);const m=he.useCallback((e,t)=>{r(a=>{const n=[...a];return n[e]=t,n}),o.current&&o.current.setParameter(e,t)},[]);if(!s)return t.jsxs("div",{className:"flex flex-col gap-4 p-4",children:[t.jsxs("div",{className:"flex items-center justify-center gap-2 p-4 text-gray-400",children:[t.jsx(kt,{size:16,className:"animate-spin"}),t.jsx("span",{className:"text-sm",children:"Loading Melodica..."})]}),t.jsx(Gf,{instrument:e,onChange:a})]});const p=l?"bg-[#051515] border-cyan-900/50":"bg-[#1a1a1a] border-teal-900/30";return t.jsxs("div",{className:"flex flex-col gap-4 p-4 overflow-y-auto",children:[t.jsxs("div",{className:`p-4 rounded-xl border ${p}`,children:[t.jsx("h3",{className:"font-bold uppercase tracking-tight text-sm mb-3",style:{color:c},children:"Breath & Dynamics"}),t.jsxs("div",{className:"flex flex-wrap gap-4 justify-center",children:[t.jsx(I,{label:"Breath",value:n[dx],min:0,max:1,defaultValue:.7,onChange:e=>m(dx,e),size:"md",color:u}),t.jsx(I,{label:"Attack",value:n[xx],min:0,max:1,defaultValue:.15,onChange:e=>m(xx,e),size:"md",color:u,formatValue:e=>`${Math.round(1e3*e)}ms`}),t.jsx(I,{label:"Release",value:n[gx],min:0,max:1,defaultValue:.2,onChange:e=>m(gx,e),size:"md",color:u,formatValue:e=>`${Math.round(1e3*e)}ms`})]})]}),t.jsxs("div",{className:`p-4 rounded-xl border ${p}`,children:[t.jsx("h3",{className:"font-bold uppercase tracking-tight text-sm mb-3",style:{color:c},children:"Tone"}),t.jsxs("div",{className:"flex flex-wrap gap-4 justify-center",children:[t.jsx(I,{label:"Brightness",value:n[cx],min:0,max:1,defaultValue:.5,onChange:e=>m(cx,e),size:"md",color:u}),t.jsx(I,{label:"Noise",value:n[hx],min:0,max:1,defaultValue:.15,onChange:e=>m(hx,e),size:"md",color:u,formatValue:e=>`${Math.round(100*e)}%`}),t.jsx(I,{label:"Detune",value:n[px],min:-50,max:50,defaultValue:5,onChange:e=>m(px,e),size:"md",color:u,bipolar:!0,formatValue:e=>`${e>0?"+":""}${Math.round(e)}ct`})]})]}),t.jsxs("div",{className:`p-4 rounded-xl border ${p}`,children:[t.jsx("h3",{className:"font-bold uppercase tracking-tight text-sm mb-3",style:{color:c},children:"Vibrato"}),t.jsxs("div",{className:"flex flex-wrap gap-4 justify-center",children:[t.jsx(I,{label:"Rate",value:n[ux],min:0,max:10,defaultValue:4.5,onChange:e=>m(ux,e),size:"md",color:u,formatValue:e=>`${e.toFixed(1)}Hz`}),t.jsx(I,{label:"Depth",value:n[mx],min:0,max:1,defaultValue:.2,onChange:e=>m(mx,e),size:"md",color:u})]})]}),t.jsxs("div",{className:`p-4 rounded-xl border ${p}`,children:[t.jsx("h3",{className:"font-bold uppercase tracking-tight text-sm mb-3",style:{color:c},children:"Playing & Output"}),t.jsxs("div",{className:"flex flex-wrap gap-4 justify-center",children:[t.jsx(I,{label:"Portamento",value:n[fx],min:0,max:1,defaultValue:.1,onChange:e=>m(fx,e),size:"md",color:u}),t.jsx(I,{label:"Volume",value:n[bx],min:0,max:1,defaultValue:.8,onChange:e=>m(bx,e),size:"md",color:u})]})]})]})},wx=[{id:"osc",label:"OSC"},{id:"filter",label:"FILTER"},{id:"env",label:"ENV"},{id:"lfo",label:"LFO"},{id:"fx",label:"FX"},{id:"master",label:"MASTER"},{id:"other",label:"OTHER"}],jx=["osc_1_","osc_2_","osc_3_","filter_1_","filter_2_","filter_fx_","env_1_","env_2_","env_3_","env_4_","env_5_","env_6_","lfo_1_","lfo_2_","lfo_3_","lfo_4_","lfo_5_","lfo_6_","lfo_7_","lfo_8_","chorus_","delay_","distortion_","reverb_","compressor_","flanger_","phaser_","eq_"],_x=new Set(["volume","polyphony","portamento_time","pitch_bend_range","velocity_track","oversampling","macro_control_1","macro_control_2","macro_control_3","macro_control_4"]);const kx=({instrument:e,onChange:a})=>{const[n,r]=he.useState("osc"),[s,i]=he.useState(new Map),[o,l]=he.useState(new Map),[c,u]=he.useState([]),[m,p]=he.useState(!1),h=he.useRef(null),f="cyan-lineart"===B(e=>e.currentThemeId),x=f?"#00ffff":"#b84eff",g=f?"#00ffff":"#b84eff";he.useEffect(()=>{let t=!1;const a=async()=>{try{const n=d(),r=`${e.id}--1`,s=n.instruments?.get(r);if(!s||!("setParameter"in s))return void setTimeout(()=>{t||a()},500);if("ensureInitialized"in s&&await s.ensureInitialized(),h.current=s,"getParams"in s){const e=s.getParams(),a=new Map,n=new Map;for(const t of e)a.set(t.name,t),n.set(t.id,t.defaultValue);t||(l(a),i(n),u(e),p(!0))}else t||p(!0)}catch(n){setTimeout(()=>{t||a()},1e3)}};return a(),()=>{t=!0}},[e.id]);const b=he.useCallback((e,t)=>{i(a=>{const n=new Map(a);return n.set(e,t),n}),h.current&&h.current.setParameter(e,t)},[]),y=he.useCallback(({name:e,label:a,min:n,max:r,fmt:i,logarithmic:l,bipolar:d,size:c})=>{const u=o.get(e);return u?t.jsx(I,{label:a,value:s.get(u.id)??u.defaultValue,min:n??u.min,max:r??u.max,defaultValue:u.defaultValue,onChange:e=>b(u.id,e),size:c||"sm",color:g,logarithmic:l,bipolar:d,formatValue:i}):null},[o,s,b,g]);if(!m)return t.jsxs("div",{className:"flex flex-col gap-4 p-4",children:[t.jsxs("div",{className:"flex items-center justify-center gap-2 p-4 text-gray-400",children:[t.jsx(kt,{size:16,className:"animate-spin"}),t.jsx("span",{className:"text-sm",children:"Loading Vital..."})]}),t.jsx(Gf,{instrument:e,onChange:a})]});const v=f?"bg-[#051515] border-cyan-900/50":"bg-[#1a1a1a] border-purple-900/30",w=f?"bg-[#061818]":"bg-[#111]";return t.jsxs("div",{className:"flex flex-col gap-0 overflow-y-auto",children:[t.jsx("div",{className:`flex gap-1 px-4 py-2 ${w} border-b border-gray-800`,children:wx.map(e=>t.jsx("button",{onClick:()=>r(e.id),className:"px-3 py-1.5 text-xs font-bold rounded transition-all "+(n===e.id?"text-black":"bg-gray-800 text-gray-400 hover:bg-gray-700"),style:n===e.id?{backgroundColor:x}:{},children:e.label},e.id))}),t.jsxs("div",{className:"p-4 flex flex-col gap-4",children:["osc"===n&&t.jsx(t.Fragment,{children:[1,2,3].map(e=>t.jsxs("div",{className:`p-4 rounded-xl border ${v}`,children:[t.jsxs("h3",{className:"font-bold uppercase tracking-tight text-sm mb-3",style:{color:x},children:["Oscillator ",e]}),t.jsxs("div",{className:"flex flex-wrap gap-3 justify-center",children:[t.jsx(y,{name:`osc_${e}_transpose`,label:"Transpose",min:-48,max:48,bipolar:!0,fmt:e=>`${e>0?"+":""}${Math.round(e)}st`}),t.jsx(y,{name:`osc_${e}_tune`,label:"Tune",min:-1,max:1,bipolar:!0,fmt:e=>`${(100*e).toFixed(0)}ct`}),t.jsx(y,{name:`osc_${e}_level`,label:"Level"}),t.jsx(y,{name:`osc_${e}_pan`,label:"Pan",min:-1,max:1,bipolar:!0,fmt:e=>0===e?"C":e<0?`L${Math.round(100*Math.abs(e))}`:`R${Math.round(100*e)}`}),t.jsx(y,{name:`osc_${e}_unison_voices`,label:"Voices",fmt:e=>`${Math.round(e)}`}),t.jsx(y,{name:`osc_${e}_unison_detune`,label:"Detune"}),t.jsx(y,{name:`osc_${e}_wave_frame`,label:"Frame"}),t.jsx(y,{name:`osc_${e}_spectral_morph_amount`,label:"Spec Morph"}),t.jsx(y,{name:`osc_${e}_distortion_amount`,label:"Distortion"})]})]},e))}),"filter"===n&&t.jsxs(t.Fragment,{children:[[1,2].map(e=>t.jsxs("div",{className:`p-4 rounded-xl border ${v}`,children:[t.jsxs("h3",{className:"font-bold uppercase tracking-tight text-sm mb-3",style:{color:x},children:["Filter ",e]}),t.jsxs("div",{className:"flex flex-wrap gap-3 justify-center",children:[t.jsx(y,{name:`filter_${e}_cutoff`,label:"Cutoff",fmt:e=>{const t=20*Math.pow(2,10*e);return t>=1e3?`${(t/1e3).toFixed(1)}k`:`${Math.round(t)}`}}),t.jsx(y,{name:`filter_${e}_resonance`,label:"Resonance"}),t.jsx(y,{name:`filter_${e}_drive`,label:"Drive"}),t.jsx(y,{name:`filter_${e}_blend`,label:"Blend"}),t.jsx(y,{name:`filter_${e}_keytrack`,label:"Keytrack",bipolar:!0}),t.jsx(y,{name:`filter_${e}_mix`,label:"Mix"})]})]},e)),t.jsxs("div",{className:`p-4 rounded-xl border ${v}`,children:[t.jsx("h3",{className:"font-bold uppercase tracking-tight text-sm mb-3",style:{color:x},children:"FX Filter"}),t.jsxs("div",{className:"flex flex-wrap gap-3 justify-center",children:[t.jsx(y,{name:"filter_fx_cutoff",label:"Cutoff"}),t.jsx(y,{name:"filter_fx_resonance",label:"Resonance"}),t.jsx(y,{name:"filter_fx_drive",label:"Drive"}),t.jsx(y,{name:"filter_fx_blend",label:"Blend"}),t.jsx(y,{name:"filter_fx_mix",label:"Mix"})]})]})]}),"env"===n&&t.jsx(t.Fragment,{children:[1,2,3,4,5,6].map(e=>t.jsxs("div",{className:`p-4 rounded-xl border ${v}`,children:[t.jsxs("h3",{className:"font-bold uppercase tracking-tight text-sm mb-3",style:{color:x},children:["Envelope ",e," ",1===e?"(Amp)":2===e?"(Filter)":""]}),t.jsxs("div",{className:"flex flex-wrap gap-3 justify-center",children:[t.jsx(y,{name:`env_${e}_delay`,label:"Delay",fmt:e=>`${(1e3*e).toFixed(0)}ms`}),t.jsx(y,{name:`env_${e}_attack`,label:"Attack",fmt:e=>`${(1e3*e).toFixed(0)}ms`}),t.jsx(y,{name:`env_${e}_hold`,label:"Hold",fmt:e=>`${(1e3*e).toFixed(0)}ms`}),t.jsx(y,{name:`env_${e}_decay`,label:"Decay",fmt:e=>`${(1e3*e).toFixed(0)}ms`}),t.jsx(y,{name:`env_${e}_sustain`,label:"Sustain",fmt:e=>`${Math.round(100*e)}%`}),t.jsx(y,{name:`env_${e}_release`,label:"Release",fmt:e=>`${(1e3*e).toFixed(0)}ms`}),t.jsx(y,{name:`env_${e}_attack_power`,label:"A Curve",bipolar:!0}),t.jsx(y,{name:`env_${e}_decay_power`,label:"D Curve",bipolar:!0}),t.jsx(y,{name:`env_${e}_release_power`,label:"R Curve",bipolar:!0})]})]},e))}),"lfo"===n&&t.jsx(Nx,{paramByName:o,paramValues:s,setParam:b,knobColor:g,accentColor:x,panelBg:v}),"fx"===n&&t.jsx(t.Fragment,{children:[{name:"chorus",label:"Chorus",params:["chorus_voices","chorus_frequency","chorus_depth","chorus_feedback","chorus_dry_wet","chorus_mod_depth"]},{name:"delay",label:"Delay",params:["delay_frequency","delay_feedback","delay_dry_wet","delay_filter_cutoff","delay_filter_spread"]},{name:"distortion",label:"Distortion",params:["distortion_drive","distortion_mix","distortion_filter_cutoff","distortion_filter_resonance"]},{name:"reverb",label:"Reverb",params:["reverb_size","reverb_decay_time","reverb_pre_low_cutoff","reverb_pre_high_cutoff","reverb_dry_wet","reverb_chorus_amount"]},{name:"compressor",label:"Compressor",params:["compressor_attack","compressor_release","compressor_low_gain","compressor_band_gain","compressor_high_gain","compressor_mix"]},{name:"flanger",label:"Flanger",params:["flanger_frequency","flanger_feedback","flanger_center","flanger_dry_wet","flanger_mod_depth"]},{name:"phaser",label:"Phaser",params:["phaser_frequency","phaser_feedback","phaser_center","phaser_dry_wet","phaser_mod_depth"]},{name:"eq",label:"EQ",params:["eq_low_cutoff","eq_low_gain","eq_band_cutoff","eq_band_gain","eq_high_cutoff","eq_high_gain"]}].map(e=>t.jsxs("div",{className:`p-4 rounded-xl border ${v}`,children:[t.jsxs("div",{className:"flex items-center gap-3 mb-3",children:[t.jsx($x,{name:`${e.name}_on`,paramByName:o,paramValues:s,setParam:b,accentColor:x}),t.jsx("h3",{className:"font-bold uppercase tracking-tight text-sm",style:{color:x},children:e.label})]}),t.jsx("div",{className:"flex flex-wrap gap-3 justify-center",children:e.params.map(a=>{const n=o.get(a);if(!n)return null;const r=a.replace(`${e.name}_`,"").replace(/_/g," ");return t.jsx(I,{label:r.length>10?r.substring(0,10):r,value:s.get(n.id)??n.defaultValue,min:n.min,max:n.max,defaultValue:n.defaultValue,onChange:e=>b(n.id,e),size:"sm",color:g},a)})})]},e.name))}),"master"===n&&t.jsxs("div",{className:`p-4 rounded-xl border ${v}`,children:[t.jsx("h3",{className:"font-bold uppercase tracking-tight text-sm mb-3",style:{color:x},children:"Master"}),t.jsxs("div",{className:"flex flex-wrap gap-4 justify-center",children:[t.jsx(y,{name:"volume",label:"Volume",size:"md"}),t.jsx(y,{name:"polyphony",label:"Polyphony",size:"md",fmt:e=>`${Math.round(e)}`}),t.jsx(y,{name:"portamento_time",label:"Porta Time",size:"md"}),t.jsx(y,{name:"pitch_bend_range",label:"PB Range",size:"md",fmt:e=>`${Math.round(e)}st`}),t.jsx(y,{name:"velocity_track",label:"Vel Track",size:"md"}),t.jsx(y,{name:"oversampling",label:"Oversample",size:"md",fmt:e=>`${Math.round(e)}x`})]}),t.jsx("h3",{className:"font-bold uppercase tracking-tight text-sm mb-3 mt-6",style:{color:x},children:"Macros"}),t.jsxs("div",{className:"flex flex-wrap gap-4 justify-center",children:[t.jsx(y,{name:"macro_control_1",label:"Macro 1",size:"md"}),t.jsx(y,{name:"macro_control_2",label:"Macro 2",size:"md"}),t.jsx(y,{name:"macro_control_3",label:"Macro 3",size:"md"}),t.jsx(y,{name:"macro_control_4",label:"Macro 4",size:"md"})]})]}),"other"===n&&t.jsx(Cx,{allParams:c,paramValues:s,setParam:b,knobColor:g,accentColor:x,panelBg:v})]})]})},Nx=({paramByName:e,paramValues:a,setParam:n,knobColor:r,accentColor:s,panelBg:i})=>{const[o,l]=he.useState(1);return t.jsxs(t.Fragment,{children:[t.jsx("div",{className:"flex gap-1 mb-2",children:[1,2,3,4,5,6,7,8].map(e=>t.jsxs("button",{onClick:()=>l(e),className:"px-2.5 py-1 text-xs font-bold rounded transition-all "+(o===e?"text-black":"bg-gray-800 text-gray-400 hover:bg-gray-700"),style:o===e?{backgroundColor:s}:{},children:["LFO ",e]},e))}),t.jsxs("div",{className:`p-4 rounded-xl border ${i}`,children:[t.jsxs("h3",{className:"font-bold uppercase tracking-tight text-sm mb-3",style:{color:s},children:["LFO ",o]}),t.jsx("div",{className:"flex flex-wrap gap-3 justify-center",children:["frequency","sync","tempo","fade_time","smooth_mode","delay_time","stereo","phase"].map(s=>{const i=`lfo_${o}_${s}`,l=e.get(i);if(!l)return null;const d=s.replace(/_/g," ");return t.jsx(I,{label:d.length>10?d.substring(0,10):d,value:a.get(l.id)??l.defaultValue,min:l.min,max:l.max,defaultValue:l.defaultValue,onChange:e=>n(l.id,e),size:"sm",color:r},i)})})]})]})},$x=({name:e,paramByName:a,paramValues:n,setParam:r,accentColor:s})=>{const i=a.get(e);if(!i)return null;const o=(n.get(i.id)??i.defaultValue)>.5;return t.jsx("button",{onClick:()=>r(i.id,o?0:1),className:"px-2 py-1 text-[10px] font-bold rounded transition-all "+(o?"text-black":"bg-gray-800 text-gray-500 hover:bg-gray-700"),style:o?{backgroundColor:s}:{},children:o?"ON":"OFF"})},Cx=({allParams:e,paramValues:a,setParam:n,knobColor:r,accentColor:s,panelBg:i})=>{const o=e.filter(e=>{return t=e.name,!(_x.has(t)||jx.some(e=>t.startsWith(e)));var t});if(0===o.length)return t.jsx("div",{className:`p-4 rounded-xl border ${i}`,children:t.jsx("p",{className:"text-sm text-gray-500",children:"All parameters are shown in the categorized tabs."})});const l=new Map;for(const t of o){const e=t.name.split("_").slice(0,2).join("_");l.has(e)||l.set(e,[]),l.get(e).push(t)}return t.jsxs(t.Fragment,{children:[t.jsx("div",{className:`p-3 rounded-lg border ${i}`,children:t.jsxs("p",{className:"text-xs text-gray-500 mb-1",children:[o.length," additional parameters not shown in other tabs"]})}),Array.from(l.entries()).map(([e,o])=>t.jsxs("div",{className:`p-4 rounded-xl border ${i}`,children:[t.jsx("h3",{className:"font-bold uppercase tracking-tight text-sm mb-3",style:{color:s},children:e.replace(/_/g," ")}),t.jsx("div",{className:"flex flex-wrap gap-3 justify-center",children:o.map(s=>{const i=s.name.replace(`${e}_`,"").replace(/_/g," ");return t.jsx(I,{label:i.length>12?i.substring(0,12):i,value:a.get(s.id)??s.defaultValue,min:s.min,max:s.max,defaultValue:s.defaultValue,onChange:e=>n(s.id,e),size:"sm",color:r},s.id)})})]},e))]})},Sx=0,Mx=15,zx=16,Tx=17,Ex=18,Ax=19,Ix=22,Ox=23,Rx=24,Vx=25,Px=26,Dx=30,Bx=31,Lx=32,Fx=33,Wx=34,Ux=35,qx=36,Hx=37,Gx=38,Kx=39,Xx=40,Yx=42,Zx=43,Qx=["Analog","Wavetable","Multi","Vector","Chip","FM","PM","Noise","WaveDraw","ChipDraw","SpecDraw"],Jx=["None","LP24","LP12","BP24","BP12","HP24","HP12","SEM12","Korg LP","Korg HP","Diode","Formant","Comb","Ring"],eg=({instrument:e,onChange:a})=>{const[n,r]=he.useState(new Array(44).fill(0)),[s,i]=he.useState(!1),o=he.useRef(null),l="cyan-lineart"===B(e=>e.currentThemeId),c=l?"#00ffff":"#4a9eff",u=l?"#00ffff":"#4a9eff";he.useEffect(()=>{let t=!1;const a=async()=>{try{const n=d(),s=`${e.id}--1`,l=n.instruments?.get(s);if(!l||!("setParameter"in l))return void setTimeout(()=>{t||a()},500);if("ensureInitialized"in l&&await l.ensureInitialized(),o.current=l,"getParams"in l){const e=l.getParams().map(e=>e.defaultValue);t||(r(e),i(!0))}else t||i(!0)}catch(n){setTimeout(()=>{t||a()},1e3)}};return a(),()=>{t=!0}},[e.id]);const m=he.useCallback((e,t)=>{r(a=>{const n=[...a];return n[e]=t,n}),o.current&&o.current.setParameter(e,t)},[]);if(!s)return t.jsxs("div",{className:"flex flex-col gap-4 p-4",children:[t.jsxs("div",{className:"flex items-center justify-center gap-2 p-4 text-gray-400",children:[t.jsx(kt,{size:16,className:"animate-spin"}),t.jsx("span",{className:"text-sm",children:"Loading Odin2..."})]}),t.jsx(Gf,{instrument:e,onChange:a})]});const p=l?"bg-[#051515] border-cyan-900/50":"bg-[#1a1a1a] border-blue-900/30";return t.jsxs("div",{className:"flex flex-col gap-4 p-4 overflow-y-auto",children:[t.jsxs("div",{className:`p-4 rounded-xl border ${p}`,children:[t.jsx("h3",{className:"font-bold uppercase tracking-tight text-sm mb-4",style:{color:c},children:"Oscillators"}),t.jsx("div",{className:"flex flex-col gap-4",children:[0,1,2].map(e=>{const a=Sx+5*e,r=a+1,s=a+2,i=a+3,o=a+4;return t.jsxs("div",{className:"flex flex-wrap items-center gap-3",children:[t.jsxs("span",{className:"text-xs font-bold w-10 shrink-0",style:{color:c},children:["OSC ",e+1]}),t.jsx("div",{className:"flex flex-wrap gap-1",children:Qx.map((e,r)=>t.jsx("button",{onClick:()=>m(a,r),className:"px-1.5 py-1 text-[9px] font-bold rounded transition-all "+(Math.round(n[a])===r?"text-black":"bg-gray-800 text-gray-400 hover:bg-gray-700"),style:Math.round(n[a])===r?{backgroundColor:c}:{},children:e},e))}),t.jsxs("div",{className:"flex gap-2 ml-auto",children:[t.jsx(I,{label:"Vol",value:n[r],min:0,max:1,defaultValue:.8,onChange:e=>m(r,e),size:"sm",color:u}),t.jsx(I,{label:"Oct",value:n[s],min:-4,max:4,defaultValue:0,step:1,onChange:e=>m(s,Math.round(e)),size:"sm",color:u,formatValue:e=>`${e>0?"+":""}${Math.round(e)}`}),t.jsx(I,{label:"Semi",value:n[i],min:-12,max:12,defaultValue:0,step:1,onChange:e=>m(i,Math.round(e)),size:"sm",color:u,bipolar:!0,formatValue:e=>`${e>0?"+":""}${Math.round(e)}`}),t.jsx(I,{label:"Fine",value:n[o],min:-1,max:1,defaultValue:0,onChange:e=>m(o,e),size:"sm",color:u,bipolar:!0,formatValue:e=>`${(100*e).toFixed(0)}ct`})]})]},e)})})]}),t.jsxs("div",{className:`p-4 rounded-xl border ${p}`,children:[t.jsx("h3",{className:"font-bold uppercase tracking-tight text-sm mb-4",style:{color:c},children:"Filters"}),t.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-2 gap-4",children:[t.jsxs("div",{className:"flex flex-col gap-3",children:[t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx("span",{className:"text-xs font-bold",style:{color:c},children:"FILTER 1"}),t.jsx(I,{label:"Env Amt",value:n[Gx],min:0,max:1,defaultValue:.5,onChange:e=>m(Gx,e),size:"sm",color:u,formatValue:e=>`${Math.round(100*e)}%`})]}),t.jsx("div",{className:"flex flex-wrap gap-1",children:Jx.map((e,a)=>t.jsx("button",{onClick:()=>m(Mx,a),className:"px-1.5 py-1 text-[9px] font-bold rounded transition-all "+(Math.round(n[Mx])===a?"text-black":"bg-gray-800 text-gray-400 hover:bg-gray-700"),style:Math.round(n[Mx])===a?{backgroundColor:c}:{},children:e},e))}),t.jsxs("div",{className:"flex gap-2 justify-center",children:[t.jsx(I,{label:"Freq",value:n[zx],min:20,max:2e4,defaultValue:1e3,onChange:e=>m(zx,e),size:"sm",color:u,logarithmic:!0,formatValue:e=>e>=1e3?`${(e/1e3).toFixed(1)}k`:`${Math.round(e)}`}),t.jsx(I,{label:"Res",value:n[Tx],min:0,max:1,defaultValue:0,onChange:e=>m(Tx,e),size:"sm",color:u}),t.jsx(I,{label:"Gain",value:n[Ex],min:0,max:2,defaultValue:1,onChange:e=>m(Ex,e),size:"sm",color:u,formatValue:e=>`x${e.toFixed(2)}`})]}),t.jsx("div",{className:"flex gap-1 justify-center",children:["Osc1","Osc2","Osc3"].map((e,a)=>{const r=Ax+a;return t.jsx("button",{onClick:()=>m(r,n[r]>.5?0:1),className:"px-2 py-1 text-[10px] font-bold rounded transition-all "+(n[r]>.5?"text-black":"bg-gray-800 text-gray-500 hover:bg-gray-700"),style:n[r]>.5?{backgroundColor:c}:{},children:e},e)})})]}),t.jsxs("div",{className:"flex flex-col gap-3",children:[t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx("span",{className:"text-xs font-bold",style:{color:c},children:"FILTER 2"}),t.jsx(I,{label:"Env Amt",value:n[Kx],min:0,max:1,defaultValue:0,onChange:e=>m(Kx,e),size:"sm",color:u,formatValue:e=>`${Math.round(100*e)}%`})]}),t.jsx("div",{className:"flex flex-wrap gap-1",children:Jx.map((e,a)=>t.jsx("button",{onClick:()=>m(Ix,a),className:"px-1.5 py-1 text-[9px] font-bold rounded transition-all "+(Math.round(n[Ix])===a?"text-black":"bg-gray-800 text-gray-400 hover:bg-gray-700"),style:Math.round(n[Ix])===a?{backgroundColor:c}:{},children:e},e))}),t.jsxs("div",{className:"flex gap-2 justify-center",children:[t.jsx(I,{label:"Freq",value:n[Ox],min:20,max:2e4,defaultValue:1e3,onChange:e=>m(Ox,e),size:"sm",color:u,logarithmic:!0,formatValue:e=>e>=1e3?`${(e/1e3).toFixed(1)}k`:`${Math.round(e)}`}),t.jsx(I,{label:"Res",value:n[Rx],min:0,max:1,defaultValue:0,onChange:e=>m(Rx,e),size:"sm",color:u}),t.jsx(I,{label:"Gain",value:n[Vx],min:0,max:2,defaultValue:1,onChange:e=>m(Vx,e),size:"sm",color:u,formatValue:e=>`x${e.toFixed(2)}`})]}),t.jsx("div",{className:"flex gap-1 justify-center",children:["Osc1","Osc2","Osc3","Fil1"].map((e,a)=>{const r=Px+a;return t.jsx("button",{onClick:()=>m(r,n[r]>.5?0:1),className:"px-2 py-1 text-[10px] font-bold rounded transition-all "+(n[r]>.5?"text-black":"bg-gray-800 text-gray-500 hover:bg-gray-700"),style:n[r]>.5?{backgroundColor:c}:{},children:e},e)})})]})]})]}),t.jsxs("div",{className:`p-4 rounded-xl border ${p}`,children:[t.jsx("h3",{className:"font-bold uppercase tracking-tight text-sm mb-4",style:{color:c},children:"Envelopes"}),t.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-2 gap-4",children:[t.jsxs("div",{children:[t.jsx("span",{className:"text-xs font-bold block mb-2",style:{color:c},children:"AMP EG"}),t.jsxs("div",{className:"flex gap-2 justify-center",children:[t.jsx(I,{label:"A",value:n[Dx],min:0,max:5,defaultValue:.01,onChange:e=>m(Dx,e),size:"sm",color:u,formatValue:e=>`${(1e3*e).toFixed(0)}ms`}),t.jsx(I,{label:"D",value:n[Bx],min:0,max:5,defaultValue:.3,onChange:e=>m(Bx,e),size:"sm",color:u,formatValue:e=>`${(1e3*e).toFixed(0)}ms`}),t.jsx(I,{label:"S",value:n[Lx],min:0,max:1,defaultValue:.7,onChange:e=>m(Lx,e),size:"sm",color:u,formatValue:e=>`${Math.round(100*e)}%`}),t.jsx(I,{label:"R",value:n[Fx],min:0,max:10,defaultValue:.5,onChange:e=>m(Fx,e),size:"sm",color:u,formatValue:e=>`${(1e3*e).toFixed(0)}ms`})]})]}),t.jsxs("div",{children:[t.jsx("span",{className:"text-xs font-bold block mb-2",style:{color:c},children:"FILTER EG"}),t.jsxs("div",{className:"flex gap-2 justify-center",children:[t.jsx(I,{label:"A",value:n[Wx],min:0,max:5,defaultValue:.01,onChange:e=>m(Wx,e),size:"sm",color:u,formatValue:e=>`${(1e3*e).toFixed(0)}ms`}),t.jsx(I,{label:"D",value:n[Ux],min:0,max:5,defaultValue:.3,onChange:e=>m(Ux,e),size:"sm",color:u,formatValue:e=>`${(1e3*e).toFixed(0)}ms`}),t.jsx(I,{label:"S",value:n[qx],min:0,max:1,defaultValue:.5,onChange:e=>m(qx,e),size:"sm",color:u,formatValue:e=>`${Math.round(100*e)}%`}),t.jsx(I,{label:"R",value:n[Hx],min:0,max:10,defaultValue:.5,onChange:e=>m(Hx,e),size:"sm",color:u,formatValue:e=>`${(1e3*e).toFixed(0)}ms`})]})]})]})]}),t.jsxs("div",{className:`p-4 rounded-xl border ${p}`,children:[t.jsx("h3",{className:"font-bold uppercase tracking-tight text-sm mb-3",style:{color:c},children:"Routing"}),t.jsx("div",{className:"flex gap-2 justify-center",children:["Fil1 → Amp","Fil2 → Amp"].map((e,a)=>{const r=Xx+a;return t.jsx("button",{onClick:()=>m(r,n[r]>.5?0:1),className:"px-3 py-1.5 text-xs font-bold rounded transition-all "+(n[r]>.5?"text-black":"bg-gray-800 text-gray-400 hover:bg-gray-700"),style:n[r]>.5?{backgroundColor:c}:{},children:e},e)})})]}),t.jsxs("div",{className:`p-4 rounded-xl border ${p}`,children:[t.jsx("h3",{className:"font-bold uppercase tracking-tight text-sm mb-3",style:{color:c},children:"Master"}),t.jsxs("div",{className:"flex gap-4 justify-center",children:[t.jsx(I,{label:"Volume",value:n[Yx],min:0,max:1,defaultValue:.8,onChange:e=>m(Yx,e),size:"md",color:u}),t.jsx(I,{label:"Glide",value:n[Zx],min:0,max:1,defaultValue:0,onChange:e=>m(Zx,e),size:"md",color:u,formatValue:e=>`${Math.round(1e3*e)}ms`})]})]})]})},tg=[{id:"osc",label:"OSC"},{id:"filter",label:"FILTER"},{id:"env",label:"ENV"},{id:"lfo",label:"LFO"},{id:"fx",label:"FX"},{id:"global",label:"GLOBAL"},{id:"other",label:"OTHER"}];const ag=({instrument:e,onChange:a})=>{const[n,r]=he.useState("osc"),[s,i]=he.useState("A"),[o,l]=he.useState(new Map),[c,u]=he.useState(new Map),[m,p]=he.useState([]),[h,f]=he.useState(!1),x=he.useRef(null),g="cyan-lineart"===B(e=>e.currentThemeId),b=g?"#00ffff":"#ff8c00",y=g?"#00ffff":"#ff8c00";he.useEffect(()=>{let t=!1;const a=async()=>{try{const n=d(),r=`${e.id}--1`,s=n.instruments?.get(r);if(!s||!("setParameter"in s))return void setTimeout(()=>{t||a()},500);if("ensureInitialized"in s&&await s.ensureInitialized(),x.current=s,"getParams"in s){const e=s.getParams(),a=new Map,n=new Map;for(const t of e)a.set(t.name,t),n.set(t.id,t.defaultValue);t||(u(a),l(n),p(e),f(!0))}else t||f(!0)}catch(n){setTimeout(()=>{t||a()},1e3)}};return a(),()=>{t=!0}},[e.id]);const v=he.useCallback((e,t)=>{l(a=>{const n=new Map(a);return n.set(e,t),n}),x.current&&x.current.setParameter(e,t)},[]),w=he.useCallback(({name:e,label:a,min:n,max:r,fmt:s,logarithmic:i,bipolar:l,size:d})=>{const u=c.get(e);return u?t.jsx(I,{label:a,value:o.get(u.id)??u.defaultValue,min:n??u.min,max:r??u.max,defaultValue:u.defaultValue,onChange:e=>v(u.id,e),size:d||"sm",color:y,logarithmic:i,bipolar:l,formatValue:s}):null},[c,o,v,y]),j=he.useCallback(e=>{const t=`${s} ${e}`;return m.filter(e=>e.name.startsWith(t))},[m,s]);if(!h)return t.jsxs("div",{className:"flex flex-col gap-4 p-4",children:[t.jsxs("div",{className:"flex items-center justify-center gap-2 p-4 text-gray-400",children:[t.jsx(kt,{size:16,className:"animate-spin"}),t.jsx("span",{className:"text-sm",children:"Loading Surge XT..."})]}),t.jsx(Gf,{instrument:e,onChange:a})]});const _=g?"bg-[#051515] border-cyan-900/50":"bg-[#1a1a1a] border-orange-900/30",k=g?"bg-[#061818]":"bg-[#111]";return t.jsxs("div",{className:"flex flex-col gap-0 overflow-y-auto",children:[t.jsxs("div",{className:`flex items-center gap-3 px-4 py-2 ${k} border-b border-gray-800`,children:[t.jsx("div",{className:"flex gap-1",children:["A","B"].map(e=>t.jsxs("button",{onClick:()=>i(e),className:"px-3 py-1.5 text-xs font-bold rounded transition-all "+(s===e?"text-black":"bg-gray-800 text-gray-400 hover:bg-gray-700"),style:s===e?{backgroundColor:b}:{},children:["Scene ",e]},e))}),t.jsx("div",{className:"w-px h-6 bg-gray-700"}),t.jsx("div",{className:"flex gap-1",children:tg.map(e=>t.jsx("button",{onClick:()=>r(e.id),className:"px-3 py-1.5 text-xs font-bold rounded transition-all "+(n===e.id?"text-black":"bg-gray-800 text-gray-400 hover:bg-gray-700"),style:n===e.id?{backgroundColor:b}:{},children:e.label},e.id))})]}),t.jsxs("div",{className:"p-4 flex flex-col gap-4",children:["osc"===n&&t.jsx(t.Fragment,{children:[1,2,3].map(e=>{const a=j(`Osc ${e}`);return 0===a.length?null:t.jsxs("div",{className:`p-4 rounded-xl border ${_}`,children:[t.jsxs("h3",{className:"font-bold uppercase tracking-tight text-sm mb-3",style:{color:b},children:[s," - Oscillator ",e]}),t.jsxs("div",{className:"flex flex-wrap gap-3 justify-center",children:[t.jsx(w,{name:`${s} Osc ${e} Pitch`,label:"Pitch",bipolar:!0,fmt:e=>`${e>0?"+":""}${Math.round(e)}st`}),a.filter(e=>!e.name.includes("Pitch")&&!e.name.includes("Type")).map(a=>{const n=a.name.replace(`${s} Osc ${e} `,"");return t.jsx(I,{label:n.length>10?n.substring(0,10):n,value:o.get(a.id)??a.defaultValue,min:a.min,max:a.max,defaultValue:a.defaultValue,onChange:e=>v(a.id,e),size:"sm",color:y},a.id)})]})]},e)})}),"filter"===n&&t.jsx(t.Fragment,{children:[1,2].map(e=>{const a=j(`Filter ${e}`);return 0===a.length?null:t.jsxs("div",{className:`p-4 rounded-xl border ${_}`,children:[t.jsxs("h3",{className:"font-bold uppercase tracking-tight text-sm mb-3",style:{color:b},children:[s," - Filter ",e]}),t.jsxs("div",{className:"flex flex-wrap gap-3 justify-center",children:[t.jsx(w,{name:`${s} Filter ${e} Frequency`,label:"Cutoff",logarithmic:!0}),t.jsx(w,{name:`${s} Filter ${e} Resonance`,label:"Resonance"}),t.jsx(w,{name:`${s} Filter ${e} Env Depth`,label:"Env Depth",bipolar:!0}),t.jsx(w,{name:`${s} Filter ${e} Keytrack`,label:"Keytrack",bipolar:!0}),a.filter(e=>{const t=e.name.toLowerCase();return!(t.includes("frequency")||t.includes("resonance")||t.includes("env depth")||t.includes("keytrack")||t.includes("type"))}).map(e=>{const a=e.name.replace(new RegExp(`${s} Filter \\d+ `),"");return t.jsx(I,{label:a.length>10?a.substring(0,10):a,value:o.get(e.id)??e.defaultValue,min:e.min,max:e.max,defaultValue:e.defaultValue,onChange:t=>v(e.id,t),size:"sm",color:y},e.id)})]})]},e)})}),"env"===n&&t.jsx(t.Fragment,{children:["Amp EG","Filter EG"].map(e=>t.jsxs("div",{className:`p-4 rounded-xl border ${_}`,children:[t.jsxs("h3",{className:"font-bold uppercase tracking-tight text-sm mb-3",style:{color:b},children:[s," - ",e]}),t.jsxs("div",{className:"flex flex-wrap gap-3 justify-center",children:[t.jsx(w,{name:`${s} ${e} Attack`,label:"Attack",fmt:e=>`${(1e3*e).toFixed(0)}ms`}),t.jsx(w,{name:`${s} ${e} Decay`,label:"Decay",fmt:e=>`${(1e3*e).toFixed(0)}ms`}),t.jsx(w,{name:`${s} ${e} Sustain`,label:"Sustain",fmt:e=>`${Math.round(100*e)}%`}),t.jsx(w,{name:`${s} ${e} Release`,label:"Release",fmt:e=>`${(1e3*e).toFixed(0)}ms`}),t.jsx(w,{name:`${s} ${e} Attack Shape`,label:"A Shape",bipolar:!0}),t.jsx(w,{name:`${s} ${e} Decay Shape`,label:"D Shape",bipolar:!0}),t.jsx(w,{name:`${s} ${e} Release Shape`,label:"R Shape",bipolar:!0})]})]},e))}),"lfo"===n&&t.jsx(ng,{activeScene:s,paramValues:o,setParam:v,knobColor:y,accentColor:b,panelBg:_,allParams:m}),"fx"===n&&t.jsx(rg,{allParams:m,paramValues:o,setParam:v,knobColor:y,accentColor:b,panelBg:_}),"global"===n&&t.jsxs("div",{className:`p-4 rounded-xl border ${_}`,children:[t.jsx("h3",{className:"font-bold uppercase tracking-tight text-sm mb-3",style:{color:b},children:"Global"}),t.jsxs("div",{className:"flex flex-wrap gap-4 justify-center",children:[t.jsx(w,{name:"Volume",label:"Volume",size:"md"}),t.jsx(w,{name:"Active Scene",label:"Scene",fmt:e=>e<.5?"A":"B"}),t.jsx(w,{name:"Scene Mode",label:"Mode",fmt:e=>["Single","Key Split","Dual","Ch Split"][Math.round(e)]||`${Math.round(e)}`}),t.jsx(w,{name:"Split Point",label:"Split",size:"md",fmt:e=>`${Math.round(e)}`}),t.jsx(w,{name:"FX Return A",label:"FX Ret A",size:"md"}),t.jsx(w,{name:"FX Return B",label:"FX Ret B",size:"md"}),t.jsx(w,{name:"Polyphony",label:"Poly",fmt:e=>`${Math.round(e)}`})]})]}),"other"===n&&t.jsx(sg,{allParams:m,paramValues:o,setParam:v,knobColor:y,accentColor:b,panelBg:_})]})]})},ng=({activeScene:e,paramValues:a,setParam:n,knobColor:r,accentColor:s,panelBg:i,allParams:o})=>{const[l,d]=he.useState(1),c=["LFO 1","LFO 2","LFO 3","LFO 4","LFO 5","LFO 6","S-LFO 1","S-LFO 2"],u=c[l-1]||"LFO 1",m=`${e} ${u}`,p=o.filter(e=>e.name.startsWith(m));return t.jsxs(t.Fragment,{children:[t.jsx("div",{className:"flex gap-1 flex-wrap mb-2",children:c.map((e,a)=>t.jsx("button",{onClick:()=>d(a+1),className:"px-2 py-1 text-[10px] font-bold rounded transition-all "+(l===a+1?"text-black":"bg-gray-800 text-gray-400 hover:bg-gray-700"),style:l===a+1?{backgroundColor:s}:{},children:e},e))}),t.jsxs("div",{className:`p-4 rounded-xl border ${i}`,children:[t.jsxs("h3",{className:"font-bold uppercase tracking-tight text-sm mb-3",style:{color:s},children:[e," - ",u]}),t.jsx("div",{className:"flex flex-wrap gap-3 justify-center",children:p.map(e=>{const s=e.name.replace(`${m} `,"");return t.jsx(I,{label:s.length>10?s.substring(0,10):s,value:a.get(e.id)??e.defaultValue,min:e.min,max:e.max,defaultValue:e.defaultValue,onChange:t=>n(e.id,t),size:"sm",color:r},e.id)})})]})]})},rg=({allParams:e,paramValues:a,setParam:n,knobColor:r,accentColor:s,panelBg:i})=>{const o=["A1","A2","A3","A4","B1","B2","B3","B4","S1","S2","S3","S4","G1","G2","G3","G4"].map(t=>{const a=`FX ${t}`,n=e.filter(e=>e.name.startsWith(a));return{slot:t,prefix:a,params:n}}).filter(e=>e.params.length>0);if(0===o.length){const o=e.filter(e=>e.name.startsWith("FX"));return 0===o.length?t.jsx("div",{className:`p-4 rounded-xl border ${i}`,children:t.jsx("p",{className:"text-sm text-gray-500",children:"No FX parameters available."})}):t.jsxs("div",{className:`p-4 rounded-xl border ${i}`,children:[t.jsx("h3",{className:"font-bold uppercase tracking-tight text-sm mb-3",style:{color:s},children:"Effects"}),t.jsx("div",{className:"flex flex-wrap gap-3 justify-center",children:o.map(e=>t.jsx(I,{label:e.name.replace("FX ","").substring(0,10),value:a.get(e.id)??e.defaultValue,min:e.min,max:e.max,defaultValue:e.defaultValue,onChange:t=>n(e.id,t),size:"sm",color:r},e.id))})]})}return t.jsx(t.Fragment,{children:o.map(({slot:e,prefix:o,params:l})=>t.jsxs("div",{className:`p-4 rounded-xl border ${i}`,children:[t.jsxs("h3",{className:"font-bold uppercase tracking-tight text-sm mb-3",style:{color:s},children:["FX ",e]}),t.jsx("div",{className:"flex flex-wrap gap-3 justify-center",children:l.map(e=>{const s=e.name.replace(`${o} `,"");return t.jsx(I,{label:s.length>10?s.substring(0,10):s,value:a.get(e.id)??e.defaultValue,min:e.min,max:e.max,defaultValue:e.defaultValue,onChange:t=>n(e.id,t),size:"sm",color:r},e.id)})})]},e))})},sg=({allParams:e,paramValues:a,setParam:n,knobColor:r,accentColor:s,panelBg:i})=>{const o=e.filter(e=>!function(e){for(const t of["A","B"]){for(const a of[1,2,3])if(e.startsWith(`${t} Osc ${a} `))return!0;for(const a of[1,2])if(e.startsWith(`${t} Filter ${a} `))return!0;if(e.startsWith(`${t} Amp EG `))return!0;if(e.startsWith(`${t} Filter EG `))return!0;for(const a of[1,2,3,4,5,6])if(e.startsWith(`${t} LFO ${a} `))return!0;for(const a of[1,2])if(e.startsWith(`${t} S-LFO ${a} `))return!0}return!!e.startsWith("FX ")||!!new Set(["Volume","Active Scene","Scene Mode","Split Point","FX Return A","FX Return B","Polyphony"]).has(e)}(e.name));if(0===o.length)return t.jsx("div",{className:`p-4 rounded-xl border ${i}`,children:t.jsx("p",{className:"text-sm text-gray-500",children:"All parameters are shown in the categorized tabs."})});const l=new Map;for(const t of o){const e=t.name.split(" "),a=e.length>2?e.slice(0,2).join(" "):e[0];l.has(a)||l.set(a,[]),l.get(a).push(t)}return t.jsxs(t.Fragment,{children:[t.jsx("div",{className:`p-3 rounded-lg border ${i}`,children:t.jsxs("p",{className:"text-xs text-gray-500 mb-1",children:[o.length," additional parameters not shown in other tabs"]})}),Array.from(l.entries()).map(([e,o])=>t.jsxs("div",{className:`p-4 rounded-xl border ${i}`,children:[t.jsx("h3",{className:"font-bold uppercase tracking-tight text-sm mb-3",style:{color:s},children:e}),t.jsx("div",{className:"flex flex-wrap gap-3 justify-center",children:o.map(s=>{const i=s.name.replace(`${e} `,"");return t.jsx(I,{label:i.length>12?i.substring(0,12):i,value:a.get(s.id)??s.defaultValue,min:s.min,max:s.max,defaultValue:s.defaultValue,onChange:e=>n(s.id,e),size:"sm",color:r},s.id)})})]},e))]})},ig={PU1:"#00ffcc",PU2:"#00ccff",WAV:"#44ff88",NOI:"#ff44aa",TRI:"#88ff44",DPCM:"#ffaa44",SQ1:"#00ffcc",SQ2:"#00ccff",A:"#00ffcc",B:"#00ccff",C:"#44ff88"},og="#00d4aa";function lg({channelNames:e=[],width:a,height:n=180}){const r=he.useRef(null),s=he.useRef([]),i=he.useRef(0),o=he.useRef(0),{channelData:l,numChannels:d,isActive:c}=q(),u="cyan-lineart"===B(e=>e.currentThemeId),m=u?"#030808":"#0a0a0b",p=u?"rgba(0, 255, 255, 0.06)":"rgba(100, 100, 120, 0.1)",h=u?"rgba(0, 255, 255, 0.15)":"rgba(100, 100, 120, 0.2)",f=u?"#00ffff":"#888",x=u?"linear-gradient(180deg, #0a1515 0%, #050c0c 100%)":"linear-gradient(180deg, #252525 0%, #1a1a1a 100%)",g=d||e.length||4,b=he.useMemo(()=>e.length>0?e:Array.from({length:g},(e,t)=>`CH${t+1}`),[e,g]),y=he.useCallback((e,t,a)=>{const n=e.getContext("2d");if(!n)return;const r=window.devicePixelRatio||1,s=e.clientWidth,i=e.clientHeight;e.width===s*r&&e.height===i*r||(e.width=s*r,e.height=i*r,n.scale(r,r)),n.fillStyle=m,n.fillRect(0,0,s,i);const o=s-8,l=i-8;n.strokeStyle=p,n.lineWidth=.5;for(let u=1;u<4;u++){const e=4+l/4*u;n.beginPath(),n.moveTo(4,e),n.lineTo(4+o,e),n.stroke()}for(let u=1;u<4;u++){const e=4+o/4*u;n.beginPath(),n.moveTo(e,4),n.lineTo(e,4+l),n.stroke()}if(n.strokeStyle=h,n.lineWidth=1,n.beginPath(),n.moveTo(4,4+l/2),n.lineTo(4+o,4+l/2),n.stroke(),t&&t.length>0){const e=ig[a]||og;n.strokeStyle=e,n.lineWidth=1.5,n.lineJoin="round",n.lineCap="round",n.beginPath();const r=t.length/o;for(let a=0;a<o;a++){const e=4+l/2-t[Math.floor(a*r)]/32768*(l/2)*.9;0===a?n.moveTo(4+a,e):n.lineTo(4+a,e)}n.stroke(),n.strokeStyle=(d=e,c=.2,`rgba(${parseInt(d.slice(1,3),16)}, ${parseInt(d.slice(3,5),16)}, ${parseInt(d.slice(5,7),16)}, ${c})`),n.lineWidth=4,n.stroke()}var d,c},[m,p,h]);he.useEffect(()=>{const e=t=>{if(t-o.current<33)return void(i.current=requestAnimationFrame(e));o.current=t;const a=q.getState().channelData;for(let e=0;e<s.current.length;e++){const t=s.current[e];if(!t)continue;const n=b[e]||`CH${e+1}`;y(t,a[e]||null,n)}i.current=requestAnimationFrame(e)};return i.current=requestAnimationFrame(e),()=>{i.current&&cancelAnimationFrame(i.current)}},[y,b]);const v=g<=2?g:g<=4?2:3,w=Math.ceil(g/v),j=Math.max(60,(n-40)/w-20);return t.jsxs("div",{ref:r,className:"rounded-md overflow-hidden border border-black/30",style:{background:x,width:a||"100%",boxShadow:"0 8px 24px rgba(0,0,0,0.4), inset 0 1px 0 rgba(255,255,255,0.05)"},children:[t.jsxs("div",{className:"flex items-center justify-between px-3 py-1.5",style:{borderBottom:"1px solid rgba(0,0,0,0.4)",boxShadow:"0 1px 0 rgba(255,255,255,0.03)"},children:[t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx("svg",{width:"12",height:"12",viewBox:"0 0 12 12",fill:"none",children:t.jsx("path",{d:"M1 6 L3 6 L4 2 L5 10 L6 4 L7 8 L8 6 L11 6",stroke:f,strokeWidth:"1.2",strokeLinecap:"round",strokeLinejoin:"round",fill:"none"})}),t.jsx("span",{className:"text-[9px] font-bold uppercase tracking-wider",style:{color:f},children:"Channel Oscilloscope"})]}),c&&t.jsxs("span",{className:"text-[8px] uppercase tracking-wider opacity-50",style:{color:f},children:[g,"ch"]})]}),t.jsx("div",{className:"p-2",style:{display:"grid",gridTemplateColumns:`repeat(${v}, 1fr)`,gap:"6px"},children:Array.from({length:g},(e,a)=>t.jsxs("div",{className:"flex flex-col items-center",children:[t.jsx("div",{className:"w-full rounded-sm overflow-hidden",style:{border:"1px solid "+(u?"rgba(0,255,255,0.1)":"rgba(255,255,255,0.06)"),boxShadow:"inset 0 0 8px rgba(0,0,0,0.5), 0 0 1px "+(u?"rgba(0,255,255,0.05)":"rgba(255,255,255,0.02)")},children:t.jsx("canvas",{ref:e=>{s.current[a]=e},style:{width:"100%",height:j,display:"block"}})}),t.jsx("span",{className:"text-[8px] font-bold uppercase tracking-wider mt-1",style:{color:ig[b[a]]||og,opacity:.7},children:b[a]})]},a))})]})}function dg({instrumentId:e,width:a,height:n=120,color:r}){const s=he.useRef(null),i=he.useRef(null),o=he.useRef(0),l=he.useRef(null),[c,u]=he.useState(!1),m="cyan-lineart"===B(e=>e.currentThemeId),p=m?"#030808":"#0a0a0b",h=m?"rgba(0, 255, 255, 0.06)":"rgba(100, 100, 120, 0.1)",f=m?"rgba(0, 255, 255, 0.15)":"rgba(100, 100, 120, 0.2)",x=r||(m?"#00ffff":"#00d4aa"),g=m?"linear-gradient(180deg, #0a1515 0%, #050c0c 100%)":"linear-gradient(180deg, #252525 0%, #1a1a1a 100%)",b=he.useCallback(()=>{const e=s.current;if(!e)return;const t=e.getContext("2d");if(!t)return;const a=window.devicePixelRatio||1,n=e.clientWidth,r=e.clientHeight;e.width===n*a&&e.height===r*a||(e.width=n*a,e.height=r*a,t.scale(a,a)),t.fillStyle=p,t.fillRect(0,0,n,r);const i=n-8,d=r-8;t.strokeStyle=h,t.lineWidth=1;for(let s=1;s<4;s++){const e=4+d*s/4;t.beginPath(),t.moveTo(4,e),t.lineTo(n-4,e),t.stroke()}for(let s=1;s<8;s++){const e=4+i*s/8;t.beginPath(),t.moveTo(e,4),t.lineTo(e,r-4),t.stroke()}t.strokeStyle=f,t.lineWidth=1,t.beginPath(),t.moveTo(4,r/2),t.lineTo(n-4,r/2),t.stroke();const c=l.current;if(c&&c.length>0){t.strokeStyle=x,t.lineWidth=1.5,t.beginPath();const e=c.length,a=i/e;for(let n=0;n<e;n++){const e=4+n*a,r=4+d/2-Math.max(-1,Math.min(1,c[n]))*(d/2-4);0===n?t.moveTo(e,r):t.lineTo(e,r)}t.stroke(),t.strokeStyle=x,t.globalAlpha=.3,t.lineWidth=3,t.stroke(),t.globalAlpha=1}else t.strokeStyle=x,t.globalAlpha=.3,t.lineWidth=1,t.beginPath(),t.moveTo(4,r/2),t.lineTo(n-4,r/2),t.stroke(),t.globalAlpha=1;o.current=requestAnimationFrame(b)},[p,h,f,x]);return he.useEffect(()=>{const t=d().getMAMEChipSynth(e);if(!t)return void u(!1);u(!0);const a=t.onOscData(e=>{l.current=e});return o.current=requestAnimationFrame(b),()=>{a(),o.current&&cancelAnimationFrame(o.current)}},[e,b]),c?t.jsxs("div",{ref:i,className:"rounded-lg overflow-hidden",style:{background:g,border:m?"1px solid rgba(0, 255, 255, 0.2)":"1px solid rgba(255, 255, 255, 0.08)",width:a||"100%"},children:[t.jsx("div",{className:"px-2 py-1 flex items-center justify-between border-b",style:{borderColor:m?"rgba(0, 255, 255, 0.1)":"rgba(255, 255, 255, 0.05)"},children:t.jsx("span",{className:"text-[10px] font-mono uppercase tracking-wider",style:{color:m?"#00ffff":"#888"},children:"Oscilloscope"})}),t.jsx("canvas",{ref:s,style:{width:"100%",height:n},className:"block"})]}):null}const cg={[H.VOLUME]:{label:"Volume",min:0,max:127,signed:!1,color:"#00d4aa",description:"Volume envelope (0-127)"},[H.ARPEGGIO]:{label:"Arpeggio",min:-24,max:24,signed:!0,color:"#ff6b6b",description:"Semitone offset (-24 to +24)"},[H.DUTY]:{label:"Duty/Wave",min:0,max:7,signed:!1,color:"#ffd93d",description:"Duty cycle or wave mode"},[H.WAVETABLE]:{label:"Wavetable",min:0,max:63,signed:!1,color:"#6bcbff",description:"Wavetable index select"},[H.PITCH]:{label:"Pitch",min:-128,max:127,signed:!0,color:"#c56bff",description:"Fine pitch offset (cents)"},[H.PANNING]:{label:"Panning",min:-127,max:127,signed:!0,color:"#ff9f43",description:"Left/Right panning"},[H.PHASE_RESET]:{label:"Phase Reset",min:0,max:1,signed:!1,color:"#ff6b9d",description:"Trigger phase reset (0/1)"},[H.ALG]:{label:"Algorithm",min:0,max:7,signed:!1,color:"#4ecdc4",description:"FM algorithm select"},[H.FB]:{label:"Feedback",min:0,max:7,signed:!1,color:"#45b7d1",description:"FM feedback amount"}},ug={"vol-sustain":{name:"Sustain",data:[127],loop:0},"vol-decay":{name:"Decay",data:[127,100,80,64,50,40,32,25,20,15,10,5,0]},"vol-pluck":{name:"Pluck",data:[127,80,50,30,15,5,0]},"vol-swell":{name:"Swell",data:[0,10,25,45,70,100,127],loop:6},"vol-tremolo":{name:"Tremolo",data:[127,100,80,100,127,100,80,100],loop:0},"arp-maj":{name:"Major",data:[0,4,7],loop:0},"arp-min":{name:"Minor",data:[0,3,7],loop:0},"arp-oct":{name:"Octave",data:[0,12],loop:0},"arp-5th":{name:"Fifth",data:[0,7],loop:0},"arp-dim":{name:"Dim",data:[0,3,6],loop:0},"pitch-vibrato":{name:"Vibrato",data:[0,5,10,5,0,-5,-10,-5],loop:0},"pitch-wobble":{name:"Wobble",data:[0,15,0,-15],loop:0},"pitch-slide-up":{name:"Slide Up",data:[0,5,10,15,20,25,30]},"pitch-slide-dn":{name:"Slide Down",data:[0,-5,-10,-15,-20,-25,-30]},"duty-cycle":{name:"Cycle",data:[0,1,2,3],loop:0},"duty-pulse":{name:"Pulse",data:[0,1,0,1,2,1],loop:0}};function mg({macro:e,onChange:a,label:n,min:r=0,max:s=127,signed:i=!1,color:o="#00d4aa",height:l=80}){const d=he.useRef(null),[c,u]=he.useState(!1),[m,p]=he.useState(null),h="cyan-lineart"===B(e=>e.currentThemeId),f=h?"#00ffff":o,x=h?"#030808":"#0a0a0b",g=h?"rgba(0, 255, 255, 0.08)":"rgba(100, 100, 120, 0.15)",b=h?"#00ffff":"#888",y=e.data.length>0?e.data:[i?0:Math.floor(s/2)],v=y.length,w=he.useCallback(()=>{const t=d.current;if(!t)return;const a=t.getContext("2d");if(!a)return;const n=window.devicePixelRatio||1,o=Math.max(200,12*v),c=l;t.width=o*n,t.height=c*n,t.style.width=o+"px",t.style.height=c+"px",a.scale(n,n);const u=o,p=c,w=(u-4)/Math.max(1,v),j=s-r;a.fillStyle=x,a.fillRect(0,0,u,p),a.strokeStyle=g,a.lineWidth=1;for(let e=0;e<=4;e++){const t=2+(p-4)*e/4;a.beginPath(),a.moveTo(2,t),a.lineTo(u-2,t),a.stroke()}if(i&&(a.strokeStyle=h?"rgba(0, 255, 255, 0.3)":"rgba(255, 255, 255, 0.2)",a.beginPath(),a.moveTo(2,p/2),a.lineTo(u-2,p/2),a.stroke()),e.loop>=0&&e.loop<v){const t=2+e.loop*w;a.fillStyle="rgba(0, 255, 0, 0.3)",a.fillRect(t,0,u-t,p),a.strokeStyle="#00ff00",a.lineWidth=2,a.beginPath(),a.moveTo(t,0),a.lineTo(t,p),a.stroke()}if(e.release>=0&&e.release<v){const t=2+e.release*w;a.strokeStyle="#ff6600",a.lineWidth=2,a.setLineDash([4,4]),a.beginPath(),a.moveTo(t,0),a.lineTo(t,p),a.stroke(),a.setLineDash([])}for(let e=0;e<v;e++){const t=2+e*w,n=y[e],o=(n-r)/j,l=o*(p-4);if(i){const i=p/2,l=n>=0?i-(o-.5)*(p-4):i,d=Math.abs(n)/(s-r)*(p-4);a.fillStyle=m===e?"#ffffff":f,a.fillRect(t+1,l,w-2,d)}else a.fillStyle=m===e?"#ffffff":f,a.fillRect(t+1,p-2-l,w-2,l);e%8==0&&(a.fillStyle=b,a.font="8px monospace",a.fillText(String(e),t+2,p-2))}},[y,v,l,r,s,i,e.loop,e.release,m,f,x,g,b,h]);he.useEffect(()=>{w()},[w]);const j=he.useCallback(e=>{const t=d.current;if(!t)return null;const a=t.getBoundingClientRect(),n=e.clientX-a.left,r=a.width/v;return Math.floor(n/r)},[v]),_=he.useCallback(e=>{const t=d.current;if(!t)return 0;const a=t.getBoundingClientRect(),n=1-(e.clientY-a.top)/a.height,i=s-r;return Math.round(r+n*i)},[r,s]),k=he.useCallback(t=>{const n=j(t),i=_(t);if(null===n||n<0||n>=v)return;u(!0),p(n);const o=[...y];o[n]=Math.max(r,Math.min(s,i)),a({...e,data:o})},[j,_,y,v,r,s,a,e]),N=he.useCallback(t=>{if(!c)return;const n=j(t),i=_(t);if(null===n||n<0||n>=v)return;p(n);const o=[...y];o[n]=Math.max(r,Math.min(s,i)),a({...e,data:o})},[c,j,_,y,v,r,s,a,e]),$=he.useCallback(()=>{u(!1),p(null)},[]),C=he.useCallback(()=>{const t=[...y,y[y.length-1]||0];a({...e,data:t})},[y,a,e]),S=he.useCallback(()=>{if(y.length<=1)return;const t=y.slice(0,-1),n=e.loop>=t.length?t.length-1:e.loop,r=e.release>=t.length?-1:e.release;a({...e,data:t,loop:n,release:r})},[y,a,e]),M=he.useCallback(()=>{const t=i?0:Math.floor(s/2);a({...e,data:[t],loop:-1,release:-1})},[a,e,i,s]),z=he.useCallback(()=>{null!==m&&a({...e,loop:e.loop===m?-1:m})},[m,a,e]),T=he.useCallback(()=>{null!==m&&a({...e,release:e.release===m?-1:m})},[m,a,e]);return t.jsxs("div",{className:"flex flex-col gap-1",children:[t.jsxs("div",{className:"flex items-center justify-between px-1",children:[t.jsx("span",{className:"text-[10px] font-mono uppercase tracking-wider",style:{color:f},children:n}),t.jsxs("div",{className:"flex items-center gap-1",children:[t.jsxs("span",{className:"text-[9px] text-slate-500",children:[v," steps"]}),t.jsx("button",{onClick:C,className:"px-1 py-0.5 text-[9px] bg-dark-surface hover:bg-dark-border rounded",title:"Add step",children:"+"}),t.jsx("button",{onClick:S,className:"px-1 py-0.5 text-[9px] bg-dark-surface hover:bg-dark-border rounded",title:"Remove step",children:"-"}),t.jsx("button",{onClick:z,className:"px-1 py-0.5 text-[9px] bg-green-900/50 hover:bg-green-800/50 rounded",title:"Set loop point",children:"L"}),t.jsx("button",{onClick:T,className:"px-1 py-0.5 text-[9px] bg-orange-900/50 hover:bg-orange-800/50 rounded",title:"Set release point",children:"R"}),t.jsx("button",{onClick:M,className:"px-1 py-0.5 text-[9px] bg-red-900/50 hover:bg-red-800/50 rounded",title:"Clear",children:t.jsx(We,{size:10})})]})]}),t.jsx("div",{className:"relative overflow-x-auto",children:t.jsx("canvas",{ref:d,className:"cursor-crosshair rounded",onMouseDown:k,onMouseMove:N,onMouseUp:$,onMouseLeave:$})})]})}function pg({instrumentId:e,macros:a,onChange:n,chipCapabilities:r={}}){const[s,i]=he.useState(new Set([H.VOLUME])),[o,l]=he.useState(null),c="cyan-lineart"===B(e=>e.currentThemeId),u=he.useMemo(()=>{const e=[H.VOLUME,H.ARPEGGIO,H.PITCH];return r.hasWavetable&&e.push(H.WAVETABLE),r.hasNoise&&e.push(H.DUTY),r.hasPanning&&e.push(H.PANNING),r.hasFM&&e.push(H.ALG,H.FB),e.push(H.PHASE_RESET),e},[r]),m=he.useCallback(e=>{const t=a.find(t=>t.type===e);if(t)return t;const n=cg[e];return{type:e,data:[n?.signed?0:n?.max||127],loop:-1,release:-1}},[a]),p=he.useCallback((t,r)=>{const s=a.filter(e=>e.type!==t);s.push(r),n(s);const i=d().getMAMEChipSynth(e);i&&i.setMacro({type:r.type,data:r.data,loop:r.loop,release:r.release})},[a,n,e]),h=he.useCallback((e,t)=>{const a=ug[t];if(!a)return;const n=m(e);p(e,{...n,data:[...a.data],loop:a.loop??-1}),l(null)},[m,p]),f=he.useCallback(e=>{i(t=>{const a=new Set(t);return a.has(e)?a.delete(e):a.add(e),a})},[]),x=he.useCallback(e=>{const t=e===H.VOLUME?"vol-":e===H.ARPEGGIO?"arp-":e===H.PITCH?"pitch-":e===H.DUTY?"duty-":"";return Object.keys(ug).filter(e=>e.startsWith(t))},[]),g=c?"linear-gradient(180deg, #0a1515 0%, #050c0c 100%)":"linear-gradient(180deg, #1e1e1e 0%, #151515 100%)",b=c?"rgba(0, 255, 255, 0.2)":"rgba(255, 255, 255, 0.08)";return t.jsxs("div",{className:"rounded-lg overflow-hidden",style:{background:g,border:`1px solid ${b}`},children:[t.jsxs("div",{className:"px-3 py-2 flex items-center justify-between border-b",style:{borderColor:b},children:[t.jsx("span",{className:"text-xs font-semibold uppercase tracking-wider",style:{color:c?"#00ffff":"#e2e8f0"},children:"Macros"}),t.jsxs("span",{className:"text-[10px] text-slate-500",children:[a.filter(e=>e.data.length>1).length," active"]})]}),t.jsx("div",{className:"p-2 space-y-2",children:u.map(e=>{const a=cg[e];if(!a)return null;const n=m(e),r=s.has(e),i=n.data.length>1,d=x(e);return t.jsxs("div",{className:"rounded border",style:{borderColor:i?a.color+"40":b},children:[t.jsxs("button",{onClick:()=>f(e),className:"w-full px-2 py-1.5 flex items-center justify-between hover:bg-white/5 transition-colors",children:[t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx("div",{className:"w-2 h-2 rounded-full",style:{backgroundColor:i?a.color:"#444"}}),t.jsx("span",{className:"text-[11px] font-medium",style:{color:c?"#00ffff":"#e2e8f0"},children:a.label}),i&&t.jsxs("span",{className:"text-[9px] text-slate-500",children:["(",n.data.length," steps)"]})]}),t.jsx(we,{size:14,className:"transform transition-transform "+(r?"rotate-180":""),style:{color:c?"#00ffff":"#888"}})]}),r&&t.jsxs("div",{className:"px-2 pb-2 space-y-2",children:[d.length>0&&t.jsxs("div",{className:"relative",children:[t.jsxs("button",{onClick:()=>l(o===e?null:e),className:"text-[10px] px-2 py-1 bg-dark-surface hover:bg-dark-border rounded flex items-center gap-1",children:["Presets",t.jsx(we,{size:10})]}),o===e&&t.jsx("div",{className:"absolute top-full left-0 mt-1 bg-dark-bg border border-dark-border rounded shadow-lg z-10",children:d.map(a=>t.jsx("button",{onClick:()=>h(e,a),className:"block w-full text-left px-3 py-1.5 text-[10px] hover:bg-dark-surface",children:ug[a].name},a))})]}),t.jsx(mg,{macro:n,onChange:t=>p(e,t),label:a.label,min:a.min,max:a.max,signed:a.signed,color:a.color,height:60}),t.jsx("p",{className:"text-[9px] text-slate-500 px-1",children:a.description})]})]},e)})})]})}const hg={sine:"Sine",square:"Square",sawtooth:"Saw",triangle:"Tri",pulse:"Pulse",pwm:"PWM"},fg=({value:e,onChange:a,availableWaveforms:n=["sine","square","sawtooth","triangle"],size:r="md",color:s="#00ff88"})=>{const i={sm:{width:48,height:28,fontSize:8},md:{width:64,height:36,fontSize:9},lg:{width:80,height:44,fontSize:10}}[r];return t.jsx("div",{className:"flex gap-1 p-1 bg-[#1a1a1a] rounded-lg",children:n.map(n=>{const r=e===n,o=((e,t,a)=>{const n=a/2,r=.35*a,s=t-8,i=[],o=100;for(let l=0;l<=o;l++){const t=4+l/o*s,a=l/o*Math.PI*4;let d;switch(e){case"sine":d=n-Math.sin(a)*r;break;case"square":d=n-(Math.sin(a)>=0?1:-1)*r;break;case"sawtooth":d=n-(a/Math.PI%2-1)*r;break;case"triangle":const e=a/Math.PI%2;d=n-(e<1?2*e-1:3-2*e)*r;break;case"pulse":d=n-(a/Math.PI%2<.5?1:-1)*r;break;case"pwm":const t=.25+l/o*.5;d=n-(a/Math.PI%2<t?1:-1)*r;break;default:d=n}i.push(0===l?`M ${t} ${d}`:`L ${t} ${d}`)}return i.join(" ")})(n,i.width,i.height);return t.jsxs("button",{onClick:()=>a(n),className:`\n              relative rounded transition-all\n              ${r?"ring-2 ring-offset-1 ring-offset-[#1a1a1a]":"hover:bg-gray-800"}\n            `,style:r?{"--tw-ring-color":s}:void 0,title:hg[n],children:[t.jsxs("svg",{width:i.width,height:i.height,className:"rounded",style:{backgroundColor:r?`${s}15`:"#252525"},children:[t.jsx("line",{x1:0,y1:i.height/2,x2:i.width,y2:i.height/2,stroke:"#333",strokeWidth:"1",strokeDasharray:"2,2"}),t.jsx("path",{d:o,fill:"none",stroke:r?s:"#666",strokeWidth:r?2:1.5,strokeLinecap:"round",strokeLinejoin:"round",style:r?{filter:`drop-shadow(0 0 3px ${s})`}:void 0})]}),t.jsx("div",{className:`\n                absolute inset-x-0 bottom-0 text-center font-mono font-bold\n                ${r?"text-white":"text-gray-500"}\n              `,style:{fontSize:i.fontSize},children:hg[n]})]},n)})})},xg=[{value:"sine",label:"Sine",icon:"∿"},{value:"triangle",label:"Triangle",icon:"△"},{value:"sawtooth",label:"Saw",icon:"⩘"},{value:"square",label:"Square",icon:"⊓"}],gg=({instrument:e,onChange:a,compact:n=!1})=>{const r=e.lfo||{...G},s=he.useRef(r);s.current=r;const i=e=>{a({lfo:{...s.current,...e}})},o=()=>{i({enabled:!r.enabled})};return n?t.jsxs("div",{className:"flex items-center gap-2 px-2 py-1 bg-dark-bgSecondary rounded-lg border border-dark-border",children:[t.jsx("button",{onClick:o,className:"p-1.5 rounded transition-colors "+(r.enabled?"bg-accent-primary text-dark-bg":"bg-dark-bgTertiary text-text-muted hover:text-text-primary"),title:"Toggle LFO",children:t.jsx(Be,{size:14})}),r.enabled&&t.jsxs(t.Fragment,{children:[t.jsxs("div",{className:"flex items-center gap-1",children:[t.jsx("span",{className:"text-[10px] text-text-muted",children:"Rate"}),t.jsx("input",{type:"range",min:.1,max:20,step:.1,value:r.rate,onChange:e=>i({rate:parseFloat(e.target.value)}),className:"w-16 h-1 accent-accent-primary"}),t.jsxs("span",{className:"text-[10px] text-text-secondary w-8",children:[r.rate.toFixed(1),"Hz"]})]}),t.jsxs("div",{className:"flex items-center gap-1",children:[t.jsx(ft,{size:12,className:"text-cyan-400"}),t.jsx("input",{type:"range",min:0,max:100,value:r.filterAmount,onChange:e=>i({filterAmount:parseInt(e.target.value)}),className:"w-12 h-1 accent-cyan-400"})]}),t.jsxs("div",{className:"flex items-center gap-1",children:[t.jsx(ve,{size:12,className:"text-yellow-400"}),t.jsx("input",{type:"range",min:0,max:100,value:r.pitchAmount,onChange:e=>i({pitchAmount:parseInt(e.target.value)}),className:"w-12 h-1 accent-yellow-400"})]}),t.jsxs("div",{className:"flex items-center gap-1",children:[t.jsx(Ge,{size:12,className:"text-green-400"}),t.jsx("input",{type:"range",min:0,max:100,value:r.volumeAmount,onChange:e=>i({volumeAmount:parseInt(e.target.value)}),className:"w-12 h-1 accent-green-400"})]})]})]}):t.jsxs("div",{className:"bg-dark-bgSecondary rounded-lg border border-dark-border p-4",children:[t.jsxs("div",{className:"flex items-center justify-between mb-4",children:[t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx(Be,{size:16,className:"text-accent-primary"}),t.jsx("h3",{className:"text-sm font-semibold text-text-primary",children:"LFO Modulation"})]}),t.jsxs("button",{onClick:o,className:"flex items-center gap-1.5 px-3 py-1.5 rounded-lg text-xs font-medium transition-colors "+(r.enabled?"bg-accent-primary text-dark-bg":"bg-dark-bgTertiary text-text-muted hover:text-text-primary hover:bg-dark-bgHover"),children:[t.jsx(Nt,{size:12}),r.enabled?"ON":"OFF"]})]}),t.jsx("div",{className:"mb-4 bg-dark-bg rounded-lg p-2 border border-dark-border",children:t.jsx(da,{instrumentId:e.id,rate:r.rate,depth:Math.max(r.filterAmount,r.pitchAmount,r.volumeAmount),waveform:r.waveform,width:200,height:50})}),t.jsxs("div",{className:"mb-4",children:[t.jsx("label",{className:"block text-xs text-text-muted mb-2",children:"Waveform"}),t.jsx("div",{className:"flex gap-1",children:xg.map(e=>t.jsx("button",{onClick:()=>i({waveform:e.value}),className:"flex-1 px-2 py-2 rounded text-center text-lg transition-colors "+(r.waveform===e.value?"bg-accent-primary text-dark-bg":"bg-dark-bgTertiary text-text-muted hover:text-text-primary"),title:e.label,children:e.icon},e.value))})]}),t.jsxs("div",{className:"mb-4",children:[t.jsxs("div",{className:"flex items-center justify-between mb-1",children:[t.jsx("label",{className:"text-xs text-text-muted",children:"Rate"}),t.jsxs("span",{className:"text-xs text-text-secondary",children:[r.rate.toFixed(1)," Hz"]})]}),t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx(I,{value:r.rate,min:.1,max:20,step:.1,onChange:e=>i({rate:e}),size:"md",color:"#a855f7"}),t.jsx("input",{type:"range",min:.1,max:20,step:.1,value:r.rate,onChange:e=>i({rate:parseFloat(e.target.value)}),className:"flex-1 h-2 accent-purple-500 rounded-lg"})]})]}),t.jsxs("div",{className:"grid grid-cols-3 gap-4",children:[t.jsxs("div",{className:"text-center",children:[t.jsxs("div",{className:"flex items-center justify-center gap-1 mb-2",children:[t.jsx(ft,{size:14,className:"text-cyan-400"}),t.jsx("span",{className:"text-xs text-text-muted",children:"Filter"})]}),t.jsx(I,{value:r.filterAmount,min:0,max:100,onChange:e=>i({filterAmount:e}),size:"lg",color:"#22d3ee"}),t.jsxs("div",{className:"text-[10px] text-text-secondary mt-1",children:[r.filterAmount,"%"]})]}),t.jsxs("div",{className:"text-center",children:[t.jsxs("div",{className:"flex items-center justify-center gap-1 mb-2",children:[t.jsx(ve,{size:14,className:"text-yellow-400"}),t.jsx("span",{className:"text-xs text-text-muted",children:"Pitch"})]}),t.jsx(I,{value:r.pitchAmount,min:0,max:100,onChange:e=>i({pitchAmount:e}),size:"lg",color:"#facc15"}),t.jsxs("div",{className:"text-[10px] text-text-secondary mt-1",children:[r.pitchAmount," cents"]})]}),t.jsxs("div",{className:"text-center",children:[t.jsxs("div",{className:"flex items-center justify-center gap-1 mb-2",children:[t.jsx(Ge,{size:14,className:"text-green-400"}),t.jsx("span",{className:"text-xs text-text-muted",children:"Volume"})]}),t.jsx(I,{value:r.volumeAmount,min:0,max:100,onChange:e=>i({volumeAmount:e}),size:"lg",color:"#22c55e"}),t.jsxs("div",{className:"text-[10px] text-text-secondary mt-1",children:[r.volumeAmount,"%"]})]})]}),t.jsx("div",{className:"mt-4 pt-4 border-t border-dark-border",children:t.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[t.jsxs("div",{children:[t.jsx("label",{className:"block text-xs text-text-muted mb-1",children:"Start Phase"}),t.jsx("input",{type:"range",min:0,max:360,value:r.phase,onChange:e=>i({phase:parseInt(e.target.value)}),className:"w-full h-1 accent-accent-primary"}),t.jsxs("div",{className:"text-[10px] text-text-secondary text-center",children:[r.phase,"°"]})]}),t.jsxs("div",{children:[t.jsx("label",{className:"block text-xs text-text-muted mb-1",children:"Note Retrigger"}),t.jsx("button",{onClick:()=>i({retrigger:!r.retrigger}),className:"w-full px-3 py-1.5 rounded text-xs transition-colors "+(r.retrigger?"bg-accent-primary text-dark-bg":"bg-dark-bgTertiary text-text-muted"),children:r.retrigger?"ON":"OFF"})]})]})})]})},bg=["Sampler","Player","GranularSynth"];function yg({color:e,title:a}){return t.jsxs("div",{className:"flex items-center gap-2 mb-4",children:[t.jsx("div",{className:"w-1 h-4 rounded-full",style:{backgroundColor:e}}),t.jsx("h3",{className:"text-sm font-bold text-white uppercase tracking-wide",children:a})]})}function vg(e,a,n){const r=bg.includes(e.synthType),s=(t,n)=>{const r=e.oscillator||{type:"sawtooth",detune:0,octave:0};a({oscillator:{...r,[t]:n}})},i=(t,n)=>{const r=e.envelope||{attack:10,decay:200,sustain:50,release:1e3};a({envelope:{...r,[t]:n}})},o=(t,n)=>{const r=e.pitchEnvelope||{enabled:!1,amount:12,attack:0,decay:50,sustain:0,release:100};a({pitchEnvelope:{...r,[t]:n}})},l=(t,n)=>{const r=e.filter||{type:"lowpass",frequency:2e3,Q:1,rolloff:-24};a({filter:{...r,[t]:n}})};switch(n){case"oscillator":return function(e,a,n){return!e.oscillator||n?null:t.jsx("div",{className:"synth-tab-section p-4",children:t.jsxs("section",{className:"bg-[#1a1a1a] rounded-xl p-4 border border-gray-800",children:[t.jsx(yg,{color:"#4a9eff",title:"Oscillator"}),t.jsx("div",{className:"mb-4",children:t.jsx(fg,{value:e.oscillator.type,onChange:e=>a("type",e),size:"lg",color:"#4a9eff"})}),t.jsxs("div",{className:"flex flex-wrap gap-6 items-end",children:[t.jsx(I,{value:e.oscillator.detune||0,min:-100,max:100,onChange:e=>a("detune",e),label:"Detune",unit:"",color:"#4a9eff",bipolar:!0}),t.jsx(I,{value:e.oscillator.octave||0,min:-2,max:2,onChange:e=>a("octave",e),label:"Octave",color:"#4a9eff",formatValue:e=>e>0?`+${e}`:e.toString()})]})]})})}(e,s,r);case"envelope":return function(e,a,n){return t.jsxs("div",{className:"synth-tab-section p-4 space-y-4",children:[e.envelope&&t.jsxs("section",{className:"bg-[#1a1a1a] rounded-xl p-4 border border-gray-800",children:[t.jsx(yg,{color:"#22c55e",title:"Amplitude Envelope"}),t.jsxs("div",{className:"flex gap-4",children:[t.jsx("div",{className:"flex-1",children:t.jsx(oa,{instrumentId:e.id,attack:e.envelope.attack,decay:e.envelope.decay,sustain:e.envelope.sustain,release:e.envelope.release,width:200,height:80,color:"#22c55e",activeColor:"#4ade80",backgroundColor:"#0a0a0a"})}),t.jsxs("div",{className:"flex gap-2 items-end",children:[t.jsx(I,{value:e.envelope.attack,min:1,max:2e3,onChange:e=>a("attack",e),label:"A",size:"sm",color:"#22c55e",formatValue:e=>`${Math.round(e)}ms`}),t.jsx(I,{value:e.envelope.decay,min:1,max:2e3,onChange:e=>a("decay",e),label:"D",size:"sm",color:"#22c55e",formatValue:e=>`${Math.round(e)}ms`}),t.jsx(I,{value:e.envelope.sustain,min:0,max:100,onChange:e=>a("sustain",e),label:"S",size:"sm",color:"#22c55e",formatValue:e=>`${Math.round(e)}%`}),t.jsx(I,{value:e.envelope.release,min:1,max:5e3,onChange:e=>a("release",e),label:"R",size:"sm",color:"#22c55e",formatValue:e=>`${Math.round(e)}ms`})]})]})]}),t.jsxs("section",{className:"bg-[#1a1a1a] rounded-xl p-4 border border-gray-800",children:[t.jsxs("div",{className:"flex items-center justify-between mb-4",children:[t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx("div",{className:"w-1 h-4 bg-orange-500 rounded-full"}),t.jsx("h3",{className:"text-sm font-bold text-white uppercase tracking-wide",children:"Pitch Envelope"})]}),t.jsxs("label",{className:"flex items-center gap-2 cursor-pointer",children:[t.jsx("span",{className:"text-xs text-gray-400",children:e.pitchEnvelope?.enabled?"ON":"OFF"}),t.jsx("input",{type:"checkbox",checked:e.pitchEnvelope?.enabled||!1,onChange:e=>n("enabled",e.target.checked),className:"w-4 h-4 rounded bg-gray-700 border-gray-600 text-orange-500 focus:ring-orange-500 focus:ring-offset-0"})]})]}),t.jsxs("div",{className:"flex flex-wrap gap-6 items-end "+(e.pitchEnvelope?.enabled?"":"opacity-50 pointer-events-none"),children:[t.jsx(I,{value:e.pitchEnvelope?.amount||12,min:-48,max:48,onChange:e=>n("amount",e),label:"Amt",size:"sm",color:"#f97316",formatValue:e=>`${e>0?"+":""}${Math.round(e)}st`}),t.jsx(I,{value:e.pitchEnvelope?.attack||0,min:0,max:2e3,onChange:e=>n("attack",e),label:"A",size:"sm",color:"#f97316",formatValue:e=>`${Math.round(e)}ms`}),t.jsx(I,{value:e.pitchEnvelope?.decay||50,min:1,max:2e3,onChange:e=>n("decay",e),label:"D",size:"sm",color:"#f97316",formatValue:e=>`${Math.round(e)}ms`}),t.jsx(I,{value:e.pitchEnvelope?.sustain||0,min:-100,max:100,onChange:e=>n("sustain",e),label:"S",size:"sm",color:"#f97316",formatValue:e=>`${Math.round(e)}%`}),t.jsx(I,{value:e.pitchEnvelope?.release||100,min:1,max:5e3,onChange:e=>n("release",e),label:"R",size:"sm",color:"#f97316",formatValue:e=>`${Math.round(e)}ms`})]})]})]})}(e,i,o);case"filter":return function(e,a){return e.filter?t.jsx("div",{className:"synth-tab-section p-4",children:t.jsxs("section",{className:"bg-[#1a1a1a] rounded-xl p-4 border border-gray-800",children:[t.jsx(yg,{color:"#ff6b6b",title:"Filter"}),t.jsx("div",{className:"flex gap-1 mb-4",children:["lowpass","highpass","bandpass","notch"].map(n=>t.jsx("button",{onClick:()=>a("type",n),className:`\n                flex-1 px-2 py-1.5 text-xs font-bold rounded uppercase transition-all\n                ${e.filter?.type===n?"bg-red-500/20 text-red-400 ring-1 ring-red-500":"bg-gray-800 text-gray-500 hover:text-gray-300"}\n              `,children:n.replace("pass","")},n))}),t.jsxs("div",{className:"flex gap-4",children:[t.jsx("div",{className:"flex-1",children:t.jsx(la,{instrumentId:e.id,cutoff:e.filter.frequency,resonance:e.filter.Q,type:e.filter.type,width:200,height:80,color:"#ff6b6b",modulatedColor:"#fbbf24",backgroundColor:"#0a0a0a"})}),t.jsxs("div",{className:"flex gap-2 items-end",children:[t.jsx(I,{value:e.filter.frequency,min:20,max:2e4,onChange:e=>a("frequency",e),label:"Cutoff",color:"#ff6b6b",formatValue:e=>e>=1e3?`${(e/1e3).toFixed(1)}k`:`${Math.round(e)}`}),t.jsx(I,{value:e.filter.Q,min:0,max:100,onChange:e=>a("Q",e),label:"Reso",color:"#ff6b6b",formatValue:e=>`${Math.round(e)}%`})]})]})]})}):null}(e,l);case"modulation":return function(e,a,n){return n?null:t.jsx("div",{className:"synth-tab-section p-4",children:t.jsx("section",{className:"bg-[#1a1a1a] rounded-xl p-4 border border-gray-800",children:t.jsx(gg,{instrument:e,onChange:a})})})}(e,a,r);case"output":return function(e,a){return t.jsx("div",{className:"synth-tab-section p-4",children:t.jsxs("section",{className:"bg-[#1a1a1a] rounded-xl p-4 border border-gray-800",children:[t.jsx(yg,{color:"#a855f7",title:"Output"}),t.jsxs("div",{className:"flex flex-wrap gap-6 items-end",children:[t.jsx(I,{value:e.volume,min:-60,max:0,onChange:e=>a({volume:e}),label:"Volume",unit:"dB",size:"lg",color:"#a855f7"}),t.jsx(I,{value:e.pan,min:-100,max:100,onChange:e=>a({pan:e}),label:"Pan",color:"#a855f7",bipolar:!0,formatValue:e=>0===e?"C":e<0?`L${Math.abs(e)}`:`R${e}`})]})]})})}(e,a);case"special":return function(e,a){const n=wg(e,a);return n?t.jsx("div",{className:"synth-tab-section p-4 overflow-y-auto",children:n}):null}(e,a);default:return null}}function wg(e,a){const n=e.parameters||{},r=(e,t)=>{a({parameters:{...n,[e]:t}})};switch(e.synthType){case"FMSynth":return t.jsxs("section",{className:"bg-[#1a1a1a] rounded-xl p-4 border border-gray-800",children:[t.jsx(yg,{color:"#22d3ee",title:"FM Synthesis"}),t.jsxs("div",{className:"flex flex-wrap gap-6 items-end",children:[t.jsx(I,{value:n.modulationIndex??10,min:0,max:100,onChange:e=>r("modulationIndex",e),label:"Mod Index",color:"#22d3ee",formatValue:e=>e.toFixed(1)}),t.jsx(I,{value:n.harmonicity??3,min:.1,max:20,step:.1,onChange:e=>r("harmonicity",e),label:"Harmonicity",color:"#22d3ee",formatValue:e=>e.toFixed(2)}),t.jsx(I,{value:n.modulationEnvAmount??50,min:0,max:100,onChange:e=>r("modulationEnvAmount",e),label:"Mod Env",color:"#22d3ee",formatValue:e=>`${Math.round(e)}%`})]})]});case"AMSynth":return t.jsxs("section",{className:"bg-[#1a1a1a] rounded-xl p-4 border border-gray-800",children:[t.jsx(yg,{color:"#14b8a6",title:"AM Synthesis"}),t.jsxs("div",{className:"flex flex-wrap gap-6 items-end",children:[t.jsx(I,{value:n.harmonicity??3,min:.1,max:20,step:.1,onChange:e=>r("harmonicity",e),label:"Harmonicity",color:"#14b8a6",formatValue:e=>e.toFixed(2)}),t.jsx(I,{value:n.modulationDepth??50,min:0,max:100,onChange:e=>r("modulationDepth",e),label:"Depth",color:"#14b8a6",formatValue:e=>`${Math.round(e)}%`})]})]});case"PluckSynth":return t.jsxs("section",{className:"bg-[#1a1a1a] rounded-xl p-4 border border-gray-800",children:[t.jsx(yg,{color:"#f59e0b",title:"Pluck Parameters"}),t.jsxs("div",{className:"flex flex-wrap gap-6 items-end",children:[t.jsx(I,{value:n.attackNoise??1,min:0,max:10,step:.1,onChange:e=>r("attackNoise",e),label:"Attack",color:"#f59e0b",formatValue:e=>e.toFixed(1)}),t.jsx(I,{value:n.dampening??4e3,min:100,max:1e4,onChange:e=>r("dampening",e),label:"Dampening",color:"#f59e0b",formatValue:e=>e>=1e3?`${(e/1e3).toFixed(1)}k`:`${Math.round(e)}`}),t.jsx(I,{value:n.resonance??.9,min:.1,max:.999,step:.001,onChange:e=>r("resonance",e),label:"Resonance",color:"#f59e0b",formatValue:e=>e.toFixed(3)})]})]});case"MembraneSynth":return t.jsxs("section",{className:"bg-[#1a1a1a] rounded-xl p-4 border border-gray-800",children:[t.jsx(yg,{color:"#f97316",title:"Membrane Parameters"}),t.jsxs("div",{className:"flex flex-wrap gap-6 items-end",children:[t.jsx(I,{value:n.pitchDecay??.05,min:.001,max:1,step:.001,onChange:e=>r("pitchDecay",e),label:"Pitch Decay",color:"#f97316",formatValue:e=>`${(1e3*e).toFixed(0)}ms`}),t.jsx(I,{value:n.octaves??10,min:.5,max:20,step:.5,onChange:e=>r("octaves",e),label:"Octaves",color:"#f97316",formatValue:e=>e.toFixed(1)})]})]});case"MetalSynth":return t.jsxs("section",{className:"bg-[#1a1a1a] rounded-xl p-4 border border-gray-800",children:[t.jsx(yg,{color:"#ef4444",title:"Metal Parameters"}),t.jsxs("div",{className:"flex flex-wrap gap-6 items-end",children:[t.jsx(I,{value:n.frequency??200,min:50,max:1e3,onChange:e=>r("frequency",e),label:"Frequency",color:"#ef4444",formatValue:e=>`${Math.round(e)}Hz`}),t.jsx(I,{value:n.harmonicity??5.1,min:.5,max:20,step:.1,onChange:e=>r("harmonicity",e),label:"Harmonicity",color:"#ef4444",formatValue:e=>e.toFixed(1)}),t.jsx(I,{value:n.modulationIndex??32,min:1,max:100,onChange:e=>r("modulationIndex",e),label:"Mod Index",color:"#ef4444",formatValue:e=>Math.round(e).toString()}),t.jsx(I,{value:n.resonance??4e3,min:100,max:8e3,onChange:e=>r("resonance",e),label:"Resonance",color:"#ef4444",formatValue:e=>e>=1e3?`${(e/1e3).toFixed(1)}k`:`${Math.round(e)}`})]})]});case"NoiseSynth":return t.jsxs("section",{className:"bg-[#1a1a1a] rounded-xl p-4 border border-gray-800",children:[t.jsx(yg,{color:"#6b7280",title:"Noise Type"}),t.jsx("div",{className:"flex gap-2",children:["white","pink","brown"].map(e=>t.jsx("button",{onClick:()=>r("noiseType",e),className:"flex-1 px-4 py-3 rounded-lg font-bold uppercase text-sm transition-all "+(n.noiseType===e||!n.noiseType&&"white"===e?"bg-gray-600 text-white ring-2 ring-gray-400":"bg-gray-800 text-gray-500 hover:bg-gray-700"),children:e},e))})]});case"DuoSynth":return t.jsxs("section",{className:"bg-[#1a1a1a] rounded-xl p-4 border border-gray-800",children:[t.jsx(yg,{color:"#8b5cf6",title:"Duo Parameters"}),t.jsxs("div",{className:"flex flex-wrap gap-6 items-end",children:[t.jsx(I,{value:n.vibratoAmount??.5,min:0,max:1,step:.01,onChange:e=>r("vibratoAmount",e),label:"Vibrato",color:"#8b5cf6",formatValue:e=>`${Math.round(100*e)}%`}),t.jsx(I,{value:n.vibratoRate??5,min:.1,max:20,step:.1,onChange:e=>r("vibratoRate",e),label:"Vib Rate",color:"#8b5cf6",formatValue:e=>`${e.toFixed(1)}Hz`}),t.jsx(I,{value:n.harmonicity??1.5,min:.5,max:4,step:.1,onChange:e=>r("harmonicity",e),label:"Harmonicity",color:"#8b5cf6",formatValue:e=>e.toFixed(2)})]})]});case"MonoSynth":return t.jsxs("section",{className:"bg-[#1a1a1a] rounded-xl p-4 border border-gray-800",children:[t.jsx(yg,{color:"#ec4899",title:"Mono Parameters"}),t.jsx("div",{className:"flex flex-wrap gap-6 items-end",children:t.jsx(I,{value:n.portamento??0,min:0,max:1e3,onChange:e=>r("portamento",e),label:"Glide",color:"#ec4899",formatValue:e=>`${Math.round(e)}ms`})})]});case"SuperSaw":{const n=e.superSaw||j;return t.jsxs("section",{className:"bg-[#1a1a1a] rounded-xl p-4 border border-gray-800",children:[t.jsx(yg,{color:"#f43f5e",title:"SuperSaw"}),t.jsxs("div",{className:"flex flex-wrap items-end gap-3 mb-4",children:[t.jsx(I,{value:n.voices,min:3,max:9,onChange:e=>a({superSaw:{...n,voices:e}}),label:"Voices",size:"sm",color:"#f43f5e",formatValue:e=>Math.round(e).toString()}),t.jsx(I,{value:n.detune,min:0,max:100,onChange:e=>a({superSaw:{...n,detune:e}}),label:"Detune",size:"sm",color:"#f43f5e",formatValue:e=>`${Math.round(e)}`}),t.jsx(I,{value:n.mix,min:0,max:100,onChange:e=>a({superSaw:{...n,mix:e}}),label:"Mix",size:"sm",color:"#f43f5e",formatValue:e=>`${Math.round(e)}%`}),t.jsx(I,{value:n.stereoSpread,min:0,max:100,onChange:e=>a({superSaw:{...n,stereoSpread:e}}),label:"Width",size:"sm",color:"#f43f5e",formatValue:e=>`${Math.round(e)}%`})]}),t.jsxs("div",{className:"pt-3 border-t border-gray-700",children:[t.jsx("p",{className:"text-xs text-gray-500 mb-2",children:"FILTER"}),t.jsxs("div",{className:"flex flex-wrap gap-6 items-end",children:[t.jsx(I,{value:n.filter.cutoff,min:20,max:2e4,size:"sm",onChange:e=>a({superSaw:{...n,filter:{...n.filter,cutoff:e}}}),label:"Cutoff",color:"#f43f5e",formatValue:e=>e>=1e3?`${(e/1e3).toFixed(1)}k`:`${Math.round(e)}`}),t.jsx(I,{value:n.filter.resonance,min:0,max:100,size:"sm",onChange:e=>a({superSaw:{...n,filter:{...n.filter,resonance:e}}}),label:"Reso",color:"#f43f5e",formatValue:e=>`${Math.round(e)}%`}),t.jsx(I,{value:n.filter.envelopeAmount,min:-100,max:100,size:"sm",onChange:e=>a({superSaw:{...n,filter:{...n.filter,envelopeAmount:e}}}),label:"Env Amt",color:"#f43f5e",bipolar:!0,formatValue:e=>`${Math.round(e)}%`})]})]})]})}case"PolySynth":{const n=e.polySynth||w;return t.jsxs("section",{className:"bg-[#1a1a1a] rounded-xl p-4 border border-gray-800",children:[t.jsx(yg,{color:"#06b6d4",title:"PolySynth"}),t.jsx("div",{className:"flex gap-2 mb-3",children:["Synth","FMSynth","AMSynth"].map(e=>t.jsx("button",{onClick:()=>a({polySynth:{...n,voiceType:e}}),className:"flex-1 px-2 py-1.5 rounded font-bold text-xs transition-all "+(n.voiceType===e?"bg-cyan-500/20 border border-cyan-500 text-cyan-400":"bg-gray-800 border border-gray-700 text-gray-400 hover:border-gray-500"),children:e},e))}),t.jsxs("div",{className:"flex flex-wrap gap-6 items-end mb-3",children:[t.jsx(I,{value:n.voiceCount,min:1,max:16,size:"sm",onChange:e=>a({polySynth:{...n,voiceCount:Math.round(e)}}),label:"Voices",color:"#06b6d4",formatValue:e=>Math.round(e).toString()}),t.jsx(I,{value:n.portamento,min:0,max:1e3,size:"sm",onChange:e=>a({polySynth:{...n,portamento:e}}),label:"Portamento",color:"#06b6d4",formatValue:e=>`${Math.round(e)}ms`})]}),t.jsxs("div",{className:"pt-3 border-t border-gray-700",children:[t.jsx("p",{className:"text-xs text-gray-500 mb-2",children:"VOICE STEAL MODE"}),t.jsx("div",{className:"flex gap-2",children:["oldest","lowest","highest"].map(e=>t.jsx("button",{onClick:()=>a({polySynth:{...n,stealMode:e}}),className:"flex-1 px-2 py-1 rounded text-xs font-bold uppercase transition-all "+(n.stealMode===e?"bg-cyan-500/20 text-cyan-400":"bg-gray-800 text-gray-500 hover:text-gray-300"),children:e},e))})]})]})}case"Organ":{const n=e.organ||v,r=["16'","5⅓'","8'","4'","2⅔'","2'","1⅗'","1⅓'","1'"];return t.jsxs("section",{className:"bg-[#1a1a1a] rounded-xl p-4 border border-gray-800",children:[t.jsx(yg,{color:"#84cc16",title:"Drawbars"}),t.jsx("div",{className:"flex justify-between gap-1 mb-3",children:n.drawbars.map((e,s)=>t.jsx("div",{className:"flex flex-col items-center",children:t.jsx(I,{value:e,min:0,max:8,step:1,size:"sm",onChange:e=>{const t=[...n.drawbars];t[s]=Math.round(e),a({organ:{...n,drawbars:t}})},label:r[s],color:"#84cc16",formatValue:e=>`${Math.round(e)}`})},s))}),t.jsxs("div",{className:"flex gap-3 items-center pt-2 border-t border-gray-700",children:[t.jsxs("label",{className:"flex items-center gap-2 cursor-pointer",children:[t.jsx("input",{type:"checkbox",checked:n.rotary.enabled,onChange:e=>a({organ:{...n,rotary:{...n.rotary,enabled:e.target.checked}}}),className:"w-4 h-4 rounded bg-gray-700 border-gray-600"}),t.jsx("span",{className:"text-xs text-gray-400",children:"ROTARY"})]}),n.rotary.enabled&&t.jsx("div",{className:"flex gap-1",children:["slow","fast"].map(e=>t.jsx("button",{onClick:()=>a({organ:{...n,rotary:{...n.rotary,speed:e}}}),className:"px-2 py-1 rounded text-xs font-bold uppercase transition-all "+(n.rotary.speed===e?"bg-lime-500/20 text-lime-400":"bg-gray-800 text-gray-500 hover:text-gray-300"),children:e},e))}),t.jsx(I,{value:n.keyClick,min:0,max:100,onChange:e=>a({organ:{...n,keyClick:e}}),label:"Click",size:"sm",color:"#84cc16",formatValue:e=>`${Math.round(e)}%`})]})]})}case"DrumMachine":{const n=e.drumMachine||C,r=n.drumType,s=()=>{switch(r){case"kick":{const e=n.kick||C.kick;return t.jsxs("div",{className:"flex flex-wrap items-end gap-4",children:[t.jsx(I,{value:e.pitch,min:30,max:100,size:"sm",onChange:t=>a({drumMachine:{...n,kick:{...e,pitch:t}}}),label:"Pitch",color:"#ef4444",formatValue:e=>`${Math.round(e)}Hz`}),t.jsx(I,{value:e.decay,min:50,max:1e3,size:"sm",onChange:t=>a({drumMachine:{...n,kick:{...e,decay:t}}}),label:"Decay",color:"#ef4444",formatValue:e=>`${Math.round(e)}ms`}),t.jsx(I,{value:e.tone,min:0,max:100,size:"sm",onChange:t=>a({drumMachine:{...n,kick:{...e,tone:t}}}),label:"Tone",color:"#ef4444",formatValue:e=>`${Math.round(e)}%`}),t.jsx(I,{value:e.drive,min:0,max:100,size:"sm",onChange:t=>a({drumMachine:{...n,kick:{...e,drive:t}}}),label:"Drive",color:"#ef4444",formatValue:e=>`${Math.round(e)}%`})]})}case"snare":{const e=n.snare||C.snare;return t.jsxs("div",{className:"flex flex-wrap items-end gap-4",children:[t.jsx(I,{value:e.pitch,min:100,max:400,size:"sm",onChange:t=>a({drumMachine:{...n,snare:{...e,pitch:t}}}),label:"Pitch",color:"#f97316",formatValue:e=>`${Math.round(e)}Hz`}),t.jsx(I,{value:e.decay,min:50,max:500,size:"sm",onChange:t=>a({drumMachine:{...n,snare:{...e,decay:t}}}),label:"Decay",color:"#f97316",formatValue:e=>`${Math.round(e)}ms`}),t.jsx(I,{value:e.tone,min:0,max:100,size:"sm",onChange:t=>a({drumMachine:{...n,snare:{...e,tone:t}}}),label:"Tone",color:"#f97316",formatValue:e=>`${Math.round(e)}%`}),t.jsx(I,{value:e.snappy,min:0,max:100,size:"sm",onChange:t=>a({drumMachine:{...n,snare:{...e,snappy:t}}}),label:"Snappy",color:"#f97316",formatValue:e=>`${Math.round(e)}%`})]})}default:return t.jsx("p",{className:"text-gray-500 text-sm",children:"Select a drum type above"})}};return t.jsxs("section",{className:"bg-[#1a1a1a] rounded-xl p-4 border border-gray-800",children:[t.jsx(yg,{color:"#ef4444",title:`${r.toUpperCase()} Parameters`}),s()]})}case"ChipSynth":{const n=e.chipSynth||$;return t.jsxs("section",{className:"bg-[#1a1a1a] rounded-xl p-4 border border-gray-800",children:[t.jsx(yg,{color:"#22d3ee",title:"Chip Parameters"}),t.jsx("div",{className:"flex gap-1 mb-3",children:["pulse1","pulse2","triangle","noise"].map(e=>t.jsx("button",{onClick:()=>a({chipSynth:{...n,channel:e}}),className:"flex-1 px-2 py-1 rounded text-xs font-bold uppercase transition-all "+(n.channel===e?"bg-cyan-500/20 text-cyan-400 ring-1 ring-cyan-500":"bg-gray-800 text-gray-500 hover:text-gray-300"),children:e.replace("pulse","P")},e))}),t.jsxs("div",{className:"flex flex-wrap items-end gap-4",children:[t.jsx(I,{value:n.bitDepth,min:2,max:16,size:"sm",onChange:e=>a({chipSynth:{...n,bitDepth:Math.round(e)}}),label:"Bits",color:"#22d3ee",formatValue:e=>`${Math.round(e)}`}),("pulse1"===n.channel||"pulse2"===n.channel)&&t.jsx(I,{value:n.pulse?.duty||50,min:12.5,max:50,size:"sm",step:12.5,onChange:e=>a({chipSynth:{...n,pulse:{duty:e}}}),label:"Duty",color:"#22d3ee",formatValue:e=>`${e}%`}),t.jsx(I,{value:n.vibrato.speed,min:0,max:20,size:"sm",step:.5,onChange:e=>a({chipSynth:{...n,vibrato:{...n.vibrato,speed:e}}}),label:"Vib Spd",color:"#22d3ee",formatValue:e=>`${e.toFixed(1)}Hz`}),t.jsx(I,{value:n.vibrato.depth,min:0,max:100,size:"sm",onChange:e=>a({chipSynth:{...n,vibrato:{...n.vibrato,depth:e}}}),label:"Vib Dep",color:"#22d3ee",formatValue:e=>`${Math.round(e)}%`})]})]})}case"WobbleBass":{const n=e.wobbleBass||g,r=[{value:"classic",label:"CLS"},{value:"reese",label:"RSE"},{value:"fm",label:"FM"},{value:"growl",label:"GRL"},{value:"hybrid",label:"HYB"}],s=[{value:"free",label:"Free"},{value:"1/4",label:"1/4"},{value:"1/8",label:"1/8"},{value:"1/16",label:"1/16"}],i=["soft","hard","fuzz","bitcrush"],o=["A","E","I","O","U"];return t.jsxs("section",{className:"bg-[#1a1a1a] rounded-xl p-4 border border-gray-800 space-y-4",children:[t.jsx(yg,{color:"#d946ef",title:"Wobble Bass"}),t.jsx("div",{className:"flex gap-1",children:r.map(e=>t.jsx("button",{onClick:()=>a({wobbleBass:{...n,mode:e.value}}),className:"px-2 py-1 text-xs rounded transition-colors "+(n.mode===e.value?"bg-fuchsia-500 text-white":"bg-gray-800 text-gray-400 hover:bg-gray-700"),children:e.label},e.value))}),t.jsxs("div",{className:"pt-3 border-t border-gray-700",children:[t.jsx("p",{className:"text-xs text-gray-500 mb-2",children:"OSC 1 / OSC 2"}),t.jsxs("div",{className:"flex flex-wrap items-end gap-3",children:[t.jsx(I,{value:n.osc1.level,min:0,max:100,size:"sm",onChange:e=>a({wobbleBass:{...n,osc1:{...n.osc1,level:e}}}),label:"O1 Lv",color:"#d946ef",formatValue:e=>`${Math.round(e)}%`}),t.jsx(I,{value:n.osc1.detune,min:-100,max:100,size:"sm",bipolar:!0,onChange:e=>a({wobbleBass:{...n,osc1:{...n.osc1,detune:e}}}),label:"O1 Det",color:"#d946ef",formatValue:e=>`${Math.round(e)}¢`}),t.jsx(I,{value:n.osc2.level,min:0,max:100,size:"sm",onChange:e=>a({wobbleBass:{...n,osc2:{...n.osc2,level:e}}}),label:"O2 Lv",color:"#c026d3",formatValue:e=>`${Math.round(e)}%`}),t.jsx(I,{value:n.osc2.detune,min:-100,max:100,size:"sm",bipolar:!0,onChange:e=>a({wobbleBass:{...n,osc2:{...n.osc2,detune:e}}}),label:"O2 Det",color:"#c026d3",formatValue:e=>`${Math.round(e)}¢`})]})]}),t.jsxs("div",{className:"pt-3 border-t border-gray-700",children:[t.jsx("p",{className:"text-xs text-gray-500 mb-2",children:"SUB / UNISON"}),t.jsxs("div",{className:"flex flex-wrap items-end gap-3",children:[t.jsx("button",{onClick:()=>a({wobbleBass:{...n,sub:{...n.sub,enabled:!n.sub.enabled}}}),className:"px-2 py-1.5 rounded text-xs font-bold transition-all "+(n.sub.enabled?"bg-fuchsia-500/20 border border-fuchsia-500 text-fuchsia-400":"bg-gray-800 border border-gray-700 text-gray-400"),children:"SUB"}),n.sub.enabled&&t.jsx(I,{value:n.sub.level,min:0,max:100,size:"sm",onChange:e=>a({wobbleBass:{...n,sub:{...n.sub,level:e}}}),label:"Sub Lv",color:"#e879f9",formatValue:e=>`${Math.round(e)}%`}),t.jsx(I,{value:n.unison.voices,min:1,max:16,size:"sm",onChange:e=>a({wobbleBass:{...n,unison:{...n.unison,voices:Math.round(e)}}}),label:"Voices",color:"#e879f9",formatValue:e=>Math.round(e).toString()}),t.jsx(I,{value:n.unison.detune,min:0,max:100,size:"sm",onChange:e=>a({wobbleBass:{...n,unison:{...n.unison,detune:e}}}),label:"Spread",color:"#e879f9",formatValue:e=>`${Math.round(e)}¢`})]})]}),t.jsxs("div",{className:"pt-3 border-t border-gray-700",children:[t.jsx("p",{className:"text-xs text-gray-500 mb-2",children:"FM"}),t.jsxs("div",{className:"flex flex-wrap items-end gap-3",children:[t.jsx("button",{onClick:()=>a({wobbleBass:{...n,fm:{...n.fm,enabled:!n.fm.enabled}}}),className:"px-2 py-1.5 rounded text-xs font-bold transition-all "+(n.fm.enabled?"bg-fuchsia-500/20 border border-fuchsia-500 text-fuchsia-400":"bg-gray-800 border border-gray-700 text-gray-400"),children:"FM"}),n.fm.enabled&&t.jsxs(t.Fragment,{children:[t.jsx(I,{value:n.fm.amount,min:0,max:100,size:"sm",onChange:e=>a({wobbleBass:{...n,fm:{...n.fm,amount:e}}}),label:"Amount",color:"#f0abfc",formatValue:e=>`${Math.round(e)}`}),t.jsx(I,{value:n.fm.ratio,min:.5,max:8,step:.5,size:"sm",onChange:e=>a({wobbleBass:{...n,fm:{...n.fm,ratio:e}}}),label:"Ratio",color:"#f0abfc",formatValue:e=>`${e.toFixed(1)}`}),t.jsx(I,{value:n.fm.envelope,min:0,max:100,size:"sm",onChange:e=>a({wobbleBass:{...n,fm:{...n.fm,envelope:e}}}),label:"FM Env",color:"#f0abfc",formatValue:e=>`${Math.round(e)}%`})]})]})]}),t.jsxs("div",{className:"pt-3 border-t border-gray-700",children:[t.jsx("p",{className:"text-xs text-gray-500 mb-2",children:"FILTER"}),t.jsxs("div",{className:"flex flex-wrap items-end gap-3",children:[t.jsx(I,{value:n.filter.cutoff,min:20,max:2e4,size:"sm",onChange:e=>a({wobbleBass:{...n,filter:{...n.filter,cutoff:e}}}),label:"Cutoff",color:"#d946ef",formatValue:e=>e>=1e3?`${(e/1e3).toFixed(1)}k`:`${Math.round(e)}`}),t.jsx(I,{value:n.filter.resonance,min:0,max:100,size:"sm",onChange:e=>a({wobbleBass:{...n,filter:{...n.filter,resonance:e}}}),label:"Reso",color:"#d946ef",formatValue:e=>`${Math.round(e)}%`}),t.jsx(I,{value:n.filter.drive,min:0,max:100,size:"sm",onChange:e=>a({wobbleBass:{...n,filter:{...n.filter,drive:e}}}),label:"Drive",color:"#d946ef",formatValue:e=>`${Math.round(e)}%`}),t.jsx(I,{value:n.filterEnvelope.amount,min:-100,max:100,size:"sm",bipolar:!0,onChange:e=>a({wobbleBass:{...n,filterEnvelope:{...n.filterEnvelope,amount:e}}}),label:"Env Amt",color:"#d946ef",formatValue:e=>`${Math.round(e)}%`})]})]}),t.jsxs("div",{className:"pt-3 border-t border-gray-700",children:[t.jsx("p",{className:"text-xs text-gray-500 mb-2",children:"WOBBLE LFO"}),t.jsxs("div",{className:"flex flex-wrap items-end gap-3",children:[t.jsxs("div",{className:"flex flex-col items-center",children:[t.jsx("p",{className:"text-[9px] text-gray-500 mb-1",children:"Sync"}),t.jsx("select",{value:n.wobbleLFO.sync,onChange:e=>a({wobbleBass:{...n,wobbleLFO:{...n.wobbleLFO,sync:e.target.value}}}),className:"bg-gray-800 text-white text-xs px-2 py-1 rounded border border-gray-700",children:s.map(e=>t.jsx("option",{value:e.value,children:e.label},e.value))})]}),t.jsx(I,{value:n.wobbleLFO.amount,min:0,max:100,size:"sm",onChange:e=>a({wobbleBass:{...n,wobbleLFO:{...n.wobbleLFO,amount:e}}}),label:"Filter",color:"#ec4899",formatValue:e=>`${Math.round(e)}%`}),t.jsx(I,{value:n.wobbleLFO.pitchAmount,min:0,max:100,size:"sm",onChange:e=>a({wobbleBass:{...n,wobbleLFO:{...n.wobbleLFO,pitchAmount:e}}}),label:"Pitch",color:"#ec4899",formatValue:e=>`${Math.round(e)}¢`}),t.jsx(I,{value:n.wobbleLFO.fmAmount,min:0,max:100,size:"sm",onChange:e=>a({wobbleBass:{...n,wobbleLFO:{...n.wobbleLFO,fmAmount:e}}}),label:"FM Mod",color:"#ec4899",formatValue:e=>`${Math.round(e)}%`})]})]}),t.jsxs("div",{className:"pt-3 border-t border-gray-700",children:[t.jsx("p",{className:"text-xs text-gray-500 mb-2",children:"DISTORTION"}),t.jsxs("div",{className:"flex flex-wrap items-end gap-3",children:[t.jsx("button",{onClick:()=>a({wobbleBass:{...n,distortion:{...n.distortion,enabled:!n.distortion.enabled}}}),className:"px-2 py-1.5 rounded text-xs font-bold transition-all "+(n.distortion.enabled?"bg-red-500/20 border border-red-500 text-red-400":"bg-gray-800 border border-gray-700 text-gray-400"),children:"DIST"}),n.distortion.enabled&&t.jsxs(t.Fragment,{children:[t.jsx("div",{className:"flex gap-1",children:i.map(e=>t.jsx("button",{onClick:()=>a({wobbleBass:{...n,distortion:{...n.distortion,type:e}}}),className:"px-1.5 py-1 rounded text-[10px] font-bold uppercase transition-all "+(n.distortion.type===e?"bg-red-500/20 text-red-400":"bg-gray-800 text-gray-500"),children:e},e))}),t.jsx(I,{value:n.distortion.drive,min:0,max:100,size:"sm",onChange:e=>a({wobbleBass:{...n,distortion:{...n.distortion,drive:e}}}),label:"Drive",color:"#ef4444",formatValue:e=>`${Math.round(e)}%`}),t.jsx(I,{value:n.distortion.tone,min:0,max:100,size:"sm",onChange:e=>a({wobbleBass:{...n,distortion:{...n.distortion,tone:e}}}),label:"Tone",color:"#ef4444",formatValue:e=>`${Math.round(e)}%`})]})]})]}),t.jsxs("div",{className:"pt-3 border-t border-gray-700",children:[t.jsx("p",{className:"text-xs text-gray-500 mb-2",children:"FORMANT (GROWL)"}),t.jsxs("div",{className:"flex flex-wrap items-end gap-3",children:[t.jsx("button",{onClick:()=>a({wobbleBass:{...n,formant:{...n.formant,enabled:!n.formant.enabled}}}),className:"px-2 py-1.5 rounded text-xs font-bold transition-all "+(n.formant.enabled?"bg-orange-500/20 border border-orange-500 text-orange-400":"bg-gray-800 border border-gray-700 text-gray-400"),children:"GROWL"}),n.formant.enabled&&t.jsxs(t.Fragment,{children:[t.jsx("div",{className:"flex gap-1",children:o.map(e=>t.jsx("button",{onClick:()=>a({wobbleBass:{...n,formant:{...n.formant,vowel:e}}}),className:"px-2 py-1 rounded text-xs font-bold transition-all "+(n.formant.vowel===e?"bg-orange-500/20 text-orange-400":"bg-gray-800 text-gray-500"),children:e},e))}),t.jsx(I,{value:n.formant.morph,min:0,max:100,size:"sm",onChange:e=>a({wobbleBass:{...n,formant:{...n.formant,morph:e}}}),label:"Morph",color:"#f97316",formatValue:e=>`${Math.round(e)}%`}),t.jsx(I,{value:n.formant.lfoAmount,min:0,max:100,size:"sm",onChange:e=>a({wobbleBass:{...n,formant:{...n.formant,lfoAmount:e}}}),label:"LFO",color:"#f97316",formatValue:e=>`${Math.round(e)}%`})]})]})]})]})}case"Synth":return t.jsxs("section",{className:"bg-[#1a1a1a] rounded-xl p-4 border border-gray-800",children:[t.jsx(yg,{color:"#a855f7",title:"Basic Synth"}),t.jsxs("div",{className:"text-center py-4",children:[t.jsx("p",{className:"text-gray-400 text-sm",children:"Simple polyphonic synthesizer"}),t.jsxs("p",{className:"text-gray-500 text-xs mt-2",children:["Use the ",t.jsx("span",{className:"text-purple-400 font-medium",children:"Oscillator"}),","," ",t.jsx("span",{className:"text-purple-400 font-medium",children:"Envelope"}),", and"," ",t.jsx("span",{className:"text-purple-400 font-medium",children:"Filter"})," tabs to shape your sound."]})]}),t.jsxs("div",{className:"flex flex-wrap gap-6 items-end mt-4",children:[t.jsx(I,{value:n.portamento??0,min:0,max:1,step:.01,onChange:e=>r("portamento",e),label:"Portamento",color:"#a855f7",formatValue:e=>`${(1e3*e).toFixed(0)}ms`}),t.jsx(I,{value:n.volume??0,min:-24,max:6,step:.5,onChange:e=>r("volume",e),label:"Volume",color:"#a855f7",formatValue:e=>`${e>0?"+":""}${e.toFixed(1)}dB`})]})]});case"PWMSynth":{const n=e.pwmSynth||N,r=["sine","triangle","sawtooth"];return t.jsxs("section",{className:"bg-[#1a1a1a] rounded-xl p-4 border border-gray-800 space-y-4",children:[t.jsx(yg,{color:"#e879f9",title:"PWM Synthesis"}),t.jsxs("div",{className:"flex flex-wrap items-end gap-4",children:[t.jsx(I,{value:n.pulseWidth,min:5,max:95,size:"sm",onChange:e=>a({pwmSynth:{...n,pulseWidth:e}}),label:"Width",color:"#e879f9",formatValue:e=>`${Math.round(e)}%`}),t.jsx(I,{value:n.pwmDepth,min:0,max:100,size:"sm",onChange:e=>a({pwmSynth:{...n,pwmDepth:e}}),label:"PWM Depth",color:"#e879f9",formatValue:e=>`${Math.round(e)}%`}),t.jsx(I,{value:n.pwmRate,min:.1,max:20,step:.1,size:"sm",onChange:e=>a({pwmSynth:{...n,pwmRate:e}}),label:"PWM Rate",color:"#e879f9",formatValue:e=>`${e.toFixed(1)}Hz`})]}),t.jsxs("div",{className:"pt-3 border-t border-gray-700",children:[t.jsx("p",{className:"text-xs text-gray-500 mb-2",children:"PWM WAVEFORM"}),t.jsx("div",{className:"flex gap-1 mb-3",children:r.map(e=>t.jsx("button",{onClick:()=>a({pwmSynth:{...n,pwmWaveform:e}}),className:"flex-1 px-2 py-1.5 rounded text-xs font-bold uppercase transition-all "+(n.pwmWaveform===e?"bg-fuchsia-500/20 border border-fuchsia-500 text-fuchsia-400":"bg-gray-800 border border-gray-700 text-gray-400 hover:border-gray-500"),children:e},e))})]}),t.jsxs("div",{className:"pt-3 border-t border-gray-700",children:[t.jsx("p",{className:"text-xs text-gray-500 mb-2",children:"OSCILLATORS"}),t.jsxs("div",{className:"flex flex-wrap items-end gap-4",children:[t.jsx(I,{value:n.oscillators,min:1,max:3,size:"sm",onChange:e=>a({pwmSynth:{...n,oscillators:Math.round(e)}}),label:"Count",color:"#d946ef",formatValue:e=>Math.round(e).toString()}),t.jsx(I,{value:n.detune,min:0,max:50,size:"sm",onChange:e=>a({pwmSynth:{...n,detune:e}}),label:"Detune",color:"#d946ef",formatValue:e=>`${Math.round(e)}¢`})]})]}),t.jsxs("div",{className:"pt-3 border-t border-gray-700",children:[t.jsx("p",{className:"text-xs text-gray-500 mb-2",children:"FILTER"}),t.jsxs("div",{className:"flex flex-wrap items-end gap-4",children:[t.jsx(I,{value:n.filter.cutoff,min:20,max:2e4,size:"sm",onChange:e=>a({pwmSynth:{...n,filter:{...n.filter,cutoff:e}}}),label:"Cutoff",color:"#c084fc",formatValue:e=>e>=1e3?`${(e/1e3).toFixed(1)}k`:`${Math.round(e)}`}),t.jsx(I,{value:n.filter.resonance,min:0,max:100,size:"sm",onChange:e=>a({pwmSynth:{...n,filter:{...n.filter,resonance:e}}}),label:"Reso",color:"#c084fc",formatValue:e=>`${Math.round(e)}%`}),t.jsx(I,{value:n.filter.envelopeAmount,min:-100,max:100,size:"sm",bipolar:!0,onChange:e=>a({pwmSynth:{...n,filter:{...n.filter,envelopeAmount:e}}}),label:"Env Amt",color:"#c084fc",formatValue:e=>`${Math.round(e)}%`}),t.jsx(I,{value:n.filter.keyTracking,min:0,max:100,size:"sm",onChange:e=>a({pwmSynth:{...n,filter:{...n.filter,keyTracking:e}}}),label:"Key Trk",color:"#c084fc",formatValue:e=>`${Math.round(e)}%`})]})]})]})}case"StringMachine":{const n=e.stringMachine||y;return t.jsxs("section",{className:"bg-[#1a1a1a] rounded-xl p-4 border border-gray-800 space-y-4",children:[t.jsx(yg,{color:"#22c55e",title:"String Machine"}),t.jsxs("div",{children:[t.jsx("p",{className:"text-xs text-gray-500 mb-2",children:"SECTIONS"}),t.jsxs("div",{className:"flex flex-wrap items-end gap-4",children:[t.jsx(I,{value:n.sections.violin,min:0,max:100,size:"sm",onChange:e=>a({stringMachine:{...n,sections:{...n.sections,violin:e}}}),label:"Violin",color:"#4ade80",formatValue:e=>`${Math.round(e)}%`}),t.jsx(I,{value:n.sections.viola,min:0,max:100,size:"sm",onChange:e=>a({stringMachine:{...n,sections:{...n.sections,viola:e}}}),label:"Viola",color:"#22c55e",formatValue:e=>`${Math.round(e)}%`}),t.jsx(I,{value:n.sections.cello,min:0,max:100,size:"sm",onChange:e=>a({stringMachine:{...n,sections:{...n.sections,cello:e}}}),label:"Cello",color:"#16a34a",formatValue:e=>`${Math.round(e)}%`}),t.jsx(I,{value:n.sections.bass,min:0,max:100,size:"sm",onChange:e=>a({stringMachine:{...n,sections:{...n.sections,bass:e}}}),label:"Bass",color:"#15803d",formatValue:e=>`${Math.round(e)}%`})]})]}),t.jsxs("div",{className:"pt-3 border-t border-gray-700",children:[t.jsx("p",{className:"text-xs text-gray-500 mb-2",children:"ENSEMBLE"}),t.jsxs("div",{className:"flex flex-wrap items-end gap-4",children:[t.jsx(I,{value:n.ensemble.depth,min:0,max:100,size:"sm",onChange:e=>a({stringMachine:{...n,ensemble:{...n.ensemble,depth:e}}}),label:"Depth",color:"#34d399",formatValue:e=>`${Math.round(e)}%`}),t.jsx(I,{value:n.ensemble.rate,min:.5,max:6,step:.1,size:"sm",onChange:e=>a({stringMachine:{...n,ensemble:{...n.ensemble,rate:e}}}),label:"Rate",color:"#34d399",formatValue:e=>`${e.toFixed(1)}Hz`}),t.jsx(I,{value:n.ensemble.voices,min:2,max:6,size:"sm",onChange:e=>a({stringMachine:{...n,ensemble:{...n.ensemble,voices:Math.round(e)}}}),label:"Voices",color:"#34d399",formatValue:e=>Math.round(e).toString()})]})]}),t.jsxs("div",{className:"pt-3 border-t border-gray-700",children:[t.jsx("p",{className:"text-xs text-gray-500 mb-2",children:"AMPLITUDE"}),t.jsxs("div",{className:"flex flex-wrap items-end gap-4",children:[t.jsx(I,{value:n.attack,min:10,max:2e3,size:"sm",onChange:e=>a({stringMachine:{...n,attack:e}}),label:"Attack",color:"#6ee7b7",formatValue:e=>`${Math.round(e)}ms`}),t.jsx(I,{value:n.release,min:100,max:5e3,size:"sm",onChange:e=>a({stringMachine:{...n,release:e}}),label:"Release",color:"#6ee7b7",formatValue:e=>e>=1e3?`${(e/1e3).toFixed(1)}s`:`${Math.round(e)}ms`}),t.jsx(I,{value:n.brightness,min:0,max:100,size:"sm",onChange:e=>a({stringMachine:{...n,brightness:e}}),label:"Bright",color:"#6ee7b7",formatValue:e=>`${Math.round(e)}%`})]})]})]})}case"FormantSynth":{const n=e.formantSynth||b,r=["A","E","I","O","U"],s=["manual","lfo","envelope"];return t.jsxs("section",{className:"bg-[#1a1a1a] rounded-xl p-4 border border-gray-800 space-y-4",children:[t.jsx(yg,{color:"#f97316",title:"Formant Synthesis"}),t.jsxs("div",{children:[t.jsx("p",{className:"text-xs text-gray-500 mb-2",children:"VOWEL"}),t.jsx("div",{className:"flex gap-1 mb-3",children:r.map(e=>t.jsx("button",{onClick:()=>a({formantSynth:{...n,vowel:e,formants:{...n.formants,...K[e]}}}),className:"flex-1 px-3 py-2 rounded text-sm font-bold transition-all "+(n.vowel===e?"bg-orange-500/20 border border-orange-500 text-orange-400":"bg-gray-800 border border-gray-700 text-gray-400 hover:border-gray-500"),children:e},e))})]}),t.jsxs("div",{className:"pt-3 border-t border-gray-700",children:[t.jsx("p",{className:"text-xs text-gray-500 mb-2",children:"VOWEL MORPH"}),t.jsx("div",{className:"flex gap-1 mb-2",children:r.map(e=>t.jsxs("button",{onClick:()=>a({formantSynth:{...n,vowelMorph:{...n.vowelMorph,target:e}}}),className:"flex-1 px-2 py-1 rounded text-xs font-bold transition-all "+(n.vowelMorph.target===e?"bg-amber-500/20 text-amber-400 ring-1 ring-amber-500":"bg-gray-800 text-gray-500 hover:text-gray-300"),children:["→",e]},e))}),t.jsx("div",{className:"flex gap-1 mb-3",children:s.map(e=>t.jsx("button",{onClick:()=>a({formantSynth:{...n,vowelMorph:{...n.vowelMorph,mode:e}}}),className:"flex-1 px-2 py-1 rounded text-xs font-bold uppercase transition-all "+(n.vowelMorph.mode===e?"bg-orange-500/20 text-orange-400":"bg-gray-800 text-gray-500 hover:text-gray-300"),children:e},e))}),t.jsxs("div",{className:"flex flex-wrap items-end gap-4",children:[t.jsx(I,{value:n.vowelMorph.amount,min:0,max:100,size:"sm",onChange:e=>a({formantSynth:{...n,vowelMorph:{...n.vowelMorph,amount:e}}}),label:"Amount",color:"#fb923c",formatValue:e=>`${Math.round(e)}%`}),t.jsx(I,{value:n.vowelMorph.rate,min:0,max:5,step:.1,size:"sm",onChange:e=>a({formantSynth:{...n,vowelMorph:{...n.vowelMorph,rate:e}}}),label:"Rate",color:"#fb923c",formatValue:e=>`${e.toFixed(1)}Hz`})]})]}),t.jsxs("div",{className:"pt-3 border-t border-gray-700",children:[t.jsx("p",{className:"text-xs text-gray-500 mb-2",children:"FORMANTS"}),t.jsxs("div",{className:"flex flex-wrap items-end gap-4",children:[t.jsx(I,{value:n.formants.f1,min:200,max:1200,size:"sm",onChange:e=>a({formantSynth:{...n,formants:{...n.formants,f1:e}}}),label:"F1",color:"#f97316",formatValue:e=>`${Math.round(e)}Hz`}),t.jsx(I,{value:n.formants.f2,min:500,max:3e3,size:"sm",onChange:e=>a({formantSynth:{...n,formants:{...n.formants,f2:e}}}),label:"F2",color:"#f97316",formatValue:e=>e>=1e3?`${(e/1e3).toFixed(1)}k`:`${Math.round(e)}`}),t.jsx(I,{value:n.formants.f3,min:1500,max:4e3,size:"sm",onChange:e=>a({formantSynth:{...n,formants:{...n.formants,f3:e}}}),label:"F3",color:"#f97316",formatValue:e=>e>=1e3?`${(e/1e3).toFixed(1)}k`:`${Math.round(e)}`}),t.jsx(I,{value:n.formants.bandwidth,min:50,max:200,size:"sm",onChange:e=>a({formantSynth:{...n,formants:{...n.formants,bandwidth:e}}}),label:"BW",color:"#f97316",formatValue:e=>`${Math.round(e)}Hz`}),t.jsx(I,{value:n.brightness,min:0,max:100,size:"sm",onChange:e=>a({formantSynth:{...n,brightness:e}}),label:"Bright",color:"#fb923c",formatValue:e=>`${Math.round(e)}%`})]})]})]})}case"Wavetable":{const n=e.wavetable||k,r=["none","lfo","envelope"];return t.jsxs("section",{className:"bg-[#1a1a1a] rounded-xl p-4 border border-gray-800 space-y-4",children:[t.jsx(yg,{color:"#06b6d4",title:"Wavetable"}),t.jsx("div",{className:"flex flex-wrap items-end gap-4",children:t.jsx(I,{value:n.morphPosition,min:0,max:100,onChange:e=>a({wavetable:{...n,morphPosition:e}}),label:"Morph",color:"#06b6d4",formatValue:e=>`${Math.round(e)}%`})}),t.jsxs("div",{className:"pt-3 border-t border-gray-700",children:[t.jsx("p",{className:"text-xs text-gray-500 mb-2",children:"MORPH MODULATION"}),t.jsx("div",{className:"flex gap-1 mb-3",children:r.map(e=>t.jsx("button",{onClick:()=>a({wavetable:{...n,morphModSource:e}}),className:"flex-1 px-2 py-1.5 rounded text-xs font-bold uppercase transition-all "+(n.morphModSource===e?"bg-cyan-500/20 border border-cyan-500 text-cyan-400":"bg-gray-800 border border-gray-700 text-gray-400 hover:border-gray-500"),children:e},e))}),t.jsxs("div",{className:"flex flex-wrap items-end gap-4",children:[t.jsx(I,{value:n.morphModAmount,min:0,max:100,size:"sm",onChange:e=>a({wavetable:{...n,morphModAmount:e}}),label:"Mod Amt",color:"#22d3ee",formatValue:e=>`${Math.round(e)}%`}),"lfo"===n.morphModSource&&t.jsx(I,{value:n.morphLFORate,min:.1,max:20,step:.1,size:"sm",onChange:e=>a({wavetable:{...n,morphLFORate:e}}),label:"LFO Rate",color:"#22d3ee",formatValue:e=>`${e.toFixed(1)}Hz`})]})]}),t.jsxs("div",{className:"pt-3 border-t border-gray-700",children:[t.jsx("p",{className:"text-xs text-gray-500 mb-2",children:"UNISON"}),t.jsxs("div",{className:"flex flex-wrap items-end gap-4",children:[t.jsx(I,{value:n.unison.voices,min:1,max:8,size:"sm",onChange:e=>a({wavetable:{...n,unison:{...n.unison,voices:Math.round(e)}}}),label:"Voices",color:"#67e8f9",formatValue:e=>Math.round(e).toString()}),t.jsx(I,{value:n.unison.detune,min:0,max:100,size:"sm",onChange:e=>a({wavetable:{...n,unison:{...n.unison,detune:e}}}),label:"Detune",color:"#67e8f9",formatValue:e=>`${Math.round(e)}¢`}),t.jsx(I,{value:n.unison.stereoSpread,min:0,max:100,size:"sm",onChange:e=>a({wavetable:{...n,unison:{...n.unison,stereoSpread:e}}}),label:"Spread",color:"#67e8f9",formatValue:e=>`${Math.round(e)}%`})]})]}),t.jsxs("div",{className:"pt-3 border-t border-gray-700",children:[t.jsx("p",{className:"text-xs text-gray-500 mb-2",children:"FILTER"}),t.jsxs("div",{className:"flex flex-wrap items-end gap-4",children:[t.jsx(I,{value:n.filter.cutoff,min:20,max:2e4,size:"sm",onChange:e=>a({wavetable:{...n,filter:{...n.filter,cutoff:e}}}),label:"Cutoff",color:"#0891b2",formatValue:e=>e>=1e3?`${(e/1e3).toFixed(1)}k`:`${Math.round(e)}`}),t.jsx(I,{value:n.filter.resonance,min:0,max:100,size:"sm",onChange:e=>a({wavetable:{...n,filter:{...n.filter,resonance:e}}}),label:"Reso",color:"#0891b2",formatValue:e=>`${Math.round(e)}%`}),t.jsx(I,{value:n.filter.envelopeAmount,min:-100,max:100,size:"sm",bipolar:!0,onChange:e=>a({wavetable:{...n,filter:{...n.filter,envelopeAmount:e}}}),label:"Env Amt",color:"#0891b2",formatValue:e=>`${Math.round(e)}%`})]})]})]})}case"GranularSynth":{const n=e.granular||_;return t.jsxs("section",{className:"bg-[#1a1a1a] rounded-xl p-4 border border-gray-800 space-y-4",children:[t.jsx(yg,{color:"#a78bfa",title:"Granular Synthesis"}),t.jsxs("div",{children:[t.jsx("p",{className:"text-xs text-gray-500 mb-2",children:"GRAIN"}),t.jsxs("div",{className:"flex flex-wrap items-end gap-4",children:[t.jsx(I,{value:n.grainSize,min:10,max:500,size:"sm",onChange:e=>a({granular:{...n,grainSize:e}}),label:"Size",color:"#a78bfa",formatValue:e=>`${Math.round(e)}ms`}),t.jsx(I,{value:n.grainOverlap,min:0,max:100,size:"sm",onChange:e=>a({granular:{...n,grainOverlap:e}}),label:"Overlap",color:"#a78bfa",formatValue:e=>`${Math.round(e)}%`}),t.jsx(I,{value:n.density,min:1,max:16,size:"sm",onChange:e=>a({granular:{...n,density:Math.round(e)}}),label:"Density",color:"#a78bfa",formatValue:e=>Math.round(e).toString()}),t.jsx("button",{onClick:()=>a({granular:{...n,reverse:!n.reverse}}),className:"px-3 py-2 rounded text-xs font-bold transition-all "+(n.reverse?"bg-purple-500/20 border border-purple-500 text-purple-400":"bg-gray-800 border border-gray-700 text-gray-400 hover:border-gray-500"),children:"REV"})]})]}),t.jsxs("div",{className:"pt-3 border-t border-gray-700",children:[t.jsx("p",{className:"text-xs text-gray-500 mb-2",children:"PLAYBACK"}),t.jsxs("div",{className:"flex flex-wrap items-end gap-4",children:[t.jsx(I,{value:n.scanPosition,min:0,max:100,size:"sm",onChange:e=>a({granular:{...n,scanPosition:e}}),label:"Position",color:"#8b5cf6",formatValue:e=>`${Math.round(e)}%`}),t.jsx(I,{value:n.scanSpeed,min:-100,max:100,size:"sm",bipolar:!0,onChange:e=>a({granular:{...n,scanSpeed:e}}),label:"Scan Spd",color:"#8b5cf6",formatValue:e=>`${Math.round(e)}%`}),t.jsx(I,{value:n.playbackRate,min:.25,max:4,step:.01,size:"sm",onChange:e=>a({granular:{...n,playbackRate:e}}),label:"Speed",color:"#8b5cf6",formatValue:e=>`${e.toFixed(2)}x`}),t.jsx(I,{value:n.detune,min:-1200,max:1200,size:"sm",bipolar:!0,onChange:e=>a({granular:{...n,detune:e}}),label:"Detune",color:"#8b5cf6",formatValue:e=>`${Math.round(e)}¢`})]})]}),t.jsxs("div",{className:"pt-3 border-t border-gray-700",children:[t.jsx("p",{className:"text-xs text-gray-500 mb-2",children:"RANDOM"}),t.jsxs("div",{className:"flex flex-wrap items-end gap-4",children:[t.jsx(I,{value:n.randomPitch,min:0,max:100,size:"sm",onChange:e=>a({granular:{...n,randomPitch:e}}),label:"Rnd Pitch",color:"#7c3aed",formatValue:e=>`${Math.round(e)}%`}),t.jsx(I,{value:n.randomPosition,min:0,max:100,size:"sm",onChange:e=>a({granular:{...n,randomPosition:e}}),label:"Rnd Pos",color:"#7c3aed",formatValue:e=>`${Math.round(e)}%`})]})]}),t.jsxs("div",{className:"pt-3 border-t border-gray-700",children:[t.jsx("p",{className:"text-xs text-gray-500 mb-2",children:"GRAIN ENVELOPE"}),t.jsxs("div",{className:"flex flex-wrap items-end gap-4",children:[t.jsx(I,{value:n.envelope.attack,min:1,max:100,size:"sm",onChange:e=>a({granular:{...n,envelope:{...n.envelope,attack:e}}}),label:"Attack",color:"#c4b5fd",formatValue:e=>`${Math.round(e)}ms`}),t.jsx(I,{value:n.envelope.release,min:1,max:100,size:"sm",onChange:e=>a({granular:{...n,envelope:{...n.envelope,release:e}}}),label:"Release",color:"#c4b5fd",formatValue:e=>`${Math.round(e)}ms`})]})]}),t.jsxs("div",{className:"pt-3 border-t border-gray-700",children:[t.jsx("p",{className:"text-xs text-gray-500 mb-2",children:"FILTER"}),t.jsxs("div",{className:"flex flex-wrap items-end gap-4",children:[t.jsx(I,{value:n.filter.cutoff,min:20,max:2e4,size:"sm",onChange:e=>a({granular:{...n,filter:{...n.filter,cutoff:e}}}),label:"Cutoff",color:"#6d28d9",formatValue:e=>e>=1e3?`${(e/1e3).toFixed(1)}k`:`${Math.round(e)}`}),t.jsx(I,{value:n.filter.resonance,min:0,max:100,size:"sm",onChange:e=>a({granular:{...n,filter:{...n.filter,resonance:e}}}),label:"Reso",color:"#6d28d9",formatValue:e=>`${Math.round(e)}%`})]})]})]})}default:{const a=l(e.synthType);return t.jsxs("section",{className:"bg-[#1a1a1a] rounded-xl p-4 border border-gray-800",children:[t.jsx(yg,{color:"#6b7280",title:a.name}),t.jsxs("div",{className:"text-center py-4",children:[t.jsx("p",{className:"text-gray-400 text-sm",children:a.description}),t.jsx("p",{className:"text-gray-500 text-xs mt-2",children:"Use the other tabs to configure this instrument."})]})]})}}}const jg=[{key:"accent",label:"Accent",shortLabel:"AC"},{key:"bass",label:"Bass Drum",shortLabel:"BD"},{key:"snare",label:"Snare Drum",shortLabel:"SD"},{key:"low_tom",label:"Low Tom",shortLabel:"LT"},{key:"mid_tom",label:"Mid Tom",shortLabel:"MT"},{key:"hi_tom",label:"Hi Tom",shortLabel:"HT"},{key:"rimshot",label:"Rim/Cow",shortLabel:"RIM/COW"},{key:"handclap",label:"HCP/Tamb",shortLabel:"HCP/TAMB"},{key:"hihat",label:"Hi-Hat",shortLabel:"HH"},{key:"crash",label:"Crash",shortLabel:"CRASH"},{key:"ride",label:"Ride",shortLabel:"RIDE"},{key:"volume",label:"Volume",shortLabel:"VOLUME"}],_g=({label:e,shortLabel:a,value:n,onChange:r})=>{const s="cyan-lineart"!==B(e=>e.currentThemeId);return t.jsxs("div",{className:"flex flex-col items-center gap-2 flex-1",children:[t.jsxs("div",{className:"relative h-32 w-8 flex items-center justify-center",children:[t.jsx("div",{className:`absolute inset-0 rounded-full ${s?"bg-gray-800":"bg-gray-300"} border ${s?"border-gray-700":"border-gray-400"} z-0`,children:t.jsx("div",{className:"absolute left-1/2 top-2 bottom-2 w-1 -translate-x-1/2 bg-gray-900 rounded-full"})}),t.jsx("input",{type:"range",min:"0",max:"1",step:"0.01",value:n,onChange:e=>{r(parseFloat(e.target.value))},className:"absolute h-32 w-8 bg-transparent cursor-pointer vertical-slider z-10 opacity-0",style:{writingMode:"vertical-lr",direction:"rtl"},title:`${e}: ${Math.round(100*n)}%`}),t.jsx("div",{className:`absolute w-6 h-3 rounded-sm ${s?"bg-red-600":"bg-red-500"} border border-red-800 shadow-lg pointer-events-none transition-all z-20`,style:{top:100-100*n+"%",transform:"translateY(-50%)"}})]}),t.jsxs("div",{className:"text-center",children:[t.jsx("div",{className:`text-xs font-bold ${s?"text-gray-300":"text-gray-700"} tracking-wider`,children:a}),t.jsx("div",{className:"text-[10px] text-gray-500 uppercase",children:e})]})]})},kg=({label:e,value:a,onChange:n,size:r="medium"})=>{const s="cyan-lineart"!==B(e=>e.currentThemeId),i=270*a-135;return t.jsxs("div",{className:"flex flex-col items-center gap-2",children:[t.jsxs("div",{className:`${{small:"w-12 h-12",medium:"w-16 h-16",large:"w-20 h-20"}[r]} relative cursor-pointer select-none`,onMouseDown:e=>{const t=e.currentTarget.getBoundingClientRect(),a=t.left+t.width/2,r=t.top+t.height/2,s=e=>{const t=(Math.atan2(e.clientY-r,e.clientX-a)*(180/Math.PI)+135+360)%360,s=Math.max(0,Math.min(1,t/270));n(s)},i=()=>{document.removeEventListener("mousemove",s),document.removeEventListener("mouseup",i)};document.addEventListener("mousemove",s),document.addEventListener("mouseup",i)},title:`${e}: ${Math.round(100*a)}%`,children:[t.jsx("div",{className:`absolute inset-0 rounded-full ${s?"bg-gray-800":"bg-gray-700"} border-4 border-gray-900 shadow-lg`,style:{background:s?"radial-gradient(circle at 30% 30%, #4b5563, #1f2937)":"radial-gradient(circle at 30% 30%, #6b7280, #374151)"}}),t.jsx("div",{className:"absolute top-1 left-1/2 w-1 h-4 bg-white rounded-full -translate-x-1/2 shadow-md",style:{transform:`translateX(-50%) rotate(${i}deg)`,transformOrigin:"50% "+("large"===r?"2.5rem":"medium"===r?"2rem":"1.5rem")}}),t.jsx("div",{className:`absolute inset-0 m-auto w-3 h-3 rounded-full ${s?"bg-gray-950":"bg-black"} shadow-inner`})]}),t.jsx("div",{className:`text-xs font-bold ${s?"text-gray-300":"text-gray-700"} uppercase tracking-wider text-center`,children:e})]})},Ng="#9b9fa0",$g="#232425",Cg="#ff5a00",Sg="#d03933",Mg="#e98e2f",zg="#dfd442",Tg="#e9e8e7",Eg="#ff5a00",Ag="#111111",Ig="Helvetica, Arial, sans-serif",Og=`"ITC Serif Gothic W03", ${Ig}`,Rg=`"Helvetica LT W04", ${Ig}`,Vg={MozUserSelect:"none",WebkitUserSelect:"none",msUserSelect:"none",userSelect:"none"},Pg={fontFamily:Rg,fontWeight:"bold",textAlign:"center",letterSpacing:"-0.2px",...Vg,cursor:"default"},Dg={...Pg,fontSize:13,color:Ng},Bg={...Pg,fontSize:15,color:Ng},Lg={...Pg,fontSize:11,color:Ng},Fg=e=>({position:"absolute",width:e,height:e,left:0,right:0,top:0,bottom:0,margin:"auto",borderRadius:"50%"}),Wg=({active:e})=>{const a={position:"absolute",left:4,right:4,top:4,bottom:4,borderRadius:"50%"};return t.jsxs("div",{style:{position:"relative",backgroundColor:"rgba(0,0,0,0.4)",width:18,height:18,borderRadius:"50%",pointerEvents:"none"},children:[t.jsx("div",{style:{...a,backgroundColor:"#570000"}}),t.jsx("div",{style:{...a,backgroundColor:"#FE0000",transition:"opacity 0.1s",opacity:e?1:0}})]})},Ug=fe.memo(({num:e,distance:a,hideCount:n=0,guideStyle:r={},rotate:s=!0,values:i,offset:o})=>{let l=e??0,d=!1;null!=i&&0!==i.length&&(l=i.length,d=!0);const c=[],u=360/(l+n);let m=180+n*u;o&&(m+=o);const p=u*(n>1?n-1:0)/2;for(let h=0;h<l;h++){let e=null;d&&(e=i[h]);let n=`translateX(-50%) translateY(-50%) rotate(${m}deg) translateY(-${a}px)`;!1===s&&(n+=` rotate(-${m-p}deg)`),c.push(t.jsx("div",{style:{...r,cursor:"default",position:"absolute",top:"50%",left:"50%",transform:n},children:e},h)),m+=u}return t.jsx("div",{style:{position:"absolute",width:"100%",height:"100%",transform:`rotate(-${p}deg)`},children:c})},()=>!0),qg=({value:e,onChange:a,size:n,min:r,max:s,step:i,bufferSize:o=360,children:l})=>{const d=fe.useRef(null),c=he.useCallback(t=>{t.preventDefault();const n=t.clientY,o=e,l=s-r,d=e=>{const t=(n-e.clientY)/200;let d=o+t*l;d=Math.round(d/i)*i+r,d=Math.max(r,Math.min(s,d)),a(d)},c=()=>{document.removeEventListener("mousemove",d),document.removeEventListener("mouseup",c)};document.addEventListener("mousemove",d),document.addEventListener("mouseup",c)},[e,a,r,s,i]),u=(e-r)/(s-r)*o-o/2;return t.jsx("div",{ref:d,style:{position:"relative",borderRadius:"50%",height:n,width:n,cursor:"grab"},onMouseDown:c,children:t.jsx("div",{style:{position:"relative",borderRadius:"50%",height:"100%",width:"100%",transform:`rotate(${u}deg)`},children:l})})},Hg=fe.memo(({value:e,onChange:a,size:n=75,label:r="",level:s=!1})=>{const i=Math.ceil(.6*n);return t.jsxs("div",{style:{position:"relative",display:"flex",flexDirection:"column",alignItems:"center",justifyContent:"space-between",width:n,height:n+30},children:[t.jsx("div",{style:{position:"relative",display:"flex",alignItems:"center",justifyContent:"center",flexGrow:1},children:t.jsx("span",{style:Dg,children:r})}),t.jsxs("div",{style:{position:"relative",width:n,height:n},children:[s&&t.jsx("div",{style:{position:"absolute",width:5,height:5,borderRadius:"50%",backgroundColor:Eg,right:"8%",top:"37%",zIndex:2}}),t.jsx(Ug,{num:11,distance:n/3,hideCount:1,guideStyle:{width:2,backgroundColor:Ng,height:n/3}}),t.jsx("div",{style:{...Fg(i),display:"flex",alignItems:"center",justifyContent:"center"},children:t.jsx(qg,{value:e,onChange:a,size:i,min:0,max:100,step:2,bufferSize:300,children:t.jsx("div",{style:{position:"relative",overflow:"hidden",width:"100%",height:"100%",borderRadius:"50%",border:`solid ${Ag} 8px`,backgroundColor:s?Eg:"#C8D4C8"},children:t.jsx("div",{style:{position:"absolute",width:4,height:12,backgroundColor:Ag,top:-6,left:"50%",transform:"translateX(-50%)"}})})})})]})]})},(e,t)=>e.value===t.value),Gg=({position:e,onChange:a})=>t.jsx("div",{style:{width:"100%",display:"flex",flexDirection:"column",alignItems:"center"},children:t.jsx("div",{style:{position:"relative",width:22,height:50,padding:4,backgroundColor:"#111111",borderRadius:2,cursor:"pointer"},onClick:()=>a(e<.5?1:0),children:t.jsx("div",{style:{position:"absolute",width:14,height:21,left:4,top:e<.5?4:25,backgroundColor:"#313335",borderRadius:2,transition:"top 0.1s ease"}})})}),Kg={fontFamily:Rg,whiteSpace:"pre",color:$g,letterSpacing:-.5,...Vg},Xg=({label:e})=>{const a=e.map((e,a)=>{let n,r;return"*"===e[0]?(n={...Kg,fontSize:19,fontWeight:400},r=e.slice(1)):(n={...Kg,fontSize:11},r=e),t.jsx("div",{style:n,children:r},a)});return t.jsx("div",{style:{width:"100%",height:36,display:"flex",flexDirection:"row",alignItems:"center",justifyContent:"center",backgroundColor:"#f6edc6",borderRadius:4},children:t.jsx("div",{style:{alignItems:"baseline",cursor:"default",display:"flex",flexDirection:"row",wordSpacing:"-0.1em"},children:a})})},Yg=({labels:e,children:a,width:n,height:r})=>t.jsxs("div",{style:{display:"flex",flexDirection:"column",alignItems:"stretch",justifyContent:"space-between",width:n,height:r,padding:4},children:[t.jsx("div",{style:{width:"100%",display:"flex",flexDirection:"column",alignItems:"center"},children:fe.Children.map(a,(e,a)=>t.jsx("div",{style:{marginBottom:5},children:e},a))}),t.jsx("div",{style:{width:"100%",display:"flex",flexDirection:"column",alignItems:"stretch"},children:e.map((e,a)=>t.jsx("div",{style:{marginTop:8},children:e},a))})]}),Zg="EMPTY",Qg=({config:e,width:a,height:n,parameters:r,onParamChange:s})=>{const{type:i,labels:o,switchConfig:l,controls:d}=e,c=Math.ceil(.72*a),u=[];u.push(t.jsx(Xg,{label:o[0]},`${i}-label-0`)),2===o.length&&(null!=l&&u.push(t.jsx(Gg,{position:r[l.param]??0,onChange:e=>s(l.param,e)},`${i}-switch`)),u.push(t.jsx(Xg,{label:o[1]},`${i}-label-1`)));const m=[];return m.push(t.jsx(Hg,{value:r[`${i}_level`]??75,onChange:e=>s(`${i}_level`,e),size:c,label:"LEVEL",level:!0},`${i}-knob-level`)),d.forEach((e,a)=>{e!==Zg?m.push(t.jsx(Hg,{value:r[`${i}_${e}`]??50,onChange:t=>s(`${i}_${e}`,t),size:c,label:e.toUpperCase()},`${i}-knob-${a}`)):m.push(t.jsx("div",{style:{width:c,height:c+30}},`${i}-knob-${a}`))}),t.jsx(Yg,{labels:u,width:a,height:n,children:m})},Jg=fe.memo(({text:e})=>{const a=e.split("e").reduce((e,a,n)=>{if(null===e)return[a];const r=t.jsx("span",{style:{display:"inline-block",transformOrigin:"50% 60%",transform:"rotate(-40deg)"},children:"e"},n);return[...e,r,a]},null);return t.jsx(t.Fragment,{children:a})}),eb=({width:e,height:a})=>t.jsxs("div",{style:{position:"relative",width:e,height:a},children:[t.jsx("div",{style:{position:"absolute",height:"1.5%",left:"50%",transform:"translateX(-50%)",top:"55%",backgroundColor:Cg,width:e-20}}),t.jsxs("div",{style:{display:"flex",flexDirection:"row",flexWrap:"nowrap",alignItems:"baseline",position:"absolute",bottom:"calc(55% - 17.5px)",right:60},children:[t.jsx("div",{style:{...Bg,fontFamily:Og,marginRight:40,color:Cg,fontSize:50,textShadow:`0.3rem 0 ${$g},0.3rem 0rem ${$g},-0.3rem -0 ${$g},-0.3rem 0 ${$g}`},children:t.jsx(Jg,{text:"Rhythm Composer"})}),t.jsx("div",{style:{...Bg,fontFamily:Og,color:Cg,fontSize:40,letterSpacing:-1.5},children:t.jsx(Jg,{text:"DEViLBOX"})})]}),t.jsx("div",{style:{...Bg,fontFamily:Og,position:"absolute",top:"59.5%",right:60,fontSize:28,letterSpacing:-1},children:t.jsx(Jg,{text:"Browser Controlled"})})]}),tb=[];for(let Bb=0;Bb<11;Bb++)0===Bb?tb.push("MIN"):10===Bb?tb.push("MAX"):tb.push(Bb);const ab=({value:e,onChange:a,size:n=130})=>{const r=Math.ceil(.54*n);return t.jsxs("div",{style:{display:"flex",flexDirection:"column",alignItems:"stretch",justifyContent:"space-between",width:n,height:n+9},children:[t.jsxs("div",{style:{position:"relative",width:n,height:n},children:[t.jsx(Ug,{num:11,distance:.33*n,hideCount:1,guideStyle:{width:5,height:5,backgroundColor:Ng,borderRadius:"50%"}}),t.jsx(Ug,{distance:.45*n,hideCount:1,rotate:!1,values:tb,guideStyle:Lg}),t.jsx("div",{style:Fg(r),children:t.jsx(qg,{value:e,onChange:a,size:r,bufferSize:300,min:0,max:100,step:1,children:t.jsx("div",{style:{position:"relative",width:"100%",height:"100%",borderRadius:"50%",backgroundColor:$g,border:`2px solid ${Ng}`},children:t.jsx("div",{style:{position:"absolute",width:3,height:"40%",backgroundColor:Cg,top:2,left:"50%",transform:"translateX(-50%)",borderRadius:1}})})})})]}),t.jsx("div",{style:{position:"relative",...Dg,overflow:"visible",top:-4},children:"MASTER VOLUME"})]})},nb=({color:e,active:a,onClick:n,width:r=50,height:s=80})=>t.jsx("div",{style:{borderRadius:4,display:"flex",flexDirection:"column",alignItems:"center",padding:5,backgroundColor:e,width:r,height:s,cursor:"pointer"},onClick:n,children:t.jsx(Wg,{active:a})}),rb=[{type:"accent",labels:[["*A","*C","CENT"]],controls:[]},{type:"kick",labels:[["*B","ASS ","*D","RUM"]],controls:["tone","decay"]},{type:"snare",labels:[["*S","NARE ","*D","RUM"]],controls:["tone","snappy"]},{type:"low_tom",labels:[["*L","OW ","*C","ONGA"],["*L","OW ","*T","OM"]],switchConfig:{param:"low_tom_selector"},controls:["tuning"]},{type:"mid_tom",labels:[["*M","ID ","*C","ONGA"],["*M","ID ","*T","OM"]],switchConfig:{param:"mid_tom_selector"},controls:["tuning"]},{type:"hi_tom",labels:[["*H","I ","*C","ONGA"],["*H","I ","*T","OM"]],switchConfig:{param:"hi_tom_selector"},controls:["tuning"]},{type:"rimshot",labels:[["*C","*L","AVES"],["*R","IM ","*S","HOT"]],switchConfig:{param:"rimshot_selector"},controls:[]},{type:"clap",labels:[["*M","*A","RACAS"],["HAND ","*C","LA","*P"]],switchConfig:{param:"clap_selector"},controls:[]},{type:"cowbell",labels:[["*C","OW ","*B","ELL"]],controls:[]},{type:"cymbal",labels:[["*C","*Y","MBAL"]],controls:["tone","decay"]},{type:"oh",labels:[["*O","PEN ","*H","IHAT"]],controls:[Zg,"decay"]},{type:"ch",labels:[["*C","LS'D ","*H","IHAT"]],controls:[]}],sb=[Sg,Sg,Sg,Sg,Mg,Mg,Mg,Mg,zg,zg,zg,zg,Tg,Tg,Tg,Tg],ib=({label:e,value:a,onChange:n,size:r="medium",color:s="silver"})=>{const i=270*a-135,o="orange"===s?"radial-gradient(circle at 30% 30%, #ff8800, #cc6600)":"radial-gradient(circle at 30% 30%, #c0c0c0, #808080)";return t.jsxs("div",{className:"flex flex-col items-center gap-1",children:[t.jsxs("div",{className:`${{small:"w-10 h-10",medium:"w-14 h-14",large:"w-20 h-20"}[r]} relative cursor-pointer select-none`,onMouseDown:e=>{const t=e.currentTarget.getBoundingClientRect(),a=t.left+t.width/2,r=t.top+t.height/2,s=e=>{const t=(Math.atan2(e.clientY-r,e.clientX-a)*(180/Math.PI)+135+360)%360,s=Math.max(0,Math.min(1,t/270));n(s)},i=()=>{document.removeEventListener("mousemove",s),document.removeEventListener("mouseup",i)};document.addEventListener("mousemove",s),document.addEventListener("mouseup",i)},title:`${e}: ${Math.round(100*a)}%`,children:[t.jsx("div",{className:"absolute inset-0 rounded-full border-2 border-gray-900 shadow-lg",style:{background:o}}),t.jsx("div",{className:"absolute top-1 left-1/2 w-0.5 h-3 bg-black rounded-full -translate-x-1/2",style:{transform:`translateX(-50%) rotate(${i}deg)`,transformOrigin:"50% "+("large"===r?"2.5rem":"medium"===r?"1.75rem":"1.25rem")}})]}),t.jsx("div",{className:"text-[9px] font-bold text-gray-300 uppercase tracking-wide text-center",children:e})]})},ob=({label:e,active:a=!1,onClick:n,color:r="gray"})=>{const s={gray:a?"bg-gray-600":"bg-gray-700",orange:a?"bg-orange-500":"bg-orange-600",red:a?"bg-red-500":"bg-red-600"};return t.jsx("button",{onClick:n,className:`${s[r]} hover:brightness-110 text-white text-[9px] font-bold px-3 py-1.5 rounded border border-gray-900 shadow-md transition-all ${a?"shadow-lg scale-95":""}`,children:e})},lb=({label:e,value:a,onChange:n,size:r="medium"})=>{const s=270*a-135;return t.jsxs("div",{className:"flex flex-col items-center gap-1",children:[t.jsxs("div",{className:`${{small:"w-10 h-10",medium:"w-12 h-12"}[r]} relative cursor-pointer select-none`,onMouseDown:e=>{const t=e.currentTarget.getBoundingClientRect(),a=t.left+t.width/2,r=t.top+t.height/2,s=e=>{const t=(Math.atan2(e.clientY-r,e.clientX-a)*(180/Math.PI)+135+360)%360,s=Math.max(0,Math.min(1,t/270));n(s)},i=()=>{document.removeEventListener("mousemove",s),document.removeEventListener("mouseup",i)};document.addEventListener("mousemove",s),document.addEventListener("mouseup",i)},title:`${e}: ${Math.round(100*a)}%`,children:[t.jsx("div",{className:"absolute inset-0 rounded-full border-2 border-gray-800 shadow-lg",style:{background:"radial-gradient(circle at 30% 30%, #707070, #404040)"}}),t.jsx("div",{className:"absolute top-1 left-1/2 w-1 h-2 bg-white rounded-full -translate-x-1/2 shadow-md",style:{transform:`translateX(-50%) rotate(${s}deg)`,transformOrigin:"50% "+("medium"===r?"1.5rem":"1.25rem")}})]}),t.jsx("div",{className:"text-[8px] font-semibold text-gray-300 uppercase tracking-wide text-center max-w-[60px]",children:e})]})},db=({label:e,active:a=!1,onClick:n,small:r=!1})=>t.jsx("button",{onClick:n,className:`${r?"text-[8px] px-2 py-1":"text-[9px] px-3 py-1.5"} ${a?"bg-red-600":"bg-gray-700"} hover:brightness-110 text-white font-bold rounded border border-gray-900 shadow-md transition-all ${a?"shadow-lg":""}`,children:e}),cb=({label:e,value:a,onChange:n})=>t.jsxs("div",{className:"flex flex-col items-center gap-1",children:[t.jsxs("div",{className:"relative h-24 w-6 flex items-center justify-center",children:[t.jsx("div",{className:"absolute inset-0 rounded bg-gray-800 border border-gray-700",children:t.jsx("div",{className:"absolute left-1/2 top-1 bottom-1 w-0.5 -translate-x-1/2 bg-gray-900 rounded-full"})}),t.jsx("input",{type:"range",min:"0",max:"1",step:"0.01",value:a,onChange:e=>{n(parseFloat(e.target.value))},className:"absolute h-24 w-6 bg-transparent cursor-pointer z-10 opacity-0",style:{writingMode:"vertical-lr",direction:"rtl"},title:`${e}: ${Math.round(100*a)}%`}),t.jsx("div",{className:"absolute w-5 h-2.5 rounded-sm bg-orange-500 border border-orange-700 shadow-md pointer-events-none z-20",style:{top:100-100*a+"%",transform:"translateY(-50%)"}})]}),t.jsx("div",{className:"text-[8px] font-bold text-gray-300 uppercase tracking-wide text-center",children:e})]}),ub=({label:e,active:a=!1,onClick:n,color:r="gray",small:s=!1})=>{const i={gray:a?"bg-gray-600":"bg-gray-700",orange:a?"bg-orange-500":"bg-orange-600"};return t.jsx("button",{onClick:n,className:`${i[r]} hover:brightness-110 text-white ${s?"text-[8px] px-2 py-1":"text-[9px] px-3 py-1.5"} font-bold rounded border border-gray-900 shadow-md transition-all ${a?"shadow-lg scale-95":""}`,children:e})},mb=({label:e,value:a,onChange:n,size:r="medium"})=>{const s=270*a-135;return t.jsxs("div",{className:"flex flex-col items-center gap-1",children:[t.jsxs("div",{className:`${{small:"w-10 h-10",medium:"w-14 h-14"}[r]} relative cursor-pointer select-none`,onMouseDown:e=>{const t=e.currentTarget.getBoundingClientRect(),a=t.left+t.width/2,r=t.top+t.height/2,s=e=>{const t=(Math.atan2(e.clientY-r,e.clientX-a)*(180/Math.PI)+135+360)%360,s=Math.max(0,Math.min(1,t/270));n(s)},i=()=>{document.removeEventListener("mousemove",s),document.removeEventListener("mouseup",i)};document.addEventListener("mousemove",s),document.addEventListener("mouseup",i)},title:`${e}: ${Math.round(100*a)}%`,children:[t.jsx("div",{className:"absolute inset-0 rounded-full border-2 border-black shadow-lg",style:{background:"radial-gradient(circle at 30% 30%, #303030, #000000)"}}),t.jsx("div",{className:"absolute top-1 left-1/2 w-1 h-3 bg-white rounded-full -translate-x-1/2 shadow-md",style:{transform:`translateX(-50%) rotate(${s}deg)`,transformOrigin:"50% "+("medium"===r?"1.75rem":"1.25rem")}})]}),t.jsx("div",{className:"text-[8px] font-semibold text-gray-300 uppercase tracking-wide text-center max-w-[60px]",children:e})]})},pb=({label:e,active:a=!1,onClick:n,small:r=!1})=>t.jsx("button",{onClick:n,className:`${r?"text-[8px] px-2 py-1":"text-[9px] px-3 py-1.5"} ${a?"bg-blue-600":"bg-gray-700"} hover:brightness-110 text-white font-bold rounded border border-gray-900 shadow-md transition-all ${a?"shadow-lg":""}`,children:e}),hb=({label:e,value:a,onChange:n})=>t.jsxs("div",{className:"flex flex-col items-center gap-1",children:[t.jsxs("div",{className:"relative h-28 w-6 flex items-center justify-center",children:[t.jsx("div",{className:"absolute inset-0 rounded bg-gray-800 border border-gray-700",children:t.jsx("div",{className:"absolute left-1/2 top-1 bottom-1 w-0.5 -translate-x-1/2 bg-gray-900 rounded-full"})}),t.jsx("input",{type:"range",min:"0",max:"1",step:"0.01",value:a,onChange:e=>{n(parseFloat(e.target.value))},className:"absolute h-28 w-6 bg-transparent cursor-pointer z-10 opacity-0",style:{writingMode:"vertical-lr",direction:"rtl"},title:`${e}: ${Math.round(100*a)}%`}),t.jsx("div",{className:"absolute w-5 h-2.5 rounded-sm bg-green-500 border border-green-700 shadow-md pointer-events-none z-20",style:{top:100-100*a+"%",transform:"translateY(-50%)"}})]}),t.jsx("div",{className:"text-[8px] font-bold text-gray-300 uppercase tracking-wide text-center",children:e})]}),fb=({label:e,active:a=!1,onClick:n,small:r=!1,color:s="gray"})=>{const i={gray:a?"bg-gray-600":"bg-gray-700",green:a?"bg-green-600":"bg-green-700"};return t.jsx("button",{onClick:n,className:`${i[s]} hover:brightness-110 text-white ${r?"text-[8px] px-2 py-1":"text-[9px] px-3 py-1.5"} font-bold rounded border border-gray-900 shadow-md transition-all ${a?"shadow-lg":""}`,children:e})},xb=({label:e,value:a,onChange:n,size:r="medium"})=>{const s=270*a-135;return t.jsxs("div",{className:"flex flex-col items-center gap-1",children:[t.jsxs("div",{className:`${{small:"w-10 h-10",medium:"w-14 h-14",large:"w-16 h-16"}[r]} relative cursor-pointer select-none`,onMouseDown:e=>{const t=e.currentTarget.getBoundingClientRect(),a=t.left+t.width/2,r=t.top+t.height/2,s=e=>{const t=(Math.atan2(e.clientY-r,e.clientX-a)*(180/Math.PI)+135+360)%360,s=Math.max(0,Math.min(1,t/270));n(s)},i=()=>{document.removeEventListener("mousemove",s),document.removeEventListener("mouseup",i)};document.addEventListener("mousemove",s),document.addEventListener("mouseup",i)},title:`${e}: ${Math.round(100*a)}%`,children:[t.jsx("div",{className:"absolute inset-0 rounded-full border-2 border-black shadow-lg",style:{background:"radial-gradient(circle at 30% 30%, #2a2a2a, #000000)"}}),t.jsx("div",{className:"absolute top-1 left-1/2 w-1 h-4 bg-white rounded-full -translate-x-1/2 shadow-md",style:{transform:`translateX(-50%) rotate(${s}deg)`,transformOrigin:"50% "+("large"===r?"2rem":"medium"===r?"1.75rem":"1.25rem")}})]}),t.jsx("div",{className:"text-[9px] font-semibold text-gray-300 uppercase tracking-wide text-center",children:e})]})},gb=({label:e,active:a=!1,onClick:n})=>t.jsxs("div",{className:"flex flex-col items-center gap-1",children:[t.jsx("button",{onClick:n,className:`w-6 h-6 rounded-full border-2 ${a?"bg-orange-500 border-orange-600":"bg-gray-800 border-gray-700"} shadow-md transition-all ${a?"shadow-lg shadow-orange-500/50":""}`}),t.jsx("div",{className:"text-[8px] font-semibold text-gray-300 uppercase tracking-wide text-center",children:e})]}),bb={MAMETR707:({parameters:e,onParamChange:a})=>{const n="cyan-lineart"!==B(e=>e.currentThemeId);return t.jsxs("div",{className:"rounded-lg overflow-hidden shadow-2xl "+(n?"bg-gradient-to-b from-gray-400 via-gray-300 to-gray-400":"bg-gradient-to-b from-gray-200 via-gray-100 to-gray-200"),style:{background:"linear-gradient(180deg, #d4d4d4 0%, #c0c0c0 50%, #a8a8a8 100%)"},children:[t.jsxs("div",{className:"px-4 py-2 bg-gradient-to-r from-orange-600 to-orange-500 border-b-2 border-gray-500 flex items-center justify-between",children:[t.jsx("div",{className:"flex items-center gap-4",children:t.jsx("div",{className:"text-white font-black text-xl tracking-wider",style:{fontFamily:"monospace"},children:"ROLAND"})}),t.jsxs("div",{className:"text-right",children:[t.jsx("div",{className:"text-gray-800 text-xs font-light tracking-[0.3em] uppercase",children:"Rhythm Composer"}),t.jsx("div",{className:"text-gray-900 font-black text-3xl tracking-tight",children:"TR-707"})]})]}),t.jsxs("div",{className:"flex gap-4 p-4",children:[t.jsxs("div",{className:"flex-shrink-0 w-48 space-y-3",children:[t.jsx("div",{className:"bg-gradient-to-b from-gray-700 to-gray-800 p-3 rounded border-2 border-gray-600 shadow-inner",children:t.jsxs("div",{className:"bg-green-900/30 border border-green-800 rounded p-2 min-h-[80px] font-mono text-xs text-green-400",children:[t.jsx("div",{className:"opacity-80",children:"MEMORY PATTERN"}),t.jsx("div",{className:"mt-2 text-[10px]",children:"PTN: 01"}),t.jsx("div",{className:"text-[10px]",children:"KIT: Standard"})]})}),t.jsx("div",{className:"grid grid-cols-4 gap-1",children:["A","B","C","D","E","F","G","H"].map(e=>t.jsx("button",{className:"bg-gray-700 hover:bg-gray-600 text-white text-xs font-bold py-2 rounded border border-gray-600 shadow",children:e},e))}),t.jsxs("div",{className:"space-y-1",children:[t.jsx("button",{className:"w-full bg-orange-600 hover:bg-orange-500 text-white text-xs font-bold py-2 rounded border border-orange-700",children:"EDIT"}),t.jsx("button",{className:"w-full bg-gray-700 hover:bg-gray-600 text-white text-xs font-bold py-2 rounded border border-gray-600",children:"OPTION"})]})]}),t.jsxs("div",{className:"flex-1 flex flex-col",children:[t.jsx("div",{className:"text-xs font-bold text-gray-700 uppercase tracking-widest mb-2 text-center",children:"LEVEL"}),t.jsxs("div",{className:"flex gap-2 justify-between items-end flex-1 px-2",children:[t.jsx("div",{className:"text-[9px] text-gray-600 uppercase tracking-tight self-start",children:"MAX"}),jg.map(n=>t.jsx(_g,{label:n.label,shortLabel:n.shortLabel,value:e[n.key]||.8,onChange:e=>a(n.key,e)},n.key)),t.jsx("div",{className:"text-[9px] text-gray-600 uppercase tracking-tight self-start",children:"MAX"})]}),t.jsx("div",{className:"text-[9px] text-gray-600 uppercase tracking-tight text-center mt-1",children:"MIN"}),t.jsx("div",{className:"flex justify-end mt-3 pr-4",children:t.jsxs("div",{className:"text-center",children:[t.jsx("div",{className:"text-[10px] text-gray-700 uppercase font-bold mb-1",children:"Shuffle"}),t.jsx(kg,{label:"",value:e.decay||.5,onChange:e=>a("decay",e),size:"medium"})]})})]})]}),t.jsx("div",{className:"px-4 pb-3",children:t.jsxs("div",{className:"bg-gradient-to-b from-gray-600 to-gray-700 rounded p-2 border border-gray-500",children:[t.jsx("div",{className:"grid grid-cols-16 gap-0.5 mb-2",children:Array.from({length:16},(e,a)=>t.jsx("div",{className:"bg-gray-800 hover:bg-gray-700 border border-gray-600 h-6 rounded-sm flex items-center justify-center text-[9px] text-gray-400",children:a+1},a))}),t.jsxs("div",{className:"flex gap-2 text-[9px] text-gray-300 justify-between px-1",children:[t.jsx("span",{children:"Bass Drum"}),t.jsx("span",{children:"Snare Drum"}),t.jsx("span",{children:"Low Tom"}),t.jsx("span",{children:"Mid Tom"}),t.jsx("span",{children:"Hi Tom"}),t.jsx("span",{className:"text-right",children:"Hi-Hat"})]})]})}),t.jsx("div",{className:"px-4 py-1 bg-gray-800 border-t border-gray-600",children:t.jsx("div",{className:"text-[9px] text-gray-500 text-center uppercase tracking-widest",children:"PCM Digital Rhythm Composer • 1985"})})]})},DrumMachine:({parameters:e,onParamChange:a})=>{const[n,r]=fe.useState(new Array(16).fill(!1)),s=he.useCallback(e=>{r(t=>{const a=[...t];return a[e]=!a[e],a})},[]),i=Math.ceil(364),o=520-i;return t.jsxs("div",{style:{width:"100%",backgroundColor:$g,overflow:"hidden"},children:[t.jsxs("div",{style:{width:"100%",display:"flex",flexDirection:"column"},children:[t.jsx("div",{style:{width:"100%",height:3,backgroundColor:Ng}}),t.jsx("div",{style:{width:"100%",height:i,display:"flex",flexDirection:"row",alignItems:"center"},children:rb.reduce((n,r,s)=>{const o=[...n];return 0!==s&&o.push(t.jsx("div",{style:{width:1,height:i-10,backgroundColor:Ng,flexShrink:0}},`separator-${s}`)),o.push(t.jsx("div",{style:{flex:"1 1 0",minWidth:0,height:i,display:"flex",justifyContent:"center"},children:t.jsx(Qg,{config:r,width:110,height:i,parameters:e,onParamChange:a})},`column-${s}`)),o},[])}),t.jsxs("div",{style:{width:"100%",height:o,display:"flex",flexDirection:"row",alignItems:"center",justifyContent:"space-between"},children:[t.jsx(eb,{width:Math.ceil(5.5*o),height:o}),t.jsx("div",{style:{height:o,display:"flex",flex:1,alignItems:"center",justifyContent:"center"},children:t.jsx(ab,{value:e.master_volume??75,onChange:e=>a("master_volume",e),size:Math.floor(.86*o)})})]}),t.jsx("div",{style:{width:"100%",height:3,backgroundColor:Ng}})]}),t.jsxs("div",{style:{width:"100%",height:120,backgroundColor:Ng,padding:"8px 16px",display:"flex",flexDirection:"column"},children:[t.jsx("div",{style:{display:"flex",flexDirection:"row",justifyContent:"space-around",alignItems:"center",marginBottom:4},children:sb.map((e,a)=>t.jsx("div",{style:{...Lg,color:a<8?Cg:$g,fontSize:a<4||a>=8&&a<12?13:11,fontWeight:"bold",width:50,textAlign:"center"},children:a+1},a))}),t.jsx("div",{style:{display:"flex",flexDirection:"row",justifyContent:"space-around",alignItems:"flex-start",flex:1},children:sb.map((e,a)=>t.jsx(nb,{color:e,active:n[a],onClick:()=>s(a),width:50,height:80},a))})]})]})},TB303:({parameters:e,onParamChange:a})=>t.jsxs("div",{className:"rounded-lg overflow-hidden shadow-2xl",style:{background:"linear-gradient(180deg, #e0e0e0 0%, #c8c8c8 50%, #b0b0b0 100%)"},children:[t.jsxs("div",{className:"px-4 py-2 bg-gradient-to-r from-gray-800 to-gray-700 border-b-2 border-gray-900 flex items-center justify-between",children:[t.jsx("div",{className:"flex items-center gap-4",children:t.jsx("div",{className:"text-white font-black text-xl tracking-wider",style:{fontFamily:"monospace"},children:"ROLAND"})}),t.jsxs("div",{className:"text-right",children:[t.jsx("div",{className:"text-gray-300 text-xs font-light tracking-[0.3em] uppercase",children:"Bass Line"}),t.jsx("div",{className:"text-white font-black text-3xl tracking-tight",children:"TB-303"})]})]}),t.jsxs("div",{className:"p-6",children:[t.jsxs("div",{className:"mb-6",children:[t.jsx("div",{className:"text-xs font-bold text-gray-700 uppercase tracking-widest mb-3 border-b border-gray-400 pb-1",children:"VCF (Voltage Controlled Filter)"}),t.jsxs("div",{className:"flex gap-6 justify-center",children:[t.jsx(ib,{label:"Cutoff",value:e.cutoff||.5,onChange:e=>a("cutoff",e),size:"large",color:"silver"}),t.jsx(ib,{label:"Resonance",value:e.resonance||.5,onChange:e=>a("resonance",e),size:"large",color:"silver"}),t.jsx(ib,{label:"Env Mod",value:e.envMod||.5,onChange:e=>a("envMod",e),size:"large",color:"silver"}),t.jsx(ib,{label:"Decay",value:e.decay||.5,onChange:e=>a("decay",e),size:"large",color:"silver"})]})]}),t.jsxs("div",{className:"mb-6",children:[t.jsx("div",{className:"text-xs font-bold text-gray-700 uppercase tracking-widest mb-3 border-b border-gray-400 pb-1",children:"VCO (Voltage Controlled Oscillator)"}),t.jsxs("div",{className:"flex gap-6 justify-center items-end",children:[t.jsx(ib,{label:"Tuning",value:e.tuning||.5,onChange:e=>a("tuning",e),size:"medium",color:"silver"}),t.jsxs("div",{className:"flex flex-col items-center gap-2",children:[t.jsxs("div",{className:"flex gap-2",children:[t.jsx(ob,{label:"SAW",active:1!==e.waveform,onClick:()=>a("waveform",0)}),t.jsx(ob,{label:"SQR",active:1===e.waveform,onClick:()=>a("waveform",1)})]}),t.jsx("div",{className:"text-[9px] font-bold text-gray-700 uppercase",children:"Wave"})]})]})]}),t.jsxs("div",{className:"mb-4",children:[t.jsx("div",{className:"text-xs font-bold text-gray-700 uppercase tracking-widest mb-3 border-b border-gray-400 pb-1",children:"VCA (Voltage Controlled Amplifier)"}),t.jsxs("div",{className:"flex gap-6 justify-center",children:[t.jsx(ib,{label:"Volume",value:e.volume||.8,onChange:e=>a("volume",e),size:"large",color:"orange"}),t.jsx(ib,{label:"Accent",value:e.accent||.5,onChange:e=>a("accent",e),size:"medium",color:"silver"})]})]}),t.jsxs("div",{className:"flex gap-2 justify-center mt-6 pt-4 border-t border-gray-400",children:[t.jsx(ob,{label:"NORMAL",color:"gray"}),t.jsx(ob,{label:"PATTERN",color:"gray"}),t.jsx(ob,{label:"WRITE",color:"orange"}),t.jsx(ob,{label:"TRACK",color:"gray"})]})]}),t.jsx("div",{className:"px-4 py-1 bg-gray-900 border-t border-gray-700",children:t.jsx("div",{className:"text-[9px] text-gray-500 text-center uppercase tracking-widest",children:"Computerized Bass Line • 1981-1984 • Acid House Legend"})})]}),CZ101:({parameters:e,onParamChange:a})=>t.jsxs("div",{className:"rounded-lg overflow-hidden shadow-2xl max-w-2xl",style:{background:"linear-gradient(180deg, #4a4a4a 0%, #3a3a3a 50%, #2a2a2a 100%)"},children:[t.jsxs("div",{className:"px-4 py-2 bg-gradient-to-r from-gray-900 to-gray-800 border-b-2 border-orange-600 flex items-center justify-between",children:[t.jsx("div",{className:"flex items-center gap-3",children:t.jsx("div",{className:"text-white font-black text-xl tracking-[0.3em]",style:{fontFamily:"sans-serif"},children:"CASIO"})}),t.jsxs("div",{className:"text-right",children:[t.jsx("div",{className:"text-orange-400 text-xs font-light tracking-[0.3em] uppercase",children:"Phase Distortion"}),t.jsx("div",{className:"text-white font-black text-3xl tracking-wide",children:"CZ-101"})]})]}),t.jsxs("div",{className:"p-4",children:[t.jsx("div",{className:"mb-4 bg-gradient-to-b from-gray-800 to-gray-900 p-2 rounded border border-gray-700 shadow-inner",children:t.jsxs("div",{className:"bg-amber-900/20 border border-amber-800 rounded p-2 min-h-[60px] font-mono text-xs text-amber-400",children:[t.jsxs("div",{className:"flex justify-between",children:[t.jsx("span",{children:"PATCH: 12"}),t.jsx("span",{children:"BRASS 1"})]}),t.jsx("div",{className:"text-[10px] text-amber-500/80 mt-1",children:"DCO1: SAW | DCO2: PULSE"})]})}),t.jsxs("div",{className:"mb-4",children:[t.jsx("div",{className:"text-[10px] font-bold text-orange-400 uppercase tracking-widest mb-2 text-center",children:"Parameter Control"}),t.jsxs("div",{className:"flex gap-3 justify-center items-end bg-gray-900/30 rounded p-3",children:[t.jsx(cb,{label:"DCW",value:e.dcw||.5,onChange:e=>a("dcw",e)}),t.jsx(cb,{label:"DCA",value:e.dca||.8,onChange:e=>a("dca",e)}),t.jsx(cb,{label:"DCO",value:e.dco||.5,onChange:e=>a("dco",e)}),t.jsx(cb,{label:"Detune",value:e.detune||.5,onChange:e=>a("detune",e)}),t.jsx(cb,{label:"Octave",value:e.octave||.5,onChange:e=>a("octave",e)}),t.jsx(cb,{label:"Volume",value:e.volume||.8,onChange:e=>a("volume",e)})]})]}),t.jsxs("div",{className:"mb-3",children:[t.jsx("div",{className:"text-[10px] font-bold text-orange-400 uppercase tracking-widest mb-2 text-center",children:"Waveform"}),t.jsxs("div",{className:"grid grid-cols-4 gap-1",children:[t.jsx(ub,{label:"SAW",small:!0,active:0===e.waveform,onClick:()=>a("waveform",0)}),t.jsx(ub,{label:"SQUARE",small:!0,active:1===e.waveform,onClick:()=>a("waveform",1)}),t.jsx(ub,{label:"PULSE",small:!0,active:2===e.waveform,onClick:()=>a("waveform",2)}),t.jsx(ub,{label:"RESO",small:!0,active:6===e.waveform,onClick:()=>a("waveform",6)})]})]}),t.jsxs("div",{className:"grid grid-cols-3 gap-2 mb-3",children:[t.jsx(ub,{label:"CARTRIDGE",color:"gray"}),t.jsx(ub,{label:"TONE EDIT",color:"orange"}),t.jsx(ub,{label:"PROGRAM",color:"gray"})]}),t.jsx("div",{className:"grid grid-cols-4 gap-1",children:["A-1","A-2","A-3","A-4","B-1","B-2","B-3","B-4"].map(e=>t.jsx(ub,{label:e,small:!0,color:"gray"},e))})]}),t.jsx("div",{className:"px-4 py-1 bg-black border-t border-gray-800",children:t.jsx("div",{className:"text-[9px] text-gray-600 text-center uppercase tracking-widest",children:"Phase Distortion Synthesis • 8 Voices • 1984"})})]}),Dexed:({parameters:e,onParamChange:a})=>t.jsxs("div",{className:"rounded-lg overflow-hidden shadow-2xl",style:{background:"linear-gradient(180deg, #d0d0d0 0%, #a8a8a8 100%)"},children:[t.jsxs("div",{className:"px-6 py-3 bg-gradient-to-r from-gray-900 to-gray-800 border-b-2 border-gray-700",children:[t.jsx("div",{className:"flex items-center justify-between mb-3",children:t.jsxs("div",{children:[t.jsx("div",{className:"text-gray-400 text-[10px] font-light tracking-[0.5em] uppercase",children:"Yamaha"}),t.jsx("div",{className:"text-white font-black text-4xl tracking-wider",children:"DX7"}),t.jsx("div",{className:"text-gray-400 text-[9px] font-light tracking-[0.3em] uppercase",children:"Digital Programmable Algorithm Synthesizer"})]})}),t.jsx("div",{className:"bg-gradient-to-b from-green-950 to-black border-2 border-green-800 rounded p-3 shadow-inner",children:t.jsxs("div",{className:"font-mono text-green-400 text-sm",children:[t.jsxs("div",{className:"flex justify-between mb-1",children:[t.jsx("span",{children:"VOICE: 01"}),t.jsx("span",{children:"E.PIANO 1"})]}),t.jsxs("div",{className:"text-xs text-green-500 opacity-80 grid grid-cols-2 gap-2",children:[t.jsx("span",{children:"ALG: 05"}),t.jsx("span",{children:"FBK: 7"})]}),t.jsx("div",{className:"text-[10px] text-green-600 mt-1 flex gap-4",children:t.jsx("span",{children:"OP1█ OP2█ OP3▓ OP4▓ OP5░ OP6░"})})]})})]}),t.jsxs("div",{className:"p-6 bg-gradient-to-b from-gray-400 to-gray-500",children:[t.jsxs("div",{className:"mb-6",children:[t.jsx("div",{className:"text-xs font-bold text-gray-800 uppercase tracking-widest mb-3 pb-1 border-b border-gray-600",children:"Operator Levels"}),t.jsxs("div",{className:"flex gap-4 justify-center items-end bg-gray-500/30 rounded p-4",children:[t.jsx(hb,{label:"OP1",value:e.op1_level||.99,onChange:e=>a("op1_level",e)}),t.jsx(hb,{label:"OP2",value:e.op2_level||.99,onChange:e=>a("op2_level",e)}),t.jsx(hb,{label:"OP3",value:e.op3_level||.8,onChange:e=>a("op3_level",e)}),t.jsx(hb,{label:"OP4",value:e.op4_level||.8,onChange:e=>a("op4_level",e)}),t.jsx(hb,{label:"OP5",value:e.op5_level||.5,onChange:e=>a("op5_level",e)}),t.jsx(hb,{label:"OP6",value:e.op6_level||.5,onChange:e=>a("op6_level",e)})]})]}),t.jsxs("div",{className:"mb-4",children:[t.jsx("div",{className:"text-xs font-bold text-gray-800 uppercase tracking-widest mb-3 pb-1 border-b border-gray-600",children:"Master"}),t.jsxs("div",{className:"flex gap-6 justify-center items-end",children:[t.jsx(hb,{label:"Volume",value:e.volume||.8,onChange:e=>a("volume",e)}),t.jsx(hb,{label:"Detune",value:e.detune||.5,onChange:e=>a("detune",e)}),t.jsx(hb,{label:"Feedback",value:e.feedback||.5,onChange:e=>a("feedback",e)})]})]}),t.jsxs("div",{className:"grid grid-cols-4 gap-2 mt-6 pt-4 border-t border-gray-600",children:[t.jsx(fb,{label:"EDIT",color:"green"}),t.jsx(fb,{label:"VOICE",color:"gray"}),t.jsx(fb,{label:"FUNCTION",color:"gray"}),t.jsx(fb,{label:"STORE",color:"green"})]}),t.jsxs("div",{className:"grid grid-cols-4 gap-2 mt-3",children:[t.jsx(fb,{label:"1-8",small:!0}),t.jsx(fb,{label:"9-16",small:!0}),t.jsx(fb,{label:"17-24",small:!0}),t.jsx(fb,{label:"25-32",small:!0})]}),t.jsxs("div",{className:"mt-4 p-3 bg-gray-700 rounded border border-gray-800",children:[t.jsx("div",{className:"text-[9px] text-gray-300 uppercase tracking-wide mb-2 text-center",children:"Algorithm 5"}),t.jsxs("div",{className:"flex justify-center gap-2 text-[10px] font-mono text-green-400",children:[t.jsxs("div",{className:"flex flex-col items-center gap-1",children:[t.jsx("div",{className:"w-6 h-6 border-2 border-green-400 rounded flex items-center justify-center",children:"6"}),t.jsx("div",{className:"h-4 w-0.5 bg-green-400"}),t.jsx("div",{className:"w-6 h-6 border-2 border-green-400 rounded flex items-center justify-center",children:"5"})]}),t.jsxs("div",{className:"flex flex-col items-center gap-1",children:[t.jsx("div",{className:"w-6 h-6 border-2 border-green-400 rounded flex items-center justify-center",children:"4"}),t.jsx("div",{className:"h-4 w-0.5 bg-green-400"}),t.jsx("div",{className:"w-6 h-6 border-2 border-green-400 rounded flex items-center justify-center",children:"3"})]}),t.jsxs("div",{className:"flex flex-col items-center gap-1",children:[t.jsx("div",{className:"w-6 h-6 border-2 border-green-400 rounded flex items-center justify-center",children:"2"}),t.jsx("div",{className:"h-4 w-0.5 bg-green-400"}),t.jsx("div",{className:"w-6 h-6 border-2 border-green-400 rounded flex items-center justify-center",children:"1"})]})]})]})]}),t.jsx("div",{className:"px-4 py-1 bg-gray-800 border-t border-gray-700",children:t.jsx("div",{className:"text-[9px] text-gray-400 text-center uppercase tracking-widest",children:"6-Operator FM Synthesis • 32 Algorithms • 16 Voices • 1983"})})]}),OBXd:({parameters:e,onParamChange:a})=>t.jsxs("div",{className:"rounded-lg overflow-hidden shadow-2xl",style:{background:"linear-gradient(180deg, #4a4a4a 0%, #2a2a2a 100%)"},children:[t.jsx("div",{className:"px-6 py-3 bg-gradient-to-r from-orange-700 to-orange-600 border-b-2 border-orange-800",children:t.jsxs("div",{className:"flex items-center justify-between",children:[t.jsxs("div",{children:[t.jsx("div",{className:"text-orange-200 text-sm font-light tracking-[0.5em] uppercase",children:"Oberheim"}),t.jsx("div",{className:"text-white font-black text-4xl tracking-wider",children:"OB-X"})]}),t.jsxs("div",{className:"text-right",children:[t.jsx("div",{className:"text-orange-200 text-xs font-light tracking-[0.3em] uppercase",children:"Polyphonic"}),t.jsx("div",{className:"text-white text-2xl font-bold",children:"8 VOICE"})]})]})}),t.jsxs("div",{className:"p-6 bg-gradient-to-b from-gray-800 to-gray-900",children:[t.jsxs("div",{className:"mb-6",children:[t.jsx("div",{className:"text-xs font-bold text-orange-400 uppercase tracking-widest mb-3 pb-1 border-b border-gray-700",children:"Oscillators"}),t.jsxs("div",{className:"grid grid-cols-3 gap-6",children:[t.jsxs("div",{className:"text-center",children:[t.jsx("div",{className:"text-[10px] text-gray-400 uppercase mb-2",children:"VCO 1"}),t.jsxs("div",{className:"flex gap-3 justify-center",children:[t.jsx(xb,{label:"Freq",value:e.vco1_freq||.5,onChange:e=>a("vco1_freq",e),size:"medium"}),t.jsx(xb,{label:"Level",value:e.vco1_level||.8,onChange:e=>a("vco1_level",e),size:"small"})]})]}),t.jsxs("div",{className:"text-center",children:[t.jsx("div",{className:"text-[10px] text-gray-400 uppercase mb-2",children:"VCO 2"}),t.jsxs("div",{className:"flex gap-3 justify-center",children:[t.jsx(xb,{label:"Freq",value:e.vco2_freq||.5,onChange:e=>a("vco2_freq",e),size:"medium"}),t.jsx(xb,{label:"Level",value:e.vco2_level||.8,onChange:e=>a("vco2_level",e),size:"small"})]})]}),t.jsxs("div",{className:"text-center",children:[t.jsx("div",{className:"text-[10px] text-gray-400 uppercase mb-2",children:"Mix"}),t.jsx(xb,{label:"Detune",value:e.detune||.5,onChange:e=>a("detune",e),size:"medium"})]})]}),t.jsxs("div",{className:"flex gap-8 justify-center mt-4 p-3 bg-gray-900/50 rounded",children:[t.jsxs("div",{className:"flex gap-3",children:[t.jsx(gb,{label:"SAW",active:1===e.vco1_saw,onClick:()=>a("vco1_saw",1===e.vco1_saw?0:1)}),t.jsx(gb,{label:"PLS",active:1===e.vco1_pulse,onClick:()=>a("vco1_pulse",1===e.vco1_pulse?0:1)})]}),t.jsxs("div",{className:"flex gap-3",children:[t.jsx(gb,{label:"SAW",active:1===e.vco2_saw,onClick:()=>a("vco2_saw",1===e.vco2_saw?0:1)}),t.jsx(gb,{label:"PLS",active:1===e.vco2_pulse,onClick:()=>a("vco2_pulse",1===e.vco2_pulse?0:1)})]})]})]}),t.jsxs("div",{className:"mb-6",children:[t.jsx("div",{className:"text-xs font-bold text-orange-400 uppercase tracking-widest mb-3 pb-1 border-b border-gray-700",children:"VCF (Filter)"}),t.jsxs("div",{className:"flex gap-5 justify-center",children:[t.jsx(xb,{label:"Cutoff",value:e.cutoff||.7,onChange:e=>a("cutoff",e),size:"large"}),t.jsx(xb,{label:"Reso",value:e.resonance||.3,onChange:e=>a("resonance",e),size:"large"}),t.jsx(xb,{label:"Env Amt",value:e.filter_env||.5,onChange:e=>a("filter_env",e),size:"medium"}),t.jsx(xb,{label:"Kbd Amt",value:e.filter_kbd||.5,onChange:e=>a("filter_kbd",e),size:"small"})]}),t.jsxs("div",{className:"flex gap-4 justify-center mt-4",children:[t.jsx(gb,{label:"LP",active:0===e.filter_mode,onClick:()=>a("filter_mode",0)}),t.jsx(gb,{label:"BP",active:1===e.filter_mode,onClick:()=>a("filter_mode",1)}),t.jsx(gb,{label:"HP",active:2===e.filter_mode,onClick:()=>a("filter_mode",2)})]})]}),t.jsxs("div",{className:"mb-6",children:[t.jsx("div",{className:"text-xs font-bold text-orange-400 uppercase tracking-widest mb-3 pb-1 border-b border-gray-700",children:"Envelope"}),t.jsxs("div",{className:"flex gap-5 justify-center",children:[t.jsx(xb,{label:"Attack",value:e.attack||.01,onChange:e=>a("attack",e),size:"medium"}),t.jsx(xb,{label:"Decay",value:e.decay||.3,onChange:e=>a("decay",e),size:"medium"}),t.jsx(xb,{label:"Sustain",value:e.sustain||.7,onChange:e=>a("sustain",e),size:"medium"}),t.jsx(xb,{label:"Release",value:e.release||.3,onChange:e=>a("release",e),size:"medium"})]})]}),t.jsxs("div",{className:"mb-4",children:[t.jsx("div",{className:"text-xs font-bold text-orange-400 uppercase tracking-widest mb-3 pb-1 border-b border-gray-700",children:"Master"}),t.jsxs("div",{className:"flex gap-6 justify-center items-end",children:[t.jsx(xb,{label:"Volume",value:e.volume||.8,onChange:e=>a("volume",e),size:"large"}),t.jsx(xb,{label:"Tune",value:e.tune||.5,onChange:e=>a("tune",e),size:"small"}),t.jsx("div",{className:"flex flex-col items-center gap-2",children:t.jsx(gb,{label:"UNISON",active:1===e.unison,onClick:()=>a("unison",1===e.unison?0:1)})})]})]})]}),t.jsx("div",{className:"px-4 py-1 bg-black border-t border-gray-800",children:t.jsx("div",{className:"text-[9px] text-gray-600 text-center uppercase tracking-widest",children:"Analog Polyphonic Synthesizer • Classic Warmth • 1979"})})]}),MAMERSA:({parameters:e,onParamChange:a})=>t.jsxs("div",{className:"rounded-lg overflow-hidden shadow-2xl",style:{background:"linear-gradient(180deg, #2a2a2a 0%, #1a1a1a 100%)"},children:[t.jsxs("div",{className:"px-6 py-3 bg-gradient-to-r from-gray-900 via-gray-800 to-gray-900 border-b-2 border-gray-700",children:[t.jsxs("div",{className:"flex items-center justify-between mb-3",children:[t.jsx("div",{className:"text-white font-black text-2xl tracking-wider",style:{fontFamily:"monospace"},children:"ROLAND"}),t.jsxs("div",{className:"text-right",children:[t.jsx("div",{className:"text-gray-400 text-[10px] font-light tracking-[0.4em] uppercase",children:"Linear Synthesizer"}),t.jsx("div",{className:"text-white font-black text-4xl tracking-tight",children:"D-50"})]})]}),t.jsx("div",{className:"bg-gradient-to-b from-cyan-900 to-cyan-950 border-2 border-cyan-800 rounded p-3 shadow-inner",children:t.jsxs("div",{className:"font-mono text-cyan-400 text-sm",children:[t.jsxs("div",{className:"flex justify-between mb-1",children:[t.jsx("span",{children:"PATCH: 11"}),t.jsx("span",{children:"FANTASIA"})]}),t.jsxs("div",{className:"text-xs text-cyan-500 opacity-80",children:[t.jsx("span",{children:"Upper: Piano+Str"}),t.jsx("span",{className:"ml-4",children:"Lower: Synth Bass"})]})]})})]}),t.jsxs("div",{className:"p-6 bg-gradient-to-b from-gray-800 to-gray-900",children:[t.jsxs("div",{className:"mb-6",children:[t.jsx("div",{className:"text-xs font-bold text-cyan-400 uppercase tracking-widest mb-3 pb-1 border-b border-gray-700",children:"Tone Controls"}),t.jsxs("div",{className:"grid grid-cols-4 gap-4",children:[t.jsxs("div",{className:"text-center",children:[t.jsx("div",{className:"text-[9px] text-gray-400 uppercase mb-2",children:"Upper"}),t.jsxs("div",{className:"flex gap-3 justify-center",children:[t.jsx(lb,{label:"Level",value:e.upper_level||.8,onChange:e=>a("upper_level",e),size:"medium"}),t.jsx(lb,{label:"Detune",value:e.upper_detune||.5,onChange:e=>a("upper_detune",e),size:"small"})]})]}),t.jsxs("div",{className:"text-center",children:[t.jsx("div",{className:"text-[9px] text-gray-400 uppercase mb-2",children:"Lower"}),t.jsxs("div",{className:"flex gap-3 justify-center",children:[t.jsx(lb,{label:"Level",value:e.lower_level||.8,onChange:e=>a("lower_level",e),size:"medium"}),t.jsx(lb,{label:"Detune",value:e.lower_detune||.5,onChange:e=>a("lower_detune",e),size:"small"})]})]}),t.jsxs("div",{className:"text-center",children:[t.jsx("div",{className:"text-[9px] text-gray-400 uppercase mb-2",children:"Cutoff"}),t.jsx(lb,{label:"Filter",value:e.cutoff||.7,onChange:e=>a("cutoff",e),size:"medium"})]}),t.jsxs("div",{className:"text-center",children:[t.jsx("div",{className:"text-[9px] text-gray-400 uppercase mb-2",children:"Resonance"}),t.jsx(lb,{label:"Reso",value:e.resonance||.3,onChange:e=>a("resonance",e),size:"medium"})]})]})]}),t.jsxs("div",{className:"mb-6",children:[t.jsx("div",{className:"text-xs font-bold text-cyan-400 uppercase tracking-widest mb-3 pb-1 border-b border-gray-700",children:"Effects & Master"}),t.jsxs("div",{className:"flex gap-6 justify-center items-end",children:[t.jsx(lb,{label:"Chorus",value:e.chorus||.3,onChange:e=>a("chorus",e),size:"medium"}),t.jsx(lb,{label:"Reverb",value:e.reverb||.4,onChange:e=>a("reverb",e),size:"medium"}),t.jsx(lb,{label:"Volume",value:e.volume||.8,onChange:e=>a("volume",e),size:"medium"})]})]}),t.jsxs("div",{className:"grid grid-cols-4 gap-2 mt-6 pt-4 border-t border-gray-700",children:[t.jsx(db,{label:"PATCH"}),t.jsx(db,{label:"TONE"}),t.jsx(db,{label:"CHASE"}),t.jsx(db,{label:"EDIT"}),t.jsx(db,{label:"WRITE"}),t.jsx(db,{label:"UTILITY"}),t.jsx(db,{label:"MIDI"}),t.jsx(db,{label:"EXIT"})]}),t.jsx("div",{className:"grid grid-cols-8 gap-1 mt-4",children:["A-1","A-2","A-3","A-4","A-5","A-6","A-7","A-8"].map(e=>t.jsx(db,{label:e,small:!0},e))})]}),t.jsx("div",{className:"px-4 py-1 bg-black border-t border-gray-800",children:t.jsx("div",{className:"text-[9px] text-gray-600 text-center uppercase tracking-widest",children:"LA Synthesis • 16 Voices • PCM + Analog • 1987"})})]}),MAMEVFX:({parameters:e,onParamChange:a})=>t.jsxs("div",{className:"rounded-lg overflow-hidden shadow-2xl",style:{background:"linear-gradient(180deg, #1a1a1a 0%, #0a0a0a 100%)"},children:[t.jsxs("div",{className:"px-6 py-3 bg-gradient-to-r from-blue-900 via-blue-800 to-blue-900 border-b-2 border-blue-700",children:[t.jsx("div",{className:"flex items-center justify-between mb-3",children:t.jsxs("div",{children:[t.jsx("div",{className:"text-blue-200 text-[10px] font-light tracking-[0.5em] uppercase",children:"Ensoniq"}),t.jsx("div",{className:"text-white font-black text-3xl tracking-wider",children:"VFX"}),t.jsx("div",{className:"text-blue-300 text-[9px] font-light tracking-[0.3em] uppercase",children:"SD Music Synthesizer"})]})}),t.jsx("div",{className:"bg-gradient-to-b from-blue-950 to-black border-2 border-blue-800 rounded p-3 shadow-inner",children:t.jsxs("div",{className:"font-mono text-blue-400 text-sm",children:[t.jsxs("div",{className:"flex justify-between mb-1",children:[t.jsx("span",{children:"PROG: 042"}),t.jsx("span",{children:"TRANSWAVES"})]}),t.jsx("div",{className:"text-xs text-blue-500 opacity-80",children:t.jsx("span",{children:"Wave: Piano →  Strings"})}),t.jsxs("div",{className:"text-[10px] text-blue-600 mt-1",children:[t.jsx("span",{children:"ENV1: ▁▃▅█▇▅▃▁"}),t.jsx("span",{className:"ml-4",children:"ENV2: ▁▂▃▄▅▆▇█"})]})]})})]}),t.jsxs("div",{className:"p-6 bg-gradient-to-b from-gray-900 to-black",children:[t.jsxs("div",{className:"mb-6",children:[t.jsx("div",{className:"text-xs font-bold text-blue-400 uppercase tracking-widest mb-3 pb-1 border-b border-gray-800",children:"Oscillator / Wave"}),t.jsxs("div",{className:"flex gap-5 justify-center",children:[t.jsx(mb,{label:"Wave",value:e.wave||0,onChange:e=>a("wave",e),size:"medium"}),t.jsx(mb,{label:"Start",value:e.wave_start||0,onChange:e=>a("wave_start",e),size:"medium"}),t.jsx(mb,{label:"End",value:e.wave_end||1,onChange:e=>a("wave_end",e),size:"medium"}),t.jsx(mb,{label:"Pitch",value:e.pitch||.5,onChange:e=>a("pitch",e),size:"medium"}),t.jsx(mb,{label:"Fine",value:e.fine||.5,onChange:e=>a("fine",e),size:"small"})]})]}),t.jsxs("div",{className:"mb-6",children:[t.jsx("div",{className:"text-xs font-bold text-blue-400 uppercase tracking-widest mb-3 pb-1 border-b border-gray-800",children:"Filter"}),t.jsxs("div",{className:"flex gap-5 justify-center",children:[t.jsx(mb,{label:"Cutoff",value:e.cutoff||.7,onChange:e=>a("cutoff",e),size:"medium"}),t.jsx(mb,{label:"Reso",value:e.resonance||.3,onChange:e=>a("resonance",e),size:"medium"}),t.jsx(mb,{label:"Env Amt",value:e.filter_env||.5,onChange:e=>a("filter_env",e),size:"medium"}),t.jsx(mb,{label:"Vel Amt",value:e.filter_vel||.5,onChange:e=>a("filter_vel",e),size:"small"})]})]}),t.jsxs("div",{className:"mb-6",children:[t.jsx("div",{className:"text-xs font-bold text-blue-400 uppercase tracking-widest mb-3 pb-1 border-b border-gray-800",children:"Envelope / Amp"}),t.jsxs("div",{className:"flex gap-5 justify-center",children:[t.jsx(mb,{label:"Attack",value:e.attack||0,onChange:e=>a("attack",e),size:"medium"}),t.jsx(mb,{label:"Decay",value:e.decay||.3,onChange:e=>a("decay",e),size:"medium"}),t.jsx(mb,{label:"Sustain",value:e.sustain||.7,onChange:e=>a("sustain",e),size:"medium"}),t.jsx(mb,{label:"Release",value:e.release||.3,onChange:e=>a("release",e),size:"medium"}),t.jsx(mb,{label:"Volume",value:e.volume||.8,onChange:e=>a("volume",e),size:"medium"})]})]}),t.jsxs("div",{className:"mb-4",children:[t.jsx("div",{className:"text-xs font-bold text-blue-400 uppercase tracking-widest mb-3 pb-1 border-b border-gray-800",children:"Effects"}),t.jsxs("div",{className:"flex gap-5 justify-center",children:[t.jsx(mb,{label:"Chorus",value:e.chorus||.2,onChange:e=>a("chorus",e),size:"medium"}),t.jsx(mb,{label:"Reverb",value:e.reverb||.3,onChange:e=>a("reverb",e),size:"medium"}),t.jsx(mb,{label:"Delay",value:e.delay||0,onChange:e=>a("delay",e),size:"medium"})]})]}),t.jsxs("div",{className:"grid grid-cols-4 gap-2 mt-6 pt-4 border-t border-gray-800",children:[t.jsx(pb,{label:"PROGRAM"}),t.jsx(pb,{label:"EDIT"}),t.jsx(pb,{label:"SEQ"}),t.jsx(pb,{label:"SONG"}),t.jsx(pb,{label:"FX"}),t.jsx(pb,{label:"CART"}),t.jsx(pb,{label:"MIDI"}),t.jsx(pb,{label:"MASTER"})]}),t.jsx("div",{className:"grid grid-cols-8 gap-1 mt-3",children:Array.from({length:8},(e,t)=>t+1).map(e=>t.jsx(pb,{label:e.toString(),small:!0},e))})]}),t.jsx("div",{className:"px-4 py-1 bg-black border-t border-gray-800",children:t.jsx("div",{className:"text-[9px] text-gray-600 text-center uppercase tracking-widest",children:"Wavetable Synthesis • 21 Voices • 32 Oscillators • 1989"})})]})};function yb(e){return e in bb}const vb=({synthType:e,parameters:a,onParamChange:n})=>{const r=bb[e];return r?t.jsx(r,{parameters:a,onParamChange:n}):t.jsxs("div",{className:"p-8 text-center text-gray-500",children:[t.jsxs("p",{className:"text-lg mb-2",children:["Hardware UI not available for ",e]}),t.jsx("p",{className:"text-sm",children:"This synth uses the standard control interface."})]})};function wb(e){return["Sampler","Player","GranularSynth","DrumKit","ChiptuneModule"].includes(e)}function jb(e){return"TB303"===e||"Buzz3o3"===e?"tb303":function(e){return"Furnace"===e||e.startsWith("Furnace")}(e)?"furnace":function(e){return"Buzzmachine"===e||e.startsWith("Buzz")}(e)?"buzzmachine":wb(e)?"sample":function(e){return"DubSiren"===e}(e)?"dubsiren":function(e){return"SpaceLaser"===e}(e)?"spacelaser":function(e){return"V2"===e}(e)?"v2":"Sam"===e?"sam":function(e){return"Synare"===e}(e)?"synare":function(e){return e in Of}(e)?"mamechip":function(e){return["MAMEVFX","MAMEDOC"].includes(e)}(e)?"mame":function(e){return"Dexed"===e}(e)?"dexed":function(e){return"OBXd"===e}(e)?"obxd":"WAM"===e?"wam":"TonewheelOrgan"===e?"tonewheelOrgan":"Melodica"===e?"melodica":"Vital"===e?"vital":"Odin2"===e?"odin2":"Surge"===e?"surge":re.has(e)?"vstbridge":"generic"}const _b=({instrument:e,onChange:a})=>{const[n,r]=he.useState("oscilloscope"),[s,i]=he.useState(!1),[o,l]=he.useState("oscillator"),[c,u]=he.useState(!1),[m,x]=he.useState(()=>yb(e.synthType)?"hardware":"simple"),[g,b]=he.useState("custom"),{bakeInstrument:y,unbakeInstrument:v}=T(),{triggerPreview:w}=function(e,t){const a=he.useRef(!1),n=he.useRef(null),r=he.useCallback(()=>{if(ya.has(t.synthType))return;const r=d();null!==n.current&&(clearTimeout(n.current),n.current=null),a.current||(a.current=!0,r.triggerPolyNoteAttack(e,ba,.3,t)),n.current=setTimeout(()=>{if(a.current){a.current=!1;const t=T.getState().getInstrument(e);t&&r.triggerPolyNoteRelease(e,ba,t)}n.current=null},600)},[e,t.synthType]);return he.useEffect(()=>()=>{if(null!==n.current&&(clearTimeout(n.current),n.current=null),a.current){a.current=!1;try{const t=d(),a=T.getState().getInstrument(e);a&&t.triggerPolyNoteRelease(e,ba,a)}catch{}}},[e]),{triggerPreview:r}}(e.id,e),j=he.useCallback(e=>{a(e),w()},[a,w]),_=!!e.metadata?.preservedSynth,k=async()=>{u(!0);try{await y(e.id,"lite")}finally{u(!1)}},N=async()=>{u(!0);try{await y(e.id,"pro")}finally{u(!1)}},$=()=>{v(e.id)},C=jb(e.synthType);he.useEffect(()=>{"DrumMachine"===e.synthType?l("special"):wb(e.synthType)?l("envelope"):"special"!==o||wg(e,j)||l("oscillator")},[e.synthType]);const S="cyan-lineart"===B(e=>e.currentThemeId),z=()=>{const a=S?"#00ffff":"#00ff00",s=S?"bg-[#041010] border-b-2 border-cyan-500":"bg-gradient-to-r from-[#2a2a2a] to-[#1a1a1a] border-b-4 border-[#00ff00]";return t.jsx(xa,{instrument:e,onChange:j,vizMode:n,onVizModeChange:r,onBake:k,onBakePro:N,onUnbake:$,isBaked:_,isBaking:c,customHeader:t.jsx("div",{className:`synth-editor-header px-4 py-3 ${s}`,children:t.jsxs("div",{className:"flex items-center justify-between",children:[t.jsxs("div",{className:"flex items-center gap-3",children:[t.jsx("div",{className:"p-2 rounded-lg bg-gradient-to-br from-green-500 to-green-700 shadow-lg",children:t.jsx(Se,{size:24,className:"text-white"})}),t.jsxs("div",{children:[t.jsx("h2",{className:"text-xl font-black tracking-tight",style:{color:a},children:"SPACE LASER"}),t.jsx("p",{className:"text-[10px] uppercase tracking-widest "+(S?"text-cyan-600":"text-gray-400"),children:"Cosmic Zap Generator"})]})]}),t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsxs("button",{onClick:()=>j({isLive:!e.isLive}),className:"p-1.5 rounded transition-all flex items-center gap-1.5 px-2 "+(e.isLive?"bg-accent-success/20 text-accent-success ring-1 ring-accent-success/50 animate-pulse-glow":"bg-gray-800 text-text-muted hover:text-text-secondary border border-gray-700"),children:[t.jsx(je,{size:14}),t.jsx("span",{className:"text-[10px] font-bold uppercase",children:"LIVE"})]}),t.jsx(Qt,{synthType:e.synthType,onChange:j})]})]})})})},E=()=>{const a=S?"#00ffff":"#ffaa00",s=S?"bg-[#041010] border-b-2 border-cyan-500":"bg-gradient-to-r from-[#2a2a2a] to-[#1a1a1a] border-b-4 border-[#ffaa00]";return t.jsx(xa,{instrument:e,onChange:j,vizMode:n,onVizModeChange:r,onBake:k,onBakePro:N,onUnbake:$,isBaked:_,isBaking:c,customHeader:t.jsx("div",{className:`synth-editor-header px-4 py-3 ${s}`,children:t.jsxs("div",{className:"flex items-center justify-between",children:[t.jsxs("div",{className:"flex items-center gap-3",children:[t.jsx("div",{className:"p-2 rounded-lg bg-gradient-to-br from-amber-500 to-amber-700 shadow-lg",children:t.jsx(zt,{size:24,className:"text-white"})}),t.jsxs("div",{children:[t.jsx("h2",{className:"text-xl font-black tracking-tight",style:{color:a},children:"V2 SYNTH"}),t.jsx("p",{className:"text-[10px] uppercase tracking-widest "+(S?"text-cyan-600":"text-gray-400"),children:"Farbrausch 4k Intro Engine"})]})]}),t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsxs("button",{onClick:()=>{j({v2Speech:{...te}})},className:"p-1.5 rounded transition-all flex items-center gap-1.5 px-2 bg-gray-800 text-text-muted hover:text-amber-400 hover:bg-amber-500/10 border border-gray-700",title:"Switch to Speech Mode",children:[t.jsx($t,{size:14}),t.jsx("span",{className:"text-[10px] font-bold uppercase",children:"Speech"})]}),t.jsxs("button",{onClick:()=>j({isLive:!e.isLive}),className:"p-1.5 rounded transition-all flex items-center gap-1.5 px-2 "+(e.isLive?"bg-accent-success/20 text-accent-success ring-1 ring-accent-success/50 animate-pulse-glow":"bg-gray-800 text-text-muted hover:text-text-secondary border border-gray-700"),children:[t.jsx(je,{size:14}),t.jsx("span",{className:"text-[10px] font-bold uppercase",children:"LIVE"})]}),t.jsx(Qt,{synthType:e.synthType,onChange:j})]})]})})})},A=()=>{const a=S?"#00ffff":"#ff4444",s=S?"bg-[#041010] border-b-2 border-cyan-500":"bg-gradient-to-r from-[#2a2a2a] to-[#1a1a1a] border-b-4 border-[#ff4444]";return t.jsx(xa,{instrument:e,onChange:j,vizMode:n,onVizModeChange:r,onBake:k,onBakePro:N,onUnbake:$,isBaked:_,isBaking:c,customHeader:t.jsx("div",{className:`synth-editor-header px-4 py-3 ${s}`,children:t.jsxs("div",{className:"flex items-center justify-between",children:[t.jsxs("div",{className:"flex items-center gap-3",children:[t.jsx("div",{className:"p-2 rounded-lg bg-gradient-to-br from-red-500 to-red-700 shadow-lg",children:t.jsx(Mt,{size:24,className:"text-white"})}),t.jsxs("div",{children:[t.jsx("h2",{className:"text-xl font-black tracking-tight",style:{color:a},children:"DUB SIREN"}),t.jsx("p",{className:"text-[10px] uppercase tracking-widest "+(S?"text-cyan-600":"text-gray-400"),children:"Sound System Generator"})]})]}),t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsxs("button",{onClick:()=>j({isLive:!e.isLive}),className:"p-1.5 rounded transition-all flex items-center gap-1.5 px-2 "+(e.isLive?"bg-accent-success/20 text-accent-success ring-1 ring-accent-success/50 animate-pulse-glow":"bg-gray-800 text-text-muted hover:text-text-secondary border border-gray-700"),children:[t.jsx(je,{size:14}),t.jsx("span",{className:"text-[10px] font-bold uppercase",children:"LIVE"})]}),t.jsx(Qt,{synthType:e.synthType,onChange:j})]})]})})})},I=()=>{const a=S?"#00ffff":"#ffcc00",s=S?"bg-[#041010] border-b-2 border-cyan-500":"bg-gradient-to-r from-[#2a2a2a] to-[#1a1a1a] border-b-4 border-[#ffcc00]";return t.jsx(xa,{instrument:e,onChange:j,vizMode:n,onVizModeChange:r,onBake:k,onBakePro:N,onUnbake:$,isBaked:_,isBaking:c,customHeader:t.jsx("div",{className:`synth-editor-header px-4 py-3 ${s}`,children:t.jsxs("div",{className:"flex items-center justify-between",children:[t.jsxs("div",{className:"flex items-center gap-3",children:[t.jsx("div",{className:"p-2 rounded-lg bg-gradient-to-br from-yellow-500 to-orange-700 shadow-lg text-black",children:t.jsx(Ke,{size:24})}),t.jsxs("div",{children:[t.jsx("h2",{className:"text-xl font-black tracking-tight",style:{color:a},children:"SYNARE 3"}),t.jsx("p",{className:"text-[10px] uppercase tracking-widest "+(S?"text-cyan-600":"text-gray-400"),children:"Electronic Percussion"})]})]}),t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsxs("button",{onClick:()=>j({isLive:!e.isLive}),className:"p-1.5 rounded transition-all flex items-center gap-1.5 px-2 "+(e.isLive?"bg-accent-success/20 text-accent-success ring-1 ring-accent-success/50 animate-pulse-glow":"bg-gray-800 text-text-muted hover:text-text-secondary border border-gray-700"),children:[t.jsx(je,{size:14}),t.jsx("span",{className:"text-[10px] font-bold uppercase",children:"LIVE"})]}),t.jsx(Qt,{synthType:e.synthType,onChange:j})]})]})})})},O=he.useCallback(t=>{j({tb303:{...e.tb303,...t}})},[e.tb303,j]),R=he.useCallback(async t=>{if(t.tb303&&j({tb303:{...e.tb303,...t.tb303}}),void 0!==t.effects){const a=t.effects.map((e,t)=>({...e,id:e.id||`tb303-fx-${Date.now()}-${t}`}));j({effects:a});try{const t=d();await t.rebuildInstrumentEffects(e.id,a)}catch(tn){}}},[e.tb303,e.id,j]),V=he.useCallback(t=>{const a=e.dubSiren||f;j({dubSiren:{...a,...t}})},[e.dubSiren,j]),P=he.useCallback(t=>{const a=e.spaceLaser||h;j({spaceLaser:{...a,...t}})},[e.spaceLaser,j]),D=he.useCallback(t=>{const a=e.v2||X;j({v2:{...a,...t}})},[e.v2,j]),L=he.useCallback(t=>{const a=e.synare||p;j({synare:{...a,...t}})},[e.synare,j]),F=he.useCallback(t=>{const a=e.furnace||M;j({furnace:{...a,...t}})},[e.furnace,j]),W=he.useCallback(t=>{const a={...e.mame||("MAMEDOC"===e.synthType?Y:Z),...t};j({mame:a});try{d().updateMAMEParameters(e.id,a)}catch(tn){}},[e.mame,e.synthType,e.id,j]),U=he.useCallback((t,a)=>{const n={...e.parameters||{},[t]:a};j({parameters:n});try{d().updateMAMEChipParam(e.id,t,a)}catch(r){}},[e.parameters,e.id,j]),q=he.useCallback((t,a)=>{const n={...e.parameters||{},[t]:a};j({parameters:n});try{d().updateMAMEChipTextParam(e.id,t,a)}catch(r){}},[e.parameters,e.id,j]),H=he.useCallback(t=>{const a=e.parameters||{};j({parameters:{...a,_program:t}});try{d().loadMAMEChipPreset(e.id,t)}catch(n){}},[e.parameters,e.id,j]),G=he.useCallback((t,a)=>{try{d().loadSynthROM(e.id,e.synthType,t,a)}catch(n){}},[e.id,e.synthType]),K=he.useCallback(t=>{const a={...e.dexed||Q,...t};j({dexed:a});try{d().updateDexedParameters(e.id,a)}catch(tn){}},[e.dexed,e.id,j]),re=he.useCallback(t=>{const a={...e.obxd||J,...t};j({obxd:a});try{d().updateOBXdParameters(e.id,a)}catch(tn){}},[e.obxd,e.id,j]);if("tb303"===C&&e.tb303){const a=S?"bg-[#030808]":"bg-gradient-to-b from-[#1e1e1e] to-[#151515]";return t.jsx("div",{className:`synth-editor-container ${a}`,children:t.jsx("div",{className:"synth-editor-content p-4 flex items-center justify-center",children:t.jsx(ja,{config:e.tb303,onChange:O,onPresetLoad:R,showFilterCurve:!1,showHeader:!1,isJC303:!0,isBuzz3o3:"Buzz3o3"===e.synthType})})})}if("furnace"===C){const a=ee(M,e.furnace||{}),s="FurnaceGB"===e.synthType,i={FurnaceGB:["PU1","PU2","WAV","NOI"],FurnaceNES:["PU1","PU2","TRI","NOI","DPCM"],FurnacePSG:["SQ1","SQ2","SQ3","NOI"],FurnaceAY:["A","B","C"]};return t.jsxs("div",{className:"synth-editor-container bg-gradient-to-b from-[#1e1e1e] to-[#151515]",children:[t.jsx(xa,{instrument:e,onChange:j,vizMode:n,onVizModeChange:r,showHelpButton:!1}),s&&t.jsx("div",{className:"px-4 pt-3",children:t.jsx(lg,{channelNames:i[e.synthType]||[],height:160})}),t.jsx("div",{className:"synth-editor-content overflow-y-auto p-4",children:t.jsx(Ta,{config:a,instrumentId:e.id,onChange:F})})]})}if("buzzmachine"===C)return t.jsxs("div",{className:"synth-editor-container bg-gradient-to-b from-[#1e1e1e] to-[#151515]",children:[t.jsx(xa,{instrument:e,onChange:j,vizMode:n,onVizModeChange:r,showHelpButton:!1}),t.jsx("div",{className:"synth-editor-content overflow-y-auto p-4",children:t.jsx(Qa,{config:e,onChange:j})})]});if("sample"===C)return t.jsxs("div",{className:"synth-editor-container bg-gradient-to-b from-[#1e1e1e] to-[#151515]",children:[t.jsx(xa,{instrument:e,onChange:j,vizMode:n,onVizModeChange:r,hideVisualization:!0,showHelpButton:!1}),t.jsx("div",{className:"synth-editor-content overflow-y-auto p-4",children:t.jsx(jf,{instrument:e,onChange:j})})]});if("dubsiren"===C){const a=ee(f,e.dubSiren||{});return t.jsxs("div",{className:"synth-editor-container bg-gradient-to-b from-[#1e1e1e] to-[#151515]",children:[A(),t.jsx(_f,{config:a,instrumentId:e.id,onChange:V})]})}if("spacelaser"===C){const a=ee(h,e.spaceLaser||{});return t.jsxs("div",{className:"synth-editor-container bg-gradient-to-b from-[#1e1e1e] to-[#151515]",children:[z(),t.jsx(kf,{config:a,onChange:P})]})}if("v2"===C){if(e.v2Speech){const a=S?"#00ffff":"#ffaa00",s=S?"bg-[#041010] border-b-2 border-cyan-500":"bg-gradient-to-r from-[#2a2a2a] to-[#1a1a1a] border-b-4 border-[#ffaa00]",i=()=>{j({v2Speech:void 0})};return t.jsxs("div",{className:"synth-editor-container bg-gradient-to-b from-[#1e1e1e] to-[#151515]",children:[t.jsx(xa,{instrument:e,onChange:j,vizMode:n,onVizModeChange:r,onBake:k,onBakePro:N,onUnbake:$,isBaked:_,isBaking:c,customHeader:t.jsx("div",{className:`synth-editor-header px-4 py-3 ${s}`,children:t.jsxs("div",{className:"flex items-center justify-between",children:[t.jsxs("div",{className:"flex items-center gap-3",children:[t.jsx("div",{className:"p-2 rounded-lg bg-gradient-to-br from-amber-500 to-amber-700 shadow-lg",children:t.jsx($t,{size:24,className:"text-white"})}),t.jsxs("div",{children:[t.jsx("h2",{className:"text-xl font-black tracking-tight",style:{color:a},children:"V2 SPEECH"}),t.jsx("p",{className:"text-[10px] uppercase tracking-widest "+(S?"text-cyan-600":"text-gray-400"),children:"Lisa Engine / Ronan"})]})]}),t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsxs("button",{onClick:i,className:"p-1.5 rounded transition-all flex items-center gap-1.5 px-2 bg-gray-800 text-text-muted hover:text-amber-400 hover:bg-amber-500/10 border border-gray-700",title:"Switch to Synth Mode",children:[t.jsx(ve,{size:14}),t.jsx("span",{className:"text-[10px] font-bold uppercase",children:"Synth"})]}),t.jsxs("button",{onClick:()=>j({isLive:!e.isLive}),className:"p-1.5 rounded transition-all flex items-center gap-1.5 px-2 "+(e.isLive?"bg-accent-success/20 text-accent-success ring-1 ring-accent-success/50 animate-pulse-glow":"bg-gray-800 text-text-muted hover:text-text-secondary border border-gray-700"),children:[t.jsx(je,{size:14}),t.jsx("span",{className:"text-[10px] font-bold uppercase",children:"LIVE"})]}),t.jsx(Qt,{synthType:e.synthType,onChange:j})]})]})})}),t.jsx($f,{config:ee(te,e.v2Speech||{}),onChange:t=>j({v2Speech:{...e.v2Speech,...t}})})]})}return t.jsxs("div",{className:"synth-editor-container bg-gradient-to-b from-[#1e1e1e] to-[#151515]",children:[E(),t.jsx(Nf,{config:ee(X,e.v2||{}),onChange:D})]})}if("sam"===C){const a=S?"#00ffff":"#ffcc33",s=S?"bg-[#041010] border-b-2 border-cyan-500":"bg-gradient-to-r from-[#2a2a2a] to-[#1a1a1a] border-b-4 border-[#ffcc33]",i=ee(ae,e.sam||{});return t.jsxs("div",{className:"synth-editor-container bg-gradient-to-b from-[#1e1e1e] to-[#151515]",children:[t.jsx(xa,{instrument:e,onChange:j,vizMode:n,onVizModeChange:r,onBake:k,onBakePro:N,onUnbake:$,isBaked:_,isBaking:c,customHeader:t.jsx("div",{className:`synth-editor-header px-4 py-3 ${s}`,children:t.jsxs("div",{className:"flex items-center justify-between",children:[t.jsxs("div",{className:"flex items-center gap-3",children:[t.jsx("div",{className:"p-2 rounded-lg bg-gradient-to-br from-amber-500 to-amber-700 shadow-lg text-white",children:t.jsx(xt,{size:24})}),t.jsxs("div",{children:[t.jsx("h2",{className:"text-xl font-black tracking-tight",style:{color:a},children:"SAM"}),t.jsx("p",{className:"text-[10px] uppercase tracking-widest "+(S?"text-cyan-600":"text-gray-400"),children:"Software Automatic Mouth"})]})]}),t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsxs("button",{onClick:()=>j({isLive:!e.isLive}),className:"p-1.5 rounded transition-all flex items-center gap-1.5 px-2 "+(e.isLive?"bg-accent-success/20 text-accent-success ring-1 ring-accent-success/50 animate-pulse-glow":"bg-gray-800 text-text-muted hover:text-text-secondary border border-gray-700"),children:[t.jsx(je,{size:14}),t.jsx("span",{className:"text-[10px] font-bold uppercase",children:"LIVE"})]}),t.jsx(Qt,{synthType:e.synthType,onChange:j})]})]})})}),t.jsx(Cf,{config:i,onChange:t=>j({sam:{...e.sam,...t}})})]})}if("synare"===C){const a=ee(p,e.synare||{});return t.jsxs("div",{className:"synth-editor-container bg-gradient-to-b from-[#1e1e1e] to-[#151515]",children:[I(),t.jsx(Sf,{config:a,instrumentId:e.id,onChange:L})]})}if("mamechip"===C){const a=e.synthType.replace("MAME",""),s=ne(a),i=Rf(e.synthType),o=e.parameters?.macros||[],l=t=>{j({parameters:{...e.parameters,macros:t}})},d=e.parameters?.wavetables||[],c=t=>{j({parameters:{...e.parameters,wavetables:t}})},u=yb(e.synthType);return t.jsxs("div",{className:"synth-editor-container bg-gradient-to-b from-[#1e1e1e] to-[#151515]",children:[t.jsx(xa,{instrument:e,onChange:j,vizMode:n,onVizModeChange:r,showHelpButton:!1,customHeaderControls:u?t.jsxs("button",{onClick:()=>x("simple"===m?"hardware":"simple"),className:"p-1.5 rounded transition-all flex items-center gap-1.5 px-2 "+("hardware"===m?"bg-accent-primary/20 text-accent-primary ring-1 ring-accent-primary/50":"bg-gray-800 text-text-muted hover:text-text-secondary border border-gray-700"),title:"hardware"===m?"Switch to Simple Controls":"Switch to Hardware UI",children:["hardware"===m?t.jsx(Ue,{size:14}):t.jsx(Ct,{size:14}),t.jsx("span",{className:"text-[10px] font-bold uppercase",children:"hardware"===m?"Hardware UI":"Simple UI"})]}):void 0}),t.jsx("div",{className:"synth-editor-content overflow-y-auto p-4 space-y-4",children:"hardware"===m&&u?t.jsx(vb,{synthType:e.synthType,parameters:e.parameters||{},onParamChange:U}):t.jsxs(t.Fragment,{children:[t.jsx(dg,{instrumentId:e.id,height:100,color:i?.color}),t.jsx(Vf,{synthType:e.synthType,parameters:e.parameters||{},instrumentId:e.id,onParamChange:U,onTextChange:q,onLoadPreset:H,onRomUpload:G}),t.jsx(pg,{instrumentId:e.id,macros:o,onChange:l,chipCapabilities:{hasWavetable:s.hasWavetable,hasFM:s.hasFM,hasNoise:s.hasNoise,hasPanning:s.hasPanning}}),s.hasWavetable&&t.jsxs("div",{className:"rounded-lg overflow-hidden border border-dark-border",children:[t.jsx("div",{className:"px-3 py-2 bg-dark-surface border-b border-dark-border",children:t.jsx("span",{className:"text-xs font-semibold uppercase tracking-wider text-slate-300",children:"Wavetables"})}),t.jsx("div",{className:"p-2",children:t.jsx(Sa,{wavetables:d.length>0?d:[{id:0,data:new Array(32).fill(15),len:32,max:31}],onChange:c,maxWavetables:16})})]})]})})]})}if("mame"===C){const a="MAMEDOC"===e.synthType?Y:Z,s=ee(a,e.mame||{}),i=d().getMAMESynthHandle(e.id);return t.jsxs("div",{className:"synth-editor-container bg-gradient-to-b from-[#1e1e1e] to-[#151515]",children:[t.jsx(xa,{instrument:e,onChange:j,vizMode:n,onVizModeChange:r,showHelpButton:!1}),t.jsx("div",{className:"synth-editor-content overflow-y-auto p-4",children:t.jsx(If,{config:s,handle:i,onChange:W})})]})}if("dexed"===C){const a=ee(Q,e.dexed||{});return t.jsxs("div",{className:"synth-editor-container bg-gradient-to-b from-[#1e1e1e] to-[#151515]",children:[t.jsx(xa,{instrument:e,onChange:j,vizMode:n,onVizModeChange:r,showHelpButton:!1,onBake:k,onBakePro:N,onUnbake:$,isBaked:_,isBaking:c}),t.jsx("div",{className:"synth-editor-content overflow-y-auto",children:t.jsx(Lf,{config:a,onChange:K})})]})}if("obxd"===C){const a=ee(J,e.obxd||{});return t.jsxs("div",{className:"synth-editor-container bg-gradient-to-b from-[#1e1e1e] to-[#151515]",children:[t.jsx(xa,{instrument:e,onChange:j,vizMode:n,onVizModeChange:r,showHelpButton:!1,onBake:k,onBakePro:N,onUnbake:$,isBaked:_,isBaking:c}),t.jsx("div",{className:"synth-editor-content overflow-y-auto",children:t.jsx(Uf,{config:a,onChange:re})})]})}if("tonewheelOrgan"===C){const a=S?"#00ffff":"#d4a017",s=S?"bg-[#041010] border-b-2 border-cyan-500":"bg-gradient-to-r from-[#2a2a2a] to-[#1a1a1a] border-b-4 border-[#d4a017]";return t.jsxs("div",{className:"synth-editor-container bg-gradient-to-b from-[#1e1e1e] to-[#151515]",children:[t.jsx(xa,{instrument:e,onChange:j,vizMode:n,onVizModeChange:r,onBake:k,onBakePro:N,onUnbake:$,isBaked:_,isBaking:c,customHeader:t.jsx("div",{className:`synth-editor-header px-4 py-3 ${s}`,children:t.jsxs("div",{className:"flex items-center justify-between",children:[t.jsxs("div",{className:"flex items-center gap-3",children:[t.jsx("div",{className:"p-2 rounded-lg bg-gradient-to-br from-amber-600 to-amber-800 shadow-lg",children:t.jsx(ve,{size:24,className:"text-white"})}),t.jsxs("div",{children:[t.jsx("h2",{className:"text-xl font-black tracking-tight",style:{color:a},children:"TONEWHEEL ORGAN"}),t.jsx("p",{className:"text-[10px] uppercase tracking-widest "+(S?"text-cyan-600":"text-gray-400"),children:"Hammond-Style Drawbar Organ"})]})]}),t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsxs("button",{onClick:()=>b("custom"===g?"generic":"custom"),className:"p-1.5 rounded transition-all flex items-center gap-1.5 px-2 "+("custom"===g?"bg-amber-500/20 text-amber-400 ring-1 ring-amber-500/50":"bg-gray-800 text-text-muted hover:text-text-secondary border border-gray-700"),title:"custom"===g?"Switch to Generic Controls":"Switch to Custom Controls",children:["custom"===g?t.jsx(ve,{size:14}):t.jsx(St,{size:14}),t.jsx("span",{className:"text-[10px] font-bold uppercase",children:"custom"===g?"Custom":"Generic"})]}),t.jsxs("button",{onClick:()=>j({isLive:!e.isLive}),className:"p-1.5 rounded transition-all flex items-center gap-1.5 px-2 "+(e.isLive?"bg-accent-success/20 text-accent-success ring-1 ring-accent-success/50 animate-pulse-glow":"bg-gray-800 text-text-muted hover:text-text-secondary border border-gray-700"),children:[t.jsx(je,{size:14}),t.jsx("span",{className:"text-[10px] font-bold uppercase",children:"LIVE"})]}),t.jsx(Qt,{synthType:e.synthType,onChange:j})]})]})})}),t.jsx("div",{className:"synth-editor-content overflow-y-auto",children:"custom"===g?t.jsx(ox,{instrument:e,onChange:j}):t.jsx(Gf,{instrument:e,onChange:j})})]})}if("melodica"===C){const a=S?"#00ffff":"#2dd4bf",s=S?"bg-[#041010] border-b-2 border-cyan-500":"bg-gradient-to-r from-[#2a2a2a] to-[#1a1a1a] border-b-4 border-[#2dd4bf]";return t.jsxs("div",{className:"synth-editor-container bg-gradient-to-b from-[#1e1e1e] to-[#151515]",children:[t.jsx(xa,{instrument:e,onChange:j,vizMode:n,onVizModeChange:r,onBake:k,onBakePro:N,onUnbake:$,isBaked:_,isBaking:c,customHeader:t.jsx("div",{className:`synth-editor-header px-4 py-3 ${s}`,children:t.jsxs("div",{className:"flex items-center justify-between",children:[t.jsxs("div",{className:"flex items-center gap-3",children:[t.jsx("div",{className:"p-2 rounded-lg bg-gradient-to-br from-teal-500 to-teal-700 shadow-lg",children:t.jsx(ve,{size:24,className:"text-white"})}),t.jsxs("div",{children:[t.jsx("h2",{className:"text-xl font-black tracking-tight",style:{color:a},children:"MELODICA"}),t.jsx("p",{className:"text-[10px] uppercase tracking-widest "+(S?"text-cyan-600":"text-gray-400"),children:"Reed Instrument Physical Model"})]})]}),t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsxs("button",{onClick:()=>b("custom"===g?"generic":"custom"),className:"p-1.5 rounded transition-all flex items-center gap-1.5 px-2 "+("custom"===g?"bg-teal-500/20 text-teal-400 ring-1 ring-teal-500/50":"bg-gray-800 text-text-muted hover:text-text-secondary border border-gray-700"),title:"custom"===g?"Switch to Generic Controls":"Switch to Custom Controls",children:["custom"===g?t.jsx(ve,{size:14}):t.jsx(St,{size:14}),t.jsx("span",{className:"text-[10px] font-bold uppercase",children:"custom"===g?"Custom":"Generic"})]}),t.jsxs("button",{onClick:()=>j({isLive:!e.isLive}),className:"p-1.5 rounded transition-all flex items-center gap-1.5 px-2 "+(e.isLive?"bg-accent-success/20 text-accent-success ring-1 ring-accent-success/50 animate-pulse-glow":"bg-gray-800 text-text-muted hover:text-text-secondary border border-gray-700"),children:[t.jsx(je,{size:14}),t.jsx("span",{className:"text-[10px] font-bold uppercase",children:"LIVE"})]}),t.jsx(Qt,{synthType:e.synthType,onChange:j})]})]})})}),t.jsx("div",{className:"synth-editor-content overflow-y-auto",children:"custom"===g?t.jsx(vx,{instrument:e,onChange:j}):t.jsx(Gf,{instrument:e,onChange:j})})]})}if("vital"===C){const a=S?"#00ffff":"#b84eff",s=S?"bg-[#041010] border-b-2 border-cyan-500":"bg-gradient-to-r from-[#2a2a2a] to-[#1a1a1a] border-b-4 border-[#b84eff]";return t.jsxs("div",{className:"synth-editor-container bg-gradient-to-b from-[#1e1e1e] to-[#151515]",children:[t.jsx(xa,{instrument:e,onChange:j,vizMode:n,onVizModeChange:r,onBake:k,onBakePro:N,onUnbake:$,isBaked:_,isBaking:c,customHeader:t.jsx("div",{className:`synth-editor-header px-4 py-3 ${s}`,children:t.jsxs("div",{className:"flex items-center justify-between",children:[t.jsxs("div",{className:"flex items-center gap-3",children:[t.jsx("div",{className:"p-2 rounded-lg bg-gradient-to-br from-purple-500 to-purple-700 shadow-lg",children:t.jsx(ve,{size:24,className:"text-white"})}),t.jsxs("div",{children:[t.jsx("h2",{className:"text-xl font-black tracking-tight",style:{color:a},children:"VITAL"}),t.jsx("p",{className:"text-[10px] uppercase tracking-widest "+(S?"text-cyan-600":"text-gray-400"),children:"Spectral Wavetable Synth"})]})]}),t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsxs("button",{onClick:()=>b("custom"===g?"generic":"custom"),className:"p-1.5 rounded transition-all flex items-center gap-1.5 px-2 "+("custom"===g?"bg-purple-500/20 text-purple-400 ring-1 ring-purple-500/50":"bg-gray-800 text-text-muted hover:text-text-secondary border border-gray-700"),title:"custom"===g?"Switch to Generic Controls":"Switch to Custom Controls",children:["custom"===g?t.jsx(ve,{size:14}):t.jsx(St,{size:14}),t.jsx("span",{className:"text-[10px] font-bold uppercase",children:"custom"===g?"Custom":"Generic"})]}),t.jsxs("button",{onClick:()=>j({isLive:!e.isLive}),className:"p-1.5 rounded transition-all flex items-center gap-1.5 px-2 "+(e.isLive?"bg-accent-success/20 text-accent-success ring-1 ring-accent-success/50 animate-pulse-glow":"bg-gray-800 text-text-muted hover:text-text-secondary border border-gray-700"),children:[t.jsx(je,{size:14}),t.jsx("span",{className:"text-[10px] font-bold uppercase",children:"LIVE"})]}),t.jsx(Qt,{synthType:e.synthType,onChange:j})]})]})})}),t.jsx("div",{className:"synth-editor-content overflow-y-auto",children:"custom"===g?t.jsx(kx,{instrument:e,onChange:j}):t.jsx(Gf,{instrument:e,onChange:j})})]})}if("odin2"===C){const a=S?"#00ffff":"#4a9eff",s=S?"bg-[#041010] border-b-2 border-cyan-500":"bg-gradient-to-r from-[#2a2a2a] to-[#1a1a1a] border-b-4 border-[#4a9eff]";return t.jsxs("div",{className:"synth-editor-container bg-gradient-to-b from-[#1e1e1e] to-[#151515]",children:[t.jsx(xa,{instrument:e,onChange:j,vizMode:n,onVizModeChange:r,onBake:k,onBakePro:N,onUnbake:$,isBaked:_,isBaking:c,customHeader:t.jsx("div",{className:`synth-editor-header px-4 py-3 ${s}`,children:t.jsxs("div",{className:"flex items-center justify-between",children:[t.jsxs("div",{className:"flex items-center gap-3",children:[t.jsx("div",{className:"p-2 rounded-lg bg-gradient-to-br from-blue-500 to-blue-700 shadow-lg",children:t.jsx(ve,{size:24,className:"text-white"})}),t.jsxs("div",{children:[t.jsx("h2",{className:"text-xl font-black tracking-tight",style:{color:a},children:"ODIN2"}),t.jsx("p",{className:"text-[10px] uppercase tracking-widest "+(S?"text-cyan-600":"text-gray-400"),children:"Semi-Modular Hybrid Synth"})]})]}),t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsxs("button",{onClick:()=>b("custom"===g?"generic":"custom"),className:"p-1.5 rounded transition-all flex items-center gap-1.5 px-2 "+("custom"===g?"bg-blue-500/20 text-blue-400 ring-1 ring-blue-500/50":"bg-gray-800 text-text-muted hover:text-text-secondary border border-gray-700"),title:"custom"===g?"Switch to Generic Controls":"Switch to Custom Controls",children:["custom"===g?t.jsx(ve,{size:14}):t.jsx(St,{size:14}),t.jsx("span",{className:"text-[10px] font-bold uppercase",children:"custom"===g?"Custom":"Generic"})]}),t.jsxs("button",{onClick:()=>j({isLive:!e.isLive}),className:"p-1.5 rounded transition-all flex items-center gap-1.5 px-2 "+(e.isLive?"bg-accent-success/20 text-accent-success ring-1 ring-accent-success/50 animate-pulse-glow":"bg-gray-800 text-text-muted hover:text-text-secondary border border-gray-700"),children:[t.jsx(je,{size:14}),t.jsx("span",{className:"text-[10px] font-bold uppercase",children:"LIVE"})]}),t.jsx(Qt,{synthType:e.synthType,onChange:j})]})]})})}),t.jsx("div",{className:"synth-editor-content overflow-y-auto",children:"custom"===g?t.jsx(eg,{instrument:e,onChange:j}):t.jsx(Gf,{instrument:e,onChange:j})})]})}if("surge"===C){const a=S?"#00ffff":"#ff8c00",s=S?"bg-[#041010] border-b-2 border-cyan-500":"bg-gradient-to-r from-[#2a2a2a] to-[#1a1a1a] border-b-4 border-[#ff8c00]";return t.jsxs("div",{className:"synth-editor-container bg-gradient-to-b from-[#1e1e1e] to-[#151515]",children:[t.jsx(xa,{instrument:e,onChange:j,vizMode:n,onVizModeChange:r,onBake:k,onBakePro:N,onUnbake:$,isBaked:_,isBaking:c,customHeader:t.jsx("div",{className:`synth-editor-header px-4 py-3 ${s}`,children:t.jsxs("div",{className:"flex items-center justify-between",children:[t.jsxs("div",{className:"flex items-center gap-3",children:[t.jsx("div",{className:"p-2 rounded-lg bg-gradient-to-br from-orange-500 to-orange-700 shadow-lg",children:t.jsx(ve,{size:24,className:"text-white"})}),t.jsxs("div",{children:[t.jsx("h2",{className:"text-xl font-black tracking-tight",style:{color:a},children:"SURGE XT"}),t.jsx("p",{className:"text-[10px] uppercase tracking-widest "+(S?"text-cyan-600":"text-gray-400"),children:"Hybrid Synthesizer"})]})]}),t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsxs("button",{onClick:()=>b("custom"===g?"generic":"custom"),className:"p-1.5 rounded transition-all flex items-center gap-1.5 px-2 "+("custom"===g?"bg-orange-500/20 text-orange-400 ring-1 ring-orange-500/50":"bg-gray-800 text-text-muted hover:text-text-secondary border border-gray-700"),title:"custom"===g?"Switch to Generic Controls":"Switch to Custom Controls",children:["custom"===g?t.jsx(ve,{size:14}):t.jsx(St,{size:14}),t.jsx("span",{className:"text-[10px] font-bold uppercase",children:"custom"===g?"Custom":"Generic"})]}),t.jsxs("button",{onClick:()=>j({isLive:!e.isLive}),className:"p-1.5 rounded transition-all flex items-center gap-1.5 px-2 "+(e.isLive?"bg-accent-success/20 text-accent-success ring-1 ring-accent-success/50 animate-pulse-glow":"bg-gray-800 text-text-muted hover:text-text-secondary border border-gray-700"),children:[t.jsx(je,{size:14}),t.jsx("span",{className:"text-[10px] font-bold uppercase",children:"LIVE"})]}),t.jsx(Qt,{synthType:e.synthType,onChange:j})]})]})})}),t.jsx("div",{className:"synth-editor-content overflow-y-auto",children:"custom"===g?t.jsx(ag,{instrument:e,onChange:j}):t.jsx(Gf,{instrument:e,onChange:j})})]})}if("vstbridge"===C)return t.jsxs("div",{className:"synth-editor-container bg-gradient-to-b from-[#1e1e1e] to-[#151515]",children:[t.jsx(xa,{instrument:e,onChange:j,vizMode:n,onVizModeChange:r,showHelpButton:!1,onBake:k,onBakePro:N,onUnbake:$,isBaked:_,isBaking:c}),t.jsx("div",{className:"synth-editor-content overflow-y-auto",children:t.jsx(Gf,{instrument:e,onChange:j})})]});if("wam"===C)return t.jsxs("div",{className:"synth-editor-container bg-gradient-to-b from-[#1e1e1e] to-[#151515]",children:[t.jsx(xa,{instrument:e,onChange:j,vizMode:n,onVizModeChange:r,showHelpButton:!1}),t.jsx("div",{className:"synth-editor-content overflow-hidden",children:t.jsx(qf,{instrument:e,onChange:j})})]});const se=yb(e.synthType);return t.jsxs("div",{className:"synth-editor-container bg-gradient-to-b from-[#1e1e1e] to-[#151515]",children:[t.jsx(xa,{instrument:e,onChange:j,vizMode:n,onVizModeChange:r,showHelpButton:!se,showHelp:s,onHelpToggle:()=>i(!s),onBake:k,onBakePro:N,onUnbake:$,isBaked:_,isBaking:c,customHeaderControls:se?t.jsxs("button",{onClick:()=>x("simple"===m?"hardware":"simple"),className:"p-1.5 rounded transition-all flex items-center gap-1.5 px-2 "+("hardware"===m?"bg-accent-primary/20 text-accent-primary ring-1 ring-accent-primary/50":"bg-gray-800 text-text-muted hover:text-text-secondary border border-gray-700"),title:"hardware"===m?"Switch to Simple Controls":"Switch to Hardware UI",children:["hardware"===m?t.jsx(Ue,{size:14}):t.jsx(Ct,{size:14}),t.jsx("span",{className:"text-[10px] font-bold uppercase",children:"hardware"===m?"Hardware UI":"Simple UI"})]}):void 0}),"hardware"===m&&se?t.jsx("div",{className:"synth-editor-content overflow-y-auto p-4 space-y-4",children:t.jsx(vb,{synthType:e.synthType,parameters:e.parameters||{},onParamChange:(t,a)=>{j({parameters:{...e.parameters,[t]:a}})}})}):t.jsxs(t.Fragment,{children:[t.jsx(wa,{activeTab:o,onTabChange:l,hiddenTabs:(()=>{const t=[];"DrumMachine"===e.synthType?(t.push("oscillator"),t.push("envelope"),t.push("filter"),t.push("modulation")):(wb(e.synthType)&&t.push("oscillator"),e.oscillator||wb(e.synthType)||t.push("oscillator"));return null!==wg(e,j)||t.push("special"),t})()}),t.jsx("div",{className:"synth-editor-content",children:t.jsx(kb,{instrument:e,onChange:j,activeTab:o})})]})]})},kb=({instrument:e,onChange:t,activeTab:a})=>vg(e,t,a),Nb=["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"],$b={z:"C",s:"C#",x:"D",d:"D#",c:"E",v:"F",g:"F#",b:"G",h:"G#",n:"A",j:"A#",m:"B",q:"C+",2:"C#+",w:"D+",3:"D#+",e:"E+",r:"F+",5:"F#+",t:"G+",6:"G#+",y:"A+",7:"A#+",u:"B+",i:"C++"};function Cb(e,t){const a=[],n=e<=3?3-e:0;for(let s=0;s<t;s++){const t=e+s;for(const e of Nb){const r=e.includes("#"),i=`${e}${t}`;let o;const l=s-n;if(0===l){const t=Object.entries($b).find(([t,a])=>a===e);t&&(o=t[0])}else if(1===l){const t=Object.entries($b).find(([t,a])=>a===e+"+");t&&(o=t[0])}else 2===l&&"C"===e&&(o="i");a.push({note:i,label:e.replace("#",""),isBlack:r,keyboardKey:o,octave:t})}}const r=e+t;return a.push({note:`C${r}`,label:"C",isBlack:!1,keyboardKey:t<=2?"i":void 0,octave:r}),a}const Sb=new Set(Object.keys($b)),Mb=({instrument:e})=>{const[a,n]=he.useState(new Set),[r,s]=he.useState(400),i=he.useRef(null),o=he.useRef(m.getInstance()),l=he.useRef(new Set),d=he.useRef(!1);he.useEffect(()=>{l.current=a},[a]),he.useEffect(()=>{const e=i.current;if(!e)return;const t=new ResizeObserver(e=>{for(const t of e){const e=t.contentRect.width-24;e>0&&s(e)}});return t.observe(e),()=>t.disconnect()},[]);const{whiteKeyWidth:c,keys:u}=he.useMemo(()=>{const e=r-8;let t=6,a=40;for(;t>=2;){if(a=e/(7*t+1),a>=24){a=Math.min(a,40);break}t--}t=Math.max(2,t);const n=7*t+1;a=Math.min(e/n,40);return{numOctaves:t,whiteKeyWidth:a,keys:Cb(Math.max(1,4-Math.floor(t/2)),t)}},[r]);he.useEffect(()=>{d.current||o.current.init().then(()=>{d.current=!0})},[]);const p=he.useCallback(t=>{if(l.current.has(t))return;const a=o.current,r=e,{midiPolyphonic:s}=se.getState();if(s)a.triggerPolyNoteAttack(r.id,t,.8,r);else{for(const e of l.current)a.triggerPolyNoteRelease(r.id,e,r);a.triggerPolyNoteAttack(r.id,t,.8,r)}n(e=>s?new Set(e).add(t):new Set([t]))},[e]),h=he.useCallback(t=>{const a=o.current,r=e;a.triggerPolyNoteRelease(r.id,t,r),n(e=>{const a=new Set(e);return a.delete(t),a})},[e]);he.useEffect(()=>{const e=e=>{if(e.target instanceof HTMLInputElement||e.target instanceof HTMLTextAreaElement)return;if(e.repeat)return;const t=e.key.toLowerCase();if(Sb.has(t)){e.preventDefault(),e.stopPropagation();const a=u.find(e=>e.keyboardKey===t);a&&p(a.note)}},t=e=>{const t=e.key.toLowerCase();if(Sb.has(t)){e.preventDefault(),e.stopPropagation();const a=u.find(e=>e.keyboardKey===t);a&&h(a.note)}};return window.addEventListener("keydown",e,!0),window.addEventListener("keyup",t,!0),()=>{window.removeEventListener("keydown",e,!0),window.removeEventListener("keyup",t,!0)}},[p,h,u]);const f=u.filter(e=>!e.isBlack),x=u.filter(e=>e.isBlack),g=.6*c,b=96*.6;return t.jsx("div",{ref:i,className:"space-y-3 w-full",children:t.jsxs("div",{className:"space-y-3 pt-2",children:[t.jsx("div",{className:"bg-ft2-header rounded border-2 border-ft2-border p-3",children:t.jsx("div",{className:"relative flex items-end justify-center",style:{height:96},children:t.jsxs("div",{className:"relative flex",children:[f.map((e,n)=>{const r=a.has(e.note),s="C"===e.label;return t.jsx("button",{onMouseDown:t=>{t.preventDefault(),p(e.note)},onMouseUp:t=>{t.preventDefault(),h(e.note)},onMouseLeave:()=>{a.has(e.note)&&h(e.note)},onTouchStart:t=>{t.preventDefault(),p(e.note)},onTouchEnd:t=>{t.preventDefault(),h(e.note)},className:`\n                    relative border border-ft2-border rounded-b\n                    transition-colors duration-75 cursor-pointer select-none touch-none\n                    ${r?"bg-cyan-400 shadow-lg shadow-cyan-400/50":"bg-white hover:bg-gray-100"}\n                    ${s&&n>0?"border-l-2 border-l-gray-300":""}\n                  `,style:{width:c,height:96,marginRight:n<f.length-1?1:0},children:t.jsxs("div",{className:"absolute bottom-1 left-0 right-0 text-center",children:[s&&t.jsx("div",{className:"text-[8px] text-gray-400 font-mono",children:e.octave}),t.jsx("div",{className:"font-bold text-gray-700",style:{fontSize:c<30?"8px":"10px"},children:e.label}),e.keyboardKey&&t.jsx("div",{className:"text-[8px] text-gray-400 font-mono uppercase",children:e.keyboardKey})]})},e.note)}),x.map(e=>{const n=a.has(e.note),r=(e=>{const t=u.findIndex(t=>t.note===e.note);return u.slice(0,t).filter(e=>!e.isBlack).length*c-.3*c/2})(e);return t.jsx("button",{onMouseDown:t=>{t.preventDefault(),p(e.note)},onMouseUp:t=>{t.preventDefault(),h(e.note)},onMouseLeave:()=>{a.has(e.note)&&h(e.note)},onTouchStart:t=>{t.preventDefault(),p(e.note)},onTouchEnd:t=>{t.preventDefault(),h(e.note)},className:`\n                    absolute border border-ft2-border rounded-b\n                    transition-colors duration-75 cursor-pointer select-none touch-none z-10\n                    ${n?"bg-amber-500 shadow-lg shadow-amber-500/50":"bg-gray-900 hover:bg-gray-700"}\n                  `,style:{left:r,width:g,height:b},children:e.keyboardKey&&t.jsx("div",{className:"absolute bottom-1 left-0 right-0 text-center text-gray-400 font-mono uppercase",style:{fontSize:"7px"},children:e.keyboardKey})},e.note)})]})})}),t.jsxs("div",{className:"flex items-center gap-3 bg-ft2-header rounded border border-ft2-border p-2",children:[t.jsx("span",{className:"text-xs font-bold text-ft2-highlight",children:"VELOCITY:"}),t.jsx("input",{type:"range",min:"0",max:"100",defaultValue:"80",className:"flex-1 h-1 bg-ft2-bg rounded-lg appearance-none cursor-pointer accent-ft2-cursor"}),t.jsx("span",{className:"text-xs font-mono text-ft2-text",children:"80%"})]})]})})},zb="devilbox-synth-selector-category",Tb="devilbox-synth-selector-search",Eb="devilbox-synth-selector-scroll",Ab=({onSelect:e,compact:a=!1})=>{const n=T(e=>e.currentInstrumentId),r=T(e=>e.instruments),s=T(e=>e.updateInstrument),i=r.find(e=>e.id===n)||null,[o,d]=he.useState(null),[c,p]=he.useState(null),[h,f]=he.useState(()=>{try{return localStorage.getItem(Tb)||""}catch{return""}}),[z,E]=he.useState(()=>{try{return localStorage.getItem(zb)||null}catch{return null}}),A=he.useRef(null),I=he.useRef(!1);he.useEffect(()=>{try{z?localStorage.setItem(zb,z):localStorage.removeItem(zb)}catch{}},[z]),he.useEffect(()=>{try{h?localStorage.setItem(Tb,h):localStorage.removeItem(Tb)}catch{}},[h]);const O=he.useCallback(()=>{if(I.current)return;const e=A.current;if(e)try{localStorage.setItem(Eb,String(e.scrollTop))}catch{}},[]);he.useEffect(()=>{const e=A.current;e&&requestAnimationFrame(()=>{if(I.current=!0,i?.synthType){const t=e.querySelector(`[data-synth-type="${i.synthType}"]`);if(t)return t.scrollIntoView({block:"center",behavior:"instant"}),void setTimeout(()=>{I.current=!1},100)}try{const t=localStorage.getItem(Eb);t&&(e.scrollTop=parseInt(t,10)||0)}catch{}setTimeout(()=>{I.current=!1},100)})},[]);const R=he.useMemo(()=>{const e=h.toLowerCase().trim();return u.filter(e=>!z||e.id===z).map(t=>({...t,synths:t.synths.filter(t=>!(!t||!t.icon)&&(!e||(t.name.toLowerCase().includes(e)||t.shortName.toLowerCase().includes(e)||t.description.toLowerCase().includes(e)||t.bestFor.some(t=>t.toLowerCase().includes(e)))))})).filter(e=>e.synths.length>0)},[h,z]),V=he.useMemo(()=>R.reduce((e,t)=>e+t.synths.length,0),[R]),P=e=>{if(!e)return Te;try{return ze[e]||Te}catch(t){return Te}},D=t=>{if(!i)return;m.getInstance().invalidateInstrument(i.id);const a={synthType:t,tb303:void 0,drumMachine:void 0,chipSynth:void 0,pwmSynth:void 0,wavetable:void 0,granular:void 0,superSaw:void 0,polySynth:void 0,organ:void 0,stringMachine:void 0,formantSynth:void 0,furnace:void 0,chiptuneModule:void 0,wobbleBass:void 0,drumKit:void 0};switch(t){case"TB303":a.tb303={...S};break;case"DrumMachine":a.drumMachine={...C};break;case"ChipSynth":a.chipSynth={...$};break;case"PWMSynth":a.pwmSynth={...N};break;case"Wavetable":a.wavetable={...k};break;case"GranularSynth":a.granular={..._};break;case"SuperSaw":a.superSaw={...j};break;case"PolySynth":a.polySynth={...w};break;case"Organ":a.organ={...v};break;case"StringMachine":a.stringMachine={...y};break;case"FormantSynth":a.formantSynth={...b};break;case"Furnace":a.furnace={...M};break;case"ChiptuneModule":a.chiptuneModule={...ie};break;case"WobbleBass":a.wobbleBass={...g};break;case"DrumKit":a.drumKit={...x}}s(i.id,a),e?.(t)};if(a){const e=R.flatMap(e=>e.synths),a=Array.from(new Map(e.map(e=>[e.type,e])).values());return t.jsxs("div",{className:"space-y-3",children:[t.jsxs("div",{className:"relative",children:[t.jsx(Tt,{size:14,className:"absolute left-2.5 top-1/2 -translate-y-1/2 text-text-muted"}),t.jsx("input",{type:"text",placeholder:"Search synths...",value:h,onChange:e=>f(e.target.value),className:"w-full pl-8 pr-8 py-1.5 text-sm bg-dark-bgSecondary border border-dark-border rounded-lg text-text-primary placeholder:text-text-muted focus:outline-none focus:border-accent-primary"}),h&&t.jsx("button",{onClick:()=>f(""),className:"absolute right-2 top-1/2 -translate-y-1/2 text-text-muted hover:text-text-primary",children:t.jsx(be,{size:14})})]}),t.jsx("div",{className:"grid grid-cols-3 gap-2",children:a.map(e=>{const a=i?.synthType===e.type,n=P(e.icon);return t.jsxs("button",{"data-synth-type":e.type,onClick:()=>D(e.type),className:`\n                  flex items-center gap-2 p-2 rounded-lg border text-left transition-all\n                  ${a?"bg-accent-primary/15 border-accent-primary":"bg-dark-bgSecondary border-dark-border hover:border-text-muted"}\n                `,children:[t.jsx(n,{size:14,className:e.color}),t.jsx("span",{className:"text-sm truncate "+(a?"text-accent-primary":"text-text-secondary"),children:e.shortName})]},e.type)})}),0===a.length&&t.jsxs("div",{className:"text-center py-4 text-text-muted text-sm",children:['No synths found for "',h,'"']})]})}return t.jsxs("div",{ref:A,onScroll:O,className:"space-y-4 max-h-full overflow-y-auto",children:[t.jsxs("div",{className:"space-y-3 sticky top-0 bg-dark-bg pb-3 z-10",children:[t.jsxs("div",{className:"relative",children:[t.jsx(Tt,{size:16,className:"absolute left-3 top-1/2 -translate-y-1/2 text-text-muted"}),t.jsx("input",{type:"text",placeholder:"Search synths by name, description, or use case...",value:h,onChange:e=>f(e.target.value),className:"w-full pl-10 pr-10 py-2 text-sm bg-dark-bgSecondary border border-dark-border rounded-lg text-text-primary placeholder:text-text-muted focus:outline-none focus:border-accent-primary"}),h&&t.jsx("button",{onClick:()=>f(""),className:"absolute right-3 top-1/2 -translate-y-1/2 text-text-muted hover:text-text-primary",children:t.jsx(be,{size:16})})]}),t.jsxs("div",{className:"flex flex-wrap gap-1.5",children:[t.jsxs("button",{onClick:()=>E(null),className:"px-3 py-1 text-xs rounded-full border transition-all "+(null===z?"bg-accent-primary text-dark-bg border-accent-primary":"bg-dark-bgSecondary text-text-secondary border-dark-border hover:border-text-muted"),children:["All (",u.reduce((e,t)=>e+t.synths.filter(e=>e?.icon).length,0),")"]}),u.map(e=>{const a=e.synths.filter(e=>e?.icon).length;return t.jsxs("button",{onClick:()=>E(z===e.id?null:e.id),className:"px-3 py-1 text-xs rounded-full border transition-all "+(z===e.id?"bg-accent-primary text-dark-bg border-accent-primary":"bg-dark-bgSecondary text-text-secondary border-dark-border hover:border-text-muted"),children:[e.name," (",a,")"]},e.id)})]}),(h||z)&&t.jsxs("div",{className:"text-xs text-text-muted",children:["Showing ",V," synth",1!==V?"s":"",h&&` matching "${h}"`,z&&` in ${u.find(e=>e.id===z)?.name}`]})]}),R.map(e=>t.jsxs("div",{children:[t.jsxs("button",{onClick:()=>d(o===e.id?null:e.id),className:"w-full flex items-center justify-between mb-3 group",children:[t.jsxs("div",{children:[t.jsx("h3",{className:"text-sm font-semibold text-text-primary",children:e.name}),t.jsx("p",{className:"text-xs text-text-muted",children:e.description})]}),t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx("span",{className:"text-xs text-text-muted",children:e.synths.length}),t.jsx(He,{size:16,className:`\n                  text-text-muted transition-transform\n                  ${o===e.id?"rotate-90":""}\n                `})]})]}),(o===e.id||null===o)&&t.jsx("div",{className:"grid grid-cols-2 gap-3",children:e.synths.map(e=>((e,n)=>{if(!e||!e.icon)return null;const r=P(e.icon);return t.jsxs("div",{"data-synth-type":e.type,onClick:()=>D(e.type),onMouseEnter:()=>p(e.type),onMouseLeave:()=>p(null),className:`\n          relative p-4 rounded-lg border cursor-pointer transition-all\n          ${n?"bg-accent-primary/15 border-accent-primary":"bg-dark-bgSecondary border-dark-border hover:border-text-muted hover:bg-dark-bgHover"}\n        `,children:[n&&t.jsx("div",{className:"absolute top-2 right-2 w-5 h-5 rounded-full bg-accent-primary flex items-center justify-center",children:t.jsx(Et,{size:12,className:"text-dark-bg"})}),t.jsxs("div",{className:"flex items-center gap-3 mb-2",children:[t.jsx("div",{className:`p-2 rounded-md bg-dark-bgTertiary ${e.color}`,children:t.jsx(r,{size:18})}),t.jsxs("div",{children:[t.jsx("h4",{className:"font-medium text-text-primary",children:e.name}),t.jsx("p",{className:"text-xs text-text-muted",children:e.shortName})]})]}),!a&&t.jsxs(t.Fragment,{children:[t.jsx("p",{className:"text-sm text-text-secondary mb-2",children:e.description}),t.jsx("div",{className:"flex flex-wrap gap-1",children:e.bestFor.slice(0,3).map(e=>t.jsx("span",{className:"px-2 py-0.5 text-[10px] rounded-full bg-dark-bgTertiary text-text-muted",children:e},e))})]})]},e.type)})(e,i?.synthType===e.type))})]},e.id)),0===R.length&&t.jsxs("div",{className:"text-center py-8 text-text-muted",children:[t.jsx("p",{className:"text-sm",children:"No synths found"}),t.jsx("p",{className:"text-xs mt-1",children:"Try a different search term or category"}),t.jsx("button",{onClick:()=>{f(""),E(null)},className:"mt-3 px-4 py-1.5 text-xs bg-dark-bgSecondary border border-dark-border rounded-lg hover:border-text-muted",children:"Clear filters"})]}),c&&t.jsx("div",{className:"fixed bottom-4 left-1/2 -translate-x-1/2 bg-dark-bgTertiary border border-dark-border rounded-lg p-3 shadow-xl z-50 max-w-sm",children:(()=>{const e=l(c);if(!e||!e.icon)return null;const a=P(e.icon);return t.jsxs("div",{className:"flex gap-3",children:[t.jsx("div",{className:`p-2 rounded-md bg-dark-bg ${e.color}`,children:t.jsx(a,{size:20})}),t.jsxs("div",{children:[t.jsx("h4",{className:"font-medium text-text-primary",children:e.name}),t.jsx("p",{className:"text-xs text-text-secondary",children:e.description}),t.jsxs("p",{className:"text-[10px] text-text-muted mt-1",children:["Best for: ",e.bestFor.join(", ")]})]})]})})()})]})},Ib=["Distortion","Reverb","Delay","Chorus","Phaser","Tremolo","Vibrato","AutoFilter","AutoPanner","AutoWah","BitCrusher","Chebyshev","FeedbackDelay","FrequencyShifter","PingPongDelay","PitchShift","Compressor","EQ3","Filter","JCReverb","StereoWidener","SpaceEcho","BiPhase","DubFilter","MoogFilter","SpaceyDelayer","RETapeEcho","MVerb","Leslie","SpringReverb"];function Ob({effect:e,onToggle:a,onRemove:n,onEdit:r,onWetChange:s}){const{attributes:i,listeners:o,setNodeRef:l,transform:d,transition:c,isDragging:u}=Gt({id:e.id}),m={transform:Kt.Transform.toString(d),transition:c,opacity:u?.5:1};return t.jsxs("div",{ref:l,style:m,className:`\n        bg-ft2-header border border-ft2-border p-3 mb-2\n        ${u?"shadow-lg":""}\n      `,children:[t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx("button",{...i,...o,className:"text-ft2-textDim hover:text-ft2-highlight cursor-grab active:cursor-grabbing",title:"Drag to reorder",children:t.jsxs("svg",{width:"16",height:"16",viewBox:"0 0 16 16",fill:"currentColor",children:[t.jsx("circle",{cx:"6",cy:"4",r:"1.5"}),t.jsx("circle",{cx:"10",cy:"4",r:"1.5"}),t.jsx("circle",{cx:"6",cy:"8",r:"1.5"}),t.jsx("circle",{cx:"10",cy:"8",r:"1.5"}),t.jsx("circle",{cx:"6",cy:"12",r:"1.5"}),t.jsx("circle",{cx:"10",cy:"12",r:"1.5"})]})}),t.jsx("div",{className:"flex-1 font-mono text-sm font-bold text-ft2-text",children:e.type}),t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx("span",{className:"text-xs text-ft2-textDim",children:"WET"}),t.jsx("input",{type:"range",min:"0",max:"100",value:e.wet,onChange:e=>s(Number(e.target.value)),className:"w-20 h-1 bg-ft2-bg rounded-lg appearance-none cursor-pointer\n                     [&::-webkit-slider-thumb]:appearance-none [&::-webkit-slider-thumb]:w-3 [&::-webkit-slider-thumb]:h-3\n                     [&::-webkit-slider-thumb]:rounded-full [&::-webkit-slider-thumb]:bg-ft2-highlight\n                     [&::-moz-range-thumb]:w-3 [&::-moz-range-thumb]:h-3\n                     [&::-moz-range-thumb]:rounded-full [&::-moz-range-thumb]:bg-ft2-highlight [&::-moz-range-thumb]:border-0"}),t.jsxs("span",{className:"text-xs text-ft2-highlight font-mono w-8 text-right",children:[e.wet,"%"]})]}),t.jsx("button",{onClick:r,className:"px-2 py-1 text-xs border border-ft2-border bg-ft2-bg\n                   hover:border-ft2-highlight hover:text-ft2-highlight transition-colors",title:"Edit parameters",children:"EDIT"}),t.jsx("button",{onClick:a,className:`\n            px-2 py-1 text-xs border font-bold transition-colors\n            ${e.enabled?"border-green-500 bg-green-900 text-green-300 hover:bg-green-800":"border-red-500 bg-red-900 text-red-300 hover:bg-red-800"}\n          `,children:e.enabled?"ON":"OFF"}),t.jsx("button",{onClick:n,className:"px-2 py-1 text-xs border border-ft2-border bg-ft2-bg\n                   hover:border-red-500 hover:text-red-500 transition-colors",title:"Remove effect",children:"X"})]}),!e.enabled&&t.jsx("div",{className:"mt-2 text-xs text-red-400 font-mono",children:"BYPASSED"})]})}const Rb=({instrumentId:e,effects:a,onEditEffect:n})=>{const[r,s]=he.useState(!1),{updateEffect:i,removeEffect:o,addEffect:l,reorderEffects:d}=T(),c=Pt(Dt(Ht),Dt(qt,{coordinateGetter:Ut}));return t.jsxs("div",{className:"p-4 bg-ft2-bg",children:[t.jsxs("div",{className:"flex items-center justify-between mb-4 pb-2 border-b border-ft2-border",children:[t.jsx("div",{className:"text-ft2-highlight text-sm font-bold",children:"EFFECTS CHAIN"}),t.jsx("button",{onClick:()=>s(!r),className:"px-3 py-1 text-xs border border-ft2-border bg-ft2-header\n                   hover:border-ft2-highlight hover:text-ft2-highlight transition-colors font-bold",children:"+ ADD EFFECT"})]}),r&&t.jsxs("div",{className:"mb-4 p-3 bg-ft2-header border border-ft2-highlight max-h-64 overflow-y-auto scrollbar-ft2",children:[t.jsx("div",{className:"text-xs text-ft2-textDim mb-2 font-bold",children:"SELECT EFFECT:"}),t.jsx("div",{className:"grid grid-cols-2 gap-1",children:Ib.map(a=>t.jsx("button",{onClick:()=>(t=>{l(e,t),s(!1)})(a),className:"px-2 py-1 text-xs text-left border border-ft2-border bg-ft2-bg\n                         hover:bg-ft2-cursor hover:text-ft2-bg hover:border-ft2-highlight\n                         transition-colors font-mono",children:a},a))})]}),t.jsx("div",{className:"mb-4 p-3 bg-ft2-header border border-ft2-border",children:t.jsxs("div",{className:"flex items-center justify-between text-xs font-mono text-ft2-textDim",children:[t.jsx("span",{className:"text-ft2-highlight font-bold",children:"SYNTH"}),t.jsx("span",{children:"→"}),a.length>0?t.jsx(t.Fragment,{children:a.map((e,a)=>t.jsxs(fe.Fragment,{children:[t.jsxs("span",{className:e.enabled?"text-green-400":"text-red-400",children:["FX",a+1]}),t.jsx("span",{children:"→"})]},e.id))}):t.jsxs(t.Fragment,{children:[t.jsx("span",{className:"text-ft2-textDim italic",children:"no effects"}),t.jsx("span",{children:"→"})]}),t.jsx("span",{className:"text-ft2-highlight font-bold",children:"OUT"})]})}),0===a.length?t.jsx("div",{className:"p-8 text-center text-ft2-textDim text-sm border border-dashed border-ft2-border",children:'No effects. Click "ADD EFFECT" to get started.'}):t.jsx(Bt,{sensors:c,collisionDetection:Lt,onDragEnd:t=>{const{active:n,over:r}=t;if(r&&n.id!==r.id){const t=a.findIndex(e=>e.id===n.id),s=a.findIndex(e=>e.id===r.id);-1!==t&&-1!==s&&d(e,t,s)}},children:t.jsx(Ft,{items:a.map(e=>e.id),strategy:Wt,children:a.map(r=>t.jsx(Ob,{effect:r,onToggle:()=>(t=>{const n=a.find(e=>e.id===t);n&&i(e,t,{enabled:!n.enabled})})(r.id),onRemove:()=>{return t=r.id,void o(e,t);var t},onEdit:()=>(e=>{n&&n(e)})(r),onWetChange:t=>((t,a)=>{i(e,t,{wet:a})})(r.id,t)},r.id))})}),t.jsxs("div",{className:"mt-4 text-xs text-ft2-textDim",children:[t.jsx("div",{className:"font-bold mb-1",children:"TIPS:"}),t.jsxs("ul",{className:"list-disc list-inside space-y-1",children:[t.jsx("li",{children:"Drag effects to reorder the signal chain"}),t.jsx("li",{children:"Use WET control to blend effect with dry signal"}),t.jsx("li",{children:"Click EDIT to adjust effect parameters"}),t.jsx("li",{children:"Toggle ON/OFF to bypass effects"})]})]})]})};const Vb=({isOpen:e,onClose:a,createMode:n=!1})=>{const r=T(e=>e.instruments),s=T(e=>e.currentInstrumentId),i=T(e=>e.createInstrument),o=T(e=>e.updateInstrument),d=T(e=>e.setPreviewInstrument),c=T(e=>e.setCurrentInstrument),u=r.find(e=>e.id===s)||null,[p,h]=he.useState(n),[f,x]=he.useState("TB303"),[g,b]=he.useState(""),[y,v]=he.useState("303 Classic"),[w,j]=he.useState(null),[_,k]=he.useState("sound"),[N,$]=he.useState(!0),[C,S]=he.useState(!1),[M,z]=he.useState(!1),[E,A]=he.useState(()=>{try{const e=localStorage.getItem("devilbox-editor-left-panel-collapsed");return null===e||"true"===e}catch{return!0}});he.useEffect(()=>{try{localStorage.setItem("devilbox-editor-left-panel-collapsed",String(E))}catch{}},[E]),he.useEffect(()=>{e&&n?(h(!0),x("TB303"),v("303 Classic"),j(Db("TB303"))):e&&!n&&(0===r.length?(h(!0),x("TB303"),v("303 Classic"),j(Db("TB303"))):u?(h(!1),j(null)):(h(!1),j(null),c(r[0].id)))},[e,n,u,r,c]),he.useEffect(()=>{if(p&&w)return d(w),()=>d(null)},[p,w,d]),he.useEffect(()=>{if(!e)return;const t=e=>{"Escape"===e.key&&(e.preventDefault(),V())};return window.addEventListener("keydown",t),()=>window.removeEventListener("keydown",t)},[e]);const I=e=>ze[e]||Te,O=oe.filter(e=>{if(!g.trim())return!0;const t=le[e],a=g.toLowerCase();return t.name.toLowerCase().includes(a)||t.shortName.toLowerCase().includes(a)||t.description.toLowerCase().includes(a)||t.bestFor.some(e=>e.toLowerCase().includes(a))}),R=()=>{d(null);const e=i();w&&o(e,{...w,name:y}),c(e),h(!1),j(null)},V=()=>{d(null),h(!1),j(null),a()},P=he.useCallback(e=>{m.getInstance().invalidateInstrument(-1),j(t=>t?{...t,...e}:null)},[]),D=()=>{h(!0),x("TB303"),v("303 Classic"),j(Db("TB303"))},B=he.useCallback(e=>{k("sound")},[]),L=[...r].sort((e,t)=>e.id-t.id),F=L.findIndex(e=>e.id===s),W=he.useCallback(()=>{F>0?c(L[F-1].id):L.length>0&&c(L[L.length-1].id)},[F,L,c]),U=he.useCallback(()=>{F<L.length-1?c(L[F+1].id):L.length>0&&c(L[0].id)},[F,L,c]);if(!e)return null;const q=p?w:u,H=l(q?.synthType?q.synthType:"TB303"),G=I(H.icon);if(p)return t.jsx("div",{className:"fixed inset-0 z-50 flex items-center justify-center bg-black/90",children:t.jsxs("div",{className:"w-full h-full bg-dark-bg flex flex-col overflow-hidden",children:[t.jsxs("div",{className:"flex items-center justify-between px-4 py-2 bg-dark-bgSecondary border-b border-dark-border shrink-0",children:[t.jsxs("div",{className:"flex items-center gap-3",children:[t.jsx("div",{className:`p-1.5 rounded ${H.color} bg-dark-bgTertiary`,children:t.jsx(G,{size:18})}),t.jsxs("div",{className:"flex items-center gap-3",children:[t.jsx("h2",{className:"text-text-primary font-bold text-sm",children:"CREATE INSTRUMENT"}),t.jsx("input",{type:"text",value:y,onChange:e=>v(e.target.value),className:"px-3 py-1 text-sm bg-dark-bg border border-dark-border text-text-primary rounded focus:border-accent-primary focus:outline-none font-mono",placeholder:"Instrument name..."})]})]}),t.jsxs("div",{className:"flex items-center gap-3",children:[t.jsxs("button",{onClick:V,className:"flex items-center gap-1.5 px-4 py-2 bg-red-900/50 text-red-300 text-sm font-bold hover:bg-red-800/60 hover:text-red-200 transition-colors rounded border border-red-700",children:[t.jsx(be,{size:14}),"Cancel"]}),t.jsxs("button",{onClick:R,disabled:!y.trim(),className:"flex items-center gap-1.5 px-4 py-2 bg-green-600 text-white text-sm font-bold hover:bg-green-500 transition-colors rounded disabled:opacity-50 disabled:cursor-not-allowed",children:[t.jsx(Et,{size:14}),"Add Instrument"]})]})]}),t.jsxs("div",{className:"flex-1 flex overflow-hidden",children:[t.jsxs("div",{className:"w-64 shrink-0 bg-dark-bgSecondary border-r border-dark-border flex flex-col",children:[t.jsx("div",{className:"p-2 border-b border-dark-border",children:t.jsxs("div",{className:"relative",children:[t.jsx(Tt,{size:14,className:"absolute left-2 top-1/2 -translate-y-1/2 text-text-muted"}),t.jsx("input",{type:"text",value:g,onChange:e=>b(e.target.value),placeholder:"Search synths...",className:"w-full pl-7 pr-2 py-1.5 text-xs bg-dark-bg border border-dark-border text-text-primary rounded focus:border-accent-primary focus:outline-none"})]})}),t.jsxs("div",{className:"flex-1 overflow-y-auto scrollbar-modern",children:[O.map(e=>{const a=le[e],n=I(a.icon),r=f===e;return t.jsxs("button",{onClick:()=>(e=>{m.getInstance().invalidateInstrument(-1),x(e),j(Db(e)),v(l(e).name)})(e),className:`\n                        w-full px-2 py-1.5 text-left transition-all flex items-center gap-2 border-b border-dark-border\n                        ${r?"bg-accent-primary text-dark-bg":"hover:bg-dark-bgTertiary"}\n                      `,children:[t.jsx(n,{size:14,className:r?"text-dark-bg":a.color}),t.jsxs("div",{className:"flex-1 min-w-0",children:[t.jsx("div",{className:"font-bold text-xs truncate "+(r?"text-dark-bg":"text-text-primary"),children:a.shortName}),t.jsx("div",{className:"text-[10px] truncate "+(r?"text-dark-bg/70":"text-text-muted"),children:a.bestFor[0]})]})]},e)}),0===O.length&&t.jsx("div",{className:"text-center py-4 text-text-muted text-xs",children:"No synths found"})]})]}),t.jsxs("div",{className:"flex-1 flex flex-col overflow-hidden",children:[t.jsx("div",{className:"flex-1 overflow-y-auto scrollbar-modern",children:w&&t.jsx(Pb,{instrument:w,onChange:P})}),t.jsx("div",{className:"p-2 border-t border-dark-border bg-dark-bgSecondary shrink-0",children:w&&t.jsx(Mb,{instrument:w})})]})]})]})});const K=[{id:"sound",label:"Sound",icon:qe},{id:"effects",label:"Effects",icon:Qe}];return t.jsx("div",{className:"fixed inset-0 z-50 bg-black/90",children:t.jsxs("div",{className:"bg-dark-bg w-full h-full flex flex-col overflow-hidden",children:[t.jsxs("div",{className:"flex h-full",children:[t.jsx("div",{className:"border-r border-dark-border flex-shrink-0 bg-dark-bgSecondary transition-all duration-200 "+(E?"w-8":"w-52"),children:E?t.jsx("button",{onClick:()=>A(!1),className:"w-full h-full flex items-start justify-center pt-3 text-text-muted hover:text-text-primary hover:bg-dark-bgTertiary transition-colors",title:"Show instrument list",children:t.jsx(He,{size:16})}):t.jsxs("div",{className:"h-full flex flex-col",children:[t.jsxs("div",{className:"flex items-center justify-between px-2 py-1 border-b border-dark-border",children:[t.jsx("span",{className:"text-xs font-medium text-text-muted",children:"Instruments"}),t.jsx("button",{onClick:()=>A(!0),className:"p-1 text-text-muted hover:text-text-primary hover:bg-dark-bgTertiary rounded transition-colors",title:"Hide instrument list",children:t.jsx(At,{size:14})})]}),t.jsx("div",{className:"flex-1 overflow-hidden",children:t.jsx(de,{maxHeight:"100%",showActions:!0,onCreateNew:D})})]})}),t.jsxs("div",{className:"flex-1 flex flex-col min-w-0",children:[u?t.jsxs(t.Fragment,{children:[t.jsxs("div",{className:"flex items-center justify-between px-4 py-3 border-b border-dark-border bg-dark-bgSecondary",children:[t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx("button",{onClick:W,className:"p-1.5 rounded hover:bg-dark-bgTertiary text-text-muted hover:text-text-primary transition-colors",title:"Previous instrument",children:t.jsx(At,{size:20})}),t.jsx("div",{className:`p-2 rounded-lg bg-dark-bg ${H?.color||"text-text-primary"}`,children:t.jsx(G,{size:20})}),t.jsxs("div",{children:[t.jsxs("div",{className:"flex items-center gap-1",children:[t.jsx("input",{type:"text",value:u.name,onChange:e=>o(u.id,{name:e.target.value}),className:"bg-transparent text-text-primary font-semibold text-lg focus:outline-none focus:ring-1 focus:ring-accent-primary rounded px-1 -ml-1"}),t.jsxs("span",{className:"text-xs text-text-muted font-mono",children:["(",F+1,"/",L.length,")"]})]}),t.jsxs("p",{className:"text-xs text-text-muted",children:[H?.name||u.synthType," ",t.jsx("span",{className:"opacity-50",children:"|"})," ID: ",u.id.toString(16).toUpperCase().padStart(2,"0")]})]}),t.jsx("button",{onClick:U,className:"p-1.5 rounded hover:bg-dark-bgTertiary text-text-muted hover:text-text-primary transition-colors",title:"Next instrument",children:t.jsx(He,{size:20})})]}),t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsxs("button",{onClick:()=>z(!0),className:"flex items-center gap-1.5 px-3 py-1.5 rounded bg-dark-bg hover:bg-dark-bgTertiary text-text-primary transition-colors text-sm border border-dark-border",title:"Change synth type",children:[t.jsx(Te,{size:14}),"Browse Synths"]}),t.jsxs("button",{onClick:()=>S(!0),className:"flex items-center gap-1.5 px-3 py-1.5 rounded bg-dark-bg hover:bg-dark-bgTertiary text-text-primary transition-colors text-sm border border-dark-border",title:"Save as preset",children:[t.jsx(xe,{size:14}),"Save"]}),t.jsxs("button",{onClick:V,className:"flex items-center gap-2 px-3 py-2 rounded-lg bg-dark-bg hover:bg-dark-bgHover transition-colors text-text-muted hover:text-text-primary border border-dark-border",title:"Close (Escape)",children:[t.jsx(be,{size:18}),t.jsx("span",{className:"text-sm font-medium",children:"Close"})]})]})]}),t.jsx("div",{className:"flex items-center gap-1 px-4 py-2 border-b border-dark-border bg-dark-bg",children:K.map(e=>{const a=e.icon,n=_===e.id;return t.jsxs("button",{onClick:()=>k(e.id),className:`\n                          flex items-center gap-2 px-4 py-2 rounded-lg text-sm font-medium transition-all border\n                          ${n?"bg-dark-bgSecondary text-accent-primary border-accent-primary":"text-text-muted hover:text-text-primary hover:bg-dark-bgSecondary border-transparent"}\n                        `,children:[t.jsx(a,{size:16}),e.label]},e.id)})}),t.jsxs("div",{className:"flex-1 overflow-y-auto scrollbar-modern",children:["sound"===_&&t.jsx("div",{className:"overflow-y-auto",children:t.jsx(Pb,{instrument:u,onChange:e=>o(u.id,e)})}),"effects"===_&&t.jsx("div",{className:"p-4",children:t.jsx(Rb,{instrumentId:u.id,effects:u.effects||[]})})]}),M&&t.jsx("div",{className:"absolute inset-0 z-50 bg-black/80 flex items-center justify-center",children:t.jsxs("div",{className:"bg-dark-bg border border-dark-border rounded-lg shadow-2xl w-[90%] max-w-4xl max-h-[85vh] flex flex-col",children:[t.jsxs("div",{className:"flex items-center justify-between px-4 py-3 border-b border-dark-border",children:[t.jsxs("h3",{className:"text-lg font-semibold text-text-primary flex items-center gap-2",children:[t.jsx(Te,{size:20,className:"text-accent-primary"}),"Browse Synth Types"]}),t.jsx("button",{onClick:()=>z(!1),className:"p-1.5 rounded hover:bg-dark-bgHover text-text-muted hover:text-text-primary transition-colors",children:t.jsx(be,{size:18})})]}),t.jsx("div",{className:"flex-1 overflow-y-auto p-4",children:t.jsx(Ab,{onSelect:e=>{B(e),z(!1)}})})]})})]}):t.jsxs("div",{className:"flex-1 flex flex-col",children:[t.jsxs("div",{className:"flex items-center justify-between px-4 py-3 border-b border-dark-border bg-dark-bgSecondary",children:[t.jsx("h2",{className:"text-lg font-semibold text-text-primary",children:"Instrument Editor"}),t.jsxs("button",{onClick:V,className:"flex items-center gap-2 px-3 py-2 rounded-lg bg-dark-bg hover:bg-dark-bgHover transition-colors text-text-muted hover:text-text-primary border border-dark-border",title:"Close (Escape)",children:[t.jsx(be,{size:18}),t.jsx("span",{className:"text-sm font-medium",children:"Close"})]})]}),t.jsx("div",{className:"flex-1 flex items-center justify-center",children:t.jsxs("div",{className:"text-center",children:[t.jsx(Te,{size:48,className:"mx-auto mb-4 opacity-50 text-text-muted"}),t.jsx("p",{className:"text-text-muted mb-2",children:"No instrument selected"}),t.jsx("p",{className:"text-text-muted text-sm mb-4",children:"Select an instrument from the list or create a new one"}),t.jsxs("button",{onClick:D,className:"flex items-center gap-2 px-4 py-2 bg-accent-primary rounded-lg text-text-inverse hover:bg-accent-primary/80 transition-colors mx-auto",children:[t.jsx(Ie,{size:16}),"Create Instrument"]})]})})]}),u&&t.jsxs("div",{className:"border-t border-dark-border",children:[t.jsxs("button",{onClick:()=>$(!N),className:"w-full px-4 py-2 flex items-center justify-between text-sm text-text-muted hover:text-text-primary hover:bg-dark-bgHover transition-colors",children:[t.jsxs("span",{className:"flex items-center gap-2",children:[t.jsx(It,{size:14}),"Test Keyboard"]}),N?t.jsx(we,{size:14}):t.jsx(bt,{size:14})]}),N&&t.jsx("div",{className:"p-4 bg-dark-bgSecondary",children:t.jsx(Mb,{instrument:u})})]})]})]}),C&&u&&t.jsx(Zt,{instrument:u,onClose:()=>S(!1)})]})})},Pb=({instrument:e,onChange:a})=>t.jsx("div",{className:"instrument-editor-wrapper",children:t.jsx(_b,{instrument:e,onChange:a})});function Db(e){const t={id:-1,name:l(e).name,type:"synth",synthType:e,volume:-6,pan:0,oscillator:pe,envelope:me,filter:ue,effects:[]};if("TB303"===e||"Buzz3o3"===e)t.tb303={...S},"Buzz3o3"===e&&(t.buzzmachine={...z,machineType:"OomekAggressor",parameters:{0:0,1:120,2:64,3:64,4:64,5:64,6:100,7:100}});else if(function(e){return"Furnace"===e||e.startsWith("Furnace")}(e)){t.furnace={...M};const a={Furnace:1,FurnaceOPN:0,FurnaceOPNA:13,FurnaceOPNB:14,FurnaceOPM:1,FurnaceOPL:2,FurnaceOPLL:23,FurnaceOPL4:26,FurnaceOPZ:24,FurnaceESFM:25,FurnaceNES:3,FurnaceGB:4,FurnaceC64:5,FurnaceSID6581:5,FurnaceSID8580:5,FurnaceAY:6,FurnacePSG:7,FurnaceTIA:8,FurnaceVERA:9,FurnaceSAA:10,FurnaceVIC:11,FurnaceLynx:12};void 0!==a[e]&&(t.furnace.chipType=a[e])}else if(function(e){return"Buzzmachine"===e||e.startsWith("Buzz")}(e)){t.buzzmachine={...z};const a={Buzzmachine:"ArguruDistortion",BuzzDTMF:"CyanPhaseDTMF",BuzzFreqBomb:"ElenzilFrequencyBomb",BuzzKick:"FSMKick",BuzzKickXP:"FSMKickXP",BuzzNoise:"JeskolaNoise",BuzzTrilok:"JeskolaTrilok",Buzz4FM2F:"MadBrain4FM2F",BuzzDynamite6:"MadBrainDynamite6",BuzzM3:"MakkM3",Buzz3o3:"OomekAggressor"};a[e]&&(t.buzzmachine.machineType=a[e])}else if("GranularSynth"===e)t.granular={..._};else if("DrumKit"===e)t.drumKit={...x};else if("Sam"===e)t.sam={...ae};else if("V2"===e)t.v2={...X};else if("Sampler"!==e&&"Player"!==e&&"ChiptuneModule"!==e)switch(e){case"DrumMachine":t.drumMachine={...C};break;case"ChipSynth":t.chipSynth={...$};break;case"PWMSynth":t.pwmSynth={...N};break;case"Wavetable":t.wavetable={...k};break;case"SuperSaw":t.superSaw={...j};break;case"PolySynth":t.polySynth={...w};break;case"Organ":t.organ={...v};break;case"StringMachine":t.stringMachine={...y};break;case"FormantSynth":t.formantSynth={...b};break;case"WobbleBass":t.wobbleBass={...g};break;case"DubSiren":t.dubSiren={...f};break;case"SpaceLaser":t.spaceLaser={...h};break;case"Synare":t.synare={...p}}const a=t.furnace?.chipType,n=t.buzzmachine?.machineType,r=ce(e);if(r){const{name:s,type:i,synthType:o,...d}=r;Object.assign(t,d),t.synthType=e,t.id=-1,t.name=l(e).name,void 0!==a&&t.furnace&&(t.furnace.chipType=a),n&&t.buzzmachine&&(t.buzzmachine.machineType=n)}return t}export{Vb as EditInstrumentModal};
