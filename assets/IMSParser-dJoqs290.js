import{aB as t}from"./index-zx6LJBPK.js";import"./vendor-react-DkDaD07v.js";import"./vendor-utils-XMmR-oGw.js";import"./vendor-tone-CADp_hfL.js";import"./vendor-ui-uomqNFY-.js";function n(t,n){return t.getUint8(n)}function e(t,n){return t.getInt8(n)}function r(t,n){return t.getUint16(n,!1)}function o(t,n){return t.getUint32(n,!1)}function i(t,n,e){let r="";for(let o=0;o<e;o++){const e=t.getUint8(n+o);if(0===e)break;r+=String.fromCharCode(e)}return r.trim()}const s=1084,a=768,l=31,u=[-50,50,50,-50];function f(t){if(t.byteLength<s)return!1;const i=new DataView(t),u=o(i,1080);if(u<=s)return!1;const f=u-s;if(f%a!==0)return!1;const c=f/a;if(c>128)return!1;const p=n(i,950),m=n(i,951);if(0===p||p>128)return!1;if(m>p)return!1;for(let e=0;e<128;e++)if(n(i,952+e)>=c)return!1;let h=!1;for(let n=0;n<l;n++){const t=20+30*n,o=r(i,t+22);if(o>32768)return!1;if(0!==e(i,t+24))return!1;o>0&&(h=!0)}return h}function c(t){return 63===t?0:t<48?37+t:-1}async function p(p,m){if(!f(p))throw new Error("IMSParser: file does not pass IMS format validation");const h=new DataView(p),g=new Uint8Array(p),d=i(h,0,20)||m.replace(/\.[^/.]+$/,""),w=n(h,950),S=n(h,951),$=o(h,1080),v=($-s)/a,y=[];for(let t=0;t<w;t++)y.push(n(h,952+t));const I=[];for(let t=0;t<l;t++){const o=20+30*t;I.push({name:i(h,o,22)||`Sample ${t+1}`,length:r(h,o+22),finetune:e(h,o+24),volume:n(h,o+25),loopStart:r(h,o+26),loopLen:r(h,o+28)})}const M=[];let P=s;for(let t=0;t<v;t++){const e=Array.from({length:4},(t,n)=>({id:`channel-${n}`,name:`Channel ${n+1}`,muted:!1,solo:!1,collapsed:!1,volume:100,pan:u[n],instrumentId:null,color:null,rows:[]}));for(let r=0;r<64;r++)for(let o=0;o<4;o++){const i=P+3*(4*r+o),s=n(h,i),a=n(h,i+1),u=63&s,f=(192&s)>>2|(240&a)>>4,p=15&a,m=n(h,i+2);if(f>l)throw new Error(`IMSParser: invalid instrument ${f} at pattern ${t} row ${r} ch ${o}`);const g=c(u);if(-1===g)throw new Error(`IMSParser: invalid note index ${u} at pattern ${t} row ${r} ch ${o}`);const d={note:g,instrument:f,volume:0,effTyp:p,eff:m,effTyp2:0,eff2:0};e[o].rows.push(d)}M.push({id:`pattern-${t}`,name:`Pattern ${t}`,length:64,channels:e,importMetadata:{sourceFormat:"IMS",sourceFile:m,importedAt:(new Date).toISOString(),originalChannelCount:4,originalPatternCount:v,originalInstrumentCount:l}}),P+=a}let C=$;const L=[];for(let t=0;t<l;t++){const n=2*I[t].length;n>0&&C+n<=p.byteLength?(L.push(g.slice(C,C+n)),C+=n):(L.push(null),C+=n)}const j=[];for(let n=0;n<l;n++){const e=I[n],r=n+1,o=L[n];if(!o||0===o.length){j.push({id:r,name:e.name,type:"sample",synthType:"Sampler",effects:[],volume:-60,pan:0});continue}let i=0,s=0;e.loopLen>1&&(i=2*e.loopStart,s=2*(e.loopStart+e.loopLen),s=Math.min(s,o.length)),j.push(t(r,e.name,o,e.volume,8287,i,s))}return{name:d,format:"MOD",patterns:M,instruments:j,songPositions:y,songLength:y.length,restartPosition:S,numChannels:4,initialSpeed:6,initialBPM:125,linearPeriods:!1}}export{f as isIMSFormat,p as parseIMSFile};
