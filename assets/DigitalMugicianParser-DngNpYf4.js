function e(e,t,n){let a="";for(let o=0;o<n;o++){const n=e[t+o];if(0===n)break;a+=String.fromCharCode(n)}return a}function t(e,t){return e[t]}function n(e,t){const n=e[t];return n<128?n:n-256}function a(e,t){return e[t]<<8|e[t+1]}function o(e,t){return(e[t]<<24|e[t+1]<<16|e[t+2]<<8|e[t+3])>>>0}const r=[3220,3040,2869,2708,2556,2412,2277,2149,2029,1915,1807,1706,1610,1520,1434,1354,1278,1206,1139,1075,1014,957,904,853,805,760,717,677,639,603,569,537,507,479,452,426,403,380,359,338,319,302,285,269,254,239,226,213,201,190,179,169,160,151,142,134,127,4842,4571,4314,4072,3843,3628,3424,3232,3051,2879,2718,2565,2421,2285,2157,2036,1922,1814,1712,1616,1525,1440,1359,1283,1211,1143,1079,1018,961,907,856,808,763,720,679,641,605,571,539,509,480,453,428,404,381,360,340,321,303,286,270,254,240,227,214,202,191,180,170,160,151,143,135,127,4860,4587,4330,4087,3857,3641,3437,3244,3062,2890,2728,2574,2430,2294,2165,2043,1929,1820,1718,1622,1531,1445,1364,1287,1215,1147,1082,1022,964,910,859,811,765,722,682,644,607,573,541,511,482,455,430,405,383,361,341,322,304,287,271,255,241,228,215,203,191,181,170,161,152,143,135,128,4878,4604,4345,4102,3871,3654,3449,3255,3073,2900,2737,2584,2439,2302,2173,2051,1936,1827,1724,1628,1536,1450,1369,1292,1219,1151,1086,1025,968,914,862,814,768,725,684,646,610,575,543,513,484,457,431,407,384,363,342,323,305,288,272,256,242,228,216,203,192,181,171,161,152,144,136,128,4895,4620,4361,4116,3885,3667,3461,3267,3084,2911,2747,2593,2448,2310,2181,2058,1943,1834,1731,1634,1542,1455,1374,1297,1224,1155,1090,1029,971,917,865,817,771,728,687,648,612,578,545,515,486,458,433,408,385,364,343,324,306,289,273,257,243,229,216,204,193,182,172,162,153,144,136,129,4913,4637,4377,4131,3899,3681,3474,3279,3095,2921,2757,2603,2456,2319,2188,2066,1950,1840,1737,1639,1547,1461,1379,1301,1228,1159,1094,1033,975,920,868,820,774,730,689,651,614,580,547,516,487,460,434,410,387,365,345,325,307,290,274,258,244,230,217,205,193,183,172,163,154,145,137,129,4931,4654,4393,4146,3913,3694,3486,3291,3106,2932,2767,2612,2465,2327,2196,2073,1957,1847,1743,1645,1553,1466,1384,1306,1233,1163,1098,1037,978,923,872,823,777,733,692,653,616,582,549,518,489,462,436,411,388,366,346,326,308,291,275,259,245,231,218,206,194,183,173,163,154,145,137,130,4948,4671,4409,4161,3928,3707,3499,3303,3117,2942,2777,2621,2474,2335,2204,2081,1964,1854,1750,1651,1559,1471,1389,1311,1237,1168,1102,1040,982,927,875,826,779,736,694,655,619,584,551,520,491,463,437,413,390,368,347,328,309,292,276,260,245,232,219,206,195,184,174,164,155,146,138,130,4966,4688,4425,4176,3942,3721,3512,3315,3129,2953,2787,2631,2483,2344,2212,2088,1971,1860,1756,1657,1564,1477,1394,1315,1242,1172,1106,1044,985,930,878,829,782,738,697,658,621,586,553,522,493,465,439,414,391,369,348,329,310,293,277,261,246,233,219,207,196,185,174,164,155,146,138,131,4984,4705,4441,4191,3956,3734,3524,3327,3140,2964,2797,2640,2492,2352,2220,2096,1978,1867,1762,1663,1570,1482,1399,1320,1246,1176,1110,1048,989,934,881,832,785,741,699,660,623,588,555,524,495,467,441,416,392,370,350,330,312,294,278,262,247,233,220,208,196,185,175,165,156,147,139,131,5002,4722,4457,4206,3970,3748,3537,3339,3151,2974,2807,2650,2501,2361,2228,2103,1985,1874,1769,1669,1576,1487,1404,1325,1251,1180,1114,1052,993,937,884,835,788,744,702,662,625,590,557,526,496,468,442,417,394,372,351,331,313,295,279,263,248,234,221,209,197,186,175,166,156,148,139,131,5020,4739,4473,4222,3985,3761,3550,3351,3163,2985,2818,2659,2510,2369,2236,2111,1992,1881,1775,1675,1581,1493,1409,1330,1255,1185,1118,1055,996,940,887,838,791,746,704,665,628,592,559,528,498,470,444,419,395,373,352,332,314,296,280,264,249,235,222,209,198,187,176,166,157,148,140,132,5039,4756,4489,4237,3999,3775,3563,3363,3174,2996,2828,2669,2519,2378,2244,2118,2e3,1887,1781,1681,1587,1498,1414,1335,1260,1189,1122,1059,1e3,944,891,841,794,749,707,667,630,594,561,530,500,472,445,420,397,374,353,334,315,297,281,265,250,236,223,210,198,187,177,167,157,149,140,132,5057,4773,4505,4252,4014,3788,3576,3375,3186,3007,2838,2679,2528,2387,2253,2126,2007,1894,1788,1688,1593,1503,1419,1339,1264,1193,1126,1063,1003,947,894,844,796,752,710,670,632,597,563,532,502,474,447,422,398,376,355,335,316,298,282,266,251,237,223,211,199,188,177,167,158,149,141,133,5075,4790,4521,4268,4028,3802,3589,3387,3197,3018,2848,2688,2538,2395,2261,2134,2014,1901,1794,1694,1599,1509,1424,1344,1269,1198,1130,1067,1007,951,897,847,799,754,712,672,634,599,565,533,504,475,449,423,400,377,356,336,317,299,283,267,252,238,224,212,200,189,178,168,159,150,141,133,5093,4808,4538,4283,4043,3816,3602,3399,3209,3029,2859,2698,2547,2404,2269,2142,2021,1908,1801,1700,1604,1514,1429,1349,1273,1202,1134,1071,1011,954,900,850,802,757,715,675,637,601,567,535,505,477,450,425,401,379,357,337,318,300,284,268,253,238,225,212,201,189,179,169,159,150,142,134];function s(e){if(e<=0)return 0;let t=0,n=1/0;for(let o=0;o<57&&o<r.length;o++){const a=Math.abs(r[o]-e);a<n&&(n=a,t=o)}const a=t+1;return Math.max(1,Math.min(96,a))}async function l(l,i){const p=new Uint8Array(l);if(p.length<76)throw new Error("File too small to be a Digital Mugician module");const c=e(p,0,24);if(" MUGICIAN/SOFTEYES 1990 "!==c&&" MUGICIAN2/SOFTEYES 1990"!==c)throw new Error(`Not a Digital Mugician file: magic="${c}"`);const h=a(p,24),f=a(p,26)<<6,u=[];for(let e=0;e<8;e++)u[e]=o(p,28+4*e);const m=o(p,60),g=o(p,64)<<7,d=o(p,68),v=[];let M=76;for(let n=0;n<8;n++){const n=t(p,M),a=t(p,M+1)<<2,o=t(p,M+2),r=t(p,M+3)<<2,s=e(p,M+4,12);v.push({title:s,speed:o,length:r,loop:n,loopStep:a,tracks:[]}),M+=16}M=204;for(let e=0;e<8;e++){const a=u[e]<<2;for(let o=0;o<a&&!(M+1>=p.length);o++){const a=t(p,M)<<6,o=n(p,M+1);v[e].tracks.push({pattern:a,transpose:o}),M+=2}}const w=[],S=m+1;for(let e=1;e<S&&!(M+16>p.length);e++){const e={wave:t(p,M),waveLen:t(p,M+1)<<1,volume:t(p,M+2),volumeSpeed:t(p,M+3),arpeggio:t(p,M+4),pitch:t(p,M+5),effectStep:t(p,M+6),pitchDelay:t(p,M+7),finetune:t(p,M+8)<<6,pitchLoop:t(p,M+9),pitchSpeed:t(p,M+10),effect:t(p,M+11),source1:t(p,M+12),source2:t(p,M+13),effectSpeed:t(p,M+14),volumeLoop:t(p,M+15),pointer:0,sampleLength:0,loopOffset:0,repeat:0,name:""};w.push(e),M+=16}w.length>0&&w.unshift(w[0]);const y=M,b=new Uint8Array(g);for(let e=0;e<g&&M+e<p.length;e++)b[e]=p[M+e];M+=g;const $=M;if(d>0){const t=$+(d<<5),n=o(p,72),a=t;for(let r=1;r<w.length;r++){const t=w[r];if(t.wave<32)continue;const n=$+(t.wave-32<<5);if(n+24>p.length)continue;const s=o(p,n),l=o(p,n+4),i=o(p,n+8),c=e(p,n+12,12);t.pointer=s,t.sampleLength=l-s,t.name=c,i>0?(t.loopOffset=i-s,t.repeat=t.sampleLength-t.loopOffset,1&t.repeat&&t.repeat--):(t.loopOffset=0,t.repeat=0),1&t.pointer&&t.pointer--,1&t.sampleLength&&t.sampleLength--,t.pointer+=a}M=t+n}else if(M+4<=p.length){M=$+o(p,72)}const k=y+g+(d<<5),C=[];let D=k;for(let e=0;e<f;e++)D+4>p.length?(C.push({note:0,sample:0,effect:0,param:0}),D+=4):(C.push({note:t(p,D),sample:63&t(p,D+1),effect:t(p,D+2),param:n(p,D+3)}),D+=4);const L=new Uint8Array(256);if(1===h){const e=k+4*f;let t;if(d>0){t=e+o(p,72)}else t=e;if(t<p.length){const e=Math.min(256,p.length-t);for(let n=0;n<e;n++)L[n]=p[t+n]}}const O=[],I=new Map;let T=1;function A(e){if(e<=0||e>=w.length)return 0;if(I.has(e))return I.get(e);const t=w[e],n=T++;I.set(e,n);const a=[];for(let r=0;r<8;r++){const e=t.arpeggio+r;a.push(e<L.length?L[e]:0)}const o=Math.min(64,t.volume);if(t.wave>=32&&t.sampleLength>0){const r=t.pointer,s=r+t.sampleLength,l=s<=p.length&&t.sampleLength>0?p.slice(r,s):void 0,i={wavetable:[0,0,0,0],waveBlend:0,waveSpeed:0,volume:o,arpTable:a,arpSpeed:Math.min(15,t.pitchSpeed),vibSpeed:0,vibDepth:0,pcmData:l,loopStart:t.loopOffset,loopLength:t.repeat>0?t.repeat:0};O.push({id:n,name:t.name||`PCM ${e}`,type:"synth",synthType:"DigMugSynth",digMug:i,effects:[],volume:-6,pan:0})}else if(t.wave<32){const e=t.wave<<7,r=t.waveLen>0?Math.min(t.waveLen,128):128,s=e+r<=b.length?b.slice(e,e+r):void 0,l={wavetable:[t.wave,t.wave,t.wave,t.wave],waveBlend:0,waveSpeed:0,volume:o,arpTable:a,arpSpeed:Math.min(15,t.pitchSpeed),vibSpeed:0,vibDepth:0,waveformData:s};O.push({id:n,name:`Wave ${t.wave}`,type:"synth",synthType:"DigMugSynth",digMug:l,effects:[],volume:-6,pan:0})}else O.push({id:n,name:`Instrument ${e}`,type:"synth",synthType:"Synth",effects:[],volume:-6,pan:0});return n}const P=v[0];if(!P||0===P.length)throw new Error("Digital Mugician file contains no song data");const E=15&P.speed,F=Math.floor(P.length/4),U=[],B=[],N=new Map;for(let e=0;e<F;e++){const t=4*e;if(t+3>=P.tracks.length)break;const n=P.tracks[t],a=P.tracks[t+1],o=P.tracks[t+2],l=P.tracks[t+3],p=`${n.pattern}:${n.transpose}:${a.pattern}:${a.transpose}:${o.pattern}:${o.transpose}:${l.pattern}:${l.transpose}`;if(N.has(p)){B.push(N.get(p));continue}const c=U.length;N.set(p,c),B.push(c);const h=[[],[],[],[]];for(let e=0;e<64;e++)for(let n=0;n<4;n++){const a=P.tracks[t+n],o=a.pattern+e;let l=0,i=0,p=0,c=0;if(o>=0&&o<C.length){const e=C[o];l=e.note,i=e.sample,p=e.effect,c=e.param}let f=0;if(l>0){let e=0,t=a.transpose;i>0&&i<w.length&&(e=w[i].finetune);const n=l+t+e;if(n>=0&&n<r.length){f=s(r[n])}}let u=0;i>0&&(u=A(i));const m=c;let g=0,d=0;if(l>0)switch(l>0?p<64?1:p-62:0){case 1:0!==m&&(m>0?(g=1,d=Math.min(Math.abs(m),255)):(g=2,d=Math.min(Math.abs(m),255)));break;case 5:case 10:case 11:break;case 6:m>0&&m<=15&&(g=15,d=255&m);break;case 7:g=14,d=1;break;case 8:g=14,d=0;break;case 9:0!==m&&(m>0?(g=1,d=Math.min(m,255)):(g=2,d=Math.min(-m,255)));break;case 12:0!==m&&(g=3,d=Math.min(Math.abs(m),255));break;case 13:{const e=15&m;e>0&&(m>>4&15)>0&&(g=15,d=e);break}}const v=0;h[n].push({note:f,instrument:u,volume:v,effTyp:g,eff:d,effTyp2:0,eff2:0})}U.push({id:`pattern-${c}`,name:`Pattern ${c}`,length:64,channels:h.map((e,t)=>({id:`channel-${t}`,name:`Channel ${t+1}`,muted:!1,solo:!1,collapsed:!1,volume:100,pan:0===t||3===t?-50:50,instrumentId:null,color:null,rows:e})),importMetadata:{sourceFormat:"MOD",sourceFile:i,importedAt:(new Date).toISOString(),originalChannelCount:4,originalPatternCount:Math.floor(f/64),originalInstrumentCount:m}})}0===U.length&&(U.push(function(e){return{id:"pattern-0",name:"Pattern 0",length:64,channels:Array.from({length:4},(e,t)=>({id:`channel-${t}`,name:`Channel ${t+1}`,muted:!1,solo:!1,collapsed:!1,volume:100,pan:0===t||3===t?-50:50,instrumentId:null,color:null,rows:Array.from({length:64},()=>({note:0,instrument:0,volume:0,effTyp:0,eff:0,effTyp2:0,eff2:0}))})),importMetadata:{sourceFormat:"MOD",sourceFile:e,importedAt:(new Date).toISOString(),originalChannelCount:4,originalPatternCount:0,originalInstrumentCount:0}}}(i)),B.push(0));const x=P.loop>0?Math.min(Math.floor(P.loopStep/4),B.length-1):0;return{name:P.title.trim()||i.replace(/\.[^/.]+$/,""),format:"MOD",patterns:U,instruments:O,songPositions:B,songLength:B.length,restartPosition:x,numChannels:4,initialSpeed:E>0?E:6,initialBPM:125,linearPeriods:!1}}export{l as parseDigitalMugicianFile};
