import{aW as n}from"./index-zx6LJBPK.js";import"./vendor-react-DkDaD07v.js";import"./vendor-utils-XMmR-oGw.js";import"./vendor-tone-CADp_hfL.js";import"./vendor-ui-uomqNFY-.js";function t(n,t){return n.getUint8(t)}function e(n,t){return n.getUint16(t,!0)}function o(n,t){return n.getUint32(t,!0)}function r(n,t,e){let o="";for(let r=0;r<e;r++){const e=n.getUint8(t+r);if(0===e)break;o+=String.fromCharCode(e)}return o}function i(n){const t=n instanceof Uint8Array?n:new Uint8Array(n);return!(t.length<192)&&(73===t[0]&&77===t[1]&&80===t[2]&&77===t[3])}function l(n,o){const r=t(n,o),i=t(n,o+1),l=t(n,o+2),s=t(n,o+3),a=t(n,o+4);if(!(1&r)||0===i)return;const f=[];for(let u=0;u<i&&u<25;u++){const r=o+6+3*u,i=t(n,r),l=e(n,r+1);f.push({tick:l,value:i})}return{enabled:!0,points:f,sustainPoint:4&r?a:null,loopStartPoint:2&r?l:null,loopEndPoint:2&r?s:null}}function s(n,e,i,l){if(i+80>n.byteLength)return null;if(73!==t(n,i)||77!==t(n,i+1)||80!==t(n,i+2)||83!==t(n,i+3))return null;const s=t(n,i+18),a=Math.min(t(n,i+19),64),f=r(n,i+20,26).replace(/\0/g,"").trim()||`Sample ${l}`,u=t(n,i+46),c=t(n,i+47),p=o(n,i+48),h=o(n,i+52),m=o(n,i+56),g=o(n,i+60),y=o(n,i+72);if(!(1&s)||0===p||0===y||y>=n.byteLength)return null;const d=!!(2&s),w=!(1&u);let A;if(!!(8&s)){if(A=function(n,t,e){const o=new ArrayBuffer(t*(e?2:1)),r=new Int8Array(o),i=new Int16Array(o);let l=0,s=0,a=0,f=0,u=null,c=0;function p(){if(0===a)return 0;const n=1&f;return f>>=1,a--,0===a&&c<(u?.length??0)&&(f=u[c++],a=8),n}function h(n){let t=0;for(let e=0;e<n;e++)t|=p()<<e;return t}for(;l+2<=n.length&&s<t;){const o=n[l]|n[l+1]<<8;if(l+=2,l+o>n.length)break;if(u=n.subarray(l,l+o),l+=o,c=0,f=u.length>0?u[c++]:0,a=u.length>0?8:0,e){let n=17,e=0;for(;s<t;){const t=h(n);if(n<7){if(t===(1<<n)-1){n++;continue}e=(e+(t-((1<<n-1)-1))&65535)<<16>>16,i[s++]=e}else if(n<17){const o=1<<n-1;if(t===o+1){const e=255&t;n=0===e?1:Math.min(e,17);continue}if(t===o){n++;continue}e=(e+(t<o?t:t-(o<<1))&65535)<<16>>16,i[s++]=e}else if(t<65536)e=(65535&t)<<16>>16,i[s++]=e;else{const e=t>>1&255;e?n=e+1:n++}}}else{let n=9,e=0;for(;s<t;){const t=h(n);if(n<7){if(t===(1<<n)-1){n++;continue}e=(e+(t-((1<<n-1)-1))&255)<<24>>24,r[s++]=e}else if(n<9){const o=1<<n-1;if(t===o+1){const e=255&t;n=0===e?1:Math.min(e,9);continue}if(t===o){n++;continue}e=(e+(t<o?t:t-(o<<1))&255)<<24>>24,r[s++]=e}else if(t<256)e=(255&t)<<24>>24,r[s++]=e;else{const e=t>>1&255;e?n=e+1:n++}}}}return o}(e.subarray(y),p,d),w)if(d){const n=new Int16Array(A);for(let t=0;t<n.length;t++)n[t]=n[t]+32768&65535}else{const n=new Uint8Array(A);for(let t=0;t<n.length;t++)n[t]^=128}}else{const n=p*(d?2:1),t=Math.min(y+n,e.length)-y;if(d){const n=t>>1,o=new ArrayBuffer(2*n),r=new DataView(o);for(let t=0;t<n;t++){const n=y+2*t;if(n+1>=e.length)break;if(w){const o=e[n]|e[n+1]<<8;r.setInt16(2*t,o-32768&65535,!0)}else r.setInt16(2*t,e[n]|e[n+1]<<8,!0)}A=o}else{const n=new ArrayBuffer(t),o=new Uint8Array(n);for(let r=0;r<t;r++)o[r]=w?128^e[y+r]:e[y+r];A=n}}const v=!!(16&s)&&m>h;return{id:l,name:f,pcmData:A,bitDepth:d?16:8,sampleRate:g||8363,length:p,loopStart:v?h:0,loopLength:v?m-h:0,loopType:v?!!(64&s)?"pingpong":"forward":"none",volume:a,finetune:0,relativeNote:0,panning:128&c?Math.min(4*(127&c),255):128}}function a(n,t,e){const o=()=>({note:0,instrument:0,volume:0,effTyp:0,eff:0,effTyp2:0,eff2:0}),r=Array.from({length:t},()=>Array.from({length:e},o)),i=new Uint8Array(64),l=new Uint8Array(64),s=new Uint8Array(64),a=new Uint8Array(64),f=new Uint8Array(64),u=new Uint8Array(64);let c=0,p=0;for(;p<t&&c<n.length;){const t=n[c++];if(0===t){p++;continue}const o=t-1&63;let h;128&t?(h=n[c++],i[o]=h):h=i[o];let m=0,g=0,y=0,d=0,w=0;if(1&h){const t=n[c++];l[o]=t,254===t?m=97:255!==t&&120!==t&&(m=t+1)}if(2&h&&(g=n[c++],s[o]=g),4&h&&(y=n[c++],a[o]=y),8&h&&(d=n[c++],w=n[c++],f[o]=d,u[o]=w),16&h){const n=l[o];254===n?m=97:255!==n&&120!==n&&(m=n+1)}32&h&&(g=s[o]),64&h&&(y=a[o]),128&h&&(d=f[o],w=u[o]),o<e&&(r[p][o]={note:m,instrument:g,volume:y,effTyp:d,eff:w,effTyp2:0,eff2:0})}return r}function f(n,t){return{id:n,name:t||`Sample ${n}`,type:"sample",synthType:"Sampler",effects:[],volume:-60,pan:0}}function u(n,t,e,o,r){const i={note:0,instrument:0,volume:0,effTyp:0,eff:0,effTyp2:0,eff2:0},l=[];for(let s=0;s<t;s++)l.push({id:`channel-${s}`,name:`Channel ${s+1}`,muted:!1,solo:!1,collapsed:!1,volume:100,pan:0,instrumentId:null,color:null,rows:Array.from({length:64},()=>({...i}))});return{id:`pattern-${n}`,name:`Pattern ${n}`,length:64,channels:l,importMetadata:{sourceFormat:"IT",sourceFile:e,importedAt:(new Date).toISOString(),originalChannelCount:t,originalPatternCount:o+1,originalInstrumentCount:r}}}function c(c,p){if(!i(c))throw new Error("Not a valid IT file");const h=new DataView(c),m=new Uint8Array(c),g=r(h,4,26),y=e(h,32),d=e(h,34),w=e(h,36),A=e(h,38),v=e(h,42),I=e(h,44),T=t(h,50)||6,b=t(h,51)||125,U=!!(8&I),$=!!(4&I)&&v>=512&&d>0,S=function(n){let e=0;for(let o=0;o<64;o++)t(n,64+o)<128&&(e=o+1);return Math.max(e,1)}(h);let C=192;const M=[];for(let n=0;n<y;n++){const e=t(h,C+n);if(255===e)break;254!==e&&M.push(e)}C+=y;const P=[];for(let n=0;n<d;n++)P.push(o(h,C+4*n));C+=4*d;const D=[];for(let n=0;n<w;n++)D.push(o(h,C+4*n));C+=4*w;const L=[];for(let n=0;n<A;n++)L.push(o(h,C+4*n));const j=D.map((n,t)=>s(h,m,n,t+1)),k=[];if($)for(let o=0;o<d;o++){const i=o+1,s=P[o];if(0===s||s+554>c.byteLength){k.push(f(i,`Instrument ${i}`));continue}if(73!==t(h,s)||77!==t(h,s+1)||80!==t(h,s+2)||73!==t(h,s+3)){k.push(f(i,`Instrument ${i}`));continue}const a=r(h,s+32,26).replace(/\0/g,"").trim()||`Instrument ${i}`,u=e(h,s+20),p=l(h,s+304),m=l(h,s+386),g=new Set;for(let n=0;n<120;n++){const e=t(h,s+64+120+n);e>0&&e<=w&&g.add(e-1)}const y=new Array(96).fill(0),d=[],A=new Map;for(const n of Array.from(g).sort((n,t)=>n-t)){const t=j[n];t&&(A.set(n,d.length),d.push({...t,id:d.length+1}))}for(let n=0;n<96;n++){const e=t(h,s+64+120+n);if(e>0){const t=A.get(e-1);void 0!==t&&(y[n]=t)}}if(0===d.length){k.push(f(i,a));continue}const v=n({id:i,name:a,samples:d,volumeEnvelope:p,panningEnvelope:m,sampleMap:y,fadeout:u,volumeType:p?.enabled?"envelope":"none",panningType:m?.enabled?"envelope":"none"},i,"IT");v.length>0?k.push(v[0]):k.push(f(i,a))}else for(let t=0;t<w;t++){const e=t+1,o=j[t];if(!o){const n=`Sample ${e}`;k.push(f(e,n));continue}const r={id:e,name:o.name,samples:[o],fadeout:0},i=n(r,e,"IT");i.length>0?k.push(i[0]):k.push(f(e,o.name))}const B=[],E=new Map,F=new Set(M);for(let n=0;n<A;n++)F.add(n);const x=Array.from(F).sort((n,t)=>n-t),N=x.length>0?x[x.length-1]:0,O=$?d:w;for(const n of x){if(n>=L.length||0===L[n]){E.set(n,B.length),B.push(u(n,S,p,N,O));continue}const t=L[n];if(t+8>c.byteLength){E.set(n,B.length),B.push(u(n,S,p,N,O));continue}const o=e(h,t),r=e(h,t+2)||64,i=a(m.subarray(t+8,t+8+o),r,S),l=[];for(let n=0;n<S;n++){const t=[];for(let e=0;e<r;e++)t.push(i[e]?.[n]??{note:0,instrument:0,volume:0,effTyp:0,eff:0,effTyp2:0,eff2:0});l.push({id:`channel-${n}`,name:`Channel ${n+1}`,muted:!1,solo:!1,collapsed:!1,volume:100,pan:0,instrumentId:null,color:null,rows:t})}E.set(n,B.length),B.push({id:`pattern-${n}`,name:`Pattern ${n}`,length:r,channels:l,importMetadata:{sourceFormat:"IT",sourceFile:p,importedAt:(new Date).toISOString(),originalChannelCount:S,originalPatternCount:N+1,originalInstrumentCount:O}})}const V=[];for(const n of M){const t=E.get(n);void 0!==t&&V.push(t)}return 0===V.length&&V.push(0),{name:g.replace(/\0/g,"").trim()||p.replace(/\.[^/.]+$/,""),format:"IT",patterns:B,instruments:k,songPositions:V,songLength:V.length,restartPosition:0,numChannels:S,initialSpeed:T,initialBPM:b,linearPeriods:U}}export{i as isITFormat,c as parseITFile};
