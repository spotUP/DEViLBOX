import{aB as e}from"./index-zx6LJBPK.js";import"./vendor-react-DkDaD07v.js";import"./vendor-utils-XMmR-oGw.js";import"./vendor-tone-CADp_hfL.js";import"./vendor-ui-uomqNFY-.js";function t(e,t){return e.getUint8(t)}function n(e,t){return e.getUint16(t,!1)}function f(e,t){return e.getUint32(t,!1)}function r(e,t,n){let f="";for(let r=0;r<n;r++){const n=e.getUint8(t+r);if(0===n)break;n>=32&&(f+=String.fromCharCode(n))}return f.trim()}function o(e,t,n){let f="",r=0;for(;r<n&&t+r<e.length;){const n=e[t+r];if(r++,0===n)break;n>=32&&(f+=String.fromCharCode(n))}return{str:f.trim(),end:t+r}}const a=[83,84,80,51];function s(e){return 0===e?125:Math.round(443250/e)}function i(e){if(e.byteLength<204)return!1;const f=new DataView(e);for(let t=0;t<4;t++)if(f.getUint8(t)!==a[t])return!1;const r=n(f,4),o=t(f,6),s=n(f,140),i=n(f,148);return!(r>2)&&(!(o>128)&&(0!==s&&50===i))}async function c(a,c){const l=new DataView(a),p=new Uint8Array(a);if(!i(a))throw new Error("STPParser: invalid STP3 file");const m=n(l,4),y=t(l,6),g=t(l,7),T=n(l,136),d=n(l,140),b=n(l,200),M=n(l,202),L=[];for(let e=0;e<128;e++)L.push(t(l,8+e));const S=L.slice(0,Math.max(1,y)),C=Math.max(1,T),P=s(d),v=new Map;let w=204,k=0;for(let e=0;e<b&&!(w+2>a.byteLength);e++){const e=n(l,w);if(w+=2,0===e||e>=1024)break;let s;if(2===m){if(w+4>a.byteLength)break;s=f(l,w)-2,w+=4}else s=M;const i=w,c=Math.min(i+s,a.byteLength);let u="",h="",y=i;if(m<2)h=r(l,y,31),y+=31,y+=1,u=r(l,y,30),y+=30;else{const e=o(p,y,257);h=e.str,y=e.end,y+=1;const t=o(p,y,31);u=t.str,y=t.end,(y-i)%2!=0&&y++}if(y+20>c){w=c;continue}const g=f(l,y),T=Math.min(t(l,y+4),64),d=f(l,y+6);let b=d+f(l,y+10),L=!1,S=d>=g?g>0?g-1:0:d;b>g&&(b=g),S>b?(S=0,b=0):b>S&&(L=!0);const C=u||h||`Sample ${e}`;if(v.set(e,{index:e,name:C,length:g,volume:T,loopStart:S,loopEnd:b,hasLoop:L}),e>k&&(k=e),w=c,m>=1){if(w+2>a.byteLength)continue;const e=n(l,w);w+=2;const t=8*e;if(w+t>a.byteLength)break;w+=t}}const $=[],I=new Map;let D=4;if(0===m){if(w+2>a.byteLength)return function(e,t,n,f,r){const o=[];for(let s=1;s<=r;s++){const e=f.get(s);o.push({id:s,name:e?.name??`Sample ${s}`,type:"sample",synthType:"Sampler",effects:[],volume:-60,pan:0})}const a=h(e,4);return{name:e.replace(/\.[^/.]+$/,""),format:"MOD",patterns:[a],instruments:o,songPositions:[0],songLength:1,restartPosition:0,numChannels:4,initialSpeed:t,initialBPM:n,linearPeriods:!1}}(c,C,P,v,k);const e=n(l,w);w+=2;const t=g>0?g:64;for(let n=0;n<e;n++){const f=D*t*4;if(w+f>a.byteLength)break;const r=u(l,w,D,t);w+=f,I.set(n,$.length),$.push({id:`pattern-${n}`,name:`Pattern ${n}`,length:t,channels:r,importMetadata:{sourceFormat:"STP",sourceFile:c,importedAt:(new Date).toISOString(),originalChannelCount:D,originalPatternCount:e,originalInstrumentCount:k}})}}else{const e=w;let t=e,r=4;for(;t+6<=a.byteLength;){const e=n(l,t);if(t+=2,65535===e)break;const f=n(l,t);t+=2;const o=n(l,t);if(t+=2,o>r&&(r=o),o>256||f>1024)break;t+=o*f*4}D=Math.min(r,32),w=e;let o=0;for(;w+6<=a.byteLength;){const e=n(l,w);if(w+=2,65535===e)break;const t=n(l,w);w+=2;const f=n(l,w);if(w+=2,f>256||t>1024)break;const r=f*t*4;if(w+r>a.byteLength)break;const s=u(l,w,f,t);w+=r,o++,I.set(e,$.length),$.push({id:`pattern-${e}`,name:`Pattern ${e}`,length:t,channels:s,importMetadata:{sourceFormat:"STP",sourceFile:c,importedAt:(new Date).toISOString(),originalChannelCount:f,originalPatternCount:o,originalInstrumentCount:k}})}for(;w+4<=a.byteLength;){if(65535===n(l,w)){w+=2;break}if(w+=2,w+=2,w+4>a.byteLength)break;const e=f(l,w);if(w+=4,w+e>a.byteLength)break;w+=e}w+=34,w>a.byteLength&&(w=a.byteLength)}const x=[];for(const e of S){const t=I.get(e);void 0!==t&&x.push(t)}0===x.length&&$.length>0&&x.push(0);const A=[];for(let t=1;t<=k;t++){const n=v.get(t),f=t;if(!n||0===n.length){A.push({id:f,name:n?.name??`Sample ${f}`,type:"sample",synthType:"Sampler",effects:[],volume:-60,pan:0});continue}if(w+n.length>a.byteLength){A.push({id:f,name:n.name,type:"sample",synthType:"Sampler",effects:[],volume:-60,pan:0}),w+=Math.min(n.length,a.byteLength-w);continue}const r=p.slice(w,w+n.length);w+=n.length,A.push(e(f,n.name,r,n.volume,8287,n.loopStart,n.hasLoop?n.loopEnd:0))}return{name:c.replace(/\.[^/.]+$/,""),format:"MOD",patterns:$.length>0?$:[h(c,D)],instruments:A,songPositions:x.length>0?x:[0],songLength:x.length,restartPosition:0,numChannels:D,initialSpeed:C,initialBPM:P,linearPeriods:!1}}function u(e,n,f,r,o,a,s,i){const c=[];for(let u=0;u<f;u++){const o=[];for(let a=0;a<r;a++){const r=n+4*(a*f+u);if(r+4>e.byteLength){o.push(p());continue}const s=t(e,r),i=t(e,r+1),c=t(e,r+2),h=t(e,r+3),m=i>0?25+i:0,{effTyp:y,eff:g}=l(c,h);o.push({note:m,instrument:s,volume:0,effTyp:y,eff:g,effTyp2:0,eff2:0})}c.push({id:`channel-${u}`,name:`Channel ${u+1}`,muted:!1,solo:!1,collapsed:!1,volume:100,pan:u%2==0?-50:50,instrumentId:null,color:null,rows:o})}return c}function l(e,t){if(!(240&~e)){const n=(15&e)<<8|t;if(n>0){return{effTyp:15,eff:Math.min(255,Math.max(1,s(n)))}}return{effTyp:0,eff:0}}const n=-(t>>4&15)+(15&t),f=n>0?n<<4&255:255&-n;switch(e){case 0:return t?{effTyp:0,eff:t}:{effTyp:0,eff:0};case 1:return t?{effTyp:1,eff:t}:{effTyp:0,eff:0};case 2:return t?{effTyp:2,eff:t}:{effTyp:0,eff:0};case 3:case 5:return{effTyp:1,eff:t};case 4:case 6:return{effTyp:2,eff:t};case 7:return{effTyp:16,eff:Math.min(t,64)};case 8:case 11:return n<0?{effTyp:10,eff:15&-n}:n>0?{effTyp:10,eff:n<<4&255}:{effTyp:0,eff:0};case 9:return{effTyp:14,eff:16|Math.min(t,15)};case 10:return{effTyp:14,eff:32|Math.min(t,15)};case 12:return{effTyp:12,eff:Math.min(t,64)};case 13:return n<0?{effTyp:10,eff:15&f}:n>0?{effTyp:10,eff:240&f}:{effTyp:0,eff:0};case 14:return{effTyp:14,eff:t?0:1};case 15:return{effTyp:15,eff:t>>4};case 16:return{effTyp:4,eff:t};case 17:return{effTyp:7,eff:t};case 18:return{effTyp:13,eff:0};case 19:return{effTyp:3,eff:t};case 20:return{effTyp:11,eff:t};case 22:case 23:case 24:case 25:default:return{effTyp:0,eff:0};case 29:return n<0?{effTyp:14,eff:176|15&-n}:n>0?{effTyp:14,eff:160|15&n}:{effTyp:0,eff:0};case 32:return 240&t?{effTyp:10,eff:t>>4}:{effTyp:14,eff:192|15&t};case 33:return{effTyp:14,eff:208|Math.min(t,15)};case 34:return{effTyp:14,eff:144|Math.min(t,15)};case 73:return{effTyp:9,eff:t};case 78:return 96==(240&t)||224==(240&t)?{effTyp:14,eff:t}:{effTyp:0,eff:0};case 79:return{effTyp:15,eff:t}}}function p(){return{note:0,instrument:0,volume:0,effTyp:0,eff:0,effTyp2:0,eff2:0}}function h(e,t){return{id:"pattern-0",name:"Pattern 0",length:64,channels:Array.from({length:t},(e,t)=>({id:`channel-${t}`,name:`Channel ${t+1}`,muted:!1,solo:!1,collapsed:!1,volume:100,pan:t%2==0?-50:50,instrumentId:null,color:null,rows:Array.from({length:64},()=>({note:0,instrument:0,volume:0,effTyp:0,eff:0,effTyp2:0,eff2:0}))})),importMetadata:{sourceFormat:"STP",sourceFile:e,importedAt:(new Date).toISOString(),originalChannelCount:t,originalPatternCount:0,originalInstrumentCount:0}}}export{i as isSTPFormat,c as parseSTPFile};
