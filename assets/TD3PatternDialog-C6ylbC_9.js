import{bJ as e,b as t,s,bK as o,j as r,bL as i,u as n}from"./index-zx6LJBPK.js";import{r as a}from"./vendor-utils-XMmR-oGw.js";import{createDefaultTB303Instrument as l}from"./instrumentFactory-CRsYYbpw.js";import{suggestBaseOctave as m,validatePatternForTD3Export as c,trackerPatternToTD3Steps as d,td3StepsToTrackerCells as u}from"./TD3PatternTranslator-RYXvH-yI.js";import{parseTD3File as p}from"./TD3PatternLoader-C1bZAG-1.js";import{X as D,a6 as x,a1 as N,ab as b,I as v,F as g,am as f,an as E}from"./vendor-ui-uomqNFY-.js";import"./vendor-react-DkDaD07v.js";import"./vendor-tone-CADp_hfL.js";function h(e){if(!e.note)return 0;const{value:t,octave:s,upperC:o}=e.note;let r=12+t+12*s;return o&&(r|=128),r}function V(t){const s=Math.max(0,Math.min(3,t.group)),o=Math.max(0,Math.min(15,t.pattern)),r=t.steps.slice(0,16);for(;r.length<16;)r.push({note:null,accent:!1,slide:!1,tie:!1});const i=function(e){const t=new Uint8Array(32);for(let s=0;s<16;s++){const o=h(e[s]||{note:null});t[2*s]=o>>4&15,t[2*s+1]=15&o}return t}(r),n=function(e){const t=new Uint8Array(32);for(let s=0;s<16;s++){const o=e[s]||{accent:!1};t[2*s]=0,t[2*s+1]=o.accent?1:0}return t}(r),a=function(e){const t=new Uint8Array(32);for(let s=0;s<16;s++){const o=e[s]||{slide:!1};t[2*s]=0,t[2*s+1]=o.slide?1:0}return t}(r),l=new Uint8Array([0,0]),m=function(e){const t=Math.max(1,Math.min(16,e));return new Uint8Array([t>>4&15,15&t])}(t.activeSteps),c=new Uint8Array([0,0]),d=function(e){let t=0;for(let s=0;s<16;s++){const o=e[s];o?.tie&&(t|=1<<s)}return new Uint8Array([t>>4&15,15&t,t>>12&15,t>>8&15])}(r),u=function(e){let t=0;for(let s=0;s<16;s++){const o=e[s];o?.note||(t|=1<<s)}return new Uint8Array([t>>4&15,15&t,t>>12&15,t>>8&15])}(r),p=e.HEADER.length,D=new Uint8Array(p+115+1);let x=0;return D.set(e.HEADER,x),x+=e.HEADER.length,D[x++]=e.CMD_SEND_PATTERN,D[x++]=s,D[x++]=o,D[x++]=0,D[x++]=1,D.set(i,x),x+=i.length,D.set(n,x),x+=n.length,D.set(a,x),x+=a.length,D.set(l,x),x+=l.length,D.set(m,x),x+=m.length,D.set(c,x),x+=c.length,D.set(d,x),x+=d.length,D.set(u,x),x+=u.length,D[x]=e.FOOTER,D}function C(e,t){return`${["A","B","C","D"][e]||"?"}${t<8?"A":"B"}${t%8+1}`}function T(e,t){const s=e<<4|t;if(0===s)return null;const o=!!(128&s),r=(127&s)-12;if(r<0)return null;const i=Math.floor(r/12),n=r%12;return{value:n,octave:Math.min(i,2),upperC:o&&0===n}}function y(e,t){const s=[];for(let o=0;o<16;o++)s.push(0!==e[t+2*o+1]);return s}function j(t){const s=function(t){if(t.length<e.HEADER.length+5)return{valid:!1,error:"Message too short"};for(let o=0;o<e.HEADER.length;o++)if(t[o]!==e.HEADER[o])return{valid:!1,error:"Invalid TD-3 header"};const s=t[e.HEADER.length];return s!==e.CMD_SEND_PATTERN?{valid:!1,error:`Invalid command: expected ${e.CMD_SEND_PATTERN}, got ${s}`}:t[t.length-1]!==e.FOOTER?{valid:!1,error:"Invalid SysEx footer"}:{valid:!0}}(t);if(!s.valid)return null;const o=e.HEADER.length+1,r=t[o],i=t[o+1],n=function(e,t){const s=[];for(let o=0;o<16;o++){const r=e[t+2*o],i=e[t+2*o+1];s.push(T(r,i))}return s}(t,o+4),a=y(t,o+36),l=y(t,o+68),m=0!==t[o+101],c=function(e,t){return e[t]<<4|e[t+1]}(t,o+102),d=function(e,t){const s=e[t+1]|e[t]<<4|e[t+3]<<8|e[t+2]<<12,o=[];for(let r=0;r<16;r++)o.push(!!(s&1<<r));return o}(t,o+106),u=[];for(let e=0;e<16;e++)u.push({note:n[e],accent:a[e],slide:l[e],tie:d[e]});return{group:r,pattern:i,steps:u,triplet:m,activeSteps:Math.min(16,Math.max(1,c))}}function P(e){let t=0,s=0;for(let o=0;o<8;o++)e[o]&&(t|=1<<o);for(let o=8;o<16;o++)e[o]&&(s|=1<<o-8);return new Uint8Array([t>>4&15,15&t,s>>4&15,15&s])}const U=["A","B","C","D"],O=({isOpen:h,onClose:T})=>{const[y,O]=a.useState("export"),[B,L]=a.useState(0),[X,w]=a.useState(0),[k,A]=a.useState(0),[S,R]=a.useState(2),[M,I]=a.useState(!1),[H,z]=a.useState(!1),[F,$]=a.useState(null),[q,_]=a.useState(null),[J,Q]=a.useState([]),G=a.useRef(null),K=a.useRef(null),{selectedOutputId:W,selectedInputId:Y}=t(),{patterns:Z,currentPatternIndex:ee,cursor:te,setCell:se}=s(),oe=Z[ee],re=oe?.channels||[];a.useEffect(()=>{if(h&&($(null),_(null),Q([]),A(te.channelIndex),oe&&oe.channels[te.channelIndex])){const e=oe.channels[te.channelIndex].rows;R(m(e))}},[h,te.channelIndex,oe]),a.useEffect(()=>()=>{null!==G.current&&(clearTimeout(G.current),G.current=null)},[]),a.useEffect(()=>{if(!h||"import"!==y||!H)return;const t=o(),s=t=>{if("sysex"===t.type&&function(t){if(t.length<e.HEADER.length+2)return!1;for(let s=0;s<e.HEADER.length;s++)if(t[s]!==e.HEADER[s])return!1;return t[e.HEADER.length]===e.CMD_SEND_PATTERN}(t.data)){const e=j(t.data);e&&(null!==G.current&&(clearTimeout(G.current),G.current=null),_(e),z(!1))}};return t.addMessageHandler(s),()=>t.removeMessageHandler(s)},[h,y,H]);const ie=a.useCallback(()=>oe&&oe.channels[k]?oe.channels[k].rows:[],[oe,k]),ne=c(ie(),S);return h?r.jsxDEV("div",{className:"fixed inset-0 bg-black/60 flex items-center justify-center z-50 animate-fade-in",children:r.jsxDEV("div",{className:"bg-dark-bgSecondary border border-dark-border rounded-lg shadow-xl w-[480px] max-h-[80vh] overflow-hidden animate-slide-in-up",children:[r.jsxDEV("div",{className:"flex items-center justify-between px-4 py-3 border-b border-dark-border",children:[r.jsxDEV("h2",{className:"text-lg font-bold text-text-primary",children:"TD-3 Pattern Transfer"},void 0,!1,{fileName:"/Users/spot/Code/DEViLBOX/src/components/midi/TD3PatternDialog.tsx",lineNumber:359,columnNumber:11},void 0),r.jsxDEV("button",{onClick:T,className:"p-1 rounded hover:bg-dark-bgHover text-text-muted hover:text-text-primary transition-colors",children:r.jsxDEV(D,{size:18},void 0,!1,{fileName:"/Users/spot/Code/DEViLBOX/src/components/midi/TD3PatternDialog.tsx",lineNumber:364,columnNumber:13},void 0)},void 0,!1,{fileName:"/Users/spot/Code/DEViLBOX/src/components/midi/TD3PatternDialog.tsx",lineNumber:360,columnNumber:11},void 0)]},void 0,!0,{fileName:"/Users/spot/Code/DEViLBOX/src/components/midi/TD3PatternDialog.tsx",lineNumber:358,columnNumber:9},void 0),r.jsxDEV("div",{className:"flex border-b border-dark-border",children:[r.jsxDEV("button",{onClick:()=>O("export"),className:"flex-1 px-4 py-2 text-sm font-medium transition-colors flex items-center justify-center gap-2\n              "+("export"===y?"text-text-primary border-b-2 border-accent-primary bg-dark-bgActive":"text-text-secondary hover:text-text-primary"),children:[r.jsxDEV(x,{size:14},void 0,!1,{fileName:"/Users/spot/Code/DEViLBOX/src/components/midi/TD3PatternDialog.tsx",lineNumber:378,columnNumber:13},void 0),"Export"]},void 0,!0,{fileName:"/Users/spot/Code/DEViLBOX/src/components/midi/TD3PatternDialog.tsx",lineNumber:370,columnNumber:11},void 0),r.jsxDEV("button",{onClick:()=>O("import"),className:"flex-1 px-4 py-2 text-sm font-medium transition-colors flex items-center justify-center gap-2\n              "+("import"===y?"text-text-primary border-b-2 border-accent-primary bg-dark-bgActive":"text-text-secondary hover:text-text-primary"),children:[r.jsxDEV(N,{size:14},void 0,!1,{fileName:"/Users/spot/Code/DEViLBOX/src/components/midi/TD3PatternDialog.tsx",lineNumber:389,columnNumber:13},void 0),"Import"]},void 0,!0,{fileName:"/Users/spot/Code/DEViLBOX/src/components/midi/TD3PatternDialog.tsx",lineNumber:381,columnNumber:11},void 0)]},void 0,!0,{fileName:"/Users/spot/Code/DEViLBOX/src/components/midi/TD3PatternDialog.tsx",lineNumber:369,columnNumber:9},void 0),r.jsxDEV("div",{className:"p-4 space-y-4 overflow-y-auto max-h-[400px]",children:[!W&&"export"===y&&r.jsxDEV("div",{className:"flex items-center gap-2 p-3 bg-accent-warning/10 border border-accent-warning/30 rounded-md",children:[r.jsxDEV(b,{size:16,className:"text-accent-warning flex-shrink-0"},void 0,!1,{fileName:"/Users/spot/Code/DEViLBOX/src/components/midi/TD3PatternDialog.tsx",lineNumber:399,columnNumber:15},void 0),r.jsxDEV("span",{className:"text-sm text-text-secondary",children:"No MIDI output selected. You can still export to file."},void 0,!1,{fileName:"/Users/spot/Code/DEViLBOX/src/components/midi/TD3PatternDialog.tsx",lineNumber:400,columnNumber:15},void 0)]},void 0,!0,{fileName:"/Users/spot/Code/DEViLBOX/src/components/midi/TD3PatternDialog.tsx",lineNumber:398,columnNumber:13},void 0),(!W||!Y)&&"import"===y&&!q&&r.jsxDEV("div",{className:"flex items-center gap-2 p-3 bg-dark-bgTertiary border border-dark-border rounded-md",children:[r.jsxDEV(b,{size:16,className:"text-text-muted flex-shrink-0"},void 0,!1,{fileName:"/Users/spot/Code/DEViLBOX/src/components/midi/TD3PatternDialog.tsx",lineNumber:408,columnNumber:15},void 0),r.jsxDEV("span",{className:"text-sm text-text-muted",children:'MIDI transfer requires hardware. Use "Load File" for .sqs or .json patterns.'},void 0,!1,{fileName:"/Users/spot/Code/DEViLBOX/src/components/midi/TD3PatternDialog.tsx",lineNumber:409,columnNumber:15},void 0)]},void 0,!0,{fileName:"/Users/spot/Code/DEViLBOX/src/components/midi/TD3PatternDialog.tsx",lineNumber:407,columnNumber:13},void 0),r.jsxDEV("div",{className:"grid grid-cols-2 gap-4",children:[r.jsxDEV("div",{children:[r.jsxDEV("label",{className:"block text-xs font-medium text-text-muted uppercase tracking-wide mb-1",children:"Group"},void 0,!1,{fileName:"/Users/spot/Code/DEViLBOX/src/components/midi/TD3PatternDialog.tsx",lineNumber:418,columnNumber:15},void 0),r.jsxDEV("div",{className:"flex gap-1",children:U.map((e,t)=>r.jsxDEV("button",{onClick:()=>L(t),className:"flex-1 py-2 rounded font-medium text-sm transition-colors\n                      "+(B===t?"bg-accent-primary text-text-inverse":"bg-dark-bgTertiary text-text-secondary hover:text-text-primary hover:bg-dark-bgActive"),children:e},e,!1,{fileName:"/Users/spot/Code/DEViLBOX/src/components/midi/TD3PatternDialog.tsx",lineNumber:423,columnNumber:19},void 0))},void 0,!1,{fileName:"/Users/spot/Code/DEViLBOX/src/components/midi/TD3PatternDialog.tsx",lineNumber:421,columnNumber:15},void 0)]},void 0,!0,{fileName:"/Users/spot/Code/DEViLBOX/src/components/midi/TD3PatternDialog.tsx",lineNumber:417,columnNumber:13},void 0),r.jsxDEV("div",{children:[r.jsxDEV("label",{className:"block text-xs font-medium text-text-muted uppercase tracking-wide mb-1",children:"Pattern (1-16)"},void 0,!1,{fileName:"/Users/spot/Code/DEViLBOX/src/components/midi/TD3PatternDialog.tsx",lineNumber:439,columnNumber:15},void 0),r.jsxDEV("select",{value:X,onChange:e=>w(Number(e.target.value)),className:"w-full px-3 py-2 rounded bg-dark-bgTertiary border border-dark-border text-text-primary",children:Array.from({length:16},(e,t)=>r.jsxDEV("option",{value:t,children:t<8?`A${t+1}`:"B"+(t-7)},t,!1,{fileName:"/Users/spot/Code/DEViLBOX/src/components/midi/TD3PatternDialog.tsx",lineNumber:448,columnNumber:19},void 0))},void 0,!1,{fileName:"/Users/spot/Code/DEViLBOX/src/components/midi/TD3PatternDialog.tsx",lineNumber:442,columnNumber:15},void 0)]},void 0,!0,{fileName:"/Users/spot/Code/DEViLBOX/src/components/midi/TD3PatternDialog.tsx",lineNumber:438,columnNumber:13},void 0)]},void 0,!0,{fileName:"/Users/spot/Code/DEViLBOX/src/components/midi/TD3PatternDialog.tsx",lineNumber:416,columnNumber:11},void 0),"export"===y&&r.jsxDEV(r.Fragment,{children:[r.jsxDEV("div",{className:"grid grid-cols-2 gap-4",children:[r.jsxDEV("div",{children:[r.jsxDEV("label",{className:"block text-xs font-medium text-text-muted uppercase tracking-wide mb-1",children:"Source Channel"},void 0,!1,{fileName:"/Users/spot/Code/DEViLBOX/src/components/midi/TD3PatternDialog.tsx",lineNumber:461,columnNumber:19},void 0),r.jsxDEV("select",{value:k,onChange:e=>A(Number(e.target.value)),className:"w-full px-3 py-2 rounded bg-dark-bgTertiary border border-dark-border text-text-primary",children:re.map((e,t)=>r.jsxDEV("option",{value:t,children:e.name||`Channel ${t+1}`},t,!1,{fileName:"/Users/spot/Code/DEViLBOX/src/components/midi/TD3PatternDialog.tsx",lineNumber:470,columnNumber:23},void 0))},void 0,!1,{fileName:"/Users/spot/Code/DEViLBOX/src/components/midi/TD3PatternDialog.tsx",lineNumber:464,columnNumber:19},void 0)]},void 0,!0,{fileName:"/Users/spot/Code/DEViLBOX/src/components/midi/TD3PatternDialog.tsx",lineNumber:460,columnNumber:17},void 0),r.jsxDEV("div",{children:[r.jsxDEV("label",{className:"block text-xs font-medium text-text-muted uppercase tracking-wide mb-1",children:"Base Octave"},void 0,!1,{fileName:"/Users/spot/Code/DEViLBOX/src/components/midi/TD3PatternDialog.tsx",lineNumber:478,columnNumber:19},void 0),r.jsxDEV("select",{value:S,onChange:e=>R(Number(e.target.value)),className:"w-full px-3 py-2 rounded bg-dark-bgTertiary border border-dark-border text-text-primary",children:[r.jsxDEV("option",{value:1,children:"C1 - C4"},void 0,!1,{fileName:"/Users/spot/Code/DEViLBOX/src/components/midi/TD3PatternDialog.tsx",lineNumber:486,columnNumber:21},void 0),r.jsxDEV("option",{value:2,children:"C2 - C5"},void 0,!1,{fileName:"/Users/spot/Code/DEViLBOX/src/components/midi/TD3PatternDialog.tsx",lineNumber:487,columnNumber:21},void 0),r.jsxDEV("option",{value:3,children:"C3 - C6"},void 0,!1,{fileName:"/Users/spot/Code/DEViLBOX/src/components/midi/TD3PatternDialog.tsx",lineNumber:488,columnNumber:21},void 0),r.jsxDEV("option",{value:4,children:"C4 - C7"},void 0,!1,{fileName:"/Users/spot/Code/DEViLBOX/src/components/midi/TD3PatternDialog.tsx",lineNumber:489,columnNumber:21},void 0)]},void 0,!0,{fileName:"/Users/spot/Code/DEViLBOX/src/components/midi/TD3PatternDialog.tsx",lineNumber:481,columnNumber:19},void 0)]},void 0,!0,{fileName:"/Users/spot/Code/DEViLBOX/src/components/midi/TD3PatternDialog.tsx",lineNumber:477,columnNumber:17},void 0)]},void 0,!0,{fileName:"/Users/spot/Code/DEViLBOX/src/components/midi/TD3PatternDialog.tsx",lineNumber:459,columnNumber:15},void 0),(ne.warnings.length>0||J.length>0)&&r.jsxDEV("div",{className:"space-y-1",children:[...ne.warnings,...J].map((e,t)=>r.jsxDEV("div",{className:"flex items-center gap-2 text-xs text-accent-warning",children:[r.jsxDEV(b,{size:12},void 0,!1,{fileName:"/Users/spot/Code/DEViLBOX/src/components/midi/TD3PatternDialog.tsx",lineNumber:502,columnNumber:23},void 0),r.jsxDEV("span",{children:e},void 0,!1,{fileName:"/Users/spot/Code/DEViLBOX/src/components/midi/TD3PatternDialog.tsx",lineNumber:503,columnNumber:23},void 0)]},t,!0,{fileName:"/Users/spot/Code/DEViLBOX/src/components/midi/TD3PatternDialog.tsx",lineNumber:498,columnNumber:21},void 0))},void 0,!1,{fileName:"/Users/spot/Code/DEViLBOX/src/components/midi/TD3PatternDialog.tsx",lineNumber:496,columnNumber:17},void 0),r.jsxDEV("div",{className:"text-xs text-text-muted",children:r.jsxDEV("p",{children:["Exporting ",Math.min(16,ie().length)," steps from"," ",re[k]?.name||`Channel ${k+1}`," to"," ",r.jsxDEV("span",{className:"text-text-primary font-mono",children:C(B,X)},void 0,!1,{fileName:"/Users/spot/Code/DEViLBOX/src/components/midi/TD3PatternDialog.tsx",lineNumber:514,columnNumber:19},void 0)]},void 0,!0,{fileName:"/Users/spot/Code/DEViLBOX/src/components/midi/TD3PatternDialog.tsx",lineNumber:511,columnNumber:17},void 0)},void 0,!1,{fileName:"/Users/spot/Code/DEViLBOX/src/components/midi/TD3PatternDialog.tsx",lineNumber:510,columnNumber:15},void 0)]},void 0,!0,{fileName:"/Users/spot/Code/DEViLBOX/src/components/midi/TD3PatternDialog.tsx",lineNumber:458,columnNumber:13},void 0),"import"===y&&q&&r.jsxDEV("div",{className:"p-3 bg-dark-bgTertiary rounded-md border border-accent-primary/20",children:[r.jsxDEV("h4",{className:"text-sm font-medium text-text-primary mb-2 flex items-center gap-2",children:[r.jsxDEV(v,{size:14,className:"text-accent-success"},void 0,!1,{fileName:"/Users/spot/Code/DEViLBOX/src/components/midi/TD3PatternDialog.tsx",lineNumber:526,columnNumber:17},void 0),"Pattern Loaded"]},void 0,!0,{fileName:"/Users/spot/Code/DEViLBOX/src/components/midi/TD3PatternDialog.tsx",lineNumber:525,columnNumber:15},void 0),r.jsxDEV("p",{className:"text-xs text-text-muted",children:[q.activeSteps," active steps detected."]},void 0,!0,{fileName:"/Users/spot/Code/DEViLBOX/src/components/midi/TD3PatternDialog.tsx",lineNumber:529,columnNumber:15},void 0),r.jsxDEV("div",{className:"mt-3",children:[r.jsxDEV("label",{className:"block text-xs font-medium text-text-muted uppercase tracking-wide mb-1",children:"Target Channel"},void 0,!1,{fileName:"/Users/spot/Code/DEViLBOX/src/components/midi/TD3PatternDialog.tsx",lineNumber:534,columnNumber:17},void 0),r.jsxDEV("select",{value:k,onChange:e=>A(Number(e.target.value)),className:"w-full px-3 py-2 rounded bg-dark-bg border border-dark-border text-text-primary",children:re.map((e,t)=>r.jsxDEV("option",{value:t,children:e.name||`Channel ${t+1}`},t,!1,{fileName:"/Users/spot/Code/DEViLBOX/src/components/midi/TD3PatternDialog.tsx",lineNumber:543,columnNumber:21},void 0))},void 0,!1,{fileName:"/Users/spot/Code/DEViLBOX/src/components/midi/TD3PatternDialog.tsx",lineNumber:537,columnNumber:17},void 0)]},void 0,!0,{fileName:"/Users/spot/Code/DEViLBOX/src/components/midi/TD3PatternDialog.tsx",lineNumber:533,columnNumber:15},void 0)]},void 0,!0,{fileName:"/Users/spot/Code/DEViLBOX/src/components/midi/TD3PatternDialog.tsx",lineNumber:524,columnNumber:13},void 0),F&&r.jsxDEV("div",{className:"flex items-center gap-2 p-3 rounded-md "+(F.success?"bg-accent-success/10 border border-accent-success/30":"bg-accent-error/10 border border-accent-error/30"),children:[F.success?r.jsxDEV(v,{size:16,className:"text-accent-success"},void 0,!1,{fileName:"/Users/spot/Code/DEViLBOX/src/components/midi/TD3PatternDialog.tsx",lineNumber:562,columnNumber:17},void 0):r.jsxDEV(b,{size:16,className:"text-accent-error"},void 0,!1,{fileName:"/Users/spot/Code/DEViLBOX/src/components/midi/TD3PatternDialog.tsx",lineNumber:564,columnNumber:17},void 0),r.jsxDEV("span",{className:"text-sm text-text-secondary",children:F.message},void 0,!1,{fileName:"/Users/spot/Code/DEViLBOX/src/components/midi/TD3PatternDialog.tsx",lineNumber:566,columnNumber:15},void 0)]},void 0,!0,{fileName:"/Users/spot/Code/DEViLBOX/src/components/midi/TD3PatternDialog.tsx",lineNumber:554,columnNumber:13},void 0)]},void 0,!0,{fileName:"/Users/spot/Code/DEViLBOX/src/components/midi/TD3PatternDialog.tsx",lineNumber:395,columnNumber:9},void 0),r.jsxDEV("div",{className:"flex flex-wrap items-center justify-between gap-2 px-4 py-3 border-t border-dark-border bg-dark-bgTertiary",children:[r.jsxDEV("div",{className:"flex gap-2",children:["import"===y&&r.jsxDEV(r.Fragment,{children:[r.jsxDEV("input",{ref:K,type:"file",accept:".json,.sqs",className:"hidden",onChange:async e=>{const t=e.target.files?.[0];if(t){try{const e=await t.arrayBuffer();if(t.name.toLowerCase().endsWith(".sqs")){const t=await p(e);if(t.patterns.length>0){const e=t.patterns[0];_({group:0,pattern:0,steps:e.steps,triplet:e.triplet||!1,activeSteps:e.length}),$({success:!0,message:`Loaded pattern "${e.name}" from .sqs file`})}}else{const t=(new TextDecoder).decode(e),s=JSON.parse(t),o=s.steps.map(e=>({note:null===e.note?null:{value:e.note,octave:e.octave,upperC:e.upperC||!1},flag1:e.accent?1:void 0,flag2:e.slide?2:void 0,tie:e.tie}));_({group:s.group||0,pattern:s.pattern||0,steps:o,triplet:s.triplet||!1,activeSteps:s.activeSteps||16}),$({success:!0,message:"Loaded pattern from JSON file"})}}catch{$({success:!1,message:"Failed to parse pattern file"})}K.current&&(K.current.value="")}}},void 0,!1,{fileName:"/Users/spot/Code/DEViLBOX/src/components/midi/TD3PatternDialog.tsx",lineNumber:576,columnNumber:17},void 0),r.jsxDEV("button",{onClick:()=>K.current?.click(),className:"px-3 py-2 text-xs font-bold bg-dark-bg border border-dark-border text-text-secondary hover:text-text-primary rounded transition-colors flex items-center gap-2",children:[r.jsxDEV(g,{size:14},void 0,!1,{fileName:"/Users/spot/Code/DEViLBOX/src/components/midi/TD3PatternDialog.tsx",lineNumber:587,columnNumber:19},void 0),"LOAD FILE"]},void 0,!0,{fileName:"/Users/spot/Code/DEViLBOX/src/components/midi/TD3PatternDialog.tsx",lineNumber:583,columnNumber:17},void 0)]},void 0,!0,{fileName:"/Users/spot/Code/DEViLBOX/src/components/midi/TD3PatternDialog.tsx",lineNumber:575,columnNumber:15},void 0),"export"===y&&r.jsxDEV(r.Fragment,{children:[r.jsxDEV("button",{onClick:()=>{const e=ie(),{steps:t}=d(e,S),s={name:`Pattern ${C(B,X)}`,steps:t.map(e=>({note:e.note?e.note.value:null,octave:e.note?e.note.octave:0,upperC:!!e.note&&e.note.upperC,flag1:e.accent?1:void 0,flag2:e.slide?2:void 0,tie:e.tie})),activeSteps:Math.min(16,e.length)},o=new Blob([JSON.stringify(s,null,2)],{type:"application/json"});i.saveAs(o,`td3-pattern-${C(B,X).replace(" ","")}.json`),$({success:!0,message:"Pattern exported to JSON file"})},className:"px-3 py-2 text-xs font-bold bg-dark-bg border border-dark-border text-text-secondary hover:text-text-primary rounded transition-colors flex items-center gap-2",children:[r.jsxDEV(f,{size:14},void 0,!1,{fileName:"/Users/spot/Code/DEViLBOX/src/components/midi/TD3PatternDialog.tsx",lineNumber:598,columnNumber:19},void 0),"SAVE AS JSON"]},void 0,!0,{fileName:"/Users/spot/Code/DEViLBOX/src/components/midi/TD3PatternDialog.tsx",lineNumber:594,columnNumber:17},void 0),r.jsxDEV("button",{onClick:()=>{const e=ie(),{steps:t}=d(e,S),s={group:B,pattern:X,steps:t,triplet:!1,activeSteps:Math.min(16,e.length)};try{const e=function(e){const t=new Uint8Array(146);new DataView(t.buffer).setUint32(0,597185654,!1);const s=new Uint8Array([0,0,0,8,0,84,0,68,0,45,0,51,0,0,0,10,0,49,0,46,0,51,0,46,0,55,0,0]);t.set(s,4),t[32]=0,t[33]=112,t[34]=0,t[35]=0;const o=36,r=Array(16).fill(!1),i=Array(16).fill(!1),n=[],a=[],l=[];for(let m=0;m<16;m++){const t=e.steps[m]||{note:null,accent:!1,slide:!1,tie:!1};if(m>0&&t.tie)r[m]=!1,i[m]=null===t.note;else{r[m]=!0,i[m]=null===t.note;let e=0;t.note&&(e=24+t.note.value+12*t.note.octave,t.note.upperC&&(e=60)),n.push(e),a.push(t.accent),l.push(t.slide)}}for(let m=0;m<16;m++){const e=n[m]||0;t[o+2*m]=e>>4&15,t[o+2*m+1]=15&e}for(let m=0;m<16;m++){const e=a[m]?1:0;t[68+2*m]=0,t[68+2*m+1]=e}for(let m=0;m<16;m++){const e=l[m]?1:0;t[100+2*m]=0,t[100+2*m+1]=e}return t[132]=0,t[133]=0,t[134]=0,t[135]=15&e.activeSteps,t.set(P(r),138),t.set(P(i),142),t}(s),t=new Blob([e.buffer],{type:"application/octet-stream"});i.saveAs(t,`td3-pattern-${C(B,X).replace(" ","")}.seq`),$({success:!0,message:"Pattern exported to .seq file"})}catch{$({success:!1,message:"Failed to export .seq file"})}},className:"px-3 py-2 text-xs font-bold bg-dark-bg border border-dark-border text-text-secondary hover:text-text-primary rounded transition-colors flex items-center gap-2",children:[r.jsxDEV(f,{size:14},void 0,!1,{fileName:"/Users/spot/Code/DEViLBOX/src/components/midi/TD3PatternDialog.tsx",lineNumber:605,columnNumber:19},void 0),"SAVE AS .SEQ"]},void 0,!0,{fileName:"/Users/spot/Code/DEViLBOX/src/components/midi/TD3PatternDialog.tsx",lineNumber:601,columnNumber:17},void 0)]},void 0,!0,{fileName:"/Users/spot/Code/DEViLBOX/src/components/midi/TD3PatternDialog.tsx",lineNumber:593,columnNumber:15},void 0)]},void 0,!0,{fileName:"/Users/spot/Code/DEViLBOX/src/components/midi/TD3PatternDialog.tsx",lineNumber:573,columnNumber:11},void 0),r.jsxDEV("div",{className:"flex gap-2",children:[r.jsxDEV("button",{onClick:T,className:"px-4 py-2 text-sm font-medium text-text-secondary hover:text-text-primary transition-colors",children:"Close"},void 0,!1,{fileName:"/Users/spot/Code/DEViLBOX/src/components/midi/TD3PatternDialog.tsx",lineNumber:613,columnNumber:13},void 0),"export"===y&&r.jsxDEV("button",{onClick:async()=>{if(!W)return;const e=ie(),{steps:t,warnings:s}=d(e,S);Q(s);const r=V({group:B,pattern:X,steps:t,activeSteps:Math.min(16,e.length)});I(!0),$(null);try{o().sendSysEx(r),$({success:!0,message:`Pattern sent to ${C(B,X)}`})}catch(i){$({success:!1,message:i instanceof Error?i.message:"Failed to send pattern"})}finally{I(!1)}},disabled:!W||M||!ne.valid,className:"px-4 py-2 text-sm font-medium bg-accent-primary text-text-inverse rounded hover:bg-accent-primary/90 transition-colors disabled:opacity-50 disabled:cursor-not-allowed flex items-center gap-2 shadow-glow-sm",children:M?r.jsxDEV(r.Fragment,{children:[r.jsxDEV(E,{size:14,className:"animate-spin"},void 0,!1,{fileName:"/Users/spot/Code/DEViLBOX/src/components/midi/TD3PatternDialog.tsx",lineNumber:628,columnNumber:21},void 0),"Sending..."]},void 0,!0,{fileName:"/Users/spot/Code/DEViLBOX/src/components/midi/TD3PatternDialog.tsx",lineNumber:627,columnNumber:19},void 0):r.jsxDEV(r.Fragment,{children:[r.jsxDEV(x,{size:14},void 0,!1,{fileName:"/Users/spot/Code/DEViLBOX/src/components/midi/TD3PatternDialog.tsx",lineNumber:633,columnNumber:21},void 0),"Send to TD-3"]},void 0,!0,{fileName:"/Users/spot/Code/DEViLBOX/src/components/midi/TD3PatternDialog.tsx",lineNumber:632,columnNumber:19},void 0)},void 0,!1,{fileName:"/Users/spot/Code/DEViLBOX/src/components/midi/TD3PatternDialog.tsx",lineNumber:621,columnNumber:15},void 0),"import"===y&&!q&&r.jsxDEV("button",{onClick:()=>{if(!W||!Y)return;const t=function(t,s){const o=Math.max(0,Math.min(3,t)),r=Math.max(0,Math.min(15,s)),i=new Uint8Array(e.HEADER.length+4);return i.set(e.HEADER,0),i[e.HEADER.length]=e.CMD_REQUEST_PATTERN,i[e.HEADER.length+1]=o,i[e.HEADER.length+2]=r,i[e.HEADER.length+3]=e.FOOTER,i}(B,X);z(!0),_(null),$(null);try{o().sendSysEx(t),null!==G.current&&clearTimeout(G.current),G.current=window.setTimeout(()=>{G.current=null,z(!1),$({success:!1,message:"No response from TD-3. Make sure it is connected and in the correct mode."})},5e3)}catch(s){z(!1),$({success:!1,message:s instanceof Error?s.message:"Failed to send request"})}},disabled:!W||!Y||H,className:"px-4 py-2 text-sm font-medium bg-accent-primary text-text-inverse rounded hover:bg-accent-primary/90 transition-colors disabled:opacity-50 disabled:cursor-not-allowed flex items-center gap-2",children:H?r.jsxDEV(r.Fragment,{children:[r.jsxDEV(E,{size:14,className:"animate-spin"},void 0,!1,{fileName:"/Users/spot/Code/DEViLBOX/src/components/midi/TD3PatternDialog.tsx",lineNumber:648,columnNumber:21},void 0),"Requesting..."]},void 0,!0,{fileName:"/Users/spot/Code/DEViLBOX/src/components/midi/TD3PatternDialog.tsx",lineNumber:647,columnNumber:19},void 0):r.jsxDEV(r.Fragment,{children:[r.jsxDEV(N,{size:14},void 0,!1,{fileName:"/Users/spot/Code/DEViLBOX/src/components/midi/TD3PatternDialog.tsx",lineNumber:653,columnNumber:21},void 0),"Request from TD-3"]},void 0,!0,{fileName:"/Users/spot/Code/DEViLBOX/src/components/midi/TD3PatternDialog.tsx",lineNumber:652,columnNumber:19},void 0)},void 0,!1,{fileName:"/Users/spot/Code/DEViLBOX/src/components/midi/TD3PatternDialog.tsx",lineNumber:641,columnNumber:15},void 0),"import"===y&&q&&r.jsxDEV("button",{onClick:()=>{if(!q)return;const{instruments:e,addInstrument:t}=n.getState();let s=e.find(e=>"TB303"===e.synthType);if(!s){const e=l();t(e),s=e}const o=e.findIndex(e=>e.id===s.id)+1,r=u(q.steps,S),i=Math.min(q.activeSteps,r.length);for(let n=0;n<i;n++){const e=r[n];se(k,n,{note:e.note,instrument:e.note?o:void 0,flag1:e.flag1,flag2:e.flag2})}$({success:!0,message:`Imported ${i} steps into channel ${k+1} with TB-303`}),_(null)},className:"px-4 py-2 text-sm font-medium bg-accent-success text-text-inverse rounded hover:bg-accent-success/90 transition-colors flex items-center gap-2 shadow-glow-sm",children:[r.jsxDEV(v,{size:14},void 0,!1,{fileName:"/Users/spot/Code/DEViLBOX/src/components/midi/TD3PatternDialog.tsx",lineNumber:665,columnNumber:17},void 0),"Insert into Pattern"]},void 0,!0,{fileName:"/Users/spot/Code/DEViLBOX/src/components/midi/TD3PatternDialog.tsx",lineNumber:661,columnNumber:15},void 0)]},void 0,!0,{fileName:"/Users/spot/Code/DEViLBOX/src/components/midi/TD3PatternDialog.tsx",lineNumber:612,columnNumber:11},void 0)]},void 0,!0,{fileName:"/Users/spot/Code/DEViLBOX/src/components/midi/TD3PatternDialog.tsx",lineNumber:572,columnNumber:9},void 0)]},void 0,!0,{fileName:"/Users/spot/Code/DEViLBOX/src/components/midi/TD3PatternDialog.tsx",lineNumber:356,columnNumber:7},void 0)},void 0,!1,{fileName:"/Users/spot/Code/DEViLBOX/src/components/midi/TD3PatternDialog.tsx",lineNumber:355,columnNumber:5},void 0):null};export{O as TD3PatternDialog};
