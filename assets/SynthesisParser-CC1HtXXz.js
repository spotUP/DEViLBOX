import{aB as t}from"./index-zx6LJBPK.js";import"./vendor-react-DkDaD07v.js";import"./vendor-utils-XMmR-oGw.js";import"./vendor-tone-CADp_hfL.js";import"./vendor-ui-uomqNFY-.js";const e=3546895,n=Math.round(e/1712);function o(t,e){return(t[e]<<8|t[e+1])>>>0}function s(t,e){return(t[e]<<24|t[e+1]<<16|t[e+2]<<8|t[e+3])>>>0}function r(t){return t<128?t:t-256}function a(t){return 0===t?0:t-49+37}function i(t,e,n){let o="";for(let s=0;s<n;s++){const n=t[e+s];if(0===n)break;o+=String.fromCharCode(n)}return o.trim()}function l(t){return!(t.length<204)&&(83===t[0]&&121===t[1]&&110===t[2]&&116===t[3]&&104===t[4]&&52===t[5]&&46===t[6]&&48===t[7]||!(t.length<8154)&&(83===t[7950]&&121===t[7951]&&110===t[7952]&&116===t[7953]&&104===t[7954]&&52===t[7955]&&46===t[7956]&&50===t[7957]))}function c(c,f){try{return function(c,f){if(!l(c))return null;const u=83===c[0]?0:7950;let h=u+8;const m=o(c,h);h+=2;const p=o(c,h);h+=2,h+=4;const g=c[h++],d=c[h++],y=c[h++],v=c[h++],w=c[h++],P=c[h++];h+=1,h+=13;const T=i(c,h,28);h+=28,h+=140;const S=[];for(let t=0;t<g;t++)h+=1,S.push(i(c,h,27)),h+=27;const A=[];for(let t=0;t<g;t++)A.push(s(c,h)),h+=4;h+=128*w,h+=256*P;const $=[];for(let t=0;t<y;t++){const t=c[h++],e=0!==c[h++],n=o(c,h);h+=2;const s=o(c,h);h+=2;const r=c[h++];h+=1,h+=1,h+=1,h+=2,h+=1,h+=1,h+=1,h+=1,h+=1,h+=1,h+=1,h+=1,h+=1,h+=1,h+=1,h+=1,h+=1,h+=1,h+=2,$.push({waveformNumber:t,synthesisEnabled:e,waveformLength:n,repeatLength:s,volume:r})}h+=256;const b=[];for(let t=0;t<v;t++){h+=4;const t=c[h++],e=c[h++],n=o(c,h);h+=2;const s=o(c,h);h+=2;const r=o(c,h);h+=2,h+=2,b.push({startSpeed:t,rowsPerTrack:e,firstPosition:n,lastPosition:s,restartPosition:r})}h+=14;const C=[];for(let t=0;t<d;t++)C.push(c.slice(h,h+256)),h+=256;const M=[];for(let t=0;t<m;t++){const t=[];for(let e=0;e<4;e++){const e=o(c,h);h+=2;const n=r(c[h++]),s=r(c[h++]);t.push({startTrackRow:e,soundTranspose:n,noteTranspose:s})}M.push(t)}const k=p+64,L=[];for(let t=0;t<k;t++){const t=c[h++],e=c[h++],n=c[h++],o=c[h++];L.push({note:t,instrument:e,arpeggio:(240&n)>>4,effect:15&n,effectArg:o})}const j=[];for(let t=0;t<g;t++){const e=A[t];j.push(e>0?c.slice(h,h+e):new Uint8Array(0)),h+=e}const I=b[0];if(!I)return null;const x=[];for(let o=0;o<y;o++){const s=$[o],r=o+1;if(s.synthesisEnabled){const e=s.waveformNumber;if(e<d){const o=C[e],a=s.waveformLength,i=s.repeatLength,l=s.volume;let c=0,f=0;0===i?(c=0,f=o.length):2===i?(c=0,f=0):(c=a,f=a+i),x.push(t(r,`Waveform ${e}`,o,l,n,c,f))}else x.push({id:r,name:`Instrument ${r}`,type:"synth",synthType:"Synth",effects:[],volume:0,pan:0,oscillator:{type:"sawtooth",detune:0,octave:0}})}else{const n=s.waveformNumber;if(n<g&&j[n].length>0){const o=j[n],a=s.volume,i=s.waveformLength,l=s.repeatLength;let c=0,f=0;const u=Math.round(e/1712);0===l?(c=0,f=o.length):2===l?(c=0,f=0):(c=i,f=i+l),x.push(t(r,S[n]||`Sample ${n}`,o,a,u,c,f))}else x.push({id:r,name:`Instrument ${r}`,type:"synth",synthType:"Synth",effects:[],volume:0,pan:0,oscillator:{type:"sawtooth",detune:0,octave:0}})}}const N=I.rowsPerTrack||16,B=I.firstPosition,E=[],F=[-50,50,50,-50];for(let t=0;t<m;t++){const e=M[t],n=Array.from({length:N},()=>Array.from({length:4},()=>({note:0,instrument:0,volume:0,effTyp:0,eff:0,effTyp2:0,eff2:0})));for(let t=0;t<4;t++){const o=e[t];let s=o.startTrackRow;for(let e=0;e<N&&!(s>=L.length);e++){const i=L[s++];let l=0,c=0,f=0,u=0;if(0!==i.note){const t=i.note+r(o.noteTranspose);l=a(Math.max(1,Math.min(108,t)))}switch(0!==i.instrument&&(c=i.instrument+r(o.soundTranspose),c<1&&(c=1),c>y&&(c=y)),i.effect){case 1:f=3,u=i.effectArg;break;case 8:f=15,u=i.effectArg;break;case 15:f=12,u=Math.min(64,i.effectArg)}n[e][t]={note:l,instrument:c,volume:0,effTyp:f,eff:u,effTyp2:0,eff2:0}}}E.push({id:`pattern-${t}`,name:`Pattern ${t}`,length:N,channels:Array.from({length:4},(t,e)=>({id:`channel-${e}`,name:`Channel ${e+1}`,muted:!1,solo:!1,collapsed:!1,volume:100,pan:F[e],instrumentId:null,color:null,rows:n.map(t=>t[e])})),importMetadata:{sourceFormat:"Synthesis",sourceFile:f,importedAt:(new Date).toISOString(),originalChannelCount:4,originalPatternCount:m,originalInstrumentCount:y}})}const R=[];for(let t=B;t<=I.lastPosition&&t<m;t++)R.push(t);if(0===R.length)for(let t=0;t<m;t++)R.push(t);const D=f.replace(/\.[^/.]+$/,"");return{name:T||D,format:"XM",patterns:E,instruments:x,songPositions:R,songLength:R.length,restartPosition:I.restartPosition<R.length?I.restartPosition:0,numChannels:4,initialSpeed:I.startSpeed||6,initialBPM:125}}(c,f)}catch{return null}}export{l as isSynthesisFormat,c as parseSynthesisFile};
