import{aB as t}from"./index-zx6LJBPK.js";import"./vendor-react-DkDaD07v.js";import"./vendor-utils-XMmR-oGw.js";import"./vendor-tone-CADp_hfL.js";import"./vendor-ui-uomqNFY-.js";function n(t,n){return t.getUint8(n)}function e(t,n){return t.getInt8(n)}function o(t,n){return t.getUint16(n,!1)}function r(t,n){return t.getUint32(n,!1)}function s(t,n,e){let o="";for(let r=0;r<e;r++){const e=t.getUint8(n+r);if(0===e)break;o+=String.fromCharCode(e)}return o}function l(t){if(t.byteLength<12)return!1;const n=new DataView(t);return"FORM"===s(n,0,4)&&"EMOD"===s(n,8,4)}async function a(l,a){const i=new DataView(l),u=new Uint8Array(l);if(l.byteLength<12)throw new Error("QC: file too small");if("FORM"!==s(i,0,4))throw new Error("QC: missing FORM magic");if("EMOD"!==s(i,8,4))throw new Error("QC: not an EMOD file");let m=12,f=a.replace(/\.[^/.]+$/,""),h=125;const c=[],p=[],g=new Uint8Array(256);let d=[],M=-1,C=0,w=-1,y=0;for(;m+8<=l.byteLength;){const t=s(i,m,4),l=r(i,m+4),a=m+8;if(m=a+l,1&m&&m++,"EMIC"===t){let t=a;o(i,t),t+=2;const r=s(i,t,20).trim();t+=20,r&&(f=r),t+=20,h=n(i,t),t+=1;const l=n(i,t);t+=1;for(let a=0;a<l;a++){t+=1;const r=n(i,t);t+=1;const l=2*o(i,t);t+=2;const u=s(i,t,20).trim();t+=20;const m=n(i,t);t+=1,e(i,t),t+=1;const f=2*o(i,t);t+=2;const h=2*o(i,t);t+=2,t+=4,c.push({name:u||`Sample ${a+1}`,volume:r,length:l,hasLoop:!!(1&m),loopStart:f,loopEnd:h>0?f+h:0})}t+=1;const u=n(i,t);t+=1;for(let e=0;e<u;e++){const o=n(i,t);t+=1;const r=n(i,t)+1;t+=1,t+=20,t+=4,g[o]=e,p.push({origNumber:o,rows:r})}const m=n(i,t);t+=1;for(let e=0;e<m;e++)d.push(g[n(i,t)]),t+=1}else"PATT"===t?(M=a,C=l):"8SMP"===t&&(w=a,y=l)}const x=[];{let t=M>=0?M:0;const e=M>=0?Math.min(M+C,l.byteLength):0;for(const o of p){const r=[];for(let s=0;s<o.rows;s++){const o=[];for(let r=0;r<4;r++){if(M<0||t+4>e){o.push({ins:0,note:255,fxt:0,fxp:0});continue}const r=n(i,t),s=n(i,t+1),l=15&n(i,t+2);let a=n(i,t+3);t+=4,4===l&&(a=240&a|a<<1&15),9===l&&(a=Math.min(2*a,255)),o.push({ins:r,note:s,fxt:l,fxp:a})}r.push(o)}x.push(r)}}const v=[];{let t=w>=0?w:0;const n=w>=0?Math.min(w+y,l.byteLength):0;for(const e of c)if(w<0||0===e.length)v.push(null);else{const o=Math.min(e.length,Math.max(0,n-t));v.push(o>0?u.slice(t,t+o):null),t+=e.length}}const S=c.map((n,e)=>{const o=v[e];return o&&0!==o.length?t(e+1,n.name,o,n.volume,8287,n.hasLoop?n.loopStart:0,n.hasLoop?n.loopEnd:0):{id:e+1,name:n.name,type:"sample",synthType:"Sampler",effects:[],volume:-60,pan:0}}),P=[-50,50,50,-50],E=x.map((t,n)=>{const e=Array.from({length:4},(n,e)=>{const o=t.map(t=>{const n=t[e],o=n.note<=35?n.note+13:0;let r=0,s=n.fxt,l=n.fxp;return 12===n.fxt&&(r=16+Math.min(n.fxp,64),s=0,l=0),{note:o,instrument:n.ins,volume:r,effTyp:s,eff:l,effTyp2:0,eff2:0}});return{id:`channel-${e}`,name:`Channel ${e+1}`,muted:!1,solo:!1,collapsed:!1,volume:100,pan:P[e],instrumentId:null,color:null,rows:o}});return{id:`pattern-${n}`,name:`Pattern ${n}`,length:t.length,channels:e,importMetadata:{sourceFormat:"QuadraComposer",sourceFile:a,importedAt:(new Date).toISOString(),originalChannelCount:4,originalPatternCount:p.length,originalInstrumentCount:c.length}}});0===E.length&&E.push({id:"pattern-0",name:"Pattern 0",length:64,channels:Array.from({length:4},(t,n)=>({id:`channel-${n}`,name:`Channel ${n+1}`,muted:!1,solo:!1,collapsed:!1,volume:100,pan:P[n],instrumentId:null,color:null,rows:Array.from({length:64},()=>({note:0,instrument:0,volume:0,effTyp:0,eff:0,effTyp2:0,eff2:0}))})),importMetadata:{sourceFormat:"QuadraComposer",sourceFile:a,importedAt:(new Date).toISOString(),originalChannelCount:4,originalPatternCount:0,originalInstrumentCount:0}});const L=d.length>0?d.filter(t=>t<E.length):[0];return 0===L.length&&L.push(0),{name:f,format:"MOD",patterns:E,instruments:S,songPositions:L,songLength:L.length,restartPosition:0,numChannels:4,initialSpeed:6,initialBPM:Math.max(32,Math.min(255,h||125)),linearPeriods:!1}}export{l as isQuadraComposerFormat,a as parseQuadraComposerFile};
