import{aB as e,aC as t}from"./index-zx6LJBPK.js";import"./vendor-react-DkDaD07v.js";import"./vendor-utils-XMmR-oGw.js";import"./vendor-tone-CADp_hfL.js";import"./vendor-ui-uomqNFY-.js";const n=new TextDecoder("iso-8859-1");function r(e,t,r){let o=t;for(;o<t+r&&0!==e[o];)o++;return n.decode(e.subarray(t,o))}function o(e,t){return e[t]<<8|e[t+1]}function a(e,t){return(e[t]<<24|e[t+1]<<16|e[t+2]<<8|e[t+3])>>>0}function s(s,f){const l=new Uint8Array(s),c=n.decode(l.subarray(0,8));if("OKTASONG"!==c)throw new Error(`Not a valid Oktalyzer file (expected OKTASONG magic, got ${c.slice(0,8)})`);let i=8;const u=l.byteLength,p=[];let h=6,m=0,d=0;const g=[],y=[],T=[];for(;i+8<=u;){const e=n.decode(l.subarray(i,i+4)),t=a(l,i+4),s=i+8;switch(i+=8+t,1&t&&i++,e){case"CMOD":for(let e=0;e<4&&2*e+1<t;e++)o(l,s+2*e);break;case"SAMP":{const e=Math.floor(t/32);for(let t=0;t<e;t++){const e=s+32*t,n=r(l,e,20),f=a(l,e+20),c=2*o(l,e+24),i=2*o(l,e+26),u=o(l,e+28),h=o(l,e+30);p.push({name:n,length:f,loopStart:c,loopLength:i,volume:u,type:h,pcm:null})}break}case"SPEE":h=o(l,s);break;case"SLEN":m=o(l,s);break;case"PLEN":d=o(l,s);break;case"PATT":for(let e=0;e<m&&e<t;e++)g.push(l[s+e]);break;case"PBOD":{const e=o(l,s),t=8,n=[];for(let r=0;r<e;r++){const e=[];for(let n=0;n<t;n++){const o=s+2+r*t*4+4*n,a=l[o],f=l[o+1],c=l[o+2],i=l[o+3];e.push(a,f,c,i)}n.push(e)}y.push({rows:e,channels:t,cells:n});break}case"SBOD":T.push(l.slice(s,s+t))}}for(let e=0;e<p.length&&e<T.length;e++)p[e].pcm=T[e];const S=p.map((t,n)=>{const r=t.pcm??new Uint8Array(t.length),o=t.loopStart+t.loopLength,a=t.loopLength>2&&o<=t.length;return e(n+1,t.name,r,t.volume,8287,a?t.loopStart:0,a?o:0)}),b=y.map((e,n)=>{const r=Array.from({length:e.channels},(n,r)=>{const o=e.cells.map(e=>{const n=4*r,o=e[n],a=e[n+1],s=e[n+2],f=e[n+3],{effTyp:l,eff:c}=function(e,t){switch(e){case 0:default:return{effTyp:0,eff:0};case 1:return{effTyp:15,eff:t};case 2:return{effTyp:11,eff:t};case 10:return{effTyp:12,eff:t};case 11:return{effTyp:1,eff:t};case 12:return{effTyp:2,eff:t};case 13:return{effTyp:3,eff:t};case 17:return{effTyp:10,eff:t};case 30:return{effTyp:14,eff:192|15&t}}}(s,f);return{note:t(o),instrument:a,volume:0,effTyp:l,eff:c,effTyp2:0,eff2:0}});return{id:`channel-${r}`,name:`Channel ${r+1}`,muted:!1,solo:!1,collapsed:!1,volume:100,pan:r<4?-25:25,instrumentId:null,color:null,rows:o}});return{id:`pattern-${n}`,name:`Pattern ${n}`,length:e.rows,channels:r,importMetadata:{sourceFormat:"OKT",sourceFile:f,importedAt:(new Date).toISOString(),originalChannelCount:e.channels,originalPatternCount:d,originalInstrumentCount:p.length}}}),w=g.slice(0,m);return{name:f.replace(/\.[^/.]+$/,""),format:"OKT",patterns:b,instruments:S,songPositions:w.length>0?w:[0],songLength:w.length||1,restartPosition:0,numChannels:8,initialSpeed:h,initialBPM:125,linearPeriods:!1}}export{s as parseOktalyzerFile};
