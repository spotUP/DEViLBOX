import{aU as t}from"./index-zx6LJBPK.js";import{C as e}from"./Cpu6502-B9laXm8V.js";import"./vendor-react-DkDaD07v.js";import"./vendor-utils-XMmR-oGw.js";import"./vendor-tone-CADp_hfL.js";import"./vendor-ui-uomqNFY-.js";function n(){return{note:0,instrument:0,volume:0,effTyp:0,eff:0,effTyp2:0,eff2:0}}function r(t){if(0===t||t>=255)return 0;const e=63921/(2*(t+1));if(e<20||e>2e4)return 0;const n=Math.round(12*Math.log2(e/440)+69);return n>=1&&n<=96?n:0}function a(t){const e=new Uint8Array(t);return e.length>=3&&83===e[0]&&65===e[1]&&80===e[2]}async function s(s,l){if(!a(s))throw new Error("Not a valid SAP file");const o=new Uint8Array(s),i=function(t){const e={name:"",author:"",songs:1,stereo:!1,initAddr:0,playerAddr:0,musicAddr:0,type:"B",fastplay:312,dataOffset:0};let n=0;for(;n<t.length-1;){if(255===t[n]&&255===t[n+1]){e.dataOffset=n+2;break}let r=n;for(;r<t.length&&10!==t[r];)r++;const a=new TextDecoder("latin1").decode(t.subarray(n,r)).replace(/\r/g,"").trim();a.startsWith("NAME ")&&(e.name=a.slice(5).replace(/^"|"$/g,"").trim()),a.startsWith("AUTHOR ")&&(e.author=a.slice(7).replace(/^"|"$/g,"").trim()),a.startsWith("SONGS ")&&(e.songs=parseInt(a.slice(6))||1),"STEREO"===a&&(e.stereo=!0),a.startsWith("TYPE ")&&(e.type=a.slice(5).trim()),a.startsWith("INIT ")&&(e.initAddr=parseInt(a.slice(5),16)),a.startsWith("PLAYER ")&&(e.playerAddr=parseInt(a.slice(7),16)),a.startsWith("MUSIC ")&&(e.musicAddr=parseInt(a.slice(6),16)),a.startsWith("FASTPLAY ")&&(e.fastplay=parseInt(a.slice(9))||312),n=r+1}return e}(o),c=i.stereo?8:4,f=Array.from({length:c},(e,n)=>({id:n+1,name:`POKEY ${n+1}`,type:"synth",synthType:"FurnacePOKEY",furnace:{...t,chipType:20,ops:2},effects:[],volume:0,pan:0}));let u;if(i.dataOffset>0&&i.initAddr>0&&i.playerAddr>0)try{const t=function(t,n,a){const s=new Uint8Array(65536);let l=0;if(n.dataOffset+3<t.length){l=t[n.dataOffset]|t[n.dataOffset+1]<<8;const e=t[n.dataOffset+2]|t[n.dataOffset+3]<<8,r=t.subarray(n.dataOffset+4,n.dataOffset+4+(e-l+1));s.set(r.subarray(0,Math.min(r.length,65536-l)),l)}const o=new Uint8Array(16),i=new e({read:t=>t>=53760&&t<53776?o[t-53760]:s[65535&t],write(t,e){s[65535&t]=e,t>=53760&&t<53776&&(o[t-53760]=e)}}),c="B"===n.type?n.initAddr:n.musicAddr,f=n.playerAddr;if(0===c||0===f)return[];i.reset(c),i.setA(0),i.callSubroutine(c);const u=[];for(let e=0;e<900;e++){i.callSubroutine(f);const t=new Array(a).fill(null);for(let e=0;e<Math.min(a,4);e++){const n=o[2*e],a=15&o[2*e+1];t[e]=a>0?r(n):null}u.push({notes:t})}return u}(o,i,c);u=t.length>0?function(t,e,r){const a=Math.max(1,Math.ceil(t.length/256)),s=Math.min(256,Math.ceil(t.length/a)),l=Array.from({length:r},(t,r)=>({id:`ch${r}`,name:e[r]?.name||`POKEY ${r+1}`,muted:!1,solo:!1,collapsed:!1,volume:100,pan:0,instrumentId:null,color:null,rows:Array.from({length:s},n)})),o=new Array(r).fill(0);for(let n=0;n<s;n++){const e=t[Math.min(n*a,t.length-1)];for(let t=0;t<r&&t<e.notes.length;t++){const r=e.notes[t],a=l[t].rows[n];null!==r&&r!==o[t]?(a.note=r,a.instrument=t+1,o[t]=r):null===r&&o[t]>0&&(a.note=97,o[t]=0)}}return{id:"p0",name:"Pattern 1",length:s,channels:l}}(t,f,c):{id:"p0",name:"Pattern 1",length:16,channels:Array.from({length:c},(t,e)=>({id:`ch${e}`,name:`POKEY ${e+1}`,muted:!1,solo:!1,collapsed:!1,volume:100,pan:0,instrumentId:null,color:null,rows:Array.from({length:16},n)}))}}catch{u={id:"p0",name:"Pattern 1",length:16,channels:Array.from({length:c},(t,e)=>({id:`ch${e}`,name:`POKEY ${e+1}`,muted:!1,solo:!1,collapsed:!1,volume:100,pan:0,instrumentId:null,color:null,rows:Array.from({length:16},n)}))}}else u={id:"p0",name:"Pattern 1",length:16,channels:Array.from({length:c},(t,e)=>({id:`ch${e}`,name:`POKEY ${e+1}`,muted:!1,solo:!1,collapsed:!1,volume:100,pan:0,instrumentId:null,color:null,rows:Array.from({length:16},n)}))};return{name:(i.name||l.replace(/\.sap$/i,""))+(i.author?` â€” ${i.author}`:""),format:"SAP",patterns:[u],instruments:f,songPositions:[0],songLength:i.songs,restartPosition:0,numChannels:c,initialSpeed:1,initialBPM:50}}export{a as isSAPFormat,s as parseSAPFile};
