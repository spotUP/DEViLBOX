import{aB as t}from"./index-zx6LJBPK.js";import"./vendor-react-DkDaD07v.js";import"./vendor-utils-XMmR-oGw.js";import"./vendor-tone-CADp_hfL.js";import"./vendor-ui-uomqNFY-.js";function e(t,e){return t.getUint8(e)}function n(t,e){return t.getUint16(e,!0)}function r(t,e){return t.getUint32(e,!0)}function f(t,e,n){const r=[];for(let f=0;f<n;f++){const n=t.getUint8(e+f);if(0===n)break;r.push(n)}return String.fromCharCode(...r).trimEnd()}const o=332,i=64,l=15;function u(t){if(t.length<332)return!1;const r=new DataView(t.buffer,t.byteOffset,t.byteLength);if(67!==e(r,0))return!1;if(66!==e(r,1))return!1;if(65!==e(r,2))return!1;if(249!==e(r,3))return!1;if(26!==e(r,36))return!1;const f=e(r,39),o=e(r,43),i=e(r,44);if(0===f||f>32)return!1;if(0===o)return!1;if(i<32)return!1;const l=n(r,37),u=48*e(r,42)+l;return!(t.length<332+u)}function s(t,e){if(0===t)return{effTyp:0,eff:0};if(t>=1&&t<=14){return{effTyp:t-1,eff:e}}if(15===t)return{effTyp:0,eff:0};if(24===t)return{effTyp:27,eff:e};if(t>=16&&t<=30){return{effTyp:14,eff:t-16<<4|Math.min(e,15)}}return 31===t?{effTyp:15,eff:e}:32===t?{effTyp:15,eff:Math.max(e,20)}:{effTyp:0,eff:0}}function a(a,p){try{return function(a,p){if(!u(a))return null;const m=new DataView(a.buffer,a.byteOffset,a.byteLength),c=f(m,4,32),h=e(m,39),g=e(m,40),y=e(m,41),d=e(m,42),T=e(m,43),v=e(m,44),M=[];for(let t=0;t<32;t++){const n=2*e(m,45+t),r=Math.round((n-256)/256*50);M.push(Math.max(-50,Math.min(50,r)))}const A=[];for(let t=0;t<y&&t<255;t++){const n=e(m,77+t);if(255===n||254===n)break;A.push(n)}0===A.length&&A.push(0);let C=o;const S=[];for(let t=0;t<d;t++){if(C+48>a.length)return null;S.push({name:f(m,C,32),flags:e(m,C+32),volume:e(m,C+33),sampleRate:n(m,C+34),length:r(m,C+36),loopStart:r(m,C+40),loopEnd:r(m,C+44)}),C+=48}const b=C,$=g+1,w=320*h,P=[];for(let t=0;t<$;t++){const n=b+t*w;if(n+w>a.length){P.push(Array.from({length:h},()=>Array.from({length:i},()=>({note:0,instrument:0,volume:0,effTyp:0,eff:0,effTyp2:0,eff2:0}))));continue}const r=Array.from({length:h},()=>Array.from({length:i},()=>({note:0,instrument:0,volume:0,effTyp:0,eff:0,effTyp2:0,eff2:0})));let f=n;for(let t=0;t<i;t++)for(let n=0;n<h&&!(f+5>a.length);n++){const o=e(m,f),i=e(m,f+1),l=e(m,f+2),u=e(m,f+3),a=e(m,f+4);f+=5;const p=r[n][t];if(p.instrument=o,255===i?p.note=254:i>0&&i<=96&&(p.note=12+i),l>0&&(p.volume=Math.min(l,65)-1),u>0){const{effTyp:t,eff:e}=s(u,a);p.effTyp=t,p.eff=e}}P.push(r)}let j=b+$*w;const U=[];for(let t=0;t<d;t++){const e=S[t].length;if(0===e||j+e>a.length){U.push(null),j+=e;continue}const n=new Uint8Array(e);let r=0;for(let t=0;t<e;t++){const e=a[j+t];r=r+(e<128?e:e-256)&255,n[t]=r}U.push(n),j+=e}const x=S.map((e,n)=>{const r=n+1,f=e.name||`Sample ${r}`,o=U[n];if(!o||0===o.length)return{id:r,name:f,type:"sample",synthType:"Sampler",effects:[],volume:0,pan:0};const i=!!(8&e.flags)&&e.loopEnd>e.loopStart,l=i?e.loopStart:0,u=i?Math.min(e.loopEnd,e.length):0,s=e.sampleRate>0?e.sampleRate:8363;return t(r,f,o,e.volume,s,l,u)}),D=A.map((t,e)=>{const n=t<P.length?P[t]:null,r=Array.from({length:h},(t,r)=>{const f=Array.from({length:i},(t,e)=>{if(!n){const t={note:0,instrument:0,volume:0,effTyp:0,eff:0,effTyp2:0,eff2:0};return 0===r&&0===e&&(t.effTyp=l,t.eff=T),t}const f={...n[r][e]};return 0===r&&0===e&&0===f.effTyp&&0===f.eff&&(f.effTyp=l,f.eff=T),f});return{id:`c${e}-ch${r}`,name:`Channel ${r+1}`,muted:!1,solo:!1,collapsed:!1,volume:100,pan:r<h?M[r]:0,instrumentId:null,color:null,rows:f}});return{id:`pattern-${e}-${t}`,name:`Pattern ${t}`,length:i,channels:r,importMetadata:{sourceFormat:"CBA",sourceFile:p,importedAt:(new Date).toISOString(),originalChannelCount:h,originalPatternCount:$,originalInstrumentCount:d}}}),E=D.map((t,e)=>e),O=c.trim()||p.replace(/\.[^/.]+$/,"");return{name:O,format:"MOD",patterns:D,instruments:x,songPositions:E,songLength:E.length,restartPosition:0,numChannels:h,initialSpeed:T,initialBPM:v,linearPeriods:!1}}(a,p)}catch{return null}}export{u as isChuckBiscuitsFormat,a as parseChuckBiscuitsFile};
