import{aB as e}from"./index-zx6LJBPK.js";import"./vendor-react-DkDaD07v.js";import"./vendor-utils-XMmR-oGw.js";import"./vendor-tone-CADp_hfL.js";import"./vendor-ui-uomqNFY-.js";function t(e,t){return e.getUint8(t)}function n(e,t){return e.getUint16(t,!0)}function f(e,t){return e.getUint32(t,!0)}function r(e,t,n){let f="";for(let r=0;r<n;r++){const n=e.getUint8(t+r);if(0===n)break;f+=String.fromCharCode(n)}return f.trim()}function o(e){if(e.byteLength<608)return!1;const f=new DataView(e);if(80!==f.getUint8(44)||84!==f.getUint8(45)||77!==f.getUint8(46)||70!==f.getUint8(47))return!1;if(26!==t(f,28))return!1;if(t(f,30)>2)return!1;if(0!==n(f,40))return!1;const r=n(f,38),o=n(f,32),a=n(f,34),s=n(f,36);return!(r<1||r>32)&&(!(o<1||o>256)&&(!(a<1||a>255)&&!(s<1||s>128)))}function a(e){const t=new Uint8Array(e.length);let n=0;for(let f=0;f<e.length;f++)n=n+e[f]&255,t[f]=n;return t}function s(e,t){switch(e){case 0:return{effTyp:0,eff:t};case 1:return{effTyp:1,eff:t};case 2:return{effTyp:2,eff:t};case 3:return{effTyp:3,eff:t};case 4:return{effTyp:4,eff:t};case 5:return{effTyp:5,eff:t};case 6:return{effTyp:6,eff:t};case 7:return{effTyp:7,eff:t};case 8:return{effTyp:83,eff:128|Math.max(t>>3,1)-1&15};case 9:return{effTyp:9,eff:t};case 10:return{effTyp:10,eff:t};case 11:return{effTyp:11,eff:t};case 12:return{effTyp:12,eff:t};case 13:return{effTyp:13,eff:t};case 14:return{effTyp:14,eff:t};case 15:return{effTyp:15,eff:t};default:return{effTyp:0,eff:0}}}function i(e,o){return{flags:t(e,o+0),filename:r(e,o+1,12),volume:t(e,o+13),c4speed:n(e,o+14),dataOffset:f(e,o+18),length:f(e,o+22),loopStart:f(e,o+26),loopEnd:f(e,o+30),name:r(e,o+48,28)}}async function l(f,l){if(!o(f))throw new Error("PTMParser: file does not pass PTM format validation");const u=new DataView(f),p=new Uint8Array(f),c=r(u,0,28)||l.replace(/\.[^/.]+$/,""),m=n(u,32),h=n(u,34),y=n(u,36),g=n(u,38),d=[];for(let e=0;e<32;e++){const n=15&t(u,64+e);d.push(Math.round(100*(n/7.5-1)))}const T=[];let v=0;for(let e=0;e<m;e++){const n=t(u,96+e);if(255===n)break;254!==n?T.push(n):v=T.length}const b=[];for(let e=0;e<128;e++)b.push(16*n(u,352+2*e));const w=[];for(let e=0;e<h;e++)w.push(i(u,608+80*e));const M=[];for(let e=0;e<y;e++){const t=Array.from({length:g},(e,t)=>({id:`channel-${t}`,name:`Ch ${t+1}`,muted:!1,solo:!1,collapsed:!1,volume:100,pan:t<32?d[t]:0,instrumentId:null,color:null,rows:[]})),n=Array.from({length:64},()=>Array.from({length:g},()=>({note:0,instrument:0,volume:0,effTyp:0,eff:0,effTyp2:0,eff2:0}))),r=b[e];if(0!==r&&r+1<f.byteLength){let e=r,t=0;for(;t<64&&e<f.byteLength;){const r=p[e++];if(0===r){t++;continue}const o=31&r,a=o<g?n[t][o]:{note:0,instrument:0,volume:0,effTyp:0,eff:0};if(32&r){if(e+1>=f.byteLength)break;const t=p[e++],n=p[e++];a.instrument=n,a.note=254===t?97:t>=1&&t<=120?t:0}if(64&r){if(e+1>=f.byteLength)break;const t=p[e++],n=p[e++];if(t<=15){let e=n;const{effTyp:f,eff:r}=s(t,e);a.effTyp=f,a.eff=r}}if(128&r){if(e>=f.byteLength)break;const t=p[e++];a.volume=Math.min(t,64)}}}for(let e=0;e<g;e++)for(let f=0;f<64;f++)t[e].rows.push(n[f][e]);M.push({id:`pattern-${e}`,name:`Pattern ${e}`,length:64,channels:t,importMetadata:{sourceFormat:"PTM",sourceFile:l,importedAt:(new Date).toISOString(),originalChannelCount:g,originalPatternCount:y,originalInstrumentCount:h}})}const S=[];for(let t=0;t<h;t++){const n=w[t],r=t+1,o=1==(3&n.flags),s=!!(16&n.flags),i=!!(4&n.flags);if(!o||0===n.length||0===n.dataOffset){S.push({id:r,name:n.name||n.filename||`Sample ${r}`,type:"sample",synthType:"Sampler",effects:[],volume:-60,pan:0});continue}const l=n.c4speed>0?2*n.c4speed:8363,u=n.length,c=n.loopStart,m=n.loopEnd>0?n.loopEnd-1:0,h=s?2:1,y=c/h,g=i&&m>c?m/h:0,d=n.dataOffset+u;if(d>f.byteLength){S.push({id:r,name:n.name||n.filename||`Sample ${r}`,type:"sample",synthType:"Sampler",effects:[],volume:-60,pan:0});continue}const T=a(p.slice(n.dataOffset,d)),v=Math.min(n.volume,64),b=i?Math.round(y):0,M=i&&g>y?Math.round(g):0,P=n.name||n.filename||`Sample ${r}`;S.push(e(r,P,T,v,l,b,M))}return{name:c,format:"S3M",patterns:M,instruments:S,songPositions:T.length>0?T:[0],songLength:T.length>0?T.length:1,restartPosition:v,numChannels:g,initialSpeed:6,initialBPM:125,linearPeriods:!1}}export{o as isPTMFormat,l as parsePTMFile};
