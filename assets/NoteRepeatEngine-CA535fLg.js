import{M as e,m as t}from"./MpcResamplerDSP-nORj9P5z.js";import{c as a,r}from"./vendor-utils-XMmR-oGw.js";import{t as s,j as n}from"./index-zx6LJBPK.js";function o(e){return{id:e,sample:null,name:`Pad ${e}`,level:100,tune:0,pan:0,output:"stereo",attack:0,decay:200,decayMode:"start",sustain:80,release:100,filterType:"off",cutoff:2e4,resonance:0,filterAttack:0,filterDecay:50,filterEnvAmount:0,veloToLevel:100,veloToAttack:0,veloToStart:0,veloToFilter:0,veloToPitch:0,muteGroup:0,playMode:"oneshot",sampleStart:0,sampleEnd:1,reverse:!1,layers:[]}}function i(e,t){return{id:e,name:t,pads:Array.from({length:64},(e,t)=>o(t+1)),masterLevel:100,masterTune:0}}function l(e,t){const a={A:0,B:1,C:2,D:3}[t];return e.slice(16*a,16*(a+1))}function c(){const e=i("A-01","808 Kit");return e.pads[0].name="Kick",e.pads[1].name="Snare",e.pads[2].name="Clap",e.pads[3].name="Rim",e.pads[4].name="Cl Hat",e.pads[5].name="Op Hat",e.pads[6].name="Lo Tom",e.pads[7].name="Mid Tom",e.pads[8].name="Hi Tom",e.pads[9].name="Crash",e.pads[10].name="Ride",e.pads[11].name="Clave",e.pads[12].name="Cowbell",e.pads[13].name="Maracas",e.pads[14].name="Conga",e.pads[15].name="Cymbal",e}function d(){const e=i("B-01","909 Kit");return e.pads[0].name="Kick",e.pads[1].name="Snare",e.pads[2].name="Clap",e.pads[3].name="Rim",e.pads[4].name="Cl Hat",e.pads[5].name="Op Hat",e.pads[6].name="Lo Tom",e.pads[7].name="Mid Tom",e.pads[8].name="Hi Tom",e.pads[9].name="Crash",e.pads[10].name="Ride",e.pads[11].name="Shaker",e.pads[12].name="Tambourine",e.pads[13].name="Splash",e.pads[14].name="China",e.pads[15].name="Reverse Cymbal",e}const m="programs",u="samples";let p=null;function f(){return p?Promise.resolve(p):new Promise((e,t)=>{const a=indexedDB.open("devilbox-drumpad",1);a.onupgradeneeded=()=>{const e=a.result;e.objectStoreNames.contains(m)||e.createObjectStore(m,{keyPath:"id"}),e.objectStoreNames.contains(u)||e.createObjectStore(u,{keyPath:"id"})},a.onsuccess=()=>{p=a.result,p.onclose=()=>{p=null},e(p)},a.onerror=()=>{t(a.error)}})}function v(e,t,a){return e.transaction(t,a).objectStore(t)}function h(e){return new Promise((t,a)=>{e.onsuccess=()=>t(e.result),e.onerror=()=>a(e.error)})}function g(e){return new Promise((t,a)=>{e.oncomplete=()=>t(),e.onerror=()=>a(e.error)})}function y(e){const t=[];for(let a=0;a<e.audioBuffer.numberOfChannels;a++){const r=e.audioBuffer.getChannelData(a);t.push(r.buffer.slice(r.byteOffset,r.byteOffset+r.byteLength))}return{id:e.id,name:e.name,channels:t,sampleRate:e.sampleRate,duration:e.duration}}function T(e,t){const a=e.channels.length,r=e.channels[0]?new Float32Array(e.channels[0]).length:0,s=t.createBuffer(a,r,e.sampleRate);for(let n=0;n<a;n++)s.copyToChannel(new Float32Array(e.channels[n]),n);return{id:e.id,name:e.name,audioBuffer:s,sampleRate:e.sampleRate,duration:e.duration}}function b(e){return{id:e.id,name:e.name,masterLevel:e.masterLevel,masterTune:e.masterTune,mpcResample:e.mpcResample,pads:e.pads.map(e=>({id:e.id,name:e.name,sampleId:e.sample?.id??null,level:e.level,tune:e.tune,pan:e.pan,output:e.output,attack:e.attack,decay:e.decay,decayMode:e.decayMode,sustain:e.sustain,release:e.release,filterType:e.filterType,cutoff:e.cutoff,resonance:e.resonance,filterAttack:e.filterAttack,filterDecay:e.filterDecay,filterEnvAmount:e.filterEnvAmount,veloToLevel:e.veloToLevel,veloToAttack:e.veloToAttack,veloToStart:e.veloToStart,veloToFilter:e.veloToFilter,veloToPitch:e.veloToPitch,scratchAction:e.scratchAction,muteGroup:e.muteGroup,playMode:e.playMode,sampleStart:e.sampleStart,sampleEnd:e.sampleEnd,reverse:e.reverse}))}}function P(e,t){const a=e.pads.map(e=>({id:e.id,name:e.name,sample:e.sampleId?t.get(e.sampleId)??null:null,level:e.level,tune:e.tune,pan:e.pan,output:e.output,attack:e.attack,decay:e.decay,sustain:e.sustain,release:e.release,filterType:e.filterType,cutoff:e.cutoff,resonance:e.resonance,layers:[],scratchAction:e.scratchAction,muteGroup:e.muteGroup??0,playMode:e.playMode??"oneshot",sampleStart:e.sampleStart??0,sampleEnd:e.sampleEnd??1,reverse:e.reverse??!1,decayMode:e.decayMode??"start",filterAttack:e.filterAttack??0,filterDecay:e.filterDecay??50,filterEnvAmount:e.filterEnvAmount??0,veloToLevel:e.veloToLevel??100,veloToAttack:e.veloToAttack??0,veloToStart:e.veloToStart??0,veloToFilter:e.veloToFilter??0,veloToPitch:e.veloToPitch??0}));for(;a.length<64;)a.push(o(a.length+1));return{id:e.id,name:e.name,masterLevel:e.masterLevel,masterTune:e.masterTune,mpcResample:e.mpcResample,pads:a}}async function x(e){const t=await f(),a=new Map;for(const i of e.values())for(const e of i.pads)e.sample&&a.set(e.sample.id,e.sample);const r=t.transaction(u,"readwrite"),s=r.objectStore(u);s.clear();for(const i of a.values())s.put(y(i));await g(r);const n=t.transaction(m,"readwrite"),o=n.objectStore(m);o.clear();for(const i of e.values())o.put(b(i));await g(n)}function A(e){const t=new Uint8Array(e.buffer,e.byteOffset,e.byteLength);let a="";for(let r=0;r<t.length;r++)a+=String.fromCharCode(t[r]);return btoa(a)}function M(e){const t=atob(e),a=new Uint8Array(t.length);for(let r=0;r<t.length;r++)a[r]=t.charCodeAt(r);return new Float32Array(a.buffer)}const N={defaultProgram:"A-01",velocitySensitivity:1,padColors:{}},S=a((a,r)=>({programs:new Map([["A-01",c()],["B-01",d()],["C-01",i("C-01","Empty Kit")]]),currentProgramId:"A-01",midiMappings:{},preferences:N,busLevels:{},currentBank:"A",setBank:e=>a({currentBank:e}),getCurrentBankPads:()=>{const{programs:e,currentProgramId:t,currentBank:a}=r(),s=e.get(t);return s?l(s.pads,a):[]},clipboardPad:null,copyPad:e=>{const{programs:t,currentProgramId:s}=r(),n=t.get(s),o=n?.pads.find(t=>t.id===e);o&&a({clipboardPad:{...o,layers:o.layers.map(e=>({...e,sample:{...e.sample}}))}})},pastePad:e=>{const{clipboardPad:t}=r();t&&(r().updatePad(e,{sample:t.sample?{...t.sample}:null,name:t.name,level:t.level,tune:t.tune,pan:t.pan,output:t.output,attack:t.attack,decay:t.decay,sustain:t.sustain,release:t.release,filterType:t.filterType,cutoff:t.cutoff,resonance:t.resonance,muteGroup:t.muteGroup,playMode:t.playMode,sampleStart:t.sampleStart,sampleEnd:t.sampleEnd,reverse:t.reverse,decayMode:t.decayMode,filterAttack:t.filterAttack,filterDecay:t.filterDecay,filterEnvAmount:t.filterEnvAmount,veloToLevel:t.veloToLevel,veloToAttack:t.veloToAttack,veloToStart:t.veloToStart,veloToFilter:t.veloToFilter,veloToPitch:t.veloToPitch,layers:t.layers.map(e=>({...e,sample:{...e.sample}})),scratchAction:t.scratchAction}),r().saveToIndexedDB())},noteRepeatEnabled:!1,noteRepeatRate:"1/16",setNoteRepeatEnabled:e=>a({noteRepeatEnabled:e}),setNoteRepeatRate:e=>a({noteRepeatRate:e}),loadProgram:e=>{const{programs:t}=r();t.has(e)&&(a({currentProgramId:e}),r().saveToStorage())},saveProgram:e=>{a(t=>{const a=new Map(t.programs);return a.set(e.id,e),{programs:a}}),r().saveToStorage()},createProgram:(e,t)=>{a(a=>{const r=new Map(a.programs);return r.set(e,i(e,t)),{programs:r,currentProgramId:e}}),r().saveToStorage()},deleteProgram:e=>{a(t=>{const a=new Map(t.programs);a.delete(e);let r=t.currentProgramId;if(e===t.currentProgramId){r=Array.from(a.keys())[0]||"A-01",a.has(r)||(a.set("A-01",c()),r="A-01")}return{programs:a,currentProgramId:r}}),r().saveToStorage()},copyProgram:(e,t)=>{const{programs:s}=r(),n=s.get(e);if(n){const e={...n,id:t,name:`${n.name} (Copy)`,pads:n.pads.map(e=>({...e,sample:e.sample?{...e.sample}:null,layers:e.layers.map(e=>({...e,sample:{...e.sample}}))}))};a(a=>{const r=new Map(a.programs);return r.set(t,e),{programs:r}}),r().saveToStorage()}},updatePad:(e,t)=>{a(a=>{const r=new Map(a.programs),s=r.get(a.currentProgramId);if(s){const n=s.pads.map(a=>a.id===e?{...a,...t}:a);r.set(a.currentProgramId,{...s,pads:n})}return{programs:r}}),r().saveToStorage()},loadSampleToPad:async(a,s)=>{const{programs:n,currentProgramId:o}=r(),i=n.get(o);let l=s;if(i?.mpcResample?.enabled)try{const a={...e[i.mpcResample.model],model:i.mpcResample.model},r=await t(s.audioBuffer,a);l={...s,audioBuffer:r.buffer,originalAudioBuffer:s.audioBuffer,duration:r.buffer.duration,sampleRate:r.buffer.sampleRate}}catch(c){}r().updatePad(a,{sample:l,name:s.name}),r().saveToIndexedDB()},clearPad:e=>{r().updatePad(e,{sample:null,name:`Pad ${e}`})},addLayerToPad:(e,t,a)=>{const{programs:s,currentProgramId:n}=r(),o=s.get(n),i=o?.pads.find(t=>t.id===e);if(!i)return;const l={sample:t,velocityRange:a,levelOffset:0};r().updatePad(e,{layers:[...i.layers,l]}),r().saveToIndexedDB()},removeLayerFromPad:(e,t)=>{const{programs:a,currentProgramId:s}=r(),n=a.get(s),o=n?.pads.find(t=>t.id===e);if(!o)return;const i=o.layers.filter((e,a)=>a!==t);r().updatePad(e,{layers:i}),r().saveToIndexedDB()},updateLayerOnPad:(e,t,a)=>{const{programs:s,currentProgramId:n}=r(),o=s.get(n),i=o?.pads.find(t=>t.id===e);if(!i||!i.layers[t])return;const l=i.layers.map((e,r)=>r===t?{...e,...a}:e);r().updatePad(e,{layers:l})},setBusLevel:(e,t)=>{a(a=>({busLevels:{...a.busLevels,[e]:t}}))},setMIDIMapping:(e,t)=>{a(a=>({midiMappings:{...a.midiMappings,[e]:t}})),r().saveToStorage()},clearMIDIMapping:e=>{a(t=>{const{[e]:a,...r}=t.midiMappings;return{midiMappings:r}}),r().saveToStorage()},getMIDIMapping:e=>{const{midiMappings:t}=r();for(const[a,r]of Object.entries(t))if("note"===r.type&&r.note===e)return a;return null},saveToStorage:()=>{try{const{programs:e,currentProgramId:t,midiMappings:a,preferences:s}=r(),n={};e.forEach((e,t)=>{n[t]=e});const o={version:1,programs:n,currentProgramId:t,midiMappings:a,preferences:s};localStorage.setItem("devilbox_drumpad",JSON.stringify(o))}catch(e){e instanceof Error&&e.name}},loadFromStorage:()=>{try{const e=localStorage.getItem("devilbox_drumpad");if(e){const t=JSON.parse(e),r=new Map;Object.entries(t.programs||{}).forEach(([e,t])=>{const a=t,s=(a.pads||[]).map(e=>({...e,muteGroup:e.muteGroup??0,playMode:e.playMode??"oneshot",sampleStart:e.sampleStart??0,sampleEnd:e.sampleEnd??1,reverse:e.reverse??!1,decayMode:e.decayMode??"start",filterAttack:e.filterAttack??0,filterDecay:e.filterDecay??50,filterEnvAmount:e.filterEnvAmount??0,veloToLevel:e.veloToLevel??100,veloToAttack:e.veloToAttack??0,veloToStart:e.veloToStart??0,veloToFilter:e.veloToFilter??0,veloToPitch:e.veloToPitch??0}));for(;s.length<64;)s.push(o(s.length+1));r.set(e,{...a,pads:s})}),a({programs:r,currentProgramId:t.currentProgramId||"A-01",midiMappings:t.midiMappings||{},preferences:{...N,...t.preferences}})}}catch(e){}},saveToIndexedDB:async()=>{try{const{programs:e}=r();await x(e)}catch(e){}},loadFromIndexedDB:async e=>{try{const t=await async function(e){const t=await f(),a=v(t,u,"readonly"),r=await h(a.getAll());if(0===r.length){const e=v(t,m,"readonly");if(0===(await h(e.getAll())).length)return null}const s=new Map;for(const c of r)try{s.set(c.id,T(c,e))}catch(l){}const n=v(t,m,"readonly"),o=await h(n.getAll()),i=new Map;for(const c of o)i.set(c.id,P(c,s));return i.size>0?i:null}(e);if(t&&t.size>0){const e=r(),s=t.has(e.currentProgramId)?e.currentProgramId:Array.from(t.keys())[0]||"A-01";a({programs:t,currentProgramId:s})}}catch(t){}},exportAllConfigs:async()=>{const{programs:e}=r();return async function(e){const t=new Map;for(const s of e.values())for(const e of s.pads)e.sample&&t.set(e.sample.id,e.sample);const a=Array.from(t.values()).map(e=>{const t=[];for(let a=0;a<e.audioBuffer.numberOfChannels;a++)t.push(A(e.audioBuffer.getChannelData(a)));return{id:e.id,name:e.name,sampleRate:e.sampleRate,duration:e.duration,channels:t}}),r={version:1,programs:Array.from(e.values()).map(b),samples:a};return new Blob([JSON.stringify(r)],{type:"application/json"})}(e)},importConfigs:async(e,t)=>{try{const s=await async function(e,t){const a=await e.text(),r=JSON.parse(a);if(1!==r.version)throw new Error(`Unsupported .dvbpads version: ${r.version}`);const s=new Map;for(const o of r.samples){const e=o.channels.length,a=o.channels.map(M),r=a[0]?.length??0,n=t.createBuffer(e,r,o.sampleRate);for(let t=0;t<e;t++)n.copyToChannel(new Float32Array(a[t]),t);s.set(o.id,{id:o.id,name:o.name,audioBuffer:n,sampleRate:o.sampleRate,duration:o.duration})}const n=new Map;for(const o of r.programs)n.set(o.id,P(o,s));return n}(e,t);a({programs:s}),await x(s),r().saveToStorage()}catch(s){throw s}},setPreference:(e,t)=>{a(a=>({preferences:{...a.preferences,[e]:t}})),r().saveToStorage()}}));"undefined"!=typeof window&&S.getState().loadFromStorage();const B=({pad:e,isSelected:t,isFocused:a=!1,velocity:o,onTrigger:i,onRelease:l,onSelect:c,onFocus:d,className:m=""})=>{const u=s(e=>e.useHexNumbers),[p,f]=r.useState(!1),[v,h]=r.useState(0),g=r.useRef(null);r.useEffect(()=>()=>{g.current&&cancelAnimationFrame(g.current)},[]);const y=r.useCallback(e=>{const t=e/127;h(t);const a=performance.now(),r=200+200*t,s=()=>{const e=performance.now()-a,n=Math.min(e/r,1),o=t*Math.pow(1-n,2);h(o),n<1&&(g.current=requestAnimationFrame(s))};g.current&&cancelAnimationFrame(g.current),g.current=requestAnimationFrame(s)},[]),T=r.useCallback((e,t)=>{const a=t.getBoundingClientRect(),r=(e-a.top)/a.height,s=Math.floor(127*(1-r));return Math.max(1,Math.min(127,s))},[]),b=r.useCallback(t=>{if(t.preventDefault(),!e.sample)return void c(e.id);f(!0);const a=T(t.clientY,t.currentTarget);y(a),i(e.id,a)},[e.id,e.sample,i,c,T,y]),P=r.useCallback(()=>{f(!1),l?.(e.id)},[e.id,l]),x=r.useCallback(t=>{(t.shiftKey||t.metaKey||t.ctrlKey)&&c(e.id)},[e.id,c]),A=r.useCallback(t=>{if(t.preventDefault(),!e.sample)return void c(e.id);f(!0);const a=t.touches[0],r=T(a.clientY,t.currentTarget);y(r),i(e.id,r)},[e.id,e.sample,i,c,T,y]),M=r.useCallback(t=>{t.preventDefault(),f(!1),l?.(e.id),t.changedTouches.length>1&&c(e.id)},[e.id,c,l]),N=r.useMemo(()=>e.sample?{className:"bg-emerald-800",overlay:void 0}:{className:"bg-dark-border",overlay:void 0},[e.sample,t]),S=v>.01?v:0;return n.jsxDEV("button",{"data-pad-id":e.id,className:`\n        relative rounded-lg select-none overflow-hidden cursor-pointer\n        ${N.className}\n        ${e.sample?"":"opacity-40"}\n        ${p&&e.sample?"scale-95":"scale-100"}\n        ${t?"ring-2 ring-accent-primary ring-offset-2 ring-offset-dark-bg":""}\n        ${a&&!t?"ring-2 ring-blue-400 ring-offset-2 ring-offset-dark-bg":""}\n        transform-gpu will-change-transform\n        ${m}\n      `,style:{aspectRatio:"1",transition:p?"transform 50ms":"transform 120ms"},onMouseDown:b,onMouseUp:P,onMouseLeave:P,onClick:x,onFocus:d,onTouchStart:A,onTouchEnd:M,onTouchCancel:M,tabIndex:0,"aria-label":`Drum pad ${e.id}: ${e.name}${e.sample?"":" (empty - click to assign)"}`,"aria-pressed":p,role:"gridcell",children:[S>0&&n.jsxDEV("div",{className:"absolute inset-0 rounded-lg pointer-events-none",style:{background:`radial-gradient(circle at center, rgba(16, 185, 129, ${.9*S}) 0%, rgba(52, 211, 153, ${.5*S}) 60%, transparent 100%)`}},void 0,!1,{fileName:"/Users/spot/Code/DEViLBOX/src/components/drumpad/PadButton.tsx",lineNumber:185,columnNumber:9},void 0),n.jsxDEV("div",{className:"absolute top-1 left-1 text-[10px] font-mono text-white/60",children:u?e.id.toString(16).toUpperCase().padStart(2,"0"):e.id},void 0,!1,{fileName:"/Users/spot/Code/DEViLBOX/src/components/drumpad/PadButton.tsx",lineNumber:194,columnNumber:7},void 0),n.jsxDEV("div",{className:"absolute inset-0 flex items-center justify-center px-2",children:n.jsxDEV("span",{className:"text-xs font-bold text-white text-center truncate leading-tight",children:e.name},void 0,!1,{fileName:"/Users/spot/Code/DEViLBOX/src/components/drumpad/PadButton.tsx",lineNumber:200,columnNumber:9},void 0)},void 0,!1,{fileName:"/Users/spot/Code/DEViLBOX/src/components/drumpad/PadButton.tsx",lineNumber:199,columnNumber:7},void 0),n.jsxDEV("div",{className:"absolute bottom-1 left-1 flex items-center gap-0.5",children:[e.muteGroup>0&&n.jsxDEV("span",{className:"text-[8px] font-mono text-amber-400/70",children:["M",e.muteGroup]},void 0,!0,{fileName:"/Users/spot/Code/DEViLBOX/src/components/drumpad/PadButton.tsx",lineNumber:208,columnNumber:11},void 0),"sustain"===e.playMode&&n.jsxDEV("span",{className:"text-[8px] font-mono text-blue-400/70",children:"S"},void 0,!1,{fileName:"/Users/spot/Code/DEViLBOX/src/components/drumpad/PadButton.tsx",lineNumber:211,columnNumber:11},void 0),e.reverse&&n.jsxDEV("span",{className:"text-[8px] font-mono text-purple-400/70",children:"R"},void 0,!1,{fileName:"/Users/spot/Code/DEViLBOX/src/components/drumpad/PadButton.tsx",lineNumber:214,columnNumber:11},void 0)]},void 0,!0,{fileName:"/Users/spot/Code/DEViLBOX/src/components/drumpad/PadButton.tsx",lineNumber:206,columnNumber:7},void 0),o>0&&e.sample&&n.jsxDEV("div",{className:"absolute bottom-1 right-1",children:n.jsxDEV("div",{className:"w-1.5 h-1.5 rounded-full bg-emerald-400",style:{opacity:.3+o/127*.7}},void 0,!1,{fileName:"/Users/spot/Code/DEViLBOX/src/components/drumpad/PadButton.tsx",lineNumber:221,columnNumber:11},void 0)},void 0,!1,{fileName:"/Users/spot/Code/DEViLBOX/src/components/drumpad/PadButton.tsx",lineNumber:220,columnNumber:9},void 0),!e.sample&&n.jsxDEV("div",{className:"absolute inset-0 flex items-center justify-center",children:n.jsxDEV("div",{className:"text-2xl text-white/20",children:"+"},void 0,!1,{fileName:"/Users/spot/Code/DEViLBOX/src/components/drumpad/PadButton.tsx",lineNumber:231,columnNumber:11},void 0)},void 0,!1,{fileName:"/Users/spot/Code/DEViLBOX/src/components/drumpad/PadButton.tsx",lineNumber:230,columnNumber:9},void 0)]},void 0,!0,{fileName:"/Users/spot/Code/DEViLBOX/src/components/drumpad/PadButton.tsx",lineNumber:154,columnNumber:5},void 0)};class E{static MAX_VOICES=32;context;masterGain;voices=new Map;outputs=new Map;muteGroups=new Map;reversedBufferCache=new WeakMap;constructor(e,t){this.context=e,this.masterGain=this.context.createGain(),this.masterGain.connect(t??this.context.destination),this.outputs.set("stereo",this.masterGain),["out1","out2","out3","out4"].forEach(e=>{const t=this.context.createGain();t.connect(this.masterGain),this.outputs.set(e,t)})}rerouteOutput(e){this.masterGain.disconnect(),this.masterGain.connect(e)}setMuteGroups(e){this.muteGroups.clear();for(const t of e)t.muteGroup>0&&this.muteGroups.set(t.id,t.muteGroup)}getReversedBuffer(e){const t=this.reversedBufferCache.get(e);if(t)return t;const a=this.context.createBuffer(e.numberOfChannels,e.length,e.sampleRate);for(let r=0;r<e.numberOfChannels;r++){const t=e.getChannelData(r),s=a.getChannelData(r);for(let e=0;e<t.length;e++)s[e]=t[t.length-1-e]}return this.reversedBufferCache.set(e,a),a}triggerPad(e,t){let a=e.sample?.audioBuffer??null,r=0;if(e.layers.length>0){const s=e.layers.find(e=>t>=e.velocityRange[0]&&t<=e.velocityRange[1]);s?.sample?.audioBuffer&&(a=s.sample.audioBuffer,r=s.levelOffset)}if(!a)return;if(e.reverse&&(a=this.getReversedBuffer(a)),e.muteGroup>0)for(const[B,E]of this.muteGroups.entries())E===e.muteGroup&&B!==e.id&&this.stopPad(B);this.stopPad(e.id),this.voices.size>=E.MAX_VOICES&&this.stealOldestVoice();const s=this.context.currentTime,n=this.context.createBufferSource(),o=this.context.createGain(),i=this.context.createBiquadFilter(),l=this.context.createStereoPanner();n.buffer=a;const c=t/127,d=1-c,m=e.veloToPitch/100*c*12,u=e.tune/10+m;if(n.playbackRate.value=Math.pow(2,u/12),"off"!==e.filterType){switch(e.filterType){case"lpf":i.type="lowpass";break;case"hpf":i.type="highpass";break;case"bpf":i.type="bandpass"}const t=e.veloToFilter/100*c,a=e.cutoff,r=a+t*(2e4-a);if(i.frequency.value=Math.min(2e4,Math.max(20,r)),i.Q.value=e.resonance/100*20,e.filterEnvAmount>0){const t=e.filterEnvAmount/100*(2e4-r),a=e.filterAttack/100*3,n=e.filterDecay/100*2.6,o=Math.min(2e4,r+t);i.frequency.setValueAtTime(r,s),i.frequency.linearRampToValueAtTime(o,s+a),i.frequency.exponentialRampToValueAtTime(Math.max(20,r),s+a+n)}}l.pan.value=e.pan/64;const p=(1-e.veloToLevel/100*d)*(e.level/127)*(0!==r?Math.pow(10,r/20):1),f=e.attack/1e3*(1+2*(e.veloToAttack/100*d)),v=e.decay/1e3,h=e.sustain/100*p,g=e.release/1e3;o.gain.setValueAtTime(0,s),o.gain.linearRampToValueAtTime(p,s+f),o.gain.linearRampToValueAtTime(h,s+f+v),n.connect(i),i.connect(l),l.connect(o);const y=this.outputs.get(e.output)||this.masterGain;o.connect(y);const T=e.veloToStart/100*d;let b,P,x=e.sampleStart+T*(e.sampleEnd-e.sampleStart);x=Math.min(x,e.sampleEnd-.01),e.reverse?(b=(1-e.sampleEnd)*a.duration,P=(e.sampleEnd-x)*a.duration):(b=x*a.duration,P=(e.sampleEnd-x)*a.duration),n.start(s,b,P);const A=s+P/n.playbackRate.value+g+.1,M=this.context.createBuffer(1,1,this.context.sampleRate),N=this.context.createBufferSource();N.buffer=M,N.connect(this.context.destination),N.onended=()=>{this.cleanupVoice(e.id)},N.start(A);const S={source:n,gainNode:o,filterNode:i,panNode:l,startTime:s,noteOffTime:null,velocity:t,cleanupSource:N};this.voices.set(e.id,S)}stopPad(e,t){const a=this.voices.get(e);if(!a||null!==a.noteOffTime)return;const r=this.context.currentTime;a.noteOffTime=r;const s=t??.1;a.gainNode.gain.cancelScheduledValues(r),a.gainNode.gain.setValueAtTime(a.gainNode.gain.value,r),a.gainNode.gain.linearRampToValueAtTime(0,r+s);const n=r+s+.05,o=this.context.createBuffer(1,1,this.context.sampleRate),i=this.context.createBufferSource();i.buffer=o,i.connect(this.context.destination),i.onended=()=>{this.cleanupVoice(e)},i.start(n)}stealOldestVoice(){if(0===this.voices.size)return;let e=null,t=1/0;for(const[a,r]of this.voices.entries())r.startTime<t&&(t=r.startTime,e=a);null!==e&&this.stopPad(e)}cleanupVoice(e){const t=this.voices.get(e);if(t){this.voices.delete(e);try{t.source?.stop(),t.source?.disconnect(),t.gainNode.disconnect(),t.filterNode.disconnect(),t.panNode.disconnect(),t.cleanupSource?.disconnect()}catch{}}}setMasterLevel(e){this.masterGain.gain.value=e/127}setOutputLevel(e,t){const a=this.outputs.get(e);a&&(a.gain.value=t/127)}stopAll(){Array.from(this.voices.keys()).forEach(e=>this.stopPad(e))}dispose(){this.stopAll(),this.masterGain.disconnect(),this.outputs.forEach(e=>e.disconnect()),this.outputs.clear(),this.voices.clear()}}function w(e,t){const a=60/t;switch(e){case"1/4":return a;case"1/8":return a/2;case"1/16":return a/4;case"1/32":return a/8;case"1/8T":return a/3;case"1/16T":return a/6}}class C{engine;activePads=new Map;rate="1/16";bpm=125;enabled=!1;constructor(e){this.engine=e}setRate(e){this.rate=e;for(const[,t]of this.activePads.entries()){clearInterval(t.timerId);const e=w(this.rate,this.bpm);t.timerId=setInterval(()=>{this.engine.triggerPad(t.pad,t.velocity)},1e3*e)}}setBpm(e){this.bpm=e,this.activePads.size>0&&this.setRate(this.rate)}setEnabled(e){this.enabled=e,e||this.stopAll()}startRepeat(e,t){if(!this.enabled)return;this.stopRepeat(e.id);const a=w(this.rate,this.bpm),r=setInterval(()=>{this.engine.triggerPad(e,t)},1e3*a);this.activePads.set(e.id,{pad:e,velocity:t,timerId:r})}stopRepeat(e){const t=this.activePads.get(e);t&&(clearInterval(t.timerId),this.activePads.delete(e))}stopAll(){for(const[,e]of this.activePads)clearInterval(e.timerId);this.activePads.clear()}dispose(){this.stopAll()}}export{E as D,C as N,B as P,l as g,S as u};
