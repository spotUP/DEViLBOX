import{aB as e}from"./index-zx6LJBPK.js";import"./vendor-react-DkDaD07v.js";import"./vendor-utils-XMmR-oGw.js";import"./vendor-tone-CADp_hfL.js";import"./vendor-ui-uomqNFY-.js";function t(e,t){return e.getUint8(t)}function f(e,t){return e.getUint16(t,!0)}function n(e,t){return e.getUint32(t,!0)}function r(e,t,f){let n="";for(let r=0;r<f;r++){const f=e.getUint8(t+r);0!==f&&(n+=String.fromCharCode(f))}return n.trim()}function o(e,t){switch(e){case 0:return{effTyp:0,eff:0};case 1:return{effTyp:1,eff:t};case 2:return{effTyp:2,eff:t};case 3:return{effTyp:3,eff:t};case 4:return{effTyp:4,eff:t};case 5:return{effTyp:0,eff:t};case 6:return{effTyp:0,eff:0};case 7:return{effTyp:15,eff:Math.max(32,t)};case 8:return{effTyp:8,eff:2*(127&t)};case 9:return t<64?{effTyp:14,eff:120}:t<128?{effTyp:14,eff:122}:t<192?{effTyp:14,eff:124}:{effTyp:0,eff:0};case 10:return{effTyp:0,eff:0};case 11:return{effTyp:11,eff:t};case 12:return{effTyp:16,eff:Math.floor((t+1)/2)};case 13:return{effTyp:13,eff:10*(t>>4)+(15&t)};case 14:{const e=15&t;switch(t>>4){case 0:case 3:case 8:default:return{effTyp:0,eff:0};case 1:return{effTyp:25,eff:Math.min(e,14)<<4|15};case 2:return{effTyp:25,eff:240|Math.min(e,14)};case 4:return{effTyp:14,eff:48|e};case 5:return{effTyp:33,eff:e<<4^128};case 6:return{effTyp:14,eff:176|e};case 7:return{effTyp:14,eff:64|e};case 9:return{effTyp:27,eff:e};case 10:return{effTyp:17,eff:240&e+1<<3};case 11:return{effTyp:17,eff:e+1>>1&255};case 12:return{effTyp:14,eff:192|e};case 13:return{effTyp:14,eff:208|e};case 14:return{effTyp:14,eff:224|e};case 15:return{effTyp:9,eff:t}}}case 15:return{effTyp:15,eff:t};case 16:{let e=t;return e<224?(e>>=2,e>15&&(e=15),e<<=4):e=e<240?(15&e)<<2|15:e<<4|15,{effTyp:10,eff:e}}case 17:{let e=t;return e<224?(e>>=2,e>15&&(e=15)):e<240&&(e=(15&e)>>2|240),{effTyp:10,eff:e}}case 18:return{effTyp:27,eff:t};case 19:return{effTyp:7,eff:t};case 20:return{effTyp:29,eff:t};default:return{effTyp:0,eff:0}}}function a(e,t,f,n,r,a){let s=n;s>=1&&s<=6&&(s+=15);const l=o(f,r),i=o(s,a);t>0&&(e.volume=Math.floor((t+2)/4)),0===l.effTyp&&0===l.eff||(e.effTyp=l.effTyp,e.eff=l.eff),0===i.effTyp&&0===i.eff||(e.effTyp2=i.effTyp,e.eff2=i.eff)}function s(e,t){const f=new Uint8Array(t);let n=0,r=0;for(let o=0;o<t&&r<e.length;o++){const t=e[r++];let a=0;for(let e=0;e<8;e++)a|=(t>>e&1)<<7-e;n=n+(a<128?a:a-256)&255,f[o]=n}return f}function l(e,t){const f=new Int16Array(t);let n=0,r=0;for(let o=0;o<t&&r+1<e.length;o++){const t=e[r++],a=e[r++]<<8|t;let s=0;for(let e=0;e<16;e++)s|=(a>>e&1)<<15-e;n=n+(s<32768?s:s-65536)&65535;const l=n<32768?n:n-65536;f[o]=l}return f}function i(e,t){return{id:e,name:t||`Sample ${e}`,type:"sample",synthType:"Sampler",effects:[],volume:-60,pan:0}}function c(e,t,f,n,r,o,a){const s=a>o&&a>2,l=function(e,t){const f=e.length,n=2*f,r=44+n,o=new ArrayBuffer(r),a=new DataView(o),s=(e,t)=>{for(let f=0;f<t.length;f++)a.setUint8(e+f,t.charCodeAt(f))};s(0,"RIFF"),a.setUint32(4,r-8,!0),s(8,"WAVE"),s(12,"fmt "),a.setUint32(16,16,!0),a.setUint16(20,1,!0),a.setUint16(22,1,!0),a.setUint32(24,t,!0),a.setUint32(28,2*t,!0),a.setUint16(32,2,!0),a.setUint16(34,16,!0),s(36,"data"),a.setUint32(40,n,!0);let l=44;for(let i=0;i<f;i++)a.setInt16(l,e[i],!0),l+=2;return o}(f,r),i=new Uint8Array(l);let c="";for(let p=0;p<i.length;p+=8192)c+=String.fromCharCode(...Array.from(i.subarray(p,Math.min(p+8192,i.length))));const u=`data:audio/wav;base64,${btoa(c)}`;return{id:e,name:t.replace(/\0/g,"").trim()||`Sample ${e}`,type:"sample",synthType:"Sampler",effects:[],volume:n>0?20*Math.log10(n/255):-60,pan:0,sample:{audioBuffer:l,url:u,baseNote:"C3",detune:0,loop:s,loopType:s?"forward":"off",loopStart:o,loopEnd:a>0?a:f.length,sampleRate:r,reverse:!1,playbackRate:1},metadata:{modPlayback:{usePeriodPlayback:!1,periodMultiplier:3546895,finetune:0,defaultVolume:Math.round(64*n/255)}}}}function u(e){if(e.byteLength<5)return!1;const t=new DataView(e),f=String.fromCharCode(t.getUint8(0),t.getUint8(1),t.getUint8(2),t.getUint8(3)),n=t.getUint8(4);return"DMDL"===f&&n<32}async function p(o,p){if(!u(o))throw new Error("MDLParser: file does not match DMDL magic");const h=new DataView(o),y=new Uint8Array(o),m=t(h,4),g=function(e,t){const r=new Map;let o=t;const a=e.byteLength;for(;o+6<=a;){const t=f(e,o),s=n(e,o+2),l=o+6;if(l+s>a)break;r.set(t,{id:t,offset:l,length:s}),o=l+s}return r}(h,5),T=g.get(20041);if(!T)throw new Error("MDLParser: missing IN chunk");let d=T.offset;const M=r(h,d,32),w=f(h,d+52),b=f(h,d+54),U=t(h,d+57),k=t(h,d+58),A=d+59;let S=0;for(let e=0;e<32;e++){128&t(h,A+e)||(S=e+1)}S<1&&(S=1);const C=d+91,$=[];for(let e=0;e<w&&C+e<T.offset+T.length;e++)$.push(t(h,C+e));const D=[];for(let e=0;e<S;e++){let f=2*(127&t(h,A+e));f>=254&&(f=256),D.push(f-128)}const v=[],P=g.get(21076);if(P){let e=P.offset;const t=e+P.length;if(e+2<=t){const n=f(h,e);e+=2,v.push({data:new Uint8Array(0)});for(let r=1;r<=n&&e+2<=t;r++){const n=f(h,e);e+=2;const r=Math.min(e+n,t);v.push({data:y.slice(e,r)}),e+=n}}}const I=[],L=g.get(16720);if(L){let e=L.offset;const n=e+L.length;if(e<n){const o=t(h,e);e++;for(let s=0;s<o&&e<n;s++){let l=32,i=64,c="";if(m>=16){if(e+18>n)break;l=t(h,e),i=t(h,e+1)+1,c=r(h,e+2,16),e+=18}if(l>S&&(S=Math.min(l,32)),e+2*l>n)break;const u=[];for(let t=0;t<l;t++)u.push(f(h,e)),e+=2;const y=Array.from({length:i},()=>Array.from({length:S},()=>({note:0,instrument:0,volume:0,effTyp:0,eff:0,effTyp2:0,eff2:0})));for(let e=0;e<l&&e<S;e++){const t=u[e];if(0===t||t>=v.length)continue;const f=v[t].data;let n=0,r=0;for(;r<i&&n<f.length;){const t=f[n++],o=t>>2&63;switch(3&t){case 0:r+=o+1;break;case 1:if(r>0){const t=y[r-1][e];let f=o;for(;r<i&&f>=0;)y[r][e]={...t},r++,f--}break;case 2:r>o&&(y[r][e]={...y[o][e]}),r++;break;case 3:{const t=y[r][e];if(1&o){if(n>=f.length)break;const e=f[n++];t.note=e>120?97:e}if(2&o){if(n>=f.length)break;t.instrument=f[n++]}let s=0,l=0,i=0,c=0,u=0;if(4&o){if(n>=f.length)break;s=f[n++]}if(8&o){if(n>=f.length)break;const e=f[n++];l=15&e,i=e>>4}if(16&o){if(n>=f.length)break;c=f[n++]}if(32&o){if(n>=f.length)break;u=f[n++]}a(t,s,l,i,c,u),r++;break}}}}const g=Array.from({length:S},(e,t)=>({id:`channel-${t}`,name:`Channel ${t+1}`,muted:!1,solo:!1,collapsed:!1,volume:100,pan:D[t]??0,instrumentId:null,color:null,rows:y.map(e=>e[t])}));I.push({id:`pattern-${s}`,name:c||`Pattern ${s}`,length:i,channels:g,importMetadata:{sourceFormat:"MDL",sourceFile:p,importedAt:(new Date).toISOString(),originalChannelCount:S,originalPatternCount:o,originalInstrumentCount:0}})}}}const x=new Array(256).fill(null),j=g.get(21321),V=g.get(16723);if(j){let o=j.offset;const a=o+j.length;let u=V?V.offset:0;const p=V?V.offset+V.length:0;if(o<a){const g=t(h,o);o++;for(let T=0;T<g&&o<a;T++){const a=t(h,o);if(o++,0===a)break;const g=r(h,o,32);let T;o+=32,o+=8,m<16?(T=f(h,o),o+=2):(T=n(h,o),o+=4);const d=2*T;let M=n(h,o);o+=4;let w=n(h,o);o+=4;let b=n(h,o);o+=4;const U=t(h,o);o++;const k=t(h,o);o++;const A=!!(1&k),S=!!(12&k),C=0!==b;A&&(M=Math.floor(M/2),w=Math.floor(w/2),b=Math.floor(b/2));const $=C?w+b:0;if(!V||0===M||u>=p){x[a]=i(a,g||`Sample ${a}`);continue}const D=A?2*M:M,v=p-u;if(D>v){const t=v,f=y.slice(u,u+t);if(u+=t,A){const e=Math.floor(t/2),n=new Int16Array(e);for(let t=0;t<e;t++)n[t]=f[2*t+1]<<8|f[2*t];x[a]=c(a,g||`Sample ${a}`,n,U,d,w,$)}else x[a]=e(a,g||`Sample ${a}`,f,Math.round(64*U/255),d,w,$);continue}const P=y.slice(u,u+D);if(u+=D,A){let e;if(S)e=l(P,M);else{e=new Int16Array(M);for(let t=0;t<M;t++){const f=P[2*t],n=P[2*t+1]<<8|f;e[t]=n<32768?n:n-65536}}x[a]=c(a,g||`Sample ${a}`,e,U,d,w,$)}else{let t;t=S?s(P,M):P,x[a]=e(a,g||`Sample ${a}`,t,Math.round(64*U/255),d,w,$)}}}}const B=[];for(let e=1;e<256;e++)null!==x[e]&&B.push(x[e]);const E=I.length-1,F=$.filter(e=>e<=E).map(e=>e);0===F.length&&F.push(0);const R=Math.min(b,Math.max(0,F.length-1));return{name:M||p.replace(/\.[^/.]+$/i,""),format:"MOD",patterns:I,instruments:B,songPositions:F,songLength:F.length,restartPosition:R,numChannels:S,initialSpeed:Math.max(1,U),initialBPM:Math.max(4,k),linearPeriods:!1}}export{u as isMDLFormat,p as parseMDLFile};
