const e=Symbol,t=(()=>{const e="left",t="center",s="right";return["","front ","side ","rear "].map(i=>[[e,s],[e,s,t],[e,t,s],[t,e,s],[t]].flatMap(e=>e.map(e=>i+e).join(", ")))})(),s="LFE",i="monophonic (mono)",r="stereo",n="surround",a=(e,...t)=>`${[i,r,`linear ${n}`,"quadraphonic",`5.0 ${n}`,`5.1 ${n}`,`6.1 ${n}`,`7.1 ${n}`][e-1]} (${t.join(", ")})`,o=[i,a(2,t[0][0]),a(3,t[0][2]),a(4,t[1][0],t[3][0]),a(5,t[1][2],t[3][0]),a(6,t[1][2],t[3][0],s),a(7,t[1][2],t[2][0],t[3][4],s),a(8,t[1][2],t[2][0],t[3][0],s)],h=48e3,c=44100,l=32e3,u=24e3,d=22050,_=16e3,p=8e3,f="absoluteGranulePosition",g="bandwidth",m="bitDepth",C="bitrate",y=C+"Maximum",b=C+"Minimum",S=C+"Nominal",w="buffer",P=w+"Fullness",k="codec",v=k+"Frames",x="coupledStreamCount",F="crc",H=F+"16",I=F+"32",U="data",M="description",$="duration",O="emphasis",A="hasOpusPadding",N="header",R="isContinuedPacket",B="isCopyrighted",L="isFirstPage",D="isHome",E="isLastPage",T="isOriginal",G="isPrivate",q="isVbr",z="layer",V="length",j="mode",W=j+"Extension",J="mpeg",K=J+"Version",Q="numberAACFrames",X="outputGain",Y="preSkip",Z="profile",ee=e(),te="protection",se="segments",ie="subarray",re="version",ne="vorbis",ae=ne+"Comments",oe=ne+"Setup",he="block",ce=he+"ingStrategy",le=e(),ue=he+"Size",de=he+"size0",_e=he+"size1",pe=e(),fe="channel",ge=fe+"MappingFamily",me=fe+"MappingTable",Ce=fe+"Mode",ye=e(),be=fe+"s",Se="copyright",we=Se+"Id",Pe=Se+"IdStart",ke="frame",ve=ke+"Count",xe=ke+"Length",Fe="Number",He=ke+Fe,Ie=ke+"Padding",Ue=ke+"Size",Me="Rate",$e="inputSample"+Me,Oe="page",Ae=Oe+"Checksum",Ne=e(),Re=Oe+"SegmentTable",Be=Oe+"Sequence"+Fe,Le="sample",De=Le+Fe,Ee=Le+Me,Te=e(),Ge=Le+"s",qe="stream",ze=qe+"Count",Ve=qe+"Info",je=qe+"Serial"+Fe,We=qe+"StructureVersion",Je="total",Ke=Je+"BytesOut",Qe=Je+"Duration",Xe=Je+"Samples",Ye=e(),Ze=e(),et=e(),tt=e(),st=e(),it=e(),rt=e(),nt=e(),at=e(),ot=e(),ht=e(),ct=e(),lt=e(),ut=e(),dt=e(),_t=e(),pt=e(),ft=e(),gt=Uint8Array,mt=DataView,Ct="reserved",yt="bad",bt="free",St="none",wt="16bit CRC",Pt=(e,t,s)=>{for(let i=0;i<e[V];i++){let r=t(i);for(let e=8;e>0;e--)r=s(r);e[i]=r}return e},kt=Pt(new gt(256),e=>e,e=>128&e?7^e<<1:e<<1),vt=[Pt(new Uint16Array(256),e=>e<<8,e=>e<<1^(32768&e?32773:0))],xt=[Pt(new Uint32Array(256),e=>e,e=>e>>>1^3988292384*(1&e))];for(let oi=0;oi<15;oi++){vt.push(new Uint16Array(256)),xt.push(new Uint32Array(256));for(let e=0;e<=255;e++)vt[oi+1][e]=vt[0][vt[oi][e]>>>8]^vt[oi][e]<<8,xt[oi+1][e]=xt[oi][e]>>>8^xt[0][255&xt[oi][e]]}const Ft=e=>{const t=e[V],s=t-16;let i=0,r=0;for(;r<=s;)i=xt[15][255&(e[r++]^i)]^xt[14][255&(e[r++]^i>>>8)]^xt[13][255&(e[r++]^i>>>16)]^xt[12][e[r++]^i>>>24]^xt[11][e[r++]]^xt[10][e[r++]]^xt[9][e[r++]]^xt[8][e[r++]]^xt[7][e[r++]]^xt[6][e[r++]]^xt[5][e[r++]]^xt[4][e[r++]]^xt[3][e[r++]]^xt[2][e[r++]]^xt[1][e[r++]]^xt[0][e[r++]];for(;r!==t;)i=xt[0][255&(i^e[r++])]^i>>>8;return-1^i},Ht=(...e)=>{const t=new gt(e.reduce((e,t)=>e+t[V],0));return e.reduce((e,s)=>(t.set(s,e),e+s[V]),0),t},It=e=>String.fromCharCode(...e),Ut=[0,8,4,12,2,10,6,14,1,9,5,13,3,11,7,15],Mt=e=>Ut[15&e]<<4|Ut[e>>4];class $t{constructor(e){this._data=e,this._pos=8*e[V]}set position(e){this._pos=e}get position(){return this._pos}read(e){const t=Math.floor(this._pos/8),s=this._pos%8;this._pos-=e;return(Mt(this._data[t-1])<<8)+Mt(this._data[t])>>7-s&255}}class Ot{constructor(e,t){this._onCodecHeader=e,this._onCodecUpdate=t,this[dt]()}[_t](){this._isEnabled=!0}[dt](){this._headerCache=new Map,this._codecUpdateData=new WeakMap,this._codecHeaderSent=!1,this._codecShouldUpdate=!1,this._bitrate=null,this._isEnabled=!1}[ut](e,t){if(this._onCodecUpdate){this._bitrate!==e&&(this._bitrate=e,this._codecShouldUpdate=!0);const s=this._codecUpdateData.get(this._headerCache.get(this._currentHeader));this._codecShouldUpdate&&s&&this._onCodecUpdate({bitrate:e,...s},t),this._codecShouldUpdate=!1}}[at](e){const t=this._headerCache.get(e);return t&&this._updateCurrentHeader(e),t}[ot](e,t,s){this._isEnabled&&(this._codecHeaderSent||(this._onCodecHeader({...t}),this._codecHeaderSent=!0),this._updateCurrentHeader(e),this._headerCache.set(e,t),this._codecUpdateData.set(t,s))}_updateCurrentHeader(e){this._onCodecUpdate&&e!==this._currentHeader&&(this._codecShouldUpdate=!0,this._currentHeader=e)}}const At=new WeakMap,Nt=new WeakMap;class Rt{constructor(e,t){this._codecParser=e,this._headerCache=t}*[rt](){let e;for(;;){if(e=yield*this.Frame[ht](this._codecParser,this._headerCache,0),e)return e;this._codecParser[Ze](1)}}*[nt](e){let t=yield*this[rt]();const s=Nt.get(t)[V];if(e||this._codecParser._flushing||(yield*this.Header[at](this._codecParser,this._headerCache,s)))return this._headerCache[_t](),this._codecParser[Ze](s),this._codecParser[tt](t),t;this._codecParser[st](`Missing ${ke} at ${s} bytes from current position.`,`Dropping current ${ke} and trying again.`),this._headerCache[dt](),this._codecParser[Ze](1)}}class Bt{constructor(e,t){Nt.set(this,{[N]:e}),this[U]=t}}class Lt extends Bt{static*[ht](e,t,s,i,r){const n=yield*e[at](s,i,r);if(n){const e=At.get(n)[xe],i=At.get(n)[Ge];return new t(n,(yield*s[Ye](e,r))[ie](0,e),i)}return null}constructor(e,t,s){super(e,t),this[N]=e,this[Ge]=s,this[$]=s/e[Ee]*1e3,this[He]=null,this[Ke]=null,this[Xe]=null,this[Qe]=null,Nt.get(this)[V]=t[V]}}const Dt="unsynchronizationFlag",Et="extendedHeaderFlag",Tt="experimentalFlag",Gt="footerPresent";class qt{static*getID3v2Header(e,t,s){const i={};let r=yield*e[Ye](3,s);if(73!==r[0]||68!==r[1]||51!==r[2])return null;if(r=yield*e[Ye](10,s),i[re]=`id3v2.${r[3]}.${r[4]}`,15&r[5])return null;if(i[Dt]=!!(128&r[5]),i[Et]=!!(64&r[5]),i[Tt]=!!(32&r[5]),i[Gt]=!!(16&r[5]),128&r[6]||128&r[7]||128&r[8]||128&r[9])return null;const n=r[6]<<21|r[7]<<14|r[8]<<7|r[9];return i[V]=10+n,new qt(i)}constructor(e){this[re]=e[re],this[Dt]=e[Dt],this[Et]=e[Et],this[Tt]=e[Tt],this[Gt]=e[Gt],this[V]=e[V]}}class zt{constructor(e){At.set(this,e),this[m]=e[m],this[C]=null,this[be]=e[be],this[Ce]=e[Ce],this[Ee]=e[Ee]}}const Vt={0:[bt,bt,bt,bt,bt],16:[32,32,32,32,8],240:[yt,yt,yt,yt,yt]},jt=(e,t,s)=>8*((e+s)%t+t)*(1<<(e+s)/t)-8*t*(t/8|0);for(let oi=2;oi<15;oi++)Vt[oi<<4]=[32*oi,jt(oi,4,0),jt(oi,4,-1),jt(oi,8,4),jt(oi,8,0)];const Wt="bands ",Jt=" to 31",Kt={0:Wt+4+Jt,16:Wt+8+Jt,32:Wt+12+Jt,48:Wt+16+Jt},Qt="bitrateIndex",Xt="v2",Yt="v1",Zt="Intensity stereo ",es=", MS stereo ",ts="on",ss="off",is={0:Zt+ss+es+ss,16:Zt+ts+es+ss,32:Zt+ss+es+ts,48:Zt+ts+es+ts},rs={0:{[M]:Ct},2:{[M]:"Layer III",[Ie]:1,[W]:is,[Yt]:{[Qt]:2,[Ge]:1152},[Xt]:{[Qt]:4,[Ge]:576}},4:{[M]:"Layer II",[Ie]:1,[W]:Kt,[Ge]:1152,[Yt]:{[Qt]:1},[Xt]:{[Qt]:4}},6:{[M]:"Layer I",[Ie]:4,[W]:Kt,[Ge]:384,[Yt]:{[Qt]:0},[Xt]:{[Qt]:3}}},ns="MPEG Version ",as="ISO/IEC ",os={0:{[M]:`${ns}2.5 (later extension of MPEG 2)`,[z]:Xt,[Ee]:{0:11025,4:12e3,8:p,12:Ct}},8:{[M]:Ct},16:{[M]:`${ns}2 (${as}13818-3)`,[z]:Xt,[Ee]:{0:d,4:u,8:_,12:Ct}},24:{[M]:`${ns}1 (${as}11172-3)`,[z]:Yt,[Ee]:{0:c,4:h,8:l,12:Ct}},length:V},hs={0:wt,1:St},cs={0:St,1:"50/15 ms",2:Ct,3:"CCIT J.17"},ls={0:{[be]:2,[M]:r},64:{[be]:2,[M]:"joint "+r},128:{[be]:2,[M]:"dual channel"},192:{[be]:1,[M]:i}};class us extends zt{static*[at](e,t,s){const i={},r=yield*qt.getID3v2Header(e,t,s);r&&(yield*e[Ye](r[V],s),e[Ze](r[V]));const n=yield*e[Ye](4,s),a=It(n[ie](0,4)),o=t[at](a);if(o)return new us(o);if(255!==n[0]||n[1]<224)return null;const h=os[24&n[1]];if(h[M]===Ct)return null;const c=6&n[1];if(rs[c][M]===Ct)return null;const l={...rs[c],...rs[c][h[z]]};if(i[K]=h[M],i[z]=l[M],i[Ge]=l[Ge],i[te]=hs[1&n[1]],i[V]=4,i[C]=Vt[240&n[2]][l[Qt]],i[C]===yt)return null;if(i[Ee]=h[Ee][12&n[2]],i[Ee]===Ct)return null;if(i[Ie]=2&n[2]&&l[Ie],i[G]=!!(1&n[2]),i[xe]=Math.floor(125*i[C]*i[Ge]/i[Ee]+i[Ie]),!i[xe])return null;const u=192&n[3];if(i[Ce]=ls[u][M],i[be]=ls[u][be],i[W]=l[W][48&n[3]],i[B]=!!(8&n[3]),i[T]=!!(4&n[3]),i[O]=cs[3&n[3]],i[O]===Ct)return null;i[m]=16;{const{length:e,frameLength:s,samples:r,...n}=i;t[ot](a,i,n)}return new us(i)}constructor(e){super(e),this[C]=e[C],this[O]=e[O],this[Ie]=e[Ie],this[B]=e[B],this[T]=e[T],this[G]=e[G],this[z]=e[z],this[W]=e[W],this[K]=e[K],this[te]=e[te]}}class ds extends Lt{static*[ht](e,t,s){return yield*super[ht](us,ds,e,t,s)}constructor(e,t,s){super(e,t,s)}}class _s extends Rt{constructor(e,t,s){super(e,t),this.Frame=ds,this.Header=us,s(this[k])}get[k](){return J}*[ct](){return yield*this[nt]()}}const ps={0:"MPEG-4",8:"MPEG-2"},fs={0:"valid",2:yt,4:yt,6:yt},gs={0:wt,1:St},ms={0:"AAC Main",64:"AAC LC (Low Complexity)",128:"AAC SSR (Scalable Sample Rate)",192:"AAC LTP (Long Term Prediction)"},Cs={0:96e3,4:88200,8:64e3,12:h,16:c,20:l,24:u,28:d,32:_,36:12e3,40:11025,44:p,48:7350,52:Ct,56:Ct,60:"frequency is written explicitly"},ys={0:{[be]:0,[M]:"Defined in AOT Specific Config"},64:{[be]:1,[M]:i},128:{[be]:2,[M]:a(2,t[0][0])},192:{[be]:3,[M]:a(3,t[1][3])},256:{[be]:4,[M]:a(4,t[1][3],t[3][4])},320:{[be]:5,[M]:a(5,t[1][3],t[3][0])},384:{[be]:6,[M]:a(6,t[1][3],t[3][0],s)},448:{[be]:8,[M]:a(8,t[1][3],t[2][0],t[3][0],s)}};class bs extends zt{static*[at](e,t,s){const i={},r=yield*e[Ye](7,s),n=It([r[0],r[1],r[2],252&r[3]|3&r[6]]),a=t[at](n);if(a)Object.assign(i,a);else{if(255!==r[0]||r[1]<240)return null;if(i[K]=ps[8&r[1]],i[z]=fs[6&r[1]],i[z]===yt)return null;const e=1&r[1];i[te]=gs[e],i[V]=e?7:9,i[ee]=192&r[2],i[Te]=60&r[2];const s=2&r[2];if(i[Z]=ms[i[ee]],i[Ee]=Cs[i[Te]],i[Ee]===Ct)return null;i[G]=!!s,i[ye]=448&(r[2]<<8|r[3]),i[Ce]=ys[i[ye]][M],i[be]=ys[i[ye]][be],i[T]=!!(32&r[3]),i[D]=!!(8&r[3]),i[we]=!!(8&r[3]),i[Pe]=!!(4&r[3]),i[m]=16,i[Ge]=1024,i[Q]=3&r[6];{const{length:e,channelModeBits:s,profileBits:r,sampleRateBits:a,frameLength:o,samples:h,numberAACFrames:c,...l}=i;t[ot](n,i,l)}}if(i[xe]=8191&(r[3]<<11|r[4]<<3|r[5]>>5),!i[xe])return null;const o=2047&(r[5]<<6|r[6]>>2);return i[P]=2047===o?"VBR":o,new bs(i)}constructor(e){super(e),this[we]=e[we],this[Pe]=e[Pe],this[P]=e[P],this[D]=e[D],this[T]=e[T],this[G]=e[G],this[z]=e[z],this[V]=e[V],this[K]=e[K],this[Q]=e[Q],this[Z]=e[Z],this[te]=e[te]}get audioSpecificConfig(){const e=At.get(this),t=e[ee]+64<<5|e[Te]<<5|e[ye]>>3,s=new gt(2);return new mt(s[w]).setUint16(0,t,!1),s}}class Ss extends Lt{static*[ht](e,t,s){return yield*super[ht](bs,Ss,e,t,s)}constructor(e,t,s){super(e,t,s)}}class ws extends Rt{constructor(e,t,s){super(e,t),this.Frame=Ss,this.Header=bs,s(this[k])}get[k](){return"aac"}*[ct](){return yield*this[nt]()}}class Ps extends Lt{static _getFrameFooterCrc16(e){return(e[e[V]-2]<<8)+e[e[V]-1]}static[ft](e){return Ps._getFrameFooterCrc16(e)===(e=>{const t=e[V],s=t-16;let i=0,r=0;for(;r<=s;)i^=e[r++]<<8|e[r++],i=vt[15][i>>8]^vt[14][255&i]^vt[13][e[r++]]^vt[12][e[r++]]^vt[11][e[r++]]^vt[10][e[r++]]^vt[9][e[r++]]^vt[8][e[r++]]^vt[7][e[r++]]^vt[6][e[r++]]^vt[5][e[r++]]^vt[4][e[r++]]^vt[3][e[r++]]^vt[2][e[r++]]^vt[1][e[r++]]^vt[0][e[r++]];for(;r!==t;)i=(255&i)<<8^vt[0][i>>8^e[r++]];return i})(e[ie](0,-2))}constructor(e,t,s){t[Ve]=s,t[H]=Ps._getFrameFooterCrc16(e),super(t,e,At.get(t)[Ge])}}const ks="get from STREAMINFO metadata block",vs={0:"Fixed",1:"Variable"},xs={0:Ct,16:192};for(let oi=2;oi<16;oi++)xs[oi<<4]=oi<6?576*2**(oi-2):2**oi;const Fs={0:ks,1:88200,2:176400,3:192e3,4:p,5:_,6:d,7:u,8:l,9:c,10:h,11:96e3,15:yt},Hs={0:{[be]:1,[M]:i},16:{[be]:2,[M]:a(2,t[0][0])},32:{[be]:3,[M]:a(3,t[0][1])},48:{[be]:4,[M]:a(4,t[1][0],t[3][0])},64:{[be]:5,[M]:a(5,t[1][1],t[3][0])},80:{[be]:6,[M]:a(6,t[1][1],s,t[3][0])},96:{[be]:7,[M]:a(7,t[1][1],s,t[3][4],t[2][0])},112:{[be]:8,[M]:a(8,t[1][1],s,t[3][0],t[2][0])},128:{[be]:2,[M]:`${r} (left, diff)`},144:{[be]:2,[M]:`${r} (diff, right)`},160:{[be]:2,[M]:`${r} (avg, diff)`},176:Ct,192:Ct,208:Ct,224:Ct,240:Ct},Is={0:ks,2:8,4:12,6:Ct,8:16,10:20,12:24,14:Ct};class Us extends zt{static _decodeUTF8Int(e){if(e[0]>254)return null;if(e[0]<128)return{value:e[0],length:1};let t=1;for(let n=64;n&e[0];n>>=1)t++;let s=t-1,i=0,r=0;for(;s>0;r+=6,s--){if(128!=(192&e[s]))return null;i|=(63&e[s])<<r}return i|=(e[s]&127>>t)<<r,{value:i,length:t}}static[pt](e,t){const s={[Ye]:function*(){return e}};return Us[at](s,t,0).next().value}static*[at](e,t,s){let i=yield*e[Ye](6,s);if(255!==i[0]||248!==i[1]&&249!==i[1])return null;const r={},n=It(i[ie](0,4)),a=t[at](n);if(a)Object.assign(r,a);else{if(r[le]=1&i[1],r[ce]=vs[r[le]],r[pe]=240&i[2],r[Te]=15&i[2],r[ue]=xs[r[pe]],r[ue]===Ct)return null;if(r[Ee]=Fs[r[Te]],r[Ee]===yt)return null;if(1&i[3])return null;const e=Hs[240&i[3]];if(e===Ct)return null;if(r[be]=e[be],r[Ce]=e[M],r[m]=Is[14&i[3]],r[m]===Ct)return null}r[V]=5,i=yield*e[Ye](r[V]+8,s);const o=Us._decodeUTF8Int(i[ie](4));if(!o)return null;if(r[le]?r[De]=o.value:r[He]=o.value,r[V]+=o[V],96===r[pe]?(i[V]<r[V]&&(i=yield*e[Ye](r[V],s)),r[ue]=i[r[V]-1]+1,r[V]+=1):112===r[pe]&&(i[V]<r[V]&&(i=yield*e[Ye](r[V],s)),r[ue]=(i[r[V]-1]<<8)+i[r[V]]+1,r[V]+=2),r[Ge]=r[ue],12===r[Te]?(i[V]<r[V]&&(i=yield*e[Ye](r[V],s)),r[Ee]=1e3*i[r[V]-1],r[V]+=1):13===r[Te]?(i[V]<r[V]&&(i=yield*e[Ye](r[V],s)),r[Ee]=(i[r[V]-1]<<8)+i[r[V]],r[V]+=2):14===r[Te]&&(i[V]<r[V]&&(i=yield*e[Ye](r[V],s)),r[Ee]=10*((i[r[V]-1]<<8)+i[r[V]]),r[V]+=2),i[V]<r[V]&&(i=yield*e[Ye](r[V],s)),r[F]=i[r[V]-1],r[F]!==(e=>{let t=0;const s=e[V];for(let i=0;i!==s;i++)t=kt[t^e[i]];return t})(i[ie](0,r[V]-1)))return null;if(!a){const{blockingStrategyBits:e,frameNumber:s,sampleNumber:i,samples:a,sampleRateBits:o,blockSizeBits:h,crc:c,length:l,...u}=r;t[ot](n,r,u)}return new Us(r)}constructor(e){super(e),this[H]=null,this[ce]=e[ce],this[ue]=e[ue],this[He]=e[He],this[De]=e[De],this[Ve]=null}}class Ms extends Rt{constructor(e,t,s){super(e,t),this.Frame=Ps,this.Header=Us,s(this[k])}get[k](){return"flac"}*_getNextFrameSyncOffset(e){const t=yield*this._codecParser[Ye](2,0),s=t[V]-2;for(;e<s;){if(255===t[e]){const s=t[e+1];if(248===s||249===s)break;255!==s&&e++}e++}return e}*[ct](){for(;;){const e=yield*Us[at](this._codecParser,this._headerCache,0);if(e){let t=At.get(e)[V]+2;for(;t<=524288;){if(this._codecParser._flushing||(yield*Us[at](this._codecParser,this._headerCache,t))){let s=yield*this._codecParser[Ye](t);if(this._codecParser._flushing||(s=s[ie](0,t)),Ps[ft](s)){const i=new Ps(s,e);return this._headerCache[_t](),this._codecParser[Ze](t),this._codecParser[tt](i),i}}t=yield*this._getNextFrameSyncOffset(t+1)}this._codecParser[st](`Unable to sync FLAC frame after searching ${t} bytes.`),this._codecParser[Ze](t)}else this._codecParser[Ze](yield*this._getNextFrameSyncOffset(1))}}[lt](e){return 0===e[Be]?(this._headerCache[_t](),this._streamInfo=e[U][ie](13)):1===e[Be]||(e[v]=Nt.get(e)[se].map(e=>{const t=Us[pt](e,this._headerCache);if(t)return new Ps(e,t,this._streamInfo);this._codecParser[st]("Failed to parse Ogg FLAC frame","Skipping invalid FLAC frame")}).filter(e=>!!e)),e}}class $s{static*[at](e,t,s){const i={};let r=yield*e[Ye](28,s);if(79!==r[0]||103!==r[1]||103!==r[2]||83!==r[3])return null;i[We]=r[4];if(248&r[5])return null;i[E]=!!(4&r[5]),i[L]=!!(2&r[5]),i[R]=!!(1&r[5]);const n=new mt(gt.from(r[ie](0,28))[w]);i[f]=((e,t)=>{try{return e.getBigInt64(t,!0)}catch{const s=128&e.getUint8(t+7)?-1:1;let i=e.getUint32(t,!0),r=e.getUint32(t+4,!0);return-1===s&&(i=1+~i,r=1+~r),s*(i+r*2**32)}})(n,6),i[je]=n.getInt32(14,!0),i[Be]=n.getInt32(18,!0),i[Ae]=n.getInt32(22,!0);const a=r[26];i[V]=a+27,r=yield*e[Ye](i[V],s),i[xe]=0,i[Re]=[],i[Ne]=gt.from(r[ie](27,i[V]));for(let o=0,h=0;o<a;o++){const e=i[Ne][o];i[xe]+=e,h+=e,255===e&&o!==a-1||(i[Re].push(h),h=0)}return new $s(i)}constructor(e){At.set(this,e),this[f]=e[f],this[R]=e[R],this[L]=e[L],this[E]=e[E],this[Re]=e[Re],this[Be]=e[Be],this[Ae]=e[Ae],this[je]=e[je]}}class Os extends Bt{static*[ht](e,t,s){const i=yield*$s[at](e,t,s);if(i){const t=At.get(i)[xe],s=At.get(i)[V],r=s+t,n=(yield*e[Ye](r,0))[ie](0,r),a=n[ie](s,r);return new Os(i,a,n)}return null}constructor(e,t,s){super(e,t),Nt.get(this)[V]=s[V],this[v]=[],this.rawData=s,this[f]=e[f],this[I]=e[Ae],this[$]=0,this[R]=e[R],this[L]=e[L],this[E]=e[E],this[Be]=e[Be],this[Ge]=0,this[je]=e[je]}}class As extends Lt{constructor(e,t,s){super(t,e,s)}}const Ns={0:o.slice(0,2),1:o},Rs="SILK-only",Bs="CELT-only",Ls="Hybrid",Ds="narrowband",Es="medium-band",Ts="wideband",Gs="super-wideband",qs="fullband",zs={0:{[j]:Rs,[g]:Ds,[Ue]:10},8:{[j]:Rs,[g]:Ds,[Ue]:20},16:{[j]:Rs,[g]:Ds,[Ue]:40},24:{[j]:Rs,[g]:Ds,[Ue]:60},32:{[j]:Rs,[g]:Es,[Ue]:10},40:{[j]:Rs,[g]:Es,[Ue]:20},48:{[j]:Rs,[g]:Es,[Ue]:40},56:{[j]:Rs,[g]:Es,[Ue]:60},64:{[j]:Rs,[g]:Ts,[Ue]:10},72:{[j]:Rs,[g]:Ts,[Ue]:20},80:{[j]:Rs,[g]:Ts,[Ue]:40},88:{[j]:Rs,[g]:Ts,[Ue]:60},96:{[j]:Ls,[g]:Gs,[Ue]:10},104:{[j]:Ls,[g]:Gs,[Ue]:20},112:{[j]:Ls,[g]:qs,[Ue]:10},120:{[j]:Ls,[g]:qs,[Ue]:20},128:{[j]:Bs,[g]:Ds,[Ue]:2.5},136:{[j]:Bs,[g]:Ds,[Ue]:5},144:{[j]:Bs,[g]:Ds,[Ue]:10},152:{[j]:Bs,[g]:Ds,[Ue]:20},160:{[j]:Bs,[g]:Ts,[Ue]:2.5},168:{[j]:Bs,[g]:Ts,[Ue]:5},176:{[j]:Bs,[g]:Ts,[Ue]:10},184:{[j]:Bs,[g]:Ts,[Ue]:20},192:{[j]:Bs,[g]:Gs,[Ue]:2.5},200:{[j]:Bs,[g]:Gs,[Ue]:5},208:{[j]:Bs,[g]:Gs,[Ue]:10},216:{[j]:Bs,[g]:Gs,[Ue]:20},224:{[j]:Bs,[g]:qs,[Ue]:2.5},232:{[j]:Bs,[g]:qs,[Ue]:5},240:{[j]:Bs,[g]:qs,[Ue]:10},248:{[j]:Bs,[g]:qs,[Ue]:20}};class Vs extends zt{static[pt](e,t,s){const i={};if(i[be]=e[9],i[ge]=e[18],i[V]=0!==i[ge]?21+i[be]:19,e[V]<i[V])throw new Error("Out of data while inside an Ogg Page");const r=3&t[0],n=3===r?2:1,a=It(e[ie](0,i[V]))+It(t[ie](0,n)),o=s[at](a);if(o)return new Vs(o);if("OpusHead"!==a.substr(0,8))return null;if(1!==e[8])return null;i[U]=gt.from(e[ie](0,i[V]));const c=new mt(i[U][w]);if(i[m]=16,i[Y]=c.getUint16(10,!0),i[$e]=c.getUint32(12,!0),i[Ee]=h,i[X]=c.getInt16(16,!0),i[ge]in Ns&&(i[Ce]=Ns[i[ge]][i[be]-1],!i[Ce]))return null;0!==i[ge]&&(i[ze]=e[19],i[x]=e[20],i[me]=[...e[ie](21,i[be]+21)]);const l=zs[248&t[0]];switch(i[j]=l[j],i[g]=l[g],i[Ue]=l[Ue],r){case 0:i[ve]=1;break;case 1:case 2:i[ve]=2;break;case 3:i[q]=!!(128&t[1]),i[A]=!!(64&t[1]),i[ve]=63&t[1];break;default:return null}{const{length:e,data:t,channelMappingFamily:r,...n}=i;s[ot](a,i,n)}return new Vs(i)}constructor(e){super(e),this[U]=e[U],this[g]=e[g],this[ge]=e[ge],this[me]=e[me],this[x]=e[x],this[ve]=e[ve],this[Ue]=e[Ue],this[A]=e[A],this[$e]=e[$e],this[q]=e[q],this[j]=e[j],this[X]=e[X],this[Y]=e[Y],this[ze]=e[ze]}}class js extends Rt{constructor(e,t,s){super(e,t),this.Frame=As,this.Header=Vs,s(this[k]),this._identificationHeader=null,this._preSkipRemaining=null}get[k](){return"opus"}[lt](e){return 0===e[Be]?(this._headerCache[_t](),this._identificationHeader=e[U]):1===e[Be]||(e[v]=Nt.get(e)[se].map(e=>{const t=Vs[pt](this._identificationHeader,e,this._headerCache);if(t){null===this._preSkipRemaining&&(this._preSkipRemaining=t[Y]);let s=t[Ue]*t[ve]/1e3*t[Ee];return this._preSkipRemaining>0&&(this._preSkipRemaining-=s,s=this._preSkipRemaining<0?-this._preSkipRemaining:0),new As(e,t,s)}this._codecParser[it]("Failed to parse Ogg Opus Header","Not a valid Ogg Opus file")})),e}}class Ws extends Lt{constructor(e,t,s){super(t,e,s)}}const Js={};for(let oi=0;oi<8;oi++)Js[oi+6]=2**(6+oi);class Ks extends zt{static[pt](e,t,s,i){if(e[V]<30)throw new Error("Out of data while inside an Ogg Page");const r=It(e[ie](0,30)),n=t[at](r);if(n)return new Ks(n);const a={[V]:30};if("vorbis"!==r.substr(0,7))return null;a[U]=gt.from(e[ie](0,30));const h=new mt(a[U][w]);if(a[re]=h.getUint32(7,!0),0!==a[re])return null;if(a[be]=e[11],a[Ce]=o[a[be]-1]||"application defined",a[Ee]=h.getUint32(12,!0),a[y]=h.getInt32(16,!0),a[S]=h.getInt32(20,!0),a[b]=h.getInt32(24,!0),a[_e]=Js[(240&e[28])>>4],a[de]=Js[15&e[28]],a[de]>a[_e])return null;if(1!==e[29])return null;a[m]=32,a[oe]=i,a[ae]=s;{const{length:e,data:s,version:i,vorbisSetup:n,vorbisComments:o,...h}=a;t[ot](r,a,h)}return new Ks(a)}constructor(e){super(e),this[y]=e[y],this[b]=e[b],this[S]=e[S],this[de]=e[de],this[_e]=e[_e],this[U]=e[U],this[ae]=e[ae],this[oe]=e[oe]}}class Qs extends Rt{constructor(e,t,s){super(e,t),this.Frame=Ws,s(this[k]),this._identificationHeader=null,this._setupComplete=!1,this._prevBlockSize=null}get[k](){return ne}[lt](e){e[v]=[];for(const t of Nt.get(e)[se])if(1===t[0])this._headerCache[_t](),this._identificationHeader=e[U],this._setupComplete=!1;else if(3===t[0])this._vorbisComments=t;else if(5===t[0])this._vorbisSetup=t,this._mode=this._parseSetupHeader(t),this._setupComplete=!0;else if(this._setupComplete){const s=Ks[pt](this._identificationHeader,this._headerCache,this._vorbisComments,this._vorbisSetup);s?e[v].push(new Ws(t,s,this._getSamples(t,s))):this._codecParser[logError]("Failed to parse Ogg Vorbis Header","Not a valid Ogg Vorbis file")}return e}_getSamples(e,t){const s=this._mode.blockFlags[e[0]>>1&this._mode.mask]?t[_e]:t[de],i=null===this._prevBlockSize?0:(this._prevBlockSize+s)/4;return this._prevBlockSize=s,i}_parseSetupHeader(e){const t=new $t(e),s={count:0,blockFlags:[]};for(;1&~t.read(1););let i;for(;s.count<64&&t.position>0;){Mt(t.read(8));let e=0;for(;0===t.read(8)&&e++<3;);if(4!==e){1+((126&Mt(i))>>1)!==s.count&&this._codecParser[st]("vorbis derived mode count did not match actual mode count");break}i=t.read(7),s.blockFlags.unshift(1&i),t.position+=6,s.count++}return s.mask=(1<<Math.log2(s.count))-1,s}}class Xs{constructor(e,t,s){this._codecParser=e,this._headerCache=t,this._onCodec=s,this._continuedPacket=new gt,this._codec=null,this._isSupported=null,this._previousAbsoluteGranulePosition=null}get[k](){return this._codec||""}_updateCodec(e,t){this._codec!==e&&(this._headerCache[dt](),this._parser=new t(this._codecParser,this._headerCache,this._onCodec),this._codec=e)}_checkCodecSupport({data:e}){const t=It(e[ie](0,8));switch(t){case"fishead\0":return!1;case"OpusHead":return this._updateCodec("opus",js),!0;case/^\x7fFLAC/.test(t)&&t:return this._updateCodec("flac",Ms),!0;case/^\x01vorbis/.test(t)&&t:return this._updateCodec(ne,Qs),!0;default:return!1}}_checkPageSequenceNumber(e){e[Be]!==this._pageSequenceNumber+1&&this._pageSequenceNumber>1&&e[Be]>1&&this._codecParser[st]("Unexpected gap in Ogg Page Sequence Number.",`Expected: ${this._pageSequenceNumber+1}, Got: ${e[Be]}`),this._pageSequenceNumber=e[Be]}_parsePage(e){null===this._isSupported&&(this._pageSequenceNumber=e[Be],this._isSupported=this._checkCodecSupport(e)),this._checkPageSequenceNumber(e);const t=Nt.get(e),s=At.get(t[N]);let i=0;if(t[se]=s[Re].map(t=>e[U][ie](i,i+=t)),this._continuedPacket[V]&&(t[se][0]=Ht(this._continuedPacket,t[se][0]),this._continuedPacket=new gt),255===s[Ne][s[Ne][V]-1]&&(this._continuedPacket=Ht(this._continuedPacket,t[se].pop())),null!==this._previousAbsoluteGranulePosition&&(e[Ge]=Number(e[f]-this._previousAbsoluteGranulePosition)),this._previousAbsoluteGranulePosition=e[f],this._isSupported){const t=this._parser[lt](e);return this._codecParser[tt](t),t}return e}}class Ys extends Rt{constructor(e,t,s){super(e,t),this._onCodec=s,this.Frame=Os,this.Header=$s,this._streams=new Map,this._currentSerialNumber=null}get[k](){const e=this._streams.get(this._currentSerialNumber);return e?e.codec:""}*[ct](){const e=yield*this[nt](!0);this._currentSerialNumber=e[je];let t=this._streams.get(this._currentSerialNumber);return t||(t=new Xs(this._codecParser,this._headerCache,this._onCodec),this._streams.set(this._currentSerialNumber,t)),e[E]&&this._streams.delete(this._currentSerialNumber),t._parsePage(e)}}const Zs=()=>{};class ei{constructor(e,{onCodec:t,onCodecHeader:s,onCodecUpdate:i,enableLogging:r=!1,enableFrameCRC32:n=!0}={}){this._inputMimeType=e,this._onCodec=t||Zs,this._onCodecHeader=s||Zs,this._onCodecUpdate=i,this._enableLogging=r,this._crc32=n?Ft:Zs,this[dt]()}get[k](){return this._parser?this._parser[k]:""}[dt](){this._headerCache=new Ot(this._onCodecHeader,this._onCodecUpdate),this._generator=this._getGenerator(),this._generator.next()}*flush(){this._flushing=!0;for(let e=this._generator.next();e.value;e=this._generator.next())yield e.value;this._flushing=!1,this[dt]()}*parseChunk(e){for(let t=this._generator.next(e);t.value;t=this._generator.next())yield t.value}parseAll(e){return[...this.parseChunk(e),...this.flush()]}*_getGenerator(){if(this._inputMimeType.match(/aac/))this._parser=new ws(this,this._headerCache,this._onCodec);else if(this._inputMimeType.match(/mpeg/))this._parser=new _s(this,this._headerCache,this._onCodec);else if(this._inputMimeType.match(/flac/))this._parser=new Ms(this,this._headerCache,this._onCodec);else{if(!this._inputMimeType.match(/ogg/))throw new Error(`Unsupported Codec ${mimeType}`);this._parser=new Ys(this,this._headerCache,this._onCodec)}for(this._frameNumber=0,this._currentReadPosition=0,this._totalBytesIn=0,this._totalBytesOut=0,this._totalSamples=0,this._sampleRate=void 0,this._rawData=new Uint8Array(0);;){const e=yield*this._parser[ct]();e&&(yield e)}}*[Ye](e=0,t=0){let s;for(;this._rawData[V]<=e+t;){if(s=yield,this._flushing)return this._rawData[ie](t);s&&(this._totalBytesIn+=s[V],this._rawData=Ht(this._rawData,s))}return this._rawData[ie](t)}[Ze](e){this._currentReadPosition+=e,this._rawData=this._rawData[ie](e)}[et](e){this._sampleRate=e[N][Ee],e[N][C]=e[$]>0?8*Math.round(e[U][V]/e[$]):0,e[He]=this._frameNumber++,e[Ke]=this._totalBytesOut,e[Xe]=this._totalSamples,e[Qe]=this._totalSamples/this._sampleRate*1e3,e[I]=this._crc32(e[U]),this._headerCache[ut](e[N][C],e[Qe]),this._totalBytesOut+=e[U][V],this._totalSamples+=e[Ge]}[tt](e){if(e[v]){if(e[E]){let t=e[Ge];e[v].forEach(e=>{const s=e[Ge];t<s&&(e[Ge]=t>0?t:0,e[$]=e[Ge]/e[N][Ee]*1e3),t-=s,this[et](e)})}else e[Ge]=0,e[v].forEach(t=>{e[Ge]+=t[Ge],this[et](t)});e[$]=e[Ge]/this._sampleRate*1e3||0,e[Xe]=this._totalSamples,e[Qe]=this._totalSamples/this._sampleRate*1e3||0,e[Ke]=this._totalBytesOut}else this[et](e)}_log(e,t){if(this._enableLogging){const s=[`${k}:         ${this[k]}`,`inputMimeType: ${this._inputMimeType}`,`readPosition:  ${this._currentReadPosition}`,`totalBytesIn:  ${this._totalBytesIn}`,`${Ke}: ${this._totalBytesOut}`],i=Math.max(...s.map(e=>e[V]));t.push(`--stats--${"-".repeat(i-9)}`,...s,"-".repeat(i)),e("codec-parser",t.reduce((e,t)=>e+"\n  "+t,""))}}[st](...e){this._log(console.warn,e)}[it](...e){this._log(console.error,e)}}const ti=v,si=U,ii=N,ri=E,ni=oe,ai=Xe;export{ei as C,ti as c,si as d,ii as h,ri as i,ai as t,ni as v};
