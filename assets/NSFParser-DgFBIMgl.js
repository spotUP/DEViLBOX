import{aU as n}from"./index-zx6LJBPK.js";import{C as e}from"./Cpu6502-B9laXm8V.js";import"./vendor-react-DkDaD07v.js";import"./vendor-utils-XMmR-oGw.js";import"./vendor-tone-CADp_hfL.js";import"./vendor-ui-uomqNFY-.js";function t(){return{note:0,instrument:0,volume:0,effTyp:0,eff:0,effTyp2:0,eff2:0}}function r(n,e,t){let r="";for(let o=0;o<t;o++){const t=n[e+o];if(0===t)break;r+=String.fromCharCode(t)}return r.trim()}function o(n,e=!1){if(n<=0)return 0;const t=1789773/((e?32:16)*(n+1));if(t<20||t>2e4)return 0;const r=Math.round(12*Math.log2(t/440)+69);return r>=1&&r<=96?r:0}function s(n){const e=new Uint8Array(n);return e.length>=5&&78===e[0]&&69===e[1]&&83===e[2]&&77===e[3]&&26===e[4]}function l(n){const e=new Uint8Array(n);return e.length>=4&&78===e[0]&&83===e[1]&&70===e[2]&&69===e[3]}async function a(a,i){const u=new Uint8Array(a);let f="",c="",p=1,h=0,m=32768,y=32768,d=32768,g=!1;if(s(a))f=r(u,14,34),c=r(u,48,34),p=u[6]||1,h=u[127],m=u[8]|u[9]<<8,y=u[10]|u[11]<<8,d=u[12]|u[13]<<8,g=!!(1&u[112]);else{if(!l(a))throw new Error("Not a valid NSF/NSFE file");{const n=new DataView(a);let e=4;for(;e+8<=u.length;){const t=n.getUint32(e,!0),o=String.fromCharCode(u[e+4],u[e+5],u[e+6],u[e+7]);if(e+=8,"INFO"===o&&t>=9)m=n.getUint16(e,!0),y=n.getUint16(e+2,!0),d=n.getUint16(e+4,!0),p=u[e+6]||1,h=u[e+8];else if("auth"===o&&t>0){let n=e,o=0;for(let s=e;s<e+t;s++)if(0===u[s]||s===e+t-1){const e=r(u,n,s-n+1);0===o&&(f=e),1===o&&(c=e),n=s+1,o++}}else if("NEND"===o)break;e+=t}}}const v=function(e){const t=[];let r=1;const o=["NES Pulse 1","NES Pulse 2","NES Triangle","NES Noise"];for(const s of o)t.push({id:r++,name:s,type:"synth",synthType:"FurnaceNES",furnace:{...n,chipType:34,ops:2},effects:[],volume:0,pan:0});if(1&e)for(const s of["VRC6 Pulse 1","VRC6 Pulse 2","VRC6 Sawtooth"])t.push({id:r++,name:s,type:"synth",synthType:"FurnaceNES",furnace:{...n,chipType:34,ops:2},effects:[],volume:0,pan:0});if(2&e)for(let s=0;s<6;s++)t.push({id:r++,name:`VRC7 FM ${s+1}`,type:"synth",synthType:"FurnaceOPLL",furnace:{...n,chipType:13,ops:2},effects:[],volume:0,pan:0});if(4&e&&t.push({id:r++,name:"FDS Wave",type:"synth",synthType:"FurnaceFDS",furnace:{...n,chipType:15,ops:2},effects:[],volume:0,pan:0}),8&e)for(const s of["MMC5 Pulse 1","MMC5 Pulse 2"])t.push({id:r++,name:s,type:"synth",synthType:"FurnaceMMC5",furnace:{...n,chipType:34,ops:2},effects:[],volume:0,pan:0});if(16&e)for(let s=0;s<8;s++)t.push({id:r++,name:`N163 Wave ${s+1}`,type:"synth",synthType:"FurnaceN163",furnace:{...n,chipType:17,ops:2},effects:[],volume:0,pan:0});if(32&e)for(let s=0;s<3;s++)t.push({id:r++,name:`5B AY ${s+1}`,type:"synth",synthType:"FurnaceAY",furnace:{...n,chipType:6,ops:2},effects:[],volume:0,pan:0});return t}(h);let w;if(m>0&&y>0&&d>0)try{const n=function(n,t,r,s,l,a){const i=new Uint8Array(65536),u=n.subarray(128),f=Math.min(u.length,65536-t);i.set(u.subarray(0,f),t),i[65535]=96;const c=new Uint8Array(32),p=new e({read:n=>n>=16384&&n<16416?c[n-16384]:i[65535&n],write(n,e){i[65535&n]=e,n>=16384&&n<16416&&(c[n-16384]=e)}});p.reset(r),p.setA(0),p.setX(l?1:0),p.callSubroutine(r);const h=l?35464:29780,m=[];for(let e=0;e<900;e++){p.callSubroutine(s,h);const n=new Array(a).fill(null);if(1&c[21]){const e=(7&c[3])<<8|c[2],t=15&c[0];n[0]=t>0?o(e):null}if(2&c[21]){const e=(7&c[7])<<8|c[6],t=15&c[4];n[1]=t>0?o(e):null}if(4&c[21]){const e=(7&c[11])<<8|c[10],t=127&c[8];n[2]=t>0?o(e,!0):null}if(8&c[21]){const e=15&c[12];n[3]=e>0?37:null}m.push({notes:n})}return m}(u,m,y,d,g,4);w=function(n,e,r){const o=Math.max(1,Math.ceil(n.length/256)),s=Math.min(256,Math.ceil(n.length/o)),l=Array.from({length:r},(n,r)=>({id:`ch${r}`,name:e[r]?.name||`CH ${r+1}`,muted:!1,solo:!1,collapsed:!1,volume:100,pan:0,instrumentId:null,color:null,rows:Array.from({length:s},t)})),a=new Array(r).fill(0);for(let t=0;t<s;t++){const e=n[Math.min(t*o,n.length-1)];for(let n=0;n<r&&n<e.notes.length;n++){const r=e.notes[n],o=l[n].rows[t];null!==r&&r!==a[n]?(o.note=r,o.instrument=n+1,a[n]=r):null===r&&a[n]>0&&(o.note=97,a[n]=0)}}return{id:"p0",name:"Pattern 1",length:s,channels:l}}(n,v,4)}catch{w={id:"p0",name:"Pattern 1",length:16,channels:Array.from({length:4},(n,e)=>({id:`ch${e}`,name:v[e]?.name||`CH ${e+1}`,muted:!1,solo:!1,collapsed:!1,volume:100,pan:0,instrumentId:null,color:null,rows:Array.from({length:16},t)}))}}else w={id:"p0",name:"Pattern 1",length:16,channels:Array.from({length:4},(n,e)=>({id:`ch${e}`,name:v[e]?.name||`CH ${e+1}`,muted:!1,solo:!1,collapsed:!1,volume:100,pan:0,instrumentId:null,color:null,rows:Array.from({length:16},t)}))};return{name:(f||i.replace(/\.nsfe?$/i,""))+(c?` â€” ${c}`:""),format:"NSF",patterns:[w],instruments:v,songPositions:[0],songLength:p,restartPosition:0,numChannels:4,initialSpeed:1,initialBPM:g?50:60}}export{l as isNSFEFormat,s as isNSFFormat,a as parseNSFFile};
