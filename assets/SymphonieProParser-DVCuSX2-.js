class e{pos;data;view;constructor(e,t=0){this.data=e,this.view=new DataView(e.buffer,e.byteOffset,e.byteLength),this.pos=t}get length(){return this.data.length}get remaining(){return this.data.length-this.pos}canRead(e){return this.pos+e<=this.data.length}u8(){if(this.pos>=this.data.length)throw new Error("EOF");return this.data[this.pos++]}s8(){const e=this.u8();return e>=128?e-256:e}u16be(){if(!this.canRead(2))throw new Error("EOF");const e=this.view.getUint16(this.pos,!1);return this.pos+=2,e}s16be(){if(!this.canRead(2))throw new Error("EOF");const e=this.view.getInt16(this.pos,!1);return this.pos+=2,e}u32be(){if(!this.canRead(4))throw new Error("EOF");const e=this.view.getUint32(this.pos,!1);return this.pos+=4,e}s32be(){if(!this.canRead(4))throw new Error("EOF");const e=this.view.getInt32(this.pos,!1);return this.pos+=4,e}bytes(e){if(!this.canRead(e))throw new Error("EOF");const t=this.data.slice(this.pos,this.pos+e);return this.pos+=e,t}skip(e){this.pos=Math.min(this.pos+e,this.data.length)}readMagic(e){if(!this.canRead(e.length))return!1;for(let t=0;t<e.length;t++)if(this.data[this.pos+t]!==e.charCodeAt(t))return!1;return this.pos+=e.length,!0}peekMagic(e){if(!this.canRead(e.length))return!1;for(let t=0;t<e.length;t++)if(this.data[this.pos+t]!==e.charCodeAt(t))return!1;return!0}}function t(e){if(!e.canRead(4))return new Uint8Array(0);const t=e.u32be();if(0===t||!e.canRead(t))return e.skip(e.remaining),new Uint8Array(0);const n=e.pos,a=n+t;if(t>=10&&e.peekMagic("PACK")){if(e.skip(4),255!==e.u8()||255!==e.u8()){e.pos=n;return e.bytes(t)}const s=e.u32be(),r=Math.min(s,170*t),o=new Uint8Array(r);let i=0,c=r,l=!1;for(;!l&&e.pos<a&&c>0;){switch(e.s8()){case 0:{if(!e.canRead(1)){l=!0;break}const t=e.u8();if(c<t||!e.canRead(t)){l=!0;break}for(let n=0;n<t;n++)o[i++]=e.u8();c-=t;break}case 1:{if(!e.canRead(1)){l=!0;break}const t=e.u8();if(c<4*t||!e.canRead(4)){l=!0;break}const n=e.u8(),a=e.u8(),s=e.u8(),r=e.u8();for(let e=0;e<t&&c>=4;e++)o[i++]=n,o[i++]=a,o[i++]=s,o[i++]=r,c-=4;break}case 2:{if(c<8||!e.canRead(4)){l=!0;break}const t=e.u8(),n=e.u8(),a=e.u8(),s=e.u8();o[i++]=t,o[i++]=n,o[i++]=a,o[i++]=s,o[i++]=t,o[i++]=n,o[i++]=a,o[i++]=s,c-=8;break}case 3:{if(!e.canRead(1)){l=!0;break}const t=e.u8();if(c<t){l=!0;break}i+=t,c-=t;break}default:l=!0}}return e.pos=a,c>0?new Uint8Array(0):o}return e.bytes(t)}function n(e){return t(e)}function a(e,t,n){let a="";for(let s=0;s<n;s++){const n=e[t+s];if(0===n)break;a+=n>=32&&n<128||n>=160?String.fromCharCode(n):" "}return a.trimEnd()}function s(e){const t=Math.floor(e.length/4),n=[];for(let a=0;a<t;a++){const t=4*a,s=e[t],r=e[t+1]>=128?e[t+1]-256:e[t+1];n.push({command:s,note:r,param:e[t+2],inst:e[t+3]})}return n}function r(e){const t=Math.floor(e.length/16),n=[],a=new DataView(e.buffer,e.byteOffset,e.byteLength);for(let s=0;s<t;s++){const e=16*s;n.push({start:a.getUint16(e,!1),length:a.getUint16(e+2,!1),loop:a.getUint16(e+4,!1),info:a.getInt16(e+6,!1),transpose:a.getInt16(e+8,!1)})}return n}function o(e){const t=Math.floor(e.length/32),n=[],a=new DataView(e.buffer,e.byteOffset,e.byteLength);for(let s=0;s<t;s++){const e=32*s;n.push({loopNum:a.getUint16(e+4,!1),pattern:a.getUint16(e+8,!1),start:a.getUint16(e+10,!1),length:a.getUint16(e+12,!1),speed:a.getUint16(e+14,!1),transpose:a.getInt16(e+16,!1)})}return n}function i(e){const t=Math.floor(e.length/256),n=[];for(let s=0;s<t;s++){const t=256*s,r=e.slice(t,t+128),o=e[t+128]>=128?e[t+128]-256:e[t+128],i=e[t+134],c=e[t+132],l=e[t+142],f=e[t+139]>=128?e[t+139]-256:e[t+139],h=86===r[0]&&105===r[1]&&82===r[2]&&84===r[3]?"Virtual":a(r,0,128);n.push({nameOrHeader:r,type:o,volume:i,channel:c,instFlags:l,transpose:f,name:h})}return n}function c(e){if(e.length<16)return!1;if(83!==e[0]||121!==e[1]||109!==e[2]||77!==e[3])return!1;const t=new DataView(e.buffer,e.byteOffset,e.byteLength);if(1!==t.getUint32(4,!1))return!1;if(-1!==t.getInt32(8,!1))return!1;const n=t.getUint32(12,!1);return!(n<1||n>256)}async function l(l,h){try{const p=function(l,h){if(!c(l))return null;const u=new e(l);u.skip(4),u.skip(4),u.skip(4);const p=Math.min(u.u32be(),256),m=-1,g=-2,b=-3,d=-4,y=-5,k=-6,w=-7,M=-10,U=-11,A=-12,R=-13,v=-14,$=-15,E=-16,F=-17,T=-18,S=-19,C=-20,O=-21,I=10,L=11,D=12;let P=0,V=125,x=6,N=new Uint8Array(0),q=new Uint8Array(0),B=new Uint8Array(0),z=new Uint8Array(0),H="";for(;u.canRead(4);){switch(u.s32be()){case m:u.skip(4);break;case g:{const e=u.u32be();if(e>1024)return null;P=e;break}case y:if(4!==(65535&u.u32be()))return null;break;case k:{const e=u.u32be(),t=Math.min(e,800);V=Math.floor(1.24*t),V<32&&(V=32),V>999&&(V=999);break}case b:case d:case I:case L:case D:case w:u.skip(4);break;case M:if(0===N.length)N=new Uint8Array(n(u));else if(u.canRead(4)){const e=u.u32be();u.skip(e)}break;case U:case F:case T:if(u.canRead(4)){const e=u.u32be();u.skip(e)}break;case A:break;case R:if(0===B.length)B=new Uint8Array(n(u));else if(u.canRead(4)){const e=u.u32be();u.skip(e)}break;case v:if(0===z.length)z=new Uint8Array(n(u));else if(u.canRead(4)){const e=u.u32be();u.skip(e)}break;case $:if(0===q.length)q=new Uint8Array(n(u));else if(u.canRead(4)){const e=u.u32be();u.skip(e)}break;case E:{const e=t(u);if(e.length>0){let t=0;for(;t<e.length&&10!==e[t]&&13!==e[t]&&0!==e[t];)t++;H=a(e,0,t)}break}case S:case C:case O:if(u.canRead(4)){const e=u.u32be();u.skip(e)}}}if(0===P||0===z.length)return null;if(0===N.length||0===B.length||0===q.length)return null;const K=i(z),j=s(B),G=r(q),J=o(N),Q=Math.min(K.length,255),W=p*P,X=W>0?Math.floor(j.length/W):0,Y=H||h.replace(/\.symmod$/i,""),Z=K.length>0?K.map((e,t)=>({id:t+1,name:e.name||Y,type:"sample",synthType:"Sampler",effects:[],volume:e.volume??0,pan:0})):[{id:1,name:Y,type:"sample",synthType:"Sampler",effects:[],volume:0,pan:0}],_=new Map,ee=[],te=[];let ne=!1;for(const e of G)if(1!==e.info){if(-1===e.info)break;if(!(e.start>=J.length||0===e.length||e.length>J.length||J.length-e.length<e.start))for(let t=e.start;t<e.start+e.length;t++){const n=J[t];if(!n)continue;const a=n.transpose+e.transpose,s=`${n.pattern}-${n.start}-${n.length}-${a}-${n.speed}`;if(!_.has(s)){const e=ee.length;_.set(s,e);const t=n.length,r=n.start,o=n.speed>0?n.speed:6;ne||(x=o,ne=!0);const i=[];for(let s=0;s<p;s++){const e=[];for(let i=0;i<t;i++){const t={note:0,instrument:0,volume:0,effTyp:0,eff:0,effTyp2:0,eff2:0},c=r+i,l=n.pattern*W+c*p+s;if(l>=0&&l<j.length){f(j[l],t,a,Q)}0===i&&0===s&&(t.effTyp=15,t.eff=o),e.push(t)}const c=1&s?50:-50;i.push({id:`channel-${s}`,name:`Channel ${s+1}`,muted:!1,solo:!1,collapsed:!1,volume:100,pan:c,instrumentId:null,color:null,rows:e})}ee.push({id:`pattern-${e}`,name:`Pattern ${e}`,length:t,channels:i,importMetadata:{sourceFormat:"Symphonie",sourceFile:h,importedAt:(new Date).toISOString(),originalChannelCount:p,originalPatternCount:X,originalInstrumentCount:Q}})}const r=_.get(s),o=Math.max(n.loopNum,1);for(let e=0;e<o;e++)te.push(r)}}if(0===ee.length){const e=Array.from({length:64},()=>({note:0,instrument:0,volume:0,effTyp:0,eff:0,effTyp2:0,eff2:0})),t=Array.from({length:p},(t,n)=>({id:`channel-${n}`,name:`Channel ${n+1}`,muted:!1,solo:!1,collapsed:!1,volume:100,pan:1&n?50:-50,instrumentId:null,color:null,rows:e}));ee.push({id:"pattern-0",name:"Pattern 0",length:64,channels:t,importMetadata:{sourceFormat:"Symphonie",sourceFile:h,importedAt:(new Date).toISOString(),originalChannelCount:p,originalPatternCount:0,originalInstrumentCount:Q}}),te.push(0)}const ae=h.replace(/\.[^/.]+$/,"");return{name:H.trim()||ae,format:"MOD",patterns:ee,instruments:Z,songPositions:te,songLength:te.length,restartPosition:0,numChannels:p,initialSpeed:x,initialBPM:V,linearPeriods:!1}}(l,h);if(!p)return null;try{const e=await g(l.buffer,h);p.instruments.length>0&&(p.instruments[0].synthType="SymphonieSynth",p.instruments[0].symphonie=e)}catch(u){}return p}catch{return null}}function f(e,t,n,a){switch(e.command){case 0:if(e.param>200)switch(e.param){case 254:case 251:case 250:case 249:break;case 248:if(e.note>=0&&e.note<=84){const a=h(e.note+25+n);a>0&&(t.note=a)}}else{if(e.note>=0&&e.note<=84){const a=h(e.note+25+n);a>0&&(t.note=a)}if(e.inst>0&&e.inst<a&&(t.instrument=e.inst+1),e.param>0&&e.param<=100){const n=Math.round(.64*e.param);t.volume=Math.min(n,64)}}break;case 9:t.effTyp=15,t.eff=e.param>0?e.param:4;break;case 1:t.effTyp=10,t.eff=Math.min(e.param,15)<<4;break;case 2:t.effTyp=10,t.eff=Math.min(e.param,15);break;case 3:t.effTyp=1,t.eff=Math.min(e.param,255);break;case 4:t.effTyp=2,t.eff=Math.min(e.param,255);break;case 13:t.effTyp=4,t.eff=Math.min(e.inst>>3,15)<<4|Math.min(e.param,15);break;case 12:t.effTyp=7,t.eff=Math.min(e.inst>>3,15)<<4|Math.min(e.param>>3,15);break;case 16:t.effTyp=27,t.eff=Math.min(e.inst+1,15);break;case 18:if(e.note>=0&&e.note<=84){const a=h(e.note+25+n);a>0&&(t.note=a,t.effTyp=3,t.eff=0)}break;case 5:case 6:t.effTyp=9,t.eff=Math.min(e.param,255)}}function h(e){return e<1?0:e>119?119:e}function u(e){const t=new Float32Array(e.length);let n=0;for(let a=0;a<e.length;a++)n=n+e[a]&255,t[a]=(n<128?n:n-256)/128;return t}function p(e){const t=4096,n=2048,a=Math.floor(e.length/t),s=new Float32Array(a*n),r=new Uint8Array(n);for(let o=0;o<a;o++){const a=o*t;let i=0;for(let t=0;t<n;t++)i=i+e[a+t]&255,r[t]=i;for(let t=0;t<n;t++){i=i+e[a+n+t]&255;const c=i<<8|r[t];s[o*n+t]=(c>32767?c-65536:c)/32768}}return s}function m(e){const t=new Float32Array(e.length);for(let n=0;n<e.length;n++){const a=e[n];t[n]=(a<128?a:a-256)/128}return t}async function g(l,f){const g=new Uint8Array(l);if(!c(g))throw new Error(`parseSymphonieForPlayback: not a SymMOD file (${f})`);const b=new e(g);b.skip(4),b.skip(4),b.skip(4);const d=Math.min(b.u32be(),256);let y=0,k=125,w=new Uint8Array(0),M=new Uint8Array(0),U=new Uint8Array(0),A=new Uint8Array(0),R="";const v=[];let $=0;for(;b.canRead(4);){switch(b.s32be()){case-1:b.skip(4);break;case-2:{const e=b.u32be();if(e>1024)throw new Error("trackLen > 1024");y=e;break}case-5:{const e=65535&b.u32be();if(4!==e)throw new Error(`eventSize must be 4, got ${e}`);break}case-6:{const e=b.u32be(),t=Math.min(e,800);k=Math.floor(1.24*t),k<32&&(k=32),k>999&&(k=999);break}case-3:case-4:case 10:case 11:case 12:case-7:b.skip(4);break;case-10:if(0===w.length)w=new Uint8Array(n(b));else if(b.canRead(4)){const e=b.u32be();b.skip(e)}break;case-11:{const e=t(b);v[$]={kind:"raw8",bytes:e},$++;break}case-17:{const e=t(b);v[$]={kind:"delta8",bytes:e},$++;break}case-18:{const e=t(b);v[$]={kind:"delta16",bytes:e},$++;break}case-12:$++;break;case-13:if(0===U.length)U=new Uint8Array(n(b));else if(b.canRead(4)){const e=b.u32be();b.skip(e)}break;case-14:if(0===A.length)A=new Uint8Array(n(b));else if(b.canRead(4)){const e=b.u32be();b.skip(e)}break;case-15:if(0===M.length)M=new Uint8Array(n(b));else if(b.canRead(4)){const e=b.u32be();b.skip(e)}break;case-16:{const e=t(b);if(e.length>0){let t=0;for(;t<e.length&&10!==e[t]&&13!==e[t]&&0!==e[t];)t++;R=a(e,0,t)}break}case-19:case-20:case-21:if(b.canRead(4)){const e=b.u32be();b.skip(e)}}}if(0===y||0===A.length)throw new Error("parseSymphonieForPlayback: missing trackLen or instrument data");if(0===w.length||0===U.length||0===M.length)throw new Error("parseSymphonieForPlayback: missing position/pattern/sequence data");const E=i(A),F=s(U),T=r(M),S=o(w),C=Math.min(E.length,255),O=d*y;let I=0;const L=[];for(let e=0;e<C;e++){const t=E[e],n=256*e,a=A[n+129],s=A[n+130],r=A[n+131],o=A[n+138]>=128?A[n+138]-256:A[n+138],i=A[n+140],c=A[n+143],l=t.transpose-12*c,f=0===t.volume?100:Math.min(t.volume,100),h=!!(2&t.instFlags),g=!!(16&i),b=65536*a,d=65536*s;let y=null;if(-8!==t.type&&-4!==t.type&&0!==t.type){const e=v[I];e&&(y="raw8"===e.kind?m(e.bytes):"delta8"===e.kind?u(e.bytes):p(e.bytes)),I++}L.push({name:t.name||`Instrument ${e+1}`,type:t.type,volume:f,tune:l,fineTune:o,noDsp:h,multiChannel:t.channel,loopStart:b,loopLen:d,numLoops:r,newLoopSystem:g,samples:y,sampledFrequency:0})}let D=6;e:for(const e of T)if(1!==e.info){if(-1===e.info)break;if(!(e.start>=S.length||0===e.length||e.length>S.length||S.length-e.length<e.start))for(let t=e.start;t<e.start+e.length;t++){const e=S[t];if(e&&e.speed>0){D=e.speed;break e}}}const P=new Map,V=[],x=[];for(const e of T)if(1!==e.info){if(-1===e.info)break;if(!(e.start>=S.length||0===e.length||e.length>S.length||S.length-e.length<e.start))for(let t=e.start;t<e.start+e.length;t++){const n=S[t];if(!n)continue;const a=n.transpose+e.transpose,s=`${n.pattern}-${n.start}-${n.length}-${a}-${n.speed}`;if(!P.has(s)){const e=V.length;P.set(s,e);const t=n.length,r=n.start,o=[],i=[];for(let s=0;s<t;s++)for(let e=0;e<d;e++){const t=r+s,c=n.pattern*O+t*d+e;if(c<0||c>=F.length)continue;const l=F[c];if(24===l.command||25===l.command)i.push({row:s,channel:e,type:l.note,feedback:l.inst,bufLen:l.param});else{let t=0,n=0,r=255;0===l.command?(l.note>=0&&l.note<=84&&(t=h(l.note+25+a)),l.inst>0&&l.inst<=C&&(n=l.inst),l.param<=100&&l.param>0?r=l.param:0===l.param&&(r=255)):18===l.command?l.note>=0&&l.note<=84&&(t=h(l.note+25+a)):l.note>=0&&l.note,o.push({row:s,channel:e,note:t,instrument:n,volume:r,cmd:l.command,param:l.param})}}V.push({numRows:t,events:o,dspEvents:i})}const r=P.get(s),o=Math.max(n.loopNum,1);for(let e=0;e<o;e++)x.push(r)}}0===V.length&&(V.push({numRows:64,events:[],dspEvents:[]}),x.push(0));const N=f.replace(/\.[^/.]+$/,"");return{title:R.trim()||N,bpm:k,cycle:D,numChannels:d,orderList:x,patterns:V,instruments:L,globalDspType:0,globalDspFeedback:0,globalDspBufLen:0}}export{c as isSymphonieProFormat,g as parseSymphonieForPlayback,l as parseSymphonieProFile};
