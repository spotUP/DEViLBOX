import{aB as e}from"./index-zx6LJBPK.js";import"./vendor-react-DkDaD07v.js";import"./vendor-utils-XMmR-oGw.js";import"./vendor-tone-CADp_hfL.js";import"./vendor-ui-uomqNFY-.js";const t=1566,n=64,o=1024,r=[-50,50,50,-50],a=[[1712,1616,1524,1440,1356,1280,1208,1140,1076,1016,960,906,856,808,762,720,678,640,604,570,538,508,480,453,428,404,381,360,339,320,302,285,269,254,240,226,214,202,190,180,170,160,151,143,135,127,120,113],[1700,1604,1514,1430,1348,1274,1202,1134,1070,1010,954,900,850,802,757,715,674,637,601,567,535,505,477,450,425,401,379,357,337,318,300,284,268,253,239,225,213,201,189,179,169,159,150,142,134,126,119,113],[1688,1592,1504,1418,1340,1264,1194,1126,1064,1004,948,894,844,796,752,709,670,632,597,563,532,502,474,447,422,398,376,355,335,316,298,282,266,251,237,224,211,199,188,177,167,158,149,141,133,125,118,112],[1676,1582,1492,1408,1330,1256,1184,1118,1056,996,940,888,838,791,746,704,665,628,592,559,528,498,470,444,419,395,373,352,332,314,296,280,264,249,235,222,209,198,187,176,166,157,148,140,132,125,118,111],[1664,1570,1482,1398,1320,1246,1176,1110,1048,990,934,882,832,785,741,699,660,623,588,555,524,495,467,441,416,392,370,350,330,312,294,278,262,247,233,220,208,196,185,175,165,156,147,139,131,124,117,110],[1652,1558,1472,1388,1310,1238,1168,1102,1040,982,926,874,826,779,736,694,655,619,584,551,520,491,463,437,413,390,368,347,328,309,292,276,260,245,232,219,206,195,184,174,164,155,146,138,130,123,116,109],[1640,1548,1460,1378,1302,1228,1160,1094,1032,974,920,868,820,774,730,689,651,614,580,547,516,487,460,434,410,387,365,345,325,307,290,274,258,244,230,217,205,193,183,172,163,154,145,137,129,122,115,109],[1628,1536,1450,1368,1292,1220,1150,1086,1026,968,914,862,814,768,725,684,646,610,575,543,513,484,457,431,407,384,363,342,323,305,288,272,256,242,228,216,204,192,181,171,161,152,144,136,128,121,114,108],[1814,1712,1616,1524,1440,1356,1280,1208,1140,1076,1016,960,907,856,808,762,720,678,640,604,570,538,508,480,453,428,404,381,360,339,320,302,285,269,254,240,226,214,202,190,180,170,160,151,143,135,127,120],[1800,1700,1604,1514,1430,1350,1272,1202,1134,1070,1010,954,900,850,802,757,715,675,636,601,567,535,505,477,450,425,401,379,357,337,318,300,284,268,253,238,225,212,200,189,179,169,159,150,142,134,126,119],[1788,1688,1592,1504,1418,1340,1264,1194,1126,1064,1004,948,894,844,796,752,709,670,632,597,563,532,502,474,447,422,398,376,355,335,316,298,282,266,251,237,223,211,199,188,177,167,158,149,141,133,125,118],[1774,1676,1582,1492,1408,1330,1256,1184,1118,1056,996,940,887,838,791,746,704,665,628,592,559,528,498,470,444,419,395,373,352,332,314,296,280,264,249,235,222,209,198,187,176,166,157,148,140,132,125,118],[1762,1664,1570,1482,1398,1320,1246,1176,1110,1048,988,934,881,832,785,741,699,660,623,588,555,524,494,467,441,416,392,370,350,330,312,294,278,262,247,233,220,208,196,185,175,165,156,147,139,131,123,117],[1750,1652,1558,1472,1388,1310,1238,1168,1102,1040,982,926,875,826,779,736,694,655,619,584,551,520,491,463,437,413,390,368,347,328,309,292,276,260,245,232,219,206,195,184,174,164,155,146,138,130,123,116],[1736,1640,1548,1460,1378,1302,1228,1160,1094,1032,974,920,868,820,774,730,689,651,614,580,547,516,487,460,434,410,387,365,345,325,307,290,274,258,244,230,217,205,193,183,172,163,154,145,137,129,122,115],[1724,1628,1536,1450,1368,1292,1220,1150,1086,1026,968,914,862,814,768,725,684,646,610,575,543,513,484,457,431,407,384,363,342,323,305,288,272,256,242,228,216,203,192,181,171,161,152,144,136,128,121,114]],f=a[0];function s(e,t){return e[t]??0}function l(e,t){return(e[t]??0)<<8|(e[t+1]??0)}function i(e,t){return((e[t]??0)<<24|(e[t+1]??0)<<16|(e[t+2]??0)<<8|(e[t+3]??0))>>>0}function u(e,t,n){let o="";for(let r=0;r<n;r++){const n=e[t+r];if(void 0===n||0===n)break;o+=String.fromCharCode(n)}return o}function c(e){if(0===e||2047===e)return 0;let t=0,n=1/0;for(let r=0;r<f.length;r++){const o=f[r];if(void 0===o)continue;const a=Math.abs(o-e);a<n&&(n=a,t=r)}const o=t+13;return Math.max(1,Math.min(96,o))}function m(e){return e<=0?8287:Math.round(3546895/(2*e))}function p(){return{note:0,instrument:0,volume:0,effTyp:0,eff:0,effTyp2:0,eff2:0}}function h(e){if(e.length<1566)return!1;if(1296913714!==i(e,0))return!1;const n=l(e,1436);if(0===n||n>128)return!1;let r=0;for(let t=0;t<n;t++){const n=s(e,1438+t);n>r&&(r=n)}return!(t+(r+1)*o>=e.length)}function g(f,g){try{if(!h(f))return null;const d=s(f,8),y=s(f,9),S=0===d?125:d,v=0===y?6:y,A=[];for(let e=0;e<31;e++){const t=10+46*e,n=u(f,t+0,30),o=4294967294&i(f,t+30),r=l(f,t+34),a=i(f,t+36),c=l(f,t+40),m=s(f,t+42),p=s(f,t+43),h=l(f,t+44);A.push({name:n,startOffset:o,length:r,loopStart:a,loopLength:c,finetune:m,volume:p,frequency:h})}const C=l(f,1436),$=[];for(let e=0;e<C;e++)$.push(s(f,1438+e));const b=Math.max(...$)+1,k=[];for(let e=0;e<b;e++){const r=[],a=t+e*o;for(let e=0;e<n;e++){const t=[];for(let n=0;n<4;n++){const o=a+16*e+4*n,r=s(f,o),l=s(f,o+1),i=s(f,o+2),u=s(f,o+3);t.push({sample:r>>3,period:(7&r)<<8|l,effect:i,effectArg:u})}r.push(t)}k.push(r)}const M=t+b*o,P=[];for(let t=0;t<31;t++){const n=A[t],o=t+1,r=n.loopLength>1,s=2*(n.length+(r?n.loopLength:0));if(0===n.length||0===s){P.push({id:o,name:n.name.trim()||`Sample ${o}`,type:"synth",synthType:"Synth",effects:[],volume:0,pan:0});continue}const l=M+n.startOffset,i=l+s;if(i>f.length){P.push({id:o,name:n.name.trim()||`Sample ${o}`,type:"synth",synthType:"Synth",effects:[],volume:0,pan:0});continue}const u=f.slice(l,i),c=r?n.loopStart:0,p=r?c+2*n.loopLength:0,h=15&n.finetune,g=a[h],d=g&&void 0!==g[24]?g[24]:214,y=n.frequency>0?n.frequency:m(d);P.push(e(o,n.name.trim()||`Sample ${o}`,u,n.volume,y,c,p))}const T=[];for(let e=0;e<b;e++){const t=k[e];if(!t)continue;const o=Array.from({length:4},()=>[]);for(let e=0;e<n;e++){const n=t[e];for(let e=0;e<4;e++){const t=n?.[e];if(!t){o[e].push(p());continue}const r=c(t.period),a=t.sample;let f=0,s=0;switch(t.effect){case 0:f=0,s=t.effectArg;break;case 1:f=1,s=t.effectArg;break;case 2:f=2,s=t.effectArg;break;case 3:f=12,s=t.effectArg;break;case 5:case 11:f=15,s=t.effectArg;break;case 6:f=11,s=t.effectArg;break;case 27:f=3,s=t.effectArg;break;default:f=0,s=0}o[e].push({note:r,instrument:a,volume:0,effTyp:f,eff:s,effTyp2:0,eff2:0})}}T.push({id:`pattern-${e}`,name:`Pattern ${e}`,length:n,channels:o.map((e,t)=>({id:`channel-${t}`,name:`Channel ${t+1}`,muted:!1,solo:!1,collapsed:!1,volume:100,pan:r[t]??0,instrumentId:null,color:null,rows:e})),importMetadata:{sourceFormat:"DSS",sourceFile:g,importedAt:(new Date).toISOString(),originalChannelCount:4,originalPatternCount:b,originalInstrumentCount:31}})}0===T.length&&T.push({id:"pattern-0",name:"Pattern 0",length:n,channels:Array.from({length:4},(e,t)=>({id:`channel-${t}`,name:`Channel ${t+1}`,muted:!1,solo:!1,collapsed:!1,volume:100,pan:r[t]??0,instrumentId:null,color:null,rows:Array.from({length:n},()=>({note:0,instrument:0,volume:0,effTyp:0,eff:0,effTyp2:0,eff2:0}))})),importMetadata:{sourceFormat:"DSS",sourceFile:g,importedAt:(new Date).toISOString(),originalChannelCount:4,originalPatternCount:0,originalInstrumentCount:31}});return{name:g.replace(/\.[^/.]+$/,""),format:"DSS",patterns:T,instruments:P,songPositions:$.map(e=>e),songLength:$.length,restartPosition:0,numChannels:4,initialSpeed:v,initialBPM:S,linearPeriods:!1}}catch{return null}}export{h as isDigitalSoundStudioFormat,g as parseDigitalSoundStudioFile};
