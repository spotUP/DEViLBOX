import{b7 as e,j as t,Q as r,u as i,d as s,n as l}from"./index-BScIrLQs.js";import{r as o,R as a}from"./vendor-utils-Cm-70yv0.js";import{aA as n,aB as c,a5 as d,v as h,k as u,ay as p,at as f,az as g,q as x,d as w,C as b}from"./vendor-ui-CfbwX2Zi.js";import"./vendor-react-LeNVipsj.js";import"./vendor-tone-MhHxAwwC.js";const m=[{label:"Row",value:1},{label:"Beat",value:6},{label:"1/2 Bar",value:12},{label:"Bar",value:24},{label:"2 Bars",value:48},{label:"4 Bars",value:96},{label:"Off",value:0}],v=()=>{const{tool:i,setTool:s,view:l,setPixelsPerRow:o,setSnapDivision:a,setFollowPlayback:w,zoomToFit:b,addTrack:v}=e(),y=(e,r,l,o)=>t.jsx("button",{className:"p-1.5 rounded text-xs transition-colors "+(i===e?"bg-accent-primary text-white":"bg-dark-bgTertiary text-text-secondary hover:bg-dark-border hover:text-text-primary"),onClick:()=>s(e),title:`${l} (${o})`,children:r});return t.jsxs("div",{className:"flex items-center gap-2 px-3 py-1.5 bg-dark-bgSecondary border-b border-dark-border text-xs select-none",children:[t.jsxs("select",{value:"arrangement",onChange:e=>{"arrangement"!==e.target.value&&r.getState().setActiveView("tracker")},className:"px-2 py-0.5 text-[10px] font-bold tracking-widest uppercase bg-dark-bgTertiary text-text-muted border border-dark-border rounded hover:bg-dark-bgHover transition-colors cursor-pointer",title:"Switch view",children:[t.jsx("option",{value:"tracker",children:"Tracker"}),t.jsx("option",{value:"arrangement",children:"Arrangement"})]}),t.jsx("div",{className:"w-px h-5 bg-dark-border"}),t.jsxs("div",{className:"flex items-center gap-1",children:[y("select",t.jsx(p,{size:14}),"Select","V"),y("draw",t.jsx(f,{size:14}),"Draw","D"),y("erase",t.jsx(g,{size:14}),"Erase","E"),y("split",t.jsx(x,{size:14}),"Split","S")]}),t.jsx("div",{className:"w-px h-5 bg-dark-border"}),t.jsxs("div",{className:"flex items-center gap-1",children:[t.jsx("button",{className:"p-1 rounded bg-dark-bgTertiary text-text-secondary hover:bg-dark-border hover:text-text-primary",onClick:()=>o(Math.max(.5,l.pixelsPerRow/1.5)),title:"Zoom Out (Ctrl+-)",children:t.jsx(n,{size:14})}),t.jsx("span",{className:"text-text-muted w-10 text-center",children:l.pixelsPerRow.toFixed(1)}),t.jsx("button",{className:"p-1 rounded bg-dark-bgTertiary text-text-secondary hover:bg-dark-border hover:text-text-primary",onClick:()=>o(Math.min(32,1.5*l.pixelsPerRow)),title:"Zoom In (Ctrl++)",children:t.jsx(c,{size:14})}),t.jsx("button",{className:"p-1 rounded bg-dark-bgTertiary text-text-secondary hover:bg-dark-border hover:text-text-primary",onClick:b,title:"Zoom to Fit (Ctrl+0)",children:t.jsx(d,{size:14})})]}),t.jsx("div",{className:"w-px h-5 bg-dark-border"}),t.jsxs("div",{className:"flex items-center gap-1",children:[t.jsx("span",{className:"text-text-muted",children:"Snap:"}),t.jsx("select",{className:"bg-dark-bgTertiary border border-dark-border rounded px-1.5 py-0.5 text-text-primary text-xs",value:l.snapDivision,onChange:e=>a(Number(e.target.value)),children:m.map(e=>t.jsx("option",{value:e.value,children:e.label},e.value))})]}),t.jsx("div",{className:"w-px h-5 bg-dark-border"}),t.jsxs("button",{className:"p-1 rounded text-xs flex items-center gap-1 "+(l.followPlayback?"bg-accent-primary/20 text-accent-primary":"bg-dark-bgTertiary text-text-secondary hover:bg-dark-border"),onClick:()=>w(!l.followPlayback),title:"Follow Playback (F)",children:[t.jsx(h,{size:14}),t.jsx("span",{children:"Follow"})]}),t.jsx("div",{className:"flex-1"}),t.jsxs("button",{className:"p-1.5 rounded bg-dark-bgTertiary text-text-secondary hover:bg-dark-border hover:text-text-primary flex items-center gap-1",onClick:()=>v(),title:"Add Track (Ctrl+T)",children:[t.jsx(u,{size:14}),t.jsx("span",{children:"Track"})]})]})},y=({track:r,height:i})=>{const{toggleTrackMute:s,toggleTrackSolo:l,updateTrack:a}=e(),[n,c]=o.useState(!1),[d,h]=o.useState(r.name);o.useEffect(()=>{requestAnimationFrame(()=>h(r.name))},[r.name]);const u=o.useCallback(()=>{c(!1),d.trim()&&d!==r.name&&a(r.id,{name:d.trim()})},[d,r.id,r.name,a]),p=o.useCallback(e=>{"Enter"===e.key&&u(),"Escape"===e.key&&(h(r.name),c(!1))},[u,r.name]);return t.jsxs("div",{className:"flex border-b border-dark-border bg-dark-bgSecondary select-none",style:{height:i,minHeight:30},children:[t.jsx("div",{className:"flex-shrink-0",style:{width:4,backgroundColor:r.color||"#666"}}),t.jsxs("div",{className:"flex-1 flex flex-col px-2 py-1.5 min-w-0",children:[t.jsxs("div",{className:"flex items-center gap-1.5 min-h-[20px]",children:[t.jsx("span",{className:"flex-shrink-0 w-4 h-4 rounded text-[8px] font-bold flex items-center justify-center",style:{backgroundColor:`${r.color||"#666"}33`,color:r.color||"#888"},children:r.index+1}),n?t.jsx("input",{className:"bg-dark-bgTertiary border border-dark-border rounded px-1 text-xs text-text-primary w-full",value:d,onChange:e=>h(e.target.value),onBlur:u,onKeyDown:p,autoFocus:!0}):t.jsx("span",{className:"text-xs text-text-primary truncate cursor-pointer hover:text-accent-primary font-medium",onDoubleClick:()=>c(!0),title:r.name,children:r.name})]}),i>=44&&t.jsxs("div",{className:"flex items-center gap-1 mt-1.5",children:[t.jsx("button",{className:"w-6 h-5 rounded text-[10px] font-bold leading-none transition-colors "+(r.muted?"bg-red-600 text-white":"bg-dark-bgTertiary text-text-muted hover:bg-dark-border hover:text-text-primary"),onClick:()=>s(r.id),title:"Mute",children:"M"}),t.jsx("button",{className:"w-6 h-5 rounded text-[10px] font-bold leading-none transition-colors "+(r.solo?"bg-yellow-600 text-white":"bg-dark-bgTertiary text-text-muted hover:bg-dark-border hover:text-text-primary"),onClick:()=>l(r.id),title:"Solo",children:"S"}),i>=56&&t.jsx("div",{className:"flex-1 ml-1.5",children:t.jsx("div",{className:"relative h-[4px] bg-dark-bgTertiary rounded-full overflow-hidden",children:t.jsx("div",{className:"absolute inset-y-0 left-0 rounded-full",style:{width:`${r.volume}%`,backgroundColor:`${r.color||"#3b82f6"}88`}})})})]})]})]})},k=({tracks:e,entries:r,scrollY:i})=>{const s=new Map(e.map(e=>[e.id,e])),l=[...r].filter(e=>e.visible).sort((e,t)=>e.trackIndex-t.trackIndex);return t.jsxs("div",{className:"flex-shrink-0 overflow-hidden bg-dark-bgSecondary border-r border-dark-border flex flex-col",style:{width:180},children:[t.jsx("div",{className:"flex items-center px-3 border-b border-dark-border flex-shrink-0",style:{height:36},children:t.jsx("span",{className:"text-[10px] font-bold text-text-muted tracking-widest uppercase",children:"Tracks"})}),t.jsx("div",{className:"flex-1 overflow-hidden",children:t.jsx("div",{style:{transform:`translateY(${-i}px)`,willChange:"transform"},children:l.map(e=>{const r=s.get(e.trackId);return r?t.jsx(y,{track:r,height:e.height},r.id):null})})})]})};class R{scrollRow=0;scrollY=0;pixelsPerRow=4;width=800;height=400;update(e){void 0!==e.scrollRow&&(this.scrollRow=e.scrollRow),void 0!==e.scrollY&&(this.scrollY=e.scrollY),void 0!==e.pixelsPerRow&&(this.pixelsPerRow=e.pixelsPerRow),void 0!==e.width&&(this.width=e.width),void 0!==e.height&&(this.height=e.height)}rowToPixelX(e){return(e-this.scrollRow)*this.pixelsPerRow}pixelXToRow(e){return e/this.pixelsPerRow+this.scrollRow}trackYToScreenY(e){return e-this.scrollY}screenYToTrackY(e){return e+this.scrollY}snapRow(e,t){return t<=0?Math.round(e):Math.round(e/t)*t}getVisibleRowRange(){const e=Math.floor(this.scrollRow),t=Math.ceil(this.scrollRow+this.width/this.pixelsPerRow)+1;return{startRow:Math.max(0,e),endRow:t}}get visibleRows(){return this.width/this.pixelsPerRow}}class S{entries=[];totalHeight=0;rebuild(e,t,r){const i=new Set(t.filter(e=>e.collapsed).map(e=>e.id)),s=[...e].sort((e,t)=>e.index-t.index);this.entries=[];let l=0;for(const o of s){const e=!o.groupId||!i.has(o.groupId),t=r.filter(e=>e.trackId===o.id&&e.visible),s=o.automationVisible?40*t.length:0,a=o.collapsed?24:o.height,n=a+s;this.entries.push({trackId:o.id,trackIndex:o.index,y:l,height:e?n:0,bodyHeight:e?a:0,automationY:l+a,automationHeight:e?s:0,visible:e}),e&&(l+=n+1)}this.totalHeight=l}getTotalHeight(){return this.totalHeight}getEntries(){return this.entries}getVisibleEntries(e,t){return this.entries.filter(r=>{if(!r.visible)return!1;return r.y+r.height>e&&r.y<e+t})}hitTestY(e){for(const t of this.entries){if(!t.visible)continue;if(e<t.y)continue;if(e>t.y+t.height)continue;const r=e-t.y;return r>=t.bodyHeight-4&&r<=t.bodyHeight?{trackIndex:t.trackIndex,trackId:t.trackId,zone:"resize-handle"}:r>t.bodyHeight?{trackIndex:t.trackIndex,trackId:t.trackId,zone:"automation"}:{trackIndex:t.trackIndex,trackId:t.trackId,zone:"body"}}return null}getEntryForTrack(e){return this.entries.find(t=>t.trackId===e)}}const C={background:"#0c0c0e",trackEven:"rgba(255,255,255,0.02)",trackOdd:"rgba(255,255,255,0.05)",trackSeparator:"rgba(255,255,255,0.12)",gridLine:"rgba(255,255,255,0.04)",beatLine:"rgba(255,255,255,0.15)",barLine:"rgba(255,255,255,0.30)",fourBarLine:"rgba(255,255,255,0.42)",beyondEnd:"rgba(100,100,100,0.08)"};class T{canvas=null;ctx=null;lastKey="";colors={...C};cacheKey(e,t,r,i,s,l){const o=t.map(e=>`${e.y}_${e.height}`).join(",");return`${e.scrollRow.toFixed(2)}_${e.scrollY.toFixed(1)}_${e.pixelsPerRow}_${e.width}_${e.height}_${r}_${i}_${s}_${l}_${o}`}render(e,t,r,i,s,l){const o=this.cacheKey(e,t,r,i,s,l);if(o===this.lastKey&&this.canvas)return this.canvas;const a=Math.ceil(e.width*l),n=Math.ceil(e.height*l);if(a<=0||n<=0)return null;this.canvas&&this.canvas.width===a&&this.canvas.height===n||(this.canvas=new OffscreenCanvas(a,n),this.ctx=this.canvas.getContext("2d"));const c=this.ctx;if(!c)return null;c.setTransform(l,0,0,l,0,0),c.fillStyle=this.colors.background,c.fillRect(0,0,e.width,e.height);for(let x=0;x<t.length;x++){const r=t[x];if(!r.visible)continue;const i=e.trackYToScreenY(r.y);i+r.height<0||i>e.height||(c.fillStyle=x%2==0?this.colors.trackEven:this.colors.trackOdd,c.fillRect(0,i,e.width,r.height),c.fillStyle=this.colors.trackSeparator,c.fillRect(0,i+r.height,e.width,1))}const d=r,h=r*i,u=4*h,p=e.getVisibleRowRange();let f=1;e.pixelsPerRow<1?f=h:e.pixelsPerRow<2&&(f=d);const g=Math.max(0,Math.floor(p.startRow/f)*f);if(s<p.endRow){const t=e.rowToPixelX(s);t<e.width&&(c.fillStyle=this.colors.beyondEnd,c.fillRect(t,0,e.width-t,e.height))}for(let x=g;x<=Math.min(p.endRow,s);x+=f){const t=e.rowToPixelX(x);if(t<-1||t>e.width+1)continue;const r=x%h===0,i=x%d===0;x%u===0?(c.fillStyle=this.colors.fourBarLine,c.fillRect(t,0,1,e.height)):r?(c.fillStyle=this.colors.barLine,c.fillRect(t,0,1,e.height)):i?(c.fillStyle=this.colors.beatLine,c.fillRect(t,0,1,e.height)):e.pixelsPerRow>=2&&(c.fillStyle=this.colors.gridLine,c.fillRect(t,0,1,e.height))}return this.lastKey=o,this.canvas}invalidate(){this.lastKey=""}}class I{previewCache=new Map;render(e,t,r,i,s,l,o,a){const n=new Map(i.map(e=>[e.id,e])),c=new Map(s.map(e=>[e.trackId,e])),d=new Map(l.map(e=>[e.id,e])),h=t.getVisibleRowRange();for(const u of r){const r=c.get(u.trackId);if(!r||!r.visible)continue;const i=n.get(u.trackId);if(!i)continue;const s=d.get(u.patternId),l=u.clipLengthRows??(s?s.length-u.offsetRows:64);if(u.startRow+l<h.startRow||u.startRow>h.endRow)continue;const a=o.has(u.id);this.drawClip(e,t,u,i,r,s,l,a,!1)}if(a)for(const u of a){const r=c.get(u.trackId);if(!r||!r.visible)continue;const i=n.get(u.trackId);if(!i)continue;const s=d.get(u.patternId),l=u.clipLengthRows??(s?s.length-u.offsetRows:64);this.drawClip(e,t,u,i,r,s,l,!1,!0)}}drawClip(e,t,r,i,s,l,o,a,n){const c=t.rowToPixelX(r.startRow)+1,d=t.trackYToScreenY(s.y)+1,h=o*t.pixelsPerRow-2,u=s.bodyHeight-2;if(h<2||u<4)return;const p=r.color??i.color??"#3b82f6",f=function(e){const t=e.replace("#",""),r=parseInt(3===t.length?t.split("").map(e=>e+e).join(""):t.slice(0,6),16);return{r:r>>16&255,g:r>>8&255,b:255&r}}(p);if(e.save(),n&&(e.globalAlpha=.4),e.beginPath(),this.roundRect(e,c,d,h,u,4),r.muted)e.fillStyle=`rgba(${f.r},${f.g},${f.b},0.18)`;else{const t=e.createLinearGradient(c,d,c,d+u);t.addColorStop(0,`rgba(${f.r},${f.g},${f.b},0.55)`),t.addColorStop(1,`rgba(${Math.floor(.6*f.r)},${Math.floor(.6*f.g)},${Math.floor(.6*f.b)},0.45)`),e.fillStyle=t}e.fill(),a?(e.strokeStyle="#ffffff",e.lineWidth=2,e.stroke()):(e.strokeStyle=`rgba(${f.r},${f.g},${f.b},0.7)`,e.lineWidth=1,e.stroke()),n&&(e.setLineDash([4,4]),e.strokeStyle="#ffffffaa",e.lineWidth=1,e.stroke(),e.setLineDash([])),e.beginPath(),this.roundRect(e,c,d,h,u,4),e.clip(),r.muted?(e.fillStyle=`rgba(${f.r},${f.g},${f.b},0.35)`,e.fillRect(c,d,h,4)):(e.fillStyle=p,e.fillRect(c,d,h,4));const g=e.createLinearGradient(c,d+4,c,d+4+6);g.addColorStop(0,"rgba(255,255,255,0.07)"),g.addColorStop(1,"rgba(255,255,255,0)"),e.fillStyle=g,e.fillRect(c,d+4,h,6);const x=e.createLinearGradient(c,d+u-8,c,d+u);if(x.addColorStop(0,"rgba(0,0,0,0)"),x.addColorStop(1,"rgba(0,0,0,0.15)"),e.fillStyle=x,e.fillRect(c,d+u-8,h,8),h>20&&u>20&&l&&this.drawNoteDensityPreview(e,t,r,l,c,d+16,h,u-16),h>30){const t=l?.name??r.patternId,i=h-8;e.fillStyle="rgba(0,0,0,0.5)",e.font="bold 10px Inter, system-ui, sans-serif",e.textBaseline="top",e.fillText(t,c+5,d+4+3,i),e.fillStyle=r.muted?"#ffffff55":"#ffffffee",e.fillText(t,c+4,d+4+2,i)}if(r.muted&&!n){e.fillStyle="rgba(0,0,0,0.3)",e.fillRect(c,d,h,u),e.strokeStyle="rgba(255,255,255,0.1)",e.lineWidth=1;for(let t=-u;t<h;t+=8)e.beginPath(),e.moveTo(c+t,d),e.lineTo(c+t+u,d+u),e.stroke()}if(a&&!n&&h>24){const t=e.createLinearGradient(c,d,c+6,d);t.addColorStop(0,"rgba(255,255,255,0.25)"),t.addColorStop(1,"rgba(255,255,255,0)"),e.fillStyle=t,e.fillRect(c,d,6,u);const r=e.createLinearGradient(c+h-6,d,c+h,d);r.addColorStop(0,"rgba(255,255,255,0)"),r.addColorStop(1,"rgba(255,255,255,0.25)"),e.fillStyle=r,e.fillRect(c+h-6,d,6,u)}e.restore()}drawNoteDensityPreview(e,t,r,i,s,l,o,a){const n=i.channels[r.sourceChannelIndex];if(!n)return;const c=Math.round(o),d=Math.round(a);if(c<10||d<10)return;const h=`${r.patternId}_${r.sourceChannelIndex}_${c}_${d}`;let u=this.previewCache.get(h);if(!u){if(this.previewCache.size>=64){const e=this.previewCache.keys().next().value;e&&this.previewCache.delete(e)}const e=new OffscreenCanvas(c,d),t=e.getContext("2d");if(!t)return;const s=n.rows,l=r.clipLengthRows??i.length-r.offsetRows,o=r.offsetRows;let a=127,p=0;for(let r=o;r<o+l&&r<s.length;r++){const e=s[r]?.note??0;if(e>0&&e<97){const t=e+11;t<a&&(a=t),t>p&&(p=t)}}if(a>p)return u={canvas:e,width:c,height:d},void this.previewCache.set(h,u);a=Math.max(0,a-2),p=Math.min(127,p+2);const f=p-a+1;t.fillStyle="rgba(255,255,255,0.35)";for(let r=o;r<o+l&&r<s.length;r++){const e=s[r]?.note??0;if(e<=0||e>=97)continue;const i=(r-o)/l*c,a=(p-(e+11))/f*d,n=Math.max(1,c/l),h=Math.max(1,d/f);t.fillRect(i,a,n,h)}u={canvas:e,width:c,height:d},this.previewCache.set(h,u)}e.drawImage(u.canvas,s,l,c,d)}roundRect(e,t,r,i,s,l){e.moveTo(t+l,r),e.lineTo(t+i-l,r),e.arcTo(t+i,r,t+i,r+l,l),e.lineTo(t+i,r+s-l),e.arcTo(t+i,r+s,t+i-l,r+s,l),e.lineTo(t+l,r+s),e.arcTo(t,r+s,t,r+s-l,l),e.lineTo(t,r+l),e.arcTo(t,r,t+l,r,l),e.closePath()}invalidateCache(e){if(e){const t=[...this.previewCache.keys()].filter(t=>t.startsWith(e));for(const e of t)this.previewCache.delete(e)}else this.previewCache.clear()}dispose(){this.previewCache.clear()}}const M=36,P={background:"#111114",text:"#aaaabc",beatText:"#666677",tick:"rgba(255,255,255,0.1)",beatTick:"rgba(255,255,255,0.25)",barLine:"rgba(255,255,255,0.45)",markerFlag:"#f59e0b",markerText:"#ffffffcc",loopRegion:"rgba(34,197,94,0.15)"};class j{canvas=null;ctx=null;lastKey="";colors={...P};get height(){return M}cacheKey(e,t,r,i,s,l,o){const a=i.map(e=>`${e.row}_${e.type}_${e.name}_${e.color}`).join(",");return`${e.scrollRow.toFixed(2)}_${e.pixelsPerRow}_${e.width}_${t}_${r}_${a}_${s}_${l}_${o}`}render(e,t,r,i,s,l,o){const a=this.cacheKey(e,t,r,i,s,l,o);if(a===this.lastKey&&this.canvas)return this.canvas;const n=Math.ceil(e.width*o),c=Math.ceil(M*o);if(n<=0)return null;this.canvas&&this.canvas.width===n&&this.canvas.height===c||(this.canvas=new OffscreenCanvas(n,c),this.ctx=this.canvas.getContext("2d"));const d=this.ctx;if(!d)return null;d.setTransform(o,0,0,o,0,0),d.fillStyle=this.colors.background,d.fillRect(0,0,e.width,M),d.fillStyle="rgba(255,255,255,0.15)",d.fillRect(0,35,e.width,1);const h=t,u=t*r,p=e.getVisibleRowRange();if(null!==s&&null!==l&&l>s){const t=e.rowToPixelX(s),r=(l-s)*e.pixelsPerRow;d.fillStyle=this.colors.loopRegion,d.fillRect(t,0,r,M)}let f=1;e.pixelsPerRow<1?f=u:e.pixelsPerRow<3&&(f=h);const g=Math.floor(p.startRow/f)*f;for(let x=Math.max(0,g);x<=p.endRow;x+=f){const t=e.rowToPixelX(x);if(t<-50||t>e.width+50)continue;const r=x%h===0;if(x%u===0){const e=Math.floor(x/u)+1;d.fillStyle=this.colors.barLine,d.fillRect(t,14,1,22),d.font="bold 12px Inter, system-ui, sans-serif",d.textBaseline="middle",d.fillStyle=this.colors.text,d.fillText(`${e}`,t+4,10)}else if(r&&e.pixelsPerRow>=2){if(d.fillStyle=this.colors.beatTick,d.fillRect(t,22,1,14),e.pixelsPerRow>=4){const e=Math.floor(x/u)+1,r=Math.floor(x%u/h)+1;d.font="9px Inter, system-ui, sans-serif",d.textBaseline="middle",d.fillStyle=this.colors.beatText,d.fillText(`${e}.${r}`,t+3,18)}}else e.pixelsPerRow>=4&&(d.fillStyle=this.colors.tick,d.fillRect(t,28,1,8))}d.font="9px Inter, system-ui, sans-serif";for(const x of i){if(x.row<p.startRow||x.row>p.endRow)continue;const t=e.rowToPixelX(x.row),r=x.color||this.colors.markerFlag;d.fillStyle=r,d.beginPath(),d.moveTo(t,0),d.lineTo(t+8,4),d.lineTo(t,8),d.fill(),d.fillStyle=this.colors.markerText,d.fillText(x.name,t+10,5),d.fillStyle=`${r}66`,d.fillRect(t,0,1,M)}return this.lastKey=a,this.canvas}invalidate(){this.lastKey=""}}class _{clipRects=[];rebuild(e,t,r,i,s){const l=new Map(r.map(e=>[e.id,e]));this.clipRects=[];for(const o of e){const e=s.getEntryForTrack(o.trackId);if(!e||!e.visible)continue;const t=l.get(o.patternId),r=o.clipLengthRows??(t?t.length-o.offsetRows:64),a=i.rowToPixelX(o.startRow),n=i.trackYToScreenY(e.y),c=r*i.pixelsPerRow,d=e.bodyHeight;this.clipRects.push({clip:o,x:a,y:n,w:c,h:d})}}hitTest(e,t,r,i,s){if(t<s)return{type:"ruler",row:Math.max(0,Math.round(r.pixelXToRow(e)))};const l=t-s,o=Math.max(0,Math.round(r.pixelXToRow(e)));let a=null,n="body";for(const h of this.clipRects){const t=h.y;if(e<h.x||e>h.x+h.w)continue;if(l<t||l>t+h.h)continue;const r=e-h.x;let i="body";r<=6&&h.w>18?i="resize-start":r>=h.w-6&&h.w>18&&(i="resize-end"),a=h,n=i}if(a)return{type:"clip",clipId:a.clip.id,zone:n,trackId:a.clip.trackId,row:o};const c=r.screenYToTrackY(l),d=i.hitTestY(c);return d?"resize-handle"===d.zone?{type:"track-resize",trackId:d.trackId}:"automation"===d.zone?{type:"automation",trackId:d.trackId,row:o}:{type:"empty",trackId:d.trackId,trackIndex:d.trackIndex,row:o}:{type:"none"}}findClipsInRect(e,t,r,i){const s=Math.min(e,r),l=Math.max(e,r),o=Math.min(t,i),a=Math.max(t,i),n=[];for(const c of this.clipRects)c.x+c.w<s||c.x>l||c.y+c.h<o||c.y>a||n.push(c.clip.id);return n}getCursor(e,t){if("draw"===t)return"crosshair";if("erase"===t)return"not-allowed";if("split"===t)return"col-resize";if("clip"===e.type)switch(e.zone){case"resize-start":case"resize-end":return"ew-resize";case"body":return"move"}return"track-resize"===e.type?"ns-resize":"ruler"===e.type?"pointer":"default"}}class z{_state="idle";_tool="select";_drag=null;_ghostClips=[];_selectionBox=null;_drawPreview=null;_cursor="default";_dirty=!0;get state(){return this._state}get tool(){return this._tool}get drag(){return this._drag}setTool(e){this._tool=e,this._dirty=!0}beginDrag(e,t,r,i,s,l,o,a){this._state=e,this._drag={startX:t,startY:r,currentX:t,currentY:r,startRow:i,startTrackIndex:s,targetClipId:l,selectedAtStart:new Set(o),originalClips:[...a]},this._dirty=!0}updateDrag(e,t){this._drag&&(this._drag.currentX=e,this._drag.currentY=t,this._dirty=!0)}endDrag(){this._state="idle",this._drag=null,this._ghostClips=[],this._selectionBox=null,this._drawPreview=null,this._dirty=!0}setGhostClips(e){this._ghostClips=e,this._dirty=!0}setSelectionBox(e){this._selectionBox=e,this._dirty=!0}setDrawPreview(e){this._drawPreview=e,this._dirty=!0}updateCursor(e){let t;if("idle"!==this._state)switch(this._state){case"moving-clips":t="move";break;case"resizing-clip-start":case"resizing-clip-end":t="ew-resize";break;case"drawing-clip":case"select-box":t="crosshair";break;case"erasing":t="not-allowed";break;case"moving-playhead":t="pointer";break;default:t="default"}else if("draw"===this._tool)t="crosshair";else if("erase"===this._tool)t="not-allowed";else if("split"===this._tool)t="col-resize";else if("clip"===e.type)switch(e.zone){case"resize-start":case"resize-end":t="ew-resize";break;case"body":t="move";break;default:t="default"}else t="ruler"===e.type?"pointer":"track-resize"===e.type?"ns-resize":"default";t!==this._cursor&&(this._cursor=t,this._dirty=!0)}getRenderState(){const e={state:this._state,ghostClips:this._ghostClips,selectionBox:this._selectionBox,drawPreview:this._drawPreview,cursor:this._cursor,dirty:this._dirty};return this._dirty=!1,e}getDragDelta(e,t){if(!this._drag)return{deltaRow:0,deltaTrackIndex:0};return{deltaRow:Math.round((this._drag.currentX-this._drag.startX)/e),deltaTrackIndex:Math.round((this._drag.currentY-this._drag.startY)/(t||60))}}markDirty(){this._dirty=!0}}class N{beforeState=null;description="";committed=!1;begin(e,t){this.beforeState=JSON.parse(JSON.stringify(e)),this.description=t,this.committed=!1}get isActive(){return null!==this.beforeState&&!this.committed}execute(e){this.isActive&&e()}commit(e){this.beforeState&&!this.committed&&(e(this.beforeState),this.committed=!0,this.beforeState=null)}cancel(){this.beforeState=null,this.committed=!1}getBeforeState(){return this.beforeState}getDescription(){return this.description}}class D{render(e,t,r,i){const s=new Map(i.map(e=>[e.trackId,e])),l=t.getVisibleRowRange(),o=new Map;for(const a of r){if(!a.visible||!a.enabled||0===a.points.length)continue;const e=o.get(a.trackId)??[];e.push(a),o.set(a.trackId,e)}for(const[a,n]of o){const r=s.get(a);if(r&&r.visible&&!(r.automationHeight<=0))for(let i=0;i<n.length;i++){const s=t.trackYToScreenY(r.automationY)+40*i,o=40;s+o<0||s>t.height||this.drawLane(e,t,n[i],s,o,l.startRow,l.endRow)}}}drawLane(e,t,r,i,s,l,o){const a=r.points;if(0===a.length)return;e.save(),e.beginPath(),e.rect(0,i,t.width,s),e.clip();const n=[];for(const d of a){if(d.row>o+10)break;const e=t.rowToPixelX(d.row),r=i+s-d.value*s;n.push({x:e,y:r})}if(0===n.length)return void e.restore();e.beginPath(),e.moveTo(n[0].x,i+s);for(const d of n)e.lineTo(d.x,d.y);e.lineTo(n[n.length-1].x,i+s),e.closePath();const c=e.createLinearGradient(0,i,0,i+s);c.addColorStop(0,"rgba(59,130,246,0.2)"),c.addColorStop(1,"rgba(59,130,246,0.02)"),e.fillStyle=c,e.fill(),e.beginPath(),e.moveTo(n[0].x,n[0].y);for(let d=1;d<n.length;d++)e.lineTo(n[d].x,n[d].y);e.strokeStyle="#3b82f6",e.lineWidth=1.5,e.stroke(),e.fillStyle="#3b82f6";for(const d of n)d.x<-3||d.x>t.width+3||(e.beginPath(),e.arc(d.x,d.y,3,0,2*Math.PI),e.fill());e.restore()}}const $=36,Y=()=>{const r=o.useRef(null),l=o.useRef(null),a=o.useRef(0),n=o.useRef(!0),c=o.useRef(new R),d=o.useRef(new S),h=o.useRef(new T),u=o.useRef(new I),p=o.useRef(new j),f=o.useRef(new _),g=o.useRef(new z),x=o.useRef(new N),w=o.useRef(new D),b=o.useCallback(()=>{n.current=!0},[]);o.useEffect(()=>{let t=e.getState().tool,r=i.getState().patterns;const l=[e.subscribe(e=>{e.tool!==t&&(t=e.tool,g.current.setTool(e.tool)),b()}),s.subscribe(b),i.subscribe(e=>{e.patterns!==r&&(r=e.patterns,u.current.invalidateCache(),b())})];return()=>l.forEach(e=>e())},[b]),o.useEffect(()=>{const e=l.current;if(!e)return;const t=new ResizeObserver(e=>{for(const t of e){const{width:e,height:r}=t.contentRect;c.current.update({width:e,height:r-$}),n.current=!0}});return t.observe(e),()=>t.disconnect()},[]),o.useEffect(()=>{const t=()=>{a.current=requestAnimationFrame(t);const l=r.current;if(!l)return;const o=g.current.getRenderState();if(!n.current&&!o.dirty)return;n.current=!1;const x=l.getContext("2d");if(!x)return;const b=window.devicePixelRatio||1,m=e.getState(),v=s.getState(),y=i.getState().patterns,k=c.current,R=d.current;if(m.view.followPlayback&&m.isArrangementMode&&v.isPlaying){const e=(m.playbackRow-m.view.scrollRow)*m.view.pixelsPerRow,t=l.getBoundingClientRect().width;(e>.8*t||e<0)&&m.setScrollRow(Math.max(0,m.playbackRow-.2*t/m.view.pixelsPerRow))}k.update({scrollRow:m.view.scrollRow,scrollY:m.view.scrollY,pixelsPerRow:m.view.pixelsPerRow}),R.rebuild(m.tracks,m.groups,m.automationLanes),f.current.rebuild(m.clips,m.tracks,y,k,R);const S=l.getBoundingClientRect(),C=S.width,T=S.height;l.width===Math.ceil(C*b)&&l.height===Math.ceil(T*b)||(l.width=Math.ceil(C*b),l.height=Math.ceil(T*b)),x.setTransform(b,0,0,b,0,0),x.clearRect(0,0,C,T);const I=R.getVisibleEntries(m.view.scrollY,T-$),M=v.speed||6,P=v.timeSignature[0]||4,j=m.getTotalRows(),_=p.current.render(k,M,P,m.markers,m.view.loopStart,m.view.loopEnd,b);_&&x.drawImage(_,0,0,C,$),x.save(),x.translate(0,$);const z=h.current.render(k,I,M,P,j,b);if(z&&x.drawImage(z,0,0,C,T-$),null!==m.view.loopStart&&null!==m.view.loopEnd&&m.view.loopEnd>m.view.loopStart){const e=k.rowToPixelX(m.view.loopStart),t=(m.view.loopEnd-m.view.loopStart)*k.pixelsPerRow;x.fillStyle="rgba(34,197,94,0.06)",x.fillRect(e,0,t,T-$)}if(u.current.render(x,k,m.clips,m.tracks,I,y,m.selectedClipIds,o.ghostClips.length>0?o.ghostClips:null),w.current.render(x,k,m.automationLanes,I),o.selectionBox){const{x1:e,y1:t,x2:r,y2:i}=o.selectionBox;x.strokeStyle="#3b82f6",x.lineWidth=1,x.setLineDash([4,4]),x.strokeRect(Math.min(e,r),Math.min(t,i)-$,Math.abs(r-e),Math.abs(i-t)),x.setLineDash([]),x.fillStyle="rgba(59,130,246,0.08)",x.fillRect(Math.min(e,r),Math.min(t,i)-$,Math.abs(r-e),Math.abs(i-t))}if(o.drawPreview){const e=R.getEntryForTrack(o.drawPreview.trackId);if(e&&e.visible){const t=k.rowToPixelX(o.drawPreview.startRow),r=(o.drawPreview.endRow-o.drawPreview.startRow)*k.pixelsPerRow,i=k.trackYToScreenY(e.y);x.fillStyle="rgba(59,130,246,0.2)",x.strokeStyle="#3b82f6",x.lineWidth=1,x.fillRect(t,i,r,e.bodyHeight),x.strokeRect(t,i,r,e.bodyHeight)}}if(m.isArrangementMode){const e=k.rowToPixelX(m.playbackRow);e>=-2&&e<=C+2&&(x.fillStyle="rgba(239,68,68,0.15)",x.fillRect(e-3,0,8,T-$),x.fillStyle="#ef4444",x.fillRect(e,0,2,T-$))}if(x.restore(),m.isArrangementMode){const e=k.rowToPixelX(m.playbackRow);e>=-6&&e<=C+6&&(x.fillStyle="#ef4444",x.beginPath(),x.moveTo(e+1,$),x.lineTo(e-5,29),x.lineTo(e+7,29),x.closePath(),x.fill(),x.fillStyle="rgba(239,68,68,0.5)",x.fillRect(e,0,1,$))}l.style.cursor!==o.cursor&&(l.style.cursor=o.cursor)};return a.current=requestAnimationFrame(t),()=>cancelAnimationFrame(a.current)},[]);const m=o.useCallback(e=>{const t=r.current;if(!t)return{x:0,y:0};const i=t.getBoundingClientRect();return{x:e.clientX-i.left,y:e.clientY-i.top}},[]),v=o.useCallback(t=>{const{x:r,y:i}=m(t),l=c.current,o=d.current,a=g.current,h=e.getState(),u=f.current.hitTest(r,i,l,o,$);if("ruler"===u.type)return a.beginDrag("moving-playhead",r,i,u.row,0,null,h.selectedClipIds,[]),e.getState().setPlaybackRow(u.row),void s.getState().setCurrentGlobalRow(u.row);if("select"===a.tool)if("clip"===u.type)if("body"===u.zone){t.shiftKey||h.selectedClipIds.has(u.clipId)?t.shiftKey&&h.selectClip(u.clipId,!0):h.selectClip(u.clipId);const s=e.getState().selectedClipIds,l=h.clips.filter(e=>s.has(e.id));a.beginDrag("moving-clips",r,i,u.row,0,u.clipId,s,l),x.current.begin(h.getSnapshot(),"Move clips")}else"resize-start"===u.zone?(h.selectClip(u.clipId),a.beginDrag("resizing-clip-start",r,i,u.row,0,u.clipId,h.selectedClipIds,[]),x.current.begin(h.getSnapshot(),"Resize clip start")):"resize-end"===u.zone&&(h.selectClip(u.clipId),a.beginDrag("resizing-clip-end",r,i,u.row,0,u.clipId,h.selectedClipIds,[]),x.current.begin(h.getSnapshot(),"Resize clip end"));else"empty"===u.type&&(t.shiftKey||h.clearSelection(),a.beginDrag("select-box",r,i,u.row,u.trackIndex,null,h.selectedClipIds,[]));else if("draw"===a.tool){if("empty"===u.type){const e=h.view.snapDivision||1,t=l.snapRow(u.row,e);a.beginDrag("drawing-clip",r,i,t,u.trackIndex,null,h.selectedClipIds,[]),a.setDrawPreview({trackId:u.trackId,startRow:t,endRow:t+e})}}else if("erase"===a.tool)"clip"===u.type&&(x.current.begin(h.getSnapshot(),"Erase clip"),h.removeClip(u.clipId),x.current.commit(t=>e.getState().pushUndo(t)));else if("split"===a.tool&&"clip"===u.type){const t=h.view.snapDivision||1,r=l.snapRow(u.row,t);x.current.begin(h.getSnapshot(),"Split clip"),h.splitClip(u.clipId,r),x.current.commit(t=>e.getState().pushUndo(t))}n.current=!0},[m]),y=o.useCallback(t=>{const{x:r,y:i}=m(t),l=c.current,o=d.current,a=g.current;if("idle"!==a.state&&a.drag){a.updateDrag(r,i);const t=e.getState(),o=t.view.snapDivision||1;if("moving-clips"===a.state){const{deltaRow:e}=a.getDragDelta(l.pixelsPerRow,60),t=Math.round(e/o)*o,r=a.drag.originalClips.map(e=>({...e,startRow:Math.max(0,e.startRow+t)}));a.setGhostClips(r)}else if("select-box"===a.state){a.setSelectionBox({x1:a.drag.startX,y1:a.drag.startY,x2:r,y2:i});const e=f.current.findClipsInRect(a.drag.startX,a.drag.startY-$,r,i-$);t.selectClips(e)}else if("drawing-clip"===a.state){const e=Math.max(0,l.snapRow(l.pixelXToRow(r),o)),t=a.drag.startRow;a.setDrawPreview({trackId:"",startRow:Math.min(t,e),endRow:Math.max(t+o,e)})}else if("resizing-clip-end"===a.state){const e=Math.max(1,l.snapRow(l.pixelXToRow(r),o));a.drag.targetClipId&&t.resizeClipEnd(a.drag.targetClipId,e)}else if("resizing-clip-start"===a.state){const e=Math.max(0,l.snapRow(l.pixelXToRow(r),o));a.drag.targetClipId&&t.resizeClipStart(a.drag.targetClipId,e)}else if("moving-playhead"===a.state){const e=Math.max(0,Math.round(l.pixelXToRow(r)));t.setPlaybackRow(e),s.getState().setCurrentGlobalRow(e)}}else{const e=f.current.hitTest(r,i,l,o,$);a.updateCursor(e)}n.current=!0},[m]),k=o.useCallback(t=>{const r=g.current,s=e.getState();if("moving-clips"===r.state&&r.drag){const e=s.view.snapDivision||1,{deltaRow:t}=r.getDragDelta(c.current.pixelsPerRow,60),i=Math.round(t/e)*e;0!==i?(s.moveClips([...s.selectedClipIds],i,0),x.current.commit(e=>s.pushUndo(e))):x.current.cancel()}else if("drawing-clip"===r.state&&r.drag){const e=c.current,l=s.view.snapDivision||1,o=Math.max(0,e.snapRow(e.pixelXToRow(m(t).x),l)),a=Math.min(r.drag.startRow,o),n=Math.max(r.drag.startRow+l,o),h=e.screenYToTrackY(m(t).y-$),u=d.current.hitTestY(h);if(u){const e=i.getState().patterns;e.length>0&&(x.current.begin(s.getSnapshot(),"Draw clip"),s.addClip({patternId:e[0].id,trackId:u.trackId,startRow:a,offsetRows:0,clipLengthRows:n-a,sourceChannelIndex:0,color:null,muted:!1}),x.current.commit(e=>s.pushUndo(e)))}}else"resizing-clip-start"!==r.state&&"resizing-clip-end"!==r.state||x.current.commit(e=>s.pushUndo(e));r.endDrag(),n.current=!0},[m]);return o.useEffect(()=>{const e=()=>{const e=g.current;"idle"!==e.state&&(e.endDrag(),n.current=!0)};return window.addEventListener("mouseup",e),()=>window.removeEventListener("mouseup",e)},[]),o.useEffect(()=>{const t=r.current;if(!t)return;const i=t=>{t.preventDefault();const r=e.getState();if(t.ctrlKey||t.metaKey){const e=t.deltaY>0?.9:1.1;r.setPixelsPerRow(Math.max(.5,Math.min(32,r.view.pixelsPerRow*e)))}else t.shiftKey?r.setScrollRow(Math.max(0,r.view.scrollRow+t.deltaY/r.view.pixelsPerRow)):r.setScrollY(Math.max(0,r.view.scrollY+t.deltaY));n.current=!0};return t.addEventListener("wheel",i,{passive:!1}),()=>t.removeEventListener("wheel",i)},[]),t.jsx("div",{ref:l,className:"flex-1 relative overflow-hidden",children:t.jsx("canvas",{ref:r,className:"absolute inset-0 w-full h-full",onMouseDown:v,onMouseMove:y,onMouseUp:k})})},E=({x:r,y:i,clipId:s,trackId:l,row:o,onClose:a})=>{const{removeClips:n,duplicateClips:c,toggleClipMute:d,splitClip:h,selectAllClipsOnTrack:u,selectedClipIds:p,pushUndo:f}=e(),g=e=>{f(),e(),a()};return t.jsxs("div",{className:"fixed z-50 bg-dark-bgSecondary border border-dark-border rounded-lg shadow-xl py-1 text-xs min-w-[160px]",style:{left:r,top:i},onMouseDown:e=>e.stopPropagation(),children:[s&&t.jsxs(t.Fragment,{children:[t.jsx(L,{label:"Duplicate",onClick:()=>g(()=>c([...p]))}),t.jsx(L,{label:"Split at Cursor",onClick:()=>g(()=>h(s,o))}),t.jsx(L,{label:"Mute/Unmute",onClick:()=>g(()=>d(s))}),t.jsx(X,{}),t.jsx(L,{label:"Delete",onClick:()=>g(()=>n([...p])),danger:!0})]}),l&&!s&&t.jsx(t.Fragment,{children:t.jsx(L,{label:"Select All on Track",onClick:()=>{u(l),a()}})}),!s&&!l&&t.jsx("div",{className:"px-3 py-1 text-text-muted italic",children:"No selection"})]})},L=({label:e,onClick:r,danger:i})=>t.jsx("button",{className:"w-full px-3 py-1.5 text-left hover:bg-dark-bgTertiary "+(i?"text-red-400 hover:text-red-300":"text-text-primary"),onClick:r,children:e}),X=()=>t.jsx("div",{className:"my-1 border-t border-dark-border"}),B=()=>{const{tracks:r,groups:s,view:n,setTool:c,selectedClipIds:d,removeClips:h,duplicateClips:u,clearSelection:p,selectAllClipsOnTrack:f,pushUndo:g,undo:x,redo:w,importFromPatternOrder:b}=e(),m=o.useRef(!1),y=o.useRef(!1);o.useEffect(()=>{if(m.current)return;if(r.length>0)return;const{patternOrder:e,patterns:t}=i.getState();t.length>0&&e.length>0&&(m.current=!0,b(e,t),l.success("Converted pattern order to arrangement"))},[r.length,b]),o.useEffect(()=>{y.current||0===r.length||(y.current=!0,e.getState().zoomToFit())},[r.length]);const R=o.useMemo(()=>{const e=r.slice().sort((e,t)=>e.index-t.index),t=[];let i=0;for(let r=0;r<e.length;r++){const l=e[r],o=l.groupId?s.find(e=>e.id===l.groupId):null,a=!o||!o.collapsed,n=a?l.height:0;t.push({trackId:l.id,trackIndex:r,y:i,height:n,bodyHeight:n,automationY:i+n,automationHeight:0,visible:a}),a&&(i+=l.height)}return t},[r,s]),[S,C]=a.useState(null),T=o.useRef(null),I=o.useCallback(t=>{if("INPUT"===t.target?.tagName||"SELECT"===t.target?.tagName)return;const r=t.ctrlKey||t.metaKey;if(!r&&!t.shiftKey)switch(t.key.toLowerCase()){case"v":return c("select"),void t.preventDefault();case"d":return c("draw"),void t.preventDefault();case"e":return c("erase"),void t.preventDefault();case"s":return c("split"),void t.preventDefault()}if(("Delete"===t.key||"Backspace"===t.key)&&d.size>0)return g(),h([...d]),void t.preventDefault();if(r&&"a"===t.key){const r=e.getState().selectedTrackId;if(r)return f(r),void t.preventDefault()}return r&&"d"===t.key&&d.size>0?(g(),u([...d]),void t.preventDefault()):r&&"z"===t.key&&!t.shiftKey?(x(),void t.preventDefault()):r&&"z"===t.key&&t.shiftKey?(w(),void t.preventDefault()):void("Escape"===t.key&&(p(),C(null),t.preventDefault()))},[d,c,h,u,p,f,g,x,w]);o.useEffect(()=>(window.addEventListener("keydown",I),()=>window.removeEventListener("keydown",I)),[I]);const M=o.useCallback(e=>{e.preventDefault(),C({x:e.clientX,y:e.clientY,clipId:1===d.size?[...d][0]:null,trackId:null,row:0})},[d]);return o.useEffect(()=>{if(!S)return;const e=()=>C(null);return window.addEventListener("mousedown",e),()=>window.removeEventListener("mousedown",e)},[S]),t.jsxs("div",{ref:T,className:"flex flex-col h-full bg-dark-bg",onContextMenu:M,children:[t.jsx(v,{}),t.jsxs("div",{className:"flex flex-1 overflow-hidden",children:[t.jsx(k,{tracks:r,groups:s,entries:R,scrollY:n.scrollY}),t.jsx(Y,{})]}),S&&t.jsx(E,{x:S.x,y:S.y,clipId:S.clipId,trackId:S.trackId,row:S.row,onClose:()=>C(null)})]})},F=({group:r})=>{const{toggleGroupCollapse:i}=e();return t.jsxs("div",{className:"flex items-center gap-1.5 px-2 py-1 border-b border-dark-border bg-dark-bgTertiary select-none cursor-pointer hover:bg-dark-border/50",onClick:()=>i(r.id),children:[r.collapsed?t.jsx(w,{size:12,className:"text-text-muted"}):t.jsx(b,{size:12,className:"text-text-muted"}),t.jsx("div",{className:"w-2 h-2 rounded-full flex-shrink-0",style:{backgroundColor:r.color||"#888"}}),t.jsx("span",{className:"text-xs font-medium text-text-primary truncate flex-1",children:r.name}),t.jsx("span",{className:"text-[9px] text-text-muted",children:r.collapsed?"...":""})]})};export{Y as ArrangementCanvas,E as ArrangementContextMenu,v as ArrangementToolbar,B as ArrangementView,F as TrackGroupHeader,y as TrackHeader,k as TrackHeaderPanel};
