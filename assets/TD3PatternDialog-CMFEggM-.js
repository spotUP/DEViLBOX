import{as as e,at as t,au as n,av as r,u as s,aw as a,j as o,ax as l}from"./index-DWtmwK1e.js";import{r as i}from"./vendor-utils-Cm-70yv0.js";import{X as c,a2 as d,D as u,aA as x,e as m,aL as p,b8 as f,L as h}from"./vendor-ui-CuKercQz.js";import"./vendor-react-LeNVipsj.js";import"./vendor-tone-C_GMrdAr.js";function g(e){if(!e.note)return 0;const{value:t,octave:n,upperC:r}=e.note;let s=12+t+12*n;return r&&(s|=128),s}function b(t){const n=Math.max(0,Math.min(3,t.group)),r=Math.max(0,Math.min(15,t.pattern)),s=t.steps.slice(0,16);for(;s.length<16;)s.push({note:null,accent:!1,slide:!1,tie:!1});const a=function(e){const t=new Uint8Array(32);for(let n=0;n<16;n++){const r=g(e[n]||{note:null});t[2*n]=r>>4&15,t[2*n+1]=15&r}return t}(s),o=function(e){const t=new Uint8Array(32);for(let n=0;n<16;n++){const r=e[n]||{accent:!1};t[2*n]=0,t[2*n+1]=r.accent?1:0}return t}(s),l=function(e){const t=new Uint8Array(32);for(let n=0;n<16;n++){const r=e[n]||{slide:!1};t[2*n]=0,t[2*n+1]=r.slide?1:0}return t}(s),i=new Uint8Array([0,0]),c=function(e){const t=Math.max(1,Math.min(16,e));return new Uint8Array([t>>4&15,15&t])}(t.activeSteps),d=new Uint8Array([0,0]),u=function(e){let t=0;for(let n=0;n<16;n++){const r=e[n];r?.tie&&(t|=1<<n)}return new Uint8Array([t>>4&15,15&t,t>>12&15,t>>8&15])}(s),x=function(e){let t=0;for(let n=0;n<16;n++){const r=e[n];r?.note||(t|=1<<n)}return new Uint8Array([t>>4&15,15&t,t>>12&15,t>>8&15])}(s),m=e.HEADER.length,p=new Uint8Array(m+115+1);let f=0;return p.set(e.HEADER,f),f+=e.HEADER.length,p[f++]=e.CMD_SEND_PATTERN,p[f++]=n,p[f++]=r,p[f++]=0,p[f++]=1,p.set(a,f),f+=a.length,p.set(o,f),f+=o.length,p.set(l,f),f+=l.length,p.set(i,f),f+=i.length,p.set(c,f),f+=c.length,p.set(d,f),f+=d.length,p.set(u,f),f+=u.length,p.set(x,f),f+=x.length,p[f]=e.FOOTER,p}function v(e,t){return`${["A","B","C","D"][e]||"?"}${t<8?"A":"B"}${t%8+1}`}function y(e,t){const n=e<<4|t;if(0===n)return null;const r=!!(128&n),s=(127&n)-12;if(s<0)return null;const a=Math.floor(s/12),o=s%12;return{value:o,octave:Math.min(a,2),upperC:r&&0===o}}function j(e,t){const n=[];for(let r=0;r<16;r++)n.push(0!==e[t+2*r+1]);return n}function N(t){const n=function(t){if(t.length<e.HEADER.length+5)return{valid:!1,error:"Message too short"};for(let r=0;r<e.HEADER.length;r++)if(t[r]!==e.HEADER[r])return{valid:!1,error:"Invalid TD-3 header"};const n=t[e.HEADER.length];return n!==e.CMD_SEND_PATTERN?{valid:!1,error:`Invalid command: expected ${e.CMD_SEND_PATTERN}, got ${n}`}:t[t.length-1]!==e.FOOTER?{valid:!1,error:"Invalid SysEx footer"}:{valid:!0}}(t);if(!n.valid)return null;const r=e.HEADER.length+1,s=t[r],a=t[r+1],o=function(e,t){const n=[];for(let r=0;r<16;r++){const s=e[t+2*r],a=e[t+2*r+1];n.push(y(s,a))}return n}(t,r+4),l=j(t,r+36),i=j(t,r+68),c=0!==t[r+101],d=function(e,t){return e[t]<<4|e[t+1]}(t,r+102),u=function(e,t){const n=e[t+1]|e[t]<<4|e[t+3]<<8|e[t+2]<<12,r=[];for(let s=0;s<16;s++)r.push(!!(n&1<<s));return r}(t,r+106),x=[];for(let e=0;e<16;e++)x.push({note:o[e],accent:l[e],slide:i[e],tie:u[e]});return{group:s,pattern:a,steps:x,triplet:c,activeSteps:Math.min(16,Math.max(1,d))}}const E={C:0,"C#":1,D:2,"D#":3,E:4,F:5,"F#":6,G:7,"G#":8,A:9,"A#":10,B:11},w=["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"];function C(e){if(!e||"==="===e||"---"===e)return null;const t=e.match(/^([A-G])(#?)(-?\d)$/);if(!t)return null;const[,n,r,s]=t,a=parseInt(s,10),o=E[n+(r||"")];return void 0===o?null:{semitone:o,octave:a}}function k(e,t=2){if(!e)return null;const n=C(e);if(!n)return null;const{semitone:r,octave:s}=n;let a=s-t,o=!1;return 0===r&&3===a&&(o=!0,a=2),a<0||a>2?null:{value:r,octave:a,upperC:o}}function A(e,n=2){const r=0===e.note||97===e.note,s=r?"":t(e.note);return{note:r?null:k(s,n),accent:1===e.flag1||1===e.flag2,slide:2===e.flag1||2===e.flag2,tie:!1}}function D(e,t=2){const r=e.note?function(e,t=2){let n=t+e.octave;e.upperC&&0===e.value&&(n+=1);const r=w[e.value];return r.includes("#")?`${r}${n}`:`${r}-${n}`}(e.note,t):"";return{note:r?n(r):0,instrument:0,volume:0,effTyp:0,eff:0,effTyp2:0,eff2:0,flag1:e.accent?1:void 0,flag2:e.slide?2:void 0}}function S(e,n=2){const r=[],s=[];e.length>16&&r.push(`Pattern has ${e.length} rows, only first 16 will be exported`);for(let a=0;a<Math.min(e.length,16);a++){const o=e[a],l=A(o,n);if(o.note&&0!==o.note&&97!==o.note&&!l.note){const e=t(o.note);r.push(`Row ${a+1}: Note ${e} is out of TD-3 range (C2-C5)`)}if(a>0&&l.note&&e[a-1]){const t=e[a-1];t.note&&0!==t.note&&97!==t.note&&t.note===o.note&&(l.tie=!0)}s.push(l)}for(;s.length<16;)s.push({note:null,accent:!1,slide:!1,tie:!1});return{steps:s,warnings:r}}const T=["A","B","C","D"],M=({isOpen:n,onClose:g})=>{const[y,j]=i.useState("export"),[E,w]=i.useState(0),[A,M]=i.useState(0),[R,$]=i.useState(0),[H,I]=i.useState(2),[z,F]=i.useState(!1),[P,U]=i.useState(!1),[O,L]=i.useState(null),[_,B]=i.useState(null),[q,G]=i.useState([]),J=i.useRef(null),V=i.useRef(null),{selectedOutputId:Q,selectedInputId:W}=r(),{patterns:Y,currentPatternIndex:K,cursor:X,setCell:Z}=s(),ee=Y[K],te=ee?.channels||[];i.useEffect(()=>{if(n&&(L(null),B(null),G([]),$(X.channelIndex),ee&&ee.channels[X.channelIndex])){const e=ee.channels[X.channelIndex].rows;I(function(e){const n=new Map;for(const a of e)if(a.note&&0!==a.note&&97!==a.note){const e=C(t(a.note));if(e){const t=n.get(e.octave)||0;n.set(e.octave,t+1)}}if(0===n.size)return 2;let r=0,s=2;return n.forEach((e,t)=>{e>r&&(r=e,s=t)}),Math.max(1,Math.min(4,s))}(e))}},[n,X.channelIndex,ee]),i.useEffect(()=>()=>{null!==J.current&&(clearTimeout(J.current),J.current=null)},[]),i.useEffect(()=>{if(!n||"import"!==y||!P)return;const t=a(),r=t=>{if("sysex"===t.type&&function(t){if(t.length<e.HEADER.length+2)return!1;for(let n=0;n<e.HEADER.length;n++)if(t[n]!==e.HEADER[n])return!1;return t[e.HEADER.length]===e.CMD_SEND_PATTERN}(t.data)){const e=N(t.data);e&&(null!==J.current&&(clearTimeout(J.current),J.current=null),B(e),U(!1))}};return t.addMessageHandler(r),()=>t.removeMessageHandler(r)},[n,y,P]);const ne=i.useCallback(()=>ee&&ee.channels[R]?ee.channels[R].rows:[],[ee,R]),re=function(e,n=2){const r=[],s=[];if(0===e.length)return r.push("Pattern is empty"),{valid:!1,errors:r,warnings:s};e.length>16&&s.push(`Pattern has ${e.length} rows, only first 16 will be exported`);let a=0;for(let o=0;o<Math.min(e.length,16);o++){const r=e[o];r.note&&0!==r.note&&97!==r.note&&(k(t(r.note),n)||a++)}return a>0&&s.push(`${a} note(s) are out of TD-3 range and will be skipped`),{valid:0===r.length,errors:r,warnings:s}}(ne(),H);return n?o.jsx("div",{className:"fixed inset-0 bg-black/60 flex items-center justify-center z-50 animate-fade-in",children:o.jsxs("div",{className:"bg-dark-bgSecondary border border-dark-border rounded-lg shadow-xl w-[480px] max-h-[80vh] overflow-hidden animate-slide-in-up",children:[o.jsxs("div",{className:"flex items-center justify-between px-4 py-3 border-b border-dark-border",children:[o.jsx("h2",{className:"text-lg font-bold text-text-primary",children:"TD-3 Pattern Transfer"}),o.jsx("button",{onClick:g,className:"p-1 rounded hover:bg-dark-bgHover text-text-muted hover:text-text-primary transition-colors",children:o.jsx(c,{size:18})})]}),o.jsxs("div",{className:"flex border-b border-dark-border",children:[o.jsxs("button",{onClick:()=>j("export"),className:"flex-1 px-4 py-2 text-sm font-medium transition-colors flex items-center justify-center gap-2\n              "+("export"===y?"text-text-primary border-b-2 border-accent-primary bg-dark-bgActive":"text-text-secondary hover:text-text-primary"),children:[o.jsx(d,{size:14}),"Export"]}),o.jsxs("button",{onClick:()=>j("import"),className:"flex-1 px-4 py-2 text-sm font-medium transition-colors flex items-center justify-center gap-2\n              "+("import"===y?"text-text-primary border-b-2 border-accent-primary bg-dark-bgActive":"text-text-secondary hover:text-text-primary"),children:[o.jsx(u,{size:14}),"Import"]})]}),o.jsxs("div",{className:"p-4 space-y-4 overflow-y-auto max-h-[400px]",children:[!Q&&"export"===y&&o.jsxs("div",{className:"flex items-center gap-2 p-3 bg-accent-warning/10 border border-accent-warning/30 rounded-md",children:[o.jsx(x,{size:16,className:"text-accent-warning flex-shrink-0"}),o.jsx("span",{className:"text-sm text-text-secondary",children:"No MIDI output selected. You can still export to file."})]}),(!Q||!W)&&"import"===y&&!_&&o.jsxs("div",{className:"flex items-center gap-2 p-3 bg-dark-bgTertiary border border-dark-border rounded-md",children:[o.jsx(x,{size:16,className:"text-text-muted flex-shrink-0"}),o.jsx("span",{className:"text-sm text-text-muted",children:'MIDI transfer requires hardware. Use "Load File" for .sqs or .json patterns.'})]}),o.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[o.jsxs("div",{children:[o.jsx("label",{className:"block text-xs font-medium text-text-muted uppercase tracking-wide mb-1",children:"Group"}),o.jsx("div",{className:"flex gap-1",children:T.map((e,t)=>o.jsx("button",{onClick:()=>w(t),className:"flex-1 py-2 rounded font-medium text-sm transition-colors\n                      "+(E===t?"bg-accent-primary text-text-inverse":"bg-dark-bgTertiary text-text-secondary hover:text-text-primary hover:bg-dark-bgActive"),children:e},e))})]}),o.jsxs("div",{children:[o.jsx("label",{className:"block text-xs font-medium text-text-muted uppercase tracking-wide mb-1",children:"Pattern (1-16)"}),o.jsx("select",{value:A,onChange:e=>M(Number(e.target.value)),className:"w-full px-3 py-2 rounded bg-dark-bgTertiary border border-dark-border text-text-primary",children:Array.from({length:16},(e,t)=>o.jsx("option",{value:t,children:t<8?`A${t+1}`:"B"+(t-7)},t))})]})]}),"export"===y&&o.jsxs(o.Fragment,{children:[o.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[o.jsxs("div",{children:[o.jsx("label",{className:"block text-xs font-medium text-text-muted uppercase tracking-wide mb-1",children:"Source Channel"}),o.jsx("select",{value:R,onChange:e=>$(Number(e.target.value)),className:"w-full px-3 py-2 rounded bg-dark-bgTertiary border border-dark-border text-text-primary",children:te.map((e,t)=>o.jsx("option",{value:t,children:e.name||`Channel ${t+1}`},t))})]}),o.jsxs("div",{children:[o.jsx("label",{className:"block text-xs font-medium text-text-muted uppercase tracking-wide mb-1",children:"Base Octave"}),o.jsxs("select",{value:H,onChange:e=>I(Number(e.target.value)),className:"w-full px-3 py-2 rounded bg-dark-bgTertiary border border-dark-border text-text-primary",children:[o.jsx("option",{value:1,children:"C1 - C4"}),o.jsx("option",{value:2,children:"C2 - C5"}),o.jsx("option",{value:3,children:"C3 - C6"}),o.jsx("option",{value:4,children:"C4 - C7"})]})]})]}),(re.warnings.length>0||q.length>0)&&o.jsx("div",{className:"space-y-1",children:[...re.warnings,...q].map((e,t)=>o.jsxs("div",{className:"flex items-center gap-2 text-xs text-accent-warning",children:[o.jsx(x,{size:12}),o.jsx("span",{children:e})]},t))}),o.jsx("div",{className:"text-xs text-text-muted",children:o.jsxs("p",{children:["Exporting ",Math.min(16,ne().length)," steps from"," ",te[R]?.name||`Channel ${R+1}`," to"," ",o.jsx("span",{className:"text-text-primary font-mono",children:v(E,A)})]})})]}),"import"===y&&_&&o.jsxs("div",{className:"p-3 bg-dark-bgTertiary rounded-md border border-accent-primary/20",children:[o.jsxs("h4",{className:"text-sm font-medium text-text-primary mb-2 flex items-center gap-2",children:[o.jsx(m,{size:14,className:"text-accent-success"}),"Pattern Loaded"]}),o.jsxs("p",{className:"text-xs text-text-muted",children:[_.activeSteps," active steps detected."]}),o.jsxs("div",{className:"mt-3",children:[o.jsx("label",{className:"block text-xs font-medium text-text-muted uppercase tracking-wide mb-1",children:"Target Channel"}),o.jsx("select",{value:R,onChange:e=>$(Number(e.target.value)),className:"w-full px-3 py-2 rounded bg-dark-bg border border-dark-border text-text-primary",children:te.map((e,t)=>o.jsx("option",{value:t,children:e.name||`Channel ${t+1}`},t))})]})]}),O&&o.jsxs("div",{className:"flex items-center gap-2 p-3 rounded-md "+(O.success?"bg-accent-success/10 border border-accent-success/30":"bg-accent-error/10 border border-accent-error/30"),children:[O.success?o.jsx(m,{size:16,className:"text-accent-success"}):o.jsx(x,{size:16,className:"text-accent-error"}),o.jsx("span",{className:"text-sm text-text-secondary",children:O.message})]})]}),o.jsxs("div",{className:"flex flex-wrap items-center justify-between gap-2 px-4 py-3 border-t border-dark-border bg-dark-bgTertiary",children:[o.jsxs("div",{className:"flex gap-2",children:["import"===y&&o.jsxs(o.Fragment,{children:[o.jsx("input",{ref:V,type:"file",accept:".json,.sqs",className:"hidden",onChange:async e=>{const t=e.target.files?.[0];if(t){try{const e=await t.arrayBuffer();if(t.name.toLowerCase().endsWith(".sqs")){const t=await async function(e){const t=new DataView(e),n=new Uint8Array(e);if(2269352194!==t.getUint32(0,!1))throw new Error("Invalid TD-3 file: bad magic bytes");let r="";for(let l=8;l<20;l+=2){const e=t.getUint16(l,!0);if(0===e)break;r+=String.fromCharCode(e)}let s="";for(let l=20;l<32;l+=2){const e=t.getUint16(l,!0);if(0===e)break;s+=String.fromCharCode(e)}const a=[];let o=32;for(;o<e.byteLength-100;)if(0===n[o+2]&&112===n[o+3]){const e=t.getUint16(o,!0),r=o+6,s=[];for(let t=0;t<16;t++){const e=r+2*t,a=n[e],o=n[e+1],l=0===a||15===o||8===o,i=!!(2&a);let c=15&o;c>11&&(c=0);const d=0;s.push({note:l?0:c,octave:d,accent:i,slide:!1,tie:!1,rest:l})}const l=r+32;for(let t=0;t<16;t++)s[t].slide=0!==n[l+2*t];const i=l+32;for(let t=0;t<16;t++)s[t].tie=0!==n[i+2*t];for(let t=15;t>=0&&s[t].rest;t--);a.push({index:e,name:`Pattern ${e+1}`,steps:s,length:16,tempo:120}),o+=126}else o++;return{name:r,version:s,patterns:a}}(e);if(t.patterns.length>0){const e=t.patterns[0],n=e.steps.map(e=>({note:e.rest?null:{value:e.note,octave:e.octave,upperC:!1},flag1:e.accent?1:void 0,flag2:e.slide?2:void 0,tie:e.tie}));B({group:0,pattern:0,steps:n,triplet:!1,activeSteps:e.length}),L({success:!0,message:`Loaded pattern "${e.name}" from .sqs file`})}}else{const t=(new TextDecoder).decode(e),n=JSON.parse(t),r=n.steps.map(e=>({note:null===e.note?null:{value:e.note,octave:e.octave,upperC:e.upperC||!1},flag1:e.accent?1:void 0,flag2:e.slide?2:void 0,tie:e.tie}));B({group:n.group||0,pattern:n.pattern||0,steps:r,triplet:n.triplet||!1,activeSteps:n.activeSteps||16}),L({success:!0,message:"Loaded pattern from JSON file"})}}catch(n){L({success:!1,message:"Failed to parse pattern file"})}V.current&&(V.current.value="")}}}),o.jsxs("button",{onClick:()=>V.current?.click(),className:"px-3 py-2 text-xs font-bold bg-dark-bg border border-dark-border text-text-secondary hover:text-text-primary rounded transition-colors flex items-center gap-2",children:[o.jsx(p,{size:14}),"LOAD FILE"]})]}),"export"===y&&o.jsxs("button",{onClick:()=>{const e=ne(),{steps:t}=S(e,H),n={name:`Pattern ${v(E,A)}`,steps:t.map(e=>({note:e.note?e.note.value:null,octave:e.note?e.note.octave:0,upperC:!!e.note&&e.note.upperC,flag1:e.accent?1:void 0,flag2:e.slide?2:void 0,tie:e.tie})),activeSteps:Math.min(16,e.length)},r=new Blob([JSON.stringify(n,null,2)],{type:"application/json"});l.saveAs(r,`td3-pattern-${v(E,A).replace(" ","")}.json`),L({success:!0,message:"Pattern exported to JSON file"})},className:"px-3 py-2 text-xs font-bold bg-dark-bg border border-dark-border text-text-secondary hover:text-text-primary rounded transition-colors flex items-center gap-2",children:[o.jsx(f,{size:14}),"SAVE AS JSON"]})]}),o.jsxs("div",{className:"flex gap-2",children:[o.jsx("button",{onClick:g,className:"px-4 py-2 text-sm font-medium text-text-secondary hover:text-text-primary transition-colors",children:"Close"}),"export"===y&&o.jsx("button",{onClick:async()=>{if(!Q)return;const e=ne(),{steps:t,warnings:n}=S(e,H);G(n);const r=b({group:E,pattern:A,steps:t,activeSteps:Math.min(16,e.length)});F(!0),L(null);try{a().sendSysEx(r),L({success:!0,message:`Pattern sent to ${v(E,A)}`})}catch(s){L({success:!1,message:s instanceof Error?s.message:"Failed to send pattern"})}finally{F(!1)}},disabled:!Q||z||!re.valid,className:"px-4 py-2 text-sm font-medium bg-accent-primary text-text-inverse rounded hover:bg-accent-primary/90 transition-colors disabled:opacity-50 disabled:cursor-not-allowed flex items-center gap-2 shadow-glow-sm",children:z?o.jsxs(o.Fragment,{children:[o.jsx(h,{size:14,className:"animate-spin"}),"Sending..."]}):o.jsxs(o.Fragment,{children:[o.jsx(d,{size:14}),"Send to TD-3"]})}),"import"===y&&!_&&o.jsx("button",{onClick:()=>{if(!Q||!W)return;const t=function(t,n){const r=Math.max(0,Math.min(3,t)),s=Math.max(0,Math.min(15,n)),a=new Uint8Array(e.HEADER.length+4);return a.set(e.HEADER,0),a[e.HEADER.length]=e.CMD_REQUEST_PATTERN,a[e.HEADER.length+1]=r,a[e.HEADER.length+2]=s,a[e.HEADER.length+3]=e.FOOTER,a}(E,A);U(!0),B(null),L(null);try{a().sendSysEx(t),null!==J.current&&clearTimeout(J.current),J.current=window.setTimeout(()=>{J.current=null,U(!1),L({success:!1,message:"No response from TD-3. Make sure it is connected and in the correct mode."})},5e3)}catch(n){U(!1),L({success:!1,message:n instanceof Error?n.message:"Failed to send request"})}},disabled:!Q||!W||P,className:"px-4 py-2 text-sm font-medium bg-accent-primary text-text-inverse rounded hover:bg-accent-primary/90 transition-colors disabled:opacity-50 disabled:cursor-not-allowed flex items-center gap-2",children:P?o.jsxs(o.Fragment,{children:[o.jsx(h,{size:14,className:"animate-spin"}),"Requesting..."]}):o.jsxs(o.Fragment,{children:[o.jsx(u,{size:14}),"Request from TD-3"]})}),"import"===y&&_&&o.jsxs("button",{onClick:()=>{if(!_)return;const e=function(e,t=2){return e.map(e=>D(e,t))}(_.steps,H),t=Math.min(_.activeSteps,e.length);for(let n=0;n<t;n++){const t=e[n];Z(R,n,{note:t.note,flag1:t.flag1,flag2:t.flag2})}L({success:!0,message:`Imported ${t} steps into channel ${R+1}`}),B(null)},className:"px-4 py-2 text-sm font-medium bg-accent-success text-text-inverse rounded hover:bg-accent-success/90 transition-colors flex items-center gap-2 shadow-glow-sm",children:[o.jsx(m,{size:14}),"Insert into Pattern"]})]})]})]})}):null};export{M as TD3PatternDialog};
