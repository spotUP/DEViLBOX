import{j as e}from"./index-zx6LJBPK.js";import{r as t}from"./vendor-utils-XMmR-oGw.js";import"./vendor-react-DkDaD07v.js";import"./vendor-tone-CADp_hfL.js";import"./vendor-ui-uomqNFY-.js";const n=0,r=1,a=320,o=134;function s(e){const t=new Uint8Array(11),n=e.sample,r=e.metadata?.modPlayback;t[0]=r?.defaultVolume??64,t[1]=(r?.finetune??0)+8&15;const a=n?.loopStart??0,o=(n?.loopEnd??0)-(n?.loopStart??0);t[2]=255&a,t[3]=a>>8&255,t[4]=a>>16&255,t[5]=a>>24&255;const s=o>0?o:0;t[6]=255&s,t[7]=s>>8&255,t[8]=s>>16&255,t[9]=s>>24&255;const c=n?.loopType;return t[10]="forward"===c||"pingpong"===c?1:0,t}const c=({instrument:c,onChange:l})=>{const u=t.useRef(c),d=t.useRef(null),i=t.useRef(null),[m,p]=t.useState(!1),[f,_]=t.useState(null),h=t.useRef(l),y=t.useRef(!1),w=t.useRef(44100),v=t.useRef(null),E=t.useRef(null);t.useEffect(()=>{u.current=c},[c]),t.useEffect(()=>{h.current=l},[l]),t.useEffect(()=>{const e=d.current;if(!e||!m)return;const t=s(c),n=e._malloc(t.length);n&&(e.HEAPU8.set(t,n),e._pt2_sampled_load_config(n,t.length),e._free(n))},[c,m]);const P=(e,t)=>{const n=e.getBoundingClientRect(),r=e.width/n.width,a=e.height/n.height;return[Math.floor((t.clientX-n.left)*r),Math.floor((t.clientY-n.top)*a)+121]};return t.useEffect(()=>{if(!i.current)return;const e=i.current;let t=!1,c=null;const l=[];return async function(){try{const i=await new Promise((e,t)=>{const n=window.createPT2SampEd;if("function"==typeof n)return void e(n);const r=document.createElement("script");r.src="/pt2/PT2SampEd.js",r.onload=()=>{const n=window.createPT2SampEd;"function"==typeof n?e(n):t(new Error("createPT2SampEd not found after script load"))},r.onerror=()=>t(new Error("Failed to load PT2SampEd.js")),document.head.appendChild(r)});if(t)return;c=await i({}),d.current=c,c.onParamChange=(e,t)=>{const a=u.current,o={};switch(e){case n:o.metadata={...a.metadata,modPlayback:{...a.metadata?.modPlayback,usePeriodPlayback:a.metadata?.modPlayback?.usePeriodPlayback??!1,periodMultiplier:a.metadata?.modPlayback?.periodMultiplier??3546895,finetune:a.metadata?.modPlayback?.finetune??0,defaultVolume:t}};break;case r:o.metadata={...a.metadata,modPlayback:{...a.metadata?.modPlayback,usePeriodPlayback:a.metadata?.modPlayback?.usePeriodPlayback??!1,periodMultiplier:a.metadata?.modPlayback?.periodMultiplier??3546895,finetune:t>7?t-16:t,defaultVolume:a.metadata?.modPlayback?.defaultVolume??64}}}Object.keys(o).length>0&&(u.current={...a,...o},h.current(o))},c.onLoopChange=(e,t,n)=>{const r=u.current,a=e+t,o=0===n?"off":"forward",s={sample:{...r.sample,loopStart:e,loopEnd:a,loopType:o,loop:n>0}};u.current={...r,...s},h.current(s)},c.onPlaySample=(e,t,n,r,a)=>{v.current||(v.current=new AudioContext);const o=v.current;if(E.current){try{E.current.stop()}catch{}E.current=null}if(t<=0)return;const s=new Int8Array(c.HEAP8.buffer,e,t),l=w.current,u=o.createBuffer(1,t,l),d=u.getChannelData(0);for(let c=0;c<t;c++)d[c]=s[c]/128;const i=o.createBufferSource();i.buffer=u,0!==a&&r>2&&(i.loop=!0,i.loopStart=n/l,i.loopEnd=(n+r)/l),i.connect(o.destination),i.start(),E.current=i,i.onended=()=>{E.current===i&&(E.current=null)}},c.onStopSample=()=>{if(E.current){try{E.current.stop()}catch{}E.current=null}},c._pt2_sampled_init(a,255),c._pt2_sampled_start();const m=c,f=t=>{t.preventDefault(),e.focus();const[n,r]=P(e,t);m._pt2_sampled_on_mouse_down(n,r)},g=t=>{const[n,r]=P(e,t);m._pt2_sampled_on_mouse_up(n,r)},b=t=>{const[n,r]=P(e,t);m._pt2_sampled_on_mouse_move(n,r)},k=t=>{t.preventDefault();const[n,r]=P(e,t);m._pt2_sampled_on_wheel(Math.sign(t.deltaY),n,r)},x=e=>{e.preventDefault(),m._pt2_sampled_on_key_down(e.keyCode)},C=e=>{16!==e.keyCode&&17!==e.keyCode&&18!==e.keyCode||m._pt2_sampled_on_key_down(-e.keyCode)};e.addEventListener("mousedown",f),document.addEventListener("mouseup",g),document.addEventListener("mousemove",b),e.addEventListener("wheel",k,{passive:!1}),e.addEventListener("keydown",x),e.addEventListener("keyup",C),l.push(()=>e.removeEventListener("mousedown",f),()=>document.removeEventListener("mouseup",g),()=>document.removeEventListener("mousemove",b),()=>e.removeEventListener("wheel",k),()=>e.removeEventListener("keydown",x),()=>e.removeEventListener("keyup",C));const L=s(u.current),D=c._malloc(L.length);D&&(c.HEAPU8.set(L,D),c._pt2_sampled_load_config(D,L.length),c._free(D));const A=e.getContext("2d",{willReadFrequently:!0});if(!A)return void _("Canvas 2D context unavailable");const S=A.createImageData(a,o);let N=0;const R=()=>{t||(m._pt2_sampled_tick&&m._pt2_sampled_tick(),function(e,t,n){const r=e._pt2_sampled_get_fb()+154880,a=e.HEAPU8.subarray(r,r+171520),o=n.data;for(let s=0;s<42880;s++){const e=4*s;o[e]=a[e+2],o[e+1]=a[e+1],o[e+2]=a[e],o[e+3]=255}t.putImageData(n,0,0)}(m,A,S),N=requestAnimationFrame(R))};N=requestAnimationFrame(R),l.push(()=>cancelAnimationFrame(N)),t||p(!0);const j=await async function(e){const t=e.sample;if(!t)return null;let n=null;try{if(t.audioBuffer&&t.audioBuffer.byteLength>0){const e=new OfflineAudioContext(1,1,44100);n=await e.decodeAudioData(t.audioBuffer.slice(0))}else if(t.url){const e=await fetch(t.url),r=await e.arrayBuffer(),a=new OfflineAudioContext(1,1,44100);n=await a.decodeAudioData(r)}}catch{return null}if(!n)return null;const r=n.getChannelData(0),a=new Int8Array(r.length);for(let o=0;o<r.length;o++){let e=Math.round(127*r[o]);e>127&&(e=127),e<-128&&(e=-128),a[o]=e}return{pcm:a,sampleRate:n.sampleRate}}(u.current);if(j&&!t&&c){const{pcm:e,sampleRate:t}=j;w.current=t;const n=c._malloc(e.length);n&&(c.HEAP8.set(e,n),c._pt2_sampled_load_pcm(n,e.length),c._free(n),y.current=!0)}}catch(i){t||_(String(i))}}(),()=>{if(t=!0,l.forEach(e=>e()),E.current){try{E.current.stop()}catch{}E.current=null}if(v.current){try{v.current.close()}catch{}v.current=null}if(c)try{c._pt2_sampled_shutdown()}catch{}d.current=null,y.current=!1}},[]),e.jsxDEV("div",{className:"pt2-hardware-container flex flex-col items-center",children:[e.jsxDEV("canvas",{ref:i,width:a,height:o,tabIndex:0,style:{width:"100%",maxWidth:640,height:"auto",imageRendering:"pixelated",display:"block"}},void 0,!1,{fileName:"/Users/spot/Code/DEViLBOX/src/components/instruments/hardware/PT2Hardware.tsx",lineNumber:448,columnNumber:7},void 0),!m&&!f&&e.jsxDEV("div",{className:"text-gray-400 text-sm mt-2",children:"Loading PT2 sample editor..."},void 0,!1,{fileName:"/Users/spot/Code/DEViLBOX/src/components/instruments/hardware/PT2Hardware.tsx",lineNumber:462,columnNumber:9},void 0),f&&e.jsxDEV("div",{className:"text-red-400 text-sm mt-2 text-center",children:["Failed to load PT2 hardware UI: ",f]},void 0,!0,{fileName:"/Users/spot/Code/DEViLBOX/src/components/instruments/hardware/PT2Hardware.tsx",lineNumber:467,columnNumber:9},void 0)]},void 0,!0,{fileName:"/Users/spot/Code/DEViLBOX/src/components/instruments/hardware/PT2Hardware.tsx",lineNumber:447,columnNumber:5},void 0)};export{c as PT2Hardware};
