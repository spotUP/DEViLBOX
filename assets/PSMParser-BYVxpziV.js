function e(e,t){return e[t]??0}function t(e,t){return(e[t]??0)|(e[t+1]??0)<<8}function n(e,t){return((e[t]??0)|(e[t+1]??0)<<8|(e[t+2]??0)<<16|(e[t+3]??0)<<24)>>>0}function r(e,t,n){let r="";for(let a=0;a<n;a++){const n=e[t+a]??0;if(0===n)break;32===n&&0===r.length||(r+=n>=32&&n<128?String.fromCharCode(n):" ")}return r.trimEnd()}function a(e,t,n){let r="";for(let a=0;a<n;a++){const n=e[t+a]??0;if(0===n)break;r+=n>=32&&n<128?String.fromCharCode(n):" "}return r.trimEnd()}function f(e,t,n){if(t+n.length>e.length)return!1;for(let r=0;r<n.length;r++)if(e[t+r]!==n.charCodeAt(r))return!1;return!0}function s(t){if(t.length<12)return!1;if(f(t,0,"PSM ")&&f(t,8,"FILE"))return!0;if(f(t,0,"PSMþ")&&t.length>=146){if(26!==e(t,63))return!1;const n=e(t,65);return 16===n||1===n}return!1}function o(s,o){try{return s.length<4?null:f(s,0,"PSM ")?function(s,o){if(!f(s,0,"PSM ")||!f(s,8,"FILE"))return null;const c=function(t){const r=[];let a=12;for(;a+8<=t.length;){const f=String.fromCharCode(e(t,a),e(t,a+1),e(t,a+2),e(t,a+3)),s=n(t,a+4);r.push({id:f,start:a+8,size:s}),a+=8+s}return r}(s),p=c.find(e=>"SDFT"===e.id);if(!p||!f(s,p.start,"MAINSONG"))return null;const g=c.filter(e=>"SONG"===e.id);if(0===g.length)return null;let d=0;for(const t of g){if(t.start+11>s.length)continue;if(1!==e(s,t.start+9))return null;const n=e(s,t.start+10);d=Math.max(d,n)}if(0===d||d>64)return null;const y=c.find(e=>"TITL"===e.id);let k="";y&&(k=a(s,y.start,y.size));let b=!1,T=6,S=125;const M=[];let P=0;const C=Array(d).fill(128);for(const n of g){if(n.start+11>s.length)continue;const r=i(s,n.start+11,n.size-11);for(const n of r)if("OPLH"===n.id){if(n.size<9)continue;let r=n.start+2;const a=n.start+n.size;let f=0,o=65535;for(;r<a&&!(r>=s.length);){const n=e(s,r++);if(0===n)break;switch(n){case 1:{const{patIndex:e,isSinaria:t,consumed:n}=l(s,r,b);t&&(b=!0),r+=n;const a=255===e?65535:254===e?65534:e;a<65534&&M.push(a),65535===o&&(o=f);break}case 2:r+=4;break;case 3:{if(r+2>s.length)break;const e=t(s,r);r+=3,e>=o&&(P=e-o);break}case 4:{if(r+2>s.length)break;const e=t(s,r);r+=2,e>=o&&(P=e-o);break}case 5:{if(r+2>s.length)break;const[t,n]=[e(s,r),e(s,r+1)];r+=2,t<d&&(0===n?C[t]=C[t]:4===n&&(C[t]=128));break}case 6:r+=1;break;case 7:r<s.length&&(T=Math.max(1,e(s,r++)));break;case 8:r<s.length&&(S=Math.max(32,e(s,r++)));break;case 12:{if(r+6>s.length)return null;const t=[e(s,r),e(s,r+1),e(s,r+2),e(s,r+3),e(s,r+4),e(s,r+5)];if(0!==t[0]||255!==t[1]||0!==t[2]||0!==t[3]||1!==t[4]||0!==t[5])return null;r+=6;break}case 13:{if(r+3>s.length)break;const[t,n,a]=[e(s,r),e(s,r+1),e(s,r+2)];r+=3,t<d&&(0===a?C[t]=128^n:(2===a||4===a)&&(C[t]=128));break}case 14:if(r+2>s.length)break;r+=2;break;default:return null}f++}}else if("PPAN"===n.id){let t=n.start;for(let n=0;n<d&&!(t+2>s.length);n++){const[r,a]=[e(s,t),e(s,t+1)];t+=2,0===r?C[n]=128^a:(2===r||4===r)&&(C[n]=128)}}}if(0===M.length)return null;const I=new Map,x=c.filter(e=>"DSMP"===e.id);for(const e of x){if(e.start+96>s.length)continue;let n,a;b?(n=t(s,e.start+56)+1,a=r(s,e.start+17,33)):(n=t(s,e.start+52)+1,a=r(s,e.start+13,33)),n>0&&n<256&&I.set(n,a)}const A=I.size>0?Math.max(...I.keys()):0,$=[];for(let e=1;e<=Math.max(A,1);e++)$.push({id:e,name:I.get(e)||`Sample ${e}`,type:"sample",synthType:"Sampler",effects:[],volume:0,pan:0});const v=new Map,w=c.filter(e=>"PBOD"===e.id);for(const r of w){if(r.size<8)continue;let a=r.start;if(n(s,a)!==r.size)continue;a+=4;const{patIndex:f,consumed:i}=l(s,a,b);if(a+=i,a+2>s.length)continue;const c=t(s,a);a+=2;const p=Math.min(c,256);if(0===p)continue;const m=Array.from({length:p},()=>Array.from({length:d},()=>({note:0,instrument:0,volume:0,effTyp:0,eff:0,effTyp2:0,eff2:0})));for(let n=0;n<p&&!(a+2>s.length);n++){const r=t(s,a);if(a+=2,r<=2)continue;const f=a+(r-2);if(f>s.length)break;for(;a+2<=f;){const t=e(s,a),r=e(s,a+1);a+=2;const o=Math.min(r,d-1),i=m[n][o];if(128&t&&a<f&&(i.note=h(e(s,a++),b)),64&t&&a<f&&(i.instrument=e(s,a++)+1),32&t&&a<f){const t=e(s,a++);i.volume=Math.round((Math.min(t,127)+1)/2)}if(16&t&&a+2<=f){const t=e(s,a),n=e(s,a+1);a+=2;const{effTyp:r,eff:o,extra:l}=u(t,n,b);i.effTyp=r,i.eff=o,a+=l,a>f&&(a=f)}}a=f}const g=Array.from({length:d},(e,t)=>{const n=C[t]??128,r=Math.round((n-128)/128*100);return{id:`channel-${t}`,name:`Channel ${t+1}`,muted:!1,solo:!1,collapsed:!1,volume:100,pan:r,instrumentId:null,color:null,rows:m.map(e=>e[t])}});v.set(f,{id:`pattern-${f}`,name:`Pattern ${f}`,length:p,channels:g,importMetadata:{sourceFormat:b?"PSM (Sinaria)":"PSM",sourceFile:o,importedAt:(new Date).toISOString(),originalChannelCount:d,originalPatternCount:w.length,originalInstrumentCount:$.length}})}const z=Math.max(...M,0),F=[];for(let e=0;e<=z;e++){const t=v.get(e);t?F.push(t):F.push(m(e,64,d,o,w.length,$.length))}0===F.length&&F.push(m(0,64,d,o,0,$.length));0===$.length&&$.push({id:1,name:"Sample 1",type:"sample",synthType:"Sampler",effects:[],volume:0,pan:0});const O=o.replace(/\.[^/.]+$/,"");return{name:k.trim()||O,format:"S3M",patterns:F,instruments:$,songPositions:M,songLength:M.length,restartPosition:Math.min(P,M.length-1),numChannels:d,initialSpeed:T,initialBPM:S,linearPeriods:!1}}(s,o):f(s,0,"PSMþ")?function(s,o){if(s.length<146)return null;if(!f(s,0,"PSMþ"))return null;if(26!==e(s,63))return null;const i=e(s,65);if(16!==i&&1!==i)return null;const l=e(s,66);if(0!==l)return null;const c=e(s,64);if(3&c)return null;const u=a(s,4,59),h=e(s,67),g=e(s,68);e(s,69);const d=t(s,70),y=t(s,72),k=t(s,74),b=t(s,76),T=t(s,78),S=t(s,80),M=n(s,82),P=n(s,86),C=n(s,90),I=n(s,94);if(T>32||S>32)return null;const x=Math.max(T,S);if(0===x)return null;const A=[];if(M>4){const t=M-4;if(t+4+y<=s.length&&f(s,t,"PORD"))for(let n=0;n<y;n++)A.push(e(s,t+4+n))}if(0===A.length)for(let e=0;e<Math.min(d,256);e++)A.push(e);const $=Array(x).fill(128);if(P>4){const t=P-4;if(t+4<=s.length&&f(s,t,"PPAN"))for(let n=0;n<x&&!(t+4+n>=s.length);n++){const r=15&e(s,t+4+n);$[n]=Math.round((256*(15-r)+8)/15)}}const v=64,w=[];if(I>4){const e=I-4;if(e+4<=s.length&&f(s,e,"PSAH")){let n=e+4;for(let e=0;e<b&&!(n+v>s.length);e++){const e=r(s,n+13,24),a=t(s,n+41);if(n+=v,a>0&&a<256){for(;w.length<a;){const e=w.length+1;w.push({id:e,name:`Sample ${e}`,type:"sample",synthType:"Sampler",effects:[],volume:0,pan:0})}w[a-1]={id:a,name:e||`Sample ${a}`,type:"sample",synthType:"Sampler",effects:[],volume:0,pan:0}}}}}const z=4,F=[];if(C>4){const n=C-4;if(n+4<=s.length&&f(s,n,"PPAT")){let r=n+4;for(let n=0;n<k&&!(r+z>s.length);n++){const a=t(s,r),f=e(s,r+2);if(r+=z,a<z)continue;const i=r+((a+15&-16)-z);if(i>s.length)break;const l=Math.min(f,256),c=Array.from({length:l},()=>Array.from({length:x},()=>({note:0,instrument:0,volume:0,effTyp:0,eff:0,effTyp2:0,eff2:0})));let u=0,h=r;const m=31,g=128,d=64,y=32;for(;h<i&&u<l;){const t=e(s,h++);if(0===t){u++;continue}const n=Math.min(t&m,x-1),r=c[u][n];if(t&g){if(h+2>i)break;const t=e(s,h++),n=e(s,h++);r.note=Math.max(1,Math.min(120,t+36)),r.instrument=n}if(t&d){if(h>=i)break;const t=e(s,h++);r.volume=Math.min(64,t)}if(t&y){if(h+2>i)break;const t=e(s,h++),n=e(s,h++),{effTyp:a,eff:f}=p(t,n);r.effTyp=a,r.eff=f,40===t&&(h+=2)}}r=i;const b=Array.from({length:x},(e,t)=>{const n=$[t]??128,r=Math.round((n-128)/128*100);return{id:`channel-${t}`,name:`Channel ${t+1}`,muted:!1,solo:!1,collapsed:!1,volume:100,pan:r,instrumentId:null,color:null,rows:c.map(e=>e[t])}});F.push({id:`pattern-${n}`,name:`Pattern ${n}`,length:l,channels:b,importMetadata:{sourceFormat:"PSM16",sourceFile:o,importedAt:(new Date).toISOString(),originalChannelCount:x,originalPatternCount:k,originalInstrumentCount:w.length}})}}}0===F.length&&F.push(m(0,64,x,o,0,w.length));0===w.length&&w.push({id:1,name:"Sample 1",type:"sample",synthType:"Sampler",effects:[],volume:0,pan:0});const O=A.filter(e=>e<F.length),D=O.length>0?O:[0],L=o.replace(/\.[^/.]+$/,"");return{name:u.trim()||L,format:"S3M",patterns:F,instruments:w,songPositions:D,songLength:D.length,restartPosition:0,numChannels:x,initialSpeed:Math.max(1,h),initialBPM:Math.max(32,g),linearPeriods:!1}}(s,o):null}catch{return null}}function i(t,r,a){const f=[];let s=r;const o=r+a;for(;s+8<=o;){const r=String.fromCharCode(e(t,s),e(t,s+1),e(t,s+2),e(t,s+3)),a=n(t,s+4);f.push({id:r,start:s+8,size:a}),s+=8+a}return f}function l(t,n,r){if(n+4>t.length)return{patIndex:0,isSinaria:r,consumed:0};if("PATT"===String.fromCharCode(e(t,n),e(t,n+1),e(t,n+2),e(t,n+3))){if(n+8>t.length)return{patIndex:0,isSinaria:!0,consumed:8};let r="";for(let a=4;a<8;a++){const f=e(t,n+a);if(!(f>=48&&f<=57))break;r+=String.fromCharCode(f)}return{patIndex:r?parseInt(r,10):0,isSinaria:!0,consumed:8}}{let a="";for(let r=1;r<4;r++){const f=e(t,n+r);if(!(f>=48&&f<=57))break;a+=String.fromCharCode(f)}return{patIndex:a?parseInt(a,10):0,isSinaria:r,consumed:4}}}function c(e,t){return t?e:e<4?240|e:e>>2}function u(e,t,n,r,a){let f=0,s=0,o=0;switch(e){case 1:f=10,s=n?t<<4|15:(30&t)<<3|15;break;case 2:f=10,s=n?240&t<<4:240&t<<3;break;case 3:f=10,s=n?240|t:240|t>>1;break;case 4:f=10,s=n?15&t:t<2?240|t:t>>1&15;break;case 11:f=1,s=240|c(t,n);break;case 12:f=1,s=c(t,n);break;case 13:f=2,s=240|c(t,n);break;case 14:f=2,s=c(t,n);break;case 15:f=3,s=n?t:t>>2;break;case 16:f=5,s=240&t;break;case 17:f=19,s=16|1&t;break;case 18:f=5,s=t>>4&15;break;case 21:f=4,s=t;break;case 22:f=19,s=48|15&t;break;case 23:f=6,s=240|t;break;case 24:f=6,s=t;break;case 31:f=7,s=t;break;case 32:f=19,s=64|15&t;break;case 41:f=9,s=t,o=2;break;case 42:f=27,s=t;break;case 43:f=19,s=192|15&t;break;case 44:f=19,s=208|15&t;break;case 51:f=11,s=t/2,o=1;break;case 52:f=13,s=0;break;case 53:f=19,s=176|15&t;break;case 54:f=19,s=224|15&t;break;case 61:case 62:f=15,s=t;break;case 71:f=0,s=t;break;case 72:f=19,s=32|15&t;break;case 73:f=19,s=128|15&t;break;default:f=0,s=0}return{effTyp:f,eff:s,extra:o}}function h(e,t){if(t)return e<85?e+36:0;if(255===e)return 121;if(e>=129)return 0;const n=(15&e)+12*(e>>4)+13;return Math.max(1,Math.min(120,n))}function p(e,t,n,r){switch(e){case 1:return{effTyp:10,eff:t<<4|15};case 2:return{effTyp:10,eff:t<<4&240};case 3:return{effTyp:10,eff:240|t};case 4:return{effTyp:10,eff:15&t};case 10:return{effTyp:1,eff:240|t};case 11:return{effTyp:1,eff:t};case 12:return{effTyp:2,eff:240|t};case 13:return{effTyp:2,eff:t};case 14:return{effTyp:3,eff:t};case 15:return{effTyp:19,eff:16|15&t};case 16:return{effTyp:5,eff:t<<4};case 17:return{effTyp:5,eff:15&t};case 20:return{effTyp:4,eff:t};case 21:return{effTyp:19,eff:48|15&t};case 22:return{effTyp:6,eff:t<<4};case 23:return{effTyp:6,eff:15&t};case 30:return{effTyp:7,eff:t};case 31:return{effTyp:19,eff:64|15&t};case 40:return{effTyp:9,eff:t};case 41:return{effTyp:27,eff:15&t};case 42:return{effTyp:19,eff:192|15&t};case 43:return{effTyp:19,eff:208|15&t};case 50:return{effTyp:11,eff:t};case 51:return{effTyp:13,eff:t};case 52:return{effTyp:19,eff:176|15&t};case 53:return{effTyp:19,eff:224|15&t};case 60:case 61:return{effTyp:15,eff:t};case 70:return{effTyp:0,eff:t};case 71:return{effTyp:19,eff:32|15&t};case 72:return{effTyp:19,eff:128|15&t};default:return{effTyp:0,eff:0}}}function m(e,t,n,r,a,f){const s=()=>({note:0,instrument:0,volume:0,effTyp:0,eff:0,effTyp2:0,eff2:0}),o=Array.from({length:n},(e,n)=>({id:`channel-${n}`,name:`Channel ${n+1}`,muted:!1,solo:!1,collapsed:!1,volume:100,pan:0,instrumentId:null,color:null,rows:Array.from({length:t},s)}));return{id:`pattern-${e}`,name:`Pattern ${e}`,length:t,channels:o,importMetadata:{sourceFormat:"PSM",sourceFile:r,importedAt:(new Date).toISOString(),originalChannelCount:n,originalPatternCount:a,originalInstrumentCount:f}}}export{s as isPSMFormat,o as parsePSMFile};
