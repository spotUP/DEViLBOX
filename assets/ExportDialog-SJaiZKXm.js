import{x as e,F as t,a as n,u as r,b as s,c as a,d as o,e as i,f as c,j as l,g as d,h as m,n as p,i as u,k as h,l as x,N as f,m as g,o as b,p as y}from"./index-4yDwHK16.js";import{r as v}from"./vendor-utils-Cm-70yv0.js";import{ab as j,u as N,v as w,Y as k,X as S,Q as C,K as U,I as M,H as P,y as E,z as A,h as D,x as T}from"./vendor-tone-MhHxAwwC.js";import{X as O,D as L,a2 as $,aI as R,Z as I,b as F,V as B,ad as G,aJ as V}from"./vendor-ui-C64XGON6.js";import"./vendor-react-LeNVipsj.js";async function z(e,t,n,r={}){const{sampleRate:s=44100,onProgress:a}=r,o=60/n*.25,i=e.length*o+2;a?.(0);const c=await j(({transport:r})=>{r.bpm.value=n;const s=new Map,i=new Set;e.channels.forEach(e=>{null!==e.instrumentId&&i.add(e.instrumentId),e.rows.forEach(e=>{null!==e.instrument&&i.add(e.instrument)})}),t.forEach(e=>{if(!i.has(e.id))return;let t;switch(e.synthType){case"MonoSynth":t=new T({oscillator:{type:e.oscillator?.type||"sawtooth"},envelope:{attack:e.envelope?.attack??.01,decay:e.envelope?.decay??.2,sustain:e.envelope?.sustain??.5,release:e.envelope?.release??.5},filter:{type:e.filter?.type||"lowpass",frequency:e.filter?.frequency??2e3,Q:e.filter?.Q??1}}).toDestination();break;case"FMSynth":t=new N(D).toDestination();break;case"AMSynth":t=new N(A).toDestination();break;case"DuoSynth":t=(new E).toDestination();break;case"PluckSynth":t=(new P).toDestination();break;case"MetalSynth":t=(new M).toDestination();break;case"MembraneSynth":t=(new U).toDestination();break;case"NoiseSynth":t=(new C).toDestination();break;case"Sampler":if(!e.parameters?.sampleUrl)return;t=new S({urls:{C4:e.parameters.sampleUrl},volume:e.volume||-12}).toDestination();break;case"Player":if(!e.parameters?.sampleUrl)return;t=new k({url:e.parameters.sampleUrl,volume:e.volume||-12}).toDestination();break;default:t=new N(w,{oscillator:{type:e.oscillator?.type||"sawtooth"},envelope:{attack:e.envelope?.attack??.01,decay:e.envelope?.decay??.2,sustain:e.envelope?.sustain??.5,release:e.envelope?.release??.5}}).toDestination()}s.set(e.id,t)}),e.channels.forEach(t=>{const n=t.instrumentId??0;t.rows.forEach((a,i)=>{if(0===a.note)return;if(97===a.note)return;const c=i*o,l=a.instrument??n,d=s.get(l);if(!d)return;let m=o;for(let n=i+1;n<e.length;n++){const e=t.rows[n];if(e.note&&"..."!==e.note){m=(n-i)*o;break}}const p="==="===(u=a.note)||"..."===u?u:u.replace("-","");var u;const h=null!==a.volume?a.volume/64:.8;r.schedule(e=>{try{"triggerAttackRelease"in d&&d.triggerAttackRelease(p,m,e,h)}catch(t){}},c)})}),r.start(0),a?.(50)},i,2,s);return a?.(100),c.get()}function X(e){const t=e.numberOfChannels,n=e.sampleRate,r=2*t,s=e.length,a=s*r,o=44+a,i=new ArrayBuffer(o),c=new DataView(i);Y(c,0,"RIFF"),c.setUint32(4,o-8,!0),Y(c,8,"WAVE"),Y(c,12,"fmt "),c.setUint32(16,16,!0),c.setUint16(20,1,!0),c.setUint16(22,t,!0),c.setUint32(24,n,!0),c.setUint32(28,n*r,!0),c.setUint16(32,r,!0),c.setUint16(34,16,!0),Y(c,36,"data"),c.setUint32(40,a,!0);const l=[];for(let m=0;m<t;m++)l.push(e.getChannelData(m));let d=44;for(let m=0;m<s;m++)for(let e=0;e<t;e++){const t=Math.max(-1,Math.min(1,l[e][m])),n=t<0?32768*t:32767*t;c.setInt16(d,n,!0),d+=2}return new Blob([i],{type:"audio/wav"})}function Y(e,t,n){for(let r=0;r<n.length;r++)e.setUint8(t+r,n.charCodeAt(r))}async function H(e,t,n,r,s,a){if(0===t.length)throw new Error("No patterns in sequence to export");const o=[],i=t.length;for(let p=0;p<t.length;p++){const s=e[t[p]];if(!s)continue;const c=e=>{const t=p/i*100,n=e/100*(100/i);a?.(Math.round(t+n))},l=await z(s,n,r,{sampleRate:44100,onProgress:c});o.push(l)}if(0===o.length)throw new Error("No valid patterns to export");const c=function(e,t){if(0===e.length)throw new Error("No buffers to concatenate");if(1===e.length)return e[0];const n=e[0].numberOfChannels,r=e.reduce((e,t)=>e+t.length,0),s=new OfflineAudioContext(n,r,t).createBuffer(n,r,t);let a=0;for(const o of e){for(let e=0;e<n;e++){const t=s.getChannelData(e),n=o.getChannelData(e);t.set(n,a)}a+=o.length}return s}(o,44100),l=X(c),d=URL.createObjectURL(l),m=document.createElement("a");m.href=d,m.download=s.endsWith(".wav")?s:`${s}.wav`,document.body.appendChild(m),m.click(),document.body.removeChild(m),URL.revokeObjectURL(d),a?.(100)}const W={type:1,includeAutomation:!0,velocityScale:1,exportMutedChannels:!1},K={cutoff:74,resonance:71,volume:7,pan:10,envMod:78,decay:75,overdrive:76,distortion:76,delay:91,reverb:91},q=3,Q=47,Z=81,J=88;function _(e,t,n,r={}){const s={...W,...r},a=function(e,t){const n=[];if(0===t.type){const r={name:e.name||"Pattern",events:[]};e.channels.forEach((e,n)=>{if(!t.exportMutedChannels&&e.muted)return;const s=te(e,n%16,0,t);r.events.push(...s)}),r.events.sort((e,t)=>e.tick-t.tick),n.push(r)}else n.push({name:"Tempo",events:[]}),e.channels.forEach((e,r)=>{if(!t.exportMutedChannels&&e.muted)return;const s=r%16,a={name:e.name||`Channel ${r+1}`,events:te(e,s,0,t)};n.push(a)});return n}(e,s);return oe(a[0],t,n),ie(a,s.type)}function ee(e,t,n,r,s,a={}){const o={...W,...a},i=t.map(t=>e.find(e=>e.id===t)).filter(e=>void 0!==e);if(0===i.length)throw new Error("No patterns found in sequence");let c=0;const l=new Map;for(const m of i)l.set(m.id,c),c+=se(m.length);const d=function(e,t,n){const r=[],s=Math.max(...e.map(e=>e.channels.length));if(0===n.type){const s={name:"Song",events:[]};e.forEach(e=>{const r=t.get(e.id)||0;e.channels.forEach((e,t)=>{if(!n.exportMutedChannels&&e.muted)return;const a=te(e,t%16,r,n);s.events.push(...a)})}),s.events.sort((e,t)=>e.tick-t.tick),r.push(s)}else{r.push({name:"Tempo",events:[]});for(let a=0;a<s;a++){const s={name:`Channel ${a+1}`,events:[]},o=a%16;e.forEach(e=>{const r=t.get(e.id)||0,i=e.channels[a];if(!i)return;if(!n.exportMutedChannels&&i.muted)return;i.name&&s.name===`Channel ${a+1}`&&(s.name=i.name);const c=te(i,o,r,n);s.events.push(...c)}),s.events.length>0&&r.push(s)}}return r}(i,l,o);return o.includeAutomation&&s.length>0&&function(e,t,n,r){for(const s of t){if(!s.enabled)continue;const t=K[s.parameter];if(!t)continue;const a=n.find(e=>e.id===s.patternId);if(!a)continue;const o=r.get(s.patternId)||0,i=s.channelIndex%16;let c;e.length>1&&(c=e.find(e=>e.name.includes(`Channel ${s.channelIndex+1}`)||e.name===a.channels[s.channelIndex]?.name)),c||(c=e[0]);for(const e of s.points){const n=o+re(e.row),r=Math.round(127*e.value);c.events.push({tick:n,type:"cc",channel:i,data:[t,r]})}c.events.sort((e,t)=>e.tick-t.tick)}}(d,s,i,l),oe(d[0],n,r),ie(d,o.type)}function te(t,n,r,s){const a=[],o=t.rows.length;for(let i=0;i<o;i++){const c=t.rows[i];if(!c.note||0===c.note)continue;if(97===c.note)continue;const l=e(c.note);if(null===l)continue;const d=r+re(i),m=ae(c.volume,s.velocityScale),p=ne(t.rows,i,o),u=Math.max(1,re(p));a.push({tick:d,type:"noteOn",channel:n,data:[l,m]}),a.push({tick:d+u,type:"noteOff",channel:n,data:[l,0]})}return a}function ne(e,t,n){for(let r=t+1;r<n;r++){const n=e[r];if(97===n.note)return r-t;if(n.note&&0!==n.note&&97!==n.note)return r-t}return n-t}function re(e){return 120*e}function se(e){return 120*e}function ae(e,t){const n=e??64,r=Math.round(n/64*127*t);return Math.max(1,Math.min(127,r))}function oe(e,t,n){const r=Math.round(6e7/t);e.events.unshift({tick:0,type:"meta",channel:0,data:[Z,3,r>>16&255,r>>8&255,255&r]});const[s,a]=n,o=Math.log2(a);e.events.unshift({tick:0,type:"meta",channel:0,data:[J,4,s,o,24,8]})}function ie(e,t){const n=[];n.push(function(e,t,n){const r=new Uint8Array(14),s=new DataView(r.buffer);return r[0]=77,r[1]=84,r[2]=104,r[3]=100,s.setUint32(4,6,!1),s.setUint16(8,e,!1),s.setUint16(10,t,!1),s.setUint16(12,n,!1),r}(t,e.length,480));for(const r of e)n.push(ce(r));return me(n)}function ce(e){const t=[],n=(new TextEncoder).encode(e.name);t.push(de(0)),t.push(new Uint8Array([255,q,n.length])),t.push(n);const r=[...e.events].sort((e,t)=>e.tick-t.tick);let s=0;for(const c of r){const e=c.tick-s;t.push(de(e)),t.push(le(c)),s=c.tick}t.push(de(0)),t.push(new Uint8Array([255,Q,0]));const a=me(t),o=new Uint8Array(8+a.length),i=new DataView(o.buffer);return o[0]=77,o[1]=84,o[2]=114,o[3]=107,i.setUint32(4,a.length,!1),o.set(a,8),o}function le(e){switch(e.type){case"noteOn":return new Uint8Array([144|e.channel,e.data[0],e.data[1]]);case"noteOff":return new Uint8Array([128|e.channel,e.data[0],e.data[1]]);case"cc":return new Uint8Array([176|e.channel,e.data[0],e.data[1]]);case"meta":return new Uint8Array([255,...e.data]);default:return new Uint8Array([])}}function de(e){if(0===e)return new Uint8Array([0]);const t=[];let n=e;for(t.push(127&n),n>>=7;n>0;)t.push(127&n|128),n>>=7;return new Uint8Array(t.reverse())}function me(e){const t=e.reduce((e,t)=>e+t.length,0),n=new Uint8Array(t);let r=0;for(const s of e)n.set(s,r),r+=s.length;return n}async function pe(e,t,n={}){const r=[],s=n.channelLimit||32,a=n.downmixExtra??!1,o=n.bakeSynthsToSamples??!0,i=n.stripInstrumentEffects??!0,c=n.defaultSpeed||6,l=n.defaultBPM||125,d=n.moduleName||"DEViLBOX Export",m=n.trackerName||"DEViLBOX v1.0",p=e[0]?.importMetadata,u=Math.max(...e.map(e=>e.channels.length));u>s&&r.push(`Pattern has ${u} channels. XM supports max ${s}. Extra channels will be ${a?"downmixed":"truncated"}.`);const h=Math.min(u,s),x=[];for(const g of t){if("Sampler"!==g.synthType&&o)r.push(`Synth instrument "${g.name}" will be rendered as sample.`),x.push(fe(g.name));else if("Sampler"===g.synthType){const e=await he(g,p);x.push(e)}else r.push(`Instrument "${g.name}" skipped (synth without sample).`),x.push(fe(g.name));g.effects&&g.effects.length>0&&i&&r.push(`Instrument "${g.name}" has ${g.effects.length} effects that will be lost.`)}const f=function(e){const t=[];t.push(function(e){const t=new Uint8Array(336),n=new DataView(t.buffer);let r=0;const s="Extended Module: ";for(let a=0;a<17;a++)t[r++]=s.charCodeAt(a);ye(t,r,e.moduleName,20),r+=20,t[r++]=26,ye(t,r,e.trackerName,20),r+=20,n.setUint16(r,260,!0),r+=2,n.setUint32(r,276,!0),r+=4,n.setUint16(r,e.songLength,!0),r+=2,n.setUint16(r,e.restartPosition,!0),r+=2,n.setUint16(r,e.channelCount,!0),r+=2,n.setUint16(r,e.patterns.length,!0),r+=2,n.setUint16(r,e.instruments.length,!0),r+=2,n.setUint16(r,e.linearFrequency?1:0,!0),r+=2,n.setUint16(r,e.defaultSpeed,!0),r+=2,n.setUint16(r,e.defaultBPM,!0),r+=2;for(let a=0;a<256;a++)t[r++]=a<e.songLength?a:0;return t}(e));for(const a of e.patterns)t.push(ge(a,e.channelCount));for(const a of e.instruments)t.push(be(a));const n=t.reduce((e,t)=>e+t.length,0),r=new Uint8Array(n);let s=0;for(const a of t)r.set(a,s),s+=a.length;return r.buffer}({moduleName:d,trackerName:m,patterns:e.map((e,t)=>function(e,t){const n=[];for(let r=0;r<e.length;r++){const s=[];for(let n=0;n<t;n++){const t=e.channels[n]?.rows[r];if(!t){s.push({note:0,instrument:0,volume:0,effectType:0,effectParam:0});continue}const a=ue(t);s.push(a)}n.push(s)}return{rows:n}}(e,h)),instruments:x,channelCount:h,defaultSpeed:c,defaultBPM:l,songLength:e.length,restartPosition:p?.modData?.restartPosition||0,linearFrequency:!p?.modData?.amigaPeriods});return{data:new Blob([f],{type:"application/octet-stream"}),warnings:r,filename:`${d.replace(/[^a-zA-Z0-9]/g,"_")}.xm`}}function ue(e,t){let n=0;const r=e.note;r&&("number"==typeof r?n=r:"==="===r?n=97:"---"!==r&&(n=function(e){const t=["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"],n=e.match(/^([A-G]#?)-?(\d)$/);if(!n)return 0;const r=t.indexOf(n[1]),s=parseInt(n[2]);return-1===r||s<0||s>7?0:12*s+r+1}(r)));const s=e.instrument||0;let a=0;null!==e.volume?a=16+Math.min(e.volume,64):(void 0!==e.effTyp2&&0!==e.effTyp2||void 0!==e.eff2&&0!==e.eff2)&&(a=function(e,t){if(10===e){const e=t>>4&15,n=15&t;if(e>0)return 112+e;if(n>0)return 96+n}if(14===e){const e=t>>4&15,n=15&t;if(10===e)return 144+n;if(11===e)return 128+n}if(4===e){return 176+(15&t)}if(3===e){const e=Math.floor(t/16);return 240+Math.min(e,15)}return 0}(e.effTyp2??0,e.eff2??0));let o=0,i=0;if(e.effect&&"..."!==e.effect){const t=function(e){if(3!==e.length)return{type:0,param:0};const t=e[0].toUpperCase(),n=parseInt(e.substring(1),16),r="0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ".indexOf(t);return{type:-1===r?0:r,param:isNaN(n)?0:n}}(e.effect);o=t.type,i=t.param}return{note:n,instrument:s,volume:a,effectType:o,effectParam:i}}async function he(e,t){const n=t?.originalSamples?.[e.id];return n?{name:e.name.substring(0,22),samples:[{name:n.name.substring(0,22),pcmData:n.pcmData,loopStart:n.loopStart*(16===n.bitDepth?2:1),loopLength:n.loopLength*(16===n.bitDepth?2:1),volume:n.volume,finetune:n.finetune,type:xe(n.loopType,n.bitDepth),panning:n.panning,relativeNote:n.relativeNote}],volumeEnvelope:t?.envelopes?.[e.id]?.volumeEnvelope,panningEnvelope:t?.envelopes?.[e.id]?.panningEnvelope,vibratoType:"sine"===t?.envelopes?.[e.id]?.autoVibrato?.type?0:1,vibratoSweep:t?.envelopes?.[e.id]?.autoVibrato?.sweep||0,vibratoDepth:t?.envelopes?.[e.id]?.autoVibrato?.depth||0,vibratoRate:t?.envelopes?.[e.id]?.autoVibrato?.rate||0,volumeFadeout:t?.envelopes?.[e.id]?.fadeout||0}:fe(e.name)}function xe(e,t){let n=0;return"forward"===e&&(n|=1),"pingpong"===e&&(n|=2),16===t&&(n|=16),n}function fe(e){return{name:e.substring(0,22),samples:[],vibratoType:0,vibratoSweep:0,vibratoDepth:0,vibratoRate:0,volumeFadeout:0}}function ge(e,t){const n=function(e,t){const n=[];for(const r of e)for(let e=0;e<t;e++){const t=r[e]||{note:0,instrument:0,volume:0,effectType:0,effectParam:0};if(0===t.note&&0===t.instrument&&0===t.volume&&0===t.effectType&&0===t.effectParam){n.push(128);continue}let s=128;const a=[];t.note>0&&(s|=1,a.push(t.note)),t.instrument>0&&(s|=2,a.push(t.instrument)),t.volume>0&&(s|=4,a.push(t.volume)),t.effectType>0&&(s|=8,a.push(t.effectType)),t.effectParam>0&&(s|=16,a.push(t.effectParam)),n.push(s),n.push(...a)}return new Uint8Array(n)}(e.rows,t),r=new Uint8Array(9),s=new DataView(r.buffer);s.setUint32(0,9,!0),r[4]=0,s.setUint16(5,e.rows.length,!0),s.setUint16(7,n.length,!0);const a=new Uint8Array(r.length+n.length);return a.set(r,0),a.set(n,r.length),a}function be(e){const t=e.samples.length>0?263:29,n=new Uint8Array(t),r=new DataView(n.buffer);return r.setUint32(0,t,!0),ye(n,4,e.name,22),n[26]=0,r.setUint16(27,e.samples.length,!0),e.samples.length,n}function ye(e,t,n,r){for(let s=0;s<r;s++)e[t+s]=s<n.length?n.charCodeAt(s):0}const ve={4:"M.K.",6:"6CHN",8:"8CHN"};async function je(e,t,n={}){const r=[],s=n.channelCount||4,a=n.moduleName||"DEViLBOX Export",o=n.bakeSynthsToSamples??!0;if(![4,6,8].includes(s))throw new Error(`MOD supports 4, 6, or 8 channels (got ${s})`);const i=ve[s];if(!i)throw new Error(`No format tag for ${s} channels`);const c=Math.max(...e.map(e=>e.channels.length));c>s&&r.push(`Patterns have ${c} channels but exporting as ${s}-channel MOD. Extra channels will be truncated.`);const l=e[0]?.importMetadata,d=[];for(let f=0;f<Math.min(t.length,31);f++){const e=t[f];if(e){if("Sampler"!==e.synthType&&o)r.push(`Synth instrument "${e.name}" will be rendered as sample.`),d.push(Se());else if("Sampler"===e.synthType){const t=await ke(e,l);d.push(t)}else d.push(Se());e.effects&&e.effects.length>0&&r.push(`Instrument "${e.name}" has effects that will be lost (MOD doesn't support effect chains).`)}else d.push(Se())}for(;d.length<31;)d.push(Se());const m=e.map((e,t)=>function(e,t,n,r){const s=[];for(let a=0;a<64;a++){const n=[];for(let s=0;s<t;s++){const t=e.channels[s]?.rows[a];if(!t||a>=e.length){n.push({period:0,instrument:0,effect:0,effectParam:0});continue}const o=we(t,r);n.push(o)}s.push(n)}e.length>64&&r.push(`Pattern ${n} has ${e.length} rows but MOD supports max 64. Extra rows truncated.`);return{rows:s}}(e,s,t,r)),p=Array.from({length:128},(t,n)=>n<e.length?n:0),u=function(e){const t=1084,n=1024*e.patterns.length,r=e.samples.reduce((e,t)=>e+t.pcmData.length,0),s=new Uint8Array(t+n+r);let a=0;Me(s,a,e.title,20),a+=20;for(const o of e.samples)Ce(s,a,o),a+=30;s[a++]=Math.min(e.songLength,128),s[a++]=127;for(let o=0;o<128;o++)s[a++]=e.patternOrderTable[o];Me(s,a,e.formatTag,4),a+=4;for(const o of e.patterns)Ue(s,a,o),a+=1024;for(const o of e.samples)o.pcmData.length>0&&(s.set(new Uint8Array(o.pcmData.buffer),a),a+=o.pcmData.length);return s.buffer}({title:a,samples:d,patterns:m,songLength:e.length,formatTag:i,patternOrderTable:p}),h=new Blob([u],{type:"application/octet-stream"}),x=`${a.replace(/[^a-zA-Z0-9]/g,"_")}.mod`;return{data:h,warnings:r,filename:x}}const Ne={"C-0":1712,"C#0":1616,"D-0":1525,"D#0":1440,"E-0":1357,"F-0":1281,"F#0":1209,"G-0":1141,"G#0":1077,"A-0":1017,"A#0":961,"B-0":907,"C-1":856,"C#1":808,"D-1":762,"D#1":720,"E-1":678,"F-1":640,"F#1":604,"G-1":570,"G#1":538,"A-1":508,"A#1":480,"B-1":453,"C-2":428,"C#2":404,"D-2":381,"D#2":360,"E-2":339,"F-2":320,"F#2":302,"G-2":285,"G#2":269,"A-2":254,"A#2":240,"B-2":226,"C-3":214,"C#3":202,"D-3":190,"D#3":180,"E-3":170,"F-3":160,"F#3":151,"G-3":143,"G#3":135,"A-3":127,"A#3":120,"B-3":113};function we(e,t){let n=0;const r=e.note;if(97===r||"string"==typeof r&&"==="===r)return{period:0,instrument:0,effect:12,effectParam:0};let s=null;if("number"==typeof r&&r>0&&r<97){const e=["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"],t=(r-1)%12,n=Math.floor((r-1)/12);s=`${e[t]}-${n}`}else"string"==typeof r&&r&&"---"!==r&&(s=r);s&&(n=function(e){const t=e.replace("-","-");return Ne[t]||0}(s),0===n&&t.push(`Note ${s} is out of range for MOD format (C-0 to B-3 supported).`));const a=e.instrument||0;let o=0,i=0;if(e.effect&&"..."!==e.effect){const n=function(e){if(3!==e.length)return{effect:0,param:0};const t=e[0].toUpperCase(),n=parseInt(e.substring(1),16),r="0123456789ABCDEF".indexOf(t);return{effect:-1===r?0:r,param:isNaN(n)?0:n}}(e.effect);o=n.effect,i=n.param,o>15&&(t.push(`Effect ${e.effect} is not supported in MOD format (only 0-F).`),o=0,i=0)}return(void 0!==e.effTyp2&&0!==e.effTyp2||void 0!==e.eff2&&0!==e.eff2)&&t.push("Effect2 column not supported in MOD format (will be lost)."),null!==e.volume&&(0===o&&0===i?(o=12,i=Math.min(e.volume,64)):t.push("Volume column not supported in MOD (use Cxx effect).")),{period:n,instrument:a,effect:o,effectParam:i}}async function ke(e,t){const n=t?.originalSamples?.[e.id];return n&&8===n.bitDepth?{name:n.name.substring(0,22),length:Math.floor(n.length/2),finetune:n.finetune+8&15,volume:n.volume,loopStart:Math.floor(n.loopStart/2),loopLength:"none"===n.loopType?1:Math.floor(n.loopLength/2),pcmData:new Int8Array(n.pcmData)}:Se(e.name)}function Se(e=""){return{name:e.substring(0,22),length:0,finetune:0,volume:64,loopStart:0,loopLength:1,pcmData:new Int8Array(0)}}function Ce(e,t,n){const r=new DataView(e.buffer);Me(e,t,n.name,22),t+=22,r.setUint16(t,n.length,!1),t+=2,e[t++]=15&n.finetune,e[t++]=Math.min(n.volume,64),r.setUint16(t,n.loopStart,!1),t+=2,r.setUint16(t,Math.max(n.loopLength,1),!1)}function Ue(e,t,n){for(const r of n.rows)for(const n of r){const r=n.period>>8&15,s=255&n.period,a=n.instrument>>4&15,o=15&n.instrument;e[t++]=r<<4|a,e[t++]=s,e[t++]=o<<4|15&n.effect,e[t++]=255&n.effectParam}}function Me(e,t,n,r){for(let s=0;s<r;s++)e[t+s]=s<n.length?n.charCodeAt(s):0}const Pe=82,Ee=83,Ae=84,De=81,Te=94,Oe=95,Le=80,$e=160,Re=179,Ie=180,Fe=185,Be=210,Ge=98,Ve=99,ze=97,Xe=112,Ye=102,He=0,We=4,Ke=8,qe=12,Qe=16,Ze=20,Je=24,_e=28,et=32,tt=36,nt=44,rt=48,st=52,at=92,ot=116,it=128,ct=132,lt=148,dt=156,mt={[t.OPN2]:7670453,[t.OPM]:3579545,[t.PSG]:3579545,[t.OPLL]:3579545,[t.OPL3]:14318180,[t.AY]:1789773,[t.GB]:4194304,[t.NES]:1789773,[t.PCE]:3579545,[t.SCC]:3579545,[t.SID]:1e6};function pt(e){const t=[],n=new DataView(e.buffer,e.byteOffset,e.byteLength);for(let r=0;r+12<=e.length;r+=12){const e=n.getUint32(r,!0),s=n.getUint8(r+4),a=65535&n.getUint32(r+5,!0),o=n.getUint8(r+9);t.push({timestamp:e,chipType:s,port:a,data:o})}return t}function ut(e,n){switch(e){case t.OPN2:return n<256?{cmd:Pe,adjustedPort:n}:{cmd:Ee,adjustedPort:n-256};case t.OPM:return{cmd:Ae,adjustedPort:n};case t.OPLL:return{cmd:De,adjustedPort:n};case t.OPL3:return n<256?{cmd:Te,adjustedPort:n}:{cmd:Oe,adjustedPort:n-256};case t.PSG:return{cmd:Le,adjustedPort:0};case t.AY:return{cmd:$e,adjustedPort:n};case t.GB:return{cmd:Re,adjustedPort:n};case t.NES:return{cmd:Ie,adjustedPort:n};case t.PCE:return{cmd:Fe,adjustedPort:n};case t.SCC:return{cmd:Be,adjustedPort:n};default:return null}}function ht(e,n={}){n.sampleRate;const r=[],s=new Set;for(const t of e)s.add(t.chipType);const a=[...e].sort((e,t)=>e.timestamp-t.timestamp);let o=0,i=0;for(const x of a){const e=x.timestamp-o;if(e>0){i+=e;let t=e;for(;t>0;)if(t>=882&&t<1470)r.push(Ve),t-=882;else if(t>=735)r.push(Ge),t-=735;else if(t>=16){const e=Math.min(t,65535);r.push(ze,255&e,e>>8&255),t-=e}else r.push(Xe+(t-1)),t=0}o=x.timestamp;const n=ut(x.chipType,x.port);n&&(x.chipType===t.PSG?r.push(n.cmd,x.data):r.push(n.cmd,255&n.adjustedPort,x.data))}r.push(Ye);const c=function(e){const t=[e.title||"DEViLBOX Export","",e.game||"","",e.system||"Furnace Chips","",e.author||"","",e.releaseDate||(new Date).toISOString().slice(0,10),"DEViLBOX Tracker",""],n=[];for(const a of t){for(let e=0;e<a.length;e++){const t=a.charCodeAt(e);n.push(255&t,t>>8&255)}n.push(0,0)}const r=new Uint8Array(12+n.length),s=new DataView(r.buffer);return s.setUint32(0,540238919,!0),s.setUint32(4,256,!0),s.setUint32(8,n.length,!0),r.set(n,12),r}(n),l=256,d=l+r.length-20,m=l+r.length+c.length-4,p=l+r.length+c.length,u=new Uint8Array(p),h=new DataView(u.buffer);if(h.setUint32(He,544040790,!0),h.setUint32(We,m,!0),h.setUint32(Ke,369,!0),h.setUint32(Ze,d,!0),h.setUint32(Je,i,!0),h.setUint32(tt,60,!0),h.setUint32(st,204,!0),s.has(t.OPN2)&&h.setUint32(nt,mt[t.OPN2],!0),s.has(t.OPM)&&h.setUint32(rt,mt[t.OPM],!0),s.has(t.PSG)&&h.setUint32(qe,mt[t.PSG],!0),s.has(t.OPLL)&&h.setUint32(Qe,mt[t.OPLL],!0),s.has(t.OPL3)&&h.setUint32(at,mt[t.OPL3],!0),s.has(t.AY)&&h.setUint32(ot,mt[t.AY],!0),s.has(t.GB)&&h.setUint32(it,mt[t.GB],!0),s.has(t.NES)&&h.setUint32(ct,mt[t.NES],!0),s.has(t.PCE)&&h.setUint32(lt,mt[t.PCE],!0),s.has(t.SCC)&&h.setUint32(dt,mt[t.SCC],!0),void 0!==n.loopPoint&&n.loopPoint>0){let e=0,t=0;for(let s=0;s<r.length;s++){if(t>=n.loopPoint){e=s;break}const a=r[s];a===Ge?t+=735:a===Ve?t+=882:a===ze?(t+=r[s+1]|r[s+2]<<8,s+=2):a>=Xe&&a<=127&&(t+=a-Xe+1)}e>0&&(h.setUint32(_e,l+e-28,!0),h.setUint32(et,i-n.loopPoint,!0))}return u.set(r,l),u.set(c,l+r.length),u}function xt(e){return 63&e}function ft(e,n={}){const r=n.tickRate||60,s=44100/r,a=[];let o=!1,i=!1;const c=[...e].sort((e,t)=>e.timestamp-t.timestamp).filter(e=>e.chipType===t.OPM||e.chipType===t.VERA);c.length;let l=0,d=0;for(const x of c){const e=Math.floor(x.timestamp/s),r=e-l;if(r>0){n.loopPoint&&l<n.loopPoint&&e>=n.loopPoint&&(d=a.length);let t=r;for(;t>0;)t<=128?(a.push(128|t-1),t=0):(a.push(255),t-=128);l=e}if(x.chipType===t.OPM){o=!0;const e=255&x.port;e<128?(a.push(64|e>>1),a.push((1&e)<<7|127&x.data)):(a.push(127),a.push(e),a.push(x.data))}else if(x.chipType===t.VERA){i=!0;const e=xt(x.port);a.push(e),a.push(x.data)}}a.push(128,0);const m=a.length,p=function(e,t,n,r,s){const a=new Uint8Array(16),o=new DataView(a.buffer);return a[0]=122,a[1]=109,a[2]=1,o.setUint16(3,e,!0),a[5]=255&t,a[6]=t>>8&255,a[7]=t>>16&255,a[8]=255&n,a[9]=n>>8&255,a[10]=n>>16&255,a[11]=r?255:0,o.setUint16(12,s?65535:0,!0),a[14]=n>0?1:0,a[15]=0,a}(r,d,n.pcmData?16+m:0,o,i),u=16+m+(n.pcmData?.length||0),h=new Uint8Array(u);return h.set(p,0),h.set(a,16),n.pcmData&&h.set(n.pcmData,16+m),h}function gt(e,t){const n=["SAP"];return n.push(`AUTHOR "${e.author||"DEViLBOX"}"`),n.push(`NAME "${e.name||"Untitled"}"`),n.push(`DATE "${e.date||(new Date).getFullYear()}"`),n.push("TYPE R"),e.ntsc&&n.push("NTSC"),e.stereo&&n.push("STEREO"),e.fastplay&&n.push(`FASTPLAY ${e.fastplay}`),e.songs&&e.songs>1&&(n.push(`SONGS ${e.songs}`),e.defaultSong&&n.push(`DEFSONG ${e.defaultSong}`)),n.push(`TIME ${function(e,t){const n=e/t,r=Math.floor(n/60),s=Math.floor(n%60),a=Math.floor(n%1*1e3);return`${String(r).padStart(2,"0")}:${String(s).padStart(2,"0")}.${String(a).padStart(3,"0")}`}(t,e.ntsc?60:50)}`),n.push(""),n.join("\r\n")}function bt(e,n){const r=44100/(n.ntsc?60:50),s=e.filter(e=>e.chipType===t.TIA),a=function(e,t){const n=new Map;for(const r of e){const e=Math.floor(r.timestamp/t);n.has(e)||n.set(e,[]),n.get(e).push(r)}return n}(s.length>0?s:e,r),o=Math.max(...a.keys(),0)+1,i=n.stereo?18:9,c=new Uint8Array(o*i),l=new Uint8Array(n.stereo?18:9);for(let t=0;t<o;t++){const e=a.get(t)||[],r=t*i;for(const t of e){const e=15&t.port;e<=8&&(l[e]=t.data,n.stereo&&t.port>=16&&(l[9+e]=t.data))}c.set(l,r)}return{data:c,frameCount:o}}function yt(e,n={}){const r=[...e].sort((e,t)=>e.timestamp-t.timestamp),{data:s,frameCount:a}=function(e,n){const r=44100/(n.ntsc?60:50),s=e.filter(e=>e.chipType===t.TIA);if(0===s.length)return{data:new Uint8Array(0),frameCount:0};const a=new Map;for(const t of s){const e=Math.floor(t.timestamp/r);a.has(e)||a.set(e,[]),a.get(e).push(t)}const o=Math.max(...a.keys(),0)+1,i=new Uint8Array(6*o),c=new Uint8Array(6);for(let t=0;t<o;t++){const e=a.get(t)||[],n=6*t;for(const t of e){let e=t.port;e>=21&&(e-=21),e>=0&&e<6&&(c[e]=t.data)}i.set(c,n)}return{data:i,frameCount:o}}(r,n);if(0===a)throw new Error("No TIA data to export");const o=function(e,t,n){const r=new Uint8Array(16),s=new DataView(r.buffer);return r[0]=84,r[1]=73,r[2]=117,r[3]=65,r[4]=1,r[5]=0,s.setUint16(6,t,!0),s.setUint16(8,n>=0?n:65535,!0),r[10]=e.ntsc?1:0,r}(n,a,n.loopFrame??-1),i=o.length+s.length,c=new Uint8Array(i);return c.set(o,0),c.set(s,o.length),c}const vt=0,jt=1,Nt=2,wt=3;const kt=[78,69,83,77,26];function St(e,n={}){const r={initCode:[169,0,133,0,169,0,133,1,169,1,133,2,169,15,141,21,64,169,64,141,23,64,96],playCode:[165,2,240,42,160,0,177,0,240,29,201,255,240,32,170,200,177,0,157,0,64,24,165,0,105,2,133,0,144,227,230,1,76,4,128,230,0,208,2,230,1,96,169,0,133,2,141,21,64,96],baseAddress:32768},s=function(e){const n=[],r=e.filter(e=>e.chipType===t.NES);if(0===r.length)return n.push(255),n;const s=[...r].sort((e,t)=>e.timestamp-t.timestamp);let a=0;for(const t of s){const e=Math.floor(t.timestamp/735);for(;a<e;)n.push(0),a++;const r=31&t.port;r>23||n.push(r,t.data)}return n.push(0),n.push(255),n}(e),a=n.loadAddress||32768,o=n.initAddress||a,i=r.initCode.length,c=n.playAddress||a+i,l=a+(i+r.playCode.length),d=[...r.initCode];d[1]=255&l,d[5]=l>>8&255;const m=[...r.playCode],p=m.indexOf(76);if(-1!==p){const e=a+i+4;m[p+1]=255&e,m[p+2]=e>>8&255}const u=new Uint8Array(d.length+m.length+s.length);u.set(d,0),u.set(m,d.length),u.set(s,d.length+m.length);const h=function(e,t,n,r){const s=new Uint8Array(128),a=new DataView(s.buffer);s.set(kt,0),s[5]=1,s[6]=e.totalSongs||1,s[7]=e.startingSong||1,a.setUint16(8,t,!0),a.setUint16(10,n,!0),a.setUint16(12,r,!0);const o=e.title||"DEViLBOX Export";for(let d=0;d<Math.min(o.length,31);d++)s[14+d]=o.charCodeAt(d);const i=e.artist||"";for(let d=0;d<Math.min(i.length,31);d++)s[46+d]=i.charCodeAt(d);const c=e.copyright||(new Date).getFullYear().toString();for(let d=0;d<Math.min(c.length,31);d++)s[78+d]=c.charCodeAt(d);a.setUint16(110,e.ntscSpeed||16666,!0),a.setUint16(120,e.palSpeed||2e4,!0);const l=e.region||"ntsc";return s[122]="ntsc"===l?0:"pal"===l?1:2,s[123]=0,s}(n,a,o,c,u.length),x=new Uint8Array(h.length+u.length);return x.set(h,0),x.set(u,h.length),x}const Ct=[71,66,83];function Ut(e,n={}){const r={initCode:[62,0,224,128,62,0,224,129,62,1,224,130,62,128,224,38,62,255,224,37,62,119,224,36,201],playCode:[240,130,183,200,240,128,111,240,129,103,126,183,40,20,254,255,40,26,79,35,126,35,229,38,255,105,119,225,24,232,35,125,224,128,124,224,129,201,175,224,130,224,38,201],baseAddress:16384},s=function(e){const n=[],r=e.filter(e=>e.chipType===t.GB);if(0===r.length)return n.push(255),n;const s=[...r].sort((e,t)=>e.timestamp-t.timestamp);let a=0;for(const t of s){const e=Math.floor(t.timestamp/735);for(;a<e;)n.push(0),a++;const r=255&t.port;r<16||r>63||n.push(r,t.data)}return n.push(0),n.push(255),n}(e),a=n.loadAddress||16384,o=n.initAddress||a,i=r.initCode.length,c=n.playAddress||a+i,l=a+(i+r.playCode.length),d=[...r.initCode];d[1]=255&l,d[5]=l>>8&255;const m=new Uint8Array(d.length+r.playCode.length+s.length);m.set(d,0),m.set(r.playCode,d.length),m.set(s,d.length+r.playCode.length);const p=function(e,t,n,r,s){const a=new Uint8Array(112),o=new DataView(a.buffer);a.set(Ct,0),a[3]=1,a[4]=e.totalSongs||1,a[5]=e.startingSong||1,o.setUint16(6,t,!0),o.setUint16(8,n,!0),o.setUint16(10,r,!0),o.setUint16(12,s,!0),a[14]=e.timerModulo||0,a[15]=e.timerControl||0;const i=e.title||"DEViLBOX Export";for(let d=0;d<Math.min(i.length,31);d++)a[16+d]=i.charCodeAt(d);const c=e.author||"";for(let d=0;d<Math.min(c.length,31);d++)a[48+d]=c.charCodeAt(d);const l=e.copyright||(new Date).getFullYear().toString();for(let d=0;d<Math.min(l.length,31);d++)a[80+d]=l.charCodeAt(d);return a}(n,a,o,c,65534),u=new Uint8Array(p.length+m.length);return u.set(p,0),u.set(m,p.length),u}const Mt=65536,Pt=12,Et=28,At=108,Dt=32e3/60;function Tt(e,n={}){const r={code:[186,0,0,218,0,143,0,250,143,48,241,228,253,143,128,250,143,1,241,228,253,240,252,141,0,247,0,240,18,104,255,240,22,196,242,252,247,0,196,243,252,47,237,252,96,132,0,196,0,228,1,136,0,196,1,47,210,47,254],entryPoint:512},s=function(e){const n=[],r=e.filter(e=>e.chipType===t.SNES);if(0===r.length)return n.push(255),n;const s=[...r].sort((e,t)=>e.timestamp-t.timestamp);let a=0;for(const t of s){const e=Math.floor(t.timestamp/Dt);for(;a<e;)n.push(0),a++;const r=127&t.port;n.push(r,t.data)}return n.push(0),n.push(255),n}(e),a=r.entryPoint,o=a+r.code.length,i=[...r.code];i[1]=255&o,i[2]=o>>8&255;const c=new Uint8Array(Mt);c.set(i,a),c.set(s,o);const l=new Uint8Array(128);l[At]=224,l[Pt]=127,l[Et]=127;const d=new Uint8Array(65984),m=new DataView(d.buffer),p="SNES-SPC700 Sound File Data v0.30";for(let t=0;t<p.length;t++)d[t]=p.charCodeAt(t);d[33]=26,d[34]=26,d[35]=26,d[36]=30,m.setUint16(37,r.entryPoint,!0),d[39]=0,d[40]=0,d[41]=0,d[42]=0,d[43]=239;const u=function(e){const t=new Uint8Array(210),n=e.title||"DEViLBOX Export";for(let d=0;d<Math.min(n.length,32);d++)t[d]=n.charCodeAt(d);const r=e.game||"";for(let d=0;d<Math.min(r.length,32);d++)t[32+d]=r.charCodeAt(d);const s=e.dumper||"DEViLBOX";for(let d=0;d<Math.min(s.length,16);d++)t[64+d]=s.charCodeAt(d);const a=e.comments||"";for(let d=0;d<Math.min(a.length,32);d++)t[80+d]=a.charCodeAt(d);const o=e.dumpDate||(new Date).toLocaleDateString("en-US");for(let d=0;d<Math.min(o.length,11);d++)t[112+d]=o.charCodeAt(d);const i=(e.songLength||180).toString();for(let d=0;d<Math.min(i.length,3);d++)t[123+d]=i.charCodeAt(d);const c=(e.fadeLength||1e4).toString();for(let d=0;d<Math.min(c.length,5);d++)t[126+d]=c.charCodeAt(d);const l=e.artist||"";for(let d=0;d<Math.min(l.length,32);d++)t[131+d]=l.charCodeAt(d);return t}(n);return d.set(u,46),d.set(c,256),d.set(l,65792),d}const Ot={[t.OPN2]:"YM2612 (Genesis)",[t.OPM]:"YM2151 (Arcade)",[t.OPL3]:"YMF262 (OPL3)",[t.PSG]:"SN76489 (PSG)",[t.NES]:"NES APU",[t.GB]:"Game Boy DMG",[t.PCE]:"HuC6280 (PCE)",[t.SCC]:"K051649 (SCC)",[t.AY]:"AY-3-8910",[t.OPLL]:"YM2413 (OPLL)",[t.SID]:"SID",[t.TIA]:"TIA (Atari 2600)",[t.VERA]:"VERA (X16)",[t.SNES]:"SPC700 (SNES)"},Lt={vgm:{name:"Video Game Music",extension:"vgm",mimeType:"application/octet-stream",description:"Universal format supporting 40+ chips. Compatible with VGMPlay, foobar2000, and most retro players.",supportedChips:[t.OPN2,t.OPM,t.OPL3,t.PSG,t.AY,t.GB,t.NES,t.PCE,t.SCC,t.OPLL]},zsm:{name:"ZSound Music (Commander X16)",extension:"zsm",mimeType:"application/octet-stream",description:"Native format for Commander X16. Supports YM2151 + VERA PSG/PCM.",supportedChips:[t.OPM,t.VERA]},sap:{name:"Slight Atari Player",extension:"sap",mimeType:"application/octet-stream",description:"Atari 8-bit music format for POKEY chip.",supportedChips:[t.TIA]},tiuna:{name:"TIunA (Atari 2600)",extension:"tia",mimeType:"application/octet-stream",description:"Simple format for Atari 2600 TIA chip.",supportedChips:[t.TIA]},gym:{name:"Genesis YM2612 Music",extension:"gym",mimeType:"application/octet-stream",description:"Sega Genesis/Mega Drive format. Supports YM2612 (FM) + SN76489 (PSG).",supportedChips:[t.OPN2,t.PSG]},nsf:{name:"NES Sound Format",extension:"nsf",mimeType:"application/octet-stream",description:"Nintendo Entertainment System music format with embedded 6502 driver.",supportedChips:[t.NES]},gbs:{name:"Game Boy Sound",extension:"gbs",mimeType:"application/octet-stream",description:"Nintendo Game Boy music format with embedded Z80 driver.",supportedChips:[t.GB]},spc:{name:"SNES SPC700",extension:"spc",mimeType:"application/octet-stream",description:"Super Nintendo music format with SPC700 driver and 64KB RAM dump.",supportedChips:[t.SNES]}};function $t(e){const n=[],r=Lt.vgm.supportedChips;return e.some(e=>r.includes(e.chipType))&&n.push("vgm"),function(e){return e.some(e=>e.chipType===t.OPM||e.chipType===t.VERA)}(e)&&n.push("zsm"),function(e){return e.some(e=>e.chipType===t.TIA||e.port>=53760&&e.port<=53791)}(e)&&n.push("sap"),function(e){return e.some(e=>e.chipType===t.TIA)}(e)&&n.push("tiuna"),function(e){const n=[t.OPN2,t.PSG];return e.some(e=>n.includes(e.chipType))}(e)&&n.push("gym"),function(e){return e.some(e=>e.chipType===t.NES)}(e)&&n.push("nsf"),function(e){return e.some(e=>e.chipType===t.GB)}(e)&&n.push("gbs"),function(e){return e.some(e=>e.chipType===t.SNES)}(e)&&n.push("spc"),n}function Rt(e){const t=new Map;for(const s of e)t.set(s.chipType,(t.get(s.chipType)||0)+1);const n=Array.from(t.entries()).map(([e,t])=>({type:e,name:Ot[e]||`Unknown (${e})`,writes:t})).sort((e,t)=>t.writes-e.writes),r=e.reduce((e,t)=>Math.max(e,t.timestamp),0)/44100;return{totalWrites:e.length,duration:r,usedChips:n,frameRate:60}}async function It(e,n){const r=pt(e);if(0===r.length)throw new Error("No register writes found in log data");const s=Lt[n.format];let a;switch(n.format){case"vgm":a=ht(r,{title:n.title,author:n.author,loopPoint:n.loopPoint,...n.vgm});break;case"zsm":a=ft(r,{loopPoint:n.loopPoint,...n.zsm});break;case"sap":a=function(e,t={}){const n=[...e].sort((e,t)=>e.timestamp-t.timestamp),{data:r,frameCount:s}=bt(n,t),a=gt(t,s),o=(new TextEncoder).encode(a),i=o.length+2+r.length,c=new Uint8Array(i);return c.set(o,0),c[o.length]=255,c[o.length+1]=255,c.set(r,o.length+2),c}(r,{name:n.title,author:n.author,...n.sap});break;case"tiuna":a=yt(r,{title:n.title,author:n.author,loopFrame:n.loopPoint,...n.tiuna});break;case"gym":a=function(e){const n=[],r=e.filter(e=>e.chipType===t.OPN2||e.chipType===t.PSG);if(0===r.length)return new Uint8Array(0);const s=[...r].sort((e,t)=>e.timestamp-t.timestamp);let a=0;for(const o of s){const e=o.timestamp-a,r=Math.round(e/735);if(r>0){let e=r;for(;e>0;)if(1===e)n.push(wt),e=0;else{const t=Math.min(e,252);n.push(wt+t),e-=t}}a=o.timestamp,o.chipType===t.OPN2?o.port<256?n.push(vt,255&o.port,o.data):n.push(jt,o.port-256&255,o.data):o.chipType===t.PSG&&n.push(Nt,o.data)}return new Uint8Array(n)}(r,{title:n.title,author:n.author,...n.gym});break;case"nsf":a=St(r,{title:n.title,artist:n.author,...n.nsf});break;case"gbs":a=Ut(r,{title:n.title,author:n.author,...n.gbs});break;case"spc":a=Tt(r,{title:n.title,artist:n.author,...n.spc});break;default:throw new Error(`Unsupported export format: ${n.format}`)}const o=`${n.title||"export"}.${s.extension}`;return{data:new Blob([a.buffer],{type:s.mimeType}),filename:o,mimeType:s.mimeType,format:n.format}}class Ft{isRecording=!1;engine;constructor(){this.engine=n.getInstance()}startRecording(){this.isRecording||(this.engine.setLogging(!0),this.isRecording=!0)}async stopRecording(){if(!this.isRecording)return new Uint8Array(0);this.engine.setLogging(!1),this.isRecording=!1;return await this.engine.getLog()}getIsRecording(){return this.isRecording}async recordAndExport(e,t){this.startRecording(),await new Promise(t=>setTimeout(t,e));return It(await this.stopRecording(),t)}}const Bt=({isOpen:e,onClose:t})=>{const{patterns:n,currentPatternIndex:j,importPattern:N,setCurrentPattern:w,loadPatterns:k}=r(),{instruments:S,currentInstrumentId:C,addInstrument:U,setCurrentInstrument:M,loadInstruments:P}=s(),{metadata:E,setMetadata:A}=a(),{bpm:D,setBPM:T,isPlaying:Y,stop:W}=o(),{curves:K,loadCurves:q}=i(),{masterEffects:Q,setMasterEffects:Z}=c(),[J,te]=v.useState("export"),[ne,re]=v.useState("song"),[se,ae]=v.useState({includeAutomation:!0,compress:!1,prettify:!0}),[oe,ie]=v.useState("MySound"),[ce,le]=v.useState(j),[de,me]=v.useState(C||0),[ue,he]=v.useState(!1),[xe,fe]=v.useState(0),[ge,be]=v.useState(!1),[ye,ve]=v.useState(1),[Ne,we]=v.useState(!0),[ke,Se]=v.useState(!1),[Ce,Ue]=v.useState(4),[Me,Pe]=v.useState(8),[Ee,Ae]=v.useState(!0),[De,Te]=v.useState([]),[Oe,Le]=v.useState("vgm"),[$e]=v.useState(()=>new Ft),[Re,Ie]=v.useState(!1),[Fe,Be]=v.useState(0),[Ge,Ve]=v.useState(null),[ze,Xe]=v.useState([]),[Ye,He]=v.useState([]),[We,Ke]=v.useState(""),[qe,Qe]=v.useState(""),[Ze,Je]=v.useState(0),{loopStartRow:_e,currentRow:et,setLoopStartRow:tt}=o();v.useEffect(()=>{_e>0&&Je(_e)},[_e]);const nt=v.useRef(null),rt=v.useRef(null);if(v.useEffect(()=>{if(!e)return;const n=e=>{"Escape"===e.key&&(e.preventDefault(),t())};return window.addEventListener("keydown",n),()=>window.removeEventListener("keydown",n)},[e,t]),v.useEffect(()=>{Te([])},[ne]),v.useEffect(()=>()=>{rt.current&&clearInterval(rt.current)},[]),!e)return null;return l.jsx("div",{className:"fixed inset-0 z-50 flex items-center justify-center bg-black/60",children:l.jsxs("div",{className:"bg-dark-bg border border-dark-border rounded-xl shadow-2xl w-full max-w-2xl max-h-[90vh] overflow-hidden flex flex-col animate-fade-in",children:[l.jsxs("div",{className:"bg-dark-bgTertiary border-b border-dark-border px-5 py-4 flex items-center justify-between",children:[l.jsx("h2",{className:"font-mono text-lg font-bold text-text-primary",children:"Export / Import"}),l.jsx("button",{onClick:t,className:"btn-icon",children:l.jsx(O,{size:20})})]}),l.jsxs("div",{className:"bg-dark-bgSecondary border-b border-dark-border flex",children:[l.jsxs("button",{onClick:()=>te("export"),className:`\n              flex-1 px-4 py-3 font-mono text-sm transition-all border-r border-dark-border flex items-center justify-center gap-2\n              ${"export"===J?"bg-accent-primary text-text-inverse font-bold":"text-text-secondary hover:bg-dark-bgHover"}\n            `,children:[l.jsx(L,{size:16}),"Export"]}),l.jsxs("button",{onClick:()=>te("import"),className:`\n              flex-1 px-4 py-3 font-mono text-sm transition-all flex items-center justify-center gap-2\n              ${"import"===J?"bg-accent-primary text-text-inverse font-bold":"text-text-secondary hover:bg-dark-bgHover"}\n            `,children:[l.jsx($,{size:16}),"Import"]})]}),l.jsx("div",{className:"flex-1 overflow-y-auto scrollbar-modern p-5",children:"export"===J?l.jsxs(l.Fragment,{children:[l.jsxs("div",{className:"mb-5",children:[l.jsx("label",{className:"block text-xs font-mono text-text-muted mb-3",children:"EXPORT MODE"}),l.jsxs("div",{className:"grid grid-cols-4 gap-3",children:[l.jsxs("button",{onClick:()=>re("song"),className:`\n                      p-4 rounded-lg border-2 transition-all text-center\n                      ${"song"===ne?"bg-accent-primary text-text-inverse border-accent-primary glow-sm":"bg-dark-bgSecondary text-text-primary border-dark-border hover:border-dark-borderLight"}\n                    `,children:[l.jsx(R,{size:24,className:"mx-auto mb-2"}),l.jsx("div",{className:"font-mono text-sm font-semibold",children:"Song"})]}),l.jsxs("button",{onClick:()=>re("sfx"),className:`\n                      p-4 rounded-lg border-2 transition-all text-center\n                      ${"sfx"===ne?"bg-accent-primary text-text-inverse border-accent-primary glow-sm":"bg-dark-bgSecondary text-text-primary border-dark-border hover:border-dark-borderLight"}\n                    `,children:[l.jsx(I,{size:24,className:"mx-auto mb-2"}),l.jsx("div",{className:"font-mono text-sm font-semibold",children:"SFX"})]}),l.jsxs("button",{onClick:()=>re("instrument"),className:`\n                      p-4 rounded-lg border-2 transition-all text-center\n                      ${"instrument"===ne?"bg-accent-primary text-text-inverse border-accent-primary glow-sm":"bg-dark-bgSecondary text-text-primary border-dark-border hover:border-dark-borderLight"}\n                    `,children:[l.jsx(F,{size:24,className:"mx-auto mb-2"}),l.jsx("div",{className:"font-mono text-sm font-semibold",children:"Instrument"})]}),l.jsxs("button",{onClick:()=>re("audio"),className:`\n                      p-4 rounded-lg border-2 transition-all text-center\n                      ${"audio"===ne?"bg-accent-primary text-text-inverse border-accent-primary glow-sm":"bg-dark-bgSecondary text-text-primary border-dark-border hover:border-dark-borderLight"}\n                    `,children:[l.jsx(B,{size:24,className:"mx-auto mb-2"}),l.jsx("div",{className:"font-mono text-sm font-semibold",children:"Audio"})]}),l.jsxs("button",{onClick:()=>re("midi"),className:`\n                      p-4 rounded-lg border-2 transition-all text-center\n                      ${"midi"===ne?"bg-accent-primary text-text-inverse border-accent-primary glow-sm":"bg-dark-bgSecondary text-text-primary border-dark-border hover:border-dark-borderLight"}\n                    `,children:[l.jsx(G,{size:24,className:"mx-auto mb-2"}),l.jsx("div",{className:"font-mono text-sm font-semibold",children:"MIDI"})]}),l.jsxs("button",{onClick:()=>re("xm"),className:`\n                      p-4 rounded-lg border-2 transition-all text-center\n                      ${"xm"===ne?"bg-accent-primary text-text-inverse border-accent-primary glow-sm":"bg-dark-bgSecondary text-text-primary border-dark-border hover:border-dark-borderLight"}\n                    `,children:[l.jsx(R,{size:24,className:"mx-auto mb-2"}),l.jsx("div",{className:"font-mono text-sm font-semibold",children:"XM"})]}),l.jsxs("button",{onClick:()=>re("mod"),className:`\n                      p-4 rounded-lg border-2 transition-all text-center\n                      ${"mod"===ne?"bg-accent-primary text-text-inverse border-accent-primary glow-sm":"bg-dark-bgSecondary text-text-primary border-dark-border hover:border-dark-borderLight"}\n                    `,children:[l.jsx(R,{size:24,className:"mx-auto mb-2"}),l.jsx("div",{className:"font-mono text-sm font-semibold",children:"MOD"})]}),l.jsxs("button",{onClick:()=>re("chip"),className:`\n                      p-4 rounded-lg border-2 transition-all text-center\n                      ${"chip"===ne?"bg-accent-primary text-text-inverse border-accent-primary glow-sm":"bg-dark-bgSecondary text-text-primary border-dark-border hover:border-dark-borderLight"}\n                    `,children:[l.jsx(V,{size:24,className:"mx-auto mb-2"}),l.jsx("div",{className:"font-mono text-sm font-semibold",children:"Chip"})]}),l.jsxs("button",{onClick:()=>re("nano"),className:`\n                      p-4 rounded-lg border-2 transition-all text-center\n                      ${"nano"===ne?"bg-accent-primary text-text-inverse border-accent-primary glow-sm":"bg-dark-bgSecondary text-text-primary border-dark-border hover:border-dark-borderLight"}\n                    `,children:[l.jsx(I,{size:24,className:"mx-auto mb-2"}),l.jsx("div",{className:"font-mono text-sm font-semibold",children:"Nano"})]})]})]}),"song"===ne&&l.jsxs("div",{className:"bg-dark-bgSecondary border border-dark-border rounded-lg p-4 mb-4",children:[l.jsx("h3",{className:"text-sm font-mono font-bold text-accent-primary mb-3",children:"Song Export"}),l.jsxs("div",{className:"space-y-2 text-sm font-mono text-text-primary",children:[l.jsxs("div",{children:["Project: ",l.jsx("span",{className:"text-accent-primary",children:E.name})]}),l.jsxs("div",{children:["Patterns: ",l.jsx("span",{className:"text-accent-primary",children:n.length})]}),l.jsxs("div",{children:["Instruments: ",l.jsx("span",{className:"text-accent-primary",children:S.length})]}),l.jsxs("div",{children:["BPM: ",l.jsx("span",{className:"text-accent-primary",children:D})]})]})]}),"sfx"===ne&&l.jsxs("div",{className:"bg-dark-bgSecondary border border-dark-border rounded-lg p-4 mb-4",children:[l.jsx("h3",{className:"text-sm font-mono font-bold text-accent-primary mb-3",children:"SFX Export"}),l.jsxs("div",{className:"space-y-3",children:[l.jsxs("div",{children:[l.jsx("label",{className:"block text-xs font-mono text-text-muted mb-1",children:"SFX Name"}),l.jsx("input",{type:"text",value:oe,onChange:e=>ie(e.target.value),className:"input w-full"})]}),l.jsxs("div",{children:[l.jsx("label",{className:"block text-xs font-mono text-text-muted mb-1",children:"Pattern"}),l.jsx("select",{value:ce,onChange:e=>le(Number(e.target.value)),className:"input w-full",children:n.map((e,t)=>l.jsxs("option",{value:t,children:[t.toString().padStart(2,"0")," - ",e.name]},e.id))})]}),l.jsxs("div",{children:[l.jsx("label",{className:"block text-xs font-mono text-text-muted mb-1",children:"Instrument"}),l.jsx("select",{value:de,onChange:e=>me(Number(e.target.value)),className:"input w-full",children:S.map(e=>l.jsxs("option",{value:e.id,children:[e.id.toString(16).toUpperCase().padStart(2,"0")," - ",e.name]},e.id))})]})]})]}),"instrument"===ne&&l.jsxs("div",{className:"bg-dark-bgSecondary border border-dark-border rounded-lg p-4 mb-4",children:[l.jsx("h3",{className:"text-sm font-mono font-bold text-accent-primary mb-3",children:"Instrument Export"}),l.jsxs("div",{children:[l.jsx("label",{className:"block text-xs font-mono text-text-muted mb-1",children:"Select Instrument"}),l.jsx("select",{value:de,onChange:e=>me(Number(e.target.value)),className:"input w-full",children:S.map(e=>l.jsxs("option",{value:e.id,children:[e.id.toString(16).toUpperCase().padStart(2,"0")," - ",e.name]},e.id))})]})]}),"audio"===ne&&l.jsxs("div",{className:"bg-dark-bgSecondary border border-dark-border rounded-lg p-4 mb-4",children:[l.jsx("h3",{className:"text-sm font-mono font-bold text-accent-primary mb-3",children:"Audio Export (WAV)"}),l.jsxs("div",{className:"space-y-3",children:[l.jsxs("div",{className:"flex gap-2",children:[l.jsx("button",{onClick:()=>be(!1),disabled:ue,className:`\n                          flex-1 px-3 py-2 rounded-lg text-sm font-mono transition-all\n                          ${ge?"bg-dark-bg text-text-secondary hover:bg-dark-bgHover border border-dark-border":"bg-accent-primary text-text-inverse"}\n                        `,children:"Single Pattern"}),l.jsxs("button",{onClick:()=>be(!0),disabled:ue,className:`\n                          flex-1 px-3 py-2 rounded-lg text-sm font-mono transition-all\n                          ${ge?"bg-accent-primary text-text-inverse":"bg-dark-bg text-text-secondary hover:bg-dark-bgHover border border-dark-border"}\n                        `,children:["Full Song (",n.length," patterns)"]})]}),!ge&&l.jsxs("div",{children:[l.jsx("label",{className:"block text-xs font-mono text-text-muted mb-1",children:"Pattern to Render"}),l.jsx("select",{value:ce,onChange:e=>le(Number(e.target.value)),className:"input w-full",disabled:ue,children:n.map((e,t)=>l.jsxs("option",{value:t,children:[t.toString().padStart(2,"0")," - ",e.name]},e.id))})]}),l.jsxs("div",{className:"text-sm font-mono text-text-secondary space-y-1",children:[l.jsxs("div",{children:["Format: ",l.jsx("span",{className:"text-accent-primary",children:"WAV (16-bit, 44.1kHz)"})]}),l.jsxs("div",{children:["BPM: ",l.jsx("span",{className:"text-accent-primary",children:D})]}),ge?l.jsxs(l.Fragment,{children:[l.jsxs("div",{children:["Patterns: ",l.jsx("span",{className:"text-accent-primary",children:n.length})]}),l.jsxs("div",{children:["Total Rows: ",l.jsx("span",{className:"text-accent-primary",children:n.reduce((e,t)=>e+t.length,0)})]})]}):l.jsxs("div",{children:["Length: ",l.jsxs("span",{className:"text-accent-primary",children:[n[ce]?.length||64," rows"]})]})]}),ue&&l.jsxs("div",{className:"mt-3",children:[l.jsxs("div",{className:"text-xs font-mono text-text-muted mb-1",children:["Rendering",ge?" song":"","... ",xe,"%"]}),l.jsx("div",{className:"w-full bg-dark-border rounded-full h-2",children:l.jsx("div",{className:"bg-accent-primary h-2 rounded-full transition-all duration-200",style:{width:`${xe}%`}})})]})]})]}),"midi"===ne&&l.jsxs("div",{className:"bg-dark-bgSecondary border border-dark-border rounded-lg p-4 mb-4",children:[l.jsx("h3",{className:"text-sm font-mono font-bold text-accent-primary mb-3",children:"MIDI Export (.mid)"}),l.jsxs("div",{className:"space-y-3",children:[l.jsxs("div",{className:"flex gap-2",children:[l.jsx("button",{onClick:()=>Se(!1),className:`\n                          flex-1 px-3 py-2 rounded-lg text-sm font-mono transition-all\n                          ${ke?"bg-dark-bg text-text-secondary hover:bg-dark-bgHover border border-dark-border":"bg-accent-primary text-text-inverse"}\n                        `,children:"Single Pattern"}),l.jsxs("button",{onClick:()=>Se(!0),className:`\n                          flex-1 px-3 py-2 rounded-lg text-sm font-mono transition-all\n                          ${ke?"bg-accent-primary text-text-inverse":"bg-dark-bg text-text-secondary hover:bg-dark-bgHover border border-dark-border"}\n                        `,children:["Full Song (",n.length," patterns)"]})]}),!ke&&l.jsxs("div",{children:[l.jsx("label",{className:"block text-xs font-mono text-text-muted mb-1",children:"Pattern to Export"}),l.jsx("select",{value:ce,onChange:e=>le(Number(e.target.value)),className:"input w-full",children:n.map((e,t)=>l.jsxs("option",{value:t,children:[t.toString().padStart(2,"0")," - ",e.name]},e.id))})]}),l.jsxs("div",{children:[l.jsx("label",{className:"block text-xs font-mono text-text-muted mb-1",children:"MIDI Format"}),l.jsxs("div",{className:"flex gap-2",children:[l.jsx("button",{onClick:()=>ve(0),className:`\n                            flex-1 px-3 py-2 rounded-lg text-xs font-mono transition-all\n                            ${0===ye?"bg-accent-secondary text-text-inverse":"bg-dark-bg text-text-secondary hover:bg-dark-bgHover border border-dark-border"}\n                          `,children:"Type 0 (Single Track)"}),l.jsx("button",{onClick:()=>ve(1),className:`\n                            flex-1 px-3 py-2 rounded-lg text-xs font-mono transition-all\n                            ${1===ye?"bg-accent-secondary text-text-inverse":"bg-dark-bg text-text-secondary hover:bg-dark-bgHover border border-dark-border"}\n                          `,children:"Type 1 (Multi-Track)"})]})]}),l.jsxs("label",{className:"flex items-center gap-3 text-sm font-mono text-text-primary cursor-pointer hover:text-accent-primary transition-colors",children:[l.jsx("input",{type:"checkbox",checked:Ne,onChange:e=>we(e.target.checked),className:"w-4 h-4 rounded border-dark-border bg-dark-bg text-accent-primary focus:ring-accent-primary"}),"Include automation as CC messages"]}),l.jsxs("div",{className:"text-sm font-mono text-text-secondary space-y-1",children:[l.jsxs("div",{children:["Format: ",l.jsx("span",{className:"text-accent-primary",children:"Standard MIDI File (SMF)"})]}),l.jsxs("div",{children:["Resolution: ",l.jsx("span",{className:"text-accent-primary",children:"480 PPQ"})]}),l.jsxs("div",{children:["BPM: ",l.jsx("span",{className:"text-accent-primary",children:D})]}),l.jsxs("div",{children:["Channels: ",l.jsx("span",{className:"text-accent-primary",children:n[ce]?.channels.length||8})]})]})]})]}),"xm"===ne&&l.jsxs("div",{className:"bg-dark-bgSecondary border border-dark-border rounded-lg p-4 mb-4",children:[l.jsx("h3",{className:"text-sm font-mono font-bold text-accent-primary mb-3",children:"FastTracker II XM Export (.xm)"}),l.jsxs("div",{className:"space-y-3",children:[l.jsxs("div",{children:[l.jsx("label",{className:"block text-xs font-mono text-text-muted mb-1",children:"Channel Count (max 32)"}),l.jsx("input",{type:"number",min:2,max:32,value:Me,onChange:e=>Pe(Math.min(32,Math.max(2,Number(e.target.value)))),className:"input w-full"})]}),l.jsxs("label",{className:"flex items-center gap-3 text-sm font-mono text-text-primary cursor-pointer hover:text-accent-primary transition-colors",children:[l.jsx("input",{type:"checkbox",checked:Ee,onChange:e=>Ae(e.target.checked),className:"w-4 h-4 rounded border-dark-border bg-dark-bg text-accent-primary focus:ring-accent-primary"}),"Render synth instruments as samples"]}),l.jsxs("div",{className:"text-sm font-mono text-text-secondary space-y-1",children:[l.jsxs("div",{children:["Format: ",l.jsx("span",{className:"text-accent-primary",children:"FastTracker II Extended Module"})]}),l.jsxs("div",{children:["Patterns: ",l.jsx("span",{className:"text-accent-primary",children:n.length})]}),l.jsxs("div",{children:["Channels: ",l.jsx("span",{className:"text-accent-primary",children:Math.min(n[0]?.channels.length||8,32)})]}),l.jsxs("div",{children:["Instruments: ",l.jsx("span",{className:"text-accent-primary",children:Math.min(S.length,128)})]})]}),De.length>0&&l.jsxs("div",{className:"bg-orange-500/10 border border-orange-500/30 rounded-lg p-3",children:[l.jsxs("h4",{className:"text-xs font-mono font-bold text-orange-400 mb-2",children:["Export Warnings (",De.length,")"]}),l.jsx("ul",{className:"text-xs font-mono text-orange-300 space-y-1 max-h-32 overflow-y-auto",children:De.map((e,t)=>l.jsxs("li",{className:"flex items-start gap-2",children:[l.jsx("span",{className:"text-orange-400",children:""}),l.jsx("span",{children:e})]},t))})]})]})]}),"mod"===ne&&l.jsxs("div",{className:"bg-dark-bgSecondary border border-dark-border rounded-lg p-4 mb-4",children:[l.jsx("h3",{className:"text-sm font-mono font-bold text-accent-primary mb-3",children:"ProTracker MOD Export (.mod)"}),l.jsxs("div",{className:"space-y-3",children:[l.jsxs("div",{children:[l.jsx("label",{className:"block text-xs font-mono text-text-muted mb-1",children:"MOD Format"}),l.jsxs("div",{className:"grid grid-cols-3 gap-2",children:[l.jsx("button",{onClick:()=>Ue(4),className:`\n                            px-3 py-2 rounded-lg text-xs font-mono transition-all\n                            ${4===Ce?"bg-accent-secondary text-text-inverse":"bg-dark-bg text-text-secondary hover:bg-dark-bgHover border border-dark-border"}\n                          `,children:"4 Channel (M.K.)"}),l.jsx("button",{onClick:()=>Ue(6),className:`\n                            px-3 py-2 rounded-lg text-xs font-mono transition-all\n                            ${6===Ce?"bg-accent-secondary text-text-inverse":"bg-dark-bg text-text-secondary hover:bg-dark-bgHover border border-dark-border"}\n                          `,children:"6 Channel (6CHN)"}),l.jsx("button",{onClick:()=>Ue(8),className:`\n                            px-3 py-2 rounded-lg text-xs font-mono transition-all\n                            ${8===Ce?"bg-accent-secondary text-text-inverse":"bg-dark-bg text-text-secondary hover:bg-dark-bgHover border border-dark-border"}\n                          `,children:"8 Channel (8CHN)"})]})]}),l.jsxs("label",{className:"flex items-center gap-3 text-sm font-mono text-text-primary cursor-pointer hover:text-accent-primary transition-colors",children:[l.jsx("input",{type:"checkbox",checked:Ee,onChange:e=>Ae(e.target.checked),className:"w-4 h-4 rounded border-dark-border bg-dark-bg text-accent-primary focus:ring-accent-primary"}),"Render synth instruments as samples"]}),l.jsxs("div",{className:"text-sm font-mono text-text-secondary space-y-1",children:[l.jsxs("div",{children:["Format: ",l.jsx("span",{className:"text-accent-primary",children:"ProTracker MOD"})]}),l.jsxs("div",{children:["Patterns: ",l.jsx("span",{className:"text-accent-primary",children:n.length})]}),l.jsxs("div",{children:["Max Samples: ",l.jsx("span",{className:"text-accent-primary",children:"31"})]}),l.jsxs("div",{children:["Max Rows/Pattern: ",l.jsx("span",{className:"text-accent-primary",children:"64"})]}),l.jsxs("div",{children:["Note Range: ",l.jsx("span",{className:"text-accent-primary",children:"C-0 to B-3"})]})]}),De.length>0&&l.jsxs("div",{className:"bg-orange-500/10 border border-orange-500/30 rounded-lg p-3",children:[l.jsxs("h4",{className:"text-xs font-mono font-bold text-orange-400 mb-2",children:["Export Warnings (",De.length,")"]}),l.jsx("ul",{className:"text-xs font-mono text-orange-300 space-y-1 max-h-32 overflow-y-auto",children:De.map((e,t)=>l.jsxs("li",{className:"flex items-start gap-2",children:[l.jsx("span",{className:"text-orange-400",children:""}),l.jsx("span",{children:e})]},t))})]})]})]}),"chip"===ne&&l.jsxs("div",{className:"bg-dark-bgSecondary border border-dark-border rounded-lg p-4 mb-4",children:[l.jsx("h3",{className:"text-sm font-mono font-bold text-accent-primary mb-3",children:"Chip Music Export"}),l.jsxs("div",{className:"space-y-4",children:[l.jsxs("div",{className:"bg-dark-bg border border-dark-border rounded-lg p-3",children:[l.jsxs("div",{className:"flex items-center justify-between mb-3",children:[l.jsx("span",{className:"text-xs font-mono text-text-muted",children:"RECORDING"}),l.jsx("span",{className:"text-lg font-mono text-accent-primary font-bold",children:(e=>{const t=Math.floor(e/1e3),n=Math.floor(t/60),r=t%60,s=Math.floor(e%1e3/100);return`${n}:${r.toString().padStart(2,"0")}.${s}`})(Fe)})]}),l.jsx("div",{className:"flex gap-2",children:Re?l.jsxs("button",{onClick:async()=>{rt.current&&(clearInterval(rt.current),rt.current=null);const e=await $e.stopRecording();if(Ie(!1),Ve(e),e.length>0){const t=pt(e);Xe(t);const n=$t(t);He(n),n.length>0&&!n.includes(Oe)&&Le(n[0])}},className:"flex-1 px-4 py-2 rounded-lg bg-dark-bgHover text-text-primary font-mono text-sm hover:bg-dark-border transition-colors flex items-center justify-center gap-2",children:[l.jsx("span",{className:"w-3 h-3 bg-white"}),"Stop"]}):l.jsxs("button",{onClick:()=>{$e.startRecording(),Ie(!0),Be(0),Ve(null),Xe([]),He([]),rt.current=setInterval(()=>{Be(e=>e+100)},100)},className:"flex-1 px-4 py-2 rounded-lg bg-red-500 text-white font-mono text-sm hover:bg-red-600 transition-colors flex items-center justify-center gap-2",children:[l.jsx("span",{className:"w-3 h-3 rounded-full bg-white"}),"Record"]})}),l.jsx("p",{className:"text-xs font-mono text-text-muted mt-2",children:Re?"Recording... Play your song now!":ze.length>0?`Captured ${ze.length.toLocaleString()} register writes`:"Press Record, then play your song to capture chip output"})]}),ze.length>0&&l.jsxs("div",{className:"bg-dark-bg border border-dark-border rounded-lg p-3",children:[l.jsx("h4",{className:"text-xs font-mono text-text-muted mb-2",children:"CAPTURED DATA"}),(()=>{const e=Rt(ze);return l.jsxs("div",{className:"space-y-1 text-sm font-mono",children:[l.jsxs("div",{children:["Duration: ",l.jsxs("span",{className:"text-accent-primary",children:[e.duration.toFixed(1),"s"]})]}),l.jsxs("div",{children:["Writes: ",l.jsx("span",{className:"text-accent-primary",children:e.totalWrites.toLocaleString()})]}),l.jsxs("div",{className:"pt-1 border-t border-dark-border mt-2",children:[l.jsx("span",{className:"text-text-muted",children:"Chips used:"}),e.usedChips.map(e=>l.jsxs("div",{className:"ml-2 text-xs",children:[e.name,": ",l.jsx("span",{className:"text-accent-secondary",children:e.writes.toLocaleString()})]},e.type))]})]})})()]}),ze.length>0&&l.jsxs("div",{className:"bg-dark-bg border border-dark-border rounded-lg p-3",children:[l.jsx("div",{className:"text-xs font-mono text-text-muted mb-2",children:"QUICK PRESETS"}),l.jsxs("div",{className:"grid grid-cols-2 gap-2",children:[l.jsx("button",{onClick:()=>Le("vgm"),className:"px-3 py-2 rounded-lg bg-dark-bgSecondary border border-dark-border hover:border-accent-primary text-xs font-mono transition-colors text-left",children:" Universal (VGM)"}),l.jsx("button",{onClick:()=>Le("gym"),disabled:!Ye.includes("gym"),className:"px-3 py-2 rounded-lg bg-dark-bgSecondary border border-dark-border hover:border-accent-primary text-xs font-mono transition-colors text-left disabled:opacity-50 disabled:cursor-not-allowed",children:" Genesis (GYM)"}),l.jsx("button",{onClick:()=>Le("nsf"),disabled:!Ye.includes("nsf"),className:"px-3 py-2 rounded-lg bg-dark-bgSecondary border border-dark-border hover:border-accent-primary text-xs font-mono transition-colors text-left disabled:opacity-50 disabled:cursor-not-allowed",children:" NES (NSF)"}),l.jsx("button",{onClick:()=>Le("gbs"),disabled:!Ye.includes("gbs"),className:"px-3 py-2 rounded-lg bg-dark-bgSecondary border border-dark-border hover:border-accent-primary text-xs font-mono transition-colors text-left disabled:opacity-50 disabled:cursor-not-allowed",children:" Game Boy (GBS)"})]})]}),l.jsxs("div",{children:[l.jsx("label",{className:"block text-xs font-mono text-text-muted mb-2",children:"EXPORT FORMAT"}),l.jsx("div",{className:"grid grid-cols-2 gap-2",children:["vgm","gym","nsf","gbs","spc","zsm","sap","tiuna"].map(e=>{const t=Lt[e],n=Ye.includes(e)||0===ze.length,r={vgm:{supported:!0,type:"custom"},gym:{supported:!1,type:"none"},nsf:{supported:!0,type:"auto"},gbs:{supported:!0,type:"auto"},spc:{supported:!1,type:"none"},zsm:{supported:!1,type:"none"},sap:{supported:!1,type:"none"},tiuna:{supported:!1,type:"none"}}[e];return l.jsxs("button",{onClick:()=>n&&Le(e),disabled:!n&&ze.length>0,className:`\n                                p-3 rounded-lg text-left transition-all\n                                ${Oe===e?"bg-accent-primary text-text-inverse":n||0===ze.length?"bg-dark-bg border border-dark-border hover:border-dark-borderLight":"bg-dark-bg border border-dark-border opacity-40 cursor-not-allowed"}\n                              `,children:[l.jsxs("div",{className:"flex items-center justify-between",children:[l.jsx("div",{className:"font-mono text-sm font-semibold",children:t.name}),"custom"===r.type&&l.jsx("span",{className:"text-xs opacity-70",title:"Custom loop point supported",children:""}),"auto"===r.type&&l.jsx("span",{className:"text-xs opacity-70",title:"Loops entire song automatically",children:""})]}),l.jsxs("div",{className:"text-xs opacity-70",children:[".",t.extension]})]},e)})}),Ze>0&&l.jsx("div",{className:"mt-2 text-xs",children:(()=>{const e={vgm:"custom",nsf:"auto",gbs:"auto",gym:"none",spc:"none",zsm:"none",sap:"none",tiuna:"none"}[Oe];return"custom"===e?l.jsxs("div",{className:"text-green-400",children:[" Loop point at row ",Ze," will be used"]}):"auto"===e?l.jsxs("div",{className:"text-yellow-400",children:[" ",Oe.toUpperCase()," loops entire song (custom loop points not supported)"]}):l.jsxs("div",{className:"text-yellow-400",children:[" ",Oe.toUpperCase()," format does not support loop points"]})})()})]}),l.jsxs("div",{className:"space-y-2",children:[l.jsxs("div",{children:[l.jsx("label",{className:"block text-xs font-mono text-text-muted mb-1",children:"Title"}),l.jsx("input",{type:"text",value:We,onChange:e=>Ke(e.target.value),placeholder:E.name||"Untitled",className:"input w-full"})]}),l.jsxs("div",{children:[l.jsx("label",{className:"block text-xs font-mono text-text-muted mb-1",children:"Author"}),l.jsx("input",{type:"text",value:qe,onChange:e=>Qe(e.target.value),placeholder:E.author||"Unknown",className:"input w-full"})]})]}),l.jsxs("div",{className:"bg-dark-bg border border-dark-border rounded-lg p-3",children:[l.jsx("label",{className:"block text-xs font-mono text-text-muted mb-2",children:"LOOP POINT (Row)"}),l.jsxs("div",{className:"flex gap-2",children:[l.jsx("input",{type:"number",value:Ze,onChange:e=>Je(Math.max(0,Number(e.target.value))),min:0,className:"input flex-1 font-mono",placeholder:"0"}),l.jsx("button",{onClick:()=>{Je(et),tt(et)},className:"px-3 py-2 rounded-lg bg-dark-bgHover text-text-primary font-mono text-xs hover:bg-dark-border transition-colors",title:"Set loop point to current row",children:"From Cursor"})]}),l.jsx("p",{className:"text-xs font-mono text-text-muted mt-2",children:Ze>0?`Music will loop back to row ${Ze}`:"Set to 0 for no loop (one-shot playback)"})]}),ue&&"chip"===ne&&l.jsxs("div",{className:"bg-dark-bg border border-dark-border rounded-lg p-3",children:[l.jsxs("div",{className:"flex items-center justify-between mb-2",children:[l.jsxs("span",{className:"text-xs font-mono text-text-muted",children:["Exporting ",Lt[Oe].name,"..."]}),l.jsxs("span",{className:"text-xs font-mono text-accent-primary",children:[xe,"%"]})]}),l.jsx("div",{className:"h-2 bg-dark-border rounded-full overflow-hidden",children:l.jsx("div",{className:"h-full bg-accent-primary transition-all duration-300",style:{width:`${xe}%`}})})]}),l.jsx("div",{className:"text-xs font-mono text-text-muted bg-dark-bg border border-dark-border rounded-lg p-3",children:Lt[Oe].description})]})]}),"nano"===ne&&l.jsxs("div",{className:"bg-dark-bgSecondary border border-dark-border rounded-lg p-4 mb-4",children:[l.jsx("h3",{className:"text-sm font-mono font-bold text-accent-primary mb-3",children:"Nano Binary Export (.dbn)"}),l.jsxs("div",{className:"space-y-3",children:[l.jsx("div",{className:"bg-dark-bg border border-dark-border rounded-lg p-3",children:l.jsxs("p",{className:"text-xs font-mono text-text-primary leading-relaxed",children:["Extreme binary compression for demoscene 4k intros. Exports a strictly optimized ",l.jsx("span",{className:"text-accent-secondary",children:"Uint8Array"})," containing only used instruments and bit-masked pattern data."]})}),l.jsxs("div",{className:"text-sm font-mono text-text-secondary space-y-1",children:[l.jsxs("div",{children:["Target Size: ",l.jsx("span",{className:"text-accent-primary",children:"< 4KB"})]}),l.jsxs("div",{children:["Format: ",l.jsx("span",{className:"text-accent-primary",children:"DBXN Binary"})]}),l.jsxs("div",{children:["Used Instruments: ",l.jsx("span",{className:"text-accent-primary",children:(()=>{const e=new Set;return n.forEach(t=>{t.channels.forEach(t=>{t.rows.forEach(t=>{t.instrument>0&&e.add(t.instrument)})})}),e.size})()})]})]})]})]}),l.jsxs("div",{className:"bg-dark-bgSecondary border border-dark-border rounded-lg p-4",children:[l.jsx("h3",{className:"text-sm font-mono font-bold text-accent-primary mb-3",children:"Options"}),l.jsxs("div",{className:"space-y-2",children:["song"===ne&&l.jsxs("label",{className:"flex items-center gap-3 text-sm font-mono text-text-primary cursor-pointer hover:text-accent-primary transition-colors",children:[l.jsx("input",{type:"checkbox",checked:se.includeAutomation,onChange:e=>ae({...se,includeAutomation:e.target.checked}),className:"w-4 h-4 rounded border-dark-border bg-dark-bg text-accent-primary focus:ring-accent-primary"}),"Include automation data"]}),l.jsxs("label",{className:"flex items-center gap-3 text-sm font-mono text-text-primary cursor-pointer hover:text-accent-primary transition-colors",children:[l.jsx("input",{type:"checkbox",checked:se.prettify,onChange:e=>ae({...se,prettify:e.target.checked}),className:"w-4 h-4 rounded border-dark-border bg-dark-bg text-accent-primary focus:ring-accent-primary"}),"Prettify JSON (human-readable)"]}),l.jsxs("label",{className:"flex items-center gap-3 text-sm font-mono text-text-muted cursor-not-allowed",children:[l.jsx("input",{type:"checkbox",checked:se.compress,disabled:!0,className:"w-4 h-4 rounded opacity-50"}),"Compress (coming soon)"]})]})]})]}):l.jsxs(l.Fragment,{children:[l.jsxs("div",{className:"text-center py-10",children:[l.jsx("div",{className:"w-20 h-20 mx-auto mb-5 rounded-full bg-dark-bgSecondary border border-dark-border flex items-center justify-center",children:l.jsx($,{size:32,className:"text-accent-primary"})}),l.jsx("h3",{className:"text-xl font-mono font-bold text-text-primary mb-2",children:"Import File"}),l.jsx("p",{className:"text-sm font-mono text-text-muted mb-6",children:"Select a .dbx, .sfx.json, or .dbi file"}),l.jsx("button",{onClick:()=>{nt.current?.click()},className:"btn-primary px-8 py-3",children:"Choose File"}),l.jsx("input",{ref:nt,type:"file",accept:".json",onChange:async e=>{const n=e.target.files?.[0];if(n){if(Y){W();d().releaseAll()}try{switch(await m(n)){case"song":{const e=await x(n);if(e){if(A(e.metadata),T(e.bpm),k(e.patterns),P(e.instruments),e.automationCurves&&e.automationCurves.length>0)q(e.automationCurves);else if(e.automation){const t=[];Object.entries(e.automation).forEach(([,e])=>{Object.entries(e).forEach(([,e])=>{Object.values(e).forEach(e=>{t.push(e)})})}),t.length>0&&q(t)}e.masterEffects&&e.masterEffects.length>0&&Z(e.masterEffects),p.success(`Song "${e.metadata.name}" imported successfully!`)}break}case"sfx":{const e=await h(n);if(e){const t=N(e.pattern);U(e.instrument),w(t),M(e.instrument.id),p.success(`SFX "${e.name}" imported successfully!`)}break}case"instrument":{const e=await u(n);e&&(U(e.instrument),M(e.instrument.id),p.success(`Instrument "${e.instrument.name}" imported successfully!`));break}default:p.error("Unknown or invalid file format")}t()}catch(r){p.error("Import failed: "+r.message)}}},className:"hidden"})]}),l.jsxs("div",{className:"bg-dark-bgSecondary border border-dark-border rounded-lg p-4 mt-4",children:[l.jsx("h4",{className:"text-xs font-mono font-bold text-accent-primary mb-3",children:"Supported Formats"}),l.jsxs("ul",{className:"text-sm font-mono text-text-secondary space-y-2",children:[l.jsxs("li",{className:"flex items-start gap-2",children:[l.jsx("span",{className:"text-accent-primary",children:""}),l.jsxs("span",{children:[l.jsx("strong",{children:".song.json"})," - Full song with all patterns and instruments"]})]}),l.jsxs("li",{className:"flex items-start gap-2",children:[l.jsx("span",{className:"text-accent-primary",children:""}),l.jsxs("span",{children:[l.jsx("strong",{children:".sfx.json"})," - Single pattern with one instrument"]})]}),l.jsxs("li",{className:"flex items-start gap-2",children:[l.jsx("span",{className:"text-accent-primary",children:""}),l.jsxs("span",{children:[l.jsx("strong",{children:".dbi"})," - Individual instrument preset"]})]})]})]})]})}),l.jsxs("div",{className:"bg-dark-bgSecondary border-t border-dark-border px-5 py-4 flex items-center justify-between",children:[l.jsx("div",{className:"text-xs font-mono text-text-muted",children:"export"===J?"Format: "+("audio"===ne?".wav":"midi"===ne?".mid":"xm"===ne?".xm":"mod"===ne?".mod":"chip"===ne?`.${Lt[Oe].extension}`:"nano"===ne?".dbn":`.${ne}.json`):"Select a file to import"}),l.jsxs("div",{className:"flex gap-3",children:[l.jsx("button",{onClick:t,className:"btn",disabled:ue,children:"Cancel"}),"export"===J&&l.jsxs("button",{onClick:async()=>{try{switch(ne){case"song":{const e=n.map(e=>e.id),t={};n.forEach(e=>{e.channels.forEach((n,r)=>{const s=K.filter(t=>t.patternId===e.id&&t.channelIndex===r);s.length>0&&(t[e.id]||(t[e.id]={}),t[e.id][r]=s.reduce((e,t)=>(e[t.parameter]=t,e),{}))})}),y(E,D,S,n,e,t,Q,K,se);break}case"sfx":{const e=n[ce],t=S.find(e=>e.id===de);if(!e||!t)return void p.warning("Please select a valid pattern and instrument");b(oe,t,e,D,se);break}case"instrument":{const e=S.find(e=>e.id===de);if(!e)return void p.warning("Please select a valid instrument");g(e,se);break}case"audio":he(!0),fe(0);try{if(ge){const e=n.map((e,t)=>t);await H(n,e,S,D,`${E.name||"song"}.wav`,e=>fe(e))}else{const e=n[ce];if(!e)return void p.warning("Please select a valid pattern");await async function(e,t,n,r,s){const a=X(await z(e,t,n,{onProgress:s})),o=URL.createObjectURL(a),i=document.createElement("a");i.href=o,i.download=r.endsWith(".wav")?r:`${r}.wav`,document.body.appendChild(i),i.click(),document.body.removeChild(i),URL.revokeObjectURL(o)}(e,S,D,`${e.name||"pattern"}.wav`,e=>fe(e))}}finally{he(!1),fe(0)}break;case"midi":{const e=[4,4],t={type:ye,includeAutomation:Ne,velocityScale:1,exportMutedChannels:!1};let r,s;if(ke){const a=n.map(e=>e.id);r=ee(n,a,D,e,K,t),s=`${E.name||"song"}.mid`}else{const a=n[ce];if(!a)return void p.warning("Please select a valid pattern");r=_(a,D,e,t),s=`${a.name||"pattern"}.mid`}const a=new Blob([new Uint8Array(r)],{type:"audio/midi"}),o=URL.createObjectURL(a),i=document.createElement("a");i.href=o,i.download=s,document.body.appendChild(i),i.click(),document.body.removeChild(i),URL.revokeObjectURL(o),p.success(`MIDI file "${s}" exported successfully!`);break}case"xm":{const e={channelLimit:Me,moduleName:E.name||"DEViLBOX Export",bakeSynthsToSamples:Ee},r=await pe(n,S,e),s=URL.createObjectURL(r.data),a=document.createElement("a");a.href=s,a.download=r.filename,document.body.appendChild(a),a.click(),document.body.removeChild(a),URL.revokeObjectURL(s),r.warnings.length>0?(Te(r.warnings),p.warning(`XM exported with ${r.warnings.length} warnings. Check the dialog for details.`)):(p.success(`XM file "${r.filename}" exported successfully!`),t());break}case"mod":{const e={channelCount:Ce,moduleName:E.name||"DEViLBOX Export",bakeSynthsToSamples:Ee},r=await je(n,S,e),s=URL.createObjectURL(r.data),a=document.createElement("a");a.href=s,a.download=r.filename,document.body.appendChild(a),a.click(),document.body.removeChild(a),URL.revokeObjectURL(s),r.warnings.length>0?(Te(r.warnings),p.warning(`MOD exported with ${r.warnings.length} warnings. Check the dialog for details.`)):(p.success(`MOD file "${r.filename}" exported successfully!`),t());break}case"chip":if(!Ge||0===Ge.length)return void p.error("No recording data. Press Record and play your song first.");if(0===ze.length)return void p.error("No register writes captured. Make sure Furnace chips are playing.");if(!Ye.includes(Oe)){const e=Rt(ze).usedChips.map(e=>e.name).join(", ");return void p.error(`${Lt[Oe].name} format is not compatible with chips used: ${e}. Try VGM for universal compatibility.`)}if(!We.trim())return void p.error("Please enter a title for your export.");he(!0),fe(0);try{const e=1/(D/60*4),n=Ze>0?Math.floor(Ze*e*44100):void 0;fe(50);const r=await It(Ge,{format:Oe,title:We||E.name||"Untitled",author:qe||E.author||"Unknown",loopPoint:n});fe(100);const s=URL.createObjectURL(r.data),a=document.createElement("a");a.href=s,a.download=r.filename,document.body.appendChild(a),a.click(),document.body.removeChild(a),URL.revokeObjectURL(s),p.success(`${Lt[Oe].name} file exported successfully!`),t()}catch(e){p.error(`Export failed: ${e.message}`)}finally{he(!1),fe(0)}break;case"nano":{const e=n.map((e,t)=>t),r=f.export(S,n,e,D,6),s=new Blob([new Uint8Array(r)],{type:"application/octet-stream"}),a=URL.createObjectURL(s),o=document.createElement("a");o.href=a,o.download=`${E.name||"song"}.dbn`,document.body.appendChild(o),o.click(),document.body.removeChild(o),URL.revokeObjectURL(a),p.success(`Nano binary "${E.name||"song"}.dbn" exported successfully! (${r.length} bytes)`),t();break}}"xm"!==ne&&"mod"!==ne&&t()}catch(e){p.error("Export failed: "+e.message)}},className:"btn-primary flex items-center gap-2",disabled:ue,children:[l.jsx(L,{size:16}),ue?"Rendering...":"Export"]})]})]})]})})};export{Bt as ExportDialog};
