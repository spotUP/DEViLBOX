import{aB as e}from"./index-zx6LJBPK.js";import"./vendor-react-DkDaD07v.js";import"./vendor-utils-XMmR-oGw.js";import"./vendor-tone-CADp_hfL.js";import"./vendor-ui-uomqNFY-.js";function t(e,t){return e.getUint8(t)}function n(e,t){return e.getUint32(t,!0)}function r(e,t,n){const r=[];for(let f=0;f<n;f++){const n=e.getUint8(t+f);if(0===n)break;r.push(n)}return String.fromCharCode(...r).replace(/[\x00-\x1F]/g," ").trim()}const f=497,o=1536,s=[-60,60,60,-60,-60,60,60,-60];function l(e){if(e.length<f)return!1;const n=new DataView(e.buffer,e.byteOffset,e.byteLength),r=t(n,0),s=t(n,1);if(!(105===r&&102===s)&&!(74===r&&78===s))return!1;const l=t(n,110),i=t(n,111),u=t(n,112);if(l>64)return!1;if(i>128)return!1;if(u>=128)return!1;let a=0;for(let f=0;f<108;f++){const e=t(n,2+f);if(e>0&&e<=31&&++a>40)return!1}for(let f=0;f<128;f++){const e=t(n,113+f),r=t(n,241+f),o=t(n,369+f);if(e>=128&&e<254)return!1;if(e<128&&0===r)return!1;if(r>15)return!1;if(o>=64)return!1}const c=f+25*l+i*o;return!(e.length<c)}function i(e,t){switch(e){case 0:return{effTyp:1,eff:t};case 1:return{effTyp:2,eff:t};case 2:return{effTyp:3,eff:t};case 3:return{effTyp:1,eff:240|t};case 4:return{effTyp:4,eff:t<<4|t};case 5:return{effTyp:15,eff:t};case 6:switch(t){case 0:return{effTyp:14,eff:4};case 1:return{effTyp:14,eff:20};default:return{effTyp:0,eff:0}}case 7:return{effTyp:14,eff:144|t};default:return{effTyp:0,eff:0}}}function u(u,a){try{return function(u,a){if(!l(u))return null;const c=u.buffer.slice(u.byteOffset,u.byteOffset+u.byteLength),p=new DataView(c),h=t(p,110),m=t(p,111),y=t(p,112),g=r(p,2,36),d=[];let b=f;for(let e=0;e<h;e++)d.push({filename:r(p,b,13),length:n(p,b+13),loopStart:n(p,b+17),loopEnd:n(p,b+21)}),b+=25;const T=[];for(let e=0;e<128;e++){const n=t(p,113+e);if(255===n||254===n)break;T.push(n)}0===T.length&&T.push(0);const S=[],w=[];for(let e=0;e<T.length;e++)S.push(t(p,241+e)),w.push(t(p,369+e));const $=f+25*h;function v(e,n,r,f){const l=$+e*o,u=new Uint8Array(8).fill(255),y=Array.from({length:8},()=>[]);for(let o=0;o<64;o++)for(let e=0;e<8;e++){const n=l+3*(8*o+e),s=n<c.byteLength?t(p,n):255,a=n+1<c.byteLength?t(p,n+1):0,h=n+2<c.byteLength?t(p,n+2):255;let m=0,g=0,d=0;if(s<254){g=(3&s)<<4|a>>4,m=(s>>2)+37,m<1&&(m=1),m>96&&(m=96),u[e]=255}if(s<=254){const e=15&a;d=Math.round((64*e+8)/15)}255!==h&&(u[e]=h);let b=0,T=0;if(255!==u[e]){const t=u[e]>>4,n=i(t,15&u[e]);b=n.effTyp,T=n.eff,6!==t&&(u[e]=255)}0===o&&0===e&&r>0&&15!==b&&(b=15,T=r),f<63&&o===f&&0===e&&0===b&&(b=13,T=0),y[e].push({note:m,instrument:s<254?g+1:0,volume:d,effTyp:b,eff:T,effTyp2:0,eff2:0})}const g=y.map((t,r)=>({id:`c${n}-p${e}-ch${r}`,name:`Channel ${r+1}`,muted:!1,solo:!1,collapsed:!1,volume:100,pan:s[r],instrumentId:null,color:null,rows:t}));return{id:`pattern-${n}-${e}`,name:`Pattern ${e}`,length:64,channels:g,importMetadata:{sourceFormat:"669",sourceFile:a,importedAt:(new Date).toISOString(),originalChannelCount:8,originalPatternCount:m,originalInstrumentCount:h}}}const C=[],L=[];for(let e=0;e<T.length;e++){const t=T[e],n=S[e]>0?S[e]:4,r=w[e];C.push(v(t,e,n,r)),L.push(e)}const O=$+m*o,P=d.map((t,n)=>{const r=n+1,f=t.filename||`Sample ${r}`;if(0===t.length||t.length>=67108864)return{id:r,name:f,type:"sample",synthType:"Sampler",effects:[],volume:-60,pan:0};let o=O;for(let e=0;e<n;e++)o+=d[e].length;const s=o+t.length;if(s>c.byteLength)return{id:r,name:f,type:"sample",synthType:"Sampler",effects:[],volume:-60,pan:0};let l=0,i=0;t.loopEnd>t.length&&0===t.loopStart||0===t.loopEnd||(l=t.loopStart,i=Math.min(t.loopEnd,t.length));const a=u.subarray(u.byteOffset+o,u.byteOffset+s);return e(r,f,a,64,8363,l,i)}),j=y<T.length?y:0;return{name:g||a.replace(/\.[^/.]+$/,""),format:"MOD",patterns:C,instruments:P,songPositions:L,songLength:L.length,restartPosition:j,numChannels:8,initialSpeed:4,initialBPM:125,linearPeriods:!1}}(u,a)}catch{return null}}export{l as isComposer667Format,u as parseComposer667File};
