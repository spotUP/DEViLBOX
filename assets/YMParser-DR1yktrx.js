import{aU as t}from"./index-zx6LJBPK.js";import"./vendor-react-DkDaD07v.js";import"./vendor-utils-XMmR-oGw.js";import"./vendor-tone-CADp_hfL.js";import"./vendor-ui-uomqNFY-.js";function n(){return{note:0,instrument:0,volume:0,effTyp:0,eff:0,effTyp2:0,eff2:0}}function e(t){if(t<=0)return 0;const n=2e6/(16*t);if(n<20)return 0;const e=Math.round(12*Math.log2(n/440)+69);return Math.max(1,Math.min(96,e))}function r(t){const n=String.fromCharCode(t[0],t[1],t[2],t[3]);if("YM2!"===n||"YM3!"===n||"YM3b"===n){const e=14;return{version:n,numFrames:Math.floor((t.length-4)/e),attributes:0,clock:2e6,playerHz:50,title:"",author:"",regsPerFrame:e,interleaved:!1,dataOffset:4}}if("YM4!"===n||"YM5!"===n||"YM6!"===n){let e=12;const r=new DataView(t.buffer,t.byteOffset),o=r.getUint32(e,!1);e+=4;const i=r.getUint32(e,!1);e+=4;const f=r.getUint16(e,!1);e+=2;const a=r.getUint32(e,!1);e+=4;const s=r.getUint16(e,!1);e+=2,r.getUint32(e,!1),e+=4;const l=r.getUint16(e,!1);e+=2+l;for(let t=0;t<f;t++){const t=r.getUint32(e,!1);e+=4+t}const c=()=>{const n=function(t,n){let e="",r=n;for(;r<t.length&&0!==t[r];)e+=String.fromCharCode(t[r++]);return{text:e,nextOff:r+1}}(t,e);return e=n.nextOff,n.text},u=c(),h=c();return c(),{version:n,numFrames:o,attributes:i,clock:a||2e6,playerHz:s||50,title:u,author:h,regsPerFrame:16,interleaved:!!(1&i),dataOffset:e}}throw new Error(`Unknown YM version: ${n}`)}function o(t,n){const{numFrames:e,regsPerFrame:r,interleaved:o,dataOffset:i}=n,f=t.subarray(i),a=[];for(let s=0;s<e;s++){const t=new Uint8Array(r);for(let n=0;n<r;n++){const i=o?n*e+s:s*r+n;t[n]=i<f.length?f[i]:0}a.push(t)}return a}function i(t){const r=Math.max(1,Math.ceil(t.length/256)),o=Math.min(256,Math.ceil(t.length/r)),i=function(t,e,r,o){return{id:t,name:e,length:o,channels:Array.from({length:r},(t,e)=>({id:`ch${e}`,name:`AY ${String.fromCharCode(65+e)}`,muted:!1,solo:!1,collapsed:!1,volume:100,pan:0,instrumentId:null,color:null,rows:Array.from({length:o},n)}))}}("p0","Pattern 1",3,o),f=[0,0,0],a=[-1,-1,-1];for(let n=0;n<o;n++){const o=t[Math.min(n*r,t.length-1)],s=o[7]??255;for(let t=0;t<3;t++){const r=o[2*t]??0,l=(15&(o[2*t+1]??0))<<8|r,c=15&(o[8+t]??0),u=!(s>>t&1)&&c>0&&l>0?e(l):0,h=i.channels[t].rows[n];u!==f[t]&&(h.note=u>0?u:f[t]>0?97:0,u>0&&(h.instrument=1),f[t]=u),c!==a[t]&&(h.volume=c>0?Math.round(c/15*64):0,a[t]=c)}}return i}function f(t){const n=new Uint8Array(t);if(n.length<4)return!1;const e=String.fromCharCode(n[0],n[1],n[2],n[3]);return["YM2!","YM3!","YM3b","YM4!","YM5!","YM6!"].includes(e)}async function a(n,e){let a=new Uint8Array(n);if(!f(a.buffer))throw new Error("Not a valid YM file");const s=r(a);let l;if("YM5!"===s.version||"YM6!"===s.version)try{const t=function(t){const n=510,e=new Uint8Array(8192).fill(32),r=[];let o=0,i=0,f=0,a=0,s=0;function l(n){for(f=f<<n>>>0&65535;n>s;)f|=a<<(n-=s)>>>0&65535,a=i<t.length?t[i++]:0,s=8;s-=n,f|=a>>s&65535,f&=65535}function c(t){const n=f>>16-t&(1<<t)-1;return l(t),n}a=i<t.length?t[i++]:0,l(16);const u=new Uint8Array(n),h=new Uint16Array(4096),m=new Uint8Array(14),g=new Uint16Array(256);function d(t,n,e,r){const o=1<<e,i=new Uint16Array(17);for(let a=0;a<t;a++)i[Math.min(n[a],16)]++;const f=new Uint16Array(18);f[1]=0;for(let a=1;a<=16;a++)f[a+1]=f[a]+i[a];for(let a=0;a<o;a++)r[a]=65535;for(let a=0;a<t;a++){const t=n[a];if(0===t)continue;const i=f[t];if(f[t]++,t<=e){const n=1<<e-t,f=i<<e-t;for(let t=0;t<n;t++)f+t<o&&(r[f+t]=a)}}}function y(t,n,e){let r=c(n);if(0===r){const e=c(n);for(let n=0;n<t;n++)m[n]=0;for(let t=0;t<256;t++)g[t]=e}else{let n=0;for(;n<r;){let r=f>>13&7;if(7===r){let t=4096;for(;t&f;)t>>=1,r++}if(r=Math.min(r,15),l(r<7?3:r-3),m[n++]=r,n===e)for(r=c(2);--r>=0&&n<t;)m[n++]=0}for(;n<t;)m[n++]=0;d(t,m,8,g)}}function M(){let t=c(9);if(0===t){const t=c(9);for(let e=0;e<n;e++)u[e]=0;for(let n=0;n<4096;n++)h[n]=t}else{let e=0;for(;e<t;){let t=g[f>>8&255];if((65535===t||t>=14)&&(t=13),l(m[t]),t<=2)for(t=0===t?1:1===t?c(4)+3:c(9)+20;--t>=0&&e<n;)u[e++]=0;else u[e++]=t-2}for(;e<n;)u[e++]=0;d(n,u,12,h)}}let p=0;for(;r.length<262144;){if(0===p){if(p=c(16),0===p)break;y(14,5,3),M(),y(14,4,-1)}p--;let t=h[f>>4&4095];if(65535===t||t>=n)break;if(l(u[t]),t<=255)e[o]=t,r.push(t),o=o+1&8191;else{const n=t-256+3;let i=g[f>>8&255];if(65535===i||i>=14)break;l(m[i]),i>=2&&(i=i-1<<1|c(1));const a=o-i-1&8191;for(let t=0;t<n;t++){const n=e[a+t&8191];e[o]=n,r.push(n),o=o+1&8191}}}return new Uint8Array(r)}(a.subarray(s.dataOffset)),n=new Uint8Array(s.dataOffset+t.length);n.set(a.subarray(0,s.dataOffset)),n.set(t,s.dataOffset),a=n,l=o(a,{...s,dataOffset:s.dataOffset})}catch{l=[new Uint8Array(16)]}else l=o(a,s);const c=i(l),u=s.title||e.replace(/\.ym$/i,""),h={id:1,name:"AY Channel",type:"synth",synthType:"FurnaceAY",furnace:{...t,chipType:6,ops:2},effects:[],volume:0,pan:0};return{name:u+(s.author?` â€” ${s.author}`:""),format:"YM",patterns:[c],instruments:[h],songPositions:[0],songLength:1,restartPosition:0,numChannels:3,initialSpeed:1,initialBPM:50===s.playerHz?50:60}}export{f as isYMFormat,a as parseYMFile};
