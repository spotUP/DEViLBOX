import{aB as e,aC as t,aD as n}from"./index-zx6LJBPK.js";import"./vendor-react-DkDaD07v.js";import"./vendor-utils-XMmR-oGw.js";import"./vendor-tone-CADp_hfL.js";import"./vendor-ui-uomqNFY-.js";const a=3546895,r=[0,6848,6464,6096,5760,5424,5120,4832,4560,4304,4064,3840,3616,3424,3232,3048,2880,2712,2560,2416,2280,2152,2032,1920,1808,1712,1616,1524,1440,1356,1280,1208,1140,1076,960,904,856,808,762,720,678,640,604,570,538,508,480,452,428,404,381,360,339,320,302,285,269,254,240,226,214,202,190,180,170,160,151,143,135,127,120,113,113,113,113,113,113,113,113,113,113,113,113,113],o=Math.round(a/1712),l=Math.round(a/428);function s(e,t){return e[t]<<8|e[t+1]}function i(e,t){return(e[t]<<24|e[t+1]<<16|e[t+2]<<8|e[t+3])>>>0}function f(e){return e<128?e:e-256}function u(e){if(e.byteLength<104)return!1;const t=new Uint8Array(e);if(65!==t[0]||76!==t[1]||76!==t[2]||32!==t[3])return!1;let n=104;for(let a=0;a<25;a++)if(n+=i(t,4+4*a),n>e.byteLength)return!1;return!0}function p(e){if(e<=0)return 0;const a=Math.max(0,Math.min(83,e)),o=r[a];if(0===o)return 0;const l=n(o);return t(l)}async function c(t,n){if(!u(t))throw new Error(`[DeltaMusic1Parser] Not a Delta Music 1.0 file: ${n}`);const a=new Uint8Array(t),r=[];for(let e=0;e<4;e++)r.push(i(a,4+4*e));const c=i(a,20),m=[];for(let e=0;e<20;e++)m.push(i(a,24+4*e));let h=104;const g=[];for(let e=0;e<4;e++){const t=r[e]/2,n=[];for(let e=0;e<t;e++)n.push({blockNumber:a[h],transpose:f(a[h+1])}),h+=2;g.push(n)}const y=Math.floor(c/64),b=[];for(let e=0;e<y;e++){const e=[];for(let t=0;t<16;t++)e.push({instrument:a[h],note:a[h+1],effect:a[h+2],effectArg:a[h+3]}),h+=4;b.push(e)}const d=[];for(let e=0;e<20;e++){const t=m[e];if(0===t){d.push({number:e,attackStep:0,attackDelay:0,decayStep:0,decayDelay:0,sustain:0,releaseStep:0,releaseDelay:0,volume:0,vibratoWait:0,vibratoStep:0,vibratoLength:0,bendRate:0,portamento:0,isSample:!1,tableDelay:0,arpeggio:new Array(8).fill(0),sampleLength:0,repeatStart:0,repeatLength:0,table:null,sampleData:null});continue}const n=h,r=a[n+0],o=a[n+1],l=a[n+2],i=a[n+3],u=s(a,n+4),p=a[n+6],c=a[n+7],g=a[n+8],y=a[n+9],b=a[n+10],S=a[n+11],v=f(a[n+12]),D=a[n+13],M=0!==a[n+14],A=a[n+15],k=[];for(let e=0;e<8;e++)k.push(a[n+16+e]);const w=s(a,n+24),L=s(a,n+26),$=s(a,n+28);let C,T=null;if(M)C=30;else{T=[];for(let e=0;e<48;e++)T.push(a[n+30+e]);C=78}const I=t-C;let P=null;I>0&&n+C+I<=a.length&&(P=new Int8Array(a.buffer,a.byteOffset+n+C,I)),d.push({number:e,attackStep:r,attackDelay:o,decayStep:l,decayDelay:i,sustain:u,releaseStep:p,releaseDelay:c,volume:g,vibratoWait:y,vibratoStep:b,vibratoLength:S,bendRate:v,portamento:D,isSample:M,tableDelay:A,arpeggio:k,sampleLength:w,repeatStart:L,repeatLength:$,table:T,sampleData:P}),h+=t}const S=[];for(let s=0;s<20;s++){const t=d[s],n=s+1;if(0!==t.sampleLength&&null!==t.sampleData)if(t.isSample){const a=t.sampleData.length,r=new Uint8Array(a);for(let e=0;e<a;e++)r[e]=255&t.sampleData[e];const o=t.repeatLength>1,i=o?2*t.repeatStart:0,f=o?2*(t.repeatStart+t.repeatLength):0;S.push(e(n,`Sample ${s}`,r,t.volume,l,i,f))}else if(null!==t.table){let a=0;for(let e=0;e<48;e++){const n=t.table[e];if(255===n)break;if(n<128){a=32*n;break}}const r=Math.min(32,t.sampleData.length-a);if(r<=0){S.push({id:n,name:`Synth ${s}`,type:"synth",synthType:"Synth",effects:[],volume:-6,pan:0});continue}const l=new Uint8Array(r);for(let e=0;e<r;e++)l[e]=255&t.sampleData[a+e];S.push(e(n,`Synth ${s}`,l,t.volume,o,0,r))}else S.push({id:n,name:`Instrument ${n}`,type:"synth",synthType:"Synth",effects:[],volume:-6,pan:0});else S.push({id:n,name:`Instrument ${n}`,type:"synth",synthType:"Synth",effects:[],volume:-6,pan:0})}const v=[],D=[];for(let e=0;e<4;e++){const t=g[e],n=[];let a=0;for(let e=0;e<t.length;e++){const r=t[e];if(255===r.blockNumber&&-1===r.transpose){if(e+1<t.length){const r=t[e+1],o=2047&(r.blockNumber<<8|255&r.transpose);a=Math.min(o,n.length>0?n.length-1:0)}break}n.push(r)}v.push(n),D.push(a)}const M=Math.max(...v.map(e=>e.length),1),A=[];for(let e=0;e<M;e++){const t=[[],[],[],[]];for(let n=0;n<4;n++){const a=v[n],r=a.length;if(0===r){for(let e=0;e<16;e++)t[n].push({note:0,instrument:0,volume:0,effTyp:0,eff:0,effTyp2:0,eff2:0});continue}let o=e;if(o>=r){const t=D[n]<r?D[n]:0,a=r-t;o=a>0?t+(e-t)%a:r-1}const l=a[o],s=l.blockNumber,i=l.transpose,f=s<b.length?b[s]:null;for(let e=0;e<16;e++){if(!f){t[n].push({note:0,instrument:0,volume:0,effTyp:0,eff:0,effTyp2:0,eff2:0});continue}const a=f[e];let r=0;0!==a.note&&(r=p(a.note+i),r=Math.max(0,Math.min(96,r)));const o=0!==a.note&&a.instrument<20?a.instrument+1:0;let l=0,s=0;const u=0,c=0;switch(a.effect){case 1:0!==a.effectArg&&(l=15,s=a.effectArg);break;case 2:l=1,s=a.effectArg;break;case 3:l=2,s=a.effectArg;break;case 9:l=3,s=a.effectArg;break;case 10:l=12,s=Math.min(64,a.effectArg)}t[n].push({note:r,instrument:o,volume:0,effTyp:l,eff:s,effTyp2:u,eff2:c})}}A.push({id:`pattern-${e}`,name:`Position ${e}`,length:16,channels:t.map((e,t)=>({id:`channel-${t}`,name:`Channel ${t+1}`,muted:!1,solo:!1,collapsed:!1,volume:100,pan:0===t||3===t?-50:50,instrumentId:null,color:null,rows:e})),importMetadata:{sourceFormat:"DM1",sourceFile:n,importedAt:(new Date).toISOString(),originalChannelCount:4,originalPatternCount:y,originalInstrumentCount:d.filter(e=>e.sampleLength>0).length}})}0===A.length&&A.push({id:"pattern-0",name:"Pattern 0",length:16,channels:Array.from({length:4},(e,t)=>({id:`channel-${t}`,name:`Channel ${t+1}`,muted:!1,solo:!1,collapsed:!1,volume:100,pan:0===t||3===t?-50:50,instrumentId:null,color:null,rows:Array.from({length:16},()=>({note:0,instrument:0,volume:0,effTyp:0,eff:0,effTyp2:0,eff2:0}))})),importMetadata:{sourceFormat:"DM1",sourceFile:n,importedAt:(new Date).toISOString(),originalChannelCount:4,originalPatternCount:0,originalInstrumentCount:0}});return{name:n.replace(/.[^/.]+$/,""),format:"MOD",patterns:A,instruments:S,songPositions:A.map((e,t)=>t),songLength:A.length,restartPosition:0,numChannels:4,initialSpeed:6,initialBPM:125,linearPeriods:!1}}export{u as isDeltaMusic1Format,c as parseDeltaMusic1File};
