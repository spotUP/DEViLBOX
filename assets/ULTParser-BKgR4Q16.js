import{aB as t}from"./index-zx6LJBPK.js";import"./vendor-react-DkDaD07v.js";import"./vendor-utils-XMmR-oGw.js";import"./vendor-tone-CADp_hfL.js";import"./vendor-ui-uomqNFY-.js";function e(t,e){return t.getUint8(e)}function n(t,e){return t.getInt16(e,!0)}function r(t,e){return t.getUint16(e,!0)}function o(t,e){return t.getUint32(e,!0)}function a(t,e,n){let r="";for(let o=0;o<n;o++){const n=t.getUint8(e+o);if(0===n)break;r+=String.fromCharCode(n)}return r.trim()}const s="MAS_UTrack_V00",i=64;function l(t,e,n){switch(15&t){case 0:return 0!==e&&n>=51?[0,e]:[0,0];case 1:return[1,e];case 2:return[2,e];case 3:return[3,e];case 4:return[4,e];case 5:return 2==(15&e)||32==(240&e)?[14,159]:(12==(15&e)||192==(240&e))&&n>=51?[255,0]:[0,0];case 6:return[0,0];case 7:return n>=52?[7,e]:[0,0];case 8:return[0,0];case 9:return[9,e];case 10:return 240&e?[10,240&e]:[10,e];case 11:return[8,17*(15&e)];case 12:return[12,Math.min(64,e)];case 13:return[13,10*(e>>4)+(15&e)];case 14:{const t=15&e;switch(e>>4){case 1:return[1,240|t];case 2:return[2,240|t];case 8:return n>=52?[14,96|t]:[0,0];case 9:return[14,144|t];case 10:return[10,t<<4|15];case 11:return[10,240|t];case 12:return[14,192|t];case 13:return[14,208|t];default:return[0,0]}}case 15:return[15,e];default:return[0,0]}}function u(t){if(t.byteLength<48)return!1;const e=new DataView(t);for(let r=0;r<14;r++)if(e.getUint8(r)!==s.charCodeAt(r))return!1;const n=e.getUint8(14);return!(n<49||n>52)}function c(t,e,n,r){const o=t.length>>1,a=2*o,s=44+a,i=new ArrayBuffer(s),l=new DataView(i),u=(t,e)=>{for(let n=0;n<e.length;n++)l.setUint8(t+n,e.charCodeAt(n))};u(0,"RIFF"),l.setUint32(4,s-8,!0),u(8,"WAVE"),u(12,"fmt "),l.setUint32(16,16,!0),l.setUint16(20,1,!0),l.setUint16(22,1,!0),l.setUint32(24,e,!0),l.setUint32(28,2*e,!0),l.setUint16(32,2,!0),l.setUint16(34,16,!0),u(36,"data"),l.setUint32(40,a,!0);return new Uint8Array(i,44).set(t.subarray(0,2*o)),i}function f(t){const e=new Uint8Array(t);let n="";for(let r=0;r<e.length;r+=8192)n+=String.fromCharCode(...Array.from(e.subarray(r,Math.min(r+8192,e.length))));return`data:audio/wav;base64,${btoa(n)}`}async function p(s,p){if(!u(s))throw new Error("ULTParser: not a valid UltraTracker file");const m=new DataView(s),g=new Uint8Array(s);let h=0;const d=m.getUint8(14),U=a(m,15,32)||p.replace(/\.[^/.]+$/,"");h=48,h+=32*m.getUint8(47);const y=m.getUint8(h);h+=1;const w=[];for(let t=0;t<y;t++){const s=h,i=a(m,s,32),l=a(m,s+32,12),u=o(m,s+44),c=o(m,s+48),f=o(m,s+52),p=o(m,s+56),g=e(m,s+60),U=e(m,s+61);let y,b;d>=52?(y=r(m,s+62),b=n(m,s+64),h+=66):(b=r(m,s+62),y=8363,h+=64),w.push({name:i||`Sample ${t+1}`,filename:l,loopStart:u,loopEnd:c,sizeStart:f,sizeEnd:p,volume:g,flags:U,speed:y,finetune:b})}const b=[];let S=0;for(let t=0;t<256;t++){const e=m.getUint8(h+t);if(255===e)break;if(254===e){S=b.length;break}b.push(e)}h+=256;const v=m.getUint8(h)+1;h+=1;const A=m.getUint8(h)+1;h+=1;const C=[];for(let t=0;t<v;t++)if(d>=51){const e=16*(15&m.getUint8(h+t))+8;C.push(Math.round((e-128)/128*50))}else C.push(1&t?25:-25);d>=51&&(h+=v);const T=Array.from({length:A},()=>Array.from({length:v},()=>new Array(i).fill(null))),M=()=>({note:0,instrument:0,volume:0,effTyp:0,eff:0,effTyp2:0,eff2:0});for(let t=0;t<A;t++)for(let e=0;e<v;e++)for(let n=0;n<i;n++)T[t][e][n]=M();for(let t=0;t<v;t++)for(let e=0;e<A;e++){let n=0;for(;n<i&&!(h>=s.byteLength);){let r=1,o=g[h++];if(252===o){if(h+1>=s.byteLength)break;r=g[h++],o=g[h++]}if(h+4>s.byteLength)break;const a=g[h++],u=g[h++],c=g[h++],f=g[h++];let p=0;o>0&&o<97&&(p=o+24);const[m,U]=l(15&u,c,d),[y,w]=l(u>>4,f,d);let b=p,S=m,v=U,A=y,C=w;if(255===m&&(b=97,S=0,v=0),255===y&&(b=97,A=0,C=0),r+n>i&&(r=i-n),0===r)break;const M={note:b,instrument:a,volume:0,effTyp:S,eff:v,effTyp2:A,eff2:C};for(let s=0;s<r;s++)T[e][t][n+s]={...M};n+=r}}let k=h;const E=[];for(let t=0;t<y;t++){const e=w[t],n=e.sizeEnd>e.sizeStart?e.sizeEnd-e.sizeStart:0;n>0&&k+n<=s.byteLength?(E.push(g.slice(k,k+n)),k+=n):(E.push(null),n>0&&(k+=n))}const L=[];for(let e=0;e<y;e++){const n=w[e],r=e+1,o=E[e],a=!!(4&n.flags),s=!!(8&n.flags),i=!!(16&n.flags),l=2*n.speed;if(!o||0===o.length){L.push({id:r,name:n.name,type:"sample",synthType:"Sampler",effects:[],volume:-60,pan:0});continue}let u=0,p=0;if(s){u=a?n.loopStart>>1:n.loopStart,p=a?n.loopEnd>>1:n.loopEnd;const t=a?o.length>>1:o.length;p=Math.min(p,t)}const m=Math.round(n.volume/4);if(a){const t=c(o,l),e=f(t),a=s&&p>u,g=i?"pingpong":"forward";L.push({id:r,name:n.name.replace(/\0/g,"").trim()||`Sample ${r}`,type:"sample",synthType:"Sampler",effects:[],volume:m>0?20*Math.log10(m/64):-60,pan:0,sample:{audioBuffer:t,url:e,baseNote:"C3",detune:0,loop:a,loopType:a?g:"off",loopStart:u,loopEnd:p>0?p:o.length>>1,sampleRate:l,reverse:!1,playbackRate:1}})}else{const e=s&&p>u?p:0;L.push(t(r,n.name,o,m,l,u,e))}}const $=[];for(let t=0;t<A;t++){const e=Array.from({length:v},(e,n)=>({id:`channel-${n}`,name:`Channel ${n+1}`,muted:!1,solo:!1,collapsed:!1,volume:100,pan:C[n]??0,instrumentId:null,color:null,rows:T[t][n]}));$.push({id:`pattern-${t}`,name:`Pattern ${t}`,length:i,channels:e,importMetadata:{sourceFormat:"ULT",sourceFile:p,importedAt:(new Date).toISOString(),originalChannelCount:v,originalPatternCount:A,originalInstrumentCount:y}})}return{name:U,format:"MOD",patterns:$,instruments:L,songPositions:b,songLength:b.length,restartPosition:S,numChannels:v,initialSpeed:4,initialBPM:125,linearPeriods:!1}}export{u as isULTFormat,p as parseULTFile};
