import{aB as n,aD as e,aC as t}from"./index-zx6LJBPK.js";import"./vendor-react-DkDaD07v.js";import"./vendor-utils-XMmR-oGw.js";import"./vendor-tone-CADp_hfL.js";import"./vendor-ui-uomqNFY-.js";const r=1464,o=[77,84,78,0],s=[73,84,49,48],a=[-50,50,50,-50],i=new TextDecoder("iso-8859-1");function l(n,e,t){let r=e;for(;r<e+t&&0!==n[r];)r++;return i.decode(n.subarray(e,r)).trim()}function u(n,e){return n[e]<<8|n[e+1]}function f(n,e,t){for(let r=0;r<t.length;r++)if(n[e+r]!==t[r])return!1;return!0}function m(n){if(n.byteLength<1468)return!1;const e=new Uint8Array(n);if(!f(e,r,o)&&!f(e,r,s))return!1;const t=e[950];return t>=1&&t<=128}async function c(s,i){const c=new Uint8Array(s);if(!m(s))throw new Error("ICEParser: not a valid Ice Tracker / SoundTracker 2.6 file");f(c,r,o);const p=l(c,0,20)||i.replace(/\.[^/.]+$/,""),d=[];for(let n=0;n<31;n++){const e=20+30*n,t=l(c,e,22),r=u(c,e+22),o=15&c[e+24],s=o>7?o-16:o,a=Math.min(c[e+25],64),i=u(c,e+26),f=u(c,e+28);d.push({name:t,lengthWords:r,finetune:s,volume:a,loopStartWords:i,loopLenWords:f})}const h=c[950],y=c[951],g=c.subarray(952,1464),v=[];for(let n=0;n<y;n++){const r=1468+256*n,o=[];for(let n=0;n<64;n++){const s=r+4*n,a=c[s],i=c[s+1],l=c[s+2],u=c[s+3],f=(15&a)<<8|i,m=240&a|l>>4,p=15&l;let d=p,h=u;14===p&&u>=16&&(d=0,h=0);const y=f>0?e(f):0,g=t(y);o.push({note:g,instrument:m,effTyp:d,eff:h})}v.push(o)}const C=[];for(let n=0;n<h;n++){const e=Array.from({length:4},(e,t)=>{const r=g[4*n+t],o=(r<v.length?v[r]:Array.from({length:64},()=>({note:0,instrument:0,effTyp:0,eff:0}))).map(n=>({note:n.note,instrument:n.instrument,volume:0,effTyp:n.effTyp,eff:n.eff,effTyp2:0,eff2:0}));return{id:`channel-${t}`,name:`Channel ${t+1}`,muted:!1,solo:!1,collapsed:!1,volume:100,pan:a[t],instrumentId:null,color:null,rows:o}});C.push({id:`pattern-${n}`,name:`Pattern ${n}`,length:64,channels:e,importMetadata:{sourceFormat:"ICE",sourceFile:i,importedAt:(new Date).toISOString(),originalChannelCount:4,originalPatternCount:h,originalInstrumentCount:31}})}let S=1468+256*y;const T=[];for(let e=0;e<31;e++){const t=d[e],r=e+1,o=2*t.lengthWords;if(0===o){T.push({id:r,name:t.name||`Sample ${r}`,type:"sample",synthType:"Sampler",effects:[],volume:-60,pan:0});continue}const s=Math.min(S+o,c.byteLength),a=c.subarray(S,s);S+=o;const i=2*t.loopStartWords,l=2*t.loopLenWords,u=t.loopLenWords>1,f=u?i:0,m=u?i+l:0;T.push(n(r,t.name||`Sample ${r}`,a,t.volume,8287,f,m))}return{name:p,format:"MOD",patterns:C,instruments:T,songPositions:Array.from({length:h},(n,e)=>e),songLength:h,restartPosition:0,numChannels:4,initialSpeed:6,initialBPM:125,linearPeriods:!1}}export{m as isICEFormat,c as parseICEFile};
