import{aB as e}from"./index-zx6LJBPK.js";import"./vendor-react-DkDaD07v.js";import"./vendor-utils-XMmR-oGw.js";import"./vendor-tone-CADp_hfL.js";import"./vendor-ui-uomqNFY-.js";function t(e,t){return e.getUint8(t)}function n(e,t){return e.getUint16(t,!0)}function r(e,t){return e.getUint32(t,!0)}function o(e,t,n){let r="";for(let o=0;o<n;o++){const n=e.getUint8(t+o);if(0===n)break;r+=String.fromCharCode(n)}return r.trim()}function a(e,t,n){let r="";for(let o=0;o<n;o++)r+=String.fromCharCode(e.getUint8(t+o));return r}const s=64;function f(e){const t=15&e;return 16*(t<8?t:t-16)}function l(e,t){switch(e){case 0:return{effTyp:0,eff:t};case 1:return{effTyp:1,eff:t};case 2:return{effTyp:2,eff:t};case 3:return{effTyp:3,eff:t};case 4:return{effTyp:4,eff:t};case 5:return{effTyp:5,eff:t};case 6:return{effTyp:6,eff:t};case 7:return{effTyp:7,eff:t};case 8:return{effTyp:8,eff:t};case 9:return{effTyp:9,eff:t};case 10:return{effTyp:10,eff:t};case 11:return{effTyp:11,eff:t};case 12:return{effTyp:12,eff:Math.min(t,64)};case 13:return{effTyp:13,eff:t};case 14:return{effTyp:14,eff:t};case 15:return{effTyp:15,eff:t};default:return{effTyp:0,eff:0}}}function i(e,t,n,r,o,a,s){const f=s>a&&s>2,l=function(e,t){const n=e.length,r=2*n,o=44+r,a=new ArrayBuffer(o),s=new DataView(a),f=(e,t)=>{for(let n=0;n<t.length;n++)s.setUint8(e+n,t.charCodeAt(n))};f(0,"RIFF"),s.setUint32(4,o-8,!0),f(8,"WAVE"),f(12,"fmt "),s.setUint32(16,16,!0),s.setUint16(20,1,!0),s.setUint16(22,1,!0),s.setUint32(24,t,!0),s.setUint32(28,2*t,!0),s.setUint16(32,2,!0),s.setUint16(34,16,!0),f(36,"data"),s.setUint32(40,r,!0);let l=44;for(let i=0;i<n;i++)s.setInt16(l,e[i],!0),l+=2;return a}(n,o),i=new Uint8Array(l);let u="";for(let c=0;c<i.length;c+=8192)u+=String.fromCharCode(...Array.from(i.subarray(c,Math.min(c+8192,i.length))));const m=`data:audio/wav;base64,${btoa(u)}`;return{id:e,name:t.replace(/\0/g,"").trim()||`Sample ${e}`,type:"sample",synthType:"Sampler",effects:[],volume:r>0?20*Math.log10(r/64):-60,pan:0,sample:{audioBuffer:l,url:m,baseNote:"C3",detune:0,loop:f,loopType:f?"forward":"off",loopStart:a,loopEnd:s>0?s:n.length,sampleRate:o,reverse:!1,playbackRate:1},metadata:{modPlayback:{usePeriodPlayback:!0,periodMultiplier:3546895,finetune:0,defaultVolume:r}}}}function u(e,t){return{id:e,name:t||`Sample ${e}`,type:"sample",synthType:"Sampler",effects:[],volume:-60,pan:0}}function m(e){if(e.byteLength<12)return!1;const n=new DataView(e);if("RIFF"===a(n,0,4)&&"DSMF"===a(n,8,4))return!0;if("DSMF"===a(n,0,4))return!0;if(e.byteLength>=5){if("DSm"===a(n,0,4)&&32===t(n,4))return!0}return!1}function c(e,a){return{filename:o(e,a,13),flags:n(e,a+13),volume:t(e,a+15),length:r(e,a+16),loopStart:r(e,a+20),loopEnd:r(e,a+24),sampleRate:r(e,a+32),sampleName:o(e,a+36,28)}}function p(f,m,p){const h=f.byteLength;let d=12;if(d+8>h)throw new Error("DSMParser(RIFF): file too small for SONG chunk header");const g=a(f,d,4);if("SONG"!==g)throw new Error(`DSMParser(RIFF): expected SONG chunk, found "${g}"`);const y=r(f,d+4);d+=8;const S=function(e,r,a){const s=r+a,f=o(e,r,28),l=a>29?n(e,r+28):0,i=a>31?n(e,r+30):0,u=a>35?n(e,r+34):0,m=a>37?n(e,r+36):0,c=a>39?n(e,r+38):0,p=a>41?n(e,r+40):0,h=a>43?n(e,r+42):1,d=a>44?t(e,r+44):64,g=a>45?t(e,r+45):128,y=a>46?t(e,r+46):6,S=a>47?t(e,r+47):125,w=[];for(let n=0;n<16;n++){const o=r+48+n;w.push(o<s?t(e,o):64)}const M=[];for(let n=0;n<128;n++){const o=r+64+n;M.push(o<s?t(e,o):255)}return{songName:f,fileVersion:l,flags:i,restartPos:u,numOrders:m,numSamples:c,numPatterns:p,numChannels:h,globalVol:d,masterVol:g,speed:y,bpm:S,panPos:w,orders:M}}(f,d,y);if(d+=y,S.numOrders>128||S.numChannels>16||S.numPatterns>256||S.restartPos>128)throw new Error("DSMParser(RIFF): invalid song header values");const w=Math.max(S.numChannels,1),M=[];for(let e=0;e<S.numOrders;e++){const t=S.orders[e];if(255===t)break;254!==t&&M.push(t)}const P=[];for(let e=0;e<w;e++){const t=S.panPos[e];P.push(t<=128?2*t:128)}const T=[],D=[];for(;d+8<=h;){const n=a(f,d,4),o=r(f,d+4),g=d+8;if(d+=8+o,g+o>h)break;if("PATT"===n){const e=T.length,n=Array.from({length:w},(e,t)=>({id:`channel-${t}`,name:`Channel ${t+1}`,muted:!1,solo:!1,collapsed:!1,volume:100,pan:(P[t]??128)-128,instrumentId:null,color:null,rows:Array.from({length:s},()=>({note:0,instrument:0,volume:0,effTyp:0,eff:0,effTyp2:0,eff2:0}))}));let r=g+2,a=0;for(;r<g+o&&a<s;){const e=t(f,r++);if(0===e){a++;continue}const o=15&e,s=o<w?n[o].rows[a]:{note:0,instrument:0,volume:0,effTyp:0,eff:0};if(128&e){const e=t(f,r++);e>0&&e<=108?s.note=e+11+1:e>0&&(s.note=e)}if(64&e&&(s.instrument=t(f,r++)),32&e&&(s.volume=Math.min(t(f,r++),64)),16&e){const e=t(f,r++),n=t(f,r++),{effTyp:o,eff:a}=l(e,n);s.effTyp=o,s.eff=a}}T.push({id:`pattern-${e}`,name:`Pattern ${e}`,length:s,channels:n,importMetadata:{sourceFormat:"DSM",sourceFile:p,importedAt:(new Date).toISOString(),originalChannelCount:w,originalPatternCount:S.numPatterns,originalInstrumentCount:S.numSamples}})}else if("INST"===n){const t=D.length+1;if(g+64>h){D.push(u(t,`Sample ${t}`));continue}const n=c(f,g),r=g+64,a=Math.min(n.length,g+o-r),s=Math.min(n.volume,64),l=n.sampleName||n.filename||`Sample ${t}`,p=!!(1&n.flags),d=!!(4&n.flags),y=!!(64&n.flags),S=!!(2&n.flags),w=p?n.loopStart:0,M=p?n.loopEnd:0,P=n.sampleRate||8363;if(a<=0||r+a>h){D.push(u(t,l));continue}if(d){const e=Math.floor(a/2),n=new Int16Array(e);for(let t=0;t<e;t++)n[t]=f.getInt16(r+2*t,!0);D.push(i(t,l,n,s,P,w,M))}else{let n=m.slice(r,r+a);if(y){const r=new Uint8Array(a);let o=0;for(let e=0;e<a;e++)o=o+n[e]&255,r[e]=o;n=r;const f=new Uint8Array(a);for(let e=0;e<a;e++)f[e]=128^n[e];n=f,D.push(e(t,l,n,s,P,w,M))}else if(S)D.push(e(t,l,n,s,P,w,M));else{const r=new Uint8Array(a);for(let e=0;e<a;e++)r[e]=128^n[e];D.push(e(t,l,r,s,P,w,M))}}}}for(;D.length<S.numSamples;){const e=D.length+1;D.push(u(e,`Sample ${e}`))}const b=Math.min(S.restartPos,Math.max(0,M.length-1));return{name:S.songName||p.replace(/\.[^/.]+$/,""),format:"MOD",patterns:T,instruments:D,songPositions:M,songLength:M.length,restartPosition:b,numChannels:w,initialSpeed:S.speed||6,initialBPM:S.bpm||125,linearPeriods:!1}}function h(e,r){return{name:o(e,r,22),type:t(e,r+22),length:n(e,r+23),finetune:t(e,r+25),volume:t(e,r+26),loopStart:n(e,r+27),loopLength:n(e,r+29)}}function d(n,r,a){const m=n.byteLength,c=function(e){return{title:o(e,5,20),artist:o(e,25,20),numChannels:t(e,45),numSamples:t(e,46),numOrders:t(e,47),packInformation:t(e,48),globalVol:t(e,49)}}(n),{numChannels:p,numSamples:d,numOrders:g,globalVol:y}=c;if(p<1||p>16||0===d||0===g)throw new Error("DSMParser(DSm): invalid file header values");const S=p;let w=64;const M=[];for(let e=0;e<S;e++)w>=m?M.push(128):M.push(17*(15&t(n,w++)));const P=[];for(let e=0;e<g&&!(w>=m);e++)P.push(t(n,w++));let T=0;for(const e of P)e>T&&(T=e);const D=T+1,b=[],C=D*S*8;if(w+C>m)throw new Error("DSMParser(DSm): file truncated at track names");for(let e=0;e<S;e++)b.push(o(n,w+8*e,8)||`Channel ${e+1}`);if(w+=C,w+32*d>m)throw new Error("DSMParser(DSm): file truncated at sample headers");const F=[];for(let e=0;e<d;e++)F.push(h(n,w)),w+=32;const v=D*S*s*4;if(w+v>m)throw new Error("DSMParser(DSm): file truncated at pattern data");const I=[];for(let e=0;e<D;e++){const r=Array.from({length:S},(e,t)=>({id:`channel-${t}`,name:b[t]??`Channel ${t+1}`,muted:!1,solo:!1,collapsed:!1,volume:100,pan:(M[t]??128)-128,instrumentId:null,color:null,rows:[]}));for(let o=0;o<s;o++)for(let a=0;a<S;a++){const f=w+4*(e*S*s+o*S+a),i=t(n,f),u=t(n,f+1),m=t(n,f+2),c=t(n,f+3),p=u>0&&u<=168?1+(u>>1)+35:0;let h=0,d=c,g=0,y=0;if(8===m)switch(240&c){case 0:h=14,d=128|c;break;case 16:h=10,d=(15&c)<<4;break;case 32:h=14,d=160|c;break;case 48:case 64:h=14,d=c-32;break;default:h=0,d=0}else if(19===m){h=8;let e=2*(127&c);c<=64?e+=128:c<128?e=384-e:c<192?e=128-e:e-=128,d=Math.min(255,Math.max(0,e))}else if(32==(240&m))h=9,d=c,g=1,y=4*(15&m)+4;else if(m<=15||17===m||18===m){const e=l(17===m||18===m?m-16:m,c);h=e.effTyp,d=e.eff}const M={note:p,instrument:i,volume:0!==g?y:0,effTyp:h,eff:d,effTyp2:0,eff2:0};r[a].rows.push(M)}I.push({id:`pattern-${e}`,name:`Pattern ${e}`,length:s,channels:r,importMetadata:{sourceFormat:"DSM",sourceFile:a,importedAt:(new Date).toISOString(),originalChannelCount:S,originalPatternCount:D,originalInstrumentCount:d}})}w+=v;const U=[];for(let t=0;t<d;t++){const o=F[t],a=t+1,s=o.name||`Sample ${a}`,l=Math.min(o.volume,64),c=16===o.type,p=2*o.length,h=o.loopLength>2,d=h?o.loopStart:0,g=h?o.loopStart+o.loopLength:0,y=8363,S=f(o.finetune);if(p<=0||w+p>m)U.push(u(a,s)),w+=Math.max(0,Math.min(p,m-w));else{if(c){const e=p/2,t=new Int16Array(e);for(let o=0;o<e;o++)t[o]=n.getInt16(w+2*o,!0);const r=i(a,s,t,l,y,d,g);r.metadata?.modPlayback&&(r.metadata.modPlayback.finetune=S),U.push(r)}else{const t=r.slice(w,w+p),n=e(a,s,t,l,y,d,g);n.metadata?.modPlayback&&(n.metadata.modPlayback.finetune=S),U.push(n)}w+=p}}const $=Math.round(256*y/100);return{name:c.title||a.replace(/\.[^/.]+$/,""),format:"MOD",patterns:I,instruments:U,songPositions:P,songLength:P.length,restartPosition:0,numChannels:S,initialSpeed:6,initialBPM:125,linearPeriods:!1,compatFlags:{globalVolume:$}}}async function g(e,t){if(!m(e))throw new Error("DSMParser: file does not match DSIK RIFF DSMF or Dynamic Studio DSm format");const n=new DataView(e),r=new Uint8Array(e),o=a(n,0,4);return"RIFF"===o||"DSMF"===o?p(n,r,t):d(n,r,t)}export{m as isDSMFormat,g as parseDSMFile};
