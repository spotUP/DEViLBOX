import{j as e}from"./index-zx6LJBPK.js";import{r as t}from"./vendor-utils-XMmR-oGw.js";import"./vendor-react-DkDaD07v.js";import"./vendor-tone-CADp_hfL.js";import"./vendor-ui-uomqNFY-.js";const n=0,a=1,o=2,r=5,l=6,s=7,i=8,c=9,u=632,d=400,m=["sine","square","rampDown","rampUp"];function p(e){const t=new Uint8Array(126),n=e.sample,a=e.metadata?.modPlayback,o=e.metadata?.originalEnvelope,r=e.metadata?.panningEnvelope,l=e.metadata?.autoVibrato;t[0]=a?.defaultVolume??64,t[1]=a?.panning??128;const s=a?.finetune??0;t[2]=255&s,t[3]=s>>8&255,t[4]=a?.relativeNote??0;const i=n?.loopType;t[5]="forward"===i?1:"pingpong"===i?2:0;const c=n?.loopStart??0;t[6]=255&c,t[7]=c>>8&255,t[8]=c>>16&255,t[9]=c>>24&255;const u=Math.max(0,(n?.loopEnd??0)-(n?.loopStart??0));t[10]=255&u,t[11]=u>>8&255,t[12]=u>>16&255,t[13]=u>>24&255;const d=e.metadata?.fadeout??0;t[14]=255&d,t[15]=d>>8&255,t[16]=m.indexOf(l?.type??"sine"),t[17]=l?.sweep??0,t[18]=l?.depth??0,t[19]=l?.rate??0;const p=o?.points??[{tick:0,value:64},{tick:325,value:0}];t[20]=o?.enabled?1:0,t[21]=null!=o?.sustainPoint?o.sustainPoint:255,t[22]=null!=o?.loopStartPoint?o.loopStartPoint:255,t[23]=null!=o?.loopEndPoint?o.loopEndPoint:255;for(let m=0;m<12;m++){const e=24+4*m;if(m<p.length){const n=p[m].tick,a=p[m].value;t[e]=255&n,t[e+1]=n>>8&255,t[e+2]=255&a,t[e+3]=a>>8&255}}const f=r?.points??[{tick:0,value:32},{tick:325,value:32}];t[72]=r?.enabled?1:0,t[73]=null!=r?.sustainPoint?r.sustainPoint:255,t[74]=null!=r?.loopStartPoint?r.loopStartPoint:255,t[75]=null!=r?.loopEndPoint?r.loopEndPoint:255;for(let m=0;m<12;m++){const e=76+4*m;if(m<f.length){const n=f[m].tick,a=f[m].value;t[e]=255&n,t[e+1]=n>>8&255,t[e+2]=255&a,t[e+3]=a>>8&255}}return t[124]=p.length,t[125]=f.length,t}function f(e,t,n,a,o,r,l){const s=e.metadata?.[t],i=[...s?.points??[]];for(;i.length>l;)i.pop();for(;i.length<l;){const e=i.length>0?i[i.length-1].tick+10:0;i.push({tick:e,value:"originalEnvelope"===t?64:32})}return{metadata:{...e.metadata,[t]:{...s,enabled:0!==n,points:i,sustainPoint:255===a||a<0?null:a,loopStartPoint:255===o||o<0?null:o,loopEndPoint:255===r||r<0?null:r}}}}const h=({instrument:h,onChange:v})=>{const g=t.useRef(h),_=t.useRef(null),E=t.useRef(null),[y,P]=t.useState(!1),[w,b]=t.useState(null),k=t.useRef(v),x=t.useRef(44100),C=t.useRef(null),S=t.useRef(null);t.useEffect(()=>{g.current=h},[h]),t.useEffect(()=>{k.current=v},[v]),t.useEffect(()=>{const e=_.current;if(!e||!y)return;const t=p(h),n=e._malloc(t.length);n&&(e.HEAPU8.set(t,n),e._ft2_sampled_load_config(n,t.length),e._free(n))},[h,y]);const F=(e,t)=>{const n=e.getBoundingClientRect(),a=e.width/n.width,o=e.height/n.height;return[Math.floor((t.clientX-n.left)*a),Math.floor((t.clientY-n.top)*o)]};return t.useEffect(()=>{if(!E.current)return;const e=E.current;let t=!1,h=null;const v=[];return async function(){try{const E=await new Promise((e,t)=>{const n=window.createFT2SampEd;if("function"==typeof n)return void e(n);const a=document.createElement("script");a.src="/ft2/FT2SampEd.js",a.onload=()=>{const n=window.createFT2SampEd;"function"==typeof n?e(n):t(new Error("createFT2SampEd not found after script load"))},a.onerror=()=>t(new Error("Failed to load FT2SampEd.js")),document.head.appendChild(a)});if(t)return;h=await E({}),_.current=h,h.onParamChange=(e,t)=>{const u=g.current,d={};switch(e){case n:d.metadata={...u.metadata,modPlayback:{...u.metadata?.modPlayback,usePeriodPlayback:u.metadata?.modPlayback?.usePeriodPlayback??!1,periodMultiplier:u.metadata?.modPlayback?.periodMultiplier??3546895,finetune:u.metadata?.modPlayback?.finetune??0,defaultVolume:t}};break;case a:d.metadata={...u.metadata,modPlayback:{...u.metadata?.modPlayback,usePeriodPlayback:u.metadata?.modPlayback?.usePeriodPlayback??!1,periodMultiplier:u.metadata?.modPlayback?.periodMultiplier??3546895,finetune:u.metadata?.modPlayback?.finetune??0,panning:t}};break;case o:d.metadata={...u.metadata,modPlayback:{...u.metadata?.modPlayback,usePeriodPlayback:u.metadata?.modPlayback?.usePeriodPlayback??!1,periodMultiplier:u.metadata?.modPlayback?.periodMultiplier??3546895,finetune:t,defaultVolume:u.metadata?.modPlayback?.defaultVolume??64}};break;case r:d.metadata={...u.metadata,fadeout:t};break;case l:case s:case i:case c:{const n={...u.metadata?.autoVibrato??{type:"sine",sweep:0,depth:0,rate:0}};e===l&&(n.type=m[t]??"sine"),e===s&&(n.sweep=t),e===i&&(n.depth=t),e===c&&(n.rate=t),d.metadata={...u.metadata,autoVibrato:n};break}}Object.keys(d).length>0&&(g.current={...u,...d},k.current(d))},h.onLoopChange=(e,t,n)=>{const a=g.current,o=0===n?"off":1===n?"forward":"pingpong",r={sample:{...a.sample,loopStart:e,loopEnd:e+t,loopType:o,loop:n>0}};g.current={...a,...r},k.current(r)},h.onVolEnvChange=(e,t,n)=>{const a=g.current,o=function(e,t,n,a){const o=e.metadata?.originalEnvelope,r=[...o?.points??[]];for(;r.length<=t;)r.push({tick:0,value:0});return r[t]={tick:n,value:a},{metadata:{...e.metadata,originalEnvelope:{...o,points:r}}}}(a,e,t,n);g.current={...a,...o},k.current(o)},h.onPanEnvChange=(e,t,n)=>{const a=g.current,o=function(e,t,n,a){const o=e.metadata?.panningEnvelope,r=[...o?.points??[]];for(;r.length<=t;)r.push({tick:0,value:32});return r[t]={tick:n,value:a},{metadata:{...e.metadata,panningEnvelope:{...o,points:r}}}}(a,e,t,n);g.current={...a,...o},k.current(o)},h.onVolEnvFlagsChange=(e,t,n,a,o)=>{const r=g.current,l=f(r,"originalEnvelope",e,t,n,a,o);g.current={...r,...l},k.current(l)},h.onPanEnvFlagsChange=(e,t,n,a,o)=>{const r=g.current,l=f(r,"panningEnvelope",e,t,n,a,o);g.current={...r,...l},k.current(l)},h.onPlaySample=(e,t,n,a,o,r)=>{C.current||(C.current=new AudioContext);const l=C.current;if(S.current){try{S.current.stop()}catch{}S.current=null}if(t<=0)return;const s=x.current,i=l.createBuffer(1,t,s),c=i.getChannelData(0);if(r){const n=h.HEAP16.subarray(e>>1,(e>>1)+t);for(let e=0;e<t;e++)c[e]=n[e]/32768}else{const n=new Int8Array(h.HEAPU8.buffer,e,t);for(let e=0;e<t;e++)c[e]=n[e]/128}const u=l.createBufferSource();u.buffer=i,0!==o&&a>2&&(u.loop=!0,u.loopStart=n/s,u.loopEnd=(n+a)/s),u.connect(l.destination),u.start(),S.current=u,u.onended=()=>{S.current===u&&(S.current=null)}},h.onStopSample=()=>{if(S.current){try{S.current.stop()}catch{}S.current=null}},h._ft2_sampled_init(u,d),h._ft2_sampled_start();const y=h,w=t=>{const[n,a]=F(e,t);y._ft2_sampled_on_mouse_down(n,a)},D=t=>{const[n,a]=F(e,t);y._ft2_sampled_on_mouse_up(n,a)},A=t=>{const[n,a]=F(e,t);y._ft2_sampled_on_mouse_move(n,a)},L=t=>{t.preventDefault();const[n,a]=F(e,t);y._ft2_sampled_on_wheel(Math.sign(t.deltaY),n,a)},V=e=>{[37,39].includes(e.keyCode)&&(e.preventDefault(),y._ft2_sampled_on_key_down(e.keyCode))};e.addEventListener("mousedown",w),document.addEventListener("mouseup",D),document.addEventListener("mousemove",A),e.addEventListener("wheel",L,{passive:!1}),e.addEventListener("keydown",V),v.push(()=>e.removeEventListener("mousedown",w),()=>document.removeEventListener("mouseup",D),()=>document.removeEventListener("mousemove",A),()=>e.removeEventListener("wheel",L),()=>e.removeEventListener("keydown",V));const N=p(g.current),j=h._malloc(N.length);j&&(h.HEAPU8.set(N,j),h._ft2_sampled_load_config(j,N.length),h._free(j));const R=e.getContext("2d",{willReadFrequently:!0});if(!R)return void b("Canvas 2D context unavailable");const T=R.createImageData(u,d);let B=0;const M=()=>{t||(y._ft2_sampled_tick&&y._ft2_sampled_tick(),function(e,t,n){const a=e._ft2_sampled_get_fb(),o=e.HEAPU8.subarray(a,a+1011200),r=n.data;for(let l=0;l<252800;l++){const e=4*l;r[e]=o[e+2],r[e+1]=o[e+1],r[e+2]=o[e],r[e+3]=255}t.putImageData(n,0,0)}(y,R,T),B=requestAnimationFrame(M))};B=requestAnimationFrame(M),v.push(()=>cancelAnimationFrame(B)),t||P(!0);const U=await async function(e){const t=e.sample;if(!t)return null;let n=null;try{if(t.audioBuffer&&t.audioBuffer.byteLength>0){const e=new OfflineAudioContext(1,1,44100);n=await e.decodeAudioData(t.audioBuffer.slice(0))}else if(t.url){const e=await fetch(t.url),a=await e.arrayBuffer(),o=new OfflineAudioContext(1,1,44100);n=await o.decodeAudioData(a)}}catch{return null}if(!n)return null;const a=n.getChannelData(0),o=new Int16Array(a.length);for(let r=0;r<a.length;r++){let e=Math.round(32767*a[r]);e>32767&&(e=32767),e<-32768&&(e=-32768),o[r]=e}return{pcm:o,sampleRate:n.sampleRate}}(g.current);if(U&&!t&&h){x.current=U.sampleRate;const e=U.pcm,t=h._malloc(2*e.length);t&&(h.HEAP16.set(e,t>>1),h._ft2_sampled_load_pcm(t,e.length),h._free(t))}}catch(E){t||b(String(E))}}(),()=>{if(t=!0,v.forEach(e=>e()),h)try{h._ft2_sampled_shutdown()}catch{}if(S.current){try{S.current.stop()}catch{}S.current=null}if(C.current){try{C.current.close()}catch{}C.current=null}_.current=null}},[]),e.jsxDEV("div",{className:"ft2-hardware-container flex flex-col items-center",children:[e.jsxDEV("canvas",{ref:E,width:u,height:d,tabIndex:0,style:{width:"100%",maxWidth:632,height:"auto",imageRendering:"pixelated",display:"block"}},void 0,!1,{fileName:"/Users/spot/Code/DEViLBOX/src/components/instruments/hardware/FT2Hardware.tsx",lineNumber:648,columnNumber:7},void 0),!y&&!w&&e.jsxDEV("div",{className:"text-gray-400 text-sm mt-2",children:"Loading FT2 instrument editor..."},void 0,!1,{fileName:"/Users/spot/Code/DEViLBOX/src/components/instruments/hardware/FT2Hardware.tsx",lineNumber:662,columnNumber:9},void 0),w&&e.jsxDEV("div",{className:"text-red-400 text-sm mt-2 text-center",children:["Failed to load FT2 hardware UI: ",w]},void 0,!0,{fileName:"/Users/spot/Code/DEViLBOX/src/components/instruments/hardware/FT2Hardware.tsx",lineNumber:667,columnNumber:9},void 0)]},void 0,!0,{fileName:"/Users/spot/Code/DEViLBOX/src/components/instruments/hardware/FT2Hardware.tsx",lineNumber:647,columnNumber:5},void 0)};export{h as FT2Hardware};
