import{f as e,h as t,i as n,m as s,M as a,j as r,G as o,w as i,k as l,l as c,T as h,n as d,s as p,o as u,p as m,q as g,r as x,D as f,A as v,t as y,v as T}from"./PixiApp-DUEXYeX_.js";import{R as C,S as _,B as k,a as b,b as P,c as M,A as w,C as S}from"./RenderTargetSystem-BARHEHRq.js";import"./index-zx6LJBPK.js";import"./vendor-react-DkDaD07v.js";import"./vendor-utils-XMmR-oGw.js";import"./vendor-tone-CADp_hfL.js";import"./vendor-ui-uomqNFY-.js";import"./react-three-fiber.esm-DUbY8J_y.js";import"./DJKeyboardHandler-Dzr29xNs.js";import"./parseModuleToSong-BCo4MrbT.js";import"./ArrangementKeyboardShortcuts-DvPf7hcZ.js";import"./VJView-BexYXGXr.js";const I=class a{static _getPatternRepeat(e,t){const n=e&&"clamp-to-edge"!==e,s=t&&"clamp-to-edge"!==t;return n&&s?"repeat":n?"repeat-x":s?"repeat-y":"no-repeat"}start(e,t,n){}execute(r,o){const i=o.elements;if(!i||!i.length)return;const l=r.renderer,c=l.canvasContext,h=c.activeContext;for(let d=0;d<i.length;d++){const r=i[d];if(!r.packAsQuad)continue;const p=r,u=p.texture,m=u?e.getCanvasSource(u):null;if(!m)continue;const g=u.source.style,x=c.smoothProperty,f="nearest"!==g.scaleMode;h[x]!==f&&(h[x]=f),c.setBlendMode(o.blendMode);const v=l.globalUniforms.globalUniformData?.worldColor??4294967295,y=p.color,T=(v>>>24&255)/255*((y>>>24&255)/255)*(l.filter?.alphaMultiplier??1);if(T<=0)continue;h.globalAlpha=T;const C=n(s(16777215&y,16777215&v)),_=u.frame,k=g.addressModeU??g.addressMode,b=g.addressModeV??g.addressMode,P=a._getPatternRepeat(k,b),M=u.source._resolution??u.source.resolution??1,w=p.renderable?.renderGroup?.isCachedAsTexture,S=_.x*M,I=_.y*M,R=_.width*M,B=_.height*M,A=p.bounds,j=l.renderTarget.renderTarget.isRoot,E=A.minX,H=A.minY,W=A.maxX-A.minX,q=A.maxY-A.minY,G=u.rotate,D=u.uvs,F=Math.min(D.x0,D.x1,D.x2,D.x3,D.y0,D.y1,D.y2,D.y3),O=Math.max(D.x0,D.x1,D.x2,D.x3,D.y0,D.y1,D.y2,D.y3),U="no-repeat"!==P&&(F<0||O>1),L=G&&!(!U&&(16777215!==C||G));L?(a._tempPatternMatrix.copyFrom(p.transform),t.matrixAppendRotationInv(a._tempPatternMatrix,G,E,H,W,q),c.setContextTransform(a._tempPatternMatrix,1===p.roundPixels,void 0,w&&j)):c.setContextTransform(p.transform,1===p.roundPixels,void 0,w&&j);const N=L?0:E,V=L?0:H,Y=W,z=q;if(U){let t=m;const n=16777215!==C&&!G,s=_.width<=u.source.width&&_.height<=u.source.height;n&&s&&(t=e.getTintedCanvas({texture:u},C));const r=h.createPattern(t,P);if(!r)continue;const o=Y,i=z;if(0===o||0===i)continue;const l=1/o,c=1/i,d=(D.x1-D.x0)*l,p=(D.y1-D.y0)*l,g=(D.x3-D.x0)*c,x=(D.y3-D.y0)*c,f=D.x0-d*N-g*V,v=D.y0-p*N-x*V,y=u.source.pixelWidth,T=u.source.pixelHeight;a._tempPatternMatrix.set(d*y,p*T,g*y,x*T,f*y,v*T),e.applyPatternTransform(r,a._tempPatternMatrix),h.fillStyle=r,h.fillRect(N,V,Y,z)}else{const t=16777215!==C||G?e.getTintedCanvas({texture:u},C):m,n=t!==m;h.drawImage(t,n?0:S,n?0:I,n?t.width:R,n?t.height:B,N,V,Y,z)}}}};I._tempPatternMatrix=new a,I.extension={type:[r.CanvasPipesAdaptor],name:"batch"};let R=I;class B{constructor(e){this._colorStack=[],this._colorStackIndex=0,this._currentColor=0,this._renderer=e}buildStart(){this._colorStack[0]=15,this._colorStackIndex=1,this._currentColor=15}push(e,t,n){this._renderer.renderPipes.batch.break(n);const s=this._colorStack;s[this._colorStackIndex]=s[this._colorStackIndex-1]&e.mask;const a=this._colorStack[this._colorStackIndex];a!==this._currentColor&&(this._currentColor=a,n.add({renderPipeId:"colorMask",colorMask:a,canBundle:!1})),this._colorStackIndex++}pop(e,t,n){this._renderer.renderPipes.batch.break(n);const s=this._colorStack;this._colorStackIndex--;const a=s[this._colorStackIndex-1];a!==this._currentColor&&(this._currentColor=a,n.add({renderPipeId:"colorMask",colorMask:a,canBundle:!1}))}execute(e){}destroy(){this._renderer=null,this._colorStack=null}}function A(e,t){switch(t.type){case"rectangle":{const n=t;e.rect(n.x,n.y,n.width,n.height);break}case"roundedRectangle":{const n=t;!function(e,t,n,s,a,r){r=Math.max(0,Math.min(r,Math.min(s,a)/2)),e.moveTo(t+r,n),e.lineTo(t+s-r,n),e.quadraticCurveTo(t+s,n,t+s,n+r),e.lineTo(t+s,n+a-r),e.quadraticCurveTo(t+s,n+a,t+s-r,n+a),e.lineTo(t+r,n+a),e.quadraticCurveTo(t,n+a,t,n+a-r),e.lineTo(t,n+r),e.quadraticCurveTo(t,n,t+r,n)}(e,n.x,n.y,n.width,n.height,n.radius);break}case"circle":{const n=t;e.moveTo(n.x+n.radius,n.y),e.arc(n.x,n.y,n.radius,0,2*Math.PI);break}case"ellipse":{const n=t;e.ellipse?(e.moveTo(n.x+n.halfWidth,n.y),e.ellipse(n.x,n.y,n.halfWidth,n.halfHeight,0,0,2*Math.PI)):(e.save(),e.translate(n.x,n.y),e.scale(n.halfWidth,n.halfHeight),e.moveTo(1,0),e.arc(0,0,1,0,2*Math.PI),e.restore());break}case"triangle":{const n=t;e.moveTo(n.x,n.y),e.lineTo(n.x2,n.y2),e.lineTo(n.x3,n.y3),e.closePath();break}default:{const n=t,s=n.points;if(!s?.length)break;e.moveTo(s[0],s[1]);for(let t=2;t<s.length;t+=2)e.lineTo(s[t],s[t+1]);n.closePath&&e.closePath();break}}}function j(e,t){if(!t?.length)return!1;for(let n=0;n<t.length;n++){const s=t[n];if(!s?.shape)continue;const a=s.transform,r=a&&!a.isIdentity();r&&(e.save(),e.transform(a.a,a.b,a.c,a.d,a.tx,a.ty)),A(e,s.shape),r&&e.restore()}return!0}B.extension={type:[r.CanvasPipes],name:"colorMask"};class E{constructor(e){this._warnedMaskTypes=new Set,this._canvasMaskStack=[],this._renderer=e}push(e,t,n){this._renderer.renderPipes.batch.break(n),n.add({renderPipeId:"stencilMask",action:"pushMaskBegin",mask:e,inverse:t._maskOptions.inverse,canBundle:!1})}pop(e,t,n){this._renderer.renderPipes.batch.break(n),n.add({renderPipeId:"stencilMask",action:"popMaskEnd",mask:e,inverse:t._maskOptions.inverse,canBundle:!1})}execute(e){if("pushMaskBegin"!==e.action&&"popMaskEnd"!==e.action)return;const t=this._renderer,n=t.canvasContext,s=n?.activeContext;if(!s)return;if("popMaskEnd"===e.action){return void(this._canvasMaskStack.pop()&&s.restore())}e.inverse&&this._warnOnce("inverse","CanvasRenderer: inverse masks are not supported on Canvas2D; ignoring inverse flag.");const a=e.mask.mask;if(!(a instanceof o))return this._warnOnce("nonGraphics","CanvasRenderer: only Graphics masks are supported in Canvas2D; skipping mask."),void this._canvasMaskStack.push(!1);const r=a,i=r.context?.instructions;if(!i?.length)return void this._canvasMaskStack.push(!1);s.save(),n.setContextTransform(r.groupTransform,1===(t._roundPixels|r._roundPixels)),s.beginPath();let l=!1,c=!1;for(let o=0;o<i.length;o++){const e=i[o],t=e.action;if("fill"!==t&&"stroke"!==t)continue;const n=e.data,a=n?.path?.shapePath;if(!a?.shapePrimitives?.length)continue;const r=a.shapePrimitives;for(let o=0;o<r.length;o++){const e=r[o];if(!e?.shape)continue;const t=e.transform,n=t&&!t.isIdentity();n&&(s.save(),s.transform(t.a,t.b,t.c,t.d,t.tx,t.ty)),A(s,e.shape),c=j(s,e.holes)||c,l=!0,n&&s.restore()}}if(!l)return s.restore(),void this._canvasMaskStack.push(!1);c?s.clip("evenodd"):s.clip(),this._canvasMaskStack.push(!0)}destroy(){this._renderer=null,this._warnedMaskTypes=null,this._canvasMaskStack=null}_warnOnce(e,t){this._warnedMaskTypes.has(e)||(this._warnedMaskTypes.add(e),i(t))}}E.extension={type:[r.CanvasPipes],name:"stencilMask"};const H="source-over";const W=new a;class q{constructor(e){this.activeResolution=1,this.smoothProperty="imageSmoothingEnabled",this.blendModes=function(){const e=l(),t=Object.create(null);return t.inherit=H,t.none=H,t.normal="source-over",t.add="lighter",t.multiply=e?"multiply":H,t.screen=e?"screen":H,t.overlay=e?"overlay":H,t.darken=e?"darken":H,t.lighten=e?"lighten":H,t["color-dodge"]=e?"color-dodge":H,t["color-burn"]=e?"color-burn":H,t["hard-light"]=e?"hard-light":H,t["soft-light"]=e?"soft-light":H,t.difference=e?"difference":H,t.exclusion=e?"exclusion":H,t.saturation=e?"saturation":H,t.color=e?"color":H,t.luminosity=e?"luminosity":H,t["linear-burn"]=e?"color-burn":H,t["linear-dodge"]=e?"color-dodge":H,t["linear-light"]=e?"hard-light":H,t["pin-light"]=e?"hard-light":H,t["vivid-light"]=e?"hard-light":H,t["hard-mix"]=H,t.negation=e?"difference":H,t["normal-npm"]=t.normal,t["add-npm"]=t.add,t["screen-npm"]=t.screen,t.erase="destination-out",t.subtract=H,t.divide=H,t.min=H,t.max=H,t}(),this._activeBlendMode="normal",this._projTransform=null,this._outerBlend=!1,this._warnedBlendModes=new Set,this._renderer=e}resolutionChange(e){this.activeResolution=e}init(){const e=this._renderer.background.alpha<1;if(this.rootContext=this._renderer.canvas.getContext("2d",{alpha:e}),this.activeContext=this.rootContext,this.activeResolution=this._renderer.resolution,!this.rootContext.imageSmoothingEnabled){const e=this.rootContext;e.webkitImageSmoothingEnabled?this.smoothProperty="webkitImageSmoothingEnabled":e.mozImageSmoothingEnabled?this.smoothProperty="mozImageSmoothingEnabled":e.oImageSmoothingEnabled?this.smoothProperty="oImageSmoothingEnabled":e.msImageSmoothingEnabled&&(this.smoothProperty="msImageSmoothingEnabled")}}setContextTransform(e,t,n,s){const r=s?a.IDENTITY:this._renderer.globalUniforms.globalUniformData?.worldTransformMatrix||a.IDENTITY;let o=W;o.copyFrom(r),o.append(e);const i=this._projTransform,l=this.activeResolution;if(n=n||l,i){const e=a.shared;e.copyFrom(o),e.prepend(i),o=e}t?this.activeContext.setTransform(o.a*n,o.b*n,o.c*n,o.d*n,o.tx*l|0,o.ty*l|0):this.activeContext.setTransform(o.a*n,o.b*n,o.c*n,o.d*n,o.tx*l,o.ty*l)}clear(e,t){const n=this.activeContext,s=this._renderer;if(n.clearRect(0,0,s.width,s.height),e){const a=c.shared.setValue(e);n.globalAlpha=t??a.alpha,n.fillStyle=a.toHex(),n.fillRect(0,0,s.width,s.height),n.globalAlpha=1}}setBlendMode(e){if(this._activeBlendMode===e)return;this._activeBlendMode=e,this._outerBlend=!1;const t=this.blendModes[e];if(!t)return this._warnedBlendModes.has(e)||this._warnedBlendModes.add(e),void(this.activeContext.globalCompositeOperation="source-over");this.activeContext.globalCompositeOperation=t}destroy(){this.rootContext=null,this.activeContext=null,this._warnedBlendModes.clear()}}q.extension={type:[r.CanvasSystem],name:"canvasContext"};class G{constructor(){this.maxTextures=16,this.maxBatchableTextures=16,this.maxUniformBindings=0}init(){}}G.extension={type:[r.CanvasSystem],name:"limits"};const D=new a,F=new a,O=new a,U=new a;function L(e,t,n){e.beginPath();for(let s=0;s<n.length;s+=3){const a=2*n[s],r=2*n[s+1],o=2*n[s+2];e.moveTo(t[a],t[a+1]),e.lineTo(t[r],t[r+1]),e.lineTo(t[o],t[o+1]),e.closePath()}e.fill()}function N(e,t){switch(t.type){case"rectangle":{const n=t;e.rect(n.x,n.y,n.width,n.height);break}case"roundedRectangle":{const n=t;!function(e,t,n,s,a,r){r=Math.max(0,Math.min(r,Math.min(s,a)/2)),e.moveTo(t+r,n),e.lineTo(t+s-r,n),e.quadraticCurveTo(t+s,n,t+s,n+r),e.lineTo(t+s,n+a-r),e.quadraticCurveTo(t+s,n+a,t+s-r,n+a),e.lineTo(t+r,n+a),e.quadraticCurveTo(t,n+a,t,n+a-r),e.lineTo(t,n+r),e.quadraticCurveTo(t,n,t+r,n)}(e,n.x,n.y,n.width,n.height,n.radius);break}case"circle":{const n=t;e.arc(n.x,n.y,n.radius,0,2*Math.PI);break}case"ellipse":{const n=t;e.ellipse?e.ellipse(n.x,n.y,n.halfWidth,n.halfHeight,0,0,2*Math.PI):(e.save(),e.translate(n.x,n.y),e.scale(n.halfWidth,n.halfHeight),e.arc(0,0,1,0,2*Math.PI),e.restore());break}case"triangle":{const n=t;e.moveTo(n.x,n.y),e.lineTo(n.x2,n.y2),e.lineTo(n.x3,n.y3),e.closePath();break}default:{const n=t,s=n.points;if(!s?.length)break;e.moveTo(s[0],s[1]);for(let t=2;t<s.length;t+=2)e.lineTo(s[t],s[t+1]);n.closePath&&e.closePath();break}}}function V(e,t){if(!t?.length)return!1;for(let n=0;n<t.length;n++){const s=t[n];if(!s?.shape)continue;const a=s.transform,r=a&&!a.isIdentity();r&&(e.save(),e.transform(a.a,a.b,a.c,a.d,a.tx,a.ty)),N(e,s.shape),r&&e.restore()}return!0}function Y(t,n,s,a){const r=t.fill;if(r instanceof m){r.buildGradient();const o=r.texture;if(o){const i=e.getTintedPattern(o,n),l=s?U.copyFrom(s).scale(o.source.pixelWidth,o.source.pixelHeight):U.copyFrom(r.transform);return a&&!t.textureSpace&&l.append(a),e.applyPatternTransform(i,l),i}}if(r instanceof g){const t=e.getTintedPattern(r.texture,n);return e.applyPatternTransform(t,r.transform),t}const o=t.texture;if(o&&o!==h.WHITE){if(!o.source.resource)return"#808080";const a=e.getTintedPattern(o,n),r=s?U.copyFrom(s).scale(o.source.pixelWidth,o.source.pixelHeight):t.matrix;return e.applyPatternTransform(a,r),a}return`#${(16777215&n).toString(16).padStart(6,"0")}`}class z{constructor(){this.shader=null}contextChange(e){}execute(a,r){const o=a.renderer,i=o.canvasContext,l=i.activeContext,c=r.groupTransform,m=o.globalUniforms.globalUniformData?.worldColor??4294967295,g=r.groupColorAlpha,x=(m>>>24&255)/255*((g>>>24&255)/255)*(o.filter?.alphaMultiplier??1);if(x<=0)return;const f=n(s(16777215&g,16777215&m)),v=o._roundPixels|r._roundPixels;l.save(),i.setContextTransform(c,1===v),i.setBlendMode(r.groupBlendMode);const y=r.context.instructions;for(let n=0;n<y.length;n++){const a=y[n];if("texture"===a.action){const n=a.data,r=n.image,o=r?e.getCanvasSource(r):null;if(!o)continue;const h=n.alpha*x;if(h<=0)continue;const d=s(n.style,f);l.globalAlpha=h;let p=o;16777215!==d&&(p=e.getTintedCanvas({texture:r},d));const u=r.frame,m=r.source._resolution??r.source.resolution??1;let g=u.x*m,y=u.y*m;const T=u.width*m,C=u.height*m;p!==o&&(g=0,y=0);const _=n.transform,k=_&&!_.isIdentity(),b=r.rotate;k||b?(D.copyFrom(c),k&&D.append(_),b&&t.matrixAppendRotationInv(D,b,n.dx,n.dy,n.dw,n.dh),i.setContextTransform(D,1===v)):i.setContextTransform(c,1===v),l.drawImage(p,g,y,p===o?T:p.width,p===o?C:p.height,b?0:n.dx,b?0:n.dy,n.dw,n.dh),(k||b)&&i.setContextTransform(c,1===v);continue}const r=a.data,o=r?.path?.shapePath;if(!o?.shapePrimitives?.length)continue;const m=r.style,g=s(m.color,f),T=m.alpha*x;if(T<=0)continue;const C="stroke"===a.action;if(l.globalAlpha=T,C){const e=m;l.lineWidth=e.width,l.lineCap=e.cap,l.lineJoin=e.join,l.miterLimit=e.miterLimit}const _=o.shapePrimitives;if(!C&&r.hole?.shapePath?.shapePrimitives?.length){_[_.length-1].holes=r.hole.shapePath.shapePrimitives}for(let e=0;e<_.length;e++){const t=_[e];if(!t?.shape)continue;const n=t.transform,s=n&&!n.isIdentity(),a=m.texture&&m.texture!==h.WHITE,r="global"===m.textureSpace?n:null,o=Y(m,g,a?d(F,m,t.shape,r):null,s?O.copyFrom(c).append(n):c);if(s&&(l.save(),l.transform(n.a,n.b,n.c,n.d,n.tx,n.ty)),C){const e=m;if(.5!==e.alignment&&!e.pixelLine){const n=[],s=[],a=[],r=p[t.shape.type];if(r?.build(t.shape,n)){const r=t.shape.closePath??!0;u(n,e,!1,r,s,a),l.fillStyle=o,L(l,s,a)}else l.strokeStyle=o,l.beginPath(),N(l,t.shape),l.stroke()}else l.strokeStyle=o,l.beginPath(),N(l,t.shape),l.stroke()}else{l.fillStyle=o,l.beginPath(),N(l,t.shape);V(l,t.holes)?l.fill("evenodd"):l.fill()}s&&l.restore()}}l.restore()}destroy(){this.shader=null}}z.extension={type:[r.CanvasPipesAdaptor],name:"graphics"};class J{init(e,t){this._renderer=e,this._renderTargetSystem=t}initGpuRenderTarget(e){const t=e.colorTexture,{canvas:n,context:s}=this._ensureCanvas(t);return{canvas:n,context:s,width:n.width,height:n.height}}resizeGpuRenderTarget(e){const t=e.colorTexture,{canvas:n}=this._ensureCanvas(t);n.width=e.pixelWidth,n.height=e.pixelHeight}startRenderPass(e,t,n,s){const a=this._renderTargetSystem.getGpuRenderTarget(e);this._renderer.canvasContext.activeContext=a.context,this._renderer.canvasContext.activeResolution=e.resolution,t&&this.clear(e,t,n,s)}clear(e,t,n,s){const a=this._renderTargetSystem.getGpuRenderTarget(e).context,r=s||{x:0,y:0,width:e.pixelWidth,height:e.pixelHeight};if(a.setTransform(1,0,0,1,0,0),a.clearRect(r.x,r.y,r.width,r.height),n){const e=c.shared.setValue(n);e.alpha>0&&(a.globalAlpha=e.alpha,a.fillStyle=e.toHex(),a.fillRect(r.x,r.y,r.width,r.height),a.globalAlpha=1)}}finishRenderPass(){}copyToTexture(e,t,n,s,a){const r=this._renderTargetSystem.getGpuRenderTarget(e).canvas,o=t.source,{context:i}=this._ensureCanvas(o),l=a?.x??0,c=a?.y??0;return i.drawImage(r,n.x,n.y,s.width,s.height,l,c,s.width,s.height),o.update(),t}destroyGpuRenderTarget(e){}_ensureCanvas(e){let t=e.resource;t&&x.test(t)||(t=f.get().createCanvas(e.pixelWidth,e.pixelHeight),e.resource=t),t.width===e.pixelWidth&&t.height===e.pixelHeight||(t.width=e.pixelWidth,t.height=e.pixelHeight);const n=t.getContext("2d");return{canvas:t,context:n}}}class X extends C{constructor(e){super(e),this.adaptor=new J,this.adaptor.init(e,this)}}X.extension={type:[r.CanvasSystem],name:"renderTarget"};class K{constructor(e){}init(){}initSource(e){}generateCanvas(t){const n=f.get().createCanvas(),s=n.getContext("2d"),a=e.getCanvasSource(t);if(!a)return n;const r=t.frame,o=t.source._resolution??t.source.resolution??1,i=r.x*o,l=r.y*o,c=r.width*o,h=r.height*o;return n.width=Math.ceil(c),n.height=Math.ceil(h),s.drawImage(a,i,l,c,h,0,0,c,h),n}getPixels(e){const t=this.generateCanvas(e);return{pixels:t.getContext("2d",{willReadFrequently:!0}).getImageData(0,0,t.width,t.height).data,width:t.width,height:t.height}}destroy(){}}K.extension={type:[r.CanvasSystem],name:"texture"};const Q=[..._,q,G,K,X],$=[k,b,P,M,w,E,B,S],Z=[R,z],ee=[],te=[],ne=[];T.handleByNamedList(r.CanvasSystem,ee),T.handleByNamedList(r.CanvasPipes,te),T.handleByNamedList(r.CanvasPipesAdaptor,ne),T.add(...Q,...$,...Z);class se extends v{constructor(){super({name:"canvas",type:y.CANVAS,systems:ee,renderPipes:te,renderPipeAdaptors:ne})}}export{se as CanvasRenderer};
