import{aB as e}from"./index-zx6LJBPK.js";import"./vendor-react-DkDaD07v.js";import"./vendor-utils-XMmR-oGw.js";import"./vendor-tone-CADp_hfL.js";import"./vendor-ui-uomqNFY-.js";const t=new TextDecoder("iso-8859-1");function n(e,n){return t.decode(e.subarray(n,n+4))}function r(e,n,r){let a=n;for(;a<n+r&&0!==e[a];)a++;return t.decode(e.subarray(n,a)).trim()}function a(e,t){return e[t]<<8|e[t+1]}function f(e,t){return(e[t]<<24|e[t+1]<<16|e[t+2]<<8|e[t+3])>>>0}function o(t,o){const c=new Uint8Array(t),l=n(c,0);if("DBMX"!==l&&"DBM0"!==l)throw new Error(`Not a DigiBooster file: magic="${l}"`);let m=4;"DBM0"===l&&(m=12);let u=8,i=0,p=0,y=0,h=1,d=o.replace(/\.[^/.]+$/,"");const P=[];let T=0;const g=[],w=[],b=[];for(;m+8<c.length;){const e=n(c,m),t=f(c,m+4),o=m+8;switch(m+=8+t,e){case"INFO":"DBM0"===l?(p=a(c,o),y=a(c,o+2),h=a(c,o+4),i=a(c,o+6),u=a(c,o+8)):(u=a(c,o),i=a(c,o+2),p=a(c,o+4),y=a(c,o+6));break;case"NAME":d=r(c,o,Math.min(t,44));break;case"SONG":{let e=o;for(let n=0;n<h&&e+46<=o+t;n++){const t=a(c,e+44);if(0===n){T=t;for(let n=0;n<t&&n<128;n++)P.push(a(c,e+46+2*n))}e+=302}break}case"INST":{const e="DBM0"===l?50:28;for(let t=0;t<p;t++){const n=o+t*e;if(n+e>c.length)break;const s=r(c,n,30),l=a(c,n+30),m=c[n+32],u=a(c,n+33),i=c[n+35]<128?c[n+35]:c[n+35]-256,p=f(c,n+36),y=f(c,n+40);g.push({name:s,sampleNum:l,volume:m,finetune:i,loopStart:p,loopEnd:y,flags:u})}break}case"SMPL":{let e=o;for(let n=0;n<y&&!(e+4>o+t);n++){const t=r(c,e,30),n=f(c,e+30),o=f(c,e+34),s=f(c,e+38),l=c[e+42],m=1&a(c,e+43)?16:8;e+=50;const u=n*(16===m?2:1),i=c.slice(e,e+u);e+=u,w.push({name:t,length:n,loopStart:o,loopEnd:s,volume:l||64,finetune:0,bits:m,pcm:i})}break}case"PATT":{let e=o;for(;e+4<o+t;){const t=a(c,e),n=a(c,e+2);e+=4;const r=t*n*4,f=c.slice(e,e+r);if(e+=r,b.push({rows:t,channels:n,data:f}),b.length>=i)break}break}}}const D=g.map((t,n)=>{const r=t.sampleNum-1;if(r<0||r>=w.length)return{id:n+1,name:t.name||`Instrument ${n+1}`,type:"synth",synthType:"Synth",effects:[],volume:-6,pan:0};const a=w[r];let f;if(null===a.pcm||0===a.pcm.length)f=new Uint8Array(0);else if(16===a.bits){const e=Math.floor(a.pcm.length/2);f=new Uint8Array(e);const t=new DataView(a.pcm.buffer,a.pcm.byteOffset);for(let n=0;n<e;n++){const e=t.getInt16(2*n,!1);f[n]=128+(e>>8)&255}}else f=a.pcm;return e(n+1,t.name||a.name||`Sample ${n+1}`,f,a.volume,8287,a.loopStart,a.loopEnd)});return{name:d,format:"DIGI",patterns:b.map((e,t)=>{const n=Array.from({length:e.channels},(t,n)=>{const r=[];for(let a=0;a<e.rows;a++){const t=4*(a*e.channels+n),f=e.data[t],o=e.data[t+1],c=e.data[t+2],l=e.data[t+3],m=f>0?f+12:0,{effTyp:u,effParam:i}=s(c,l);r.push({note:m,instrument:o,volume:0,effTyp:u,eff:i,effTyp2:0,eff2:0})}return{id:`channel-${n}`,name:`Channel ${n+1}`,muted:!1,solo:!1,collapsed:!1,volume:100,pan:n%2==0?-25:25,instrumentId:null,color:null,rows:r}});return{id:`pattern-${t}`,name:`Pattern ${t}`,length:e.rows,channels:n,importMetadata:{sourceFormat:"DIGI",sourceFile:o,importedAt:(new Date).toISOString(),originalChannelCount:e.channels,originalPatternCount:i,originalInstrumentCount:p}}}),instruments:D,songPositions:P.length>0?P:[0],songLength:T||1,restartPosition:0,numChannels:u,initialSpeed:6,initialBPM:125,linearPeriods:!1}}function s(e,t){switch(e){case 0:return{effTyp:0,effParam:t};case 1:return{effTyp:1,effParam:t};case 2:return{effTyp:2,effParam:t};case 3:return{effTyp:3,effParam:t};case 4:return{effTyp:4,effParam:t};case 5:return{effTyp:5,effParam:t};case 6:return{effTyp:6,effParam:t};case 7:return{effTyp:7,effParam:t};case 8:return{effTyp:8,effParam:t};case 9:return{effTyp:9,effParam:t};case 10:return{effTyp:10,effParam:t};case 11:return{effTyp:11,effParam:t};case 12:return{effTyp:12,effParam:t};case 13:return{effTyp:13,effParam:t};case 14:return{effTyp:14,effParam:t};case 15:return{effTyp:15,effParam:t};case 16:return{effTyp:16,effParam:t};case 17:return{effTyp:17,effParam:t};default:return{effTyp:0,effParam:0}}}export{o as parseDigiBoosterFile};
