import{aB as t}from"./index-zx6LJBPK.js";import"./vendor-react-DkDaD07v.js";import"./vendor-utils-XMmR-oGw.js";import"./vendor-tone-CADp_hfL.js";import"./vendor-ui-uomqNFY-.js";function n(t,n){return t.getUint8(n)}function e(t,n){return t.getUint16(n,!1)}function r(t,n){return t.getInt16(n,!1)}function o(t,n,e){let r="";for(let o=0;o<e;o++){const e=t.getUint8(n+o);if(0===e)break;r+=String.fromCharCode(e)}return r.trim()}function i(t,n,e){for(let r=0;r<e;r++){const e=t.getUint8(n+r);if(0!==e&&(e<32||e>126))return!0}return!1}const s=1084,a=768,l=[-50,50,50,-50];function u(t){let n=t;n<0&&(n=0),n&=15;return[0,16,32,48,64,80,96,112,-128,-112,-96,-80,-64,-48,-32,-16][n]}function f(t,o){if(i(t,o,20))return!1;const s=r(t,o+20);if(s<-42||s>8)return!1;if(0!==function(t,n){return t.getInt8(n)}(t,o+24))return!1;if(n(t,o+25)>64)return!1;const a=e(t,o+22),l=e(t,o+26),u=e(t,o+28);return!(a>=32768)&&(!(l>=32768)&&(!(u>=32768)&&(!(!a&&(l>0||u>1||0!==s))&&!(a&&a<l+u))))}function c(t,e,r){const o=n(t,e),i=n(t,e+1),s=n(t,e+2);if(o>116)return!1;if((63&o)>36)return!1;const a=15&i;if(12===a&&s>80)return!1;if(11===a&&s>127)return!1;if(13===a&&s>64)return!1;return!((o>>2&48|i>>4&15)>r)}function m(t){if(t.byteLength<1852)return!1;const r=new DataView(t),l=o(r,1080,4),u=n(r,1080),m=n(r,1081),p=n(r,1082),h=n(r,1083);if(!("M.K."===l)&&!("UNIC"===l)&&!(0===u&&0===m&&0===p&&0===h))return!1;if(i(r,0,20))return!1;let d=0,g=0;for(let n=0;n<31;n++){const t=20+30*n;if(!f(r,t))return!1;const o=e(r,t+22);d+=2*o,o>0&&(g=n+1)}if(d<256)return!1;const w=n(r,950);if(0===w||w>=128)return!1;let C=0;for(let e=0;e<128;e++){const t=n(r,952+e);if(t>=128)return!1;if(e>w+1&&0!==t)return!1;t>C&&(C=t)}const y=C+1;let v=0,I=0;for(let e=0;e<256;e++){const t=1084+3*e;if(!c(r,t,g))return!1;const o=n(r,t);(63&o)>0&&v++,I|=o>>2&48|n(r,t+1)>>4&15}if(v<16||0===I)return!1;const P=y*a;return!(t.byteLength<s+P+d)}async function p(i,f){if(!m(i))throw new Error("UNICParser: file does not pass UNIC format validation");const p=new DataView(i),h=new Uint8Array(i),d=o(p,0,20)||f.replace(/\.[^/.]+$/,""),g=n(p,950),w=n(p,951);let C=0;for(let t=0;t<128;t++){const e=n(p,952+t);e+1>C&&(C=e+1)}const y=[];for(let t=0;t<g;t++)y.push(n(p,952+t));const v=[];for(let t=0;t<31;t++){const i=20+30*t,s=u(-r(p,i+20));v.push({name:o(p,i,20)||`Sample ${t+1}`,length:e(p,i+22),volume:n(p,i+25),loopStart:e(p,i+26),loopLen:e(p,i+28),finetune:s})}const I=[];let P=0,U=0,S=0;for(let t=0;t<31;t++)v[t].length>0&&(S=t+1);for(let t=0;t<C;t++){const e=s+t*a,r=Array.from({length:4},(t,n)=>({id:`channel-${n}`,name:`Channel ${n+1}`,muted:!1,solo:!1,collapsed:!1,volume:100,pan:l[n],instrumentId:null,color:null,rows:[]}));for(let o=0;o<64;o++)for(let i=0;i<4;i++){const s=e+3*(4*o+i),a=n(p,s),l=n(p,s+1),u=n(p,s+2);if(!c(p,s,S))throw new Error(`UNICParser: invalid cell at pattern ${t} row ${o} ch ${i}`);const f=63&a,m=a>>2&48|l>>4&15;f>0&&P++,U|=m;const h={note:f>0?f+36:0,instrument:m,volume:0,effTyp:15&l,eff:u,effTyp2:0,eff2:0};r[i].rows.push(h)}I.push({id:`pattern-${t}`,name:`Pattern ${t}`,length:64,channels:r,importMetadata:{sourceFormat:"UNIC",sourceFile:f,importedAt:(new Date).toISOString(),originalChannelCount:4,originalPatternCount:C,originalInstrumentCount:31}})}if(P<16||0===U)throw new Error("UNICParser: insufficient note/instrument data across all patterns");let $=s+C*a;const L=[];for(let n=0;n<31;n++){const e=v[n],r=2*e.length;if(0===r||$+r>i.byteLength){$+=r,L.push({id:n+1,name:e.name,type:"sample",synthType:"Sampler",effects:[],volume:-60,pan:0});continue}const o=h.slice($,$+r);$+=r;let s=2*e.loopStart,a=2*(e.loopStart+e.loopLen);e.loopLen>1?(e.loopStart>0&&s+a>=r-2&&s+a<=r&&(a+=s,s+=s),a=Math.min(a,o.length)):(s=0,a=0);const l=t(n+1,e.name,o,e.volume,8287,s,a);l.metadata?.modPlayback&&(l.metadata.modPlayback.finetune=e.finetune),L.push(l)}return{name:d,format:"MOD",patterns:I,instruments:L,songPositions:y,songLength:y.length,restartPosition:w,numChannels:4,initialSpeed:6,initialBPM:125,linearPeriods:!1}}export{m as isUNICFormat,p as parseUNICFile};
