import{aB as e}from"./index-zx6LJBPK.js";import"./vendor-react-DkDaD07v.js";import"./vendor-utils-XMmR-oGw.js";import"./vendor-tone-CADp_hfL.js";import"./vendor-ui-uomqNFY-.js";function t(e,t){return e.getUint32(t,!1)}function n(e,t){return e.getInt16(t,!1)}function o(e,t){return e.getUint16(t,!1)}function r(e,t){return e.getUint8(t)}function s(e,t){const n=e.getUint8(t);return n<128?n:n-256}function l(e){return e<1||e>72?0:e+12}async function a(l,a){const f=new DataView(l),c=l.byteLength;for(let e=0;e<16;e+=4){if(20218!==f.getUint16(e,!1))throw new Error("Not a Fred Editor file: missing jmp instructions")}let h=0,g=-1,d=16;for(;d<1024&&d+6<=c;){const e=f.getUint16(d,!1);if(4666===e){const e=f.getUint16(d+2,!1);45057===f.getUint16(d+4,!1)&&(h=d+2+e-2197)}else if(8522===e){const e=d+2;if(e+2<=c){if(18426===f.getUint16(e+2,!1)){if(d+8<=c){g=d+6+f.getInt16(d+6,!1)}break}}}d+=2}if(-1===g)throw new Error("Not a Fred Editor file: could not locate basePtr");const m=h+2210;if(m+8>c)throw new Error("Fred Editor: sample table offset out of bounds");const y=t(f,m);let b=g+y;if(b>=c)throw new Error("Fred Editor: sample data position out of bounds");const v=[];let S=2147483647;for(;b+64<=c;){const e=t(f,b);if(0!==e){if(e<b&&0!==e||e>=c)break;e<S&&(S=e)}const l={pointer:e,loopPtr:n(f,b+4),length:o(f,b+6)<<1,relative:o(f,b+8),vibratoDelay:r(f,b+10),vibratoSpeed:r(f,b+12),vibratoDepth:r(f,b+13),envelopeVol:r(f,b+14),attackSpeed:r(f,b+15),attackVol:r(f,b+16),decaySpeed:r(f,b+17),decayVol:r(f,b+18),sustainTime:r(f,b+19),releaseSpeed:r(f,b+20),releaseVol:r(f,b+21),arpeggio:new Int8Array(16),arpeggioSpeed:0,arpeggioLimit:0,type:0,synchro:0,pulseRateNeg:0,pulseRatePos:0,pulseSpeed:0,pulsePosL:0,pulsePosH:0,pulseDelay:0,pulseCounter:0,blendRate:0,blendDelay:0,blendCounter:0};for(let t=0;t<16;t++)l.arpeggio[t]=s(f,b+22+t);l.arpeggioSpeed=r(f,b+38),l.type=s(f,b+39),l.pulseRateNeg=s(f,b+40),l.pulseRatePos=r(f,b+41),l.pulseSpeed=r(f,b+42),l.pulsePosL=r(f,b+43),l.pulsePosH=r(f,b+44),l.pulseDelay=r(f,b+45),l.synchro=r(f,b+46),l.blendRate=r(f,b+47),l.blendDelay=r(f,b+48),l.pulseCounter=r(f,b+49),l.blendCounter=r(f,b+50),l.arpeggioLimit=r(f,b+51),b+=64,v.push(l)}const P=S<2147483647?g+S:0,w=P>0&&P<c?new Uint8Array(l,P,c-P):new Uint8Array(0);if(P>0)for(const e of v)e.pointer>0&&(e.pointer=g+e.pointer-P);const D=t(f,m+4),M=g+D,k=y-D;let V;V=k>0&&M+k<=c?new Uint8Array(l,M,k):new Uint8Array(0);const C=h+2197;if(C>=c)throw new Error("Fred Editor: song count offset out of bounds");const T=r(f,C)+1,U=h+2830,L=M-U,A=[];let $=0;for(let e=0;e<T;e++){const t={speed:0,length:0,tracks:[]};for(let r=0;r<4;r++){const n=U+$;if(n+2>c)break;const s=o(f,n);let l;if(3===r&&e===T-1)l=L;else{const e=U+$+2;l=e+2<=c?o(f,e):L}const a=l-s>>1;a>t.length&&(t.length=a);const i=new Uint32Array(Math.max(0,a));for(let e=0;e<a;e++){const t=U+s+2*e;t+2<=c&&(i[e]=o(f,t))}t.tracks[r]=i,$+=2}const n=h+2199+e;n<c&&(t.speed=r(f,n)),0===t.speed&&(t.speed=6),A.push(t)}const E=[];for(let t=0;t<v.length;t++){const n=v[t],o=t+1,r=`Sample ${t+1}`;if(n.length>0&&n.pointer>=0&&0===n.type){const t=n.pointer,s=t+n.length;if(s<=w.length){const l=w.slice(t,s);let a=0,i=0;n.loopPtr>0&&(a=n.loopPtr,i=n.length),E.push(e(o,r,l,Math.min(64,n.envelopeVol||64),8287,a,i))}else E.push(u(o,r))}else if(1===n.type){const e={envelopeVol:n.envelopeVol,attackSpeed:n.attackSpeed,attackVol:n.attackVol,decaySpeed:n.decaySpeed,decayVol:n.decayVol,sustainTime:n.sustainTime,releaseSpeed:n.releaseSpeed,releaseVol:n.releaseVol,vibratoDelay:n.vibratoDelay,vibratoSpeed:n.vibratoSpeed,vibratoDepth:n.vibratoDepth,arpeggio:Array.from(n.arpeggio),arpeggioLimit:n.arpeggioLimit,arpeggioSpeed:n.arpeggioSpeed,pulseRateNeg:n.pulseRateNeg,pulseRatePos:n.pulseRatePos,pulseSpeed:n.pulseSpeed,pulsePosL:n.pulsePosL,pulsePosH:n.pulsePosH,pulseDelay:n.pulseDelay,relative:n.relative};E.push({id:o,name:`${r} (PWM)`,type:"synth",synthType:"FredSynth",fred:e,effects:[],volume:-6,pan:0})}else if(2===n.type){const t=n.pointer,s=t+n.length;if(n.length>0&&t>=0&&s<=w.length){const l=w.slice(t,s);E.push(e(o,`${r} (Blend)`,l,Math.min(64,n.envelopeVol||64),8287,0,0))}else E.push(u(o,`${r} (Blend)`))}else E.push(u(o,r))}0===E.length&&E.push(u(1,"Default"));const F=[],R=[],I=A.length>0?A[0]:null;if(I&&V.length>0){const e=I.speed||6,t=I.length;for(let n=0;n<t;n++){const o=[[],[],[],[]];for(let t=0;t<4;t++){const r=I.tracks[t];if(!r||n>=r.length){for(let e=0;e<64;e++)o[t].push(p());continue}const s=r[n];if(65535===s){for(let e=0;e<64;e++)o[t].push(p());continue}if(s>32767){for(let e=0;e<64;e++)o[t].push(p());continue}const l=i(V,s,e,v);for(const e of l)o[t].push(e)}const r=Math.max(...o.map(e=>e.length),1),s=Math.min(r,64);for(let e=0;e<4;e++){for(;o[e].length<s;)o[e].push(p());o[e].length>s&&(o[e].length=s)}const l=o.map((e,t)=>({id:`channel-${t}`,name:`Channel ${t+1}`,muted:!1,solo:!1,collapsed:!1,volume:100,pan:0===t||3===t?-50:50,instrumentId:null,color:null,rows:e})),u=F.length;F.push({id:`pattern-${u}`,name:`Pattern ${u}`,length:s,channels:l,importMetadata:{sourceFormat:"MOD",sourceFile:a,importedAt:(new Date).toISOString(),originalChannelCount:4,originalPatternCount:t,originalInstrumentCount:v.length}}),R.push(u)}}0===F.length&&(F.push(function(e){return{id:"pattern-0",name:"Pattern 0",length:64,channels:Array.from({length:4},(e,t)=>({id:`channel-${t}`,name:`Channel ${t+1}`,muted:!1,solo:!1,collapsed:!1,volume:100,pan:0===t||3===t?-50:50,instrumentId:null,color:null,rows:Array.from({length:64},()=>({note:0,instrument:0,volume:0,effTyp:0,eff:0,effTyp2:0,eff2:0}))})),importMetadata:{sourceFormat:"MOD",sourceFile:e,importedAt:(new Date).toISOString(),originalChannelCount:4,originalPatternCount:0,originalInstrumentCount:0}}}(a)),R.push(0));const j=a.replace(/\.[^/.]+$/,""),N=I?.speed||6;return{name:j,format:"MOD",patterns:F,instruments:E,songPositions:R,songLength:R.length,restartPosition:0,numChannels:4,initialSpeed:N,initialBPM:125,linearPeriods:!1}}function i(e,t,n,o){const r=[];let s=t,a=0,i=n,u=0,f=0,c=0;for(;s<e.length&&r.length<64;){const t=e[s]<128?e[s]:e[s]-256;if(s++,t>0&&t<=127){const e=l(t),n=a+1,s=a<o.length?o[a]:null;let i=0;s&&(i=Math.min(64,s.attackVol||s.envelopeVol||64));const p=16+i;let h=0,g=0,d=0,m=0;if(s&&s.arpeggioLimit>0&&0!==s.arpeggio[0]){const e=15&Math.abs(s.arpeggio[0]),t=s.arpeggioLimit>1?15&Math.abs(s.arpeggio[1]):0;(e>0||t>0)&&(h=0,g=e<<4|t)}let y=e;if(0===c&&u>0){const t=l(f);t>0&&t!==e&&(h=3,g=Math.min(u,255),d=0,m=0,y=t)}if(s&&s.vibratoSpeed>0&&s.vibratoDepth>0&&0===h){h=4;g=Math.min(s.vibratoSpeed,15)<<4|Math.min(s.vibratoDepth,15)}r.push({note:y,instrument:n,volume:p,effTyp:h,eff:g,effTyp2:d,eff2:m})}else if(t<0)switch(t){case-125:s<e.length&&(a=e[s],s++);break;case-126:if(s<e.length){i=e[s],s++;const t=p();t.effTyp=15,t.eff=i,r.push(t)}break;case-127:s+2<e.length&&(u=e[s]*i,f=e[s+1],c=e[s+2]*i,s+=3);break;case-124:r.push({note:97,instrument:0,volume:0,effTyp:0,eff:0,effTyp2:0,eff2:0});break;case-128:return r;default:{const e=Math.abs(t),n=Math.min(e-1,64-r.length);for(let t=0;t<n;t++)r.push(p());break}}else r.push(p())}return r}function p(){return{note:0,instrument:0,volume:0,effTyp:0,eff:0,effTyp2:0,eff2:0}}function u(e,t){return{id:e,name:t,type:"synth",synthType:"Synth",effects:[],volume:-6,pan:0}}export{a as parseFredEditorFile};
