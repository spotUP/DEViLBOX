import{aB as e}from"./index-zx6LJBPK.js";import"./vendor-react-DkDaD07v.js";import"./vendor-utils-XMmR-oGw.js";import"./vendor-tone-CADp_hfL.js";import"./vendor-ui-uomqNFY-.js";const n=3546895,t=[0,13696,12928,12192,11520,10848,10240,9664,9120,8608,8128,7680,7248,6848,6464,6096,5760,5424,5120,4832,4560,4304,4064,3840,3624,3424,3232,3048,2880,2712,2560,2416,2280,2152,2032,1920,1812,1712,1616,1524,1440,1356,1280,1208,1140,1076,1016,960,906,856,808,762,720,678,640,604,570,538,508,480,453,428,404,381,360,339,320,302,285,269,254,240,226,214,202,190,180,170,160,151,143,135,127,120,113,107,101,95,90,85,80,75,71,67,63,60,56,53,50,47,45,42,40,37,35,33,31,30,28];function o(e,n){return e[n]}function r(e,n){return e[n]<<8|e[n+1]}function s(e,n){return(e[n]<<24|e[n+1]<<16|e[n+2]<<8|e[n+3])>>>0}function f(e){return e<128?e:e-256}function l(e,n,t){let o="";for(let r=0;r<t;r++){const t=e[n+r];if(0===t)break;o+=String.fromCharCode(t)}return o.trim()}function a(e,n){return n+4>e.length?"":String.fromCharCode(e[n],e[n+1],e[n+2],e[n+3])}function u(e){return e<=0||e>=t.length?0:Math.min(96,e+12)}function i(e){return!(e.length<16)&&(73===e[0]&&83===e[1]&&50===e[2]&&48===e[3]&&68===e[4]&&70===e[5]&&49===e[6]&&48===e[7])}function h(t,h){if(!i(t))return null;let g=8;if(g+8>t.length)return null;if("STBL"!==a(t,g))return null;g+=4;const d=s(t,g);if(g+=4,g+10*d>t.length)return null;const T=[];for(let e=0;e<d;e++){const e=o(t,g++),n=o(t,g++),s=r(t,g);g+=2;const f=r(t,g);g+=2;const l=r(t,g);g+=2;const a=r(t,g);g+=2,T.push({startSpeed:e,rowsPerTrack:n,firstPosition:s,lastPosition:f,restartPosition:l,tempo:a})}if(0===T.length)return null;const y=T[0];if(g+8>t.length)return null;if("OVTB"!==a(t,g))return null;g+=4;const S=s(t,g);g+=4;const v=[];for(let e=0;e<S&&!(g+16>t.length);e++){const e=[];for(let n=0;n<4;n++){const n=r(t,g);g+=2;const o=f(t[g++]),s=f(t[g++]);e.push({startTrackRow:n,soundTranspose:o,noteTranspose:s})}v.push(e)}if(g+8>t.length)return null;if("NTBL"!==a(t,g))return null;g+=4;const w=s(t,g);g+=4;const M=[];for(let e=0;e<w;e++){if(g+4>t.length){M.push({note:0,instrument:0,disableSoundTranspose:!1,disableNoteTranspose:!1,arpeggio:0,effect:0,effectArg:0});continue}const e=t[g++],n=t[g++],o=t[g++],r=t[g++];M.push({note:e,instrument:n,disableSoundTranspose:!!(128&o),disableNoteTranspose:!!(64&o),arpeggio:(48&o)>>4,effect:15&o,effectArg:r})}if(g+8>t.length)return null;if("SAMP"!==a(t,g))return null;g+=4;const P=s(t,g);g+=4;const L=[];for(let e=0;e<P&&!(g+16>t.length);e++){const e=r(t,g);g+=2;const n=r(t,g);g+=2;const s=f(t[g++]),l=o(t,g++);g+=1,g+=1,g+=1,g+=1,g+=6,L.push({name:"",oneShotLength:e,repeatLength:n,sampleNumber:s,volume:l})}for(let e=0;e<P&&!(g+20>t.length);e++)L[e].name=l(t,g,20),g+=20;g+=4*P*2;const b=[];for(let e=0;e<P;e++)g+4>t.length?b.push(0):(b.push(s(t,g)),g+=4);const C=new Array(P).fill(null);for(let e=P-1;e>=0;e--){const n=b[e];if(n>0&&g+n<=t.length){const o=new Uint8Array(n);for(let e=0;e<n;e++)o[e]=t[g+e];C[e]=o,g+=n}}if(g+8>t.length)return null;if("SYNT"!==a(t,g))return null;g+=4;const A=s(t,g);g+=4;const I=[];for(let e=0;e<A&&!(g+4>t.length)&&"IS20"===a(t,g)&&(g+=4,!(g+20>t.length));e++){const e=l(t,g,20);if(g+=20,g+2>t.length)break;const n=r(t,g);g+=2;const s=o(t,g++),a=o(t,g++),u=o(t,g++),i=o(t,g++),h=o(t,g++),c=o(t,g++),p=o(t,g++);g+=4;const m=o(t,g++),d=o(t,g++),T=o(t,g++),y=o(t,g++),S=o(t,g++),v=0===o(t,g++)?0:0===S?1:2;o(t,g++),o(t,g++),o(t,g++),o(t,g++),g+=19,g+=128,g+=128,g+=48,g+=128;const w=new Int8Array(256);if(g+256<=t.length){for(let e=0;e<256;e++)w[e]=f(t[g+e]);g+=256}const M=new Int8Array(256);if(g+256<=t.length){for(let e=0;e<256;e++)M[e]=f(t[g+e]);g+=256}I.push({name:e,waveformLength:n,volume:s,vibratoDelay:a,vibratoSpeed:u,vibratoLevel:i,portamentoSpeed:h,adsrLength:c,adsrRepeat:p,sustainPoint:m,sustainSpeed:d,amfLength:T,amfRepeat:y,egMode:v,waveform1:w,waveform2:M})}const $=Math.round(n/428),N=Math.round(n/1712),x=[];for(let n=0;n<P;n++){const t=L[n],o=n+1,r=t.sampleNumber>=0&&t.sampleNumber<C.length?C[t.sampleNumber]:C[n]??null;if(r&&r.length>0){let s=0,f=0;1!==t.repeatLength&&0!==t.oneShotLength&&(0===t.repeatLength?(s=0,f=r.length):(s=2*t.oneShotLength,f=2*(t.oneShotLength+t.repeatLength))),x.push(e(o,t.name||`Sample ${n}`,r,t.volume,$,s,f))}else x.push(p(o,t.name||`Sample ${n}`))}for(let n=0;n<I.length;n++){const t=I[n],o=P+n+1,r=t.waveform1,s=Math.min(Math.max(2,t.waveformLength),256),f=new Uint8Array(s);for(let e=0;e<s;e++)f[e]=255&r[e%256];x.push(e(o,t.name||`Synth ${n}`,f,t.volume,N,0,s))}function k(e){if(0===e||128===e)return 0;if(e>=64){const n=e-64;return n<P?n+1:0}{const n=e-1;return n<I.length?P+n+1:0}}const j=Math.max(1,y.rowsPerTrack),B=y.firstPosition,F=y.lastPosition,R=[];for(let e=B;e<=F&&!(e>=v.length);e++){const n=v[e],t=[[],[],[],[]];for(let e=0;e<j;e++)for(let o=0;o<4;o++){const r=n[o],s=r.startTrackRow+e,f=s<M.length?M[s]:null;if(!f||0===f.note){t[o].push(c());continue}if(127===f.note){t[o].push({note:97,instrument:0,volume:0,effTyp:0,eff:0,effTyp2:0,eff2:0});continue}if(128===f.note){t[o].push(c());continue}let l=f.note;f.disableNoteTranspose||(l=Math.max(1,Math.min(108,l+r.noteTranspose)));let a=f.instrument;a>0&&128!==a&&!f.disableSoundTranspose&&a<64&&(a=Math.max(1,Math.min(63,a+r.soundTranspose)));const i=u(l),h=k(a),{effTyp:p,eff:g}=m(f.effect,f.effectArg);t[o].push({note:i,instrument:h,volume:0,effTyp:p,eff:g,effTyp2:0,eff2:0})}const o=e-B;R.push({id:`pattern-${o}`,name:`Position ${o}`,length:j,channels:t.map((e,n)=>({id:`channel-${n}`,name:`Channel ${n+1}`,muted:!1,solo:!1,collapsed:!1,volume:100,pan:0===n||3===n?-50:50,instrumentId:null,color:null,rows:e})),importMetadata:{sourceFormat:"IS20",sourceFile:h,importedAt:(new Date).toISOString(),originalChannelCount:4,originalPatternCount:v.length,originalInstrumentCount:x.length}})}0===R.length&&R.push(function(e,n,t){return{id:"pattern-0",name:"Pattern 0",length:t,channels:Array.from({length:n},(e,n)=>({id:`channel-${n}`,name:`Channel ${n+1}`,muted:!1,solo:!1,collapsed:!1,volume:100,pan:0,instrumentId:null,color:null,rows:Array.from({length:t},()=>({note:0,instrument:0,volume:0,effTyp:0,eff:0,effTyp2:0,eff2:0}))})),importMetadata:{sourceFormat:"IS20",sourceFile:e,importedAt:(new Date).toISOString(),originalChannelCount:n,originalPatternCount:0,originalInstrumentCount:0}}}(h,4,j));const D=h.replace(/\.[^/.]+$/,""),O=y.tempo>0?y.tempo:50;return{name:D,format:"IS20",patterns:R,instruments:x,songPositions:R.map((e,n)=>n),songLength:R.length,restartPosition:0,numChannels:4,initialSpeed:Math.max(1,y.startSpeed),initialBPM:O,linearPeriods:!1}}function c(){return{note:0,instrument:0,volume:0,effTyp:0,eff:0,effTyp2:0,eff2:0}}function p(e,n){return{id:e,name:n,type:"synth",synthType:"Synth",effects:[],volume:0,pan:0}}function m(e,n){switch(e){case 0:return 0!==n?{effTyp:0,eff:n}:{effTyp:0,eff:0};case 7:return{effTyp:3,eff:n};case 10:if(n>127){return{effTyp:10,eff:15&256-n}}return{effTyp:10,eff:(15&n)<<4};case 11:return{effTyp:11,eff:n};case 12:return{effTyp:12,eff:Math.min(64,n)};case 13:return{effTyp:13,eff:0};case 15:return n>0&&n<=31?{effTyp:15,eff:n}:{effTyp:0,eff:0};default:return{effTyp:0,eff:0}}}export{i as isInStereo2Format,h as parseInStereo2File};
