import{aB as n}from"./index-zx6LJBPK.js";import"./vendor-react-DkDaD07v.js";import"./vendor-utils-XMmR-oGw.js";import"./vendor-tone-CADp_hfL.js";import"./vendor-ui-uomqNFY-.js";function t(n,t){return n.getUint8(t)}function e(n,t){return n.getInt8(t)}function r(n,t){return n.getUint16(t,!1)}function a(n,t){return n.getUint32(t,!1)}function o(n,t,e){if(t+e.length>n.byteLength)return!1;for(let r=0;r<e.length;r++)if(n.getUint8(t+r)!==e.charCodeAt(r))return!1;return!0}const i=32,s=[new Uint8Array([192,192,208,216,224,232,240,248,0,248,240,232,224,216,208,200,63,55,47,39,31,23,15,7,255,7,15,23,31,39,47,55]),new Uint8Array([192,192,208,216,224,232,240,248,0,248,240,232,224,216,208,200,192,55,47,39,31,23,15,7,255,7,15,23,31,39,47,55]),new Uint8Array([192,192,208,216,224,232,240,248,0,248,240,232,224,216,208,200,192,184,47,39,31,23,15,7,255,7,15,23,31,39,47,55]),new Uint8Array([192,192,208,216,224,232,240,248,0,248,240,232,224,216,208,200,192,184,176,39,31,23,15,7,255,7,15,23,31,39,47,55]),new Uint8Array([192,192,208,216,224,232,240,248,0,248,240,232,224,216,208,200,192,184,176,168,31,23,15,7,255,7,15,23,31,39,47,55]),new Uint8Array([192,192,208,216,224,232,240,248,0,248,240,232,224,216,208,200,192,184,176,168,160,23,15,7,255,7,15,23,31,39,47,55]),new Uint8Array([192,192,208,216,224,232,240,248,0,248,240,232,224,216,208,200,192,184,176,168,160,152,15,7,255,7,15,23,31,39,47,55]),new Uint8Array([192,192,208,216,224,232,240,248,0,248,240,232,224,216,208,200,192,184,176,168,160,152,144,7,255,7,15,23,31,39,47,55]),new Uint8Array([192,192,208,216,224,232,240,248,0,248,240,232,224,216,208,200,192,184,176,168,160,152,144,136,255,7,15,23,31,39,47,55]),new Uint8Array([192,192,208,216,224,232,240,248,0,248,240,232,224,216,208,200,192,184,176,168,160,152,144,136,128,7,15,23,31,39,47,55]),new Uint8Array([192,192,208,216,224,232,240,248,0,248,240,232,224,216,208,200,192,184,176,168,160,152,144,136,128,136,15,23,31,39,47,55]),new Uint8Array([192,192,208,216,224,232,240,248,0,248,240,232,224,216,208,200,192,184,176,168,160,152,144,136,128,136,144,23,31,39,47,55]),new Uint8Array([192,192,208,216,224,232,240,248,0,248,240,232,224,216,208,200,192,184,176,168,160,152,144,136,128,136,144,152,31,39,47,55]),new Uint8Array([192,192,208,216,224,232,240,248,0,248,240,232,224,216,208,200,192,184,176,168,160,152,144,136,128,136,144,152,160,39,47,55]),new Uint8Array([192,192,208,216,224,232,240,248,0,248,240,232,224,216,208,200,192,184,176,168,160,152,144,136,128,136,144,152,160,168,47,55]),new Uint8Array([192,192,208,216,224,232,240,248,0,248,240,232,224,216,208,200,192,184,176,168,160,152,144,136,128,136,144,152,160,168,176,55]),new Uint8Array([129,129,129,129,129,129,129,129,129,129,129,129,129,129,129,129,127,127,127,127,127,127,127,127,127,127,127,127,127,127,127,127]),new Uint8Array([129,129,129,129,129,129,129,129,129,129,129,129,129,129,129,129,129,127,127,127,127,127,127,127,127,127,127,127,127,127,127,127]),new Uint8Array([129,129,129,129,129,129,129,129,129,129,129,129,129,129,129,129,129,129,127,127,127,127,127,127,127,127,127,127,127,127,127,127]),new Uint8Array([129,129,129,129,129,129,129,129,129,129,129,129,129,129,129,129,129,129,129,127,127,127,127,127,127,127,127,127,127,127,127,127]),new Uint8Array([129,129,129,129,129,129,129,129,129,129,129,129,129,129,129,129,129,129,129,129,127,127,127,127,127,127,127,127,127,127,127,127]),new Uint8Array([129,129,129,129,129,129,129,129,129,129,129,129,129,129,129,129,129,129,129,129,129,127,127,127,127,127,127,127,127,127,127,127]),new Uint8Array([129,129,129,129,129,129,129,129,129,129,129,129,129,129,129,129,129,129,129,129,129,129,127,127,127,127,127,127,127,127,127,127]),new Uint8Array([129,129,129,129,129,129,129,129,129,129,129,129,129,129,129,129,129,129,129,129,129,129,129,127,127,127,127,127,127,127,127,127]),new Uint8Array([129,129,129,129,129,129,129,129,129,129,129,129,129,129,129,129,129,129,129,129,129,129,129,129,127,127,127,127,127,127,127,127]),new Uint8Array([129,129,129,129,129,129,129,129,129,129,129,129,129,129,129,129,129,129,129,129,129,129,129,129,129,127,127,127,127,127,127,127]),new Uint8Array([129,129,129,129,129,129,129,129,129,129,129,129,129,129,129,129,129,129,129,129,129,129,129,129,129,129,127,127,127,127,127,127]),new Uint8Array([129,129,129,129,129,129,129,129,129,129,129,129,129,129,129,129,129,129,129,129,129,129,129,129,129,129,129,127,127,127,127,127]),new Uint8Array([129,129,129,129,129,129,129,129,129,129,129,129,129,129,129,129,129,129,129,129,129,129,129,129,129,129,129,129,127,127,127,127]),new Uint8Array([129,129,129,129,129,129,129,129,129,129,129,129,129,129,129,129,129,129,129,129,129,129,129,129,129,129,129,129,129,127,127,127]),new Uint8Array([128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,127,127]),new Uint8Array([128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,127]),new Uint8Array([128,128,128,128,128,128,128,128,127,127,127,127,127,127,127,127,128,128,128,128,128,128,128,127,127,127,127,127,127,127,127,127]),new Uint8Array([128,128,128,128,128,128,127,127,127,127,127,127,127,127,127,127,128,128,128,128,128,127,127,127,127,127,127,127,127,127,127,127]),new Uint8Array([128,128,128,128,127,127,127,127,127,127,127,127,127,127,127,127,128,128,128,127,127,127,127,127,127,127,127,127,127,127,127,127]),new Uint8Array([128,128,127,127,127,127,127,127,127,127,127,127,127,127,127,127,128,128,127,127,127,127,127,127,127,127,127,127,127,127,127,127]),new Uint8Array([128,128,144,152,160,168,176,184,192,200,208,216,224,232,240,248,0,8,16,24,32,40,48,56,64,72,80,88,96,104,112,127]),new Uint8Array([128,128,160,176,192,208,224,240,0,16,32,48,64,80,96,112,69,69,121,125,122,119,112,102,97,88,83,77,44,32,24,18]),new Uint8Array([4,219,211,205,198,188,181,174,168,163,157,153,147,142,139,138,69,69,121,125,122,119,112,102,91,75,67,55,44,32,24,18]),new Uint8Array([4,248,232,219,207,198,190,176,168,164,158,154,149,148,141,131,0,0,64,96,127,96,64,32,0,224,192,160,128,160,192,224]),new Uint8Array([0,0,64,96,127,96,64,32,0,224,192,160,128,160,192,224,128,128,144,152,160,168,176,184,192,200,208,216,224,232,240,248]),new Uint8Array([0,8,16,24,32,40,48,56,64,72,80,88,96,104,112,127,128,128,160,176,192,208,224,240,0,16,32,48,64,80,96,112])];function f(n){if(n.byteLength<80)return!1;const o=new DataView(n);for(let e=0;e<12;e++){const n=t(o,e);if(0!==n&&n<32)return!1}const i=r(o,12),s=r(o,14),f=r(o,16),u=r(o,18);if(i>255)return!1;if(!s||s>128)return!1;if(!f||f>32)return!1;if(0!==u)return!1;const c=i+1,l=80+(14*c+8*s+4+16*f+4);for(let t=0;t<10;t++){const n=r(o,60+2*t),e=a(o,20+4*t);if(n>0&&!e)return!1;if(e>1048576)return!1;if(e>0&&e<l)return!1}if(80+14*c>n.byteLength)return!1;const w=Math.min(c,4);for(let r=0;r<w;r++){const n=80+14*r;let a=!0;for(let r=0;r<4;r++){const i=t(o,n+3*r),s=e(o,n+3*r+2);if(i>=128){a=!1;break}if(1&s){a=!1;break}if(s<-48||s>48){a=!1;break}}if(!a)return!1;const i=t(o,n+12),s=t(o,n+13);if(i>15||0!==s)return!1}return!0}function u(n,e){const r=n.byteLength;let a=-1,o=!0;for(;e+4<=r;){const r=t(n,e);if(o&&192!==r)return{waveformIndex:-1,endPos:e};switch(r){case 160:e+=4;break;case 176:case 224:return{waveformIndex:a,endPos:e+4};case 192:o&&(a=t(n,e+1)),e+=4;break;default:return{waveformIndex:a,endPos:e}}o=!1}return{waveformIndex:a,endPos:e}}function c(n,e){const r=n.byteLength;for(;e+4<=r;){switch(t(n,e)){case 160:e+=4;break;case 176:case 224:return e+4;case 208:if(1&t(n,e+1))return e;e+=4;break;default:return o(n,e,"inst"),e}}return e}async function l(l,w){const m=new DataView(l),p=new Uint8Array(l);if(!f(l))throw new Error("PumaTracker: invalid file format");let y="";for(let n=0;n<12;n++){const e=t(m,n);if(0===e)break;y+=String.fromCharCode(e)}const h=r(m,12),A=r(m,14),d=r(m,16),U=h+1,g=[],T=[];for(let n=0;n<10;n++)g.push(a(m,20+4*n)),T.push(2*r(m,60+2*n));const P=[];let b=80;for(let n=0;n<U;n++){const n=[];for(let a=0;a<4;a++)n.push({pattern:t(m,b+3*a),instrTranspose:e(m,b+3*a+1),noteTranspose:e(m,b+3*a+2)});const r=t(m,b+12);P.push({channels:n,speed:r}),b+=14}const k=[];for(let n=0;n<A;n++){if(!o(m,b,"patt"))throw new Error(`PumaTracker: expected "patt" at 0x${b.toString(16)}`);b+=4;const e=new Array(i).fill(null).map(()=>({noteX2:0,instrEffect:0,param:0}));let r=0;for(;r<i&&b+4<=l.byteLength;){const a=t(m,b),o=t(m,b+1),s=t(m,b+2),f=t(m,b+3);if(b+=4,1&a)throw new Error(`PumaTracker: odd note byte at pattern ${n}`);if(!f||f>i-r)throw new Error(`PumaTracker: bad runLen ${f} at pattern ${n} row ${r}`);for(let n=0;n<f;n++)e[r+n]={noteX2:a,instrEffect:o,param:s};r+=f}k.push(e)}if(!o(m,b,"patt"))throw new Error(`PumaTracker: expected terminating "patt" at 0x${b.toString(16)}`);b+=4;const $=[];for(let n=0;n<d;n++){if(!o(m,b,"inst"))throw new Error(`PumaTracker: expected "inst" at 0x${b.toString(16)} (instrument ${n})`);b+=4;const t=u(m,b);if(b=t.endPos,$.push(t.waveformIndex),!o(m,b,"insf"))throw new Error(`PumaTracker: expected "insf" at 0x${b.toString(16)} (instrument ${n})`);b+=4,b=c(m,b)}o(m,b,"inst");const x=[];for(let n=0;n<10;n++){const t=T[n],e=g[n];if(!t||!e||e>=l.byteLength)x.push(null);else{const n=Math.min(t,l.byteLength-e);x.push(p.slice(e,e+n))}}const v=[];for(let t=0;t<d;t++){const e=$[t],r=t+1,a=`Instrument ${r}`;let o=null,i=0,f=0;e>=0&&e<10?(o=x[e],i=0,f=0):e>=10&&e<52&&(o=s[e-10],i=0,f=32),o&&0!==o.length?v.push(n(r,a,o,64,8363,i,f)):v.push({id:r,name:a,type:"sample",synthType:"Sampler",effects:[],volume:-60,pan:0})}const C=[-50,50,50,-50],I=P.map((n,t)=>{const e=Array.from({length:4},(t,e)=>{const r=n.channels[e],a=r.pattern<k.length?k[r.pattern]:null;let o=0;const s=Array.from({length:i},(t,i)=>{const s={note:0,instrument:0,volume:0,effTyp:0,eff:0,effTyp2:0,eff2:0};if(0===e&&0===i&&n.speed>0&&(s.effTyp=15,s.eff=n.speed),!a)return s;const f=a[i];if(f.noteX2){const n=f.noteX2+r.noteTranspose;s.note=Math.max(1,12+Math.trunc(n/2))}const u=31&f.instrEffect;0!==u&&(s.instrument=u+r.instrTranspose&31);const c=f.instrEffect>>5&7,l=f.param;let w=!1;switch(c){case 1:s.effTyp=12,s.eff=Math.min(l,64),o=0;break;case 2:l>0?(s.effTyp=2,s.eff=l,o=1,w=!0):o=0;break;case 3:l>0?(s.effTyp=1,s.eff=l,o=2,w=!0):o=0}return w||(f.noteX2?o=0:1===o?(s.effTyp2=2,s.eff2=0):2===o&&(s.effTyp2=1,s.eff2=0)),s});return{id:`channel-${e}`,name:`Channel ${e+1}`,muted:!1,solo:!1,collapsed:!1,volume:100,pan:C[e],instrumentId:null,color:null,rows:s}});return{id:`pattern-${t}`,name:`Pattern ${t}`,length:i,channels:e,importMetadata:{sourceFormat:"PumaTracker",sourceFile:w,importedAt:(new Date).toISOString(),originalChannelCount:4,originalPatternCount:A,originalInstrumentCount:d}}});0===I.length&&I.push({id:"pattern-0",name:"Pattern 0",length:i,channels:Array.from({length:4},(n,t)=>({id:`channel-${t}`,name:`Channel ${t+1}`,muted:!1,solo:!1,collapsed:!1,volume:100,pan:C[t],instrumentId:null,color:null,rows:Array.from({length:i},()=>({note:0,instrument:0,volume:0,effTyp:0,eff:0,effTyp2:0,eff2:0}))})),importMetadata:{sourceFormat:"PumaTracker",sourceFile:w,importedAt:(new Date).toISOString(),originalChannelCount:4,originalPatternCount:0,originalInstrumentCount:0}});const E=I.map((n,t)=>t);return{name:y.trim()||w.replace(/\.[^/.]+$/,""),format:"MOD",patterns:I,instruments:v,songPositions:E,songLength:E.length,restartPosition:0,numChannels:4,initialSpeed:6,initialBPM:125,linearPeriods:!1}}export{f as isPumaTrackerFormat,l as parsePumaTrackerFile};
