import{aB as e}from"./index-zx6LJBPK.js";import"./vendor-react-DkDaD07v.js";import"./vendor-utils-XMmR-oGw.js";import"./vendor-tone-CADp_hfL.js";import"./vendor-ui-uomqNFY-.js";function t(e,t){return e.getUint8(t)}function n(e,t){return e.getUint16(t,!1)}function r(e,t){return e.getInt16(t,!1)}function o(e,t){return e.getUint32(t,!1)}const a=1084,s=1024,i=950,l=[-50,50,50,-50];function f(e,t){let n=e,r=t;switch(e){case 0:n=0;break;case 1:n=1;break;case 2:n=2;break;case 3:n=3;break;case 4:n=4;break;case 5:n=5;break;case 6:n=6;break;case 7:n=7;break;case 8:n=8;break;case 9:n=9;break;case 10:n=10;break;case 11:n=11;break;case 12:n=12;break;case 13:n=13;break;case 14:n=14;break;case 15:n=15;break;default:n=e}return{effTyp:n,eff:r}}function u(e){if(e>=0)return 0;const t=e/-72;return 16*(t<8?t:t-16)}function c(e){if(e.byteLength<a)return!1;const l=new DataView(e);if("M.K."!==function(e,t,n){let r="";for(let o=0;o<n;o++){const n=e.getUint8(t+o);if(0===n)break;r+=String.fromCharCode(n)}return r.trim()}(l,1080,4))return!1;const f=t(l,i);if(0===f||f>127)return!1;let u=0;for(let n=0;n<128;n++){const e=t(l,952+n);if(n<f){if(e>63)return!1;e>u&&(u=e)}else if(0!==e)return!1}let c=0;for(let t=0;t<31;t++){const e=16*t,a=n(l,e+0),s=o(l,e+2),i=n(l,e+6),f=o(l,e+8),u=n(l,e+12),p=r(l,e+14);if(a>64)return!1;if(s>2097151||1&s)return!1;if(0===i){if(f!==s||1!==u)return!1}else{if(i>=32768)return!1;if(f<s)return!1;const e=f-s;if(e>=2*i)return!1;if(e+2*u>2*i)return!1;c+=i}if(p<0&&(p<-1080||p%72!=0))return!1}if(c<32)return!1;const p=u+1,m=a+p*s;if(e.byteLength<m)return!1;for(let n=0;n<p;n++){const e=a+n*s;for(let n=0;n<64;n++)for(let r=0;r<4;r++){const o=e+4*(4*n+r),a=t(l,o+0),s=t(l,o+2),i=t(l,o+3);if(3&a)return!1;if(s>72||1&s)return!1;if(7&i)return!1}}return!0}async function p(p,m){if(!c(p))throw new Error("NRUParser: file does not pass NRU format validation");const h=new DataView(p),d=new Uint8Array(p),g=t(h,i),b=t(h,951);let k=0;const y=[];for(let e=0;e<g;e++){const n=t(h,952+e);y.push(n),n>k&&(k=n)}const w=k+1,v=[];for(let e=0;e<31;e++){const t=16*e;v.push({volume:n(h,t+0),sampleAddr:o(h,t+2),length:n(h,t+6),loopStartAddr:o(h,t+8),loopLength:n(h,t+12),finetune:r(h,t+14)})}const P=m.replace(/\.[^/.]+$/,""),S=[];for(let e=0;e<w;e++){const n=a+e*s,r=Array.from({length:4},(e,t)=>({id:`channel-${t}`,name:`Channel ${t+1}`,muted:!1,solo:!1,collapsed:!1,volume:100,pan:l[t],instrumentId:null,color:null,rows:[]}));for(let e=0;e<64;e++)for(let o=0;o<4;o++){const a=n+4*(4*e+o),s=t(h,a+0),i=t(h,a+1),l=t(h,a+2),u=t(h,a+3)>>3,c=l>0?l/2+36:0;let p;p=0===s?3:12===s?0:s>>2;let m=0,d=0;if(0!==p||0!==i){const e=f(p,i);m=e.effTyp,d=e.eff}const g={note:c,instrument:u,volume:0,effTyp:m,eff:d,effTyp2:0,eff2:0};r[o].rows.push(g)}S.push({id:`pattern-${e}`,name:`Pattern ${e}`,length:64,channels:r,importMetadata:{sourceFormat:"NRU",sourceFile:m,importedAt:(new Date).toISOString(),originalChannelCount:4,originalPatternCount:w,originalInstrumentCount:31}})}let C=a+w*s;const U=[];for(let e=0;e<31;e++){const t=2*v[e].length;t>0&&C+t<=p.byteLength?U.push(d.slice(C,C+t)):U.push(null),C+=t}const A=[];for(let t=0;t<31;t++){const n=v[t],r=t+1,o=U[t];if(!o||0===o.length){A.push({id:r,name:`Sample ${r}`,type:"sample",synthType:"Sampler",effects:[],volume:-60,pan:0});continue}let a=0,s=0;n.loopLength>1&&(a=n.loopStartAddr-n.sampleAddr,s=a+2*n.loopLength,s=Math.min(s,o.length));const i=u(n.finetune),l=e(r,`Sample ${r}`,o,n.volume,8287,a,s);0!==i&&l.metadata?.modPlayback&&(l.metadata.modPlayback.finetune=i),A.push(l)}return{name:P,format:"MOD",patterns:S,instruments:A,songPositions:y,songLength:y.length,restartPosition:b,numChannels:4,initialSpeed:6,initialBPM:125,linearPeriods:!1}}export{c as isNRUFormat,p as parseNRUFile};
