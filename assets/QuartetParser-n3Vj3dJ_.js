function t(t,n){return t[n]??0}function n(t,n){return((t[n]??0)<<8|(t[n+1]??0))>>>0}function e(t,n){return((t[n]??0)<<24|(t[n+1]??0)<<16|(t[n+2]??0)<<8|(t[n+3]??0))>>>0}function r(t){const n=t.toLowerCase();return n.startsWith("qpa.")?"qpa":n.startsWith("sqt.")?"sqt":n.startsWith("qts.")?"qts":null}function i(r){if(r.length<8)return!1;if(80!==t(r,1))return!1;const i=t(r,0);if(0===i||i>30)return!1;if(3e3%i!=0)return!1;const o=-2&r.length;let s=!1;for(let t=0;t<16;t++){const i=o-2-2*t;if(i<0)break;const u=n(r,i);if(0!==u){if(65535===u){if(i-2<0||i-6<0)break;const t=e(r,i-2),n=e(r,i-6);4294967295===t&&4294967295===n&&(s=!0);break}break}}return s}function o(t){if(t.length<24)return!1;let r=0;for(let e=0;e<4;e++){if(24576!==n(t,r))return!1;const e=n(t,r+2);if(0===e)return!1;if(32768&e)return!1;if(1&e)return!1;r+=4}if(18938!==n(t,16))return!1;const i=10+n(t,10);return!(i+10>t.length)&&(1223163902===e(t,i)&&(19962===n(t,i+4)&&(20974===n(t,i+8)&&(!(i+12+2>t.length)&&24832===n(t,i+12)))))}function s(r){if(r.length<28)return!1;const i=n(r,0);if(0===i||i>16)return!1;if(4!==t(r,7))return!1;if(t(r,6)>4)return!1;if(0!==e(r,8))return!1;if(22356!==n(r,12)&&0!==e(r,12))return!1;const o=e(r,24);return!(o>76)&&(!(3&o)&&86===n(r,16))}function u(t,n){const e=new Uint8Array(t);if(n){const t=r(n.split("/").pop()??n);if("qpa"===t)return i(e);if("sqt"===t)return o(e);if("qts"===t)return s(e)}return i(e)||o(e)||s(e)}const a={qpa:"Quartet",sqt:"Quartet PSG",qts:"Quartet ST"};async function f(e,u){const f=new Uint8Array(e),l=u.split("/").pop()??u,c=function(t,n){if(n){const t=r(n.split("/").pop()??n);if(t)return t}return i(t)?"qpa":o(t)?"sqt":s(t)?"qts":null}(f,u);if(null===c)throw new Error("Not a Quartet module");const p=function(t){return t.replace(/^(qpa|sqt|qts)\./i,"")||t}(l),h=a[c];let m=6;if("qpa"===c&&f.length>=1){const n=t(f,0);n>=1&&n<=30&&(m=n)}else if("qts"===c&&f.length>=2){const t=n(f,0);t>=1&&t<=16&&(m=t)}const q="qpa"===c?16:"qts"===c?20:0,g=[];for(let t=0;t<q;t++)g.push({id:t+1,name:`Sample ${t+1}`,type:"synth",synthType:"Synth",effects:[],volume:0,pan:0});0===g.length&&g.push({id:1,name:"Channel 1",type:"synth",synthType:"Synth",effects:[],volume:0,pan:0});const y=function(t,n){const e=Array.from({length:64},()=>({note:0,instrument:0,volume:0,effTyp:0,eff:0,effTyp2:0,eff2:0}));return{id:"pattern-0",name:"Pattern 0",length:64,channels:Array.from({length:4},(t,n)=>({id:`channel-${n}`,name:`Channel ${n+1}`,muted:!1,solo:!1,collapsed:!1,volume:100,pan:0===n||3===n?-50:50,instrumentId:null,color:null,rows:e})),importMetadata:{sourceFormat:"MOD",sourceFile:t,importedAt:(new Date).toISOString(),originalChannelCount:4,originalPatternCount:1,originalInstrumentCount:n}}}(u,q);return{name:`${p} [${h}]`,format:"MOD",patterns:[y],instruments:g,songPositions:[0],songLength:1,restartPosition:0,numChannels:4,initialSpeed:m,initialBPM:125,linearPeriods:!1}}export{u as isQuartetFormat,f as parseQuartetFile};
