import{aB as t}from"./index-zx6LJBPK.js";import"./vendor-react-DkDaD07v.js";import"./vendor-utils-XMmR-oGw.js";import"./vendor-tone-CADp_hfL.js";import"./vendor-ui-uomqNFY-.js";function e(t,e){return t.getUint8(e)}function n(t,e){return t.getUint16(e,!1)}function r(t,e){return t.getUint32(e,!1)}function o(t,n,r){let o="";for(let i=0;i<r;i++){const r=e(t,n+i);if(0===r)break;o+=String.fromCharCode(r)}return o}function i(t){if(t.byteLength<82)return!1;const r=new DataView(t.buffer,t.byteOffset,t.byteLength);for(let n=0;n<4;n++)if(e(r,n)!=="FTMN".charCodeAt(n))return!1;const o=e(r,4),i=e(r,5),f=n(r,8),a=e(r,10),l=e(r,12),u=e(r,13),s=e(r,14),c=e(r,15),m=e(r,80),h=e(r,81);if(3!==o)return!1;if(i>=64)return!1;if(f<4096||f>20479)return!1;if(a>=12)return!1;if(l>=64)return!1;if(252&u)return!1;if(!(1&u))return!1;if(s<1||s>24)return!1;if(c<4||c>96)return!1;if(c!==Math.floor(96/s))return!1;if(m>64)return!1;if(0!==h)return!1;const p=32*i+4*m;return!(t.byteLength<82+p)}function f(f,a){if(!i(f))return null;const l=new DataView(f.buffer,f.byteOffset,f.byteLength),u=e(l,5),s=n(l,6),c=n(l,8),m=e(l,11),h=e(l,12),p=e(l,13),g=e(l,14),y=e(l,15),d=o(l,16,32),b=o(l,48,32),C=e(l,80),A=!!(1&p),M=Math.round(1777517.482/c),L=[];let T=82;for(let t=0;t<u;t++)L.push(o(l,T,30)),T+=32;for(let t=0;t<C;t++){if(T+4>f.byteLength)return null;const t=n(l,T);if(t>512)return null;T+=4,T+=4*t}const v=Array.from({length:s},()=>Array.from({length:y},()=>Array.from({length:8},()=>({note:0,instrument:0,volume:0,effTyp:0,eff:0,effTyp2:0,eff2:0}))));for(let t=0;t<8&&!(T+6>f.byteLength);t++){const o=n(l,T);T+=2;const i=r(l,T);if(T+=4,T+i>f.byteLength)return null;const a=T+i;let u=0,c=o;for(;T+2<=a;){const n=e(l,T),r=e(l,T+1);if(T+=2,!(240&~n)){c=r|(15&n)<<8;continue}const i=u+c,f=Math.floor(i/y),a=i%y;if(f>=s)break;const m=v[f][a][t],h=(15&n)<<2|r>>6;switch(240&n){case 0:m.instrument=h;break;case 176:m.effTyp=28,m.eff=h;break;case 192:m.effTyp=3,m.eff=h;break;case 208:m.effTyp=10,m.eff=h;break;case 224:break;default:{const t=64*((n>>4)-1)/9;m.effTyp=65,m.volume=Math.round(t),m.instrument=h;break}}const p=63&r;p>=35?m.note=97:0!==p&&(m.note=48+p),u+=1+c,c=o}T=a}const k=Array(u).fill(null),w=Array(u).fill(0),$=Array(u).fill(0);if(A)for(let t=0;t<u;t++){if(!L[t])continue;if(T+4>f.byteLength)break;const e=n(l,T),r=n(l,T+2);T+=4;const o=2*e,i=2*r,a=o+i;if(0!==a)if(T+a>f.byteLength){const e=f.byteLength-T;e>0&&(k[t]=f.slice(T,T+e),w[t]=o,$[t]=i),T+=Math.min(a,f.byteLength-T)}else k[t]=f.slice(T,T+a),w[t]=o,$[t]=i,T+=a}const P=[];for(let e=0;e<u;e++){const n=e+1,r=L[e]||`Sample ${n}`,o=k[e];if(!o||0===o.length){P.push({id:n,name:r,type:"sample",synthType:"Sampler",effects:[],volume:0,pan:0});continue}const i=w[e],f=$[e],a=f>0?i+f:0;P.push(t(n,r,o,Math.round(h/63*64),8287,i,a))}const S=[-50,-50,50,50,50,50,-50,-50],F=Array.from({length:s},(t,e)=>{const n=Array.from({length:8},(t,n)=>{const r=v[e].map(t=>t[n]);return{id:`channel-${n}`,name:`Channel ${n+1}`,muted:!!(m&1<<n),solo:!1,collapsed:!1,volume:100,pan:S[n],instrumentId:null,color:null,rows:r}});return{id:`pattern-${e}`,name:`Pattern ${e}`,length:y,channels:n,importMetadata:{sourceFormat:"FaceTheMusic",sourceFile:a,importedAt:(new Date).toISOString(),originalChannelCount:8,originalPatternCount:s,originalInstrumentCount:u}}});0===F.length&&F.push({id:"pattern-0",name:"Pattern 0",length:y,channels:Array.from({length:8},(t,e)=>({id:`channel-${e}`,name:`Channel ${e+1}`,muted:!1,solo:!1,collapsed:!1,volume:100,pan:S[e],instrumentId:null,color:null,rows:Array.from({length:y},()=>({note:0,instrument:0,volume:0,effTyp:0,eff:0,effTyp2:0,eff2:0}))})),importMetadata:{sourceFormat:"FaceTheMusic",sourceFile:a,importedAt:(new Date).toISOString(),originalChannelCount:8,originalPatternCount:0,originalInstrumentCount:u}});const I=F.map((t,e)=>e);return{name:d.trim()||(b.trim()?`${b.trim()}`:a.replace(/\.[^/.]+$/,"")),format:"MOD",patterns:F,instruments:P,songPositions:I,songLength:I.length,restartPosition:0,numChannels:8,initialSpeed:g,initialBPM:M,linearPeriods:!0}}export{i as isFaceTheMusicFormat,f as parseFaceTheMusicFile};
