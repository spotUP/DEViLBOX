import{aB as e}from"./index-zx6LJBPK.js";import"./vendor-react-DkDaD07v.js";import"./vendor-utils-XMmR-oGw.js";import"./vendor-tone-CADp_hfL.js";import"./vendor-ui-uomqNFY-.js";function n(e,n){return e.getUint8(n)}function t(e,n){return e.getUint16(n,!0)}function r(e,n){return e.getUint32(n,!0)}function o(e,n){return e.getInt8(n)}function f(e,n,t){let r="";for(let o=0;o<t;o++){const t=e.getUint8(n+o);if(0===t)break;r+=String.fromCharCode(t)}return r.trim()}const a=42;function i(e,r){return{id:String.fromCharCode(n(e,r),n(e,r+1),n(e,r+2),n(e,r+3)),space:n(e,r+4),name:f(e,r+5,32),eof:n(e,r+37),version:t(e,r+38),objectSize:t(e,r+40)}}function s(e){return"RTMM"===e.id&&32===e.space&&26===e.eof&&e.version>=256&&e.version<=274&&e.objectSize>=98}function u(e){if(e.byteLength<46)return!1;const n=new DataView(e);try{return s(i(n,0))}catch{return!1}}function l(e,o){return{flags:t(e,o+0),numTracks:n(e,o+2),numRows:t(e,o+3),packedSize:r(e,o+5)}}function c(e,r,o){return{numSamples:o>0?n(e,r):0,flags:o>2?t(e,r+1):0}}function m(e,f){return{flags:t(e,f+0),baseVolume:n(e,f+2),defaultVolume:n(e,f+3),length:r(e,f+4),loopType:n(e,f+8),loopStart:r(e,f+12),loopEnd:r(e,f+16),sampleRate:r(e,f+20),baseNote:n(e,f+24),panning:o(e,f+25)}}function p(e,n){if(0===e&&0===n)return{effTyp:0,eff:0};if(8===e)return{effTyp:8,eff:Math.min(255,2*n)};if(e==="S".charCodeAt(0)-55&&160==(240&n))return{effTyp:19,eff:n};const t="X".charCodeAt(0)-55;if(e>=1&&e<=t)return{effTyp:e,eff:n};switch(e){case 36:return{effTyp:10,eff:n};case 37:return{effTyp:1,eff:n};case 38:return{effTyp:2,eff:n};case 39:return{effTyp:6,eff:n};case 40:return{effTyp:15,eff:n};default:return{effTyp:0,eff:0}}}function h(e){const n=new Uint8Array(e.length);let t=0;for(let r=0;r<e.length;r++){t=t+(e[r]<128?e[r]:e[r]-256)&255,n[r]=t}return n}function g(e){const n=new Uint8Array(e.length),t=new DataView(n.buffer);let r=0;for(let o=0;o+1<e.length;o+=2){const n=e[o+1]<<8|e[o];r=r+(n<32768?n:n-65536)&65535;const f=r<32768?r:r-65536;t.setInt16(o,f,!0)}return n}function d(e){const n=Math.min(255,2*(e+64));return Math.round(100*(n/128-1))}function y(e,n){return{id:e,name:n,type:"sample",synthType:"Sampler",effects:[],volume:-60,pan:0}}async function b(u,b){const T=new DataView(u),M=new Uint8Array(u);if(u.byteLength<a)throw new Error("RTMParser: file too small for RTMObjectHeader");const w=i(T,0);if(!s(w))throw new Error("RTMParser: invalid RTMM object header");const S=Math.min(w.objectSize,130);if(u.byteLength<42+S)throw new Error("RTMParser: file truncated reading RTMMHeader");const C=function(e,a,i){const s=a,u=e=>i>=e,l=f(e,s+0,20),c=u(52)?f(e,s+20,32):"",m=u(54)?t(e,s+52):0,p=u(55)?n(e,s+54):0,h=u(56)?n(e,s+55):0,g=u(58)?t(e,s+56):0,d=u(60)?t(e,s+58):0,y=u(61)?n(e,s+60):6,b=u(62)?n(e,s+61):125,T=[];for(let n=0;n<32;n++)T.push(u(63+n)?o(e,s+62+n):0);return{software:l,composer:c,flags:m,numChannels:p,numInstruments:h,numOrders:g,numPatterns:d,speed:y,tempo:b,panning:T,extraDataSize:u(98)?r(e,s+94):0,originalName:u(130)?f(e,s+98,32):""}}(T,42,S);if(0===C.numChannels||C.numChannels>32)throw new Error(`RTMParser: invalid numChannels (${C.numChannels})`);if(0===C.speed)throw new Error("RTMParser: invalid speed (0)");let j=a+w.objectSize;const R=j,k=R+C.extraDataSize,v=[];let z=R;for(let e=0;e<C.numOrders&&z+2<=k&&z+2<=u.byteLength;e++)v.push(t(T,z)),z+=2;j=k;let P=w.name;!P&&w.version>=274&&(P=C.originalName),P||(P=b.replace(/\.[^/.]+$/i,""));const A=C.numChannels,L=C.numPatterns,U=C.numInstruments,I=[];for(let e=0;e<L&&!(j+a>u.byteLength);e++){const t=i(T,j);if(j+=a,j+9>u.byteLength)break;const r=l(T,j);j+=t.objectSize;const o=j;j+=r.packedSize;const f=j,s=Math.max(1,r.numRows),c=Array.from({length:s},()=>Array.from({length:A},()=>({note:0,instrument:0,volume:0,effTyp:0,eff:0,effTyp2:0,eff2:0})));let m=o,h=0,g=0;for(;h<s&&m<f;){const e=n(T,m++);if(0===e){h++,g=0;continue}if(1&e){if(m>=f)break;g=n(T,m++)}if(g>=A)break;const t=c[h][g];if(2&e){if(m>=f)break;const e=n(T,m++);254===e?t.note=97:e<120&&(t.note=e+1)}if(4&e){if(m>=f)break;t.instrument=n(T,m++)}let r=0,o=0,a=0,i=0;if(8&e){if(m>=f)break;r=n(T,m++)}if(16&e){if(m>=f)break;o=n(T,m++)}if(32&e){if(m>=f)break;a=n(T,m++)}if(64&e){if(m>=f)break;i=n(T,m++)}if(0!==r||0!==o){const e=p(r,o);t.effTyp=e.effTyp,t.eff=e.eff}if(0!==a||0!==i){const e=p(a,i);t.effTyp2=e.effTyp,t.eff2=e.eff}g++}const y=Array.from({length:A},(e,n)=>({id:`channel-${n}`,name:`Channel ${n+1}`,muted:!1,solo:!1,collapsed:!1,volume:100,pan:d(C.panning[n]??0),instrumentId:null,color:null,rows:c.map(e=>e[n])}));I.push({id:`pattern-${e}`,name:t.name||`Pattern ${e}`,length:s,channels:y,importMetadata:{sourceFormat:"RTM",sourceFile:b,importedAt:(new Date).toISOString(),originalChannelCount:A,originalPatternCount:L,originalInstrumentCount:U}})}const E=Math.max(0,I.length-1),$=v.map(e=>Math.min(e,E)),x=[];let D=0;for(let n=0;n<U&&!(j+a>u.byteLength);n++){const t=i(T,j);j+=a;const r=Math.min(t.objectSize,341);if(j+r>u.byteLength){x.push(y(D+1,t.name||`Instrument ${n+1}`)),D++;break}const o=c(T,j,r);j+=t.objectSize;const f=t.name||`Instrument ${n+1}`,s=o.numSamples;if(0!==s)for(let n=0;n<s;n++){const n=D+1;if(D++,j+a>u.byteLength){x.push(y(n,f));continue}const t=i(T,j);j+=a;if(j+Math.min(t.objectSize,26)>u.byteLength){x.push(y(n,f)),j+=t.objectSize;continue}const r=m(T,j);j+=t.objectSize;const o=r.length,s=!!(2&r.flags),l=!!(4&r.flags);if(0===o||j+o>u.byteLength){x.push(y(n,f)),j+=o;continue}const c=t.name||f,p=r.sampleRate>0?r.sampleRate:8363;let d,b,w;if(s){let e=new Uint8Array(M.buffer,M.byteOffset+j,o);l&&(e=g(e));const n=Math.floor(e.length/2);d=new Uint8Array(n);for(let t=0;t<n;t++){const n=e[2*t],r=e[2*t+1]<<8|n,o=r<32768?r:r-65536,f=Math.round(o/256);d[t]=f<0?f+256:f}b=Math.floor(r.loopStart/2),w=Math.floor(r.loopEnd/2)}else{let e=new Uint8Array(M.buffer,M.byteOffset+j,o);l&&(e=h(e)),d=e,b=r.loopStart,w=r.loopEnd}const S=0!==r.loopType&&w>b;x.push(e(n,c,d,r.defaultVolume,p,S?b:0,S?w:0)),j+=o}else x.push(y(D+1,f)),D++}return{name:P,format:"XM",patterns:I,instruments:x,songPositions:$,songLength:$.length,restartPosition:0,numChannels:A,initialSpeed:C.speed,initialBPM:C.tempo,linearPeriods:!!(1&C.flags)}}export{u as isRTMFormat,b as parseRTMFile};
