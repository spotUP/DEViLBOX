import{aW as t}from"./index-zx6LJBPK.js";import"./vendor-react-DkDaD07v.js";import"./vendor-utils-XMmR-oGw.js";import"./vendor-tone-CADp_hfL.js";import"./vendor-ui-uomqNFY-.js";function n(t,n){return t.getUint8(n)}function e(t,n){return t.getUint16(n,!0)}function o(t,n){return t.getUint32(n,!0)}function r(t,n,e){let o="";for(let r=0;r<e;r++){const e=t.getUint8(n+r);if(0===e)break;o+=String.fromCharCode(e)}return o}const i=64;function s(t){const n=t instanceof Uint8Array?t:new Uint8Array(t);return!(n.length<96)&&(83===n[44]&&67===n[45]&&82===n[46]&&77===n[47])}function a(t,n,e,o,r){const i=Math.min(n+e,t.length)-n;if(o){const e=i>>1,o=new ArrayBuffer(2*e),s=new DataView(o);for(let i=0;i<e;i++){const e=n+2*i;if(e+1>=t.length)break;if(r){const n=t[e]|t[e+1]<<8;s.setInt16(2*i,n-32768&65535,!0)}else s.setInt16(2*i,t[e]|t[e+1]<<8,!0)}return o}{const e=new ArrayBuffer(i),o=new Uint8Array(e);for(let s=0;s<i;s++)o[s]=r?128^t[n+s]:t[n+s];return e}}function l(t,n){return{id:t,name:n||`Sample ${t}`,type:"sample",synthType:"Sampler",effects:[],volume:-60,pan:0}}function f(t,n,e,o,r){const s={note:0,instrument:0,volume:0,effTyp:0,eff:0,effTyp2:0,eff2:0},a=[];for(let l=0;l<n;l++)a.push({id:`channel-${l}`,name:`Channel ${l+1}`,muted:!1,solo:!1,collapsed:!1,volume:100,pan:0,instrumentId:null,color:null,rows:Array.from({length:i},()=>({...s}))});return{id:`pattern-${t}`,name:`Pattern ${t}`,length:i,channels:a,importMetadata:{sourceFormat:"S3M",sourceFile:e,importedAt:(new Date).toISOString(),originalChannelCount:n,originalPatternCount:o+1,originalInstrumentCount:r}}}function u(t,n){const e=()=>({note:0,instrument:0,volume:0,effTyp:0,eff:0,effTyp2:0,eff2:0}),o=Array.from({length:i},()=>Array.from({length:n},e));let r=0,s=0;for(;s<i&&r<t.length;){const e=t[r++];if(0===e){s++;continue}const i=31&e;let a=0,l=0,f=0,u=0,c=0;if(32&e){const n=t[r++];if(l=t[r++],254===n)a=97;else if(255!==n){a=12*(n>>4&15)+(15&n)+1}}if(64&e){const n=t[r++];f=n<=64?n:0}128&e&&(u=t[r++],c=t[r++]),i<n&&(o[s][i]={note:a,instrument:l,volume:f,effTyp:u,eff:c,effTyp2:0,eff2:0})}return o}function c(c,p){if(!s(c))throw new Error("Not a valid S3M file");const m=new DataView(c),h=new Uint8Array(c),g=r(m,0,28),d=e(m,32),y=e(m,34),w=e(m,36),S=e(m,42),v=n(m,49)||6,C=n(m,50)||125,$=function(t){let e=0;for(let o=0;o<32;o++)255!==n(t,64+o)&&(e=o+1);return Math.max(e,1)}(m),A=2===S;let M=96;const T=[];for(let t=0;t<d;t++){const e=n(m,M+t);if(255===e)break;254!==e&&T.push(e)}M+=d;const b=[];for(let t=0;t<y;t++)b.push(e(m,M+2*t));M+=2*y;const I=[];for(let t=0;t<w;t++)I.push(e(m,M+2*t));const P=[];for(let e=0;e<y;e++){const i=e+1,s=16*b[e];if(0===s||s+80>c.byteLength){P.push(l(i,`Sample ${i}`));continue}if(1!==n(m,s)){const t=r(m,s+48,28).replace(/\0/g,"").trim()||`Sample ${i}`;P.push(l(i,t));continue}const f=n(m,s+13),u=16*(n(m,s+14)|n(m,s+15)<<8|f<<16),p=o(m,s+16),g=o(m,s+20),d=o(m,s+24),y=Math.min(n(m,s+28),64),w=n(m,s+30),S=n(m,s+31),v=o(m,s+32),C=r(m,s+48,28).replace(/\0/g,"").trim()||`Sample ${i}`;if(1===w||0===p||0===u||u>=c.byteLength){P.push(l(i,C));continue}const $=!!(4&S),M=a(h,u,p*($?2:1),$,A),T=!!(1&S)&&d>g&&d<=p,I=t({id:i,name:C,samples:[{id:i,name:C,pcmData:M,bitDepth:$?16:8,sampleRate:v||8363,length:p,loopStart:T?g:0,loopLength:T?d-g:0,loopType:T?"forward":"none",volume:y,finetune:0,relativeNote:0,panning:128}],fadeout:0},i,"S3M");I.length>0?P.push(I[0]):P.push(l(i,C))}const U=[],D=new Map,j=new Set(T);for(let t=0;t<w;t++)j.add(t);const L=Array.from(j).sort((t,n)=>t-n),F=L.length>0?L[L.length-1]:0;for(const t of L){if(t>=I.length||0===I[t]){D.set(t,U.length),U.push(f(t,$,p,F,y));continue}const n=16*I[t];if(n+2>c.byteLength){D.set(t,U.length),U.push(f(t,$,p,F,y));continue}const o=e(m,n),r=u(h.subarray(n+2,n+2+o),$),s=[];for(let t=0;t<$;t++){const n=[];for(let e=0;e<i;e++)n.push(r[e]?.[t]??{note:0,instrument:0,volume:0,effTyp:0,eff:0,effTyp2:0,eff2:0});s.push({id:`channel-${t}`,name:`Channel ${t+1}`,muted:!1,solo:!1,collapsed:!1,volume:100,pan:0,instrumentId:null,color:null,rows:n})}D.set(t,U.length),U.push({id:`pattern-${t}`,name:`Pattern ${t}`,length:i,channels:s,importMetadata:{sourceFormat:"S3M",sourceFile:p,importedAt:(new Date).toISOString(),originalChannelCount:$,originalPatternCount:F+1,originalInstrumentCount:y}})}const k=[];for(const t of T){const n=D.get(t);void 0!==n&&k.push(n)}return 0===k.length&&k.push(0),{name:g.replace(/\0/g,"").trim()||p.replace(/\.[^/.]+$/,""),format:"S3M",patterns:U,instruments:P,songPositions:k,songLength:k.length,restartPosition:0,numChannels:$,initialSpeed:v,initialBPM:C,linearPeriods:!1}}export{s as isS3MFormat,c as parseS3MFile};
