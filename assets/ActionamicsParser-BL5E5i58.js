import{aB as e}from"./index-zx6LJBPK.js";import"./vendor-react-DkDaD07v.js";import"./vendor-utils-XMmR-oGw.js";import"./vendor-tone-CADp_hfL.js";import"./vendor-ui-uomqNFY-.js";const t="ACTIONAMICS SOUND TOOL",n=[0,5760,5424,5120,4832,4560,4304,4064,3840,3816,3424,3232,3048,2880,2712,2560,2416,2280,2152,2032,1920,1808,1712,1616,1524,1440,1356,1280,1208,1140,1076,1016,960,904,856,808,762,720,678,640,604,570,538,508,480,453,428,404,381,360,339,320,302,285,269,254,240,226,214,202,190,180,170,160,151,143,135,127,120,113,107,101,95];function r(e,t){return e[t]<<8|e[t+1]}function o(e,t){return(e[t]<<24|e[t+1]<<16|e[t+2]<<8|e[t+3])>>>0}function f(e){return e<128?e:e-256}function s(e,t,n){let r="";for(let o=0;o<n;o++){const n=e[t+o];if(0===n)break;n>=32&&n<128&&(r+=String.fromCharCode(n))}return r.trim()}function u(e){if(e<=0||e>=n.length)return 0;const t=e-37+37;return Math.max(1,Math.min(96,t))}function l(e){return Math.round(3546895/(2*e))}function i(e){if(e.length<90)return!1;let n="";for(let t=0;t<22;t++)n+=String.fromCharCode(e[62+t]);return n===t}function a(t,a){if(!i(t))return null;try{return function(t,i){const a=t.length,c=r(t,0),p=[];for(let e=0;e<15;e++)p.push(o(t,2+4*e));const m=62+p[0];if(m+4>a)return null;const h=o(t,m),g=m+p[1],d=p[2],y=p[3],T=p[4];if(d!==y||d!==T)return null;const A=Math.floor(d/4);if(g+d+y+T>a)return null;const N=Array.from({length:4},()=>Array.from({length:A},()=>({trackNumber:0,noteTranspose:0,instrumentTranspose:0})));let S=g;for(let e=0;e<4;e++)for(let n=0;n<A;n++)N[e][n].trackNumber=t[S++];for(let e=0;e<4;e++)for(let n=0;n<A;n++)N[e][n].noteTranspose=f(t[S++]);for(let e=0;e<4;e++)for(let n=0;n<A;n++)N[e][n].instrumentTranspose=f(t[S++]);const C=g+d+y+T,L=p[5],b=Math.floor(L/32);if(C+L>a)return null;const P=[];let M=C;for(let e=0;e<b;e++){const e={sampleNumberListNumber:t[M],sampleNumberListValuesCount:t[M+1],sampleNumberListStartDelta:t[M+2],sampleNumberListCounterEnd:t[M+3],arpeggioListNumber:t[M+4],arpeggioListValuesCount:t[M+5],arpeggioListStartDelta:t[M+6],arpeggioListCounterEnd:t[M+7],frequencyListNumber:t[M+8],frequencyListValuesCount:t[M+9],frequencyListStartDelta:t[M+10],frequencyListCounterEnd:t[M+11],portamentoIncrement:f(t[M+12]),portamentoDelay:t[M+13],noteTranspose:f(t[M+14]),attackEndVolume:t[M+16],attackSpeed:t[M+17],decayEndVolume:t[M+18],decaySpeed:t[M+19],sustainDelay:t[M+20],releaseEndVolume:t[M+21],releaseSpeed:t[M+22]};P.push(e),M+=32}const I=C+L,w=I+p[6]+p[7];function v(e,n){const r=Math.floor(n/16),o=[];for(let s=0;s<r;s++){const n=new Int8Array(16);for(let r=0;r<16;r++)n[r]=f(t[e+16*s+r]);o.push(n)}return o}const $=v(I,p[6]),k=w+p[8]+p[9]+p[10],D=Math.floor(p[11]/4);if(k+p[11]>a)return null;const E=[];for(let e=0;e<D;e++){const n=k+4*e,r={startPosition:t[n],endPosition:t[n+1],loopPosition:t[n+2],speed:t[n+3]};E.push(r)}const O=E.filter(e=>0!==e.startPosition||0!==e.endPosition||0!==e.loopPosition);if(0===O.length){if(!(E.length>0))return null;O.push(E[0])}const V=k+p[11]+p[12],j=p[13],q=Math.floor(j/64);if(V+j>a)return null;const F=[];for(let e=0;e<q;e++){const n=V+64*e,o=r(t,n+4),f=r(t,n+6),u=r(t,n+8),l=r(t,n+12)>>8&255,i=s(t,n+32,32);F.push({name:i,length:o,loopStart:f,loopLength:u,pcm:null,arpeggioListNumber:l})}const U=V+j,x=p[14],B=Math.floor(x/2),z=B-1;if(U+x>a)return null;const G=[];for(let e=0;e<B;e++)G.push(r(t,U+2*e));const H=U+x,J=[];for(let e=0;e<z;e++){const n=H+G[e],r=H+G[e+1];r>a||n>r?J.push(new Uint8Array(0)):J.push(t.slice(n,r))}const K=F.reduce((e,t)=>e+2*t.length,0),Q=h-K;if(Q>=0&&Q+K<=a){let e=Q;for(const n of F)if(n.length>0){const r=2*n.length,o=new Int8Array(r);for(let n=0;n<r;n++)o[n]=f(t[e+n]);n.pcm=o,e+=r}}const R=O[0],W=[];for(let r=0;r<F.length;r++){const t=F[r],o=r+1;if(t.pcm&&t.length>0){const f=new Uint8Array(t.pcm.buffer),s=l(n[37]),u=t.loopLength>1?2*t.loopStart:0,i=t.loopLength>1?2*(t.loopStart+t.loopLength):0;W.push(e(o,t.name||`Sample ${r+1}`,f,64,s,u,i))}else W.push({id:o,name:t.name||`Sample ${r+1}`,type:"synth",synthType:"Synth",effects:[],volume:0,pan:0})}function X(e){const t=[];let n=0,r=0;const o=64;for(;t.length<o&&n<e.length;){if(r>0){t.push({note:0,instrNum:0,effect:0,effectArg:0}),r--;continue}const o=e[n++];if(128&o){r=255&~o,t.push({note:0,instrNum:0,effect:0,effectArg:0});continue}if(o>=112){const r=n<e.length?e[n++]:0;t.push({note:0,instrNum:0,effect:o,effectArg:r});continue}const f=o;let s=0,u=0,l=0;if(n>=e.length){t.push({note:f,instrNum:s,effect:u,effectArg:l});break}const i=e[n++];if(128&i){r=255&~i,t.push({note:f,instrNum:s,effect:u,effectArg:l});continue}if(i>=112){l=n<e.length?e[n++]:0,t.push({note:f,instrNum:s,effect:i,effectArg:l});continue}if(s=i,n>=e.length){t.push({note:f,instrNum:s,effect:u,effectArg:l});break}const a=e[n++];128&a?(r=255&~a,t.push({note:f,instrNum:s,effect:u,effectArg:l})):(u=a,l=n<e.length?e[n++]:0,t.push({note:f,instrNum:s,effect:u,effectArg:l}))}for(;t.length<o;)t.push({note:0,instrNum:0,effect:0,effectArg:0});return t.slice(0,o)}function Y(e,t){switch(e){case 112:return{effTyp:0,eff:t};case 113:return{effTyp:1,eff:t};case 114:return{effTyp:2,eff:t};case 115:case 125:return{effTyp:10,eff:t};case 116:return{effTyp:4,eff:t};case 117:case 127:return{effTyp:15,eff:t};case 118:case 121:return{effTyp:9,eff:t};case 119:return{effTyp:14,eff:208|15&t};case 120:return{effTyp:14,eff:192|15&t};case 122:return{effTyp:7,eff:t};case 123:return{effTyp:13,eff:t};case 124:return{effTyp:12,eff:Math.min(64,t)};case 126:return{effTyp:6,eff:t};default:return{effTyp:0,eff:0}}}const Z=R.startPosition,_=R.endPosition,ee=64,te=[];for(let e=Z;e<=_&&e<A;e++){const t=Array.from({length:4},()=>[]);for(let r=0;r<4;r++){const n=N[r][e],o=n.trackNumber,f=n.noteTranspose,s=n.instrumentTranspose,l=X(o<J.length?J[o]:new Uint8Array(0));for(let e=0;e<ee;e++){const n=l[e]||{note:0,instrNum:0,effect:0,effectArg:0};let o=0,i=0;if(n.note>0){if(o=u(n.note+f),n.instrNum>0){const e=n.instrNum-1+s;if(e>=0&&e<P.length){const t=P[e].sampleNumberListNumber;if(t<$.length){const e=$[t][0];i=(e>=0?e:e+256)+1}else i=n.instrNum}}}const{effTyp:a,eff:c}=Y(n.effect,n.effectArg);t[r].push({note:o,instrument:i,volume:0,effTyp:a,eff:c,effTyp2:0,eff2:0})}}const n=e-Z;te.push({id:`pattern-${n}`,name:`Position ${e}`,length:ee,channels:t.map((e,t)=>({id:`channel-${t}`,name:`Channel ${t+1}`,muted:!1,solo:!1,collapsed:!1,volume:100,pan:[-50,50,50,-50][t]??0,instrumentId:null,color:null,rows:e})),importMetadata:{sourceFormat:"AST",sourceFile:i,importedAt:(new Date).toISOString(),originalChannelCount:4,originalPatternCount:z,originalInstrumentCount:q}})}0===te.length&&te.push({id:"pattern-0",name:"Pattern 0",length:ee,channels:Array.from({length:4},(e,t)=>({id:`channel-${t}`,name:`Channel ${t+1}`,muted:!1,solo:!1,collapsed:!1,volume:100,pan:[-50,50,50,-50][t]??0,instrumentId:null,color:null,rows:Array.from({length:ee},()=>({note:0,instrument:0,volume:0,effTyp:0,eff:0,effTyp2:0,eff2:0}))})),importMetadata:{sourceFormat:"AST",sourceFile:i,importedAt:(new Date).toISOString(),originalChannelCount:4,originalPatternCount:0,originalInstrumentCount:q}});const ne=i.replace(/\.[^/.]+$/,""),re=c>0?c:125,oe=R.speed>0?R.speed:6;return{name:ne,format:"AST",patterns:te,instruments:W,songPositions:te.map((e,t)=>t),songLength:te.length,restartPosition:0,numChannels:4,initialSpeed:oe,initialBPM:re,linearPeriods:!1}}(t,a)}catch(c){return null}}export{i as isActionamicsFormat,a as parseActionamicsFile};
