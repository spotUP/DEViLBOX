function t(t,n){return n>=t.length?0:255&t[n]}function n(n,e){const o=t(n,e);return o<128?o:o-256}function e(t,n){return n+1>=t.length?0:(255&t[n])<<8|255&t[n+1]}function o(t,n){return n+3>=t.length?0:16777216*(255&t[n])+((255&t[n+1])<<16)+((255&t[n+2])<<8)+(255&t[n+3])}function r(t,n,e){let o="";for(let r=0;r<e&&!(n+r>=t.length);r++)o+=String.fromCharCode(t[n+r]);return o}const a=[0,5760,5424,5120,4832,4560,4304,4064,3840,3616,3424,3232,3048,2880,2712,2560,2416,2280,2152,2032,1920,1808,1712,1616,1524,1440,1356,1280,1208,1140,1076,1016,960,904,856,808,762,720,678,640,604,570,538,508,480,452,428,404,381,360,339,320,302,285,269,254,240,226,214,202,190,180,170,160,151,143,135,127],l=[856,808,762,720,678,640,604,570,538,508,480,453,428,404,381,360,339,320,302,285,269,254,240,226,214,202,190,180,170,160,151,143,135,127,120,113];function i(t){if(t<0||t>=a.length)return 0;const n=a[t+1];if(!n||n<=0)return 0;let e=0,o=1/0;for(let a=0;a<l.length;a++){const t=Math.abs(l[a]-n);t<o&&(o=t,e=a)}const r=e+13;return Math.max(1,Math.min(96,r))}function s(t){if(t.byteLength<64)return!1;const n=new Uint8Array(t);for(let o=0;o<n.length-40;o++)if(65===n[o]&&250===n[o+1]){const t=e(n,o+2);if(o+6<n.length&&53736===e(n,o+4)){if(65492===e(n,o+6)){const e=t+o+2;if(e>=0&&e+32<=n.length){if(" SID-MON BY R.v.VLIET  (c) 1988 "===r(n,e,32))return!0}}}}return!1}function f(a,l){const s=new Uint8Array(a);let f=-1,c=0;for(let t=0;t<s.length-10;t++)if(65===s[t]&&250===s[t+1]){if(c=e(s,t+2),t+6>=s.length)continue;if(53736!==e(s,t+4))continue;if(65492===e(s,t+6)){f=c+t+2;break}}if(f<0||f+32>s.length)throw new Error("SidMon 1 format marker not found");const u=r(s,f,32);if(" SID-MON BY R.v.VLIET  (c) 1988 "!==u)throw new Error(`SidMon 1 ID string mismatch: "${u}"`);if(f-28<0||f-24<0)throw new Error("SidMon 1 file too small to read instrument offsets");const p=o(s,f-28);let m=o(s,f-24)-p>>5;m>63&&(m=63);const g=m+1,d=f-24>=4?o(s,f-24):0,y=(f-20>=4?o(s,f-20):d)-d>>5,M=f+d,S=[];for(let t=0;t<y;t++){const n=M+32*t,e=new Int8Array(32);if(n+32<=s.length)for(let t=0;t<32;t++)e[t]=(255&s[n+t])<128?255&s[n+t]:(255&s[n+t])-256;S.push(e)}const w=[],v=f+p;for(let e=1;e<g;e++){const r=v+32*(e-1);if(r+32>s.length)break;const a=o(s,r),l=new Array(16);for(let n=0;n<16;n++)l[n]=t(s,r+4+n);const i=t(s,r+20),f=t(s,r+21),h=t(s,r+22),c=t(s,r+23),u=t(s,r+24),p=t(s,r+26),m=t(s,r+27),g=t(s,r+28),d=t(s,r+29);let M=t(s,r+30);const A=n(s,r+31);M>15&&(M=0);const C=67*M;let I=g;g>y&&(I=0);let k=new Array(32).fill(0);(a<=15&&a<S.length||a<S.length)&&(k=Array.from(S[a])),k.every(t=>0===t)&&S.length>0&&(k=Array.from(S[0]));let $=new Array(32).fill(0);I>0&&I<S.length&&($=Array.from(S[I]));const T={arpeggio:l,attackSpeed:i,attackMax:f,decaySpeed:h,decayMin:c,sustain:u,releaseSpeed:p,releaseMin:m,phaseShift:I,phaseSpeed:d,finetune:C,pitchFall:A,mainWave:k,phaseWave:$};w.push({id:e,name:`SM1 ${e}`,type:"synth",synthType:"SidMon1Synth",sidmon1:T,effects:[],volume:-6,pan:0})}var A;0===w.length&&w.push({id:A=1,name:`SM1 ${A}`,type:"synth",synthType:"SidMon1Synth",sidmon1:{arpeggio:new Array(16).fill(0),attackSpeed:8,attackMax:64,decaySpeed:4,decayMin:32,sustain:0,releaseSpeed:4,releaseMin:0,phaseShift:0,phaseSpeed:0,finetune:0,pitchFall:0,mainWave:[127,100,71,41,9,-22,-53,-82,-108,-127,-127,-127,-108,-82,-53,-22,9,41,71,100,127,100,71,41,9,-22,-53,-82,-108,-127,-127,-127],phaseWave:new Array(32).fill(0)},effects:[],volume:-6,pan:0});const C=f-12>=0?o(s,f-12):0,I=f-8>=0?o(s,f-8):C,k=Math.floor((I-C)/5),$=[],T=f+C;for(let n=0;n<k&&n<2048;n++){const e=T+5*n;if(e+5>s.length)break;$.push({note:t(s,e),sample:t(s,e+1),effect:t(s,e+2),param:t(s,e+3),speed:t(s,e+4)})}const b=f-44>=0?o(s,f-44):0,D=f-28>=0?o(s,f-28):b,P=Math.floor((D-b)/6),x=[],O=f+b;for(let t=0;t<P&&t<512;t++){const e=O+6*t;if(e+6>s.length)break;const r=o(s,e),a=n(s,e+5);x.push({pattern:r,transpose:a>=-99&&a<=99?a:0})}const F=f-8>=0?o(s,f-8):0,E=f-4>=0?o(s,f-4):F,L=f+(F>0?F:0),W=Math.max(1,Math.min(256,E>F?E-F>>2:1)),B=[];for(let t=0;t<W;t++){const n=L+4+4*t;if(n+4>s.length)break;const e=Math.floor(o(s,n)/5);if(0===e&&t>0)break;B.push(e)}const N=[];for(let t=1;t<4&&f-44+4+4*t<s.length;t++){const n=f-44+4*t;n+4<=s.length&&o(s,n)}const R=Math.min(32,Math.max(1,Math.floor(P/4)));for(let t=0;t<R;t++){const n=[[],[],[],[]];for(let e=0;e<4;e++){const o=x[4*t+e]??{pattern:0,transpose:0},r=B[o.pattern]??0,a=[];for(let t=0;t<16;t++){const n=$[r+t];if(!n){a.push(h());continue}if(0===n.note||255===n.note||0===n.sample){a.push(h());continue}const e=n.note+o.transpose,l=i(Math.max(0,e-1)),s=Math.min(n.sample,w.length);a.push({note:l,instrument:s,volume:0,effTyp:0,eff:0,effTyp2:0,eff2:0})}for(;a.length<16;)a.push(h());n[e]=a}N.push({id:`pattern-${t}`,name:`Pattern ${t}`,length:16,channels:n.map((t,n)=>({id:`channel-${n}`,name:`Channel ${n+1}`,muted:!1,solo:!1,collapsed:!1,volume:100,pan:0===n||3===n?-50:50,instrumentId:null,color:null,rows:t})),importMetadata:{sourceFormat:"MOD",sourceFile:l,importedAt:(new Date).toISOString(),originalChannelCount:4,originalPatternCount:R,originalInstrumentCount:w.length}})}0===N.length&&N.push(function(t,n){return{id:"pattern-0",name:"Pattern 0",length:16,channels:Array.from({length:4},(t,n)=>({id:`channel-${n}`,name:`Channel ${n+1}`,muted:!1,solo:!1,collapsed:!1,volume:100,pan:0===n||3===n?-50:50,instrumentId:null,color:null,rows:Array.from({length:16},()=>({note:0,instrument:0,volume:0,effTyp:0,eff:0,effTyp2:0,eff2:0}))})),importMetadata:{sourceFormat:"MOD",sourceFile:t,importedAt:(new Date).toISOString(),originalChannelCount:4,originalPatternCount:0,originalInstrumentCount:n}}}(l,w.length));return{name:`${l.replace(/\.[^/.]+$/,"")} [SidMon 1.0]`,format:"MOD",patterns:N,instruments:w,songPositions:N.map((t,n)=>n),songLength:N.length,restartPosition:0,numChannels:4,initialSpeed:6,initialBPM:125,linearPeriods:!1}}function h(){return{note:0,instrument:0,volume:0,effTyp:0,eff:0,effTyp2:0,eff2:0}}export{s as isSidMon1Format,f as parseSidMon1File};
