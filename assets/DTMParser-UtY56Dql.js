import{aB as e,aD as t,aC as n}from"./index-zx6LJBPK.js";import"./vendor-react-DkDaD07v.js";import"./vendor-utils-XMmR-oGw.js";import"./vendor-tone-CADp_hfL.js";import"./vendor-ui-uomqNFY-.js";function o(e,t){return e.getUint8(t)}function r(e,t){return e.getUint16(t,!1)}function f(e,t){return e.getUint32(t,!1)}function s(e,t,n){let o="";for(let r=0;r<n;r++){const n=e.getUint8(t+r);if(0===n)break;o+=String.fromCharCode(n)}return o.trim()}function a(e){return(e.charCodeAt(0)<<24|e.charCodeAt(1)<<16|e.charCodeAt(2)<<8|e.charCodeAt(3))>>>0}const i=a("S.Q."),l=a("PATT"),u=a("INST"),c=a("DAPT"),h=a("DAIT"),m=a("2.04"),p=a("2.06"),g=[-50,50,50,-50];function d(e,t){let n=15&e,o=t;switch(n){case 1:case 2:0===o&&(n=0);break;case 10:case 5:case 6:240&o?o&=240:0===o&&(n=0)}return{effTyp:n,eff:o}}function w(e,o,r,f){const s=(15&e)<<8|o,a=240&e|r>>4|(48&e)<<4,i=15&r,l=f;let u=0;if(s>0){const e=t(s);u=n(e)}const{effTyp:c,eff:h}=d(i,l);return{note:u,instrument:a,volume:0,effTyp:c,eff:h,effTyp2:0,eff2:0}}function y(e,t,n,o){let r=0;e>0&&e<128&&(r=12*(e>>4)+(15&e)+12);const f=t>>2,s=f>0?f-1:0,a=(3&t)<<4|n>>4,i=15&n,l=o,{effTyp:u,eff:c}=d(i,l);return{note:r,instrument:a,volume:s,effTyp:u,eff:c,effTyp2:0,eff2:0}}function T(e){if(e.byteLength<22)return!1;const t=new DataView(e);if(68!==o(t,0)||46!==o(t,1)||84!==o(t,2)||46!==o(t,3))return!1;if(f(t,4)<14)return!1;return 0===r(t,8)}function M(e,t){return{length:f(e,t+4),finetune:o(e,t+8),volume:Math.min(o(e,t+9),64),loopStart:f(e,t+10),loopLength:f(e,t+14),name:s(e,t+18,22),stereo:!!(1&o(e,t+40)),is16bit:o(e,t+41)>8,sampleRate:f(e,t+46)}}function v(e){const t=Math.floor(e.length/2),n=new Uint8Array(t),o=new DataView(e.buffer,e.byteOffset,e.byteLength);for(let r=0;r<t;r++){const e=o.getInt16(2*r,!1);n[r]=128+(e>>8)&255}return n}function C(e){const t=Math.floor(e.length/2),n=new Uint8Array(t);for(let o=0;o<t;o++)n[o]=e[2*o];return n}function D(e){return 12.5*(e>7?e-16:e)}async function S(t,n){if(!T(t))throw new Error("DTMParser: file does not pass DTM format validation");const a=new DataView(t),d=new Uint8Array(t),S=f(a,4),A=o(a,10),P=r(a,14),$=r(a,16),b=f(a,18),I=P>0?P:6,x=$>0?$:125,k=Math.max(0,S-14),L=s(a,22,k)||n.replace(/\.[^/.]+$/,""),U=function(e,t){const n=[];let o=t;for(;o+8<=e.byteLength;){const t=f(e,o),r=f(e,o+4);n.push({id:t,offset:o+8,length:r}),o+=8+r,1&r&&o++}return n}(a,22+k),j=e=>U.find(t=>t.id===e),E=e=>U.filter(t=>t.id===e),F=j(l);if(!F)throw new Error("DTMParser: missing PATT chunk");const O=r(a,F.offset),R=r(a,F.offset+2),V=f(a,F.offset+4);if(O<1||O>32)throw new Error(`DTMParser: invalid channel count ${O}`);if(0!==V&&V!==m&&V!==p)throw new Error(`DTMParser: unknown pattern format 0x${V.toString(16)}`);const B=j(i);if(!B)throw new Error("DTMParser: missing S.Q. chunk");const Q=r(a,B.offset),N=r(a,B.offset+2),q=[];for(let e=0;e<Q;e++)q.push(o(a,B.offset+8+e));const z=[];let G=0;const H=j(u);if(H){let e=r(a,H.offset);const t=!!(32768&e);if(e&=32767,e<256){let n=H.offset+2;for(let o=0;o<e;o++){let e;if(t?(e=r(a,n)+1,n+=2):e=o+1,n+50>H.offset+H.length)break;const f=M(a,n);n+=50,e>=1&&e<256&&(z.push({realIndex:e,header:f}),e>G&&(G=e))}}}const J=new Map;for(const e of E(h)){if(e.length<2)continue;const t=r(a,e.offset),n=e.offset+2,o=e.length-2;o>0&&J.set(t,d.slice(n,n+o))}const K=[],W=new Map;for(const e of z)W.set(e.realIndex,e);for(let o=1;o<=G;o++){const t=W.get(o);if(!t){K.push({id:o,name:`Sample ${o}`,type:"sample",synthType:"Sampler",effects:[],volume:-60,pan:0});continue}const n=t.header,r=J.get(o-1);if(!r||0===r.length){K.push({id:o,name:n.name||`Sample ${o}`,type:"sample",synthType:"Sampler",effects:[],volume:n.volume>0?20*Math.log10(n.volume/64):-60,pan:0});continue}let f=r;n.is16bit&&(f=v(f)),n.stereo&&(f=C(f));const s=0===V&&b>0?b:n.sampleRate>0?n.sampleRate:8363;let a=0,i=0;if(n.loopLength>1){let e=n.loopStart,t=n.loopLength;n.is16bit&&(e=Math.floor(e/2),t=Math.floor(t/2)),n.stereo&&(e=Math.floor(e/2),t=Math.floor(t/2)),a=e,i=Math.min(e+t,f.length)}const l=D(n.finetune),u=e(o,n.name||`Sample ${o}`,f,n.volume,s,a,i);0!==l&&u.sample&&(u.sample.detune=l),K.push(u)}const X=new Map;for(const e of E(c)){if(e.length<8)continue;let t=e.offset+4;const f=r(a,t);t+=2;let s=r(a,t);if(t+=2,V===p&&(s=Math.max(1,Math.floor(s/I))),f>255||0===s)continue;const i=Array.from({length:O},(e,t)=>({id:`channel-${t}`,name:`Channel ${t+1}`,muted:!1,solo:!1,collapsed:!1,volume:100,pan:0===A?g[t%4]??0:0,instrumentId:null,color:null,rows:[]}));if(V===p)for(let e=0;e<s;e++)for(let t=0;t<O;t++)i[t].rows.push({note:0,instrument:0,volume:0,effTyp:0,eff:0,effTyp2:0,eff2:0});else if(0===V)for(let n=0;n<s;n++)for(let r=0;r<O;r++){const f=t+4*(n*O+r);if(f+4>e.offset+e.length)i[r].rows.push({note:0,instrument:0,volume:0,effTyp:0,eff:0,effTyp2:0,eff2:0});else{const e=o(a,f),t=o(a,f+1),n=o(a,f+2),s=o(a,f+3);i[r].rows.push(w(e,t,n,s))}}else for(let n=0;n<s;n++)for(let r=0;r<O;r++){const f=t+4*(n*O+r);if(f+4>e.offset+e.length)i[r].rows.push({note:0,instrument:0,volume:0,effTyp:0,eff:0,effTyp2:0,eff2:0});else{const e=o(a,f),t=o(a,f+1),n=o(a,f+2),s=o(a,f+3);i[r].rows.push(y(e,t,n,s))}}X.set(f,{id:`pattern-${f}`,name:`Pattern ${f}`,length:s,channels:i,importMetadata:{sourceFormat:"DTM",sourceFile:n,importedAt:(new Date).toISOString(),originalChannelCount:O,originalPatternCount:R,originalInstrumentCount:G}})}const Y=Math.max(0,...q,...X.keys()),Z=[];for(let e=0;e<=Y;e++){const t=X.get(e);if(t)Z.push(t);else{const t=Array.from({length:O},(e,t)=>({id:`channel-${t}`,name:`Channel ${t+1}`,muted:!1,solo:!1,collapsed:!1,volume:100,pan:0===A?g[t%4]??0:0,instrumentId:null,color:null,rows:Array.from({length:64},()=>({note:0,instrument:0,volume:0,effTyp:0,eff:0,effTyp2:0,eff2:0}))}));Z.push({id:`pattern-${e}`,name:`Pattern ${e}`,length:64,channels:t,importMetadata:{sourceFormat:"DTM",sourceFile:n,importedAt:(new Date).toISOString(),originalChannelCount:O,originalPatternCount:R,originalInstrumentCount:G}})}}return{name:L,format:"MOD",patterns:Z,instruments:K,songPositions:q,songLength:q.length,restartPosition:N,numChannels:O,initialSpeed:I,initialBPM:x,linearPeriods:!1}}export{T as isDTMFormat,S as parseDTMFile};
