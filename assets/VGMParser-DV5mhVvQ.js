import{aU as t}from"./index-zx6LJBPK.js";import"./vendor-react-DkDaD07v.js";import"./vendor-utils-XMmR-oGw.js";import"./vendor-tone-CADp_hfL.js";import"./vendor-ui-uomqNFY-.js";function n(){return{note:0,instrument:0,volume:0,effTyp:0,eff:0,effTyp2:0,eff2:0}}function e(t,n){const e=7670454*t/(144*(1<<21-n));if(e<=0)return 0;const o=Math.round(12*Math.log2(e/440)+69);return Math.max(1,Math.min(96,o))}function o(t,n){if(t<=0)return 0;const e=n/(32*t);if(e<=0)return 0;const o=Math.round(12*Math.log2(e/440)+69);return Math.max(1,Math.min(96,o))}const r=[1,2,3,4,5,6,7,8,9,10,11,0];function s(t){const n=t>>4&7,e=Math.min(15&t,11),o=12*n+r[e]+12;return Math.max(1,Math.min(96,o))}function a(t,n){if("Gd3 "!==String.fromCharCode(t[n],t[n+1],t[n+2],t[n+3]))return{trackName:"",gameName:"",systemName:"",author:"",date:""};let e=n+12;const o=()=>{const n=function(t,n){let e="",o=n;for(;o+1<t.length;){const n=t[o],r=t[o+1];if(0===n&&0===r){o+=2;break}e+=String.fromCharCode(n|r<<8),o+=2}return{text:e,nextOff:o}}(t,e);return e=n.nextOff,n.text},r=o();o();const s=o();o();const a=o();o();const i=o();o();return{trackName:r,gameName:s,systemName:a,author:i,date:o()}}function i(t,e,o){const r=function(t,e,o,r){return{id:t,name:e,length:r,channels:Array.from({length:o},(t,e)=>({id:`ch${e}`,name:`CH ${e+1}`,muted:!1,solo:!1,collapsed:!1,volume:100,pan:0,instrumentId:null,color:null,rows:Array.from({length:r},n)}))}}("p0","Pattern 1",e,o);for(const n of t){const t=Math.min(Math.floor(n.tick/735),o-1),s=Math.min(n.ch,e-1),a=r.channels[s].rows[t];n.on&&0===a.note?(a.note=n.note,a.instrument=n.instIdx+1):n.on||0!==a.note||(a.note=97)}return r}function c(t){const n=new Uint8Array(t);return n.length>=4&&86===n[0]&&103===n[1]&&109===n[2]&&32===n[3]}async function h(n,r){const h=r.toLowerCase();let f=n;const m=new Uint8Array(n);if((h.endsWith(".vgz")||31===m[0]&&139===m[1])&&(f=await async function(t){const n=new DecompressionStream("gzip"),e=n.writable.getWriter(),o=n.readable.getReader();e.write(new Uint8Array(t)),e.close();const r=[];let s=!1;for(;!s;){const{value:t,done:n}=await o.read();t&&r.push(t),s=n}const a=r.reduce((t,n)=>t+n.length,0),i=new Uint8Array(a);let c=0;for(const h of r)i.set(h,c),c+=h.length;return i.buffer}(n)),!c(f))throw new Error("Not a valid VGM file");const l=new Uint8Array(f),u=new DataView(f),p=u.getUint32(8,!0),d=u.getUint32(20,!0),y=d>0?20+d:0,g=u.byteLength>16?1073741823&u.getUint32(12,!0):0;let I;if(p>=336&&l.length>56){const t=u.getUint32(52,!0);I=t>0?52+t:64}else I=64;const x=y>0&&y<l.length?a(l,y):{trackName:"",gameName:"",author:""},M=function(t,n){const e=n=>t.byteLength>n+4?2147483647&t.getUint32(n,!0):0;return{sn76489:e(12)>0,ym2413:e(16)>0,ym2612:n>=257&&e(44)>0,ym2151:n>=257&&e(48)>0,ym2203:n>=272&&e(68)>0,ym2608:n>=272&&e(72)>0,ym2610:n>=272&&e(76)>0,ym3812:n>=272&&e(80)>0,ymf262:n>=336&&e(92)>0,ay8910:n>=337&&e(116)>0}}(u,p),C=function(n){const e=[];let o=1;const r=(n,r,s,a=4)=>{e.push({id:o++,name:n,type:"synth",synthType:r,furnace:{...t,chipType:s,ops:a},effects:[],volume:0,pan:0})};let s=-1,a=-1,i=-1;n.ym2612&&(s=e.length,r("OPN2 FM","FurnaceOPN",1)),n.ym2151&&(a=e.length,r("OPM FM","FurnaceOPM",33)),n.ym2203&&r("OPN FM","FurnaceOPN2203",1),n.ym2608&&r("OPNA FM","FurnaceOPNA",1),n.ym2610&&r("OPNB FM","FurnaceOPNB",1),n.ym3812&&r("OPL2 FM","FurnaceOPL",14,2),n.ymf262&&r("OPL3 FM","FurnaceOPL",14,2),n.ym2413&&r("OPLL FM","FurnaceOPLL",13,2),n.sn76489&&(i=e.length,r("SN PSG","FurnacePSG",0,2)),n.ay8910&&r("AY PSG","FurnaceAY",6,2),0===e.length&&(s=0,r("FM","FurnaceOPN",1));let c=0,h=-1;(n.ym2612||s>=0)&&(h=c,c+=6);let f=-1;n.ym2151&&(f=c,c+=8);let m=-1;n.sn76489&&(m=c,c+=3);const l=Math.max(c,1);return{instruments:e,opn2ChStart:h,opmChStart:f,snChStart:m,opn2InstIdx:s,opmInstIdx:a,snInstIdx:i,totalChannels:l}}(M),{instruments:w,opn2ChStart:S,opmChStart:P,snChStart:k,opn2InstIdx:N,opmInstIdx:F,snInstIdx:A,totalChannels:O}=C,U=O,v=function(t,n,r,a){const i=[];let c=n,h=0;const f=new Uint8Array(6),m=new Uint8Array(6),l=new Uint8Array(6),u=a.opn2ChStart>=0?a.opn2ChStart:0,p=a.opn2InstIdx>=0?a.opn2InstIdx:0,d=new Uint16Array(4),y=new Uint8Array(4).fill(15),g=new Uint8Array(4);let I=0,x=0;const M=new Uint8Array(8),C=new Uint8Array(8);for(;c<t.length;){const n=t[c++];if(102===n)break;if(98!==n)if(99!==n)if(97!==n)if(n>=112&&n<=127)h+=1+(15&n);else if(79!==n){if(80===n){if(c>=t.length)break;const n=t[c++];if(128&n){I=n>>5&3,x=n>>4&1;const t=15&n;if(1===x){const n=y[I];if(y[I]=t,a.snChStart>=0&&I<3){const e=a.snChStart+I;if(15===t&&g[I])i.push({tick:h,ch:e,note:97,on:!1,instIdx:a.snInstIdx}),g[I]=0;else if(t<15&&15===n&&d[I]>0){const t=o(d[I],a.snClock);t>0&&(i.push({tick:h,ch:e,note:t,on:!0,instIdx:a.snInstIdx}),g[I]=1)}}}else d[I]=1008&d[I]|t}else if(0===x&&I<3&&(d[I]=(63&n)<<4|15&d[I],a.snChStart>=0)){const t=a.snChStart+I;if(y[I]<15&&d[I]>0){const n=o(d[I],a.snClock);n>0&&(g[I]&&i.push({tick:h,ch:t,note:97,on:!1,instIdx:a.snInstIdx}),i.push({tick:h,ch:t,note:n,on:!0,instIdx:a.snInstIdx}),g[I]=1)}}continue}if(82===n||83===n){if(c+1>=t.length)break;const o=t[c++],r=t[c++],s=83===n?3:0;if(o>=160&&o<=162)f[s+(o-160)]=r;else if(o>=164&&o<=166)m[s+(o-164)]=r;else if(40===o){const t=7&r,n=t<4?t:t-1;if(n<6){const t=!!(240&r);if(t!==(0!==l[n])){const o=f[n]|(7&m[n])<<8,r=m[n]>>3&7,s=u+n;i.push({tick:h,ch:s,note:e(o,r),on:t,instIdx:p}),l[n]=t?1:0}}}continue}if(84===n){if(c+1>=t.length)break;const n=t[c++],e=t[c++];if(a.opmChStart>=0)if(n>=40&&n<=47)M[n-40]=e;else if(8===n){const t=7&e,n=!!(120&e);if(n!==(0!==C[t])){const e=s(M[t]),o=a.opmChStart+t;i.push({tick:h,ch:o,note:e,on:n,instIdx:a.opmInstIdx}),C[t]=n?1:0}}continue}if(n>=81&&n<=95||n>=160&&n<=191)c+=2;else{if(103===n){if(c++,c+4>t.length)break;c+=4+(t[c]|t[c+1]<<8|t[c+2]<<16|t[c+3]<<24);continue}n>=128&&n<=143?h+=15&n:n>=192&&n<=223&&(c+=2)}}else c++;else c+1<t.length&&(h+=t[c]|t[c+1]<<8,c+=2);else h+=735;else h+=882}return i}(l,I,0,{snClock:g,snChStart:k,snInstIdx:A,opmChStart:P,opmInstIdx:F,opn2ChStart:S,opn2InstIdx:N}),L=v.length>0?Math.max(...v.map(t=>t.tick)):0,b=i(v,U,Math.min(256,Math.max(64,Math.ceil(L/735)+1)));return{name:(x.trackName||x.gameName||r.replace(/\.(vgm|vgz)$/i,""))+(x.author?` â€” ${x.author}`:""),format:"VGM",patterns:[b],instruments:w,songPositions:[0],songLength:1,restartPosition:0,numChannels:U,initialSpeed:6,initialBPM:125}}export{c as isVGMFormat,h as parseVGMFile};
