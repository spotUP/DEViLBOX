const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/butterchurnPresets.min-PxHmGQ2o.js","assets/vendor-react-DkDaD07v.js","assets/butterchurnPresetsExtra.min-_dM_8pan.js","assets/butterchurnPresetsExtra2.min-B_0laeXG.js","assets/butterchurnPresetsMD1.min-BxPUNh2X.js","assets/butterchurnPresetsNonMinimal.min-Bkg1LL3W.js","assets/ProjectMCanvas-NshNQJSi.js","assets/index-zx6LJBPK.js","assets/vendor-utils-XMmR-oGw.js","assets/vendor-tone-CADp_hfL.js","assets/vendor-ui-uomqNFY-.js","assets/index-Cnoi0D0R.css","assets/react-three-fiber.esm-DUbY8J_y.js","assets/butterchurn-3HiArFCr.js"])))=>i.map(i=>d[i]);
import{j as e,_ as t,aQ as n,t as r,bj as i}from"./index-zx6LJBPK.js";import{r as o,R as s}from"./vendor-utils-XMmR-oGw.js";import{getContext as a,getDestination as u}from"./vendor-tone-CADp_hfL.js";import{H as c,X as l,aF as h,c as f,aK as p,aI as d,P as m,aW as v,aX as g,J as y,aY as x,av as b}from"./vendor-ui-uomqNFY-.js";import{g as E}from"./vendor-react-DkDaD07v.js";import{b as w,at as N,au as S,al as T,av as M,aw as A,ax as D,aj as _,x as O,ay as P,C,y as B,am as R,az as U,aA as I,aB as j,aC as V,aD as F,ap as k,O as L,_ as z,aE as H,U as X,aF as G,af as W,aG as J,H as Y,ab as $,c as q,P as Z,aH as K,Y as Q,r as ee,aI as te,a as ne,ak as re,u as ie,aJ as oe,aK as se,aL as ae,aM as ue,aN as ce,aO as le,ar as he,as as fe}from"./react-three-fiber.esm-DUbY8J_y.js";const pe=2048;let de=null,me=null,ve=0;class ge{startTime=performance.now();lastTime=performance.now();smoothRms=0;smoothPeak=0;smoothSub=0;smoothBass=0;smoothMid=0;smoothHigh=0;energyHistory=[];lastBeatTime=0;enabled=!1;waveformAnalyser=null;fftAnalyser=null;waveformBuf=new Float32Array(pe);fftBuf=new Float32Array(1024);frame={waveform:new Float32Array(pe),fft:new Float32Array(1024),rms:0,peak:0,subEnergy:0,bassEnergy:0,midEnergy:0,highEnergy:0,beat:!1,time:0,deltaTime:0};enable(){if(!this.enabled)try{const e=function(){if(0===ve||!de||!me){const e=a().rawContext,t=u(),n=t.output?.input??t._gainNode??t.input;if(!n)throw new Error("[AudioDataBus] Cannot find Tone.Destination native input node");de=e.createAnalyser(),de.fftSize=pe,de.smoothingTimeConstant=0,me=e.createAnalyser(),me.fftSize=pe,me.smoothingTimeConstant=.4,n.connect(de),n.connect(me)}return ve++,{waveform:de,fft:me}}();this.waveformAnalyser=e.waveform,this.fftAnalyser=e.fft,this.enabled=!0}catch(e){}}disable(){this.enabled&&(!function(){if(ve--,ve<=0){ve=0;try{de?.disconnect()}catch{}try{me?.disconnect()}catch{}de=null,me=null}}(),this.waveformAnalyser=null,this.fftAnalyser=null,this.enabled=!1)}_diagCounter=0;update(){const e=performance.now(),t=(e-this.lastTime)/1e3;if(this.lastTime=e,!this.waveformAnalyser||!this.fftAnalyser)return this.frame;this.waveformAnalyser.getFloatTimeDomainData(this.waveformBuf),this.fftAnalyser.getFloatFrequencyData(this.fftBuf);const n=this.waveformBuf,r=this.fftBuf;let i=0,o=0;for(let E=0;E<n.length;E++){const e=n[E];i+=e*e;const t=e<0?-e:e;t>o&&(o=t)}const s=Math.sqrt(i/n.length);let a=0,u=0,c=0,l=0,h=0,f=0,p=0,d=0;const m=r.length;for(let E=0;E<m;E++){const e=Math.max(0,(r[E]+80)/80);E<3?(a+=e,e>h&&(h=e)):E<12?(u+=e,e>f&&(f=e)):E<186?(c+=e,e>p&&(p=e)):(l+=e,e>d&&(d=e))}a=.6*h+a/3*.4,u=.6*f+u/9*.4,c=.6*p+c/174*.4,l=.6*d+l/(m-186)*.4;const v=1.8;a=Math.min(1,a*v),u=Math.min(1,u*v),c=Math.min(1,c*v),l=Math.min(1,l*v);const g=.6;this.smoothRms=.4*this.smoothRms+s*g,this.smoothPeak=.4*this.smoothPeak+o*g,this.smoothSub=.4*this.smoothSub+a*g,this.smoothBass=.4*this.smoothBass+u*g,this.smoothMid=.4*this.smoothMid+c*g,this.smoothHigh=.4*this.smoothHigh+l*g;const y=a+u;this.energyHistory.push(y),this.energyHistory.length>43&&this.energyHistory.shift();let x=0;for(let E=0;E<this.energyHistory.length;E++)x+=this.energyHistory[E];x/=this.energyHistory.length;const b=this.energyHistory.length>=10&&y>1.3*x&&e-this.lastBeatTime>100;return b&&(this.lastBeatTime=e),this._diagCounter++,this._diagCounter,this.frame.waveform=n,this.frame.fft=r,this.frame.rms=this.smoothRms,this.frame.peak=this.smoothPeak,this.frame.subEnergy=this.smoothSub,this.frame.bassEnergy=this.smoothBass,this.frame.midEnergy=this.smoothMid,this.frame.highEnergy=this.smoothHigh,this.frame.beat=b,this.frame.time=(e-this.startTime)/1e3,this.frame.deltaTime=t,this.frame}getFrame(){return this.frame}}const ye="devilbox-vj-favorites",xe="★ All",be="♥ Favorites";let Ee=null,we=null;function Ne(e){const t=e.replace(/^[_$]+\s*/,""),n=t.indexOf(" - ");if(n>0){let e=t.slice(0,n).trim();const r=e.indexOf(" + ");r>0&&(e=e.slice(0,r).trim());const i=e.indexOf("(");if(i>0&&(e=e.slice(0,i).trim()),e.length>0&&e.length<40)return e}return"Other"}function Se(){try{const e=localStorage.getItem(ye);return e?new Set(JSON.parse(e)):new Set}catch{return new Set}}const Te=({isOpen:n,onClose:r,onSelectPreset:i,currentPresetIdx:s})=>{const[a,u]=o.useState([]),[p,d]=o.useState(!0),[m,v]=o.useState(""),[g,y]=o.useState(xe),[x,b]=o.useState(Se),E=o.useRef(null),w=o.useRef(null);o.useEffect(()=>{n&&async function(){if(Ee&&we)return{entries:Ee,presetMap:we};const[e,n,r,i,o]=await Promise.all([t(()=>import("./butterchurnPresets.min-PxHmGQ2o.js").then(e=>e.b),__vite__mapDeps([0,1])),t(()=>import("./butterchurnPresetsExtra.min-_dM_8pan.js").then(e=>e.b),__vite__mapDeps([2,1])),t(()=>import("./butterchurnPresetsExtra2.min-B_0laeXG.js").then(e=>e.b),__vite__mapDeps([3,1])),t(()=>import("./butterchurnPresetsMD1.min-BxPUNh2X.js").then(e=>e.b),__vite__mapDeps([4,1])),t(()=>import("./butterchurnPresetsNonMinimal.min-Bkg1LL3W.js").then(e=>e.b),__vite__mapDeps([5,1]))]),s=[{mod:e.default||e,label:"Main"},{mod:n.default||n,label:"Extra"},{mod:r.default||r,label:"Extra 2"},{mod:i.default||i,label:"MD1"},{mod:o.default||o,label:"NonMinimal"}],a={},u=[];let c=0;for(const{mod:t,label:l}of s){const e="function"==typeof t.getPresets?t.getPresets():t;for(const t of Object.keys(e).sort())a[t]||(a[t]=e[t],u.push({name:t,author:Ne(t),pack:l,idx:c}),c++)}return Ee=u,we=a,{entries:u,presetMap:a}}().then(({entries:e})=>{u(e),d(!1)})},[n]),o.useEffect(()=>{n&&!p&&setTimeout(()=>w.current?.focus(),100)},[n,p]);const N=o.useMemo(()=>{const e=new Map;for(const n of a)e.set(n.author,(e.get(n.author)||0)+1);const t=[...e.entries()].sort((e,t)=>t[1]-e[1]).map(([e,t])=>({name:e,count:t}));return[{name:xe,count:a.length},{name:be,count:x.size},...t]},[a,x.size]),S=o.useMemo(()=>{let e=a;if(g===be?e=e.filter(e=>x.has(e.name)):g!==xe&&(e=e.filter(e=>e.author===g)),m.trim()){const t=m.toLowerCase();e=e.filter(e=>e.name.toLowerCase().includes(t))}return e},[a,g,m,x]),T=o.useCallback(e=>{b(t=>{const n=new Set(t);var r;return n.has(e)?n.delete(e):n.add(e),r=n,localStorage.setItem(ye,JSON.stringify([...r])),n})},[]),M=o.useCallback(e=>{i(e.name,e.idx)},[i]);return o.useEffect(()=>{if(!n)return;const e=e=>{"Escape"===e.key&&r()};return window.addEventListener("keydown",e),()=>window.removeEventListener("keydown",e)},[n,r]),n?e.jsxDEV("div",{className:"absolute inset-0 z-20 flex bg-black/80 backdrop-blur-sm",children:[e.jsxDEV("div",{className:"w-48 flex-shrink-0 bg-dark-bg border-r border-dark-border flex flex-col overflow-hidden",children:[e.jsxDEV("div",{className:"p-3 border-b border-dark-border",children:e.jsxDEV("h3",{className:"text-xs font-semibold text-text-muted uppercase tracking-wider",children:"Categories"},void 0,!1,{fileName:"/Users/spot/Code/DEViLBOX/src/components/vj/VJPresetBrowser.tsx",lineNumber:216,columnNumber:11},void 0)},void 0,!1,{fileName:"/Users/spot/Code/DEViLBOX/src/components/vj/VJPresetBrowser.tsx",lineNumber:215,columnNumber:9},void 0),e.jsxDEV("div",{className:"flex-1 overflow-y-auto scrollbar-thin",children:N.map(t=>e.jsxDEV("button",{onClick:()=>y(t.name),className:"w-full text-left px-3 py-1.5 text-xs flex items-center justify-between transition-colors "+(g===t.name?"bg-accent/20 text-accent":"text-text-secondary hover:bg-dark-bgHover hover:text-text-primary"),children:[e.jsxDEV("span",{className:"truncate",children:t.name},void 0,!1,{fileName:"/Users/spot/Code/DEViLBOX/src/components/vj/VJPresetBrowser.tsx",lineNumber:229,columnNumber:15},void 0),e.jsxDEV("span",{className:"text-[10px] text-text-muted ml-1",children:t.count},void 0,!1,{fileName:"/Users/spot/Code/DEViLBOX/src/components/vj/VJPresetBrowser.tsx",lineNumber:230,columnNumber:15},void 0)]},t.name,!0,{fileName:"/Users/spot/Code/DEViLBOX/src/components/vj/VJPresetBrowser.tsx",lineNumber:220,columnNumber:13},void 0))},void 0,!1,{fileName:"/Users/spot/Code/DEViLBOX/src/components/vj/VJPresetBrowser.tsx",lineNumber:218,columnNumber:9},void 0)]},void 0,!0,{fileName:"/Users/spot/Code/DEViLBOX/src/components/vj/VJPresetBrowser.tsx",lineNumber:214,columnNumber:7},void 0),e.jsxDEV("div",{className:"flex-1 flex flex-col overflow-hidden",children:[e.jsxDEV("div",{className:"flex items-center gap-3 p-3 border-b border-dark-border bg-dark-bg",children:[e.jsxDEV("div",{className:"relative flex-1",children:[e.jsxDEV(c,{size:14,className:"absolute left-2.5 top-1/2 -translate-y-1/2 text-text-muted"},void 0,!1,{fileName:"/Users/spot/Code/DEViLBOX/src/components/vj/VJPresetBrowser.tsx",lineNumber:241,columnNumber:13},void 0),e.jsxDEV("input",{ref:w,type:"text",value:m,onChange:e=>v(e.target.value),placeholder:"Search presets...",className:"w-full pl-8 pr-8 py-1.5 text-xs bg-dark-bgSecondary text-text-primary border border-dark-border rounded focus:border-accent focus:outline-none"},void 0,!1,{fileName:"/Users/spot/Code/DEViLBOX/src/components/vj/VJPresetBrowser.tsx",lineNumber:242,columnNumber:13},void 0),m&&e.jsxDEV("button",{onClick:()=>v(""),className:"absolute right-2 top-1/2 -translate-y-1/2 text-text-muted hover:text-text-primary",children:e.jsxDEV(l,{size:12},void 0,!1,{fileName:"/Users/spot/Code/DEViLBOX/src/components/vj/VJPresetBrowser.tsx",lineNumber:255,columnNumber:17},void 0)},void 0,!1,{fileName:"/Users/spot/Code/DEViLBOX/src/components/vj/VJPresetBrowser.tsx",lineNumber:251,columnNumber:15},void 0)]},void 0,!0,{fileName:"/Users/spot/Code/DEViLBOX/src/components/vj/VJPresetBrowser.tsx",lineNumber:240,columnNumber:11},void 0),e.jsxDEV("div",{className:"text-xs text-text-muted whitespace-nowrap",children:[S.length," presets"]},void 0,!0,{fileName:"/Users/spot/Code/DEViLBOX/src/components/vj/VJPresetBrowser.tsx",lineNumber:259,columnNumber:11},void 0),e.jsxDEV("button",{onClick:r,className:"p-1.5 rounded hover:bg-dark-bgHover text-text-muted hover:text-text-primary transition-colors",title:"Close browser",children:e.jsxDEV(l,{size:16},void 0,!1,{fileName:"/Users/spot/Code/DEViLBOX/src/components/vj/VJPresetBrowser.tsx",lineNumber:267,columnNumber:13},void 0)},void 0,!1,{fileName:"/Users/spot/Code/DEViLBOX/src/components/vj/VJPresetBrowser.tsx",lineNumber:262,columnNumber:11},void 0)]},void 0,!0,{fileName:"/Users/spot/Code/DEViLBOX/src/components/vj/VJPresetBrowser.tsx",lineNumber:239,columnNumber:9},void 0),e.jsxDEV("div",{ref:E,className:"flex-1 overflow-y-auto scrollbar-thin",children:p?e.jsxDEV("div",{className:"flex items-center justify-center h-32 text-text-muted text-sm",children:"Loading presets..."},void 0,!1,{fileName:"/Users/spot/Code/DEViLBOX/src/components/vj/VJPresetBrowser.tsx",lineNumber:274,columnNumber:13},void 0):0===S.length?e.jsxDEV("div",{className:"flex items-center justify-center h-32 text-text-muted text-sm",children:"No presets found"},void 0,!1,{fileName:"/Users/spot/Code/DEViLBOX/src/components/vj/VJPresetBrowser.tsx",lineNumber:278,columnNumber:13},void 0):S.map(t=>{const n=t.idx===s,r=x.has(t.name);return e.jsxDEV("div",{className:"flex items-center gap-2 px-3 py-1.5 cursor-pointer transition-colors group "+(n?"bg-accent/15 text-accent":"text-text-secondary hover:bg-dark-bgHover hover:text-text-primary"),onClick:()=>M(t),children:[e.jsxDEV("button",{onClick:e=>{e.stopPropagation(),T(t.name)},className:"flex-shrink-0 transition-colors "+(r?"text-yellow-400":"text-transparent group-hover:text-text-muted/40"),title:r?"Remove from favorites":"Add to favorites",children:e.jsxDEV(h,{size:12,fill:r?"currentColor":"none"},void 0,!1,{fileName:"/Users/spot/Code/DEViLBOX/src/components/vj/VJPresetBrowser.tsx",lineNumber:302,columnNumber:21},void 0)},void 0,!1,{fileName:"/Users/spot/Code/DEViLBOX/src/components/vj/VJPresetBrowser.tsx",lineNumber:295,columnNumber:19},void 0),e.jsxDEV("span",{className:"flex-1 text-xs truncate font-mono",children:t.name},void 0,!1,{fileName:"/Users/spot/Code/DEViLBOX/src/components/vj/VJPresetBrowser.tsx",lineNumber:304,columnNumber:19},void 0),e.jsxDEV("span",{className:"text-[10px] text-text-muted flex-shrink-0",children:t.pack},void 0,!1,{fileName:"/Users/spot/Code/DEViLBOX/src/components/vj/VJPresetBrowser.tsx",lineNumber:305,columnNumber:19},void 0),n&&e.jsxDEV(f,{size:12,className:"flex-shrink-0 text-accent"},void 0,!1,{fileName:"/Users/spot/Code/DEViLBOX/src/components/vj/VJPresetBrowser.tsx",lineNumber:307,columnNumber:21},void 0)]},t.name,!0,{fileName:"/Users/spot/Code/DEViLBOX/src/components/vj/VJPresetBrowser.tsx",lineNumber:286,columnNumber:17},void 0)})},void 0,!1,{fileName:"/Users/spot/Code/DEViLBOX/src/components/vj/VJPresetBrowser.tsx",lineNumber:272,columnNumber:9},void 0)]},void 0,!0,{fileName:"/Users/spot/Code/DEViLBOX/src/components/vj/VJPresetBrowser.tsx",lineNumber:237,columnNumber:7},void 0)]},void 0,!0,{fileName:"/Users/spot/Code/DEViLBOX/src/components/vj/VJPresetBrowser.tsx",lineNumber:212,columnNumber:5},void 0):null};var Me,Ae={};var De,_e,Oe,Pe={};function Ce(){return _e?De:(_e=1,De=function(e){return e&&e.constructor.prototype.isBigNumber||!1})}function Be(){return Oe||(Oe=1,function(e){function t(e){return(t="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}var n=Ce();e.clone=function r(i){var o=t(i);if("number"===o||"string"===o||"boolean"===o||null==i)return i;if("function"==typeof i.clone)return i.clone();if(Array.isArray(i))return i.map(function(e){return r(e)});if(i instanceof Date)return new Date(i.valueOf());if(n(i))return i;if(i instanceof RegExp)throw new TypeError("Cannot clone "+i);return e.map(i,r)},e.map=function(t,n){var r={};for(var i in t)e.hasOwnProperty(t,i)&&(r[i]=n(t[i]));return r},e.extend=function(t,n){for(var r in n)e.hasOwnProperty(n,r)&&(t[r]=n[r]);return t},e.deepExtend=function t(n,r){if(Array.isArray(r))throw new TypeError("Arrays are not supported by deepExtend");for(var i in r)if(e.hasOwnProperty(r,i))if(r[i]&&r[i].constructor===Object)void 0===n[i]&&(n[i]={}),n[i].constructor===Object?t(n[i],r[i]):n[i]=r[i];else{if(Array.isArray(r[i]))throw new TypeError("Arrays are not supported by deepExtend");n[i]=r[i]}return n},e.deepEqual=function(t,n){var r,i,o;if(Array.isArray(t)){if(!Array.isArray(n))return!1;if(t.length!==n.length)return!1;for(i=0,o=t.length;i<o;i++)if(!e.deepEqual(t[i],n[i]))return!1;return!0}if(t instanceof Object){if(Array.isArray(n)||!(n instanceof Object))return!1;for(r in t)if(!e.deepEqual(t[r],n[r]))return!1;for(r in n)if(!e.deepEqual(t[r],n[r]))return!1;return!0}return t===n},e.canDefineProperty=function(){try{if(Object.defineProperty)return Object.defineProperty({},"x",{get:function(){}}),!0}catch(e){}return!1},e.lazy=function(t,n,r){if(e.canDefineProperty()){var i,o=!0;Object.defineProperty(t,n,{get:function(){return o&&(i=r(),o=!1),i},set:function(e){i=e,o=!1},configurable:!0,enumerable:!0})}else t[n]=r()},e.traverse=function(e,t){var n=e;if(t)for(var r=t.split("."),i=0;i<r.length;i++){var o=r[i];o in n||(n[o]={}),n=n[o]}return n},e.hasOwnProperty=function(e,t){return e&&Object.hasOwnProperty.call(e,t)},e.isFactory=function(e){return e&&"function"==typeof e.factory}}(Pe)),Pe}var Re,Ue={},Ie={exports:{}};function je(){return Re||(Re=1,Ie.exports=function(){function e(){return!0}function t(){return!1}function n(){}function r(){var i=[{name:"number",test:function(e){return"number"==typeof e}},{name:"string",test:function(e){return"string"==typeof e}},{name:"boolean",test:function(e){return"boolean"==typeof e}},{name:"Function",test:function(e){return"function"==typeof e}},{name:"Array",test:Array.isArray},{name:"Date",test:function(e){return e instanceof Date}},{name:"RegExp",test:function(e){return e instanceof RegExp}},{name:"Object",test:function(e){return"object"==typeof e&&e.constructor===Object}},{name:"null",test:function(e){return null===e}},{name:"undefined",test:function(e){return void 0===e}}],o={name:"any",test:e},s=[],a=[],u={types:i,conversions:a,ignore:s};function c(e){var t=Y(u.types,function(t){return t.name===e});if(t)return t;if("any"===e)return o;var n=Y(u.types,function(t){return t.name.toLowerCase()===e.toLowerCase()});throw new TypeError('Unknown type "'+e+'"'+(n?'. Did you mean "'+n.name+'"?':""))}function l(e){return e===o?999:u.types.indexOf(e)}function h(e){var t=Y(u.types,function(t){return t.test(e)});if(t)return t.name;throw new TypeError("Value has unknown type. Value: "+e)}function f(e,t){if(!e.signatures)throw new TypeError("Function is no typed-function");var n;if("string"==typeof t){n=t.split(",");for(var r=0;r<n.length;r++)n[r]=n[r].trim()}else{if(!Array.isArray(t))throw new TypeError("String array or a comma separated string expected");n=t}var i=n.join(","),o=e.signatures[i];if(o)return o;throw new TypeError("Signature not found (signature: "+(e.name||"unnamed")+"("+n.join(", ")+"))")}function p(e,t){var n=h(e);if(t===n)return e;for(var r=0;r<u.conversions.length;r++){var i=u.conversions[r];if(i.from===n&&i.to===t)return i.convert(e)}throw new Error("Cannot convert from "+n+" to "+t)}function d(e){return e.map(function(e){var t=e.types.map(N);return(e.restParam?"...":"")+t.join("|")}).join(",")}function m(e,t){var n=0===e.indexOf("..."),r=(n?e.length>3?e.slice(3):"any":e).split("|").map(F).filter(k).filter(V),i=P(t,r),o=r.map(function(e){var t=c(e);return{name:e,typeIndex:l(t),test:t.test,conversion:null,conversionIndex:-1}}),s=i.map(function(e){var n=c(e.from);return{name:e.from,typeIndex:l(n),test:n.test,conversion:e,conversionIndex:t.indexOf(e)}});return{types:o.concat(s),restParam:n}}function v(e,t,n){var r=[];return""!==e.trim()&&(r=e.split(",").map(F).map(function(e,t,r){var i=m(e,n);if(i.restParam&&t!==r.length-1)throw new SyntaxError('Unexpected rest parameter "'+e+'": only allowed for the last parameter');return i})),r.some(z)?null:{params:r,fn:t}}function g(e){var t=X(e);return!!t&&t.restParam}function y(e){return e.types.some(function(e){return null!=e.conversion})}function x(t){if(t&&0!==t.types.length){if(1===t.types.length)return c(t.types[0].name).test;if(2===t.types.length){var n=c(t.types[0].name).test,r=c(t.types[1].name).test;return function(e){return n(e)||r(e)}}var i=t.types.map(function(e){return c(e.name).test});return function(e){for(var t=0;t<i.length;t++)if(i[t](e))return!0;return!1}}return e}function b(e){var t,n,r;if(g(e)){var i=(t=H(e).map(x)).length,o=x(X(e)),s=function(e){for(var t=i;t<e.length;t++)if(!o(e[t]))return!1;return!0};return function(e){for(var n=0;n<t.length;n++)if(!t[n](e[n]))return!1;return s(e)&&e.length>=i+1}}return 0===e.length?function(e){return 0===e.length}:1===e.length?(n=x(e[0]),function(e){return n(e[0])&&1===e.length}):2===e.length?(n=x(e[0]),r=x(e[1]),function(e){return n(e[0])&&r(e[1])&&2===e.length}):(t=e.map(x),function(e){for(var n=0;n<t.length;n++)if(!t[n](e[n]))return!1;return e.length===t.length})}function E(e,t){return t<e.params.length?e.params[t]:g(e.params)?X(e.params):null}function w(e,t,n){var r=E(e,t);return(r?n?r.types.filter(S):r.types:[]).map(N)}function N(e){return e.name}function S(e){return null===e.conversion||void 0===e.conversion}function T(e,t){var n=$(q(e,function(e){return w(e,t,!1)}));return-1!==n.indexOf("any")?["any"]:n}function M(e,t,n){var r,i,o,s=e||"unnamed",a=n;for(o=0;o<t.length;o++){var u=a.filter(function(e){var n=x(E(e,o));return(o<e.params.length||g(e.params))&&n(t[o])});if(0===u.length){if((i=T(a,o)).length>0){var c=h(t[o]);return(r=new TypeError("Unexpected type of argument in function "+s+" (expected: "+i.join(" or ")+", actual: "+c+", index: "+o+")")).data={category:"wrongType",fn:s,index:o,actual:c,expected:i},r}}else a=u}var l=a.map(function(e){return g(e.params)?1/0:e.params.length});if(t.length<Math.min.apply(null,l))return i=T(a,o),(r=new TypeError("Too few arguments in function "+s+" (expected: "+i.join(" or ")+", index: "+t.length+")")).data={category:"tooFewArgs",fn:s,index:t.length,expected:i},r;var f=Math.max.apply(null,l);return t.length>f?((r=new TypeError("Too many arguments in function "+s+" (expected: "+f+", actual: "+t.length+")")).data={category:"tooManyArgs",fn:s,index:t.length,expectedLength:f},r):((r=new TypeError('Arguments of type "'+t.join(", ")+'" do not match any of the defined signatures of function '+s+".")).data={category:"mismatch",actual:t.map(h)},r)}function A(e){for(var t=999,n=0;n<e.types.length;n++)S(e.types[n])&&(t=Math.min(t,e.types[n].typeIndex));return t}function D(e){for(var t=999,n=0;n<e.types.length;n++)S(e.types[n])||(t=Math.min(t,e.types[n].conversionIndex));return t}function _(e,t){var n;return 0!==(n=e.restParam-t.restParam)||0!==(n=y(e)-y(t))||0!==(n=A(e)-A(t))?n:D(e)-D(t)}function O(e,t){var n,r,i=Math.min(e.params.length,t.params.length);if(0!==(r=e.params.some(y)-t.params.some(y)))return r;for(n=0;n<i;n++)if(0!==(r=y(e.params[n])-y(t.params[n])))return r;for(n=0;n<i;n++)if(0!==(r=_(e.params[n],t.params[n])))return r;return e.params.length-t.params.length}function P(e,t){var n={};return e.forEach(function(e){-1!==t.indexOf(e.from)||-1===t.indexOf(e.to)||n[e.from]||(n[e.from]=e)}),Object.keys(n).map(function(e){return n[e]})}function C(e,t){var n=t;if(e.some(y)){var r=g(e),i=e.map(B);n=function(){for(var e=[],n=r?arguments.length-1:arguments.length,o=0;o<n;o++)e[o]=i[o](arguments[o]);return r&&(e[n]=arguments[n].map(i[n])),t.apply(null,e)}}var o=n;if(g(e)){var s=e.length-1;o=function(){return n.apply(null,G(arguments,0,s).concat([G(arguments,s)]))}}return o}function B(e){var t,n,r,i,o=[],s=[];switch(e.types.forEach(function(e){e.conversion&&(o.push(c(e.conversion.from).test),s.push(e.conversion.convert))}),s.length){case 0:return function(e){return e};case 1:return t=o[0],r=s[0],function(e){return t(e)?r(e):e};case 2:return t=o[0],n=o[1],r=s[0],i=s[1],function(e){return t(e)?r(e):n(e)?i(e):e};default:return function(e){for(var t=0;t<s.length;t++)if(o[t](e))return s[t](e);return e}}}function R(e){var t={};return e.forEach(function(e){e.params.some(y)||U(e.params,!0).forEach(function(n){t[d(n)]=e.fn})}),t}function U(e,t){function n(e,r,i){if(r<e.length){var o,s=e[r],a=t?s.types.filter(S):s.types;if(s.restParam){var u=a.filter(S);o=u.length<a.length?[u,a]:[a]}else o=a.map(function(e){return[e]});return q(o,function(t){return n(e,r+1,i.concat([t]))})}return[i.map(function(t,n){return{types:t,restParam:n===e.length-1&&g(e)}})]}return n(e,0,[])}function I(e,t){for(var n=Math.max(e.params.length,t.params.length),r=0;r<n;r++)if(!J(w(e,r,!0),w(t,r,!0)))return!1;var i=e.params.length,o=t.params.length,s=g(e.params),a=g(t.params);return s?a?i===o:o>=i:a?i>=o:i===o}function j(e,r){if(0===Object.keys(r).length)throw new SyntaxError("No signatures provided");var i=[];Object.keys(r).map(function(e){return v(e,r[e],u.conversions)}).filter(L).forEach(function(e){var t=Y(i,function(t){return I(t,e)});if(t)throw new TypeError('Conflicting signatures "'+d(t.params)+'" and "'+d(e.params)+'".');i.push(e)});var o=q(i,function(e){return(e?U(e.params,!1):[]).map(function(t){return{params:t,fn:e.fn}})}).filter(L);o.sort(O);var s=o[0]&&o[0].params.length<=2&&!g(o[0].params),a=o[1]&&o[1].params.length<=2&&!g(o[1].params),c=o[2]&&o[2].params.length<=2&&!g(o[2].params),l=o[3]&&o[3].params.length<=2&&!g(o[3].params),h=o[4]&&o[4].params.length<=2&&!g(o[4].params),f=o[5]&&o[5].params.length<=2&&!g(o[5].params),p=s&&a&&c&&l&&h&&f,m=o.map(function(e){return b(e.params)}),y=s?x(o[0].params[0]):t,E=a?x(o[1].params[0]):t,w=c?x(o[2].params[0]):t,N=l?x(o[3].params[0]):t,S=h?x(o[4].params[0]):t,T=f?x(o[5].params[0]):t,A=s?x(o[0].params[1]):t,D=a?x(o[1].params[1]):t,_=c?x(o[2].params[1]):t,P=l?x(o[3].params[1]):t,B=h?x(o[4].params[1]):t,j=f?x(o[5].params[1]):t,V=o.map(function(e){return C(e.params,e.fn)}),F=s?V[0]:n,k=a?V[1]:n,z=c?V[2]:n,H=l?V[3]:n,X=h?V[4]:n,G=f?V[5]:n,W=s?o[0].params.length:-1,J=a?o[1].params.length:-1,$=c?o[2].params.length:-1,Z=l?o[3].params.length:-1,K=h?o[4].params.length:-1,Q=f?o[5].params.length:-1,ee=p?6:0,te=o.length,ne=function(){for(var t=ee;t<te;t++)if(m[t](arguments))return V[t].apply(null,arguments);throw M(e,arguments,o)},re=function(e,t){return arguments.length===W&&y(e)&&A(t)?F.apply(null,arguments):arguments.length===J&&E(e)&&D(t)?k.apply(null,arguments):arguments.length===$&&w(e)&&_(t)?z.apply(null,arguments):arguments.length===Z&&N(e)&&P(t)?H.apply(null,arguments):arguments.length===K&&S(e)&&B(t)?X.apply(null,arguments):arguments.length===Q&&T(e)&&j(t)?G.apply(null,arguments):ne.apply(null,arguments)};try{Object.defineProperty(re,"name",{value:e})}catch(ie){}return re.signatures=R(o),re}function V(e){return-1===u.ignore.indexOf(e)}function F(e){return e.trim()}function k(e){return!!e}function L(e){return null!==e}function z(e){return 0===e.types.length}function H(e){return e.slice(0,e.length-1)}function X(e){return e[e.length-1]}function G(e,t,n){return Array.prototype.slice.call(e,t,n)}function W(e,t){return-1!==e.indexOf(t)}function J(e,t){for(var n=0;n<e.length;n++)if(W(t,e[n]))return!0;return!1}function Y(e,t){for(var n=0;n<e.length;n++)if(t(e[n]))return e[n]}function $(e){for(var t={},n=0;n<e.length;n++)t[e[n]]=!0;return Object.keys(t)}function q(e,t){return Array.prototype.concat.apply([],e.map(t))}function Z(e){for(var t="",n=0;n<e.length;n++){var r=e[n];if(("object"==typeof r.signatures||"string"==typeof r.signature)&&""!==r.name)if(""===t)t=r.name;else if(t!==r.name){var i=new Error("Function names do not match (expected: "+t+", actual: "+r.name+")");throw i.data={actual:r.name,expected:t},i}}return t}function K(e){var t,n={};function r(e,r){if(n.hasOwnProperty(e)&&r!==n[e])throw(t=new Error('Signature "'+e+'" is defined twice')).data={signature:e},t}for(var i=0;i<e.length;i++){var o=e[i];if("object"==typeof o.signatures)for(var s in o.signatures)o.signatures.hasOwnProperty(s)&&(r(s,o.signatures[s]),n[s]=o.signatures[s]);else{if("string"!=typeof o.signature)throw(t=new TypeError("Function is no typed-function (index: "+i+")")).data={index:i},t;r(o.signature,o),n[o.signature]=o}}return n}return(u=j("typed",{"string, Object":j,Object:function(e){var t=[];for(var n in e)e.hasOwnProperty(n)&&t.push(e[n]);return j(Z(t),e)},"...Function":function(e){return j(Z(e),K(e))},"string, ...Function":function(e,t){return j(e,K(t))}})).create=r,u.types=i,u.conversions=a,u.ignore=s,u.convert=p,u.find=f,u.addType=function(e,t){if(!e||"string"!=typeof e.name||"function"!=typeof e.test)throw new TypeError("Object with properties {name: string, test: function} expected");if(!1!==t)for(var n=0;n<u.types.length;n++)if("Object"===u.types[n].name)return void u.types.splice(n,0,e);u.types.push(e)},u.addConversion=function(e){if(!e||"string"!=typeof e.from||"string"!=typeof e.to||"function"!=typeof e.convert)throw new TypeError("Object with properties {from: string, to: string, convert: function} expected");u.conversions.push(e)},u}return r()}()),Ie.exports}var Ve,Fe,ke,Le,ze={};function He(){return Ve||(Ve=1,function(e){var t=Be();function n(e){for(var t=[],n=0;n<e;n++)t.push(0);return t}e.isNumber=function(e){return"number"==typeof e},e.isInteger=function(e){return"boolean"==typeof e||!!isFinite(e)&&e===Math.round(e)},e.sign=Math.sign||function(e){return e>0?1:e<0?-1:0},e.format=function(n,r){if("function"==typeof r)return r(n);if(n===1/0)return"Infinity";if(n===-1/0)return"-Infinity";if(isNaN(n))return"NaN";var i,o="auto";switch(r&&(r.notation&&(o=r.notation),e.isNumber(r)?i=r:e.isNumber(r.precision)&&(i=r.precision)),o){case"fixed":return e.toFixed(n,i);case"exponential":return e.toExponential(n,i);case"engineering":return e.toEngineering(n,i);case"auto":if(r&&r.exponential&&(void 0!==r.exponential.lower||void 0!==r.exponential.upper)){var s=t.map(r,function(e){return e});return s.exponential=void 0,void 0!==r.exponential.lower&&(s.lowerExp=Math.round(Math.log(r.exponential.lower)/Math.LN10)),void 0!==r.exponential.upper&&(s.upperExp=Math.round(Math.log(r.exponential.upper)/Math.LN10)),e.toPrecision(n,i,s)}return e.toPrecision(n,i,r&&r).replace(/((\.\d*?)(0+))($|e)/,function(){var e=arguments[2],t=arguments[4];return"."!==e?e+t:t});default:throw new Error('Unknown notation "'+o+'". Choose "auto", "exponential", or "fixed".')}},e.splitNumber=function(e){var t=String(e).toLowerCase().match(/^0*?(-?)(\d+\.?\d*)(e([+-]?\d+))?$/);if(!t)throw new SyntaxError("Invalid number "+e);var n=t[1],r=t[2],i=parseFloat(t[4]||"0"),o=r.indexOf(".");i+=-1!==o?o-1:r.length-1;var s=r.replace(".","").replace(/^0*/,function(e){return i-=e.length,""}).replace(/0*$/,"").split("").map(function(e){return parseInt(e)});return 0===s.length&&(s.push(0),i++),{sign:n,coefficients:s,exponent:i}},e.toEngineering=function(t,n){if(isNaN(t)||!isFinite(t))return String(t);var r=e.roundDigits(e.splitNumber(t),n),i=r.exponent,o=r.coefficients,s=i%3==0?i:i<0?i-3-i%3:i-i%3;if(e.isNumber(n))for(;n>o.length||i-s+1>o.length;)o.push(0);else for(var a=i>=0?i:Math.abs(s);o.length-1<a;)o.push(0);for(var u=Math.abs(i-s),c=1;u>0;)c++,u--;var l=o.slice(c).join(""),h=e.isNumber(n)&&l.length||l.match(/[1-9]/)?"."+l:"",f=o.slice(0,c).join("")+h+"e"+(i>=0?"+":"")+s.toString();return r.sign+f},e.toFixed=function(t,r){if(isNaN(t)||!isFinite(t))return String(t);var i=e.splitNumber(t),o="number"==typeof r?e.roundDigits(i,i.exponent+1+r):i,s=o.coefficients,a=o.exponent+1,u=a+(r||0);return s.length<u&&(s=s.concat(n(u-s.length))),a<0&&(s=n(1-a).concat(s),a=1),a<s.length&&s.splice(a,0,0===a?"0.":"."),o.sign+s.join("")},e.toExponential=function(t,r){if(isNaN(t)||!isFinite(t))return String(t);var i=e.splitNumber(t),o=r?e.roundDigits(i,r):i,s=o.coefficients,a=o.exponent;s.length<r&&(s=s.concat(n(r-s.length)));var u=s.shift();return o.sign+u+(s.length>0?"."+s.join(""):"")+"e"+(a>=0?"+":"")+a},e.toPrecision=function(t,r,i){if(isNaN(t)||!isFinite(t))return String(t);var o=i&&void 0!==i.lowerExp?i.lowerExp:-3,s=i&&void 0!==i.upperExp?i.upperExp:5,a=e.splitNumber(t);if(a.exponent<o||a.exponent>=s)return e.toExponential(t,r);var u=r?e.roundDigits(a,r):a,c=u.coefficients,l=u.exponent;c.length<r&&(c=c.concat(n(r-c.length))),c=c.concat(n(l-c.length+1+(c.length<r?r-c.length:0)));var h=l>0?l:0;return h<(c=n(-l).concat(c)).length-1&&c.splice(h+1,0,"."),u.sign+c.join("")},e.roundDigits=function(e,t){for(var n={sign:e.sign,coefficients:e.coefficients,exponent:e.exponent},r=n.coefficients;t<=0;)r.unshift(0),n.exponent++,t++;if(r.length>t&&r.splice(t,r.length-t)[0]>=5){var i=t-1;for(r[i]++;10===r[i];)r.pop(),0===i&&(r.unshift(0),n.exponent++,i++),r[--i]++}return n},e.digits=function(e){return e.toExponential().replace(/e.*$/,"").replace(/^0\.?0*|\./,"").length},e.DBL_EPSILON=Number.EPSILON||2220446049250313e-31,e.nearlyEqual=function(t,n,r){if(null==r)return t===n;if(t===n)return!0;if(isNaN(t)||isNaN(n))return!1;if(isFinite(t)&&isFinite(n)){var i=Math.abs(t-n);return i<e.DBL_EPSILON||i<=Math.max(Math.abs(t),Math.abs(n))*r}return!1}}(ze)),ze}function Xe(){if(Le)return Ue;function e(t){return(e="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(t)}Le=1;var t=je(),n=He().digits,r=Ce(),i=ke?Fe:(ke=1,Fe=function(e){return e&&e.constructor.prototype.isMatrix||!1}),o=function(){return o=t.create,t};return Ue.create=function(t){t.isNumber=function(e){return"number"==typeof e},t.isComplex=function(e){return t.Complex&&e instanceof t.Complex||!1},t.isBigNumber=r,t.isFraction=function(e){return t.Fraction&&e instanceof t.Fraction||!1},t.isUnit=function(e){return e&&e.constructor.prototype.isUnit||!1},t.isString=function(e){return"string"==typeof e},t.isArray=Array.isArray,t.isMatrix=i,t.isDenseMatrix=function(e){return e&&e.isDenseMatrix&&e.constructor.prototype.isMatrix||!1},t.isSparseMatrix=function(e){return e&&e.isSparseMatrix&&e.constructor.prototype.isMatrix||!1},t.isRange=function(e){return e&&e.constructor.prototype.isRange||!1},t.isIndex=function(e){return e&&e.constructor.prototype.isIndex||!1},t.isBoolean=function(e){return"boolean"==typeof e},t.isResultSet=function(e){return e&&e.constructor.prototype.isResultSet||!1},t.isHelp=function(e){return e&&e.constructor.prototype.isHelp||!1},t.isFunction=function(e){return"function"==typeof e},t.isDate=function(e){return e instanceof Date},t.isRegExp=function(e){return e instanceof RegExp},t.isObject=function(n){return"object"===e(n)&&n.constructor===Object&&!t.isComplex(n)&&!t.isFraction(n)},t.isNull=function(e){return null===e},t.isUndefined=function(e){return void 0===e},t.isAccessorNode=function(e){return e&&e.isAccessorNode&&e.constructor.prototype.isNode||!1},t.isArrayNode=function(e){return e&&e.isArrayNode&&e.constructor.prototype.isNode||!1},t.isAssignmentNode=function(e){return e&&e.isAssignmentNode&&e.constructor.prototype.isNode||!1},t.isBlockNode=function(e){return e&&e.isBlockNode&&e.constructor.prototype.isNode||!1},t.isConditionalNode=function(e){return e&&e.isConditionalNode&&e.constructor.prototype.isNode||!1},t.isConstantNode=function(e){return e&&e.isConstantNode&&e.constructor.prototype.isNode||!1},t.isFunctionAssignmentNode=function(e){return e&&e.isFunctionAssignmentNode&&e.constructor.prototype.isNode||!1},t.isFunctionNode=function(e){return e&&e.isFunctionNode&&e.constructor.prototype.isNode||!1},t.isIndexNode=function(e){return e&&e.isIndexNode&&e.constructor.prototype.isNode||!1},t.isNode=function(e){return e&&e.isNode&&e.constructor.prototype.isNode||!1},t.isObjectNode=function(e){return e&&e.isObjectNode&&e.constructor.prototype.isNode||!1},t.isOperatorNode=function(e){return e&&e.isOperatorNode&&e.constructor.prototype.isNode||!1},t.isParenthesisNode=function(e){return e&&e.isParenthesisNode&&e.constructor.prototype.isNode||!1},t.isRangeNode=function(e){return e&&e.isRangeNode&&e.constructor.prototype.isNode||!1},t.isSymbolNode=function(e){return e&&e.isSymbolNode&&e.constructor.prototype.isNode||!1},t.isChain=function(e){return e&&e.constructor.prototype.isChain||!1};var s=o();return s.types=[{name:"number",test:t.isNumber},{name:"Complex",test:t.isComplex},{name:"BigNumber",test:t.isBigNumber},{name:"Fraction",test:t.isFraction},{name:"Unit",test:t.isUnit},{name:"string",test:t.isString},{name:"Array",test:t.isArray},{name:"Matrix",test:t.isMatrix},{name:"DenseMatrix",test:t.isDenseMatrix},{name:"SparseMatrix",test:t.isSparseMatrix},{name:"Range",test:t.isRange},{name:"Index",test:t.isIndex},{name:"boolean",test:t.isBoolean},{name:"ResultSet",test:t.isResultSet},{name:"Help",test:t.isHelp},{name:"function",test:t.isFunction},{name:"Date",test:t.isDate},{name:"RegExp",test:t.isRegExp},{name:"null",test:t.isNull},{name:"undefined",test:t.isUndefined},{name:"OperatorNode",test:t.isOperatorNode},{name:"ConstantNode",test:t.isConstantNode},{name:"SymbolNode",test:t.isSymbolNode},{name:"ParenthesisNode",test:t.isParenthesisNode},{name:"FunctionNode",test:t.isFunctionNode},{name:"FunctionAssignmentNode",test:t.isFunctionAssignmentNode},{name:"ArrayNode",test:t.isArrayNode},{name:"AssignmentNode",test:t.isAssignmentNode},{name:"BlockNode",test:t.isBlockNode},{name:"ConditionalNode",test:t.isConditionalNode},{name:"IndexNode",test:t.isIndexNode},{name:"RangeNode",test:t.isRangeNode},{name:"Node",test:t.isNode},{name:"Object",test:t.isObject}],s.conversions=[{from:"number",to:"BigNumber",convert:function(e){if(n(e)>15)throw new TypeError("Cannot implicitly convert a number with >15 significant digits to BigNumber (value: "+e+"). Use function bignumber(x) to convert to BigNumber.");return new t.BigNumber(e)}},{from:"number",to:"Complex",convert:function(e){return new t.Complex(e,0)}},{from:"number",to:"string",convert:function(e){return e+""}},{from:"BigNumber",to:"Complex",convert:function(e){return new t.Complex(e.toNumber(),0)}},{from:"Fraction",to:"BigNumber",convert:function(e){throw new TypeError("Cannot implicitly convert a Fraction to BigNumber or vice versa. Use function bignumber(x) to convert to BigNumber or fraction(x) to convert to Fraction.")}},{from:"Fraction",to:"Complex",convert:function(e){return new t.Complex(e.valueOf(),0)}},{from:"number",to:"Fraction",convert:function(e){if(new t.Fraction(e).valueOf()!==e)throw new TypeError("Cannot implicitly convert a number to a Fraction when there will be a loss of precision (value: "+e+"). Use function fraction(x) to convert to Fraction.");return new t.Fraction(e)}},{from:"string",to:"number",convert:function(e){var t=Number(e);if(isNaN(t))throw new Error('Cannot convert "'+e+'" to a number');return t}},{from:"string",to:"BigNumber",convert:function(e){try{return new t.BigNumber(e)}catch(n){throw new Error('Cannot convert "'+e+'" to BigNumber')}}},{from:"string",to:"Fraction",convert:function(e){try{return new t.Fraction(e)}catch(n){throw new Error('Cannot convert "'+e+'" to Fraction')}}},{from:"string",to:"Complex",convert:function(e){try{return new t.Complex(e)}catch(n){throw new Error('Cannot convert "'+e+'" to Complex')}}},{from:"boolean",to:"number",convert:function(e){return+e}},{from:"boolean",to:"BigNumber",convert:function(e){return new t.BigNumber(+e)}},{from:"boolean",to:"Fraction",convert:function(e){return new t.Fraction(+e)}},{from:"boolean",to:"string",convert:function(e){return+e}},{from:"Array",to:"Matrix",convert:function(e){return new t.DenseMatrix(e)}},{from:"Matrix",to:"Array",convert:function(e){return e.valueOf()}}],s},Ue}var Ge,We,Je={},Ye={exports:{}};function $e(){if(We)return Je;We=1;var e=function(){if(Ge)return Ye.exports;function e(){}return Ge=1,e.prototype={on:function(e,t,n){var r=this.e||(this.e={});return(r[e]||(r[e]=[])).push({fn:t,ctx:n}),this},once:function(e,t,n){var r=this;function i(){r.off(e,i),t.apply(n,arguments)}return i._=t,this.on(e,i,n)},emit:function(e){for(var t=[].slice.call(arguments,1),n=((this.e||(this.e={}))[e]||[]).slice(),r=0,i=n.length;r<i;r++)n[r].fn.apply(n[r].ctx,t);return this},off:function(e,t){var n=this.e||(this.e={}),r=n[e],i=[];if(r&&t)for(var o=0,s=r.length;o<s;o++)r[o].fn!==t&&r[o].fn._!==t&&i.push(r[o]);return i.length?n[e]=i:delete n[e],this}},Ye.exports=e,Ye.exports.TinyEmitter=e,Ye.exports}();return Je.mixin=function(t){var n=new e;return t.on=n.on.bind(n),t.off=n.off.bind(n),t.once=n.once.bind(n),t.emit=n.emit.bind(n),t},Je}var qe,Ze,Ke,Qe={};function et(){if(Ze)return qe;function e(t,n,r,i){if(!(this instanceof e))throw new SyntaxError("Constructor must be called with the new operator");this.fn=t,this.count=n,this.min=r,this.max=i,this.message="Wrong number of arguments in function "+t+" ("+n+" provided, "+r+(null!=i?"-"+i:"")+" expected)",this.stack=(new Error).stack}return Ze=1,e.prototype=new Error,e.prototype.constructor=Error,e.prototype.name="ArgumentsError",e.prototype.isArgumentsError=!0,qe=e}function tt(){if(Ke)return Qe;function e(t){return(e="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(t)}Ke=1;var t=Be().lazy,n=Be().isFactory,r=Be().traverse,i=et();return Qe.math=!0,Qe.name="import",Qe.factory=function(o,s,a,u,c){function l(e,t,n){if(n.wrap&&"function"==typeof t&&(t=function(e){var t=function(){for(var t=[],n=0,r=arguments.length;n<r;n++){var i=arguments[n];t[n]=i&&i.valueOf()}return e.apply(c,t)};e.transform&&(t.transform=e.transform);return t}(t)),m(c[e])&&m(t))return t=n.override?u(e,t.signatures):u(c[e],t),c[e]=t,h(e,t),void c.emit("import",e,function(){return t});if(void 0===c[e]||n.override)return c[e]=t,h(e,t),void c.emit("import",e,function(){return t});if(!n.silent)throw new Error('Cannot import "'+e+'": already exists')}function h(e,t){t&&"function"==typeof t.transform?(c.expression.transform[e]=t.transform,v(e)&&(c.expression.mathWithTransform[e]=t.transform)):(delete c.expression.transform[e],v(e)&&(c.expression.mathWithTransform[e]=t))}function f(e){delete c.expression.transform[e],v(e)?c.expression.mathWithTransform[e]=c[e]:delete c.expression.mathWithTransform[e]}function p(e,n){if("string"==typeof e.name){var i=e.name,o=i in c.expression.transform,s=e.path?r(c,e.path):c,l=s.hasOwnProperty(i)?s[i]:void 0,h=function(){var t=a(e);if(t&&"function"==typeof t.transform)throw new Error('Transforms cannot be attached to factory functions. Please create a separate function for it with exports.path="expression.transform"');if(m(l)&&m(t))return n.override||(t=u(l,t)),t;if(void 0===l||n.override)return t;if(!n.silent)throw new Error('Cannot import "'+i+'": already exists')};!1!==e.lazy?(t(s,i,h),o?f(i):("expression.transform"===e.path||g(e))&&t(c.expression.mathWithTransform,i,h)):(s[i]=h(),o?f(i):("expression.transform"===e.path||g(e))&&(c.expression.mathWithTransform[i]=h())),c.emit("import",i,h,e.path)}else a(e)}function d(e){return"function"==typeof e||"number"==typeof e||"string"==typeof e||"boolean"==typeof e||null===e||e&&o.isUnit(e)||e&&o.isComplex(e)||e&&o.isBigNumber(e)||e&&o.isFraction(e)||e&&o.isMatrix(e)||e&&Array.isArray(e)}function m(t){return"function"==typeof t&&"object"===e(t.signatures)}function v(e){return!y.hasOwnProperty(e)}function g(e){return void 0===e.path&&!y.hasOwnProperty(e.name)}var y={expression:!0,type:!0,docs:!0,error:!0,json:!0,chain:!0};return function t(r,o){var s=arguments.length;if(1!==s&&2!==s)throw new i("import",s,1,2);if(o||(o={}),n(r))p(r,o);else if(Array.isArray(r))r.forEach(function(e){t(e,o)});else if("object"===e(r)){for(var a in r)if(r.hasOwnProperty(a)){var u=r[a];d(u)?l(a,u,o):n(r)?p(r,o):t(u,o)}}else if(!o.silent)throw new TypeError("Factory, Object, or Array expected")}},Qe.lazy=!0,Qe}var nt,rt,it,ot,st={};function at(){if(rt)return Ae;rt=1,Me||(Me=1,Number.isFinite=Number.isFinite||function(e){return"number"==typeof e&&isFinite(e)},Number.isNaN=Number.isNaN||function(e){return e!=e});var e=Be().isFactory,t=Xe(),n=$e(),r=tt(),i=function(){if(nt)return st;nt=1;var e=Be();function t(e,t,n){if(void 0!==e[t]&&(i=n,o=e[t],-1===i.indexOf(o))){var r=function(e,t){return e.map(function(e){return e.toLowerCase()}).indexOf(t.toLowerCase())}(n,e[t]);-1!==r&&(e[t]=n[r])}var i,o}return st.name="config",st.math=!0,st.factory=function(n,r,i,o,s){var a=["Matrix","Array"],u=["number","BigNumber","Fraction"];function c(n){if(n){var i=e.map(r,e.clone);t(n,"matrix",a),t(n,"number",u),e.deepExtend(r,n);var o=e.map(r,e.clone),c=e.map(n,e.clone);return s.emit("config",o,i,c),o}return e.map(r,e.clone)}return c.MATRIX=a,c.NUMBER=u,c},st}();return Ae.create=function(o){if("function"!=typeof Object.create)throw new Error("ES5 not supported by this JavaScript engine. Please load the es5-shim and es5-sham library for compatibility.");var s=[],a=[],u=n.mixin({});u.type={},u.expression={transform:{},mathWithTransform:{}},u.typed=t.create(u.type);var c={epsilon:1e-12,matrix:"Matrix",number:"number",precision:64,predictable:!1,randomSeed:null};function l(t){if(!e(t))throw new Error("Factory object with properties `type`, `name`, and `factory` expected");var n,r=s.indexOf(t);return-1===r?(n=!0===t.math?t.factory(u.type,c,l,u.typed,u):t.factory(u.type,c,l,u.typed),s.push(t),a.push(n)):n=a[r],n}return u.import=l(r),u.config=l(i),u.expression.mathWithTransform.config=u.config,o&&u.config(o),u},Ae}var ut,ct,lt={},ht={};function ft(){return ct?ut:(ct=1,ut=function e(t,n,r){return t&&"function"==typeof t.map?t.map(function(t){return e(t,n)}):n(t)})}var pt,dt={},mt={};function vt(){if(pt)return mt;function e(t){return(e="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(t)}return pt=1,mt.name="typeof",mt.factory=function(t,n,r,i){var o=i("_typeof",{any:function(n){var r=e(n);return"object"===r?null===n?"null":Array.isArray(n)?"Array":n instanceof Date?"Date":n instanceof RegExp?"RegExp":t.isBigNumber(n)?"BigNumber":t.isComplex(n)?"Complex":t.isFraction(n)?"Fraction":t.isMatrix(n)?"Matrix":t.isUnit(n)?"Unit":t.isIndex(n)?"Index":t.isRange(n)?"Range":t.isResultSet(n)?"ResultSet":t.isNode(n)?n.type:t.isChain(n)?"Chain":t.isHelp(n)?"Help":"Object":"function"===r?"Function":r}});return o.toTex=void 0,o},mt}var gt,yt={};function xt(){if(gt)return yt;gt=1;var e=ft();return yt.name="number",yt.factory=function(t,n,r,i){var o=i("number",{"":function(){return 0},number:function(e){return e},string:function(e){if("NaN"===e)return NaN;var t=Number(e);if(isNaN(t))throw new SyntaxError('String "'+e+'" is no valid number');return t},BigNumber:function(e){return e.toNumber()},Fraction:function(e){return e.valueOf()},Unit:function(e){throw new Error("Second argument with valueless unit expected")},null:function(e){return 0},"Unit, string | Unit":function(e,t){return e.toNumber(t)},"Array | Matrix":function(t){return e(t,o)}});return o.toTex={0:"0",1:"\\left(${args[0]}\\right)",2:"\\left(\\left(${args[0]}\\right)${args[1]}\\right)"},o},yt}var bt,Et={};function wt(){if(bt)return Et;bt=1;var e=ft();return Et.name="bignumber",Et.factory=function(t,n,r,i){var o=i("bignumber",{"":function(){return new t.BigNumber(0)},number:function(e){return new t.BigNumber(e+"")},string:function(e){return new t.BigNumber(e)},BigNumber:function(e){return e},Fraction:function(e){return new t.BigNumber(e.n).div(e.d).times(e.s)},null:function(e){return new t.BigNumber(0)},"Array | Matrix":function(t){return e(t,o)}});return o.toTex={0:"0",1:"\\left(${args[0]}\\right)"},o},Et}var Nt,St,Tt={};function Mt(){if(Nt)return Tt;Nt=1;var e=ft();return Tt.name="fraction",Tt.factory=function(t,n,r,i){var o=i("fraction",{number:function(e){if(!isFinite(e)||isNaN(e))throw new Error(e+" cannot be represented as a fraction");return new t.Fraction(e)},string:function(e){return new t.Fraction(e)},"number, number":function(e,n){return new t.Fraction(e,n)},null:function(e){return new t.Fraction(0)},BigNumber:function(e){return new t.Fraction(e.toString())},Fraction:function(e){return e},Object:function(e){return new t.Fraction(e)},"Array | Matrix":function(t){return e(t,o)}});return o},Tt}var At,Dt={},_t={};function Ot(){if(At)return _t;function e(t){return(e="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(t)}At=1;var t=Be().hasOwnProperty;function n(n,r){return!(!n||"object"!==e(n))&&(!!t(o,r)||!(r in Object.prototype)&&!(r in Function.prototype))}function r(e,n){return!(!e||"function"!=typeof e[n])&&(!(t(e,n)&&Object.getPrototypeOf&&n in Object.getPrototypeOf(e))&&(!!t(s,n)||!(n in Object.prototype)&&!(n in Function.prototype)))}function i(t){return"object"===e(t)&&t&&t.constructor===Object}var o={length:!0,name:!0},s={toString:!0,valueOf:!0,toLocaleString:!0};return _t.getSafeProperty=function(e,t){if(i(e)&&n(e,t))return e[t];if("function"==typeof e[t]&&r(e,t))throw new Error('Cannot access method "'+t+'" as a property');throw new Error('No access to property "'+t+'"')},_t.setSafeProperty=function(e,t,r){if(i(e)&&n(e,t))return e[t]=r,r;throw new Error('No access to property "'+t+'"')},_t.isSafeProperty=n,_t.validateSafeMethod=function(e,t){if(!r(e,t))throw new Error('No access to method "'+t+'"')},_t.isSafeMethod=r,_t.isPlainObject=i,_t}var Pt,Ct,Bt,Rt={};function Ut(){return Ct?Pt:(Ct=1,Pt={end:!0})}function It(){if(Bt)return Rt;function e(t){return(e="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(t)}Bt=1;var t=Ut(),n=Be().deepEqual,r=Be().hasOwnProperty;return Rt.name="Node",Rt.path="expression.node",Rt.math=!0,Rt.factory=function(i,o,s,a,u){function c(){if(!(this instanceof c))throw new SyntaxError("Constructor must be called with the new operator")}return c.prototype.eval=function(e){return this.compile().eval(e)},c.prototype.type="Node",c.prototype.isNode=!0,c.prototype.comment="",c.prototype.compile=function(){var e=this._compile(u.expression.mathWithTransform,{}),n={};return{eval:function(i){var o=i||{};return function(e){for(var n in e)if(r(e,n)&&n in t)throw new Error('Scope contains an illegal symbol, "'+n+'" is a reserved keyword')}(o),e(o,n,null)}}},c.prototype._compile=function(e,t){throw new Error("Method _compile should be implemented by type "+this.type)},c.prototype.forEach=function(e){throw new Error("Cannot run forEach on a Node interface")},c.prototype.map=function(e){throw new Error("Cannot run map on a Node interface")},c.prototype._ifNode=function(e){if(!i.isNode(e))throw new TypeError("Callback function must return a Node");return e},c.prototype.traverse=function(e){e(this,null,null),function e(t,n){t.forEach(function(t,r,i){n(t,r,i),e(t,n)})}(this,e)},c.prototype.transform=function(e){return function e(t,n){return t.map(function(t,r,i){return e(n(t,r,i),n)})}(e(this,null,null),e)},c.prototype.filter=function(e){var t=[];return this.traverse(function(n,r,i){e(n,r,i)&&t.push(n)}),t},c.prototype.find=function(){throw new Error("Function Node.find is deprecated. Use Node.filter instead.")},c.prototype.match=function(){throw new Error("Function Node.match is deprecated. See functions Node.filter, Node.transform, Node.traverse.")},c.prototype.clone=function(){throw new Error("Cannot clone a Node interface")},c.prototype.cloneDeep=function(){return this.map(function(e){return e.cloneDeep()})},c.prototype.equals=function(e){return!!e&&n(this,e)},c.prototype.toString=function(t){var n;if(t&&"object"===e(t))switch(e(t.handler)){case"object":case"undefined":break;case"function":n=t.handler(this,t);break;default:throw new TypeError("Object or function expected as callback")}return void 0!==n?n:this._toString(t)},c.prototype.toJSON=function(){throw new Error("Cannot serialize object: toJSON not implemented by "+this.type)},c.prototype.toHTML=function(t){var n;if(t&&"object"===e(t))switch(e(t.handler)){case"object":case"undefined":break;case"function":n=t.handler(this,t);break;default:throw new TypeError("Object or function expected as callback")}return void 0!==n?n:this.toHTML(t)},c.prototype._toString=function(){throw new Error("_toString not implemented for "+this.type)},c.prototype.toTex=function(t){var n;if(t&&"object"===e(t))switch(e(t.handler)){case"object":case"undefined":break;case"function":n=t.handler(this,t);break;default:throw new TypeError("Object or function expected as callback")}return void 0!==n?n:this._toTex(t)},c.prototype._toTex=function(e){throw new Error("_toTex not implemented for "+this.type)},c.prototype.getIdentifier=function(){return this.type},c.prototype.getContent=function(){return this},c},Rt}var jt,Vt,Ft,kt={},Lt={};function zt(){if(Vt)return jt;function e(t,n,r){if(!(this instanceof e))throw new SyntaxError("Constructor must be called with the new operator");this.index=t,arguments.length<3?(this.min=0,this.max=n):(this.min=n,this.max=r),void 0!==this.min&&this.index<this.min?this.message="Index out of range ("+this.index+" < "+this.min+")":void 0!==this.max&&this.index>=this.max?this.message="Index out of range ("+this.index+" > "+(this.max-1)+")":this.message="Index out of range ("+this.index+")",this.stack=(new Error).stack}return Vt=1,e.prototype=new RangeError,e.prototype.constructor=RangeError,e.prototype.name="IndexError",e.prototype.isIndexError=!0,jt=e}function Ht(){if(Ft)return Lt;Ft=1;var e=zt();return Lt.transform=function(t){return t&&t.isIndexError?new e(t.index+1,t.min+1,void 0!==t.max?t.max+1:void 0):t},Lt}var Xt,Gt,Wt,Jt,Yt,$t={},qt={},Zt={},Kt={};function Qt(){return Gt||(Gt=1,function(e){function t(e){return(t="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}var n=He().format,r=function(){return Xt||(Xt=1,e=Kt,t=Be(),e.format=function(n,r){if("function"==typeof r)return r(n);if(!n.isFinite())return n.isNaN()?"NaN":n.gt(0)?"Infinity":"-Infinity";var i,o="auto";switch(void 0!==r&&(r.notation&&(o=r.notation),"number"==typeof r?i=r:r.precision&&(i=r.precision)),o){case"fixed":return e.toFixed(n,i);case"exponential":return e.toExponential(n,i);case"engineering":return e.toEngineering(n,i);case"auto":if(r&&r.exponential&&(void 0!==r.exponential.lower||void 0!==r.exponential.upper)){var s=t.map(r,function(e){return e});return s.exponential=void 0,void 0!==r.exponential.lower&&(s.lowerExp=Math.round(Math.log(r.exponential.lower)/Math.LN10)),void 0!==r.exponential.upper&&(s.upperExp=Math.round(Math.log(r.exponential.upper)/Math.LN10)),e.format(n,s)}var a=r&&void 0!==r.lowerExp?r.lowerExp:-3,u=r&&void 0!==r.upperExp?r.upperExp:5;if(n.isZero())return"0";var c=n.e;return(c>=a&&c<u?n.toSignificantDigits(i).toFixed():e.toExponential(n,i)).replace(/((\.\d*?)(0+))($|e)/,function(){var e=arguments[2],t=arguments[4];return"."!==e?e+t:t});default:throw new Error('Unknown notation "'+o+'". Choose "auto", "exponential", or "fixed".')}},e.toEngineering=function(e,t){var n=e.e,r=n%3==0?n:n<0?n-3-n%3:n-n%3,i=e.mul(Math.pow(10,-r)),o=i.toPrecision(t);return-1!==o.indexOf("e")&&(o=i.toString()),o+"e"+(n>=0?"+":"")+r.toString()},e.toExponential=function(e,t){return void 0!==t?e.toExponential(t-1):e.toExponential()},e.toFixed=function(e,t){return e.toFixed(t)}),Kt;var e,t}().format,i=Ce();function o(t,n){if(Array.isArray(t)){for(var r="[",i=t.length,s=0;s<i;s++)0!==s&&(r+=", "),r+=o(t[s],n);return r+="]"}return e.format(t,n)}e.isString=function(e){return"string"==typeof e},e.endsWith=function(e,t){var n=e.length-t.length,r=e.length;return e.substring(n,r)===t},e.format=function(s,a){if("number"==typeof s)return n(s,a);if(i(s))return r(s,a);if(function(e){return e&&"object"===t(e)&&"number"==typeof e.s&&"number"==typeof e.n&&"number"==typeof e.d||!1}(s))return a&&"decimal"===a.fraction?s.toString():s.s*s.n+"/"+s.d;if(Array.isArray(s))return o(s,a);if(e.isString(s))return'"'+s+'"';if("function"==typeof s)return s.syntax?String(s.syntax):"function";if(s&&"object"===t(s)){if("function"==typeof s.format)return s.format(a);if(s&&s.toString()!=={}.toString())return s.toString();var u=[];for(var c in s)s.hasOwnProperty(c)&&u.push('"'+c+'": '+e.format(s[c],a));return"{"+u.join(", ")+"}"}return String(s)},e.stringify=function(e){for(var t=String(e),n="",r=0;r<t.length;){var i=t.charAt(r);"\\"===i?(n+=i,r++,""!==(i=t.charAt(r))&&-1!=='"\\/bfnrtu'.indexOf(i)||(n+="\\"),n+=i):n+='"'===i?'\\"':i,r++}return'"'+n+'"'},e.escape=function(e){var t=String(e);return t=t.replace(/&/g,"&amp;").replace(/"/g,"&quot;").replace(/'/g,"&#39;").replace(/</g,"&lt;").replace(/>/g,"&gt;")}}(Zt)),Zt}function en(){if(Jt)return Wt;function e(t,n,r){if(!(this instanceof e))throw new SyntaxError("Constructor must be called with the new operator");this.actual=t,this.expected=n,this.relation=r,this.message="Dimension mismatch ("+(Array.isArray(t)?"["+t.join(", ")+"]":t)+" "+(this.relation||"!=")+" "+(Array.isArray(n)?"["+n.join(", ")+"]":n)+")",this.stack=(new Error).stack}return Jt=1,e.prototype=new RangeError,e.prototype.constructor=RangeError,e.prototype.name="DimensionError",e.prototype.isDimensionError=!0,Wt=e}function tn(){if(Yt)return qt;Yt=1,Object.defineProperty(qt,"__esModule",{value:!0}),qt.size=o,qt.validate=function(e,t){if(0===t.length){if(Array.isArray(e))throw new n.default(e.length,0)}else s(e,t,0)},qt.validateIndex=function(t,n){if(!e.default.isNumber(t)||!e.default.isInteger(t))throw new TypeError("Index must be an integer (value: "+t+")");if(t<0||"number"==typeof n&&t>=n)throw new r.default(t,n)},qt.resize=function(n,r,i){if(!Array.isArray(n)||!Array.isArray(r))throw new TypeError("Array expected");if(0===r.length)throw new Error("Resizing to scalar is not supported");return r.forEach(function(n){if(!e.default.isNumber(n)||!e.default.isInteger(n)||n<0)throw new TypeError("Invalid size, must contain positive integers (size: "+t.default.format(r)+")")}),a(n,r,0,i!==void 0?i:0),n},qt.reshape=function(e,t){var r,i=l(e);function s(e){return e.reduce(function(e,t){return e*t})}if(!Array.isArray(e)||!Array.isArray(t))throw new TypeError("Array expected");if(0===t.length)throw new n.default(0,s(o(e)),"!=");for(var a=1,u=0;u<t.length;u++)a*=t[u];if(i.length!==a)throw new n.default(s(t),s(o(e)),"!=");try{r=function(e,t){for(var n,r=e,i=t.length-1;i>0;i--){var o=t[i];n=[];for(var s=r.length/o,a=0;a<s;a++)n.push(r.slice(a*o,(a+1)*o));r=n}return r}(i,t)}catch(c){if(c instanceof n.default)throw new n.default(s(t),s(o(e)),"!=");throw c}return r},qt.squeeze=function(e,t){var n=t||o(e);for(;Array.isArray(e)&&1===e.length;)e=e[0],n.shift();var r=n.length;for(;1===n[r-1];)r--;r<n.length&&(e=u(e,r,0),n.length=r);return e},qt.unsqueeze=function(e,t,n,r){var i=r||o(e);if(n)for(var s=0;s<n;s++)e=[e],i.unshift(1);e=c(e,t,0);for(;i.length<t;)i.push(1);return e},qt.flatten=l,qt.map=function(e,t){return Array.prototype.map.call(e,t)},qt.forEach=function(e,t){Array.prototype.forEach.call(e,t)},qt.filter=function(e,t){if(1!==o(e).length)throw new Error("Only one dimensional matrices supported");return Array.prototype.filter.call(e,t)},qt.filterRegExp=function(e,t){if(1!==o(e).length)throw new Error("Only one dimensional matrices supported");return Array.prototype.filter.call(e,function(e){return t.test(e)})},qt.join=function(e,t){return Array.prototype.join.call(e,t)},qt.identify=function(e){if(!Array.isArray(e))throw new TypeError("Array input expected");if(0===e.length)return e;var t=[],n=0;t[0]={value:e[0],identifier:0};for(var r=1;r<e.length;r++)e[r]===e[r-1]?n++:n=0,t.push({value:e[r],identifier:n});return t},qt.generalize=function(e){if(!Array.isArray(e))throw new TypeError("Array input expected");if(0===e.length)return e;for(var t=[],n=0;n<e.length;n++)t.push(e[n].value);return t};var e=i(He()),t=i(Qt()),n=i(en()),r=i(zt());function i(e){return e&&e.__esModule?e:{default:e}}function o(e){for(var t=[];Array.isArray(e);)t.push(e.length),e=e[0];return t}function s(e,t,r){var i,o=e.length;if(o!==t[r])throw new n.default(o,t[r]);if(r<t.length-1){var a=r+1;for(i=0;i<o;i++){var u=e[i];if(!Array.isArray(u))throw new n.default(t.length-1,t.length,"<");s(e[i],t,a)}}else for(i=0;i<o;i++)if(Array.isArray(e[i]))throw new n.default(t.length+1,t.length,">")}function a(e,t,n,r){var i,o,s=e.length,u=t[n],c=Math.min(s,u);if(e.length=u,n<t.length-1){var l=n+1;for(i=0;i<c;i++)o=e[i],Array.isArray(o)||(o=[o],e[i]=o),a(o,t,l,r);for(i=c;i<u;i++)o=[],e[i]=o,a(o,t,l,r)}else{for(i=0;i<c;i++)for(;Array.isArray(e[i]);)e[i]=e[i][0];for(i=c;i<u;i++)e[i]=r}}function u(e,t,n){var r,i;if(n<t){var o=n+1;for(r=0,i=e.length;r<i;r++)e[r]=u(e[r],t,o)}else for(;Array.isArray(e);)e=e[0];return e}function c(e,t,n){var r,i;if(Array.isArray(e)){var o=n+1;for(r=0,i=e.length;r<i;r++)e[r]=c(e[r],t,o)}else for(var s=n;s<t;s++)e=[e];return e}function l(e){if(!Array.isArray(e))return e;var t=[];return e.forEach(function e(n){Array.isArray(n)?n.forEach(e):t.push(n)}),t}return qt}var nn,rn,on,sn,an={};function un(){if(nn)return an;return nn=1,an.name="matrix",an.factory=function(e,t,n,r){var i=r("matrix",{"":function(){return o([])},string:function(e){return o([],e)},"string, string":function(e,t){return o([],e,t)},Array:function(e){return o(e)},Matrix:function(e){return o(e,e.storage())},"Array | Matrix, string":o,"Array | Matrix, string, string":o});return i.toTex={0:"\\begin{bmatrix}\\end{bmatrix}",1:"\\left(${args[0]}\\right)",2:"\\left(${args[0]}\\right)"},i;function o(t,n,r){return new(e.Matrix.storage(n||"default"))(t,r)}},an}function cn(){if(rn)return $t;rn=1;var e=Be().clone,t=tn().validateIndex,n=Ot().getSafeProperty,r=Ot().setSafeProperty,i=en();function o(e,t){if(1!==t.size().length)throw new i(t.size(),1);var r=t.dimension(0);if("string"!=typeof r)throw new TypeError("String expected as index to retrieve an object property");return n(e,r)}function s(t,n,o){if(1!==n.size().length)throw new i(n.size(),1);var s=n.dimension(0);if("string"!=typeof s)throw new TypeError("String expected as index to retrieve an object property");var a=e(t);return r(a,s,o),a}return $t.name="subset",$t.factory=function(n,r,a,u){var c=a(un()),l=u("subset",{"Array, Index":function(e,t){var n=c(e).subset(t);return t.isScalar()?n:n.valueOf()},"Matrix, Index":function(e,t){return e.subset(t)},"Object, Index":o,"string, Index":function(e,r){if(!n.isIndex(r))throw new TypeError("Index expected");if(1!==r.size().length)throw new i(r.size().length,1);var o=e.length;t(r.min()[0],o),t(r.max()[0],o);var s=r.dimension(0),a="";return s.forEach(function(t){a+=e.charAt(t)}),a},"Array, Index, any":function(t,n,r){return c(e(t)).subset(n,r,void 0).valueOf()},"Array, Index, any, any":function(t,n,r,i){return c(e(t)).subset(n,r,i).valueOf()},"Matrix, Index, any":function(e,t,n){return e.clone().subset(t,n)},"Matrix, Index, any, any":function(e,t,n,r){return e.clone().subset(t,n,r)},"string, Index, string":h,"string, Index, string, string":h,"Object, Index, any":s});return l.toTex=void 0,l;function h(e,n,r,o){if(!n||!0!==n.isIndex)throw new TypeError("Index expected");if(1!==n.size().length)throw new i(n.size().length,1);if(void 0!==o){if("string"!=typeof o||1!==o.length)throw new TypeError("Single character expected as defaultValue")}else o=" ";var s=n.dimension(0);if(s.size()[0]!==r.length)throw new i(s.size()[0],r.length);var a=e.length;t(n.min()[0]),t(n.max()[0]);for(var u=[],c=0;c<a;c++)u[c]=e.charAt(c);if(s.forEach(function(e,t){u[e]=r.charAt(t[0])}),u.length>a)for(var l=a-1,h=u.length;l<h;l++)u[l]||(u[l]=o);return u.join("")}},$t}function ln(){if(on)return kt;function e(t){return(e="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(t)}on=1;var t=Ht().transform,n=Ot().getSafeProperty;return kt.factory=function(r,i,o,s){var a=o(cn());return function(r,i){try{if(Array.isArray(r))return a(r,i);if(r&&"function"==typeof r.subset)return r.subset(i);if("string"==typeof r)return a(r,i);if("object"===e(r)){if(!i.isObjectProperty())throw new TypeError("Cannot apply a numeric index as object property");return n(r,i.getObjectProperty())}throw new TypeError("Cannot apply index: unsupported type of object")}catch(o){throw t(o)}}},kt}var hn,fn={};var pn,dn={},mn={};var vn,gn,yn={};function xn(){if(vn)return yn;vn=1;var e=[{AssignmentNode:{},FunctionAssignmentNode:{}},{ConditionalNode:{latexLeftParens:!1,latexRightParens:!1,latexParens:!1}},{"OperatorNode:or":{associativity:"left",associativeWith:[]}},{"OperatorNode:xor":{associativity:"left",associativeWith:[]}},{"OperatorNode:and":{associativity:"left",associativeWith:[]}},{"OperatorNode:bitOr":{associativity:"left",associativeWith:[]}},{"OperatorNode:bitXor":{associativity:"left",associativeWith:[]}},{"OperatorNode:bitAnd":{associativity:"left",associativeWith:[]}},{"OperatorNode:equal":{associativity:"left",associativeWith:[]},"OperatorNode:unequal":{associativity:"left",associativeWith:[]},"OperatorNode:smaller":{associativity:"left",associativeWith:[]},"OperatorNode:larger":{associativity:"left",associativeWith:[]},"OperatorNode:smallerEq":{associativity:"left",associativeWith:[]},"OperatorNode:largerEq":{associativity:"left",associativeWith:[]},RelationalNode:{associativity:"left",associativeWith:[]}},{"OperatorNode:leftShift":{associativity:"left",associativeWith:[]},"OperatorNode:rightArithShift":{associativity:"left",associativeWith:[]},"OperatorNode:rightLogShift":{associativity:"left",associativeWith:[]}},{"OperatorNode:to":{associativity:"left",associativeWith:[]}},{RangeNode:{}},{"OperatorNode:add":{associativity:"left",associativeWith:["OperatorNode:add","OperatorNode:subtract"]},"OperatorNode:subtract":{associativity:"left",associativeWith:[]}},{"OperatorNode:multiply":{associativity:"left",associativeWith:["OperatorNode:multiply","OperatorNode:divide","Operator:dotMultiply","Operator:dotDivide"]},"OperatorNode:divide":{associativity:"left",associativeWith:[],latexLeftParens:!1,latexRightParens:!1,latexParens:!1},"OperatorNode:dotMultiply":{associativity:"left",associativeWith:["OperatorNode:multiply","OperatorNode:divide","OperatorNode:dotMultiply","OperatorNode:doDivide"]},"OperatorNode:dotDivide":{associativity:"left",associativeWith:[]},"OperatorNode:mod":{associativity:"left",associativeWith:[]}},{"OperatorNode:unaryPlus":{associativity:"right"},"OperatorNode:unaryMinus":{associativity:"right"},"OperatorNode:bitNot":{associativity:"right"},"OperatorNode:not":{associativity:"right"}},{"OperatorNode:pow":{associativity:"right",associativeWith:[],latexRightParens:!1},"OperatorNode:dotPow":{associativity:"right",associativeWith:[]}},{"OperatorNode:factorial":{associativity:"left"}},{"OperatorNode:transpose":{associativity:"left"}}];function t(t,n){var r=t;"keep"!==n&&(r=t.getContent());for(var i=r.getIdentifier(),o=0;o<e.length;o++)if(i in e[o])return o;return null}return yn.properties=e,yn.getPrecedence=t,yn.getAssociativity=function(n,r){var i=n;"keep"!==r&&(i=n.getContent());var o=i.getIdentifier(),s=t(i,r);if(null===s)return null;var a=e[s][o];if(a.hasOwnProperty("associativity")){if("left"===a.associativity)return"left";if("right"===a.associativity)return"right";throw Error("'"+o+"' has the invalid associativity '"+a.associativity+"'.")}return null},yn.isAssociativeWith=function(n,r,i){var o="keep"!==i?n.getContent():n,s="keep"!==i?n.getContent():r,a=o.getIdentifier(),u=s.getIdentifier(),c=t(o,i);if(null===c)return null;var l=e[c][a];if(l.hasOwnProperty("associativeWith")&&l.associativeWith instanceof Array){for(var h=0;h<l.associativeWith.length;h++)if(l.associativeWith[h]===u)return!0;return!1}return null},yn}function bn(){if(gn)return dn;gn=1;var e=Ot().getSafeProperty,t=Ot().setSafeProperty;return dn.name="AssignmentNode",dn.path="expression.node",dn.factory=function(n,r,i,o){var s=i(It()),a=i(function(){if(pn)return mn;function e(t){return(e="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(t)}pn=1;var t=Ht().transform,n=Ot().setSafeProperty;return mn.factory=function(r,i,o,s){var a=o(cn()),u=o(un());return function(r,i,o){try{if(Array.isArray(r))return u(r).subset(i,o).valueOf();if(r&&"function"==typeof r.subset)return r.subset(i,o);if("string"==typeof r)return a(r,i,o);if("object"===e(r)){if(!i.isObjectProperty())throw TypeError("Cannot apply a numeric index as object property");return n(r,i.getObjectProperty(),o),r}throw new TypeError("Cannot apply index: unsupported type of object")}catch(s){throw t(s)}}},mn}()),u=i(ln()),c=xn();function l(e,t,r){if(!(this instanceof l))throw new SyntaxError("Constructor must be called with the new operator");if(this.object=e,this.index=r?t:null,this.value=r||t,!n.isSymbolNode(e)&&!n.isAccessorNode(e))throw new TypeError('SymbolNode or AccessorNode expected as "object"');if(n.isSymbolNode(e)&&"end"===e.name)throw new Error('Cannot assign to symbol "end"');if(this.index&&!n.isIndexNode(this.index))throw new TypeError('IndexNode expected as "index"');if(!n.isNode(this.value))throw new TypeError('Node expected as "value"');Object.defineProperty(this,"name",{get:function(){return this.index?this.index.isObjectProperty()?this.index.getObjectProperty():"":this.object.name||""}.bind(this),set:function(){throw new Error("Cannot assign a new name, name is read-only")}})}function h(e,t){t||(t="keep");var n=c.getPrecedence(e,t),r=c.getPrecedence(e.value,t);return"all"===t||null!==r&&r<=n}return l.prototype=new s,l.prototype.type="AssignmentNode",l.prototype.isAssignmentNode=!0,l.prototype._compile=function(r,i){var o=this.object._compile(r,i),s=this.index?this.index._compile(r,i):null,c=this.value._compile(r,i),l=this.object.name;if(this.index){if(this.index.isObjectProperty()){var h=this.index.getObjectProperty();return function(e,n,r){var i=o(e,n,r),s=c(e,n,r);return t(i,h,s)}}if(n.isSymbolNode(this.object))return function(e,n,r){var i=o(e,n,r),u=c(e,n,r),h=s(e,n,i);return t(e,l,a(i,h,u)),u};var f=this.object.object._compile(r,i);if(this.object.index.isObjectProperty()){var p=this.object.index.getObjectProperty();return function(n,r,i){var o=f(n,r,i),u=e(o,p),l=s(n,r,u),h=c(n,r,i);return t(o,p,a(u,l,h)),h}}var d=this.object.index._compile(r,i);return function(e,t,n){var r=f(e,t,n),i=d(e,t,r),o=u(r,i),l=s(e,t,o),h=c(e,t,n);return a(r,i,a(o,l,h)),h}}if(!n.isSymbolNode(this.object))throw new TypeError("SymbolNode expected as object");return function(e,n,r){return t(e,l,c(e,n,r))}},l.prototype.forEach=function(e){e(this.object,"object",this),this.index&&e(this.index,"index",this),e(this.value,"value",this)},l.prototype.map=function(e){return new l(this._ifNode(e(this.object,"object",this)),this.index?this._ifNode(e(this.index,"index",this)):null,this._ifNode(e(this.value,"value",this)))},l.prototype.clone=function(){return new l(this.object,this.index,this.value)},l.prototype._toString=function(e){var t=this.object.toString(e),n=this.index?this.index.toString(e):"",r=this.value.toString(e);return h(this,e&&e.parenthesis)&&(r="("+r+")"),t+n+" = "+r},l.prototype.toJSON=function(){return{mathjs:"AssignmentNode",object:this.object,index:this.index,value:this.value}},l.fromJSON=function(e){return new l(e.object,e.index,e.value)},l.prototype.toHTML=function(e){var t=this.object.toHTML(e),n=this.index?this.index.toHTML(e):"",r=this.value.toHTML(e);return h(this,e&&e.parenthesis)&&(r='<span class="math-paranthesis math-round-parenthesis">(</span>'+r+'<span class="math-paranthesis math-round-parenthesis">)</span>'),t+n+'<span class="math-operator math-assignment-operator math-variable-assignment-operator math-binary-operator">=</span>'+r},l.prototype._toTex=function(e){var t=this.object.toTex(e),n=this.index?this.index.toTex(e):"",r=this.value.toTex(e);return h(this,e&&e.parenthesis)&&(r="\\left(".concat(r,"\\right)")),t+n+":="+r},l},dn}var En,wn,Nn={},Sn={};function Tn(){if(wn)return Nn;wn=1;var e=tn().forEach,t=tn().map;return Nn.name="BlockNode",Nn.path="expression.node",Nn.factory=function(n,r,i,o){var s=i(It()),a=i((En||(En=1,Sn.name="ResultSet",Sn.path="type",Sn.factory=function(e,t,n,r){function i(e){if(!(this instanceof i))throw new SyntaxError("Constructor must be called with the new operator");this.entries=e||[]}return i.prototype.type="ResultSet",i.prototype.isResultSet=!0,i.prototype.valueOf=function(){return this.entries},i.prototype.toString=function(){return"["+this.entries.join(", ")+"]"},i.prototype.toJSON=function(){return{mathjs:"ResultSet",entries:this.entries}},i.fromJSON=function(e){return new i(e.entries)},i}),Sn));function u(e){if(!(this instanceof u))throw new SyntaxError("Constructor must be called with the new operator");if(!Array.isArray(e))throw new Error("Array expected");this.blocks=e.map(function(e){var t=e&&e.node,r=!e||void 0===e.visible||e.visible;if(!n.isNode(t))throw new TypeError('Property "node" must be a Node');if("boolean"!=typeof r)throw new TypeError('Property "visible" must be a boolean');return{node:t,visible:r}})}return u.prototype=new s,u.prototype.type="BlockNode",u.prototype.isBlockNode=!0,u.prototype._compile=function(n,r){var i=t(this.blocks,function(e){return{eval:e.node._compile(n,r),visible:e.visible}});return function(t,n,r){var o=[];return e(i,function(e){var i=e.eval(t,n,r);e.visible&&o.push(i)}),new a(o)}},u.prototype.forEach=function(e){for(var t=0;t<this.blocks.length;t++)e(this.blocks[t].node,"blocks["+t+"].node",this)},u.prototype.map=function(e){for(var t=[],n=0;n<this.blocks.length;n++){var r=this.blocks[n],i=this._ifNode(e(r.node,"blocks["+n+"].node",this));t[n]={node:i,visible:r.visible}}return new u(t)},u.prototype.clone=function(){return new u(this.blocks.map(function(e){return{node:e.node,visible:e.visible}}))},u.prototype._toString=function(e){return this.blocks.map(function(t){return t.node.toString(e)+(t.visible?"":";")}).join("\n")},u.prototype.toJSON=function(){return{mathjs:"BlockNode",blocks:this.blocks}},u.fromJSON=function(e){return new u(e.blocks)},u.prototype.toHTML=function(e){return this.blocks.map(function(t){return t.node.toHTML(e)+(t.visible?"":'<span class="math-separator">;</span>')}).join('<span class="math-separator"><br /></span>')},u.prototype._toTex=function(e){return this.blocks.map(function(t){return t.node.toTex(e)+(t.visible?"":";")}).join("\\;\\;\n")},u},Nn}var Mn,An={};function Dn(){if(Mn)return An;Mn=1;var e=xn();return An.name="ConditionalNode",An.path="expression.node",An.factory=function(t,n,r,i){var o=r(It()),s=r(vt());function a(e,n,r){if(!(this instanceof a))throw new SyntaxError("Constructor must be called with the new operator");if(!t.isNode(e))throw new TypeError("Parameter condition must be a Node");if(!t.isNode(n))throw new TypeError("Parameter trueExpr must be a Node");if(!t.isNode(r))throw new TypeError("Parameter falseExpr must be a Node");this.condition=e,this.trueExpr=n,this.falseExpr=r}return a.prototype=new o,a.prototype.type="ConditionalNode",a.prototype.isConditionalNode=!0,a.prototype._compile=function(e,n){var r=this.condition._compile(e,n),i=this.trueExpr._compile(e,n),o=this.falseExpr._compile(e,n);return function(e,n,a){return function(e){if("number"==typeof e||"boolean"==typeof e||"string"==typeof e)return!!e;if(e){if(t.isBigNumber(e))return!e.isZero();if(t.isComplex(e))return!(!e.re&&!e.im);if(t.isUnit(e))return!!e.value}if(null==e)return!1;throw new TypeError('Unsupported type of condition "'+s(e)+'"')}(r(e,n,a))?i(e,n,a):o(e,n,a)}},a.prototype.forEach=function(e){e(this.condition,"condition",this),e(this.trueExpr,"trueExpr",this),e(this.falseExpr,"falseExpr",this)},a.prototype.map=function(e){return new a(this._ifNode(e(this.condition,"condition",this)),this._ifNode(e(this.trueExpr,"trueExpr",this)),this._ifNode(e(this.falseExpr,"falseExpr",this)))},a.prototype.clone=function(){return new a(this.condition,this.trueExpr,this.falseExpr)},a.prototype._toString=function(t){var n=t&&t.parenthesis?t.parenthesis:"keep",r=e.getPrecedence(this,n),i=this.condition.toString(t),o=e.getPrecedence(this.condition,n);("all"===n||"OperatorNode"===this.condition.type||null!==o&&o<=r)&&(i="("+i+")");var s=this.trueExpr.toString(t),a=e.getPrecedence(this.trueExpr,n);("all"===n||"OperatorNode"===this.trueExpr.type||null!==a&&a<=r)&&(s="("+s+")");var u=this.falseExpr.toString(t),c=e.getPrecedence(this.falseExpr,n);return("all"===n||"OperatorNode"===this.falseExpr.type||null!==c&&c<=r)&&(u="("+u+")"),i+" ? "+s+" : "+u},a.prototype.toJSON=function(){return{mathjs:"ConditionalNode",condition:this.condition,trueExpr:this.trueExpr,falseExpr:this.falseExpr}},a.fromJSON=function(e){return new a(e.condition,e.trueExpr,e.falseExpr)},a.prototype.toHTML=function(t){var n=t&&t.parenthesis?t.parenthesis:"keep",r=e.getPrecedence(this,n),i=this.condition.toHTML(t),o=e.getPrecedence(this.condition,n);("all"===n||"OperatorNode"===this.condition.type||null!==o&&o<=r)&&(i='<span class="math-parenthesis math-round-parenthesis">(</span>'+i+'<span class="math-parenthesis math-round-parenthesis">)</span>');var s=this.trueExpr.toHTML(t),a=e.getPrecedence(this.trueExpr,n);("all"===n||"OperatorNode"===this.trueExpr.type||null!==a&&a<=r)&&(s='<span class="math-parenthesis math-round-parenthesis">(</span>'+s+'<span class="math-parenthesis math-round-parenthesis">)</span>');var u=this.falseExpr.toHTML(t),c=e.getPrecedence(this.falseExpr,n);return("all"===n||"OperatorNode"===this.falseExpr.type||null!==c&&c<=r)&&(u='<span class="math-parenthesis math-round-parenthesis">(</span>'+u+'<span class="math-parenthesis math-round-parenthesis">)</span>'),i+'<span class="math-operator math-conditional-operator">?</span>'+s+'<span class="math-operator math-conditional-operator">:</span>'+u},a.prototype._toTex=function(e){return"\\begin{cases} {"+this.trueExpr.toTex(e)+"}, &\\quad{\\text{if }\\;"+this.condition.toTex(e)+"}\\\\{"+this.falseExpr.toTex(e)+"}, &\\quad{\\text{otherwise}}\\end{cases}"},a},An}var _n,On,Pn,Cn,Bn={},Rn={};function Un(){return Pn||(Pn=1,function(e){var t=function(){if(On)return _n;On=1;var e=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var r in n)Object.prototype.hasOwnProperty.call(n,r)&&(e[r]=n[r])}return e},t={"{":"\\{","}":"\\}","\\":"\\textbackslash{}","#":"\\#",$:"\\$","%":"\\%","&":"\\&","^":"\\textasciicircum{}",_:"\\_","~":"\\textasciitilde{}"},n={"–":"\\--","—":"\\---"," ":"~","\t":"\\qquad{}","\r\n":"\\newline{}","\n":"\\newline{}"},r=function(t,n){return e({},t,n)};return _n=function(i){for(var o=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},s=o.preserveFormatting,a=void 0!==s&&s,u=o.escapeMapFn,c=void 0===u?r:u,l=String(i),h="",f=c(e({},t),a?e({},n):{}),p=Object.keys(f),d=function(){var e=!1;p.forEach(function(t,n){e||l.length>=t.length&&l.slice(0,t.length)===t&&(h+=f[p[n]],l=l.slice(t.length,l.length),e=!0)}),e||(h+=l.slice(0,1),l=l.slice(1,l.length))};l;)d();return h},_n}();e.symbols={Alpha:"A",alpha:"\\alpha",Beta:"B",beta:"\\beta",Gamma:"\\Gamma",gamma:"\\gamma",Delta:"\\Delta",delta:"\\delta",Epsilon:"E",epsilon:"\\epsilon",varepsilon:"\\varepsilon",Zeta:"Z",zeta:"\\zeta",Eta:"H",eta:"\\eta",Theta:"\\Theta",theta:"\\theta",vartheta:"\\vartheta",Iota:"I",iota:"\\iota",Kappa:"K",kappa:"\\kappa",varkappa:"\\varkappa",Lambda:"\\Lambda",lambda:"\\lambda",Mu:"M",mu:"\\mu",Nu:"N",nu:"\\nu",Xi:"\\Xi",xi:"\\xi",Omicron:"O",omicron:"o",Pi:"\\Pi",pi:"\\pi",varpi:"\\varpi",Rho:"P",rho:"\\rho",varrho:"\\varrho",Sigma:"\\Sigma",sigma:"\\sigma",varsigma:"\\varsigma",Tau:"T",tau:"\\tau",Upsilon:"\\Upsilon",upsilon:"\\upsilon",Phi:"\\Phi",phi:"\\phi",varphi:"\\varphi",Chi:"X",chi:"\\chi",Psi:"\\Psi",psi:"\\psi",Omega:"\\Omega",omega:"\\omega",true:"\\mathrm{True}",false:"\\mathrm{False}",i:"i",inf:"\\infty",Inf:"\\infty",infinity:"\\infty",Infinity:"\\infty",oo:"\\infty",lim:"\\lim",undefined:"\\mathbf{?}"},e.operators={transpose:"^\\top",ctranspose:"^H",factorial:"!",pow:"^",dotPow:".^\\wedge",unaryPlus:"+",unaryMinus:"-",bitNot:"\\~",not:"\\neg",multiply:"\\cdot",divide:"\\frac",dotMultiply:".\\cdot",dotDivide:".:",mod:"\\mod",add:"+",subtract:"-",to:"\\rightarrow",leftShift:"<<",rightArithShift:">>",rightLogShift:">>>",equal:"=",unequal:"\\neq",smaller:"<",larger:">",smallerEq:"\\leq",largerEq:"\\geq",bitAnd:"\\&",bitXor:"\\underline{|}",bitOr:"|",and:"\\wedge",xor:"\\veebar",or:"\\vee"},e.defaultTemplate="\\mathrm{${name}}\\left(${args}\\right)";var n={deg:"^\\circ"};e.escape=function(e){return t(e,{preserveFormatting:!0})},e.toSymbol=function(t,r){return(r=void 0!==r&&r)?n.hasOwnProperty(t)?n[t]:"\\mathrm{"+e.escape(t)+"}":e.symbols.hasOwnProperty(t)?e.symbols[t]:e.escape(t)}}(Rn)),Rn}var In,jn={};var Vn,Fn,kn={},Ln={};function zn(){if(Fn)return kn;Fn=1;var e=tn().map,t=Qt().escape;return kn.name="IndexNode",kn.path="expression.node",kn.factory=function(n,r,i,o){var s=i(It()),a=i(function(){if(Vn)return Ln;Vn=1;var e=He();return Ln.name="Range",Ln.path="type",Ln.factory=function(t,n,r,i){function o(e,n,r){if(!(this instanceof o))throw new SyntaxError("Constructor must be called with the new operator");var i=null!=e,s=null!=n,a=null!=r;if(i)if(t.isBigNumber(e))e=e.toNumber();else if("number"!=typeof e)throw new TypeError("Parameter start must be a number");if(s)if(t.isBigNumber(n))n=n.toNumber();else if("number"!=typeof n)throw new TypeError("Parameter end must be a number");if(a)if(t.isBigNumber(r))r=r.toNumber();else if("number"!=typeof r)throw new TypeError("Parameter step must be a number");this.start=i?parseFloat(e):0,this.end=s?parseFloat(n):0,this.step=a?parseFloat(r):1}return o.prototype.type="Range",o.prototype.isRange=!0,o.parse=function(e){if("string"!=typeof e)return null;var t=e.split(":").map(function(e){return parseFloat(e)});if(t.some(function(e){return isNaN(e)}))return null;switch(t.length){case 2:return new o(t[0],t[1]);case 3:return new o(t[0],t[2],t[1]);default:return null}},o.prototype.clone=function(){return new o(this.start,this.end,this.step)},o.prototype.size=function(){var t=0,n=this.start,r=this.step,i=this.end-n;return e.sign(r)===e.sign(i)?t=Math.ceil(i/r):0===i&&(t=0),isNaN(t)&&(t=0),[t]},o.prototype.min=function(){var e=this.size()[0];return e>0?this.step>0?this.start:this.start+(e-1)*this.step:void 0},o.prototype.max=function(){var e=this.size()[0];return e>0?this.step>0?this.start+(e-1)*this.step:this.start:void 0},o.prototype.forEach=function(e){var t=this.start,n=this.step,r=this.end,i=0;if(n>0)for(;t<r;)e(t,[i],this),t+=n,i++;else if(n<0)for(;t>r;)e(t,[i],this),t+=n,i++},o.prototype.map=function(e){var t=[];return this.forEach(function(n,r,i){t[r[0]]=e(n,r,i)}),t},o.prototype.toArray=function(){var e=[];return this.forEach(function(t,n){e[n[0]]=t}),e},o.prototype.valueOf=function(){return this.toArray()},o.prototype.format=function(t){var n=e.format(this.start,t);return 1!==this.step&&(n+=":"+e.format(this.step,t)),n+":"+e.format(this.end,t)},o.prototype.toString=function(){return this.format()},o.prototype.toJSON=function(){return{mathjs:"Range",start:this.start,end:this.end,step:this.step}},o.fromJSON=function(e){return new o(e.start,e.end,e.step)},o},Ln}()),u=Array.isArray;function c(e,t){if(!(this instanceof c))throw new SyntaxError("Constructor must be called with the new operator");if(this.dimensions=e,this.dotNotation=t||!1,!u(e)||!e.every(n.isNode))throw new TypeError('Array containing Nodes expected for parameter "dimensions"');if(this.dotNotation&&!this.isObjectProperty())throw new Error("dotNotation only applicable for object properties");var r=function(){throw new Error("Property `IndexNode.object` is deprecated, use `IndexNode.fn` instead")};Object.defineProperty(this,"object",{get:r,set:r})}function l(e,t,r){return new a(n.isBigNumber(e)?e.toNumber():e,n.isBigNumber(t)?t.toNumber():t,n.isBigNumber(r)?r.toNumber():r)}return c.prototype=new s,c.prototype.type="IndexNode",c.prototype.isIndexNode=!0,c.prototype._compile=function(t,r){var i=e(this.dimensions,function(e,i){if(n.isRangeNode(e)){if(e.needsEnd()){var o=Object.create(r);o.end=!0;var s=e.start._compile(t,o),a=e.end._compile(t,o),u=e.step?e.step._compile(t,o):function(){return 1};return function(e,n,r){var o=t.size(r).valueOf(),c=Object.create(n);return c.end=o[i],l(s(e,c,r),a(e,c,r),u(e,c,r))}}var c=e.start._compile(t,r),h=e.end._compile(t,r),f=e.step?e.step._compile(t,r):function(){return 1};return function(e,t,n){return l(c(e,t,n),h(e,t,n),f(e,t,n))}}if(n.isSymbolNode(e)&&"end"===e.name){var p=Object.create(r);p.end=!0;var d=e._compile(t,p);return function(e,n,r){var o=t.size(r).valueOf(),s=Object.create(n);return s.end=o[i],d(e,s,r)}}var m=e._compile(t,r);return function(e,t,n){return m(e,t,n)}});return function(n,r,o){var s=e(i,function(e){return e(n,r,o)});return t.index.apply(t,s)}},c.prototype.forEach=function(e){for(var t=0;t<this.dimensions.length;t++)e(this.dimensions[t],"dimensions["+t+"]",this)},c.prototype.map=function(e){for(var t=[],n=0;n<this.dimensions.length;n++)t[n]=this._ifNode(e(this.dimensions[n],"dimensions["+n+"]",this));return new c(t)},c.prototype.clone=function(){return new c(this.dimensions.slice(0))},c.prototype.isObjectProperty=function(){return 1===this.dimensions.length&&n.isConstantNode(this.dimensions[0])&&"string"==typeof this.dimensions[0].value},c.prototype.getObjectProperty=function(){return this.isObjectProperty()?this.dimensions[0].value:null},c.prototype._toString=function(e){return this.dotNotation?"."+this.getObjectProperty():"["+this.dimensions.join(", ")+"]"},c.prototype.toJSON=function(){return{mathjs:"IndexNode",dimensions:this.dimensions,dotNotation:this.dotNotation}},c.fromJSON=function(e){return new c(e.dimensions,e.dotNotation)},c.prototype.toHTML=function(e){for(var n=[],r=0;r<this.dimensions.length;r++)n[r]=this.dimensions[r].toHTML();return this.dotNotation?'<span class="math-operator math-accessor-operator">.</span><span class="math-symbol math-property">'+t(this.getObjectProperty())+"</span>":'<span class="math-parenthesis math-square-parenthesis">[</span>'+n.join('<span class="math-separator">,</span>')+'<span class="math-parenthesis math-square-parenthesis">]</span>'},c.prototype._toTex=function(e){var t=this.dimensions.map(function(t){return t.toTex(e)});return this.dotNotation?"."+this.getObjectProperty():"_{"+t.join(",")+"}"},c},kn}var Hn,Xn={};var Gn,Wn={};var Jn,Yn={};var $n,qn,Zn={},Kn={};function Qn(){if($n)return Kn;$n=1;var e=Un(),t=Qt().escape,n=Be().hasOwnProperty,r=Ot().getSafeProperty;return Kn.name="SymbolNode",Kn.path="expression.node",Kn.math=!0,Kn.factory=function(i,o,s,a,u){var c=s(It());function l(e){return!!i.Unit&&i.Unit.isValuelessUnit(e)}function h(e){if(!(this instanceof h))throw new SyntaxError("Constructor must be called with the new operator");if("string"!=typeof e)throw new TypeError('String expected for parameter "name"');this.name=e}return h.prototype=new c,h.prototype.type="SymbolNode",h.prototype.isSymbolNode=!0,h.prototype._compile=function(e,t){var o=this.name;if(n(t,o))return function(e,t,n){return t[o]};if(o in e)return function(t,n,i){return r(o in t?t:e,o)};var s=l(o);return function(e,t,n){return o in e?r(e,o):s?new i.Unit(null,o):function(e){throw new Error("Undefined symbol "+e)}(o)}},h.prototype.forEach=function(e){},h.prototype.map=function(e){return this.clone()},h.prototype.clone=function(){return new h(this.name)},h.prototype._toString=function(e){return this.name},h.prototype.toHTML=function(e){var n=t(this.name);return"true"===n||"false"===n?'<span class="math-symbol math-boolean">'+n+"</span>":"i"===n?'<span class="math-symbol math-imaginary-symbol">'+n+"</span>":"Infinity"===n?'<span class="math-symbol math-infinity-symbol">'+n+"</span>":"NaN"===n?'<span class="math-symbol math-nan-symbol">'+n+"</span>":"null"===n?'<span class="math-symbol math-null-symbol">'+n+"</span>":"undefined"===n?'<span class="math-symbol math-undefined-symbol">'+n+"</span>":'<span class="math-symbol">'+n+"</span>"},h.prototype.toJSON=function(){return{mathjs:"SymbolNode",name:this.name}},h.fromJSON=function(e){return new h(e.name)},h.prototype._toTex=function(t){var n=!1;void 0===u[this.name]&&l(this.name)&&(n=!0);var r=e.toSymbol(this.name,n);return"\\"===r[0]?r:" "+r},h},Kn}var er,tr={};var nr,rr,ir,or={};function sr(){if(rr)return ht;function e(){return e=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var r in n)Object.prototype.hasOwnProperty.call(n,r)&&(e[r]=n[r])}return e},e.apply(this,arguments)}rr=1;var t=et(),n=ft();return ht.name="parse",ht.path="expression",ht.factory=function(r,i,o,s){var a=o((St||(St=1,dt.path="type",dt.name="_numeric",dt.factory=function(e,t,n,r){var i=n(vt()),o={string:!0,number:!0,BigNumber:!0,Fraction:!0},s={number:n(xt()),BigNumber:n(wt()),Fraction:n(Mt())},a=function(e,t){var n=i(e);if(!(n in o))throw new TypeError("Cannot convert "+e+' of type "'+n+'"; valid input types are '+Object.keys(o).join(", "));if(!(t in s))throw new TypeError("Cannot convert "+e+' to type "'+t+'"; valid output types are '+Object.keys(s).join(", "));return t===n?e:s[t](e)};return a.toTex=function(e,t){return e.args[0].toTex()},a}),dt)),u=o(function(){if(sn)return Dt;sn=1;var e=Ot().getSafeProperty;return Dt.name="AccessorNode",Dt.path="expression.node",Dt.factory=function(t,n,r,i){var o=r(It()),s=r(ln());function a(e,n){if(!(this instanceof a))throw new SyntaxError("Constructor must be called with the new operator");if(!t.isNode(e))throw new TypeError('Node expected for parameter "object"');if(!t.isIndexNode(n))throw new TypeError('IndexNode expected for parameter "index"');this.object=e||null,this.index=n,Object.defineProperty(this,"name",{get:function(){return this.index?this.index.isObjectProperty()?this.index.getObjectProperty():"":this.object.name||""}.bind(this),set:function(){throw new Error("Cannot assign a new name, name is read-only")}})}function u(e){return!(t.isAccessorNode(e)||t.isArrayNode(e)||t.isConstantNode(e)||t.isFunctionNode(e)||t.isObjectNode(e)||t.isParenthesisNode(e)||t.isSymbolNode(e))}return a.prototype=new o,a.prototype.type="AccessorNode",a.prototype.isAccessorNode=!0,a.prototype._compile=function(t,n){var r=this.object._compile(t,n),i=this.index._compile(t,n);if(this.index.isObjectProperty()){var o=this.index.getObjectProperty();return function(t,n,i){return e(r(t,n,i),o)}}return function(e,t,n){var o=r(e,t,n),a=i(e,t,o);return s(o,a)}},a.prototype.forEach=function(e){e(this.object,"object",this),e(this.index,"index",this)},a.prototype.map=function(e){return new a(this._ifNode(e(this.object,"object",this)),this._ifNode(e(this.index,"index",this)))},a.prototype.clone=function(){return new a(this.object,this.index)},a.prototype._toString=function(e){var t=this.object.toString(e);return u(this.object)&&(t="("+t+")"),t+this.index.toString(e)},a.prototype.toHTML=function(e){var t=this.object.toHTML(e);return u(this.object)&&(t='<span class="math-parenthesis math-round-parenthesis">(</span>'+t+'<span class="math-parenthesis math-round-parenthesis">)</span>'),t+this.index.toHTML(e)},a.prototype._toTex=function(e){var t=this.object.toTex(e);return u(this.object)&&(t="\\left(' + object + '\\right)"),t+this.index.toTex(e)},a.prototype.toJSON=function(){return{mathjs:"AccessorNode",object:this.object,index:this.index}},a.fromJSON=function(e){return new a(e.object,e.index)},a},Dt}()),c=o(function(){if(hn)return fn;hn=1;var e=tn().map;return fn.name="ArrayNode",fn.path="expression.node",fn.factory=function(t,n,r,i){var o=r(It());function s(e){if(!(this instanceof s))throw new SyntaxError("Constructor must be called with the new operator");if(this.items=e||[],!Array.isArray(this.items)||!this.items.every(t.isNode))throw new TypeError("Array containing Nodes expected");var n=function(){throw new Error("Property `ArrayNode.nodes` is deprecated, use `ArrayNode.items` instead")};Object.defineProperty(this,"nodes",{get:n,set:n})}return s.prototype=new o,s.prototype.type="ArrayNode",s.prototype.isArrayNode=!0,s.prototype._compile=function(t,n){var r=e(this.items,function(e){return e._compile(t,n)});if("Array"!==t.config().matrix){var i=t.matrix;return function(t,n,o){return i(e(r,function(e){return e(t,n,o)}))}}return function(t,n,i){return e(r,function(e){return e(t,n,i)})}},s.prototype.forEach=function(e){for(var t=0;t<this.items.length;t++)e(this.items[t],"items["+t+"]",this)},s.prototype.map=function(e){for(var t=[],n=0;n<this.items.length;n++)t[n]=this._ifNode(e(this.items[n],"items["+n+"]",this));return new s(t)},s.prototype.clone=function(){return new s(this.items.slice(0))},s.prototype._toString=function(e){return"["+this.items.map(function(t){return t.toString(e)}).join(", ")+"]"},s.prototype.toJSON=function(){return{mathjs:"ArrayNode",items:this.items}},s.fromJSON=function(e){return new s(e.items)},s.prototype.toHTML=function(e){return'<span class="math-parenthesis math-square-parenthesis">[</span>'+this.items.map(function(t){return t.toHTML(e)}).join('<span class="math-separator">,</span>')+'<span class="math-parenthesis math-square-parenthesis">]</span>'},s.prototype._toTex=function(e){var t="\\begin{bmatrix}";return this.items.forEach(function(n){n.items?t+=n.items.map(function(t){return t.toTex(e)}).join("&"):t+=n.toTex(e),t+="\\\\"}),t+="\\end{bmatrix}"},s},fn}()),l=o(bn()),h=o(Tn()),f=o(Dn()),p=o(function(){if(Cn)return Bn;Cn=1;var e=Qt().format,t=Un().escape;return Bn.name="ConstantNode",Bn.path="expression.node",Bn.factory=function(n,r,i,o){var s=i(It()),a=i(vt());function u(e){if(!(this instanceof u))throw new SyntaxError("Constructor must be called with the new operator");if(2===arguments.length)throw new SyntaxError("new ConstantNode(valueStr, valueType) is not supported anymore since math v4.0.0. Use new ConstantNode(value) instead, where value is a non-stringified value.");this.value=e}return u.prototype=new s,u.prototype.type="ConstantNode",u.prototype.isConstantNode=!0,u.prototype._compile=function(e,t){var n=this.value;return function(){return n}},u.prototype.forEach=function(e){},u.prototype.map=function(e){return this.clone()},u.prototype.clone=function(){return new u(this.value)},u.prototype._toString=function(t){return e(this.value,t)},u.prototype.toHTML=function(e){var t=this._toString(e);switch(a(this.value)){case"number":case"BigNumber":case"Fraction":return'<span class="math-number">'+t+"</span>";case"string":return'<span class="math-string">'+t+"</span>";case"boolean":return'<span class="math-boolean">'+t+"</span>";case"null":return'<span class="math-null-symbol">'+t+"</span>";case"undefined":return'<span class="math-undefined">'+t+"</span>";default:return'<span class="math-symbol">'+t+"</span>"}},u.prototype.toJSON=function(){return{mathjs:"ConstantNode",value:this.value}},u.fromJSON=function(e){return new u(e.value)},u.prototype._toTex=function(e){var n=this._toString(e);switch(a(this.value)){case"string":return"\\mathtt{"+t(n)+"}";case"number":case"BigNumber":var r=n.toLowerCase().indexOf("e");return-1!==r?n.substring(0,r)+"\\cdot10^{"+n.substring(r+1)+"}":n;case"Fraction":return this.value.toLatex();default:return n}},u},Bn}()),d=o(function(){if(In)return jn;In=1;var e=Ut(),t=Qt().escape,n=tn().forEach,r=tn().join,i=Un(),o=xn(),s=Ot().setSafeProperty;return jn.name="FunctionAssignmentNode",jn.path="expression.node",jn.factory=function(a,u,c,l){var h=c(It());function f(t,n,r){if(!(this instanceof f))throw new SyntaxError("Constructor must be called with the new operator");if("string"!=typeof t)throw new TypeError('String expected for parameter "name"');if(!Array.isArray(n))throw new TypeError('Array containing strings or objects expected for parameter "params"');if(!a.isNode(r))throw new TypeError('Node expected for parameter "expr"');if(t in e)throw new Error('Illegal function name, "'+t+'" is a reserved keyword');this.name=t,this.params=n.map(function(e){return e&&e.name||e}),this.types=n.map(function(e){return e&&e.type||"any"}),this.expr=r}function p(e,t){var n=o.getPrecedence(e,t),r=o.getPrecedence(e.expr,t);return"all"===t||null!==r&&r<=n}return f.prototype=new h,f.prototype.type="FunctionAssignmentNode",f.prototype.isFunctionAssignmentNode=!0,f.prototype._compile=function(e,t){var i=Object.create(t);n(this.params,function(e){i[e]=!0});var o=this.expr._compile(e,i),a=this.name,u=this.params,c=r(this.types,","),h=a+"("+r(this.params,", ")+")";return function(e,t,n){var r={};r[c]=function(){for(var r=Object.create(t),i=0;i<u.length;i++)r[u[i]]=arguments[i];return o(e,r,n)};var i=l(a,r);return i.syntax=h,s(e,a,i),i}},f.prototype.forEach=function(e){e(this.expr,"expr",this)},f.prototype.map=function(e){var t=this._ifNode(e(this.expr,"expr",this));return new f(this.name,this.params.slice(0),t)},f.prototype.clone=function(){return new f(this.name,this.params.slice(0),this.expr)},f.prototype._toString=function(e){var t=e&&e.parenthesis?e.parenthesis:"keep",n=this.expr.toString(e);return p(this,t)&&(n="("+n+")"),this.name+"("+this.params.join(", ")+") = "+n},f.prototype.toJSON=function(){var e=this.types;return{mathjs:"FunctionAssignmentNode",name:this.name,params:this.params.map(function(t,n){return{name:t,type:e[n]}}),expr:this.expr}},f.fromJSON=function(e){return new f(e.name,e.params,e.expr)},f.prototype.toHTML=function(e){for(var n=e&&e.parenthesis?e.parenthesis:"keep",r=[],i=0;i<this.params.length;i++)r.push('<span class="math-symbol math-parameter">'+t(this.params[i])+"</span>");var o=this.expr.toHTML(e);return p(this,n)&&(o='<span class="math-parenthesis math-round-parenthesis">(</span>'+o+'<span class="math-parenthesis math-round-parenthesis">)</span>'),'<span class="math-function">'+t(this.name)+'</span><span class="math-parenthesis math-round-parenthesis">(</span>'+r.join('<span class="math-separator">,</span>')+'<span class="math-parenthesis math-round-parenthesis">)</span><span class="math-operator math-assignment-operator math-variable-assignment-operator math-binary-operator">=</span>'+o},f.prototype._toTex=function(e){var t=e&&e.parenthesis?e.parenthesis:"keep",n=this.expr.toTex(e);return p(this,t)&&(n="\\left(".concat(n,"\\right)")),"\\mathrm{"+this.name+"}\\left("+this.params.map(i.toSymbol).join(",")+"\\right):="+n},f},jn}()),m=o(zn()),v=o(function(){if(Hn)return Xn;function e(t){return(e="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(t)}Hn=1;var t=Qt().stringify,n=Qt().escape,r=Ot().isSafeProperty,i=Be().hasOwnProperty;return Xn.name="ObjectNode",Xn.path="expression.node",Xn.factory=function(o,s,a,u){var c=a(It());function l(t){if(!(this instanceof l))throw new SyntaxError("Constructor must be called with the new operator");if(this.properties=t||{},t&&("object"!==e(t)||!Object.keys(t).every(function(e){return o.isNode(t[e])})))throw new TypeError("Object containing Nodes expected")}return l.prototype=new c,l.prototype.type="ObjectNode",l.prototype.isObjectNode=!0,l.prototype._compile=function(e,n){var o={};for(var s in this.properties)if(i(this.properties,s)){var a=t(s),u=JSON.parse(a);if(!r(this.properties,u))throw new Error('No access to property "'+u+'"');o[u]=this.properties[s]._compile(e,n)}return function(e,t,n){var r={};for(var s in o)i(o,s)&&(r[s]=o[s](e,t,n));return r}},l.prototype.forEach=function(e){for(var n in this.properties)this.properties.hasOwnProperty(n)&&e(this.properties[n],"properties["+t(n)+"]",this)},l.prototype.map=function(e){var n={};for(var r in this.properties)this.properties.hasOwnProperty(r)&&(n[r]=this._ifNode(e(this.properties[r],"properties["+t(r)+"]",this)));return new l(n)},l.prototype.clone=function(){var e={};for(var t in this.properties)this.properties.hasOwnProperty(t)&&(e[t]=this.properties[t]);return new l(e)},l.prototype._toString=function(e){var n=[];for(var r in this.properties)this.properties.hasOwnProperty(r)&&n.push(t(r)+": "+this.properties[r].toString(e));return"{"+n.join(", ")+"}"},l.prototype.toJSON=function(){return{mathjs:"ObjectNode",properties:this.properties}},l.fromJSON=function(e){return new l(e.properties)},l.prototype.toHTML=function(e){var t=[];for(var r in this.properties)this.properties.hasOwnProperty(r)&&t.push('<span class="math-symbol math-property">'+n(r)+'</span><span class="math-operator math-assignment-operator math-property-assignment-operator math-binary-operator">:</span>'+this.properties[r].toHTML(e));return'<span class="math-parenthesis math-curly-parenthesis">{</span>'+t.join('<span class="math-separator">,</span>')+'<span class="math-parenthesis math-curly-parenthesis">}</span>'},l.prototype._toTex=function(e){var t=[];for(var n in this.properties)this.properties.hasOwnProperty(n)&&t.push("\\mathbf{"+n+":} & "+this.properties[n].toTex(e)+"\\\\");return"\\left\\{\\begin{array}{ll}".concat(t.join("\n"),"\\end{array}\\right\\}")},l},Xn}()),g=o(function(){if(Gn)return Wn;Gn=1;var e=Un(),t=tn().map,n=Qt().escape,r=Ot().isSafeMethod,i=Ot().getSafeProperty,o=xn();return Wn.name="OperatorNode",Wn.path="expression.node",Wn.factory=function(s,a,u,c){var l=u(It());function h(e,t,n,r){if(!(this instanceof h))throw new SyntaxError("Constructor must be called with the new operator");if("string"!=typeof e)throw new TypeError('string expected for parameter "op"');if("string"!=typeof t)throw new TypeError('string expected for parameter "fn"');if(!Array.isArray(n)||!n.every(s.isNode))throw new TypeError('Array containing Nodes expected for parameter "args"');this.implicit=!0===r,this.op=e,this.fn=t,this.args=n||[]}function f(e,t,n,r,i){var s,a=o.getPrecedence(e,t),u=o.getAssociativity(e,t);if("all"===t||r.length>2&&"OperatorNode:add"!==e.getIdentifier()&&"OperatorNode:multiply"!==e.getIdentifier())return r.map(function(e){switch(e.getContent().type){case"ArrayNode":case"ConstantNode":case"SymbolNode":case"ParenthesisNode":return!1;default:return!0}});switch(r.length){case 0:s=[];break;case 1:var c=o.getPrecedence(r[0],t);if(i&&null!==c){var l,h;if("keep"===t?(l=r[0].getIdentifier(),h=e.getIdentifier()):(l=r[0].getContent().getIdentifier(),h=e.getContent().getIdentifier()),!1===o.properties[a][h].latexLeftParens){s=[!1];break}if(!1===o.properties[c][l].latexParens){s=[!1];break}}if(null===c){s=[!1];break}if(c<=a){s=[!0];break}s=[!1];break;case 2:var f,p,d=o.getPrecedence(r[0],t),m=o.isAssociativeWith(e,r[0],t);f=null!==d&&(d===a&&"right"===u&&!m||d<a);var v,g,y,x=o.getPrecedence(r[1],t),b=o.isAssociativeWith(e,r[1],t);p=null!==x&&(x===a&&"left"===u&&!b||x<a),i&&("keep"===t?(v=e.getIdentifier(),g=e.args[0].getIdentifier(),y=e.args[1].getIdentifier()):(v=e.getContent().getIdentifier(),g=e.args[0].getContent().getIdentifier(),y=e.args[1].getContent().getIdentifier()),null!==d&&(!1===o.properties[a][v].latexLeftParens&&(f=!1),!1===o.properties[d][g].latexParens&&(f=!1)),null!==x&&(!1===o.properties[a][v].latexRightParens&&(p=!1),!1===o.properties[x][y].latexParens&&(p=!1))),s=[f,p];break;default:"OperatorNode:add"!==e.getIdentifier()&&"OperatorNode:multiply"!==e.getIdentifier()||(s=r.map(function(n){var r=o.getPrecedence(n,t),i=o.isAssociativeWith(e,n,t),s=o.getAssociativity(n,t);return null!==r&&(a===r&&u===s&&!i||r<a)}))}return r.length>=2&&"OperatorNode:multiply"===e.getIdentifier()&&e.implicit&&"auto"===t&&"hide"===n&&(s=r.map(function(e,t){var n="ParenthesisNode"===e.getIdentifier();return!(!s[t]&&!n)})),s}return h.prototype=new l,h.prototype.type="OperatorNode",h.prototype.isOperatorNode=!0,h.prototype._compile=function(e,n){if("string"!=typeof this.fn||!r(e,this.fn))throw e[this.fn]?new Error('No access to function "'+this.fn+'"'):new Error("Function "+this.fn+' missing in provided namespace "math"');var o=i(e,this.fn),s=t(this.args,function(t){return t._compile(e,n)});if(1===s.length){var a=s[0];return function(e,t,n){return o(a(e,t,n))}}if(2===s.length){var u=s[0],c=s[1];return function(e,t,n){return o(u(e,t,n),c(e,t,n))}}return function(e,n,r){return o.apply(null,t(s,function(t){return t(e,n,r)}))}},h.prototype.forEach=function(e){for(var t=0;t<this.args.length;t++)e(this.args[t],"args["+t+"]",this)},h.prototype.map=function(e){for(var t=[],n=0;n<this.args.length;n++)t[n]=this._ifNode(e(this.args[n],"args["+n+"]",this));return new h(this.op,this.fn,t,this.implicit)},h.prototype.clone=function(){return new h(this.op,this.fn,this.args.slice(0),this.implicit)},h.prototype.isUnary=function(){return 1===this.args.length},h.prototype.isBinary=function(){return 2===this.args.length},h.prototype._toString=function(e){var t=e&&e.parenthesis?e.parenthesis:"keep",n=e&&e.implicit?e.implicit:"hide",r=this.args,i=f(this,t,n,r,!1);if(1===r.length){var s=o.getAssociativity(this,t),a=r[0].toString(e);i[0]&&(a="("+a+")");var u=/[a-zA-Z]+/.test(this.op);return"right"===s?this.op+(u?" ":"")+a:"left"===s?a+(u?" ":"")+this.op:a+this.op}if(2===r.length){var c=r[0].toString(e),l=r[1].toString(e);return i[0]&&(c="("+c+")"),i[1]&&(l="("+l+")"),this.implicit&&"OperatorNode:multiply"===this.getIdentifier()&&"hide"===n?c+" "+l:c+" "+this.op+" "+l}if(r.length>2&&("OperatorNode:add"===this.getIdentifier()||"OperatorNode:multiply"===this.getIdentifier())){var h=r.map(function(t,n){return t=t.toString(e),i[n]&&(t="("+t+")"),t});return this.implicit&&"OperatorNode:multiply"===this.getIdentifier()&&"hide"===n?h.join(" "):h.join(" "+this.op+" ")}return this.fn+"("+this.args.join(", ")+")"},h.prototype.toJSON=function(){return{mathjs:"OperatorNode",op:this.op,fn:this.fn,args:this.args,implicit:this.implicit}},h.fromJSON=function(e){return new h(e.op,e.fn,e.args,e.implicit)},h.prototype.toHTML=function(e){var t=e&&e.parenthesis?e.parenthesis:"keep",r=e&&e.implicit?e.implicit:"hide",i=this.args,s=f(this,t,r,i,!1);if(1===i.length){var a=o.getAssociativity(this,t),u=i[0].toHTML(e);return s[0]&&(u='<span class="math-parenthesis math-round-parenthesis">(</span>'+u+'<span class="math-parenthesis math-round-parenthesis">)</span>'),"right"===a?'<span class="math-operator math-unary-operator math-lefthand-unary-operator">'+n(this.op)+"</span>"+u:u+'<span class="math-operator math-unary-operator math-righthand-unary-operator">'+n(this.op)+"</span>"}if(2===i.length){var c=i[0].toHTML(e),l=i[1].toHTML(e);return s[0]&&(c='<span class="math-parenthesis math-round-parenthesis">(</span>'+c+'<span class="math-parenthesis math-round-parenthesis">)</span>'),s[1]&&(l='<span class="math-parenthesis math-round-parenthesis">(</span>'+l+'<span class="math-parenthesis math-round-parenthesis">)</span>'),this.implicit&&"OperatorNode:multiply"===this.getIdentifier()&&"hide"===r?c+'<span class="math-operator math-binary-operator math-implicit-binary-operator"></span>'+l:c+'<span class="math-operator math-binary-operator math-explicit-binary-operator">'+n(this.op)+"</span>"+l}var h=i.map(function(t,n){return t=t.toHTML(e),s[n]&&(t='<span class="math-parenthesis math-round-parenthesis">(</span>'+t+'<span class="math-parenthesis math-round-parenthesis">)</span>'),t});return i.length>2&&("OperatorNode:add"===this.getIdentifier()||"OperatorNode:multiply"===this.getIdentifier())?this.implicit&&"OperatorNode:multiply"===this.getIdentifier()&&"hide"===r?h.join('<span class="math-operator math-binary-operator math-implicit-binary-operator"></span>'):h.join('<span class="math-operator math-binary-operator math-explicit-binary-operator">'+n(this.op)+"</span>"):'<span class="math-function">'+n(this.fn)+'</span><span class="math-paranthesis math-round-parenthesis">(</span>'+h.join('<span class="math-separator">,</span>')+'<span class="math-paranthesis math-round-parenthesis">)</span>'},h.prototype._toTex=function(t){var n=t&&t.parenthesis?t.parenthesis:"keep",r=t&&t.implicit?t.implicit:"hide",i=this.args,s=f(this,n,r,i,!0),a=e.operators[this.fn];if(a=void 0===a?this.op:a,1===i.length){var u=o.getAssociativity(this,n),c=i[0].toTex(t);return s[0]&&(c="\\left(".concat(c,"\\right)")),"right"===u?a+c:c+a}if(2===i.length){var l=i[0],h=l.toTex(t);s[0]&&(h="\\left(".concat(h,"\\right)"));var p,d=i[1].toTex(t);switch(s[1]&&(d="\\left(".concat(d,"\\right)")),p="keep"===n?l.getIdentifier():l.getContent().getIdentifier(),this.getIdentifier()){case"OperatorNode:divide":return a+"{"+h+"}{"+d+"}";case"OperatorNode:pow":switch(h="{"+h+"}",d="{"+d+"}",p){case"ConditionalNode":case"OperatorNode:divide":h="\\left(".concat(h,"\\right)")}break;case"OperatorNode:multiply":if(this.implicit&&"hide"===r)return h+"~"+d}return h+a+d}if(i.length>2&&("OperatorNode:add"===this.getIdentifier()||"OperatorNode:multiply"===this.getIdentifier())){var m=i.map(function(e,n){return e=e.toTex(t),s[n]&&(e="\\left(".concat(e,"\\right)")),e});return"OperatorNode:multiply"===this.getIdentifier()&&this.implicit?m.join("~"):m.join(a)}return"\\mathrm{"+this.fn+"}\\left("+i.map(function(e){return e.toTex(t)}).join(",")+"\\right)"},h.prototype.getIdentifier=function(){return this.type+":"+this.fn},h},Wn}()),y=o((Jn||(Jn=1,Yn.name="ParenthesisNode",Yn.path="expression.node",Yn.factory=function(e,t,n,r){var i=n(It());function o(t){if(!(this instanceof o))throw new SyntaxError("Constructor must be called with the new operator");if(!e.isNode(t))throw new TypeError('Node expected for parameter "content"');this.content=t}return o.prototype=new i,o.prototype.type="ParenthesisNode",o.prototype.isParenthesisNode=!0,o.prototype._compile=function(e,t){return this.content._compile(e,t)},o.prototype.getContent=function(){return this.content.getContent()},o.prototype.forEach=function(e){e(this.content,"content",this)},o.prototype.map=function(e){return new o(e(this.content,"content",this))},o.prototype.clone=function(){return new o(this.content)},o.prototype._toString=function(e){return!e||e&&!e.parenthesis||e&&"keep"===e.parenthesis?"("+this.content.toString(e)+")":this.content.toString(e)},o.prototype.toJSON=function(){return{mathjs:"ParenthesisNode",content:this.content}},o.fromJSON=function(e){return new o(e.content)},o.prototype.toHTML=function(e){return!e||e&&!e.parenthesis||e&&"keep"===e.parenthesis?'<span class="math-parenthesis math-round-parenthesis">(</span>'+this.content.toHTML(e)+'<span class="math-parenthesis math-round-parenthesis">)</span>':this.content.toHTML(e)},o.prototype._toTex=function(e){return!e||e&&!e.parenthesis||e&&"keep"===e.parenthesis?"\\left(".concat(this.content.toTex(e),"\\right)"):this.content.toTex(e)},o}),Yn)),x=o(function(){if(qn)return Zn;function e(t){return(e="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(t)}function t(){return t=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var r in n)Object.prototype.hasOwnProperty.call(n,r)&&(e[r]=n[r])}return e},t.apply(this,arguments)}qn=1;var n=Un(),r=Qt().escape,i=Be().hasOwnProperty,o=tn().map,s=Ot().validateSafeMethod,a=Ot().getSafeProperty;return Zn.name="FunctionNode",Zn.path="expression.node",Zn.math=!0,Zn.factory=function(u,c,l,h,f){var p=l(It()),d=l(Qn());function m(e,t){if(!(this instanceof m))throw new SyntaxError("Constructor must be called with the new operator");if("string"==typeof e&&(e=new d(e)),!u.isNode(e))throw new TypeError('Node expected as parameter "fn"');if(!Array.isArray(t)||!t.every(u.isNode))throw new TypeError('Array containing Nodes expected for parameter "args"');this.fn=e,this.args=t||[],Object.defineProperty(this,"name",{get:function(){return this.fn.name||""}.bind(this),set:function(){throw new Error("Cannot assign a new name, name is read-only")}});var n=function(){throw new Error("Property `FunctionNode.object` is deprecated, use `FunctionNode.fn` instead")};Object.defineProperty(this,"object",{get:n,set:n})}m.prototype=new p,m.prototype.type="FunctionNode",m.prototype.isFunctionNode=!0,m.prototype._compile=function(e,n){if(!(this instanceof m))throw new TypeError("No valid FunctionNode");var r=o(this.args,function(t){return t._compile(e,n)});if(u.isSymbolNode(this.fn)){var i=this.fn.name,c=i in e?a(e,i):void 0;if("function"==typeof c&&!0===c.rawArgs){var l=this.args;return function(n,r,o){return(i in n?a(n,i):c)(l,e,t({},n,r))}}if(1===r.length){var h=r[0];return function(e,t,n){return(i in e?a(e,i):c)(h(e,t,n))}}if(2===r.length){var f=r[0],p=r[1];return function(e,t,n){return(i in e?a(e,i):c)(f(e,t,n),p(e,t,n))}}return function(e,t,n){return(i in e?a(e,i):c).apply(null,o(r,function(r){return r(e,t,n)}))}}if(u.isAccessorNode(this.fn)&&u.isIndexNode(this.fn.index)&&this.fn.index.isObjectProperty()){var d=this.fn.object._compile(e,n),v=this.fn.index.getObjectProperty(),g=this.args;return function(n,i,a){var u=d(n,i,a);return s(u,v),u[v]&&u[v].rawArgs?u[v](g,e,t({},n,i)):u[v].apply(u,o(r,function(e){return e(n,i,a)}))}}var y=this.fn._compile(e,n),x=this.args;return function(n,i,s){var a=y(n,i,s);return a&&a.rawArgs?a(x,e,t({},n,i)):a.apply(a,o(r,function(e){return e(n,i,s)}))}},m.prototype.forEach=function(e){e(this.fn,"fn",this);for(var t=0;t<this.args.length;t++)e(this.args[t],"args["+t+"]",this)},m.prototype.map=function(e){for(var t=this._ifNode(e(this.fn,"fn",this)),n=[],r=0;r<this.args.length;r++)n[r]=this._ifNode(e(this.args[r],"args["+r+"]",this));return new m(t,n)},m.prototype.clone=function(){return new m(this.fn,this.args.slice(0))};var v=m.prototype.toString;function g(t,n,r){for(var i,o="",s=new RegExp("\\$(?:\\{([a-z_][a-z_0-9]*)(?:\\[([0-9]+)\\])?\\}|\\$)","ig"),a=0;null!==(i=s.exec(t));)if(o+=t.substring(a,i.index),a=i.index,"$$"===i[0])o+="$",a++;else{a+=i[0].length;var c=n[i[1]];if(!c)throw new ReferenceError("Template: Property "+i[1]+" does not exist.");if(void 0===i[2])switch(e(c)){case"string":o+=c;break;case"object":if(u.isNode(c))o+=c.toTex(r);else{if(!Array.isArray(c))throw new TypeError("Template: "+i[1]+" has to be a Node, String or array of Nodes");o+=c.map(function(e,t){if(u.isNode(e))return e.toTex(r);throw new TypeError("Template: "+i[1]+"["+t+"] is not a Node.")}).join(",")}break;default:throw new TypeError("Template: "+i[1]+" has to be a Node, String or array of Nodes")}else{if(!u.isNode(c[i[2]]&&c[i[2]]))throw new TypeError("Template: "+i[1]+"["+i[2]+"] is not a Node.");o+=c[i[2]].toTex(r)}}return o+t.slice(a)}m.prototype.toString=function(t){var n,r=this.fn.toString(t);return t&&"object"===e(t.handler)&&i(t.handler,r)&&(n=t.handler[r](this,t)),void 0!==n?n:v.call(this,t)},m.prototype._toString=function(e){var t=this.args.map(function(t){return t.toString(e)});return(u.isFunctionAssignmentNode(this.fn)?"("+this.fn.toString(e)+")":this.fn.toString(e))+"("+t.join(", ")+")"},m.prototype.toJSON=function(){return{mathjs:"FunctionNode",fn:this.fn,args:this.args}},m.fromJSON=function(e){return new m(e.fn,e.args)},m.prototype.toHTML=function(e){var t=this.args.map(function(t){return t.toHTML(e)});return'<span class="math-function">'+r(this.fn)+'</span><span class="math-paranthesis math-round-parenthesis">(</span>'+t.join('<span class="math-separator">,</span>')+'<span class="math-paranthesis math-round-parenthesis">)</span>'};var y=m.prototype.toTex;return m.prototype.toTex=function(t){var n;return t&&"object"===e(t.handler)&&i(t.handler,this.name)&&(n=t.handler[this.name](this,t)),void 0!==n?n:y.call(this,t)},m.prototype._toTex=function(t){var r,i,o=this.args.map(function(e){return e.toTex(t)});switch(!f[this.name]||"function"!=typeof f[this.name].toTex&&"object"!==e(f[this.name].toTex)&&"string"!=typeof f[this.name].toTex||(r=f[this.name].toTex),e(r)){case"function":i=r(this,t);break;case"string":i=g(r,this,t);break;case"object":switch(e(r[o.length])){case"function":i=r[o.length](this,t);break;case"string":i=g(r[o.length],this,t)}}return void 0!==i?i:g(n.defaultTemplate,this,t)},m.prototype.getIdentifier=function(){return this.type+":"+this.name},m},Zn}()),b=o(function(){if(er)return tr;er=1;var e=xn();return tr.name="RangeNode",tr.path="expression.node",tr.factory=function(t,n,r,i){var o=r(It());function s(e,n,r){if(!(this instanceof s))throw new SyntaxError("Constructor must be called with the new operator");if(!t.isNode(e))throw new TypeError("Node expected");if(!t.isNode(n))throw new TypeError("Node expected");if(r&&!t.isNode(r))throw new TypeError("Node expected");if(arguments.length>3)throw new Error("Too many arguments");this.start=e,this.end=n,this.step=r||null}function a(t,n){var r=e.getPrecedence(t,n),i={},o=e.getPrecedence(t.start,n);if(i.start=null!==o&&o<=r||"all"===n,t.step){var s=e.getPrecedence(t.step,n);i.step=null!==s&&s<=r||"all"===n}var a=e.getPrecedence(t.end,n);return i.end=null!==a&&a<=r||"all"===n,i}return s.prototype=new o,s.prototype.type="RangeNode",s.prototype.isRangeNode=!0,s.prototype.needsEnd=function(){return this.filter(function(e){return t.isSymbolNode(e)&&"end"===e.name}).length>0},s.prototype._compile=function(e,t){var n=e.range,r=this.start._compile(e,t),i=this.end._compile(e,t);if(this.step){var o=this.step._compile(e,t);return function(e,t,s){return n(r(e,t,s),i(e,t,s),o(e,t,s))}}return function(e,t,o){return n(r(e,t,o),i(e,t,o))}},s.prototype.forEach=function(e){e(this.start,"start",this),e(this.end,"end",this),this.step&&e(this.step,"step",this)},s.prototype.map=function(e){return new s(this._ifNode(e(this.start,"start",this)),this._ifNode(e(this.end,"end",this)),this.step&&this._ifNode(e(this.step,"step",this)))},s.prototype.clone=function(){return new s(this.start,this.end,this.step&&this.step)},s.prototype._toString=function(e){var t,n=a(this,e&&e.parenthesis?e.parenthesis:"keep"),r=this.start.toString(e);if(n.start&&(r="("+r+")"),t=r,this.step){var i=this.step.toString(e);n.step&&(i="("+i+")"),t+=":"+i}var o=this.end.toString(e);return n.end&&(o="("+o+")"),t+":"+o},s.prototype.toJSON=function(){return{mathjs:"RangeNode",start:this.start,end:this.end,step:this.step}},s.fromJSON=function(e){return new s(e.start,e.end,e.step)},s.prototype.toHTML=function(e){var t,n=a(this,e&&e.parenthesis?e.parenthesis:"keep"),r=this.start.toHTML(e);if(n.start&&(r='<span class="math-parenthesis math-round-parenthesis">(</span>'+r+'<span class="math-parenthesis math-round-parenthesis">)</span>'),t=r,this.step){var i=this.step.toHTML(e);n.step&&(i='<span class="math-parenthesis math-round-parenthesis">(</span>'+i+'<span class="math-parenthesis math-round-parenthesis">)</span>'),t+='<span class="math-operator math-range-operator">:</span>'+i}var o=this.end.toHTML(e);return n.end&&(o='<span class="math-parenthesis math-round-parenthesis">(</span>'+o+'<span class="math-parenthesis math-round-parenthesis">)</span>'),t+'<span class="math-operator math-range-operator">:</span>'+o},s.prototype._toTex=function(e){var t=a(this,e&&e.parenthesis?e.parenthesis:"keep"),n=this.start.toTex(e);if(t.start&&(n="\\left(".concat(n,"\\right)")),this.step){var r=this.step.toTex(e);t.step&&(r="\\left(".concat(r,"\\right)")),n+=":"+r}var i=this.end.toTex(e);return t.end&&(i="\\left(".concat(i,"\\right)")),n+":"+i},s},tr}()),E=o(function(){if(nr)return or;nr=1;var e=xn(),t=Un(),n=Qt().escape;return or.name="RelationalNode",or.path="expression.node",or.factory=function(r,i,o,s){var a=o(It()),u=Ot().getSafeProperty;function c(e,t){if(!(this instanceof c))throw new SyntaxError("Constructor must be called with the new operator");if(!Array.isArray(e))throw new TypeError("Parameter conditionals must be an array");if(!Array.isArray(t))throw new TypeError("Parameter params must be an array");if(e.length!==t.length-1)throw new TypeError("Parameter params must contain exactly one more element than parameter conditionals");this.conditionals=e,this.params=t}return c.prototype=new a,c.prototype.type="RelationalNode",c.prototype.isRelationalNode=!0,c.prototype._compile=function(e,t){var n=this,r=this.params.map(function(n){return n._compile(e,t)});return function(t,i,o){for(var s,a=r[0](t,i,o),c=0;c<n.conditionals.length;c++)if(s=a,a=r[c+1](t,i,o),!u(e,n.conditionals[c])(s,a))return!1;return!0}},c.prototype.forEach=function(e){var t=this;this.params.forEach(function(n,r){return e(n,"params["+r+"]",t)},this)},c.prototype.map=function(e){var t=this;return new c(this.conditionals.slice(),this.params.map(function(n,r){return t._ifNode(e(n,"params["+r+"]",t))},this))},c.prototype.clone=function(){return new c(this.conditionals,this.params)},c.prototype._toString=function(t){for(var n=t&&t.parenthesis?t.parenthesis:"keep",r=e.getPrecedence(this,n),i=this.params.map(function(i,o){var s=e.getPrecedence(i,n);return"all"===n||null!==s&&s<=r?"("+i.toString(t)+")":i.toString(t)}),o={equal:"==",unequal:"!=",smaller:"<",larger:">",smallerEq:"<=",largerEq:">="},s=i[0],a=0;a<this.conditionals.length;a++)s+=" "+o[this.conditionals[a]]+" "+i[a+1];return s},c.prototype.toJSON=function(){return{mathjs:"RelationalNode",conditionals:this.conditionals,params:this.params}},c.fromJSON=function(e){return new c(e.conditionals,e.params)},c.prototype.toHTML=function(t){for(var r=t&&t.parenthesis?t.parenthesis:"keep",i=e.getPrecedence(this,r),o=this.params.map(function(n,o){var s=e.getPrecedence(n,r);return"all"===r||null!==s&&s<=i?'<span class="math-parenthesis math-round-parenthesis">(</span>'+n.toHTML(t)+'<span class="math-parenthesis math-round-parenthesis">)</span>':n.toHTML(t)}),s={equal:"==",unequal:"!=",smaller:"<",larger:">",smallerEq:"<=",largerEq:">="},a=o[0],u=0;u<this.conditionals.length;u++)a+='<span class="math-operator math-binary-operator math-explicit-binary-operator">'+n(s[this.conditionals[u]])+"</span>"+o[u+1];return a},c.prototype._toTex=function(n){for(var r=n&&n.parenthesis?n.parenthesis:"keep",i=e.getPrecedence(this,r),o=this.params.map(function(t,o){var s=e.getPrecedence(t,r);return"all"===r||null!==s&&s<=i?"\\left("+t.toTex(n)+"\right)":t.toTex(n)}),s=o[0],a=0;a<this.conditionals.length;a++)s+=t.operators[this.conditionals[a]]+o[a+1];return s},c},or}()),w=o(Qn());function N(e,i){if(1!==arguments.length&&2!==arguments.length)throw new t("parse",arguments.length,1,2);var o=i&&i.nodes?i.nodes:{};if("string"==typeof e)return V(e,o);if(Array.isArray(e)||e instanceof r.Matrix)return n(e,function(e){if("string"!=typeof e)throw new TypeError("String expected");return V(e,o)});throw new TypeError("String or matrix expected")}var S={NULL:0,DELIMITER:1,NUMBER:2,SYMBOL:3,UNKNOWN:4},T={",":!0,"(":!0,")":!0,"[":!0,"]":!0,"{":!0,"}":!0,'"':!0,"'":!0,";":!0,"+":!0,"-":!0,"*":!0,".*":!0,"/":!0,"./":!0,"%":!0,"^":!0,".^":!0,"~":!0,"!":!0,"&":!0,"|":!0,"^|":!0,"=":!0,":":!0,"?":!0,"==":!0,"!=":!0,"<":!0,">":!0,"<=":!0,">=":!0,"<<":!0,">>":!0,">>>":!0},M={mod:!0,to:!0,in:!0,and:!0,xor:!0,or:!0,not:!0},A={true:!0,false:!1,null:null,undefined:void 0},D=["NaN","Infinity"];function _(e,t){return e.expression.substr(e.index,t)}function O(e){return _(e,1)}function P(e){e.index++}function C(e){return e.expression.charAt(e.index-1)}function B(e){return e.expression.charAt(e.index+1)}function R(e){for(e.tokenType=S.NULL,e.token="",e.comment="";N.isWhitespace(O(e),e.nestingLevel);)P(e);if("#"===O(e))for(;"\n"!==O(e)&&""!==O(e);)e.comment+=O(e),P(e);if(""!==O(e)){if("\n"===O(e)&&!e.nestingLevel)return e.tokenType=S.DELIMITER,e.token=O(e),void P(e);var t=O(e),n=_(e,2),r=_(e,3);if(3===r.length&&T[r])return e.tokenType=S.DELIMITER,e.token=r,P(e),P(e),void P(e);if(2===n.length&&T[n])return e.tokenType=S.DELIMITER,e.token=n,P(e),void P(e);if(T[t])return e.tokenType=S.DELIMITER,e.token=t,void P(e);if(N.isDigitDot(t)){if(e.tokenType=S.NUMBER,"."===O(e))e.token+=O(e),P(e),N.isDigit(O(e))||(e.tokenType=S.DELIMITER);else{for(;N.isDigit(O(e));)e.token+=O(e),P(e);N.isDecimalMark(O(e),B(e))&&(e.token+=O(e),P(e))}for(;N.isDigit(O(e));)e.token+=O(e),P(e);if("E"===O(e)||"e"===O(e))if(N.isDigit(B(e))||"-"===B(e)||"+"===B(e)){if(e.token+=O(e),P(e),"+"!==O(e)&&"-"!==O(e)||(e.token+=O(e),P(e)),!N.isDigit(O(e)))throw oe(e,'Digit expected, got "'+O(e)+'"');for(;N.isDigit(O(e));)e.token+=O(e),P(e);if(N.isDecimalMark(O(e),B(e)))throw oe(e,'Digit expected, got "'+O(e)+'"')}else if("."===B(e))throw P(e),oe(e,'Digit expected, got "'+O(e)+'"')}else{if(!N.isAlpha(O(e),C(e),B(e))){for(e.tokenType=S.UNKNOWN;""!==O(e);)e.token+=O(e),P(e);throw oe(e,'Syntax error in part "'+e.token+'"')}for(;N.isAlpha(O(e),C(e),B(e))||N.isDigit(O(e));)e.token+=O(e),P(e);M.hasOwnProperty(e.token)?e.tokenType=S.DELIMITER:e.tokenType=S.SYMBOL}}else e.tokenType=S.DELIMITER}function U(e){do{R(e)}while("\n"===e.token)}function I(e){e.nestingLevel++}function j(e){e.nestingLevel--}function V(t,n){var r={extraNodes:{},expression:"",comment:"",index:0,token:"",tokenType:S.NULL,nestingLevel:0,conditionalLevel:null};e(r,{expression:t,extraNodes:n}),R(r);var i=function(e){var t,n,r=[];""!==e.token&&"\n"!==e.token&&";"!==e.token&&((t=F(e)).comment=e.comment);for(;"\n"===e.token||";"===e.token;)0===r.length&&t&&(n=";"!==e.token,r.push({node:t,visible:n})),R(e),"\n"!==e.token&&";"!==e.token&&""!==e.token&&((t=F(e)).comment=e.comment,n=";"!==e.token,r.push({node:t,visible:n}));return r.length>0?new h(r):(t||((t=new p(void 0)).comment=e.comment),t)}(r);if(""!==r.token)throw r.tokenType===S.DELIMITER?se(r,"Unexpected operator "+r.token):oe(r,'Unexpected part "'+r.token+'"');return i}function F(e){var t,n,i,o,s=function(e){var t=function(e){var t=k(e);for(;"or"===e.token;)U(e),t=new g("or","or",[t,k(e)]);return t}(e);for(;"?"===e.token;){var n=e.conditionalLevel;e.conditionalLevel=e.nestingLevel,U(e);var r=t,i=F(e);if(":"!==e.token)throw oe(e,"False part of conditional expression expected");e.conditionalLevel=null,U(e);var o=F(e);t=new f(r,i,o),e.conditionalLevel=n}return t}(e);if("="===e.token){if(r.isSymbolNode(s))return t=s.name,U(e),i=F(e),new l(new w(t),i);if(r.isAccessorNode(s))return U(e),i=F(e),new l(s.object,s.index,i);if(r.isFunctionNode(s)&&r.isSymbolNode(s.fn)&&(o=!0,n=[],t=s.name,s.args.forEach(function(e,t){r.isSymbolNode(e)?n[t]=e.name:o=!1}),o))return U(e),i=F(e),new d(t,n,i);throw oe(e,"Invalid left hand side of assignment operator =")}return s}function k(e){for(var t=L(e);"xor"===e.token;)U(e),t=new g("xor","xor",[t,L(e)]);return t}function L(e){for(var t=z(e);"and"===e.token;)U(e),t=new g("and","and",[t,z(e)]);return t}function z(e){for(var t=H(e);"|"===e.token;)U(e),t=new g("|","bitOr",[t,H(e)]);return t}function H(e){for(var t=X(e);"^|"===e.token;)U(e),t=new g("^|","bitXor",[t,X(e)]);return t}function X(e){for(var t=G(e);"&"===e.token;)U(e),t=new g("&","bitAnd",[t,G(e)]);return t}function G(e){for(var t=[W(e)],n=[],r={"==":"equal","!=":"unequal","<":"smaller",">":"larger","<=":"smallerEq",">=":"largerEq"};r.hasOwnProperty(e.token);){var i={name:e.token,fn:r[e.token]};n.push(i),U(e),t.push(W(e))}return 1===t.length?t[0]:2===t.length?new g(n[0].name,n[0].fn,t):new E(n.map(function(e){return e.fn}),t)}function W(e){var t,n,r,i,o;for(t=J(e),n={"<<":"leftShift",">>":"rightArithShift",">>>":"rightLogShift"};n.hasOwnProperty(e.token);)i=n[r=e.token],U(e),o=[t,J(e)],t=new g(r,i,o);return t}function J(e){var t,n,r,i,o;for(t=Y(e),n={to:"to",in:"to"};n.hasOwnProperty(e.token);)i=n[r=e.token],U(e),"in"===r&&""===e.token?t=new g("*","multiply",[t,new w("in")],!0):(o=[t,Y(e)],t=new g(r,i,o));return t}function Y(e){var t,n=[];if(t=":"===e.token?new p(1):$(e),":"===e.token&&e.conditionalLevel!==e.nestingLevel){for(n.push(t);":"===e.token&&n.length<3;)U(e),")"===e.token||"]"===e.token||","===e.token||""===e.token?n.push(new w("end")):n.push($(e));t=3===n.length?new b(n[0],n[2],n[1]):new b(n[0],n[1])}return t}function $(e){var t,n,r,i,o;for(t=q(e),n={"+":"add","-":"subtract"};n.hasOwnProperty(e.token);)i=n[r=e.token],U(e),o=[t,q(e)],t=new g(r,i,o);return t}function q(e){var t,n,r,i,o;for(n=t=Z(e),r={"*":"multiply",".*":"dotMultiply","/":"divide","./":"dotDivide","%":"mod",mod:"mod"};r.hasOwnProperty(e.token);)o=r[i=e.token],U(e),n=Z(e),t=new g(i,o,[t,n]);return t}function Z(e){var t,n;for(n=t=K(e);e.tokenType===S.SYMBOL||"in"===e.token&&r.isConstantNode(t)||!(e.tokenType!==S.NUMBER||r.isConstantNode(n)||r.isOperatorNode(n)&&"!"!==n.op)||"("===e.token;)n=K(e),t=new g("*","multiply",[t,n],!0);return t}function K(t){for(var n=Q(t),i=n,o=[];"/"===t.token&&r.isConstantNode(i);){if(o.push(e({},t)),U(t),t.tokenType!==S.NUMBER){e(t,o.pop());break}if(o.push(e({},t)),U(t),t.tokenType!==S.SYMBOL&&"("!==t.token){o.pop(),e(t,o.pop());break}e(t,o.pop()),o.pop(),i=Q(t),n=new g("/","divide",[n,i])}return n}function Q(e){var t,n,r,o={"-":"unaryMinus","+":"unaryPlus","~":"bitNot",not:"not"};return o.hasOwnProperty(e.token)?(r=o[e.token],t=e.token,U(e),n=[Q(e)],new g(t,r,n)):function(e){var t,n,r,o;t=function(e){var t,n,r,o;t=function(e){var t=[];if(e.tokenType===S.SYMBOL&&e.extraNodes.hasOwnProperty(e.token)){var n=e.extraNodes[e.token];if(R(e),"("===e.token){if(t=[],I(e),R(e),")"!==e.token)for(t.push(F(e));","===e.token;)R(e),t.push(F(e));if(")"!==e.token)throw oe(e,"Parenthesis ) expected");j(e),R(e)}return new n(t)}return function(e){var t;if(e.tokenType===S.SYMBOL||e.tokenType===S.DELIMITER&&e.token in M)return t=e.token,R(e),ee(e,A.hasOwnProperty(t)?new p(A[t]):-1!==D.indexOf(t)?new p(a(t,"number")):new w(t));return function(e){var t;if('"'===e.token)return t=te(e),ee(e,new p(t));return function(e){var t;if("'"===e.token)return t=ne(e),ee(e,new p(t));return function(e){var t,n,r,o;if("["===e.token){if(I(e),R(e),"]"!==e.token){var s=re(e);if(";"===e.token){for(r=1,n=[s];";"===e.token;)R(e),n[r]=re(e),r++;if("]"!==e.token)throw oe(e,"End of matrix ] expected");j(e),R(e),o=n[0].items.length;for(var u=1;u<r;u++)if(n[u].items.length!==o)throw se(e,"Column dimensions mismatch ("+n[u].items.length+" !== "+o+")");t=new c(n)}else{if("]"!==e.token)throw oe(e,"End of matrix ] expected");j(e),R(e),t=s}}else j(e),R(e),t=new c([]);return ee(e,t)}return function(e){if("{"===e.token){var t;I(e);var n={};do{if(R(e),"}"!==e.token){if('"'===e.token)t=te(e);else if("'"===e.token)t=ne(e);else{if(e.tokenType!==S.SYMBOL)throw oe(e,"Symbol or string expected as object key");t=e.token,R(e)}if(":"!==e.token)throw oe(e,"Colon : expected after object key");R(e),n[t]=F(e)}}while(","===e.token);if("}"!==e.token)throw oe(e,"Comma , or bracket } expected after object value");j(e),R(e);var r=new v(n);return r=ee(e,r)}return function(e){var t;if(e.tokenType===S.NUMBER)return t=e.token,R(e),new p(a(t,i.number));return function(e){var t;if("("===e.token){if(I(e),R(e),t=F(e),")"!==e.token)throw oe(e,"Parenthesis ) expected");return j(e),R(e),t=ee(e,t=new y(t))}return function(e){throw""===e.token?oe(e,"Unexpected end of expression"):oe(e,"Value expected")}(e)}(e)}(e)}(e)}(e)}(e)}(e)}(e)}(e),n={"!":"factorial","'":"ctranspose"};for(;n.hasOwnProperty(e.token);)o=n[r=e.token],R(e),t=ee(e,t=new g(r,o,[t]));return t}(e),("^"===e.token||".^"===e.token)&&(r="^"===(n=e.token)?"pow":"dotPow",U(e),o=[t,Q(e)],t=new g(n,r,o));return t}(e)}function ee(e,t,n){for(var i;"("===e.token||"["===e.token||"."===e.token;)if(i=[],"("===e.token){if(!r.isSymbolNode(t)&&!r.isAccessorNode(t))return t;if(I(e),R(e),")"!==e.token)for(i.push(F(e));","===e.token;)R(e),i.push(F(e));if(")"!==e.token)throw oe(e,"Parenthesis ) expected");j(e),R(e),t=new x(t,i)}else if("["===e.token){if(I(e),R(e),"]"!==e.token)for(i.push(F(e));","===e.token;)R(e),i.push(F(e));if("]"!==e.token)throw oe(e,"Parenthesis ] expected");j(e),R(e),t=new u(t,new m(i))}else{if(R(e),e.tokenType!==S.SYMBOL)throw oe(e,"Property name expected after dot");i.push(new p(e.token)),R(e);t=new u(t,new m(i,!0))}return t}function te(e){for(var t="";""!==O(e)&&'"'!==O(e);)"\\"===O(e)&&(t+=O(e),P(e)),t+=O(e),P(e);if(R(e),'"'!==e.token)throw oe(e,'End of string " expected');return R(e),JSON.parse('"'+t+'"')}function ne(e){for(var t="";""!==O(e)&&"'"!==O(e);)"\\"===O(e)&&(t+=O(e),P(e)),t+=O(e),P(e);if(R(e),"'"!==e.token)throw oe(e,"End of string ' expected");return R(e),JSON.parse('"'+t+'"')}function re(e){for(var t=[F(e)],n=1;","===e.token;)R(e),t[n]=F(e),n++;return new c(t)}function ie(e){return e.index-e.token.length+1}function oe(e,t){var n=ie(e),r=new SyntaxError(t+" (char "+n+")");return r.char=n,r}function se(e,t){var n=ie(e),r=new SyntaxError(t+" (char "+n+")");return r.char=n,r}return N.isAlpha=function(e,t,n){return N.isValidLatinOrGreek(e)||N.isValidMathSymbol(e,n)||N.isValidMathSymbol(t,e)},N.isValidLatinOrGreek=function(e){return/^[a-zA-Z_$\u00C0-\u02AF\u0370-\u03FF\u2100-\u214F]$/.test(e)},N.isValidMathSymbol=function(e,t){return/^[\uD835]$/.test(e)&&/^[\uDC00-\uDFFF]$/.test(t)&&/^[^\uDC55\uDC9D\uDCA0\uDCA1\uDCA3\uDCA4\uDCA7\uDCA8\uDCAD\uDCBA\uDCBC\uDCC4\uDD06\uDD0B\uDD0C\uDD15\uDD1D\uDD3A\uDD3F\uDD45\uDD47-\uDD49\uDD51\uDEA6\uDEA7\uDFCC\uDFCD]$/.test(t)},N.isWhitespace=function(e,t){return" "===e||"\t"===e||"\n"===e&&t>0},N.isDecimalMark=function(e,t){return"."===e&&"/"!==t&&"*"!==t&&"^"!==t},N.isDigitDot=function(e){return e>="0"&&e<="9"||"."===e},N.isDigit=function(e){return e>="0"&&e<="9"},N},ht}var ar,ur={};var cr,lr={};var hr,fr,pr,dr={};var mr=function(){if(pr)return fr;pr=1;var e=(ot?it:(ot=1,it=at())).create();e.import((ir||(ir=1,lt.name="parse",lt.factory=function(e,t,n,r){var i=n(sr());return r("parse",{"string | Array | Matrix":i,"string | Array | Matrix, Object":i})}),lt)),e.import(function(){if(ar)return ur;ar=1;var e=ft();return ur.name="compile",ur.factory=function(t,n,r,i){var o=r(sr());return i("compile",{string:function(e){return o(e).compile()},"Array | Matrix":function(t){return e(t,function(e){return o(e).compile()})}})},ur}()),e.import(function(){if(cr)return lr;cr=1;var e=ft();return lr.name="eval",lr.factory=function(t,n,r,i){var o=r(sr());return i("compile",{string:function(e){return o(e).compile().eval({})},"string, Object":function(e,t){return o(e).compile().eval(t)},"Array | Matrix":function(t){var n={};return e(t,function(e){return o(e).compile().eval(n)})},"Array | Matrix, Object":function(t,n){return e(t,function(e){return o(e).compile().eval(n)})}})},lr}()),e.import(function(){if(hr)return dr;hr=1;var e=Qt();return dr.name="format",dr.factory=function(t,n,r,i){var o=i("format",{any:e.format,"any, Object | function | number":e.format});return o.toTex=void 0,o},dr}()),e.import({add:function(e,t){return e+t},subtract:function(e,t){return e-t},multiply:function(e,t){return e*t},divide:function(e,t){return e/t},mod:function(e,t){return e%t},unaryPlus:function(e){return e},unaryMinus:function(e){return-e},bitOr:function(e,t){return e|t},bitXor:function(e,t){return e^t},bitAnd:function(e,t){return e&t},bitNot:function(e){return~e},leftShift:function(e,t){return e<<t},rightArithShift:function(e,t){return e>>t},rightLogShift:function(e,t){return e>>>t},or:function(e,t){return!(!e&&!t)},xor:function(e,t){return!!e!=!!t},and:function(e,t){return!(!e||!t)},not:function(e){return!e},equal:function(e,t){return e==t},unequal:function(e,t){return e!=t},smaller:function(e,t){return e<t},larger:function(e,t){return e>t},smallerEq:function(e,t){return e<=t},largerEq:function(e,t){return e>=t},matrix:function(){throw new Error("Matrices not supported")},index:function(){throw new Error("Matrix indexes not supported")},pi:Math.PI,e:Math.E,true:!0,false:!1,null:null});var t={};return Object.getOwnPropertyNames(Math).forEach(function(e){Object.prototype.hasOwnProperty(e)||(t[e]=Math[e])}),e.import(t),fr=e}();const vr=E(mr),gr=function(e){this.gl=e,this.textureIndex=0};function yr(e,t,n){this.gl=e,this.vShader=this.createShader(t,this.gl.VERTEX_SHADER),this.fShader=this.createShader(n,this.gl.FRAGMENT_SHADER),this.program=this.createProgram(this.vShader,this.fShader),this.locations={}}function xr(e,t){null==e&&(e={}),this.contextState=t,this.float=e.float,this.gl=this.contextState.gl,this.texture=this.gl.createTexture(),this.gl.bindTexture(this.gl.TEXTURE_2D,this.texture),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_WRAP_S,this.gl.CLAMP_TO_EDGE),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_WRAP_T,this.gl.CLAMP_TO_EDGE),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_MIN_FILTER,this.gl.LINEAR),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_MAG_FILTER,this.gl.LINEAR),this.gl.pixelStorei(this.gl.UNPACK_FLIP_Y_WEBGL,!0),this.gl.bindTexture(this.gl.TEXTURE_2D,null)}function br(e,t){this.contextState=t,this.gl=this.contextState.gl,this.persistent=e.persistent,this.name=e.target,this.textures=[],this.textures.push(new xr(e,this.contextState)),this.textures.push(new xr(e,this.contextState)),this.flipFlop=!1,this.fbo=this.gl.createFramebuffer(),this.flipFlop=!1}var Er,wr,Nr,Sr,Tr,Mr,Ar,Dr,_r,Or,Pr,Cr;gr.prototype.newTextureIndex=function(){const e=this.textureIndex;return this.textureIndex+=1,e},gr.prototype.reset=function(){this.textureIndex=0},yr.prototype.use=function(){this.gl.useProgram(this.program)},yr.prototype.getUniformLocation=function(e){return this.gl.getUniformLocation(this.program,e)},yr.prototype.bindVertices=function(){this.use();const e=this.gl.getAttribLocation(this.program,"isf_position");this.buffer=this.gl.createBuffer(),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.buffer);const t=new Float32Array([-1,-1,1,-1,-1,1,-1,1,1,-1,1,1]);this.gl.bufferData(this.gl.ARRAY_BUFFER,t,this.gl.STATIC_DRAW),this.gl.enableVertexAttribArray(e),this.gl.vertexAttribPointer(e,2,this.gl.FLOAT,!1,0,0)},yr.prototype.cleanup=function(){this.gl.deleteShader(this.fShader),this.gl.deleteShader(this.vShader),this.gl.deleteProgram(this.program),this.gl.deleteBuffer(this.buffer)},yr.prototype.createShader=function(e,t){const n=this.gl.createShader(t);this.gl.shaderSource(n,e),this.gl.compileShader(n);if(!this.gl.getShaderParameter(n,this.gl.COMPILE_STATUS)){const e=this.gl.getShaderInfoLog(n);throw new Error({message:e,type:"shader"})}return n},yr.prototype.createProgram=function(e,t){const n=this.gl.createProgram();this.gl.attachShader(n,e),this.gl.attachShader(n,t),this.gl.linkProgram(n);if(!this.gl.getProgramParameter(n,this.gl.LINK_STATUS)){const e=this.gl.getProgramInfoLog(n);throw new Error({message:e,type:"program"})}return n},xr.prototype.bind=function(e){null==e&&(e=-1);const t=this.contextState.newTextureIndex();this.gl.activeTexture(this.gl.TEXTURE0+t),this.gl.bindTexture(this.gl.TEXTURE_2D,this.texture),-1!==e&&this.gl.uniform1i(e,t)},xr.prototype.setSize=function(e,t){if(this.width!==e||this.height!==t){this.width=e,this.height=t;const n=this.float?this.gl.FLOAT:this.gl.UNSIGNED_BYTE;this.gl.bindTexture(this.gl.TEXTURE_2D,this.texture),this.gl.texImage2D(this.gl.TEXTURE_2D,0,this.gl.RGBA,e,t,0,this.gl.RGBA,n,null)}},xr.prototype.destroy=function(){this.gl.deleteTexture(this.texture)},br.prototype.setSize=function(e,t){if(this.width!==e||this.height!==t){this.width=e,this.height=t;for(let n=0;n<this.textures.length;n++){this.textures[n].setSize(e,t)}}},br.prototype.readTexture=function(){return this.flipFlop?this.textures[1]:this.textures[0]},br.prototype.writeTexture=function(){return this.flipFlop?this.textures[0]:this.textures[1]},br.prototype.flip=function(){this.flipFlop=!this.flipFlop},br.prototype.destroy=function(){for(let e=0;e<this.textures.length;e++){this.textures[e].destroy()}this.gl.deleteFramebuffer(this.fbo)};const Br=E(wr?Er:(wr=1,Ar={'"':'"',"\\":"\\","/":"/",b:"\b",f:"\f",n:"\n",r:"\r",t:"\t"},Dr=function(e){throw{name:"SyntaxError",message:e,at:Nr,text:Tr}},_r=function(e){return e&&e!==Sr&&Dr("Expected '"+e+"' instead of '"+Sr+"'"),Sr=Tr.charAt(Nr),Nr+=1,Sr},Or=function(){var e,t="";for("-"===Sr&&(t="-",_r("-"));Sr>="0"&&Sr<="9";)t+=Sr,_r();if("."===Sr)for(t+=".";_r()&&Sr>="0"&&Sr<="9";)t+=Sr;if("e"===Sr||"E"===Sr)for(t+=Sr,_r(),"-"!==Sr&&"+"!==Sr||(t+=Sr,_r());Sr>="0"&&Sr<="9";)t+=Sr,_r();if(e=+t,isFinite(e))return e;Dr("Bad number")},Pr=function(){var e,t,n,r="";if('"'===Sr)for(;_r();){if('"'===Sr)return _r(),r;if("\\"===Sr)if(_r(),"u"===Sr){for(n=0,t=0;t<4&&(e=parseInt(_r(),16),isFinite(e));t+=1)n=16*n+e;r+=String.fromCharCode(n)}else{if("string"!=typeof Ar[Sr])break;r+=Ar[Sr]}else r+=Sr}Dr("Bad string")},Cr=function(){for(;Sr&&Sr<=" ";)_r()},Mr=function(){switch(Cr(),Sr){case"{":return function(){var e,t={};if("{"===Sr){if(_r("{"),Cr(),"}"===Sr)return _r("}"),t;for(;Sr;){if(e=Pr(),Cr(),_r(":"),Object.hasOwnProperty.call(t,e)&&Dr("Duplicate key '"+e+"'"),t[e]=Mr(),Cr(),"}"===Sr)return _r("}"),t;_r(","),Cr()}}Dr("Bad object")}();case"[":return function(){var e=[];if("["===Sr){if(_r("["),Cr(),"]"===Sr)return _r("]"),e;for(;Sr;){if(e.push(Mr()),Cr(),"]"===Sr)return _r("]"),e;_r(","),Cr()}}Dr("Bad array")}();case'"':return Pr();case"-":return Or();default:return Sr>="0"&&Sr<="9"?Or():function(){switch(Sr){case"t":return _r("t"),_r("r"),_r("u"),_r("e"),!0;case"f":return _r("f"),_r("a"),_r("l"),_r("s"),_r("e"),!1;case"n":return _r("n"),_r("u"),_r("l"),_r("l"),null}Dr("Unexpected '"+Sr+"'")}()}},Er=function(e,t){var n;return Tr=e,Nr=0,Sr=" ",n=Mr(),Cr(),Sr&&Dr("Syntax error"),"function"==typeof t?function e(n,r){var i,o,s=n[r];if(s&&"object"==typeof s)for(i in s)Object.prototype.hasOwnProperty.call(s,i)&&(void 0!==(o=e(s,i))?s[i]=o:delete s[i]);return t.call(n,r,s)}({"":n},""):n})),Rr="Something is wrong with your ISF metadata";const Ur={float:"float",image:"sampler2D",bool:"bool",event:"bool",long:"int",color:"vec4",point2D:"vec2"},Ir=function(){};function jr(e){const t=e.split("\n");for(let n=0;n<t.length;n++)if(-1!==t[n].indexOf("main()"))return n;return-1}Ir.prototype.parse=function(e,t){try{this.valid=!0,this.rawFragmentShader=e,this.rawVertexShader=t||Ir.vertexShaderDefault,this.error=null;const n=function(e){const t=/\*([^*]|[\r\n]|(\*+([^*/]|[\r\n])))*\*+/.exec(e);if(!t)throw new Error("There is no metadata here.");let n,r=t[0];r=r.substring(1,r.length-1);try{n=Br(r)}catch(i){const e=i.at,t=i.message||"Invalid JSON";if(e){const n=(r||"").substring(0,e).split(/\r\n|\r|\n/),i=n.length,o=n[i-1].length,s=new Error(`${Rr}: ${t}        at line ${i} and position ${o}`);throw s.lineNumber=i,s.position=o,s}throw new Error(`${Rr}: ${t}`)}return{objectValue:n,stringValue:r,startIndex:e.indexOf("/*"),endIndex:e.indexOf("*/")}}(this.rawFragmentShader),r=n.objectValue,i=n.stringValue;this.metadata=r,this.credit=r.CREDIT,this.categories=r.CATEGORIES,this.inputs=r.INPUTS,this.imports=r.IMPORTED||{},this.description=r.DESCRIPTION;const o=r.PASSES||[{}];this.passes=this.parsePasses(o);const s=this.rawFragmentShader.indexOf(i)+i.length+2;this.rawFragmentMain=this.rawFragmentShader.substring(s),this.generateShaders(),this.inferFilterType(),this.isfVersion=this.inferISFVersion()}catch(n){this.valid=!1,this.error=n,this.inputs=[],this.categories=[],this.credit="",this.errorLine=n.lineNumber}},Ir.prototype.parsePasses=function(e){const t=[];for(let n=0;n<e.length;++n){const r=e[n],i={};r.TARGET&&(i.target=r.TARGET),i.persistent=!!r.PERSISTENT,i.width=r.WIDTH||"$WIDTH",i.height=r.HEIGHT||"$HEIGHT",i.float=!!r.FLOAT,t.push(i)}return t},Ir.prototype.generateShaders=function(){this.uniformDefs="";for(let e=0;e<this.inputs.length;++e)this.addUniform(this.inputs[e]);for(let e=0;e<this.passes.length;++e)this.passes[e].target&&this.addUniform({NAME:this.passes[e].target,TYPE:"image"});for(const e in this.imports)({}).hasOwnProperty.call(this.imports,e)&&this.addUniform({NAME:e,TYPE:"image"});this.fragmentShader=this.buildFragmentShader(),this.vertexShader=this.buildVertexShader()},Ir.prototype.addUniform=function(e){const t=this.inputToType(e.TYPE);this.addUniformLine(`uniform ${t} ${e.NAME};`),"sampler2D"===t&&this.addUniformLine(this.samplerUniforms(e))},Ir.prototype.addUniformLine=function(e){this.uniformDefs+=`${e}\n`},Ir.prototype.samplerUniforms=function(e){const t=e.NAME;let n="";return n+=`uniform vec4 _${t}_imgRect;\n`,n+=`uniform vec2 _${t}_imgSize;\n`,n+=`uniform bool _${t}_flip;\n`,n+=`varying vec2 _${t}_normTexCoord;\n`,n+=`varying vec2 _${t}_texCoord;\n`,n+="\n",n},Ir.prototype.buildFragmentShader=function(){const e=this.replaceSpecialFunctions(this.rawFragmentMain);return Ir.fragmentShaderSkeleton.replace("[[uniforms]]",this.uniformDefs).replace("[[main]]",e)},Ir.prototype.replaceSpecialFunctions=function(e){let t;return t=/IMG_THIS_PIXEL\((.+?)\)/g,e=e.replace(t,(e,t)=>`texture2D(${t}, isf_FragNormCoord)`),t=/IMG_THIS_NORM_PIXEL\((.+?)\)/g,e=e.replace(t,(e,t)=>`texture2D(${t}, isf_FragNormCoord)`),t=/IMG_PIXEL\((.+?)\)/g,e=e.replace(t,(e,t)=>{const n=t.split(",");return`texture2D(${n[0]}, (${n[1]}) / RENDERSIZE)`}),t=/IMG_NORM_PIXEL\((.+?)\)/g,e=e.replace(t,(e,t)=>{const n=t.split(","),r=n[0];return`VVSAMPLER_2DBYNORM(${r}, _${r}_imgRect, _${r}_imgSize, _${r}_flip, ${n[1]})`}),t=/IMG_SIZE\((.+?)\)/g,e=e.replace(t,(e,t)=>`_${t}_imgSize`)},Ir.prototype.buildVertexShader=function(){let e="\n";for(let t=0;t<this.inputs.length;++t){const n=this.inputs[t];"image"===n.TYPE&&(e+=`${this.texCoordFunctions(n)}\n`)}return Ir.vertexShaderSkeleton.replace("[[functions]]",e).replace("[[uniforms]]",this.uniformDefs).replace("[[main]]",this.rawVertexShader)},Ir.prototype.texCoordFunctions=function(e){const t=e.NAME;return["_[[name]]_texCoord =","    vec2(((isf_fragCoord.x / _[[name]]_imgSize.x * _[[name]]_imgRect.z) + _[[name]]_imgRect.x), ","          (isf_fragCoord.y / _[[name]]_imgSize.y * _[[name]]_imgRect.w) + _[[name]]_imgRect.y);","","_[[name]]_normTexCoord =","  vec2((((isf_FragNormCoord.x * _[[name]]_imgSize.x) / _[[name]]_imgSize.x * _[[name]]_imgRect.z) + _[[name]]_imgRect.x),","          ((isf_FragNormCoord.y * _[[name]]_imgSize.y) / _[[name]]_imgSize.y * _[[name]]_imgRect.w) + _[[name]]_imgRect.y);"].join("\n").replace(/\[\[name\]\]/g,t)},Ir.prototype.inferFilterType=function(){function e(e,t){return e.filter(t).length>0}const t=e(this.inputs,e=>"image"===e.TYPE&&"inputImage"===e.NAME),n=e(this.inputs,e=>"image"===e.TYPE&&"startImage"===e.NAME)&&e(this.inputs,e=>"image"===e.TYPE&&"endImage"===e.NAME)&&e(this.inputs,e=>"float"===e.TYPE&&"progress"===e.NAME);this.type=t?"filter":n?"transition":"generator"},Ir.prototype.inferISFVersion=function(){let e=2;return(this.metadata.PERSISTENT_BUFFERS||-1!==this.rawFragmentShader.indexOf("vv_FragNormCoord")||-1!==this.rawVertexShader.indexOf("vv_vertShaderInit")||-1!==this.rawVertexShader.indexOf("vv_FragNormCoord"))&&(e=1),e},Ir.prototype.inputToType=function(e){const t=Ur[e];if(!t)throw new Error(`Unknown input type [${e}]`);return t},Ir.fragmentShaderSkeleton="\nprecision highp float;\nprecision highp int;\n\nuniform int PASSINDEX;\nuniform vec2 RENDERSIZE;\nvarying vec2 isf_FragNormCoord;\nvarying vec2 isf_FragCoord;\nuniform float TIME;\nuniform float TIMEDELTA;\nuniform int FRAMEINDEX;\nuniform vec4 DATE;\n\n[[uniforms]]\n\n// We don't need 2DRect functions since we control all inputs.  Don't need flip either, but leaving\n// for consistency sake.\nvec4 VVSAMPLER_2DBYPIXEL(sampler2D sampler, vec4 samplerImgRect, vec2 samplerImgSize, bool samplerFlip, vec2 loc) {\n  return (samplerFlip)\n    ? texture2D   (sampler,vec2(((loc.x/samplerImgSize.x*samplerImgRect.z)+samplerImgRect.x), (samplerImgRect.w-(loc.y/samplerImgSize.y*samplerImgRect.w)+samplerImgRect.y)))\n    : texture2D   (sampler,vec2(((loc.x/samplerImgSize.x*samplerImgRect.z)+samplerImgRect.x), ((loc.y/samplerImgSize.y*samplerImgRect.w)+samplerImgRect.y)));\n}\nvec4 VVSAMPLER_2DBYNORM(sampler2D sampler, vec4 samplerImgRect, vec2 samplerImgSize, bool samplerFlip, vec2 normLoc)  {\n  vec4    returnMe = VVSAMPLER_2DBYPIXEL(   sampler,samplerImgRect,samplerImgSize,samplerFlip,vec2(normLoc.x*samplerImgSize.x, normLoc.y*samplerImgSize.y));\n  return returnMe;\n}\n\n[[main]]\n\n",Ir.vertexShaderDefault="\nvoid main() {\n  isf_vertShaderInit();\n}\n",Ir.vertexShaderSkeleton="\nprecision highp float;\nprecision highp int;\nvoid isf_vertShaderInit();\n\nattribute vec2 isf_position; // -1..1\n\nuniform int     PASSINDEX;\nuniform vec2    RENDERSIZE;\nvarying vec2    isf_FragNormCoord; // 0..1\nvec2    isf_fragCoord; // Pixel Space\n\n[[uniforms]]\n\n[[main]]\nvoid isf_vertShaderInit(void)  {\ngl_Position = vec4( isf_position, 0.0, 1.0 );\n  isf_FragNormCoord = vec2((gl_Position.x+1.0)/2.0, (gl_Position.y+1.0)/2.0);\n  isf_fragCoord = floor(isf_FragNormCoord * RENDERSIZE);\n  [[functions]]\n}\n";const Vr=vr.eval;function Fr(e){this.gl=e,this.uniforms=[],this.contextState=new gr(this.gl),this.setupPaintToScreen(),this.startTime=Date.now(),this.lastRenderTime=Date.now(),this.frameIndex=0}Fr.prototype.loadSource=function(e,t){const n=new Ir;n.parse(e,t),this.sourceChanged(n.fragmentShader,n.vertexShader,n)},Fr.prototype.sourceChanged=function(e,t,n){if(this.fragmentShader=e,this.vertexShader=t,this.model=n,!this.model.valid)return this.valid=!1,this.error=this.model.error,void(this.errorLine=this.model.errorLine);try{this.valid=!0,this.error=null,this.errorLine=null,this.setupGL(),this.initUniforms();for(let e=0;e<n.inputs.length;e++){const t=n.inputs[e];void 0!==t.DEFAULT&&this.setValue(t.NAME,t.DEFAULT)}}catch(r){this.valid=!1,this.error=r,this.errorLine=function(e,t,n){const r=jr(t),i=jr(n),o=/ERROR: (\d+):(\d+): (.*)/g.exec(e.message)[2];return parseInt(o,10)+i-r}(r,this.fragmentShader,this.model.rawFragmentShader)}},Fr.prototype.initUniforms=function(){this.uniforms=this.findUniforms(this.fragmentShader);const e=this.model.inputs;for(let t=0;t<e.length;++t){const n=e[t],r=this.uniforms[n.NAME];r&&(r.value=this.model[n.NAME],"t"===r.type&&(r.texture=new xr({},this.contextState)))}this.pushTextures()},Fr.prototype.setValue=function(e,t){this.program.use();const n=this.uniforms[e];n&&(n.value=t,"t"===n.type&&(n.textureLoaded=!1),this.pushUniform(n))},Fr.prototype.setNormalizedValue=function(e,t){const n=this.model.inputs;let r=null;for(let i=0;i<n.length;i++){const t=n[i];if(t.NAME===e){r=t;break}}r&&void 0!==r.MIN&&void 0!==r.MAX&&this.setValue(e,r.MIN+(r.MAX-r.MIN)*t)},Fr.prototype.setupPaintToScreen=function(){return this.paintProgram=new yr(this.gl,this.basicVertexShader,this.basicFragmentShader),this.paintProgram.bindVertices()},Fr.prototype.setupGL=function(){this.cleanup(),this.program=new yr(this.gl,this.vertexShader,this.fragmentShader),this.program.bindVertices(),this.generatePersistentBuffers()},Fr.prototype.generatePersistentBuffers=function(){this.renderBuffers=[];const e=this.model.passes;for(let t=0;t<e.length;++t){const n=e[t],r=new br(n,this.contextState);n.buffer=r,this.renderBuffers.push(r)}},Fr.prototype.paintToScreen=function(e,t){this.paintProgram.use(),this.gl.bindFramebuffer(this.gl.FRAMEBUFFER,null),this.gl.viewport(0,0,e.width,e.height);const n=this.paintProgram.getUniformLocation("tex");t.readTexture().bind(n),this.gl.drawArrays(this.gl.TRIANGLES,0,6),this.program.use()},Fr.prototype.pushTextures=function(){Object.keys(this.uniforms).forEach(e=>{const t=this.uniforms[e];"t"===t.type&&this.pushTexture(t)})},Fr.prototype.pushTexture=function(e){if(!e.value)return;if("OffscreenCanvas"!==e.value.constructor.name&&"CANVAS"!==e.value.tagName&&!e.value.complete&&4!==e.value.readyState)return;const t=this.program.getUniformLocation(e.name);if(e.texture.bind(t),this.gl.texImage2D(this.gl.TEXTURE_2D,0,this.gl.RGBA,this.gl.RGBA,this.gl.UNSIGNED_BYTE,e.value),!e.textureLoaded){const t=e.value;e.textureLoaded=!0;const n=t.naturalWidth||t.width||t.videoWidth,r=t.naturalHeight||t.height||t.videoHeight;this.setValue(`_${e.name}_imgSize`,[n,r]),this.setValue(`_${e.name}_imgRect`,[0,0,1,1]),this.setValue(`_${e.name}_flip`,!1)}},Fr.prototype.pushUniforms=function(){for(const e of this.uniforms)this.pushUniform(e)},Fr.prototype.pushUniform=function(e){const t=this.program.getUniformLocation(e.name);if(-1!==t){if("t"===e.type)return void this.pushTexture(e);const n=e.value;switch(e.type){case"f":this.gl.uniform1f(t,n);break;case"v2":this.gl.uniform2f(t,n[0],n[1]);break;case"v3":this.gl.uniform3f(t,n[0],n[1],n[2]);break;case"v4":case"color":this.gl.uniform4f(t,n[0],n[1],n[2],n[3]);break;case"i":this.gl.uniform1i(t,n)}}},Fr.prototype.findUniforms=function(e){const t=e.split("\n"),n={},r=t.length;for(let i=0;i<r;++i){const e=t[i].trim();if(0===e.indexOf("uniform")){const t=e.split(" "),r=t[2].substring(0,t[2].length-1),i=this.typeToUniform(t[1]);i.name=r,n[r]=i}}return n},Fr.prototype.typeToUniform=function(e){switch(e){case"float":return{type:"f",value:0};case"vec2":return{type:"v2",value:[0,0]};case"vec3":return{type:"v3",value:[0,0,0]};case"vec4":case"color":return{type:"v4",value:[0,0,0,0]};case"bool":case"int":return{type:"i",value:0};case"point2D":return{type:"v2",value:[0,0],isPoint:!0};case"sampler2D":return{type:"t",value:{complete:!1,readyState:0},texture:null,textureUnit:null};default:throw new Error(`Unknown uniform type in ISFRenderer.typeToUniform: ${e}`)}},Fr.prototype.setDateUniforms=function(){const e=Date.now();this.setValue("TIME",(e-this.startTime)/1e3),this.setValue("TIMEDELTA",(e-this.lastRenderTime)/1e3),this.setValue("FRAMEINDEX",this.frameIndex++);const t=new Date;this.setValue("DATE",[t.getFullYear(),t.getMonth()+1,t.getDate(),3600*t.getHours()+60*t.getMinutes()+t.getSeconds()]),this.lastRenderTime=e},Fr.prototype.draw=function(e){this.contextState.reset(),this.program.use(),this.setDateUniforms();const t=this.renderBuffers;for(let i=0;i<t.length;++i){const e=t[i],n=e.readTexture(),r=this.program.getUniformLocation(e.name);n.bind(r),e.name&&(this.setValue(`_${e.name}_imgSize`,[e.width,e.height]),this.setValue(`_${e.name}_imgRect`,[0,0,1,1]),this.setValue(`_${e.name}_flip`,!1))}let n=null;const r=this.model.passes;for(let i=0;i<r.length;++i){const t=r[i];this.setValue("PASSINDEX",i);const o=t.buffer;if(t.target){const r=this.evaluateSize(e,t.width),i=this.evaluateSize(e,t.height);o.setSize(r,i);const s=o.writeTexture();this.gl.bindFramebuffer(this.gl.FRAMEBUFFER,o.fbo),this.gl.framebufferTexture2D(this.gl.FRAMEBUFFER,this.gl.COLOR_ATTACHMENT0,this.gl.TEXTURE_2D,s.texture,0),this.setValue("RENDERSIZE",[o.width,o.height]),n=o,this.gl.viewport(0,0,r,i)}else{const t=e.width,r=e.height;this.gl.bindTexture(this.gl.TEXTURE_2D,null),this.gl.bindFramebuffer(this.gl.FRAMEBUFFER,null),this.setValue("RENDERSIZE",[t,r]),n=null,this.gl.viewport(0,0,t,r)}this.gl.drawArrays(this.gl.TRIANGLES,0,6),this.gl.bindTexture(this.gl.TEXTURE_2D,null),this.gl.bindFramebuffer(this.gl.FRAMEBUFFER,null)}for(let i=0;i<t.length;++i)t[i].flip();n&&this.paintToScreen(e,n)},Fr.prototype.evaluateSize=function(e,t){let n=(t+="").replace("$WIDTH",e.offsetWidth||e.width).replace("$HEIGHT",e.offsetHeight||e.height);for(const r in this.uniforms)if({}.hasOwnProperty.call(this.uniforms,r)){const e=this.uniforms[r];n=n.replace(`$${r}`,e.value)}return Vr(n)},Fr.prototype.cleanup=function(){if(this.contextState.reset(),this.renderBuffers)for(let e=0;e<this.renderBuffers.length;++e)this.renderBuffers[e].destroy()},Fr.prototype.basicVertexShader="precision mediump float;\nprecision mediump int;\nattribute vec2 isf_position; // -1..1\nvarying vec2 texCoord;\n\nvoid main(void) {\n  // Since webgl doesn't support ftransform, we do this by hand.\n  gl_Position = vec4(isf_position, 0, 1);\n  texCoord = isf_position;\n}\n",Fr.prototype.basicFragmentShader="precision mediump float;\nuniform sampler2D tex;\nvarying vec2 texCoord;\nvoid main()\n{\n  gl_FragColor = texture2D(tex, texCoord * 0.5 + 0.5);\n  //gl_FragColor = vec4(texCoord.x);\n}";class kr{canvas;gl;renderer;_valid=!1;_error=null;_inputs=[];_inputNames=new Set;_metadata=null;constructor(e){this.canvas=e;const t=e.getContext("webgl2",{alpha:!0,premultipliedAlpha:!1})||e.getContext("webgl",{alpha:!0,premultipliedAlpha:!1});if(!t)throw new Error("WebGL not available");this.gl=t,this.renderer=new Fr(t)}get valid(){return this._valid}get error(){return this._error}get inputs(){return this._inputs}get metadata(){return this._metadata}loadSource(e,t){try{const n=new Ir;return n.parse(e,t),this._metadata=n.metadata||null,this._inputs=n.inputs||[],this._inputNames=new Set(this._inputs.map(e=>e.NAME)),this.renderer.loadSource(e,t),this._valid=this.renderer.valid,this._error=this.renderer.error?String(this.renderer.error):null,this._valid}catch(n){return this._valid=!1,this._error=String(n),!1}}loadPreset(e){return this.loadSource(e.fragmentShader,e.vertexShader)}setValue(e,t){if(this._valid&&this._inputNames.has(e))try{this.renderer.setValue(e,t)}catch{}}setAudioUniforms(e){this.setValue("audio_bass",e.audio_bass),this.setValue("audio_mid",e.audio_mid),this.setValue("audio_high",e.audio_high),this.setValue("audio_level",e.audio_level),this.setValue("audio_beat",e.audio_beat)}draw(){if(this._valid)try{this.renderer.draw(this.canvas)}catch{}}resize(e,t){this.canvas.width=e,this.canvas.height=t,this.gl.viewport(0,0,e,t)}dispose(){try{this.renderer.cleanup()}catch{}}}const Lr=[{name:"Plasma Tunnel",author:"DEViLBOX",category:"Tunnel",description:"Audio-reactive plasma tunnel with beat-synced zoom",fragmentShader:'/*{\n  "DESCRIPTION": "Audio-reactive plasma tunnel",\n  "CREDIT": "DEViLBOX",\n  "CATEGORIES": ["Generator", "Tunnel"],\n  "INPUTS": [\n    { "NAME": "speed", "TYPE": "float", "DEFAULT": 1.0, "MIN": 0.0, "MAX": 4.0 },\n    { "NAME": "zoom", "TYPE": "float", "DEFAULT": 1.0, "MIN": 0.1, "MAX": 3.0 },\n    { "NAME": "audio_bass", "TYPE": "float", "DEFAULT": 0.0, "MIN": 0.0, "MAX": 1.0 },\n    { "NAME": "audio_mid", "TYPE": "float", "DEFAULT": 0.0, "MIN": 0.0, "MAX": 1.0 },\n    { "NAME": "audio_high", "TYPE": "float", "DEFAULT": 0.0, "MIN": 0.0, "MAX": 1.0 },\n    { "NAME": "audio_beat", "TYPE": "float", "DEFAULT": 0.0, "MIN": 0.0, "MAX": 1.0 }\n  ]\n}*/\n\nvoid main() {\n  vec2 uv = (gl_FragCoord.xy - 0.5 * RENDERSIZE) / min(RENDERSIZE.x, RENDERSIZE.y);\n  float t = TIME * speed;\n  float z = zoom + audio_bass * 0.5 + audio_beat * 0.3;\n  \n  float angle = atan(uv.y, uv.x);\n  float radius = length(uv);\n  \n  float tunnel = 1.0 / (radius * z + 0.001);\n  float twist = angle / 3.14159 + tunnel * 0.5;\n  \n  float p1 = sin(twist * 6.0 + t * 2.0 + audio_mid * 3.0);\n  float p2 = cos(tunnel * 4.0 - t * 1.5 + audio_high * 2.0);\n  float p3 = sin(twist * 3.0 + tunnel * 2.0 + t);\n  \n  vec3 col = vec3(\n    0.5 + 0.5 * sin(p1 * 2.0 + audio_bass * 3.0),\n    0.5 + 0.5 * cos(p2 * 2.0 + 1.0),\n    0.5 + 0.5 * sin(p3 * 2.0 + 2.0 + audio_high * 2.0)\n  );\n  \n  col *= smoothstep(0.0, 0.3, radius);\n  col *= 1.0 + audio_beat * 0.5;\n  \n  gl_FragColor = vec4(col, 1.0);\n}'},{name:"Fractal Warp",author:"DEViLBOX",category:"Fractal",description:"Warping fractal pattern driven by audio energy",fragmentShader:'/*{\n  "DESCRIPTION": "Audio-reactive fractal warp",\n  "CREDIT": "DEViLBOX",\n  "CATEGORIES": ["Generator", "Fractal"],\n  "INPUTS": [\n    { "NAME": "iterations", "TYPE": "float", "DEFAULT": 6.0, "MIN": 2.0, "MAX": 12.0 },\n    { "NAME": "complexity", "TYPE": "float", "DEFAULT": 1.5, "MIN": 0.5, "MAX": 3.0 },\n    { "NAME": "audio_bass", "TYPE": "float", "DEFAULT": 0.0, "MIN": 0.0, "MAX": 1.0 },\n    { "NAME": "audio_mid", "TYPE": "float", "DEFAULT": 0.0, "MIN": 0.0, "MAX": 1.0 },\n    { "NAME": "audio_high", "TYPE": "float", "DEFAULT": 0.0, "MIN": 0.0, "MAX": 1.0 },\n    { "NAME": "audio_level", "TYPE": "float", "DEFAULT": 0.0, "MIN": 0.0, "MAX": 1.0 }\n  ]\n}*/\n\nvoid main() {\n  vec2 uv = (gl_FragCoord.xy - 0.5 * RENDERSIZE) / min(RENDERSIZE.x, RENDERSIZE.y);\n  float t = TIME * 0.3;\n  \n  vec2 z = uv * (complexity + audio_bass * 0.5);\n  float glow = 0.0;\n  \n  for (float i = 0.0; i < 12.0; i++) {\n    if (i >= iterations) break;\n    z = abs(z) / dot(z, z) - vec2(0.5 + 0.3 * sin(t + audio_mid), 0.5 + 0.3 * cos(t * 0.7));\n    glow += exp(-3.0 * length(z));\n  }\n  \n  glow /= iterations;\n  glow *= 1.0 + audio_level * 2.0;\n  \n  vec3 col = vec3(\n    glow * (1.5 + sin(t)),\n    glow * (1.5 + sin(t + 2.094)),\n    glow * (1.5 + sin(t + 4.189))\n  );\n  \n  gl_FragColor = vec4(col, 1.0);\n}'},{name:"Neon Grid",author:"DEViLBOX",category:"Retro",description:"Retro neon grid landscape with beat-synced pulse",fragmentShader:'/*{\n  "DESCRIPTION": "Retro neon grid with audio reactivity",\n  "CREDIT": "DEViLBOX",\n  "CATEGORIES": ["Generator", "Retro"],\n  "INPUTS": [\n    { "NAME": "grid_density", "TYPE": "float", "DEFAULT": 10.0, "MIN": 2.0, "MAX": 30.0 },\n    { "NAME": "horizon", "TYPE": "float", "DEFAULT": 0.3, "MIN": 0.1, "MAX": 0.6 },\n    { "NAME": "audio_bass", "TYPE": "float", "DEFAULT": 0.0, "MIN": 0.0, "MAX": 1.0 },\n    { "NAME": "audio_mid", "TYPE": "float", "DEFAULT": 0.0, "MIN": 0.0, "MAX": 1.0 },\n    { "NAME": "audio_beat", "TYPE": "float", "DEFAULT": 0.0, "MIN": 0.0, "MAX": 1.0 }\n  ]\n}*/\n\nvoid main() {\n  vec2 uv = gl_FragCoord.xy / RENDERSIZE;\n  float t = TIME;\n  \n  // Sky gradient\n  vec3 sky = mix(\n    vec3(0.0, 0.0, 0.1),\n    vec3(0.1, 0.0, 0.2 + audio_mid * 0.1),\n    uv.y\n  );\n  \n  if (uv.y < horizon) {\n    // Ground plane perspective\n    float d = horizon / (horizon - uv.y + 0.001);\n    float x = (uv.x - 0.5) * d;\n    float z = d + t * 2.0;\n    \n    // Grid lines\n    float gx = abs(fract(x * grid_density) - 0.5);\n    float gz = abs(fract(z * 0.5) - 0.5);\n    float grid = min(gx, gz);\n    float line = smoothstep(0.02, 0.0, grid);\n    \n    // Glow color with audio\n    vec3 glow = vec3(0.0, 0.8 + audio_bass * 0.2, 1.0) * line;\n    glow *= 1.0 / (d * 0.3 + 0.5); // distance fade\n    glow *= 1.0 + audio_beat * 1.5;\n    \n    gl_FragColor = vec4(sky + glow, 1.0);\n  } else {\n    // Sun\n    vec2 sunPos = vec2(0.5, horizon + 0.15);\n    float sunDist = length(uv - sunPos);\n    float sun = smoothstep(0.12, 0.0, sunDist);\n    vec3 sunColor = mix(vec3(1.0, 0.2, 0.5), vec3(1.0, 0.8, 0.2), sun);\n    \n    gl_FragColor = vec4(sky + sunColor * sun * (1.0 + audio_beat * 0.5), 1.0);\n  }\n}'},{name:"Kaleidoscope",author:"DEViLBOX",category:"Pattern",description:"Symmetrical kaleidoscope pattern modulated by audio",fragmentShader:'/*{\n  "DESCRIPTION": "Audio-reactive kaleidoscope",\n  "CREDIT": "DEViLBOX",\n  "CATEGORIES": ["Generator", "Pattern"],\n  "INPUTS": [\n    { "NAME": "segments", "TYPE": "float", "DEFAULT": 6.0, "MIN": 2.0, "MAX": 16.0 },\n    { "NAME": "rotation_speed", "TYPE": "float", "DEFAULT": 0.5, "MIN": 0.0, "MAX": 2.0 },\n    { "NAME": "audio_bass", "TYPE": "float", "DEFAULT": 0.0, "MIN": 0.0, "MAX": 1.0 },\n    { "NAME": "audio_mid", "TYPE": "float", "DEFAULT": 0.0, "MIN": 0.0, "MAX": 1.0 },\n    { "NAME": "audio_high", "TYPE": "float", "DEFAULT": 0.0, "MIN": 0.0, "MAX": 1.0 },\n    { "NAME": "audio_beat", "TYPE": "float", "DEFAULT": 0.0, "MIN": 0.0, "MAX": 1.0 }\n  ]\n}*/\n\nvoid main() {\n  vec2 uv = (gl_FragCoord.xy - 0.5 * RENDERSIZE) / min(RENDERSIZE.x, RENDERSIZE.y);\n  float t = TIME * rotation_speed;\n  \n  float angle = atan(uv.y, uv.x) + t;\n  float radius = length(uv);\n  \n  // Kaleidoscope fold\n  float seg = 3.14159 * 2.0 / segments;\n  angle = mod(angle, seg);\n  angle = abs(angle - seg * 0.5);\n  \n  vec2 p = vec2(cos(angle), sin(angle)) * radius;\n  \n  // Pattern\n  float pattern = 0.0;\n  pattern += sin(p.x * 10.0 + t * 3.0 + audio_bass * 5.0) * 0.5;\n  pattern += cos(p.y * 8.0 - t * 2.0 + audio_mid * 4.0) * 0.5;\n  pattern += sin((p.x + p.y) * 6.0 + t + audio_high * 3.0) * 0.3;\n  \n  vec3 col = vec3(\n    0.5 + 0.5 * sin(pattern * 3.0 + 0.0),\n    0.5 + 0.5 * sin(pattern * 3.0 + 2.094),\n    0.5 + 0.5 * sin(pattern * 3.0 + 4.189)\n  );\n  \n  col *= smoothstep(1.5, 0.0, radius);\n  col *= 1.0 + audio_beat * 0.8;\n  \n  gl_FragColor = vec4(col, 1.0);\n}'},{name:"Waveform Rings",author:"DEViLBOX",category:"Audio",description:"Concentric rings pulsing with audio frequencies",fragmentShader:'/*{\n  "DESCRIPTION": "Audio-reactive concentric rings",\n  "CREDIT": "DEViLBOX",\n  "CATEGORIES": ["Generator", "Audio"],\n  "INPUTS": [\n    { "NAME": "ring_count", "TYPE": "float", "DEFAULT": 8.0, "MIN": 2.0, "MAX": 20.0 },\n    { "NAME": "thickness", "TYPE": "float", "DEFAULT": 0.15, "MIN": 0.01, "MAX": 0.5 },\n    { "NAME": "audio_bass", "TYPE": "float", "DEFAULT": 0.0, "MIN": 0.0, "MAX": 1.0 },\n    { "NAME": "audio_mid", "TYPE": "float", "DEFAULT": 0.0, "MIN": 0.0, "MAX": 1.0 },\n    { "NAME": "audio_high", "TYPE": "float", "DEFAULT": 0.0, "MIN": 0.0, "MAX": 1.0 },\n    { "NAME": "audio_level", "TYPE": "float", "DEFAULT": 0.0, "MIN": 0.0, "MAX": 1.0 },\n    { "NAME": "audio_beat", "TYPE": "float", "DEFAULT": 0.0, "MIN": 0.0, "MAX": 1.0 }\n  ]\n}*/\n\nvoid main() {\n  vec2 uv = (gl_FragCoord.xy - 0.5 * RENDERSIZE) / min(RENDERSIZE.x, RENDERSIZE.y);\n  float t = TIME;\n  float radius = length(uv);\n  float angle = atan(uv.y, uv.x);\n  \n  vec3 col = vec3(0.0);\n  \n  for (float i = 0.0; i < 20.0; i++) {\n    if (i >= ring_count) break;\n    float r = (i + 1.0) / ring_count;\n    \n    // Modulate ring radius with audio\n    float audioMod = 0.0;\n    if (i < ring_count * 0.33) audioMod = audio_bass * 0.1;\n    else if (i < ring_count * 0.66) audioMod = audio_mid * 0.08;\n    else audioMod = audio_high * 0.06;\n    \n    float ringR = r * 0.8 + audioMod + sin(angle * 3.0 + t + i) * 0.02 * audio_level;\n    float ring = smoothstep(thickness, 0.0, abs(radius - ringR));\n    \n    float hue = i / ring_count + t * 0.1;\n    vec3 ringCol = vec3(\n      0.5 + 0.5 * sin(hue * 6.283),\n      0.5 + 0.5 * sin(hue * 6.283 + 2.094),\n      0.5 + 0.5 * sin(hue * 6.283 + 4.189)\n    );\n    \n    col += ringCol * ring * (0.5 + audio_beat * 0.5);\n  }\n  \n  gl_FragColor = vec4(col, 1.0);\n}'},{name:"Starfield Warp",author:"DEViLBOX",category:"Space",description:"Warping starfield with audio-driven speed",fragmentShader:'/*{\n  "DESCRIPTION": "Audio-reactive starfield warp",\n  "CREDIT": "DEViLBOX",\n  "CATEGORIES": ["Generator", "Space"],\n  "INPUTS": [\n    { "NAME": "star_speed", "TYPE": "float", "DEFAULT": 1.0, "MIN": 0.0, "MAX": 4.0 },\n    { "NAME": "star_density", "TYPE": "float", "DEFAULT": 0.5, "MIN": 0.1, "MAX": 1.0 },\n    { "NAME": "audio_bass", "TYPE": "float", "DEFAULT": 0.0, "MIN": 0.0, "MAX": 1.0 },\n    { "NAME": "audio_level", "TYPE": "float", "DEFAULT": 0.0, "MIN": 0.0, "MAX": 1.0 },\n    { "NAME": "audio_beat", "TYPE": "float", "DEFAULT": 0.0, "MIN": 0.0, "MAX": 1.0 }\n  ]\n}*/\n\nfloat hash(vec2 p) {\n  return fract(sin(dot(p, vec2(127.1, 311.7))) * 43758.5453);\n}\n\nvoid main() {\n  vec2 uv = (gl_FragCoord.xy - 0.5 * RENDERSIZE) / min(RENDERSIZE.x, RENDERSIZE.y);\n  float t = TIME * star_speed * (1.0 + audio_bass * 2.0);\n  \n  vec3 col = vec3(0.0);\n  \n  for (float layer = 0.0; layer < 4.0; layer++) {\n    float depth = 1.0 + layer * 0.5;\n    vec2 st = uv * depth + vec2(0.0, t / depth);\n    \n    vec2 cell = floor(st * 20.0);\n    vec2 f = fract(st * 20.0);\n    \n    float h = hash(cell + layer * 100.0);\n    \n    if (h > (1.0 - star_density)) {\n      vec2 starPos = vec2(hash(cell + 0.1), hash(cell + 0.2));\n      float d = length(f - starPos);\n      float brightness = smoothstep(0.1 / depth, 0.0, d);\n      brightness *= 0.5 + 0.5 * sin(t * 2.0 + h * 6.283);\n      brightness *= 1.0 + audio_beat * 1.0;\n      \n      float hue = h * 6.283 + t * 0.1;\n      vec3 starCol = mix(vec3(0.8, 0.9, 1.0), vec3(\n        0.5 + 0.5 * sin(hue),\n        0.5 + 0.5 * sin(hue + 2.094),\n        0.5 + 0.5 * sin(hue + 4.189)\n      ), audio_level);\n      \n      col += starCol * brightness;\n    }\n  }\n  \n  gl_FragColor = vec4(col, 1.0);\n}'},{name:"Liquid Metal",author:"DEViLBOX",category:"Organic",description:"Metallic liquid surface reacting to bass",fragmentShader:'/*{\n  "DESCRIPTION": "Liquid metal surface driven by audio",\n  "CREDIT": "DEViLBOX",\n  "CATEGORIES": ["Generator", "Organic"],\n  "INPUTS": [\n    { "NAME": "scale", "TYPE": "float", "DEFAULT": 3.0, "MIN": 1.0, "MAX": 8.0 },\n    { "NAME": "audio_bass", "TYPE": "float", "DEFAULT": 0.0, "MIN": 0.0, "MAX": 1.0 },\n    { "NAME": "audio_mid", "TYPE": "float", "DEFAULT": 0.0, "MIN": 0.0, "MAX": 1.0 },\n    { "NAME": "audio_high", "TYPE": "float", "DEFAULT": 0.0, "MIN": 0.0, "MAX": 1.0 },\n    { "NAME": "audio_beat", "TYPE": "float", "DEFAULT": 0.0, "MIN": 0.0, "MAX": 1.0 }\n  ]\n}*/\n\nvoid main() {\n  vec2 uv = (gl_FragCoord.xy - 0.5 * RENDERSIZE) / min(RENDERSIZE.x, RENDERSIZE.y);\n  float t = TIME * 0.5;\n  \n  vec2 p = uv * scale;\n  \n  float n = 0.0;\n  float amp = 1.0;\n  float freq = 1.0;\n  \n  for (int i = 0; i < 5; i++) {\n    float bass_mod = audio_bass * 0.3 * amp;\n    n += amp * sin(p.x * freq + t + bass_mod) * cos(p.y * freq * 0.7 - t * 0.8);\n    n += amp * 0.5 * sin(p.y * freq * 1.3 + t * 1.2 + audio_mid * 2.0);\n    amp *= 0.5;\n    freq *= 2.1;\n  }\n  \n  n = n * 0.5 + 0.5;\n  \n  // Metallic shading\n  float highlight = pow(n, 3.0 + audio_high * 2.0);\n  vec3 col = mix(\n    vec3(0.05, 0.05, 0.1),\n    vec3(0.7, 0.75, 0.8),\n    n\n  );\n  col += vec3(1.0, 0.95, 0.9) * highlight * 0.5;\n  col *= 1.0 + audio_beat * 0.6;\n  \n  // Color tint from audio\n  col += vec3(audio_bass * 0.1, 0.0, audio_high * 0.1);\n  \n  gl_FragColor = vec4(col, 1.0);\n}'},{name:"Electric Arcs",author:"DEViLBOX",category:"Energy",description:"Lightning-like electric arcs synced to beats",fragmentShader:'/*{\n  "DESCRIPTION": "Audio-reactive electric arcs",\n  "CREDIT": "DEViLBOX",\n  "CATEGORIES": ["Generator", "Energy"],\n  "INPUTS": [\n    { "NAME": "arc_count", "TYPE": "float", "DEFAULT": 5.0, "MIN": 1.0, "MAX": 10.0 },\n    { "NAME": "intensity", "TYPE": "float", "DEFAULT": 1.0, "MIN": 0.1, "MAX": 3.0 },\n    { "NAME": "audio_bass", "TYPE": "float", "DEFAULT": 0.0, "MIN": 0.0, "MAX": 1.0 },\n    { "NAME": "audio_mid", "TYPE": "float", "DEFAULT": 0.0, "MIN": 0.0, "MAX": 1.0 },\n    { "NAME": "audio_high", "TYPE": "float", "DEFAULT": 0.0, "MIN": 0.0, "MAX": 1.0 },\n    { "NAME": "audio_beat", "TYPE": "float", "DEFAULT": 0.0, "MIN": 0.0, "MAX": 1.0 }\n  ]\n}*/\n\nfloat hash1(float n) { return fract(sin(n) * 43758.5453); }\n\nvoid main() {\n  vec2 uv = (gl_FragCoord.xy - 0.5 * RENDERSIZE) / min(RENDERSIZE.x, RENDERSIZE.y);\n  float t = TIME;\n  \n  vec3 col = vec3(0.0);\n  \n  for (float i = 0.0; i < 10.0; i++) {\n    if (i >= arc_count) break;\n    \n    float angle = i / arc_count * 6.283 + t * 0.3;\n    vec2 dir = vec2(cos(angle), sin(angle));\n    \n    // Arc path with noise\n    float d = dot(uv, dir);\n    float perp = length(uv - dir * d);\n    \n    float noise = sin(d * 20.0 + t * 5.0 + i * 7.0) * 0.02 * (1.0 + audio_mid * 2.0);\n    noise += sin(d * 40.0 + t * 8.0) * 0.01 * audio_high;\n    \n    float arc = smoothstep(0.03 * intensity, 0.0, abs(perp + noise - 0.001));\n    arc *= smoothstep(0.0, 0.2, abs(d)) * smoothstep(0.8, 0.2, abs(d));\n    arc *= (0.3 + audio_bass * 0.7 + audio_beat * 0.5);\n    \n    vec3 arcCol = vec3(0.3, 0.5, 1.0) + vec3(0.5, 0.3, 0.0) * hash1(i);\n    col += arcCol * arc;\n  }\n  \n  // Center glow\n  float glow = 0.05 / (length(uv) + 0.1);\n  col += vec3(0.2, 0.4, 0.8) * glow * (0.3 + audio_beat * 0.7);\n  \n  gl_FragColor = vec4(col, 1.0);\n}'}],zr=s.forwardRef(({onReady:t,onPresetChange:n},r)=>{const i=o.useRef(null),a=o.useRef(null),u=o.useRef(null),c=o.useRef(0),l=o.useRef(0),[h,f]=o.useState(!1);o.useEffect(()=>{const e=i.current;if(e){try{const r=new kr(e);if(a.current=r,Lr.length>0){const e=Math.floor(Math.random()*Lr.length);r.loadPreset(Lr[e]),l.current=e}const i=new ge;i.enable(),u.current=i,f(!0),t?.(Lr.length),Lr.length>0&&n?.(l.current,Lr[l.current].name)}catch(r){}return()=>{a.current?.dispose(),u.current?.disable(),cancelAnimationFrame(c.current)}}},[]),o.useEffect(()=>{if(!h)return;const e=()=>{const t=a.current,n=u.current;if(t){if(n){n.update();const e=n.getFrame(),r={audio_bass:.5*e.subEnergy+.5*e.bassEnergy,audio_mid:e.midEnergy,audio_high:e.highEnergy,audio_level:e.rms,audio_beat:e.beat?1:0};t.setAudioUniforms(r)}t.draw()}c.current=requestAnimationFrame(e)};return c.current=requestAnimationFrame(e),()=>cancelAnimationFrame(c.current)},[h]),o.useEffect(()=>{const e=i.current;if(!e||!a.current)return;const t=()=>{const t=e.clientWidth*devicePixelRatio,n=e.clientHeight*devicePixelRatio;a.current?.resize(t,n)};t();const n=new ResizeObserver(t);return n.observe(e),()=>n.disconnect()},[h]);const p=o.useCallback(e=>{const t=Lr[e];t&&a.current&&(a.current.loadPreset(t),l.current=e,n?.(e,t.name))},[n]);return s.useImperativeHandle(r,()=>({nextPreset:()=>{0!==Lr.length&&p((l.current+1)%Lr.length)},prevPreset:()=>{0!==Lr.length&&p((l.current-1+Lr.length)%Lr.length)},randomPreset:()=>{0!==Lr.length&&p(Math.floor(Math.random()*Lr.length))},loadPresetByIndex:e=>p(e),loadPresetByName:e=>{const t=Lr.findIndex(t=>t.name===e);t>=0&&p(t)},getPresetNames:()=>Lr.map(e=>e.name),getCurrentIndex:()=>l.current}),[p]),e.jsxDEV("canvas",{ref:i,className:"w-full h-full block",style:{imageRendering:"auto"}},void 0,!1,{fileName:"/Users/spot/Code/DEViLBOX/src/components/vj/ISFCanvas.tsx",lineNumber:152,columnNumber:7},void 0)});zr.displayName="ISFCanvas";var Hr=.001,Xr=class{constructor(){this.startTime=performance.now(),this.previousTime=0,this.currentTime=0,this._delta=0,this._elapsed=0,this._fixedDelta=1e3/60,this.timescale=1,this.useFixedDelta=!1,this._autoReset=!1}get autoReset(){return this._autoReset}set autoReset(e){"undefined"!=typeof document&&void 0!==document.hidden&&(e?document.addEventListener("visibilitychange",this):document.removeEventListener("visibilitychange",this),this._autoReset=e)}get delta(){return this._delta*Hr}get fixedDelta(){return this._fixedDelta*Hr}set fixedDelta(e){this._fixedDelta=1e3*e}get elapsed(){return this._elapsed*Hr}update(e){this.useFixedDelta?this._delta=this.fixedDelta:(this.previousTime=this.currentTime,this.currentTime=(void 0!==e?e:performance.now())-this.startTime,this._delta=this.currentTime-this.previousTime),this._delta*=this.timescale,this._elapsed+=this._delta}reset(){this._delta=0,this._elapsed=0,this.currentTime=performance.now()-this.startTime}getDelta(){return this.delta}getElapsed(){return this.elapsed}handleEvent(e){document.hidden||(this.currentTime=performance.now()-this.startTime)}dispose(){this.autoReset=!1}},Gr=(()=>{const e=new Float32Array([-1,-1,0,3,-1,0,-1,3,0]),t=new Float32Array([0,0,2,0,0,2]),n=new Q;return n.setAttribute("position",new ee(e,3)),n.setAttribute("uv",new ee(t,2)),n})(),Wr=class e{static get fullscreenGeometry(){return Gr}constructor(e="Pass",t=new k,n=new L){this.name=e,this.renderer=null,this.scene=t,this.camera=n,this.screen=null,this.rtt=!0,this.needsSwap=!0,this.needsDepthTexture=!1,this.enabled=!0}get renderToScreen(){return!this.rtt}set renderToScreen(e){if(this.rtt===e){const t=this.fullscreenMaterial;null!==t&&(t.needsUpdate=!0),this.rtt=!e}}set mainScene(e){}set mainCamera(e){}setRenderer(e){this.renderer=e}isEnabled(){return this.enabled}setEnabled(e){this.enabled=e}get fullscreenMaterial(){return null!==this.screen?this.screen.material:null}set fullscreenMaterial(t){let n=this.screen;null!==n?n.material=t:(n=new z(e.fullscreenGeometry,t),n.frustumCulled=!1,null===this.scene&&(this.scene=new k),this.scene.add(n),this.screen=n)}getFullscreenMaterial(){return this.fullscreenMaterial}setFullscreenMaterial(e){this.fullscreenMaterial=e}getDepthTexture(){return null}setDepthTexture(e,t=U){}render(e,t,n,r,i){throw new Error("Render method not implemented!")}setSize(e,t){}initialize(e,t,n){}dispose(){for(const t of Object.keys(this)){const n=this[t];(n instanceof _||n instanceof Y||n instanceof $||n instanceof e)&&this[t].dispose()}null!==this.fullscreenMaterial&&this.fullscreenMaterial.dispose()}},Jr=class extends Wr{constructor(){super("ClearMaskPass",null,null),this.needsSwap=!1}render(e,t,n,r,i){const o=e.state.buffers.stencil;o.setLocked(!1),o.setTest(!1)}},Yr="varying vec2 vUv;void main(){vUv=position.xy*0.5+0.5;gl_Position=vec4(position.xy,1.0,1.0);}",$r=class extends G{constructor(){super({name:"CopyMaterial",defines:{COLOR_SPACE_CONVERSION:"1",DEPTH_PACKING:"0",COLOR_WRITE:"1"},uniforms:{inputBuffer:new F(null),depthBuffer:new F(null),channelWeights:new F(null),opacity:new F(1)},blending:J,toneMapped:!1,depthWrite:!1,depthTest:!1,fragmentShader:"#ifdef COLOR_WRITE\n#include <common>\n#include <dithering_pars_fragment>\n#ifdef FRAMEBUFFER_PRECISION_HIGH\nuniform mediump sampler2D inputBuffer;\n#else\nuniform lowp sampler2D inputBuffer;\n#endif\n#endif\n#ifdef DEPTH_WRITE\n#include <packing>\n#ifdef GL_FRAGMENT_PRECISION_HIGH\nuniform highp sampler2D depthBuffer;\n#else\nuniform mediump sampler2D depthBuffer;\n#endif\nfloat readDepth(const in vec2 uv){\n#if DEPTH_PACKING == 3201\nreturn unpackRGBAToDepth(texture2D(depthBuffer,uv));\n#else\nreturn texture2D(depthBuffer,uv).r;\n#endif\n}\n#endif\n#ifdef USE_WEIGHTS\nuniform vec4 channelWeights;\n#endif\nuniform float opacity;varying vec2 vUv;void main(){\n#ifdef COLOR_WRITE\nvec4 texel=texture2D(inputBuffer,vUv);\n#ifdef USE_WEIGHTS\ntexel*=channelWeights;\n#endif\ngl_FragColor=opacity*texel;\n#ifdef COLOR_SPACE_CONVERSION\n#include <colorspace_fragment>\n#endif\n#include <dithering_fragment>\n#else\ngl_FragColor=vec4(0.0);\n#endif\n#ifdef DEPTH_WRITE\ngl_FragDepth=readDepth(vUv);\n#endif\n}",vertexShader:Yr}),this.depthFunc=K}get inputBuffer(){return this.uniforms.inputBuffer.value}set inputBuffer(e){const t=null!==e;this.colorWrite!==t&&(t?this.defines.COLOR_WRITE=!0:delete this.defines.COLOR_WRITE,this.colorWrite=t,this.needsUpdate=!0),this.uniforms.inputBuffer.value=e}get depthBuffer(){return this.uniforms.depthBuffer.value}set depthBuffer(e){const t=null!==e;this.depthWrite!==t&&(t?this.defines.DEPTH_WRITE=!0:delete this.defines.DEPTH_WRITE,this.depthTest=t,this.depthWrite=t,this.needsUpdate=!0),this.uniforms.depthBuffer.value=e}set depthPacking(e){this.defines.DEPTH_PACKING=e.toFixed(0),this.needsUpdate=!0}get colorSpaceConversion(){return void 0!==this.defines.COLOR_SPACE_CONVERSION}set colorSpaceConversion(e){this.colorSpaceConversion!==e&&(e?this.defines.COLOR_SPACE_CONVERSION=!0:delete this.defines.COLOR_SPACE_CONVERSION,this.needsUpdate=!0)}get channelWeights(){return this.uniforms.channelWeights.value}set channelWeights(e){null!==e?(this.defines.USE_WEIGHTS="1",this.uniforms.channelWeights.value=e):delete this.defines.USE_WEIGHTS,this.needsUpdate=!0}setInputBuffer(e){this.uniforms.inputBuffer.value=e}getOpacity(e){return this.uniforms.opacity.value}setOpacity(e){this.uniforms.opacity.value=e}},qr=class extends Wr{constructor(e,t=!0){super("CopyPass"),this.fullscreenMaterial=new $r,this.needsSwap=!1,this.renderTarget=e,void 0===e&&(this.renderTarget=new _(1,1,{minFilter:O,magFilter:O,stencilBuffer:!1,depthBuffer:!1}),this.renderTarget.texture.name="CopyPass.Target"),this.autoResize=t}get resize(){return this.autoResize}set resize(e){this.autoResize=e}get texture(){return this.renderTarget.texture}getTexture(){return this.renderTarget.texture}setAutoResizeEnabled(e){this.autoResize=e}render(e,t,n,r,i){this.fullscreenMaterial.inputBuffer=t.texture,e.setRenderTarget(this.renderToScreen?null:this.renderTarget),e.render(this.scene,this.camera)}setSize(e,t){this.autoResize&&this.renderTarget.setSize(e,t)}initialize(e,t,n){void 0!==n&&(this.renderTarget.texture.type=n,n!==N?this.fullscreenMaterial.defines.FRAMEBUFFER_PRECISION_HIGH="1":null!==e&&e.outputColorSpace===S&&(this.renderTarget.texture.colorSpace=S))}},Zr=new C,Kr=class extends Wr{constructor(e=!0,t=!0,n=!1){super("ClearPass",null,null),this.needsSwap=!1,this.color=e,this.depth=t,this.stencil=n,this.overrideClearColor=null,this.overrideClearAlpha=-1}setClearFlags(e,t,n){this.color=e,this.depth=t,this.stencil=n}getOverrideClearColor(){return this.overrideClearColor}setOverrideClearColor(e){this.overrideClearColor=e}getOverrideClearAlpha(){return this.overrideClearAlpha}setOverrideClearAlpha(e){this.overrideClearAlpha=e}render(e,t,n,r,i){const o=this.overrideClearColor,s=this.overrideClearAlpha,a=e.getClearAlpha(),u=null!==o,c=s>=0;u?(e.getClearColor(Zr),e.setClearColor(o,c?s:a)):c&&e.setClearAlpha(s),e.setRenderTarget(this.renderToScreen?null:t),e.clear(this.color,this.depth,this.stencil),u?e.setClearColor(Zr,a):c&&e.setClearAlpha(a)}},Qr=class extends Wr{constructor(e,t){super("MaskPass",e,t),this.needsSwap=!1,this.clearPass=new Kr(!1,!1,!0),this.inverse=!1}set mainScene(e){this.scene=e}set mainCamera(e){this.camera=e}get inverted(){return this.inverse}set inverted(e){this.inverse=e}get clear(){return this.clearPass.enabled}set clear(e){this.clearPass.enabled=e}getClearPass(){return this.clearPass}isInverted(){return this.inverted}setInverted(e){this.inverted=e}render(e,t,n,r,i){const o=e.getContext(),s=e.state.buffers,a=this.scene,u=this.camera,c=this.clearPass,l=this.inverted?0:1,h=1-l;s.color.setMask(!1),s.depth.setMask(!1),s.color.setLocked(!0),s.depth.setLocked(!0),s.stencil.setTest(!0),s.stencil.setOp(o.REPLACE,o.REPLACE,o.REPLACE),s.stencil.setFunc(o.ALWAYS,l,4294967295),s.stencil.setClear(h),s.stencil.setLocked(!0),this.clearPass.enabled&&(this.renderToScreen?c.render(e,null):(c.render(e,t),c.render(e,n))),this.renderToScreen?(e.setRenderTarget(null),e.render(a,u)):(e.setRenderTarget(t),e.render(a,u),e.setRenderTarget(n),e.render(a,u)),s.color.setLocked(!1),s.depth.setLocked(!1),s.stencil.setLocked(!1),s.stencil.setFunc(o.EQUAL,1,4294967295),s.stencil.setOp(o.KEEP,o.KEEP,o.KEEP),s.stencil.setLocked(!0)}},ei=class{constructor(e=null,{depthBuffer:t=!0,stencilBuffer:n=!1,multisampling:r=0,frameBufferType:i}={}){this.renderer=null,this.inputBuffer=this.createBuffer(t,n,i,r),this.outputBuffer=this.inputBuffer.clone(),this.copyPass=new qr,this.depthTexture=null,this.passes=[],this.timer=new Xr,this.autoRenderToScreen=!0,this.setRenderer(e)}get multisampling(){return this.inputBuffer.samples||0}set multisampling(e){const t=this.inputBuffer,n=this.multisampling;n>0&&e>0?(this.inputBuffer.samples=e,this.outputBuffer.samples=e,this.inputBuffer.dispose(),this.outputBuffer.dispose()):n!==e&&(this.inputBuffer.dispose(),this.outputBuffer.dispose(),this.inputBuffer=this.createBuffer(t.depthBuffer,t.stencilBuffer,t.texture.type,e),this.inputBuffer.depthTexture=this.depthTexture,this.outputBuffer=this.inputBuffer.clone())}getTimer(){return this.timer}getRenderer(){return this.renderer}setRenderer(e){if(this.renderer=e,null!==e){const t=e.getSize(new w),n=e.getContext().getContextAttributes().alpha,r=this.inputBuffer.texture.type;r===N&&e.outputColorSpace===S&&(this.inputBuffer.texture.colorSpace=S,this.outputBuffer.texture.colorSpace=S,this.inputBuffer.dispose(),this.outputBuffer.dispose()),e.autoClear=!1,this.setSize(t.width,t.height);for(const i of this.passes)i.initialize(e,n,r)}}replaceRenderer(e,t=!0){const n=this.renderer,r=n.domElement.parentNode;return this.setRenderer(e),t&&null!==r&&(r.removeChild(n.domElement),r.appendChild(e.domElement)),n}createDepthTexture(){const e=this.depthTexture=new T;return this.inputBuffer.depthTexture=e,this.inputBuffer.dispose(),this.inputBuffer.stencilBuffer?(e.format=M,e.type=A):e.type=D,e}deleteDepthTexture(){if(null!==this.depthTexture){this.depthTexture.dispose(),this.depthTexture=null,this.inputBuffer.depthTexture=null,this.inputBuffer.dispose();for(const e of this.passes)e.setDepthTexture(null)}}createBuffer(e,t,n,r){const i=this.renderer,o=null===i?new w:i.getDrawingBufferSize(new w),s={minFilter:O,magFilter:O,stencilBuffer:t,depthBuffer:e,type:n},a=new _(o.width,o.height,s);return r>0&&(a.samples=r),n===N&&null!==i&&i.outputColorSpace===S&&(a.texture.colorSpace=S),a.texture.name="EffectComposer.Buffer",a.texture.generateMipmaps=!1,a}setMainScene(e){for(const t of this.passes)t.mainScene=e}setMainCamera(e){for(const t of this.passes)t.mainCamera=e}addPass(e,t){const n=this.passes,r=this.renderer,i=r.getDrawingBufferSize(new w),o=r.getContext().getContextAttributes().alpha,s=this.inputBuffer.texture.type;if(e.setRenderer(r),e.setSize(i.width,i.height),e.initialize(r,o,s),this.autoRenderToScreen&&(n.length>0&&(n[n.length-1].renderToScreen=!1),e.renderToScreen&&(this.autoRenderToScreen=!1)),void 0!==t?n.splice(t,0,e):n.push(e),this.autoRenderToScreen&&(n[n.length-1].renderToScreen=!0),e.needsDepthTexture||null!==this.depthTexture)if(null===this.depthTexture){const t=this.createDepthTexture();for(e of n)e.setDepthTexture(t)}else e.setDepthTexture(this.depthTexture)}removePass(e){const t=this.passes,n=t.indexOf(e);if(-1!==n&&t.splice(n,1).length>0){if(null!==this.depthTexture){const n=(e,t)=>e||t.needsDepthTexture;t.reduce(n,!1)||(e.getDepthTexture()===this.depthTexture&&e.setDepthTexture(null),this.deleteDepthTexture())}this.autoRenderToScreen&&n===t.length&&(e.renderToScreen=!1,t.length>0&&(t[t.length-1].renderToScreen=!0))}}removeAllPasses(){const e=this.passes;this.deleteDepthTexture(),e.length>0&&(this.autoRenderToScreen&&(e[e.length-1].renderToScreen=!1),this.passes=[])}render(e){const t=this.renderer,n=this.copyPass;let r,i,o,s=this.inputBuffer,a=this.outputBuffer,u=!1;void 0===e&&(this.timer.update(),e=this.timer.getDelta());for(const c of this.passes)c.enabled&&(c.render(t,s,a,e,u),c.needsSwap&&(u&&(n.renderToScreen=c.renderToScreen,r=t.getContext(),i=t.state.buffers.stencil,i.setFunc(r.NOTEQUAL,1,4294967295),n.render(t,s,a,e,u),i.setFunc(r.EQUAL,1,4294967295)),o=s,s=a,a=o),c instanceof Qr?u=!0:c instanceof Jr&&(u=!1))}setSize(e,t,n){const r=this.renderer,i=r.getSize(new w);void 0!==e&&void 0!==t||(e=i.width,t=i.height),i.width===e&&i.height===t||r.setSize(e,t,n);const o=r.getDrawingBufferSize(new w);this.inputBuffer.setSize(o.width,o.height),this.outputBuffer.setSize(o.width,o.height);for(const s of this.passes)s.setSize(o.width,o.height)}reset(){this.dispose(),this.autoRenderToScreen=!0}dispose(){for(const e of this.passes)e.dispose();this.passes=[],null!==this.inputBuffer&&this.inputBuffer.dispose(),null!==this.outputBuffer&&this.outputBuffer.dispose(),this.deleteDepthTexture(),this.copyPass.dispose(),this.timer.dispose(),Wr.fullscreenGeometry.dispose()}},ti=0,ni=1,ri=2,ii={FRAGMENT_HEAD:"FRAGMENT_HEAD",FRAGMENT_MAIN_UV:"FRAGMENT_MAIN_UV",FRAGMENT_MAIN_IMAGE:"FRAGMENT_MAIN_IMAGE",VERTEX_HEAD:"VERTEX_HEAD",VERTEX_MAIN_SUPPORT:"VERTEX_MAIN_SUPPORT"},oi=class{constructor(){this.shaderParts=new Map([[ii.FRAGMENT_HEAD,null],[ii.FRAGMENT_MAIN_UV,null],[ii.FRAGMENT_MAIN_IMAGE,null],[ii.VERTEX_HEAD,null],[ii.VERTEX_MAIN_SUPPORT,null]]),this.defines=new Map,this.uniforms=new Map,this.blendModes=new Map,this.extensions=new Set,this.attributes=ti,this.varyings=new Set,this.uvTransformation=!1,this.readDepth=!1,this.colorSpace=j}},si=!1,ai=class{constructor(e=null){this.originalMaterials=new Map,this.material=null,this.materials=null,this.materialsBackSide=null,this.materialsDoubleSide=null,this.materialsFlatShaded=null,this.materialsFlatShadedBackSide=null,this.materialsFlatShadedDoubleSide=null,this.setMaterial(e),this.meshCount=0,this.replaceMaterial=e=>{if(e.isMesh){let t;if(e.material.flatShading)switch(e.material.side){case X:t=this.materialsFlatShadedDoubleSide;break;case H:t=this.materialsFlatShadedBackSide;break;default:t=this.materialsFlatShaded}else switch(e.material.side){case X:t=this.materialsDoubleSide;break;case H:t=this.materialsBackSide;break;default:t=this.materials}this.originalMaterials.set(e,e.material),e.isSkinnedMesh?e.material=t[2]:e.isInstancedMesh?e.material=t[1]:e.material=t[0],++this.meshCount}}}cloneMaterial(e){if(!(e instanceof G))return e.clone();const t=e.uniforms,n=new Map;for(const i in t){const e=t[i].value;e.isRenderTargetTexture&&(t[i].value=null,n.set(i,e))}const r=e.clone();for(const i of n)t[i[0]].value=i[1],r.uniforms[i[0]].value=i[1];return r}setMaterial(e){if(this.disposeMaterials(),this.material=e,null!==e){const t=this.materials=[this.cloneMaterial(e),this.cloneMaterial(e),this.cloneMaterial(e)];for(const n of t)n.uniforms=Object.assign({},e.uniforms),n.side=W;t[2].skinning=!0,this.materialsBackSide=t.map(t=>{const n=this.cloneMaterial(t);return n.uniforms=Object.assign({},e.uniforms),n.side=H,n}),this.materialsDoubleSide=t.map(t=>{const n=this.cloneMaterial(t);return n.uniforms=Object.assign({},e.uniforms),n.side=X,n}),this.materialsFlatShaded=t.map(t=>{const n=this.cloneMaterial(t);return n.uniforms=Object.assign({},e.uniforms),n.flatShading=!0,n}),this.materialsFlatShadedBackSide=t.map(t=>{const n=this.cloneMaterial(t);return n.uniforms=Object.assign({},e.uniforms),n.flatShading=!0,n.side=H,n}),this.materialsFlatShadedDoubleSide=t.map(t=>{const n=this.cloneMaterial(t);return n.uniforms=Object.assign({},e.uniforms),n.flatShading=!0,n.side=X,n})}}render(e,t,n){const r=e.shadowMap.enabled;if(e.shadowMap.enabled=!1,si){const r=this.originalMaterials;this.meshCount=0,t.traverse(this.replaceMaterial),e.render(t,n);for(const e of r)e[0].material=e[1];this.meshCount!==r.size&&r.clear()}else{const r=t.overrideMaterial;t.overrideMaterial=this.material,e.render(t,n),t.overrideMaterial=r}e.shadowMap.enabled=r}disposeMaterials(){if(null!==this.material){const e=this.materials.concat(this.materialsBackSide).concat(this.materialsDoubleSide).concat(this.materialsFlatShaded).concat(this.materialsFlatShadedBackSide).concat(this.materialsFlatShadedDoubleSide);for(const t of e)t.dispose()}}dispose(){this.originalMaterials.clear(),this.disposeMaterials()}static get workaroundEnabled(){return si}static set workaroundEnabled(e){si=e}},ui=-1,ci=class extends I{constructor(e,t=-1,n=-1,r=1){super(),this.resizable=e,this.baseSize=new w(1,1),this.preferredSize=new w(t,n),this.target=this.preferredSize,this.s=r,this.effectiveSize=new w,this.addEventListener("change",()=>this.updateEffectiveSize()),this.updateEffectiveSize()}updateEffectiveSize(){const e=this.baseSize,t=this.preferredSize,n=this.effectiveSize,r=this.scale;t.width!==ui?n.width=t.width:t.height!==ui?n.width=Math.round(t.height*(e.width/Math.max(e.height,1))):n.width=Math.round(e.width*r),t.height!==ui?n.height=t.height:t.width!==ui?n.height=Math.round(t.width/Math.max(e.width/Math.max(e.height,1),1)):n.height=Math.round(e.height*r)}get width(){return this.effectiveSize.width}set width(e){this.preferredWidth=e}get height(){return this.effectiveSize.height}set height(e){this.preferredHeight=e}getWidth(){return this.width}getHeight(){return this.height}get scale(){return this.s}set scale(e){this.s!==e&&(this.s=e,this.preferredSize.setScalar(ui),this.dispatchEvent({type:"change"}),this.resizable.setSize(this.baseSize.width,this.baseSize.height))}getScale(){return this.scale}setScale(e){this.scale=e}get baseWidth(){return this.baseSize.width}set baseWidth(e){this.baseSize.width!==e&&(this.baseSize.width=e,this.dispatchEvent({type:"change"}),this.resizable.setSize(this.baseSize.width,this.baseSize.height))}getBaseWidth(){return this.baseWidth}setBaseWidth(e){this.baseWidth=e}get baseHeight(){return this.baseSize.height}set baseHeight(e){this.baseSize.height!==e&&(this.baseSize.height=e,this.dispatchEvent({type:"change"}),this.resizable.setSize(this.baseSize.width,this.baseSize.height))}getBaseHeight(){return this.baseHeight}setBaseHeight(e){this.baseHeight=e}setBaseSize(e,t){this.baseSize.width===e&&this.baseSize.height===t||(this.baseSize.set(e,t),this.dispatchEvent({type:"change"}),this.resizable.setSize(this.baseSize.width,this.baseSize.height))}get preferredWidth(){return this.preferredSize.width}set preferredWidth(e){this.preferredSize.width!==e&&(this.preferredSize.width=e,this.dispatchEvent({type:"change"}),this.resizable.setSize(this.baseSize.width,this.baseSize.height))}getPreferredWidth(){return this.preferredWidth}setPreferredWidth(e){this.preferredWidth=e}get preferredHeight(){return this.preferredSize.height}set preferredHeight(e){this.preferredSize.height!==e&&(this.preferredSize.height=e,this.dispatchEvent({type:"change"}),this.resizable.setSize(this.baseSize.width,this.baseSize.height))}getPreferredHeight(){return this.preferredHeight}setPreferredHeight(e){this.preferredHeight=e}setPreferredSize(e,t){this.preferredSize.width===e&&this.preferredSize.height===t||(this.preferredSize.set(e,t),this.dispatchEvent({type:"change"}),this.resizable.setSize(this.baseSize.width,this.baseSize.height))}copy(e){this.s=e.scale,this.baseSize.set(e.baseWidth,e.baseHeight),this.preferredSize.set(e.preferredWidth,e.preferredHeight),this.dispatchEvent({type:"change"}),this.resizable.setSize(this.baseSize.width,this.baseSize.height)}static get AUTO_SIZE(){return ui}},li=9,hi=23,fi=28,pi=new Map([[0,"vec4 blend(const in vec4 dst,const in vec4 src,const in float opacity){vec3 c=dst.rgb+src.rgb;return mix(dst,vec4(c,max(dst.a,src.a)),opacity);}"],[1,"vec4 blend(const in vec4 dst,const in vec4 src,const in float opacity){return mix(dst,src,src.a*opacity);}"],[2,"vec4 blend(const in vec4 dst,const in vec4 src,const in float opacity){vec3 c=(dst.rgb+src.rgb)*0.5;return mix(dst,vec4(c,max(dst.a,src.a)),opacity);}"],[3,"vec4 blend(const in vec4 dst,const in vec4 src,const in float opacity){vec3 a=RGBToHSL(dst.rgb);vec3 b=RGBToHSL(src.rgb);vec3 c=HSLToRGB(vec3(b.xy,a.z));return mix(dst,vec4(c,max(dst.a,src.a)),opacity);}"],[4,"vec4 blend(const in vec4 dst,const in vec4 src,const in float opacity){vec3 a=dst.rgb,b=src.rgb;vec3 c=mix(step(0.0,b)*(1.0-min(vec3(1.0),(1.0-a)/max(b,1e-9))),vec3(1.0),step(1.0,a));return mix(dst,vec4(c,max(dst.a,src.a)),opacity);}"],[5,"vec4 blend(const in vec4 dst,const in vec4 src,const in float opacity){vec3 a=dst.rgb,b=src.rgb;vec3 c=step(0.0,a)*mix(min(vec3(1.0),a/max(1.0-b,1e-9)),vec3(1.0),step(1.0,b));return mix(dst,vec4(c,max(dst.a,src.a)),opacity);}"],[6,"vec4 blend(const in vec4 dst,const in vec4 src,const in float opacity){vec3 c=min(dst.rgb,src.rgb);return mix(dst,vec4(c,max(dst.a,src.a)),opacity);}"],[7,"vec4 blend(const in vec4 dst,const in vec4 src,const in float opacity){vec3 c=abs(dst.rgb-src.rgb);return mix(dst,vec4(c,max(dst.a,src.a)),opacity);}"],[8,"vec4 blend(const in vec4 dst,const in vec4 src,const in float opacity){vec3 c=dst.rgb/max(src.rgb,1e-9);return mix(dst,vec4(c,max(dst.a,src.a)),opacity);}"],[li,null],[10,"vec4 blend(const in vec4 dst,const in vec4 src,const in float opacity){vec3 c=dst.rgb+src.rgb-2.0*dst.rgb*src.rgb;return mix(dst,vec4(c,max(dst.a,src.a)),opacity);}"],[11,"vec4 blend(const in vec4 dst,const in vec4 src,const in float opacity){vec3 a=min(dst.rgb,1.0);vec3 b=min(src.rgb,1.0);vec3 c=mix(2.0*a*b,1.0-2.0*(1.0-a)*(1.0-b),step(0.5,b));return mix(dst,vec4(c,max(dst.a,src.a)),opacity);}"],[12,"vec4 blend(const in vec4 dst,const in vec4 src,const in float opacity){vec3 c=step(1.0,dst.rgb+src.rgb);return mix(dst,vec4(c,max(dst.a,src.a)),opacity);}"],[13,"vec4 blend(const in vec4 dst,const in vec4 src,const in float opacity){vec3 a=RGBToHSL(dst.rgb);vec3 b=RGBToHSL(src.rgb);vec3 c=HSLToRGB(vec3(b.x,a.yz));return mix(dst,vec4(c,max(dst.a,src.a)),opacity);}"],[14,"vec4 blend(const in vec4 dst,const in vec4 src,const in float opacity){vec3 c=max(1.0-src.rgb,0.0);return mix(dst,vec4(c,max(dst.a,src.a)),opacity);}"],[15,"vec4 blend(const in vec4 dst,const in vec4 src,const in float opacity){vec3 c=src.rgb*max(1.0-dst.rgb,0.0);return mix(dst,vec4(c,max(dst.a,src.a)),opacity);}"],[16,"vec4 blend(const in vec4 dst,const in vec4 src,const in float opacity){vec3 c=max(dst.rgb,src.rgb);return mix(dst,vec4(c,max(dst.a,src.a)),opacity);}"],[17,"vec4 blend(const in vec4 dst,const in vec4 src,const in float opacity){vec3 c=clamp(src.rgb+dst.rgb-1.0,0.0,1.0);return mix(dst,vec4(c,max(dst.a,src.a)),opacity);}"],[18,"vec4 blend(const in vec4 dst,const in vec4 src,const in float opacity){vec3 c=min(dst.rgb+src.rgb,1.0);return mix(dst,vec4(c,max(dst.a,src.a)),opacity);}"],[19,"vec4 blend(const in vec4 dst,const in vec4 src,const in float opacity){vec3 c=clamp(2.0*src.rgb+dst.rgb-1.0,0.0,1.0);return mix(dst,vec4(c,max(dst.a,src.a)),opacity);}"],[20,"vec4 blend(const in vec4 dst,const in vec4 src,const in float opacity){vec3 a=RGBToHSL(dst.rgb);vec3 b=RGBToHSL(src.rgb);vec3 c=HSLToRGB(vec3(a.xy,b.z));return mix(dst,vec4(c,max(dst.a,src.a)),opacity);}"],[21,"vec4 blend(const in vec4 dst,const in vec4 src,const in float opacity){vec3 c=dst.rgb*src.rgb;return mix(dst,vec4(c,max(dst.a,src.a)),opacity);}"],[22,"vec4 blend(const in vec4 dst,const in vec4 src,const in float opacity){vec3 c=max(1.0-abs(1.0-dst.rgb-src.rgb),0.0);return mix(dst,vec4(c,max(dst.a,src.a)),opacity);}"],[hi,"vec4 blend(const in vec4 dst,const in vec4 src,const in float opacity){return mix(dst,src,opacity);}"],[24,"vec4 blend(const in vec4 dst,const in vec4 src,const in float opacity){vec3 a=2.0*src.rgb*dst.rgb;vec3 b=1.0-2.0*(1.0-src.rgb)*(1.0-dst.rgb);vec3 c=mix(a,b,step(0.5,dst.rgb));return mix(dst,vec4(c,max(dst.a,src.a)),opacity);}"],[25,"vec4 blend(const in vec4 dst,const in vec4 src,const in float opacity){vec3 src2=2.0*src.rgb;vec3 c=mix(mix(src2,dst.rgb,step(0.5*dst.rgb,src.rgb)),max(src2-1.0,vec3(0.0)),step(dst.rgb,src2-1.0));return mix(dst,vec4(c,max(dst.a,src.a)),opacity);}"],[26,"vec4 blend(const in vec4 dst,const in vec4 src,const in float opacity){vec3 a=min(dst.rgb*dst.rgb/max(1.0-src.rgb,1e-9),1.0);vec3 c=mix(a,src.rgb,step(1.0,src.rgb));return mix(dst,vec4(c,max(dst.a,src.a)),opacity);}"],[27,"vec4 blend(const in vec4 dst,const in vec4 src,const in float opacity){vec3 a=RGBToHSL(dst.rgb);vec3 b=RGBToHSL(src.rgb);vec3 c=HSLToRGB(vec3(a.x,b.y,a.z));return mix(dst,vec4(c,max(dst.a,src.a)),opacity);}"],[fi,"vec4 blend(const in vec4 dst,const in vec4 src,const in float opacity){vec3 c=dst.rgb+src.rgb-min(dst.rgb*src.rgb,1.0);return mix(dst,vec4(c,max(dst.a,src.a)),opacity);}"],[29,"vec4 blend(const in vec4 dst,const in vec4 src,const in float opacity){vec3 src2=2.0*src.rgb;vec3 d=dst.rgb+(src2-1.0);vec3 w=step(0.5,src.rgb);vec3 a=dst.rgb-(1.0-src2)*dst.rgb*(1.0-dst.rgb);vec3 b=mix(d*(sqrt(dst.rgb)-dst.rgb),d*dst.rgb*((16.0*dst.rgb-12.0)*dst.rgb+3.0),w*(1.0-step(0.25,dst.rgb)));vec3 c=mix(a,b,w);return mix(dst,vec4(c,max(dst.a,src.a)),opacity);}"],[30,"vec4 blend(const in vec4 dst,const in vec4 src,const in float opacity){return src;}"],[31,"vec4 blend(const in vec4 dst,const in vec4 src,const in float opacity){vec3 c=max(dst.rgb-src.rgb,0.0);return mix(dst,vec4(c,max(dst.a,src.a)),opacity);}"],[32,"vec4 blend(const in vec4 dst,const in vec4 src,const in float opacity){vec3 c=mix(max(1.0-min((1.0-dst.rgb)/(2.0*src.rgb),1.0),0.0),min(dst.rgb/(2.0*(1.0-src.rgb)),1.0),step(0.5,src.rgb));return mix(dst,vec4(c,max(dst.a,src.a)),opacity);}"]]),di=class extends I{constructor(e,t=1){super(),this._blendFunction=e,this.opacity=new F(t)}getOpacity(){return this.opacity.value}setOpacity(e){this.opacity.value=e}get blendFunction(){return this._blendFunction}set blendFunction(e){this._blendFunction=e,this.dispatchEvent({type:"change"})}getBlendFunction(){return this.blendFunction}setBlendFunction(e){this.blendFunction=e}getShaderCode(){return pi.get(this.blendFunction)}},mi=class extends I{constructor(e,t,{attributes:n=ti,blendFunction:r=hi,defines:i=new Map,uniforms:o=new Map,extensions:s=null,vertexShader:a=null}={}){super(),this.name=e,this.renderer=null,this.attributes=n,this.fragmentShader=t,this.vertexShader=a,this.defines=i,this.uniforms=o,this.extensions=s,this.blendMode=new di(r),this.blendMode.addEventListener("change",e=>this.setChanged()),this._inputColorSpace=j,this._outputColorSpace=V}get inputColorSpace(){return this._inputColorSpace}set inputColorSpace(e){this._inputColorSpace=e,this.setChanged()}get outputColorSpace(){return this._outputColorSpace}set outputColorSpace(e){this._outputColorSpace=e,this.setChanged()}set mainScene(e){}set mainCamera(e){}getName(){return this.name}setRenderer(e){this.renderer=e}getDefines(){return this.defines}getUniforms(){return this.uniforms}getExtensions(){return this.extensions}getBlendMode(){return this.blendMode}getAttributes(){return this.attributes}setAttributes(e){this.attributes=e,this.setChanged()}getFragmentShader(){return this.fragmentShader}setFragmentShader(e){this.fragmentShader=e,this.setChanged()}getVertexShader(){return this.vertexShader}setVertexShader(e){this.vertexShader=e,this.setChanged()}setChanged(){this.dispatchEvent({type:"change"})}setDepthTexture(e,t=U){}update(e,t,n){}setSize(e,t){}initialize(e,t,n){}dispose(){for(const e of Object.keys(this)){const t=this[e];(t instanceof _||t instanceof Y||t instanceof $||t instanceof Wr)&&this[e].dispose()}}},vi=2,gi=3,yi=[new Float32Array([0,0]),new Float32Array([0,1,1]),new Float32Array([0,1,1,2]),new Float32Array([0,1,2,2,3]),new Float32Array([0,1,2,3,4,4,5]),new Float32Array([0,1,2,3,4,5,7,8,9,10])],xi=class extends G{constructor(e=new te){super({name:"KawaseBlurMaterial",uniforms:{inputBuffer:new F(null),texelSize:new F(new te),scale:new F(1),kernel:new F(0)},blending:J,toneMapped:!1,depthWrite:!1,depthTest:!1,fragmentShader:"#ifdef FRAMEBUFFER_PRECISION_HIGH\nuniform mediump sampler2D inputBuffer;\n#else\nuniform lowp sampler2D inputBuffer;\n#endif\nvarying vec2 vUv0;varying vec2 vUv1;varying vec2 vUv2;varying vec2 vUv3;void main(){vec4 sum=texture2D(inputBuffer,vUv0);sum+=texture2D(inputBuffer,vUv1);sum+=texture2D(inputBuffer,vUv2);sum+=texture2D(inputBuffer,vUv3);gl_FragColor=sum*0.25;\n#include <colorspace_fragment>\n}",vertexShader:"uniform vec4 texelSize;uniform float kernel;uniform float scale;varying vec2 vUv0;varying vec2 vUv1;varying vec2 vUv2;varying vec2 vUv3;void main(){vec2 uv=position.xy*0.5+0.5;vec2 dUv=(texelSize.xy*vec2(kernel)+texelSize.zw)*scale;vUv0=vec2(uv.x-dUv.x,uv.y+dUv.y);vUv1=vec2(uv.x+dUv.x,uv.y+dUv.y);vUv2=vec2(uv.x+dUv.x,uv.y-dUv.y);vUv3=vec2(uv.x-dUv.x,uv.y-dUv.y);gl_Position=vec4(position.xy,1.0,1.0);}"}),this.setTexelSize(e.x,e.y),this.kernelSize=vi}set inputBuffer(e){this.uniforms.inputBuffer.value=e}setInputBuffer(e){this.inputBuffer=e}get kernelSequence(){return yi[this.kernelSize]}get scale(){return this.uniforms.scale.value}set scale(e){this.uniforms.scale.value=e}getScale(){return this.uniforms.scale.value}setScale(e){this.uniforms.scale.value=e}getKernel(){return null}get kernel(){return this.uniforms.kernel.value}set kernel(e){this.uniforms.kernel.value=e}setKernel(e){this.kernel=e}setTexelSize(e,t){this.uniforms.texelSize.value.set(e,t,.5*e,.5*t)}setSize(e,t){const n=1/e,r=1/t;this.uniforms.texelSize.value.set(n,r,.5*n,.5*r)}},bi=class extends Wr{constructor({kernelSize:e=vi,resolutionScale:t=.5,width:n=ci.AUTO_SIZE,height:r=ci.AUTO_SIZE,resolutionX:i=n,resolutionY:o=r}={}){super("KawaseBlurPass"),this.renderTargetA=new _(1,1,{depthBuffer:!1}),this.renderTargetA.texture.name="Blur.Target.A",this.renderTargetB=this.renderTargetA.clone(),this.renderTargetB.texture.name="Blur.Target.B";const s=this.resolution=new ci(this,i,o,t);s.addEventListener("change",e=>this.setSize(s.baseWidth,s.baseHeight)),this._blurMaterial=new xi,this._blurMaterial.kernelSize=e,this.copyMaterial=new $r}getResolution(){return this.resolution}get blurMaterial(){return this._blurMaterial}set blurMaterial(e){this._blurMaterial=e}get dithering(){return this.copyMaterial.dithering}set dithering(e){this.copyMaterial.dithering=e}get kernelSize(){return this.blurMaterial.kernelSize}set kernelSize(e){this.blurMaterial.kernelSize=e}get width(){return this.resolution.width}set width(e){this.resolution.preferredWidth=e}get height(){return this.resolution.height}set height(e){this.resolution.preferredHeight=e}get scale(){return this.blurMaterial.scale}set scale(e){this.blurMaterial.scale=e}getScale(){return this.blurMaterial.scale}setScale(e){this.blurMaterial.scale=e}getKernelSize(){return this.kernelSize}setKernelSize(e){this.kernelSize=e}getResolutionScale(){return this.resolution.scale}setResolutionScale(e){this.resolution.scale=e}render(e,t,n,r,i){const o=this.scene,s=this.camera,a=this.renderTargetA,u=this.renderTargetB,c=this.blurMaterial,l=c.kernelSequence;let h=t;this.fullscreenMaterial=c;for(let f=0,p=l.length;f<p;++f){const t=1&f?u:a;c.kernel=l[f],c.inputBuffer=h.texture,e.setRenderTarget(t),e.render(o,s),h=t}this.fullscreenMaterial=this.copyMaterial,this.copyMaterial.inputBuffer=h.texture,e.setRenderTarget(this.renderToScreen?null:n),e.render(o,s)}setSize(e,t){const n=this.resolution;n.setBaseSize(e,t);const r=n.width,i=n.height;this.renderTargetA.setSize(r,i),this.renderTargetB.setSize(r,i),this.blurMaterial.setSize(e,t)}initialize(e,t,n){void 0!==n&&(this.renderTargetA.texture.type=n,this.renderTargetB.texture.type=n,n!==N?(this.blurMaterial.defines.FRAMEBUFFER_PRECISION_HIGH="1",this.copyMaterial.defines.FRAMEBUFFER_PRECISION_HIGH="1"):null!==e&&e.outputColorSpace===S&&(this.renderTargetA.texture.colorSpace=S,this.renderTargetB.texture.colorSpace=S))}static get AUTO_SIZE(){return ci.AUTO_SIZE}},Ei=class extends G{constructor(e=!1,t=null){super({name:"LuminanceMaterial",defines:{THREE_REVISION:q.replace(/\D+/g,"")},uniforms:{inputBuffer:new F(null),threshold:new F(0),smoothing:new F(1),range:new F(null)},blending:J,toneMapped:!1,depthWrite:!1,depthTest:!1,fragmentShader:"#include <common>\n#ifdef FRAMEBUFFER_PRECISION_HIGH\nuniform mediump sampler2D inputBuffer;\n#else\nuniform lowp sampler2D inputBuffer;\n#endif\n#ifdef RANGE\nuniform vec2 range;\n#elif defined(THRESHOLD)\nuniform float threshold;uniform float smoothing;\n#endif\nvarying vec2 vUv;void main(){vec4 texel=texture2D(inputBuffer,vUv);float l=luminance(texel.rgb);float mask=1.0;\n#ifdef RANGE\nfloat low=step(range.x,l);float high=step(l,range.y);mask=low*high;\n#elif defined(THRESHOLD)\nmask=smoothstep(threshold,threshold+smoothing,l);\n#endif\n#ifdef COLOR\ngl_FragColor=texel*mask;\n#else\ngl_FragColor=vec4(l*mask);\n#endif\n}",vertexShader:Yr}),this.colorOutput=e,this.luminanceRange=t}set inputBuffer(e){this.uniforms.inputBuffer.value=e}setInputBuffer(e){this.uniforms.inputBuffer.value=e}get threshold(){return this.uniforms.threshold.value}set threshold(e){this.smoothing>0||e>0?this.defines.THRESHOLD="1":delete this.defines.THRESHOLD,this.uniforms.threshold.value=e}getThreshold(){return this.threshold}setThreshold(e){this.threshold=e}get smoothing(){return this.uniforms.smoothing.value}set smoothing(e){this.threshold>0||e>0?this.defines.THRESHOLD="1":delete this.defines.THRESHOLD,this.uniforms.smoothing.value=e}getSmoothingFactor(){return this.smoothing}setSmoothingFactor(e){this.smoothing=e}get useThreshold(){return this.threshold>0||this.smoothing>0}set useThreshold(e){}get colorOutput(){return void 0!==this.defines.COLOR}set colorOutput(e){e?this.defines.COLOR="1":delete this.defines.COLOR,this.needsUpdate=!0}isColorOutputEnabled(e){return this.colorOutput}setColorOutputEnabled(e){this.colorOutput=e}get useRange(){return null!==this.luminanceRange}set useRange(e){this.luminanceRange=null}get luminanceRange(){return this.uniforms.range.value}set luminanceRange(e){null!==e?this.defines.RANGE="1":delete this.defines.RANGE,this.uniforms.range.value=e,this.needsUpdate=!0}getLuminanceRange(){return this.luminanceRange}setLuminanceRange(e){this.luminanceRange=e}},wi=class extends Wr{constructor({renderTarget:e,luminanceRange:t,colorOutput:n,resolutionScale:r=1,width:i=ci.AUTO_SIZE,height:o=ci.AUTO_SIZE,resolutionX:s=i,resolutionY:a=o}={}){super("LuminancePass"),this.fullscreenMaterial=new Ei(n,t),this.needsSwap=!1,this.renderTarget=e,void 0===this.renderTarget&&(this.renderTarget=new _(1,1,{depthBuffer:!1}),this.renderTarget.texture.name="LuminancePass.Target");const u=this.resolution=new ci(this,s,a,r);u.addEventListener("change",e=>this.setSize(u.baseWidth,u.baseHeight))}get texture(){return this.renderTarget.texture}getTexture(){return this.renderTarget.texture}getResolution(){return this.resolution}render(e,t,n,r,i){this.fullscreenMaterial.inputBuffer=t.texture,e.setRenderTarget(this.renderToScreen?null:this.renderTarget),e.render(this.scene,this.camera)}setSize(e,t){const n=this.resolution;n.setBaseSize(e,t),this.renderTarget.setSize(n.width,n.height)}initialize(e,t,n){void 0!==n&&n!==N&&(this.renderTarget.texture.type=n,this.fullscreenMaterial.defines.FRAMEBUFFER_PRECISION_HIGH="1")}},Ni=class extends G{constructor(){super({name:"DownsamplingMaterial",uniforms:{inputBuffer:new F(null),texelSize:new F(new w)},blending:J,toneMapped:!1,depthWrite:!1,depthTest:!1,fragmentShader:"#ifdef FRAMEBUFFER_PRECISION_HIGH\nuniform mediump sampler2D inputBuffer;\n#else\nuniform lowp sampler2D inputBuffer;\n#endif\n#define WEIGHT_INNER 0.125\n#define WEIGHT_OUTER 0.05556\nvarying vec2 vUv;varying vec2 vUv00;varying vec2 vUv01;varying vec2 vUv02;varying vec2 vUv03;varying vec2 vUv04;varying vec2 vUv05;varying vec2 vUv06;varying vec2 vUv07;varying vec2 vUv08;varying vec2 vUv09;varying vec2 vUv10;varying vec2 vUv11;float clampToBorder(const in vec2 uv){return float(uv.s>=0.0&&uv.s<=1.0&&uv.t>=0.0&&uv.t<=1.0);}void main(){vec4 c=vec4(0.0);vec4 w=WEIGHT_INNER*vec4(clampToBorder(vUv00),clampToBorder(vUv01),clampToBorder(vUv02),clampToBorder(vUv03));c+=w.x*texture2D(inputBuffer,vUv00);c+=w.y*texture2D(inputBuffer,vUv01);c+=w.z*texture2D(inputBuffer,vUv02);c+=w.w*texture2D(inputBuffer,vUv03);w=WEIGHT_OUTER*vec4(clampToBorder(vUv04),clampToBorder(vUv05),clampToBorder(vUv06),clampToBorder(vUv07));c+=w.x*texture2D(inputBuffer,vUv04);c+=w.y*texture2D(inputBuffer,vUv05);c+=w.z*texture2D(inputBuffer,vUv06);c+=w.w*texture2D(inputBuffer,vUv07);w=WEIGHT_OUTER*vec4(clampToBorder(vUv08),clampToBorder(vUv09),clampToBorder(vUv10),clampToBorder(vUv11));c+=w.x*texture2D(inputBuffer,vUv08);c+=w.y*texture2D(inputBuffer,vUv09);c+=w.z*texture2D(inputBuffer,vUv10);c+=w.w*texture2D(inputBuffer,vUv11);c+=WEIGHT_OUTER*texture2D(inputBuffer,vUv);gl_FragColor=c;\n#include <colorspace_fragment>\n}",vertexShader:"uniform vec2 texelSize;varying vec2 vUv;varying vec2 vUv00;varying vec2 vUv01;varying vec2 vUv02;varying vec2 vUv03;varying vec2 vUv04;varying vec2 vUv05;varying vec2 vUv06;varying vec2 vUv07;varying vec2 vUv08;varying vec2 vUv09;varying vec2 vUv10;varying vec2 vUv11;void main(){vUv=position.xy*0.5+0.5;vUv00=vUv+texelSize*vec2(-1.0,1.0);vUv01=vUv+texelSize*vec2(1.0,1.0);vUv02=vUv+texelSize*vec2(-1.0,-1.0);vUv03=vUv+texelSize*vec2(1.0,-1.0);vUv04=vUv+texelSize*vec2(-2.0,2.0);vUv05=vUv+texelSize*vec2(0.0,2.0);vUv06=vUv+texelSize*vec2(2.0,2.0);vUv07=vUv+texelSize*vec2(-2.0,0.0);vUv08=vUv+texelSize*vec2(2.0,0.0);vUv09=vUv+texelSize*vec2(-2.0,-2.0);vUv10=vUv+texelSize*vec2(0.0,-2.0);vUv11=vUv+texelSize*vec2(2.0,-2.0);gl_Position=vec4(position.xy,1.0,1.0);}"})}set inputBuffer(e){this.uniforms.inputBuffer.value=e}setSize(e,t){this.uniforms.texelSize.value.set(1/e,1/t)}},Si=class extends G{constructor(){super({name:"UpsamplingMaterial",uniforms:{inputBuffer:new F(null),supportBuffer:new F(null),texelSize:new F(new w),radius:new F(.85)},blending:J,toneMapped:!1,depthWrite:!1,depthTest:!1,fragmentShader:"#ifdef FRAMEBUFFER_PRECISION_HIGH\nuniform mediump sampler2D inputBuffer;uniform mediump sampler2D supportBuffer;\n#else\nuniform lowp sampler2D inputBuffer;uniform lowp sampler2D supportBuffer;\n#endif\nuniform float radius;varying vec2 vUv;varying vec2 vUv0;varying vec2 vUv1;varying vec2 vUv2;varying vec2 vUv3;varying vec2 vUv4;varying vec2 vUv5;varying vec2 vUv6;varying vec2 vUv7;void main(){vec4 c=vec4(0.0);c+=texture2D(inputBuffer,vUv0)*0.0625;c+=texture2D(inputBuffer,vUv1)*0.125;c+=texture2D(inputBuffer,vUv2)*0.0625;c+=texture2D(inputBuffer,vUv3)*0.125;c+=texture2D(inputBuffer,vUv)*0.25;c+=texture2D(inputBuffer,vUv4)*0.125;c+=texture2D(inputBuffer,vUv5)*0.0625;c+=texture2D(inputBuffer,vUv6)*0.125;c+=texture2D(inputBuffer,vUv7)*0.0625;vec4 baseColor=texture2D(supportBuffer,vUv);gl_FragColor=mix(baseColor,c,radius);\n#include <colorspace_fragment>\n}",vertexShader:"uniform vec2 texelSize;varying vec2 vUv;varying vec2 vUv0;varying vec2 vUv1;varying vec2 vUv2;varying vec2 vUv3;varying vec2 vUv4;varying vec2 vUv5;varying vec2 vUv6;varying vec2 vUv7;void main(){vUv=position.xy*0.5+0.5;vUv0=vUv+texelSize*vec2(-1.0,1.0);vUv1=vUv+texelSize*vec2(0.0,1.0);vUv2=vUv+texelSize*vec2(1.0,1.0);vUv3=vUv+texelSize*vec2(-1.0,0.0);vUv4=vUv+texelSize*vec2(1.0,0.0);vUv5=vUv+texelSize*vec2(-1.0,-1.0);vUv6=vUv+texelSize*vec2(0.0,-1.0);vUv7=vUv+texelSize*vec2(1.0,-1.0);gl_Position=vec4(position.xy,1.0,1.0);}"})}set inputBuffer(e){this.uniforms.inputBuffer.value=e}set supportBuffer(e){this.uniforms.supportBuffer.value=e}get radius(){return this.uniforms.radius.value}set radius(e){this.uniforms.radius.value=e}setSize(e,t){this.uniforms.texelSize.value.set(1/e,1/t)}},Ti=class extends Wr{constructor(){super("MipmapBlurPass"),this.needsSwap=!1,this.renderTarget=new _(1,1,{depthBuffer:!1}),this.renderTarget.texture.name="Upsampling.Mipmap0",this.downsamplingMipmaps=[],this.upsamplingMipmaps=[],this.downsamplingMaterial=new Ni,this.upsamplingMaterial=new Si,this.resolution=new w}get texture(){return this.renderTarget.texture}get levels(){return this.downsamplingMipmaps.length}set levels(e){if(this.levels!==e){const t=this.renderTarget;this.dispose(),this.downsamplingMipmaps=[],this.upsamplingMipmaps=[];for(let n=0;n<e;++n){const e=t.clone();e.texture.name="Downsampling.Mipmap"+n,this.downsamplingMipmaps.push(e)}this.upsamplingMipmaps.push(t);for(let n=1,r=e-1;n<r;++n){const e=t.clone();e.texture.name="Upsampling.Mipmap"+n,this.upsamplingMipmaps.push(e)}this.setSize(this.resolution.x,this.resolution.y)}}get radius(){return this.upsamplingMaterial.radius}set radius(e){this.upsamplingMaterial.radius=e}render(e,t,n,r,i){const{scene:o,camera:s}=this,{downsamplingMaterial:a,upsamplingMaterial:u}=this,{downsamplingMipmaps:c,upsamplingMipmaps:l}=this;let h=t;this.fullscreenMaterial=a;for(let f=0,p=c.length;f<p;++f){const t=c[f];a.setSize(h.width,h.height),a.inputBuffer=h.texture,e.setRenderTarget(t),e.render(o,s),h=t}this.fullscreenMaterial=u;for(let f=l.length-1;f>=0;--f){const t=l[f];u.setSize(h.width,h.height),u.inputBuffer=h.texture,u.supportBuffer=c[f].texture,e.setRenderTarget(t),e.render(o,s),h=t}}setSize(e,t){const n=this.resolution;n.set(e,t);let r=n.width,i=n.height;for(let o=0,s=this.downsamplingMipmaps.length;o<s;++o)r=Math.round(.5*r),i=Math.round(.5*i),this.downsamplingMipmaps[o].setSize(r,i),o<this.upsamplingMipmaps.length&&this.upsamplingMipmaps[o].setSize(r,i)}initialize(e,t,n){if(void 0!==n){const t=this.downsamplingMipmaps.concat(this.upsamplingMipmaps);for(const e of t)e.texture.type=n;if(n!==N)this.downsamplingMaterial.defines.FRAMEBUFFER_PRECISION_HIGH="1",this.upsamplingMaterial.defines.FRAMEBUFFER_PRECISION_HIGH="1";else if(null!==e&&e.outputColorSpace===S)for(const e of t)e.texture.colorSpace=S}}dispose(){super.dispose();for(const e of this.downsamplingMipmaps.concat(this.upsamplingMipmaps))e.dispose()}},Mi=class extends mi{constructor({blendFunction:e=fi,luminanceThreshold:t=1,luminanceSmoothing:n=.03,mipmapBlur:r=!0,intensity:i=1,radius:o=.85,levels:s=8,kernelSize:a=gi,resolutionScale:u=.5,width:c=ci.AUTO_SIZE,height:l=ci.AUTO_SIZE,resolutionX:h=c,resolutionY:f=l}={}){super("BloomEffect","#ifdef FRAMEBUFFER_PRECISION_HIGH\nuniform mediump sampler2D map;\n#else\nuniform lowp sampler2D map;\n#endif\nuniform float intensity;void mainImage(const in vec4 inputColor,const in vec2 uv,out vec4 outputColor){outputColor=texture2D(map,uv)*intensity;}",{blendFunction:e,uniforms:new Map([["map",new F(null)],["intensity",new F(i)]])}),this.renderTarget=new _(1,1,{depthBuffer:!1}),this.renderTarget.texture.name="Bloom.Target",this.blurPass=new bi({kernelSize:a}),this.luminancePass=new wi({colorOutput:!0}),this.luminanceMaterial.threshold=t,this.luminanceMaterial.smoothing=n,this.mipmapBlurPass=new Ti,this.mipmapBlurPass.enabled=r,this.mipmapBlurPass.radius=o,this.mipmapBlurPass.levels=s,this.uniforms.get("map").value=r?this.mipmapBlurPass.texture:this.renderTarget.texture;const p=this.resolution=new ci(this,h,f,u);p.addEventListener("change",e=>this.setSize(p.baseWidth,p.baseHeight))}get texture(){return this.mipmapBlurPass.enabled?this.mipmapBlurPass.texture:this.renderTarget.texture}getTexture(){return this.texture}getResolution(){return this.resolution}getBlurPass(){return this.blurPass}getLuminancePass(){return this.luminancePass}get luminanceMaterial(){return this.luminancePass.fullscreenMaterial}getLuminanceMaterial(){return this.luminancePass.fullscreenMaterial}get width(){return this.resolution.width}set width(e){this.resolution.preferredWidth=e}get height(){return this.resolution.height}set height(e){this.resolution.preferredHeight=e}get dithering(){return this.blurPass.dithering}set dithering(e){this.blurPass.dithering=e}get kernelSize(){return this.blurPass.kernelSize}set kernelSize(e){this.blurPass.kernelSize=e}get distinction(){return 1}set distinction(e){}get intensity(){return this.uniforms.get("intensity").value}set intensity(e){this.uniforms.get("intensity").value=e}getIntensity(){return this.intensity}setIntensity(e){this.intensity=e}getResolutionScale(){return this.resolution.scale}setResolutionScale(e){this.resolution.scale=e}update(e,t,n){const r=this.renderTarget,i=this.luminancePass;i.enabled?(i.render(e,t),this.mipmapBlurPass.enabled?this.mipmapBlurPass.render(e,i.renderTarget):this.blurPass.render(e,i.renderTarget,r)):this.mipmapBlurPass.enabled?this.mipmapBlurPass.render(e,t):this.blurPass.render(e,t,r)}setSize(e,t){const n=this.resolution;n.setBaseSize(e,t),this.renderTarget.setSize(n.width,n.height),this.blurPass.resolution.copy(n),this.luminancePass.setSize(e,t),this.mipmapBlurPass.setSize(e,t)}initialize(e,t,n){this.blurPass.initialize(e,t,n),this.luminancePass.initialize(e,t,n),this.mipmapBlurPass.initialize(e,t,n),void 0!==n&&(this.renderTarget.texture.type=n,null!==e&&e.outputColorSpace===S&&(this.renderTarget.texture.colorSpace=S))}},Ai=class extends mi{constructor({offset:e=new w(.001,5e-4),radialModulation:t=!1,modulationOffset:n=.15}={}){super("ChromaticAberrationEffect","#ifdef RADIAL_MODULATION\nuniform float modulationOffset;\n#endif\nvarying float vActive;varying vec2 vUvR;varying vec2 vUvB;void mainImage(const in vec4 inputColor,const in vec2 uv,out vec4 outputColor){vec2 ra=inputColor.ra;vec2 ba=inputColor.ba;\n#ifdef RADIAL_MODULATION\nconst vec2 center=vec2(0.5);float d=distance(uv,center)*2.0;d=max(d-modulationOffset,0.0);if(vActive>0.0&&d>0.0){ra=texture2D(inputBuffer,mix(uv,vUvR,d)).ra;ba=texture2D(inputBuffer,mix(uv,vUvB,d)).ba;}\n#else\nif(vActive>0.0){ra=texture2D(inputBuffer,vUvR).ra;ba=texture2D(inputBuffer,vUvB).ba;}\n#endif\noutputColor=vec4(ra.x,inputColor.g,ba.x,max(max(ra.y,ba.y),inputColor.a));}",{vertexShader:"uniform vec2 offset;varying float vActive;varying vec2 vUvR;varying vec2 vUvB;void mainSupport(const in vec2 uv){vec2 shift=offset*vec2(1.0,aspect);vActive=(shift.x!=0.0||shift.y!=0.0)?1.0:0.0;vUvR=uv+shift;vUvB=uv-shift;}",attributes:ri,uniforms:new Map([["offset",new F(e)],["modulationOffset",new F(n)]])}),this.radialModulation=t}get offset(){return this.uniforms.get("offset").value}set offset(e){this.uniforms.get("offset").value=e}get radialModulation(){return this.defines.has("RADIAL_MODULATION")}set radialModulation(e){e?this.defines.set("RADIAL_MODULATION","1"):this.defines.delete("RADIAL_MODULATION"),this.setChanged()}get modulationOffset(){return this.uniforms.get("modulationOffset").value}set modulationOffset(e){this.uniforms.get("modulationOffset").value=e}getOffset(){return this.offset}setOffset(e){this.offset=e}},Di=class extends Wr{constructor(e,t,n=null){super("RenderPass",e,t),this.needsSwap=!1,this.clearPass=new Kr,this.overrideMaterialManager=null===n?null:new ai(n),this.ignoreBackground=!1,this.skipShadowMapUpdate=!1,this.selection=null}set mainScene(e){this.scene=e}set mainCamera(e){this.camera=e}get renderToScreen(){return super.renderToScreen}set renderToScreen(e){super.renderToScreen=e,this.clearPass.renderToScreen=e}get overrideMaterial(){const e=this.overrideMaterialManager;return null!==e?e.material:null}set overrideMaterial(e){const t=this.overrideMaterialManager;null!==e?null!==t?t.setMaterial(e):this.overrideMaterialManager=new ai(e):null!==t&&(t.dispose(),this.overrideMaterialManager=null)}getOverrideMaterial(){return this.overrideMaterial}setOverrideMaterial(e){this.overrideMaterial=e}get clear(){return this.clearPass.enabled}set clear(e){this.clearPass.enabled=e}getSelection(){return this.selection}setSelection(e){this.selection=e}isBackgroundDisabled(){return this.ignoreBackground}setBackgroundDisabled(e){this.ignoreBackground=e}isShadowMapDisabled(){return this.skipShadowMapUpdate}setShadowMapDisabled(e){this.skipShadowMapUpdate=e}getClearPass(){return this.clearPass}render(e,t,n,r,i){const o=this.scene,s=this.camera,a=this.selection,u=s.layers.mask,c=o.background,l=e.shadowMap.autoUpdate,h=this.renderToScreen?null:t;null!==a&&s.layers.set(a.getLayer()),this.skipShadowMapUpdate&&(e.shadowMap.autoUpdate=!1),(this.ignoreBackground||null!==this.clearPass.overrideClearColor)&&(o.background=null),this.clearPass.enabled&&this.clearPass.render(e,t),e.setRenderTarget(h),null!==this.overrideMaterialManager?this.overrideMaterialManager.render(e,o,s):e.render(o,s),s.layers.mask=u,o.background=c,e.shadowMap.autoUpdate=l}},_i=class extends G{constructor(){super({name:"DepthDownsamplingMaterial",defines:{DEPTH_PACKING:"0"},uniforms:{depthBuffer:new F(null),normalBuffer:new F(null),texelSize:new F(new w)},blending:J,toneMapped:!1,depthWrite:!1,depthTest:!1,fragmentShader:"#include <packing>\n#ifdef GL_FRAGMENT_PRECISION_HIGH\nuniform highp sampler2D depthBuffer;\n#else\nuniform mediump sampler2D depthBuffer;\n#endif\n#ifdef DOWNSAMPLE_NORMALS\nuniform lowp sampler2D normalBuffer;\n#endif\nvarying vec2 vUv0;varying vec2 vUv1;varying vec2 vUv2;varying vec2 vUv3;float readDepth(const in vec2 uv){\n#if DEPTH_PACKING == 3201\nreturn unpackRGBAToDepth(texture2D(depthBuffer,uv));\n#else\nreturn texture2D(depthBuffer,uv).r;\n#endif\n}int findBestDepth(const in float samples[4]){float c=(samples[0]+samples[1]+samples[2]+samples[3])*0.25;float distances[4];distances[0]=abs(c-samples[0]);distances[1]=abs(c-samples[1]);distances[2]=abs(c-samples[2]);distances[3]=abs(c-samples[3]);float maxDistance=max(max(distances[0],distances[1]),max(distances[2],distances[3]));int remaining[3];int rejected[3];int i,j,k;for(i=0,j=0,k=0;i<4;++i){if(distances[i]<maxDistance){remaining[j++]=i;}else{rejected[k++]=i;}}for(;j<3;++j){remaining[j]=rejected[--k];}vec3 s=vec3(samples[remaining[0]],samples[remaining[1]],samples[remaining[2]]);c=(s.x+s.y+s.z)/3.0;distances[0]=abs(c-s.x);distances[1]=abs(c-s.y);distances[2]=abs(c-s.z);float minDistance=min(distances[0],min(distances[1],distances[2]));for(i=0;i<3;++i){if(distances[i]==minDistance){break;}}return remaining[i];}void main(){float d[4];d[0]=readDepth(vUv0);d[1]=readDepth(vUv1);d[2]=readDepth(vUv2);d[3]=readDepth(vUv3);int index=findBestDepth(d);\n#ifdef DOWNSAMPLE_NORMALS\nvec3 n[4];n[0]=texture2D(normalBuffer,vUv0).rgb;n[1]=texture2D(normalBuffer,vUv1).rgb;n[2]=texture2D(normalBuffer,vUv2).rgb;n[3]=texture2D(normalBuffer,vUv3).rgb;\n#else\nvec3 n[4];n[0]=vec3(0.0);n[1]=vec3(0.0);n[2]=vec3(0.0);n[3]=vec3(0.0);\n#endif\ngl_FragColor=vec4(n[index],d[index]);}",vertexShader:"uniform vec2 texelSize;varying vec2 vUv0;varying vec2 vUv1;varying vec2 vUv2;varying vec2 vUv3;void main(){vec2 uv=position.xy*0.5+0.5;vUv0=uv;vUv1=vec2(uv.x,uv.y+texelSize.y);vUv2=vec2(uv.x+texelSize.x,uv.y);vUv3=uv+texelSize;gl_Position=vec4(position.xy,1.0,1.0);}"})}set depthBuffer(e){this.uniforms.depthBuffer.value=e}set depthPacking(e){this.defines.DEPTH_PACKING=e.toFixed(0),this.needsUpdate=!0}setDepthBuffer(e,t=U){this.depthBuffer=e,this.depthPacking=t}set normalBuffer(e){this.uniforms.normalBuffer.value=e,null!==e?this.defines.DOWNSAMPLE_NORMALS="1":delete this.defines.DOWNSAMPLE_NORMALS,this.needsUpdate=!0}setNormalBuffer(e){this.normalBuffer=e}setTexelSize(e,t){this.uniforms.texelSize.value.set(e,t)}setSize(e,t){this.uniforms.texelSize.value.set(1/e,1/t)}},Oi=class extends Wr{constructor({normalBuffer:e=null,resolutionScale:t=.5,width:n=ci.AUTO_SIZE,height:r=ci.AUTO_SIZE,resolutionX:i=n,resolutionY:o=r}={}){super("DepthDownsamplingPass");const s=new _i;s.normalBuffer=e,this.fullscreenMaterial=s,this.needsDepthTexture=!0,this.needsSwap=!1,this.renderTarget=new _(1,1,{minFilter:B,magFilter:B,depthBuffer:!1,type:R}),this.renderTarget.texture.name="DepthDownsamplingPass.Target",this.renderTarget.texture.generateMipmaps=!1;const a=this.resolution=new ci(this,i,o,t);a.addEventListener("change",e=>this.setSize(a.baseWidth,a.baseHeight))}get texture(){return this.renderTarget.texture}getTexture(){return this.renderTarget.texture}getResolution(){return this.resolution}setDepthTexture(e,t=U){this.fullscreenMaterial.depthBuffer=e,this.fullscreenMaterial.depthPacking=t}render(e,t,n,r,i){e.setRenderTarget(this.renderToScreen?null:this.renderTarget),e.render(this.scene,this.camera)}setSize(e,t){const n=this.resolution;n.setBaseSize(e,t),this.renderTarget.setSize(n.width,n.height),this.fullscreenMaterial.setSize(e,t)}initialize(e,t,n){const r=e.getContext();if(!(r.getExtension("EXT_color_buffer_float")||r.getExtension("EXT_color_buffer_half_float")))throw new Error("Rendering to float texture is not supported.")}},Pi="#include <common>\n#include <packing>\n#include <dithering_pars_fragment>\n#define packFloatToRGBA(v) packDepthToRGBA(v)\n#define unpackRGBAToFloat(v) unpackRGBAToDepth(v)\n#ifdef FRAMEBUFFER_PRECISION_HIGH\nuniform mediump sampler2D inputBuffer;\n#else\nuniform lowp sampler2D inputBuffer;\n#endif\n#if DEPTH_PACKING == 3201\nuniform lowp sampler2D depthBuffer;\n#elif defined(GL_FRAGMENT_PRECISION_HIGH)\nuniform highp sampler2D depthBuffer;\n#else\nuniform mediump sampler2D depthBuffer;\n#endif\nuniform vec2 resolution;uniform vec2 texelSize;uniform float cameraNear;uniform float cameraFar;uniform float aspect;uniform float time;varying vec2 vUv;vec4 sRGBToLinear(const in vec4 value){return vec4(mix(pow(value.rgb*0.9478672986+vec3(0.0521327014),vec3(2.4)),value.rgb*0.0773993808,vec3(lessThanEqual(value.rgb,vec3(0.04045)))),value.a);}float readDepth(const in vec2 uv){\n#if DEPTH_PACKING == 3201\nfloat depth=unpackRGBAToDepth(texture2D(depthBuffer,uv));\n#else\nfloat depth=texture2D(depthBuffer,uv).r;\n#endif\n#if defined(USE_LOGARITHMIC_DEPTH_BUFFER) || defined(LOG_DEPTH)\nfloat d=pow(2.0,depth*log2(cameraFar+1.0))-1.0;float a=cameraFar/(cameraFar-cameraNear);float b=cameraFar*cameraNear/(cameraNear-cameraFar);depth=a+b/d;\n#elif defined(USE_REVERSED_DEPTH_BUFFER)\ndepth=1.0-depth;\n#endif\nreturn depth;}float getViewZ(const in float depth){\n#ifdef PERSPECTIVE_CAMERA\nreturn perspectiveDepthToViewZ(depth,cameraNear,cameraFar);\n#else\nreturn orthographicDepthToViewZ(depth,cameraNear,cameraFar);\n#endif\n}vec3 RGBToHCV(const in vec3 RGB){vec4 P=mix(vec4(RGB.bg,-1.0,2.0/3.0),vec4(RGB.gb,0.0,-1.0/3.0),step(RGB.b,RGB.g));vec4 Q=mix(vec4(P.xyw,RGB.r),vec4(RGB.r,P.yzx),step(P.x,RGB.r));float C=Q.x-min(Q.w,Q.y);float H=abs((Q.w-Q.y)/(6.0*C+EPSILON)+Q.z);return vec3(H,C,Q.x);}vec3 RGBToHSL(const in vec3 RGB){vec3 HCV=RGBToHCV(RGB);float L=HCV.z-HCV.y*0.5;float S=HCV.y/(1.0-abs(L*2.0-1.0)+EPSILON);return vec3(HCV.x,S,L);}vec3 HueToRGB(const in float H){float R=abs(H*6.0-3.0)-1.0;float G=2.0-abs(H*6.0-2.0);float B=2.0-abs(H*6.0-4.0);return clamp(vec3(R,G,B),0.0,1.0);}vec3 HSLToRGB(const in vec3 HSL){vec3 RGB=HueToRGB(HSL.x);float C=(1.0-abs(2.0*HSL.z-1.0))*HSL.y;return(RGB-0.5)*C+HSL.z;}FRAGMENT_HEAD void main(){FRAGMENT_MAIN_UV vec4 color0=texture2D(inputBuffer,UV);vec4 color1=vec4(0.0);FRAGMENT_MAIN_IMAGE color0.a=clamp(color0.a,0.0,1.0);gl_FragColor=color0;\n#ifdef ENCODE_OUTPUT\n#include <colorspace_fragment>\n#endif\n#include <dithering_fragment>\n}",Ci="uniform vec2 resolution;uniform vec2 texelSize;uniform float cameraNear;uniform float cameraFar;uniform float aspect;uniform float time;varying vec2 vUv;VERTEX_HEAD void main(){vUv=position.xy*0.5+0.5;VERTEX_MAIN_SUPPORT gl_Position=vec4(position.xy,1.0,1.0);}",Bi=class extends G{constructor(e,t,n,r,i=!1){super({name:"EffectMaterial",defines:{THREE_REVISION:q.replace(/\D+/g,""),DEPTH_PACKING:"0",ENCODE_OUTPUT:"1"},uniforms:{inputBuffer:new F(null),depthBuffer:new F(null),resolution:new F(new w),texelSize:new F(new w),cameraNear:new F(.3),cameraFar:new F(1e3),aspect:new F(1),time:new F(0)},blending:J,toneMapped:!1,depthWrite:!1,depthTest:!1,dithering:i}),e&&this.setShaderParts(e),t&&this.setDefines(t),n&&this.setUniforms(n),this.copyCameraSettings(r)}set inputBuffer(e){this.uniforms.inputBuffer.value=e}setInputBuffer(e){this.uniforms.inputBuffer.value=e}get depthBuffer(){return this.uniforms.depthBuffer.value}set depthBuffer(e){this.uniforms.depthBuffer.value=e}get depthPacking(){return Number(this.defines.DEPTH_PACKING)}set depthPacking(e){this.defines.DEPTH_PACKING=e.toFixed(0),this.needsUpdate=!0}setDepthBuffer(e,t=U){this.depthBuffer=e,this.depthPacking=t}setShaderData(e){this.setShaderParts(e.shaderParts),this.setDefines(e.defines),this.setUniforms(e.uniforms),this.setExtensions(e.extensions)}setShaderParts(e){return this.fragmentShader=Pi.replace(ii.FRAGMENT_HEAD,e.get(ii.FRAGMENT_HEAD)||"").replace(ii.FRAGMENT_MAIN_UV,e.get(ii.FRAGMENT_MAIN_UV)||"").replace(ii.FRAGMENT_MAIN_IMAGE,e.get(ii.FRAGMENT_MAIN_IMAGE)||""),this.vertexShader=Ci.replace(ii.VERTEX_HEAD,e.get(ii.VERTEX_HEAD)||"").replace(ii.VERTEX_MAIN_SUPPORT,e.get(ii.VERTEX_MAIN_SUPPORT)||""),this.needsUpdate=!0,this}setDefines(e){for(const t of e.entries())this.defines[t[0]]=t[1];return this.needsUpdate=!0,this}setUniforms(e){for(const t of e.entries())this.uniforms[t[0]]=t[1];return this}setExtensions(e){this.extensions={};for(const t of e)this.extensions[t]=!0;return this}get encodeOutput(){return void 0!==this.defines.ENCODE_OUTPUT}set encodeOutput(e){this.encodeOutput!==e&&(e?this.defines.ENCODE_OUTPUT="1":delete this.defines.ENCODE_OUTPUT,this.needsUpdate=!0)}isOutputEncodingEnabled(e){return this.encodeOutput}setOutputEncodingEnabled(e){this.encodeOutput=e}get time(){return this.uniforms.time.value}set time(e){this.uniforms.time.value=e}setDeltaTime(e){this.uniforms.time.value+=e}adoptCameraSettings(e){this.copyCameraSettings(e)}copyCameraSettings(e){e&&(this.uniforms.cameraNear.value=e.near,this.uniforms.cameraFar.value=e.far,e instanceof Z?this.defines.PERSPECTIVE_CAMERA="1":delete this.defines.PERSPECTIVE_CAMERA,this.needsUpdate=!0)}setSize(e,t){const n=this.uniforms;n.resolution.value.set(e,t),n.texelSize.value.set(1/e,1/t),n.aspect.value=e/t}static get Section(){return ii}};function Ri(e,t,n){for(const r of t){const t="$1"+e+r.charAt(0).toUpperCase()+r.slice(1),i=new RegExp("([^\\.])(\\b"+r+"\\b)","g");for(const e of n.entries())null!==e[1]&&n.set(e[0],e[1].replace(i,t))}}function Ui(e,t,n){let r=t.getFragmentShader(),i=t.getVertexShader();const o=void 0!==r&&/mainImage/.test(r),s=void 0!==r&&/mainUv/.test(r);if(n.attributes|=t.getAttributes(),void 0===r)throw new Error(`Missing fragment shader (${t.name})`);if(s&&0!==(n.attributes&ri))throw new Error(`Effects that transform UVs are incompatible with convolution effects (${t.name})`);if(!o&&!s)throw new Error(`Could not find mainImage or mainUv function (${t.name})`);{const a=/\w+\s+(\w+)\([\w\s,]*\)\s*{/g,u=n.shaderParts;let c=u.get(ii.FRAGMENT_HEAD)||"",l=u.get(ii.FRAGMENT_MAIN_UV)||"",h=u.get(ii.FRAGMENT_MAIN_IMAGE)||"",f=u.get(ii.VERTEX_HEAD)||"",p=u.get(ii.VERTEX_MAIN_SUPPORT)||"";const d=new Set,m=new Set;if(s&&(l+=`\t${e}MainUv(UV);\n`,n.uvTransformation=!0),null!==i&&/mainSupport/.test(i)){const t=/mainSupport *\([\w\s]*?uv\s*?\)/.test(i);p+=`\t${e}MainSupport(`,p+=t?"vUv);\n":");\n";for(const e of i.matchAll(/(?:varying\s+\w+\s+([\S\s]*?);)/g))for(const t of e[1].split(/\s*,\s*/))n.varyings.add(t),d.add(t),m.add(t);for(const e of i.matchAll(a))m.add(e[1])}for(const e of r.matchAll(a))m.add(e[1]);for(const e of t.defines.keys())m.add(e.replace(/\([\w\s,]*\)/g,""));for(const e of t.uniforms.keys())m.add(e);m.delete("while"),m.delete("for"),m.delete("if"),t.uniforms.forEach((t,r)=>n.uniforms.set(e+r.charAt(0).toUpperCase()+r.slice(1),t)),t.defines.forEach((t,r)=>n.defines.set(e+r.charAt(0).toUpperCase()+r.slice(1),t));const v=new Map([["fragment",r],["vertex",i]]);Ri(e,m,n.defines),Ri(e,m,v),r=v.get("fragment"),i=v.get("vertex");const g=t.blendMode;if(n.blendModes.set(g.blendFunction,g),o){null!==t.inputColorSpace&&t.inputColorSpace!==n.colorSpace&&(h+=t.inputColorSpace===S?"color0 = sRGBTransferOETF(color0);\n\t":"color0 = sRGBToLinear(color0);\n\t"),t.outputColorSpace!==V?n.colorSpace=t.outputColorSpace:null!==t.inputColorSpace&&(n.colorSpace=t.inputColorSpace);const i=/MainImage *\([\w\s,]*?depth[\w\s,]*?\)/;h+=`${e}MainImage(color0, UV, `,0!==(n.attributes&ni)&&i.test(r)&&(h+="depth, ",n.readDepth=!0),h+="color1);\n\t";const o=e+"BlendOpacity";n.uniforms.set(o,g.opacity),h+=`color0 = blend${g.blendFunction}(color0, color1, ${o});\n\n\t`,c+=`uniform float ${o};\n\n`}if(c+=r+"\n",null!==i&&(f+=i+"\n"),u.set(ii.FRAGMENT_HEAD,c),u.set(ii.FRAGMENT_MAIN_UV,l),u.set(ii.FRAGMENT_MAIN_IMAGE,h),u.set(ii.VERTEX_HEAD,f),u.set(ii.VERTEX_MAIN_SUPPORT,p),null!==t.extensions)for(const e of t.extensions)n.extensions.add(e)}}var Ii=class extends Wr{constructor(e,...t){super("EffectPass"),this.fullscreenMaterial=new Bi(null,null,null,e),this.listener=e=>this.handleEvent(e),this.effects=[],this.setEffects(t),this.skipRendering=!1,this.minTime=1,this.maxTime=Number.POSITIVE_INFINITY,this.timeScale=1}set mainScene(e){for(const t of this.effects)t.mainScene=e}set mainCamera(e){this.fullscreenMaterial.copyCameraSettings(e);for(const t of this.effects)t.mainCamera=e}get encodeOutput(){return this.fullscreenMaterial.encodeOutput}set encodeOutput(e){this.fullscreenMaterial.encodeOutput=e}get dithering(){return this.fullscreenMaterial.dithering}set dithering(e){const t=this.fullscreenMaterial;t.dithering=e,t.needsUpdate=!0}setEffects(e){for(const t of this.effects)t.removeEventListener("change",this.listener);this.effects=e.sort((e,t)=>t.attributes-e.attributes);for(const t of this.effects)t.addEventListener("change",this.listener)}updateMaterial(){const e=new oi;let t=0;for(const s of this.effects)if(s.blendMode.blendFunction===li)e.attributes|=s.getAttributes()&ni;else{if(0!==(e.attributes&s.getAttributes()&ri))throw new Error(`Convolution effects cannot be merged (${s.name})`);Ui("e"+t++,s,e)}let n=e.shaderParts.get(ii.FRAGMENT_HEAD),r=e.shaderParts.get(ii.FRAGMENT_MAIN_IMAGE),i=e.shaderParts.get(ii.FRAGMENT_MAIN_UV);const o=/\bblend\b/g;for(const s of e.blendModes.values())n+=s.getShaderCode().replace(o,`blend${s.blendFunction}`)+"\n";0!==(e.attributes&ni)?(e.readDepth&&(r="float depth = readDepth(UV);\n\n\t"+r),this.needsDepthTexture=null===this.getDepthTexture()):this.needsDepthTexture=!1,e.colorSpace===S&&(r+="color0 = sRGBToLinear(color0);\n\t"),e.uvTransformation?(i="vec2 transformedUv = vUv;\n"+i,e.defines.set("UV","transformedUv")):e.defines.set("UV","vUv"),e.shaderParts.set(ii.FRAGMENT_HEAD,n),e.shaderParts.set(ii.FRAGMENT_MAIN_IMAGE,r),e.shaderParts.set(ii.FRAGMENT_MAIN_UV,i);for(const[s,a]of e.shaderParts)null!==a&&e.shaderParts.set(s,a.trim().replace(/^#/,"\n#"));this.skipRendering=0===t,this.needsSwap=!this.skipRendering,this.fullscreenMaterial.setShaderData(e)}recompile(){this.updateMaterial()}getDepthTexture(){return this.fullscreenMaterial.depthBuffer}setDepthTexture(e,t=U){this.fullscreenMaterial.depthBuffer=e,this.fullscreenMaterial.depthPacking=t;for(const n of this.effects)n.setDepthTexture(e,t)}render(e,t,n,r,i){for(const o of this.effects)o.update(e,t,r);if(!this.skipRendering||this.renderToScreen){const i=this.fullscreenMaterial;i.inputBuffer=t.texture,i.time+=r*this.timeScale,e.setRenderTarget(this.renderToScreen?null:n),e.render(this.scene,this.camera)}}setSize(e,t){this.fullscreenMaterial.setSize(e,t);for(const n of this.effects)n.setSize(e,t)}initialize(e,t,n){this.renderer=e;for(const r of this.effects)r.initialize(e,t,n);this.updateMaterial(),void 0!==n&&n!==N&&(this.fullscreenMaterial.defines.FRAMEBUFFER_PRECISION_HIGH="1")}dispose(){super.dispose();for(const e of this.effects)e.removeEventListener("change",this.listener),e.dispose()}handleEvent(e){if("change"===e.type)this.recompile()}},ji=class extends Wr{constructor(e,t,{renderTarget:n,resolutionScale:r=1,width:i=ci.AUTO_SIZE,height:o=ci.AUTO_SIZE,resolutionX:s=i,resolutionY:a=o}={}){super("NormalPass"),this.needsSwap=!1,this.renderPass=new Di(e,t,new P);const u=this.renderPass;u.ignoreBackground=!0,u.skipShadowMapUpdate=!0;const c=u.getClearPass();c.overrideClearColor=new C(7829503),c.overrideClearAlpha=1,this.renderTarget=n,void 0===this.renderTarget&&(this.renderTarget=new _(1,1,{minFilter:B,magFilter:B}),this.renderTarget.texture.name="NormalPass.Target");const l=this.resolution=new ci(this,s,a,r);l.addEventListener("change",e=>this.setSize(l.baseWidth,l.baseHeight))}set mainScene(e){this.renderPass.mainScene=e}set mainCamera(e){this.renderPass.mainCamera=e}get texture(){return this.renderTarget.texture}getTexture(){return this.renderTarget.texture}getResolution(){return this.resolution}getResolutionScale(){return this.resolution.scale}setResolutionScale(e){this.resolution.scale=e}render(e,t,n,r,i){const o=this.renderToScreen?null:this.renderTarget;this.renderPass.render(e,o,o)}setSize(e,t){const n=this.resolution;n.setBaseSize(e,t),this.renderTarget.setSize(n.width,n.height)}};function Vi(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function Fi(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}new w,new w;var ki=function e(t,n,r){var i=this;Fi(this,e),Vi(this,"dot2",function(e,t){return i.x*e+i.y*t}),Vi(this,"dot3",function(e,t,n){return i.x*e+i.y*t+i.z*n}),this.x=t,this.y=n,this.z=r},Li=[new ki(1,1,0),new ki(-1,1,0),new ki(1,-1,0),new ki(-1,-1,0),new ki(1,0,1),new ki(-1,0,1),new ki(1,0,-1),new ki(-1,0,-1),new ki(0,1,1),new ki(0,-1,1),new ki(0,1,-1),new ki(0,-1,-1)],zi=[151,160,137,91,90,15,131,13,201,95,96,53,194,233,7,225,140,36,103,30,69,142,8,99,37,240,21,10,23,190,6,148,247,120,234,75,0,26,197,62,94,252,219,203,117,35,11,32,57,177,33,88,237,149,56,87,174,20,125,136,171,168,68,175,74,165,71,134,139,48,27,166,77,146,158,231,83,111,229,122,60,211,133,230,220,105,92,41,55,46,245,40,244,102,143,54,65,25,63,161,1,216,80,73,209,76,132,187,208,89,18,169,200,196,135,130,116,188,159,86,164,100,109,198,173,186,3,64,52,217,226,250,124,123,5,202,38,147,118,126,255,82,85,212,207,206,59,227,47,16,58,17,182,189,28,42,223,183,170,213,119,248,152,2,44,154,163,70,221,153,101,155,167,43,172,9,129,22,39,253,19,98,108,110,79,113,224,232,178,185,112,104,218,246,97,228,251,34,242,193,238,210,144,12,191,179,162,241,81,51,145,235,249,14,239,107,49,192,214,31,181,199,106,157,184,84,204,176,115,121,50,45,127,4,150,254,138,236,205,93,222,114,67,29,24,72,243,141,128,195,78,66,215,61,156,180],Hi=new Array(512),Xi=new Array(512);function Gi(e){var t=function(e){if("number"==typeof e)e=Math.abs(e);else if("string"==typeof e){var t=e;e=0;for(var n=0;n<t.length;n++)e=(e+(n+1)*(t.charCodeAt(n)%96))%2147483647}return 0===e&&(e=311),e}(e);return function(){var e=48271*t%2147483647;return t=e,e/2147483647}}!function(e){e>0&&e<1&&(e*=65536),(e=Math.floor(e))<256&&(e|=e<<8);for(var t=0;t<256;t++){var n;n=1&t?zi[t]^255&e:zi[t]^e>>8&255,Hi[t]=Hi[t+256]=n,Xi[t]=Xi[t+256]=Li[n%12]}}(0);new function e(t){var n=this;Fi(this,e),Vi(this,"seed",0),Vi(this,"init",function(e){n.seed=e,n.value=Gi(e)}),Vi(this,"value",Gi(this.seed)),this.init(t)}(Math.random());const Wi=o.createContext(null),Ji=e=>!(2&~e.getAttributes()),Yi=o.memo(o.forwardRef(({children:e,camera:t,scene:n,resolutionScale:r,enabled:i=!0,renderPriority:s=1,autoClear:a=!0,depthBuffer:u,enableNormalPass:c,stencilBuffer:l,multisampling:h=8,frameBufferType:f=re},p)=>{const{gl:d,scene:m,camera:v,size:g}=ne(),y=n||m,x=t||v,[b,E,w]=o.useMemo(()=>{const e=new ei(d,{depthBuffer:u,stencilBuffer:l,multisampling:h,frameBufferType:f});e.addPass(new Di(y,x));let t=null,n=null;return c&&(n=new ji(y,x),n.enabled=!1,e.addPass(n),void 0!==r&&(t=new Oi({normalBuffer:n.texture,resolutionScale:r}),t.enabled=!1,e.addPass(t))),[e,n,t]},[x,d,u,l,h,f,y,c,r]);o.useEffect(()=>b?.setSize(g.width,g.height),[b,g]),ie((e,t)=>{if(i){const e=d.autoClear;d.autoClear=a,l&&!a&&d.clearStencil(),b.render(t),d.autoClear=e}},i?s:0);const N=o.useRef(null);o.useLayoutEffect(()=>{const e=[],t=N.current.__r3f;if(t&&b){const n=t.children;for(let t=0;t<n.length;t++){const r=n[t].object;if(r instanceof mi){const i=[r];if(!Ji(r)){let e=null;for(;(e=n[t+1]?.object)instanceof mi&&!Ji(e);)i.push(e),t++}const o=new Ii(x,...i);e.push(o)}else r instanceof Wr&&e.push(r)}for(const t of e)b?.addPass(t);E&&(E.enabled=!0),w&&(w.enabled=!0)}return()=>{for(const t of e)b?.removePass(t);E&&(E.enabled=!1),w&&(w.enabled=!1)}},[b,e,x,E,w]),o.useEffect(()=>{const e=d.toneMapping;return d.toneMapping=oe,()=>{d.toneMapping=e}},[d]);const S=o.useMemo(()=>({composer:b,normalPass:E,downSamplingPass:w,resolutionScale:r,camera:x,scene:y}),[b,E,w,r,x,y]);return o.useImperativeHandle(p,()=>b,[b]),se.jsx(Wi.Provider,{value:S,children:se.jsx("group",{ref:N,children:e})})}));let $i=0;const qi=new WeakMap,Zi=(e,t)=>function({blendFunction:n=t?.blendFunction,opacity:r=t?.opacity,...i}){let o=qi.get(e);if(!o){const t=`@react-three/postprocessing/${e.name}-${$i++}`;ae({[t]:e}),qi.set(e,o=t)}const a=ne(e=>e.camera),u=s.useMemo(()=>[...t?.args??[],...i.args??[{...t,...i}]],[JSON.stringify(i)]);return se.jsx(o,{camera:a,"blendMode-blendFunction":n,"blendMode-opacity-value":r,...i,args:u})},Ki=Zi(Mi,{blendFunction:0}),Qi=Zi(Ai);const eo=3e3,to=[{name:"Reactive Particles",component:({audioRef:t})=>{const n=o.useRef(null),r=o.useRef(null),{positions:i,velocities:s}=o.useMemo(()=>{const e=new Float32Array(9e3),t=new Float32Array(9e3);for(let n=0;n<eo;n++){const r=Math.random()*Math.PI*2,i=Math.acos(2*Math.random()-1),o=1.5+2*Math.random();e[3*n]=o*Math.sin(i)*Math.cos(r),e[3*n+1]=o*Math.sin(i)*Math.sin(r),e[3*n+2]=o*Math.cos(i),t[3*n]=.02*(Math.random()-.5),t[3*n+1]=.02*(Math.random()-.5),t[3*n+2]=.02*(Math.random()-.5)}return{positions:e,velocities:t}},[]),a=o.useMemo(()=>({uTime:{value:0},uBass:{value:0},uMid:{value:0},uHigh:{value:0},uBeat:{value:0}}),[]);return ie(e=>{const i=t.current,o=r.current;if(!o)return;if(o.uniforms.uTime.value=e.clock.elapsedTime,i){const e=Math.min(1,2.5*(i.bassEnergy+i.subEnergy)),t=Math.min(1,3*i.midEnergy),n=Math.min(1,3*i.highEnergy);o.uniforms.uBass.value=e,o.uniforms.uMid.value=t,o.uniforms.uHigh.value=n,o.uniforms.uBeat.value=i.beat?1:.85*o.uniforms.uBeat.value}const a=n.current?.geometry;if(a){const e=a.attributes.position,t=e.array,n=o.uniforms.uBeat.value;for(let r=0;r<eo;r++){const e=3*r;t[e]+=s[e]*(1+3*n),t[e+1]+=s[e+1]*(1+3*n),t[e+2]+=s[e+2]*(1+3*n);const o=t[e],a=t[e+1],u=t[e+2],c=Math.sqrt(o*o+a*a+u*u),l=.015*(c-(2+3*(i?.bassEnergy||0)));t[e]-=o/c*l,t[e+1]-=a/c*l,t[e+2]-=u/c*l}e.needsUpdate=!0}}),e.jsxDEV("points",{ref:n,children:[e.jsxDEV("bufferGeometry",{children:e.jsxDEV("bufferAttribute",{attach:"attributes-position",args:[i,3]},void 0,!1,{fileName:"/Users/spot/Code/DEViLBOX/src/components/vj/scenes/ReactiveParticles.tsx",lineNumber:88,columnNumber:9},void 0)},void 0,!1,{fileName:"/Users/spot/Code/DEViLBOX/src/components/vj/scenes/ReactiveParticles.tsx",lineNumber:87,columnNumber:7},void 0),e.jsxDEV("shaderMaterial",{ref:r,uniforms:a,vertexShader:"\n          uniform float uTime;\n          uniform float uBass;\n          uniform float uBeat;\n          varying float vLife;\n          void main() {\n            vec4 mvPos = modelViewMatrix * vec4(position, 1.0);\n            float dist = length(position);\n            vLife = 1.0 - smoothstep(1.0, 4.0, dist);\n            gl_PointSize = (4.0 + uBass * 8.0 + uBeat * 4.0) * (300.0 / -mvPos.z);\n            gl_Position = projectionMatrix * mvPos;\n          }\n        ",fragmentShader:"\n          uniform float uTime;\n          uniform float uBass;\n          uniform float uMid;\n          uniform float uHigh;\n          varying float vLife;\n          void main() {\n            float d = length(gl_PointCoord - 0.5) * 2.0;\n            if (d > 1.0) discard;\n            float alpha = smoothstep(1.0, 0.3, d) * vLife;\n            vec3 col = vec3(\n              0.2 + uBass * 0.8,\n              0.3 + uMid * 0.7,\n              0.8 + uHigh * 0.2\n            );\n            gl_FragColor = vec4(col, alpha * 0.8);\n          }\n        ",transparent:!0,depthWrite:!1,blending:ue},void 0,!1,{fileName:"/Users/spot/Code/DEViLBOX/src/components/vj/scenes/ReactiveParticles.tsx",lineNumber:93,columnNumber:7},void 0)]},void 0,!0,{fileName:"/Users/spot/Code/DEViLBOX/src/components/vj/scenes/ReactiveParticles.tsx",lineNumber:86,columnNumber:5},void 0)},category:"Particles",description:"Audio-reactive particle cloud"},{name:"Audio Terrain",component:({audioRef:t})=>{const n=o.useRef(null),r=o.useRef(null),i=o.useMemo(()=>{const e=new ce(20,40,79,158);return e.rotateX(-Math.PI/2),e},[]),s=o.useMemo(()=>({uTime:{value:0},uBass:{value:0},uMid:{value:0},uHigh:{value:0},uBeat:{value:0},uColor1:{value:new C(26367)},uColor2:{value:new C(16711782)}}),[]);return ie(e=>{const n=t.current,i=r.current;if(i){if(i.uniforms.uTime.value=e.clock.elapsedTime,n){const e=Math.min(1,2.5*(n.bassEnergy+n.subEnergy)),t=Math.min(1,3*n.midEnergy),r=Math.min(1,3*n.highEnergy);i.uniforms.uBass.value+=.3*(e-i.uniforms.uBass.value),i.uniforms.uMid.value+=.3*(t-i.uniforms.uMid.value),i.uniforms.uHigh.value+=.3*(r-i.uniforms.uHigh.value),i.uniforms.uBeat.value=n.beat?1:.88*i.uniforms.uBeat.value}e.camera.position.z=2*Math.sin(.2*e.clock.elapsedTime)-5,e.camera.position.y=3+4*(n?.bassEnergy||0),e.camera.lookAt(0,0,5)}}),e.jsxDEV("mesh",{ref:n,geometry:i,children:e.jsxDEV("shaderMaterial",{ref:r,uniforms:s,vertexShader:"\n          uniform float uTime;\n          uniform float uBass;\n          uniform float uMid;\n          uniform float uHigh;\n          uniform float uBeat;\n          varying float vHeight;\n          varying vec2 vUv;\n          \n          float noise(vec2 p) {\n            return sin(p.x * 1.0 + uTime) * cos(p.y * 0.8 - uTime * 0.7);\n          }\n          \n          void main() {\n            vUv = uv;\n            vec3 pos = position;\n            \n            // Bass: large rolling waves\n            float bass = sin(pos.z * 0.5 + uTime * 2.0) * uBass * 4.0;\n            bass += cos(pos.x * 0.3 + uTime) * uBass * 2.0;\n            \n            // Mid: medium detail\n            float mid = noise(pos.xz * 0.5) * uMid * 2.5;\n            \n            // High: fine shimmer\n            float high = sin(pos.x * 3.0 + pos.z * 2.0 + uTime * 4.0) * uHigh * 0.8;\n            \n            // Beat: pulse\n            float beat = sin(length(pos.xz) * 2.0 - uTime * 6.0) * uBeat * 1.5;\n            \n            pos.y += bass + mid + high + beat;\n            vHeight = pos.y;\n            \n            gl_Position = projectionMatrix * modelViewMatrix * vec4(pos, 1.0);\n          }\n        ",fragmentShader:"\n          uniform float uTime;\n          uniform float uBass;\n          uniform float uBeat;\n          uniform vec3 uColor1;\n          uniform vec3 uColor2;\n          varying float vHeight;\n          varying vec2 vUv;\n          \n          void main() {\n            // Grid lines\n            vec2 grid = abs(fract(vUv * 40.0) - 0.5);\n            float line = smoothstep(0.02, 0.0, min(grid.x, grid.y));\n            \n            // Height-based coloring\n            float h = clamp(vHeight * 0.3 + 0.5, 0.0, 1.0);\n            vec3 col = mix(uColor1, uColor2, h);\n            \n            // Wire + glow\n            vec3 wire = col * (0.3 + line * 0.7);\n            wire += col * line * (0.5 + uBeat * 0.5);\n            \n            float alpha = 0.3 + line * 0.7;\n            gl_FragColor = vec4(wire, alpha);\n          }\n        ",transparent:!0,side:X,wireframe:!1},void 0,!1,{fileName:"/Users/spot/Code/DEViLBOX/src/components/vj/scenes/AudioTerrain.tsx",lineNumber:60,columnNumber:7},void 0)},void 0,!1,{fileName:"/Users/spot/Code/DEViLBOX/src/components/vj/scenes/AudioTerrain.tsx",lineNumber:59,columnNumber:5},void 0)},category:"Landscape",description:"Frequency-driven terrain mesh"},{name:"Wireframe Sphere",component:({audioRef:t})=>{const n=o.useRef(null),r=o.useRef(null),i=o.useMemo(()=>new le(1.5,4),[]),s=o.useMemo(()=>({uTime:{value:0},uBass:{value:0},uMid:{value:0},uHigh:{value:0},uBeat:{value:0}}),[]);return ie(e=>{const i=t.current,o=r.current,s=n.current;if(o&&s&&(o.uniforms.uTime.value=e.clock.elapsedTime,s.rotation.y=.15*e.clock.elapsedTime,s.rotation.x=.2*Math.sin(.1*e.clock.elapsedTime),i)){const e=Math.min(1,2.5*(i.bassEnergy+i.subEnergy)),t=Math.min(1,3*i.midEnergy),n=Math.min(1,3*i.highEnergy);o.uniforms.uBass.value+=.4*(e-o.uniforms.uBass.value),o.uniforms.uMid.value+=.4*(t-o.uniforms.uMid.value),o.uniforms.uHigh.value+=.4*(n-o.uniforms.uHigh.value),o.uniforms.uBeat.value=i.beat?1:.85*o.uniforms.uBeat.value}}),e.jsxDEV("mesh",{ref:n,geometry:i,children:e.jsxDEV("shaderMaterial",{ref:r,uniforms:s,vertexShader:"\n          uniform float uTime;\n          uniform float uBass;\n          uniform float uMid;\n          uniform float uBeat;\n          varying vec3 vNormal;\n          varying float vDisplacement;\n          \n          void main() {\n            vNormal = normal;\n            \n            // Bass: breathing\n            float breath = 1.0 + uBass * 0.8 + uBeat * 0.5;\n            \n            // Mid: vertex displacement\n            float disp = sin(position.x * 3.0 + uTime * 2.0) * \n                         cos(position.y * 2.0 - uTime * 1.5) * \n                         sin(position.z * 2.5 + uTime) * uMid * 0.8;\n            \n            vec3 pos = position * breath + normal * disp;\n            vDisplacement = disp;\n            \n            gl_Position = projectionMatrix * modelViewMatrix * vec4(pos, 1.0);\n          }\n        ",fragmentShader:"\n          uniform float uTime;\n          uniform float uBass;\n          uniform float uMid;\n          uniform float uHigh;\n          uniform float uBeat;\n          varying vec3 vNormal;\n          varying float vDisplacement;\n          \n          void main() {\n            vec3 n = normalize(vNormal);\n            float fresnel = pow(1.0 - abs(dot(n, vec3(0.0, 0.0, 1.0))), 2.0);\n            \n            vec3 col = vec3(\n              0.1 + fresnel * 0.5 + uBass * 0.6,\n              0.2 + fresnel * 0.3 + uMid * 0.7,\n              0.8 + fresnel * 0.2 + uHigh * 0.4\n            );\n            \n            col += vec3(0.3, 0.1, 0.5) * abs(vDisplacement) * 5.0;\n            col += vec3(1.0) * uBeat * fresnel * 0.8;\n            \n            gl_FragColor = vec4(col, 0.7 + fresnel * 0.3);\n          }\n        ",transparent:!0,wireframe:!0,side:X},void 0,!1,{fileName:"/Users/spot/Code/DEViLBOX/src/components/vj/scenes/WireframeSphere.tsx",lineNumber:49,columnNumber:7},void 0)},void 0,!1,{fileName:"/Users/spot/Code/DEViLBOX/src/components/vj/scenes/WireframeSphere.tsx",lineNumber:48,columnNumber:5},void 0)},category:"Geometry",description:"Pulsing wireframe icosphere"}],no=({sceneIdx:t})=>{const n=function(){const e=o.useRef(null),t=o.useRef(null);return o.useMemo(()=>{const t=new ge;t.enable(),e.current=t},[]),o.useEffect(()=>()=>e.current?.disable(),[]),ie(()=>{const n=e.current;n&&(n.update(),t.current=n.getFrame())}),t}(),r=to[t]?.component;return r?e.jsxDEV(r,{audioRef:n},void 0,!1,{fileName:"/Users/spot/Code/DEViLBOX/src/components/vj/ThreeCanvas.tsx",lineNumber:50,columnNumber:10},void 0):null},ro=()=>e.jsxDEV(Yi,{children:[e.jsxDEV(Ki,{intensity:.8,luminanceThreshold:.3,luminanceSmoothing:.9,mipmapBlur:!0},void 0,!1,{fileName:"/Users/spot/Code/DEViLBOX/src/components/vj/ThreeCanvas.tsx",lineNumber:55,columnNumber:5},void 0),e.jsxDEV(Qi,{blendFunction:hi,offset:new w(.001,.001)},void 0,!1,{fileName:"/Users/spot/Code/DEViLBOX/src/components/vj/ThreeCanvas.tsx",lineNumber:61,columnNumber:5},void 0)]},void 0,!0,{fileName:"/Users/spot/Code/DEViLBOX/src/components/vj/ThreeCanvas.tsx",lineNumber:54,columnNumber:3},void 0),io=s.forwardRef(({onReady:t,onSceneChange:n},r)=>{const[i,a]=o.useState(0),u=o.useRef(0);s.useEffect(()=>{t?.(to.length),to.length>0&&n?.(0,to[0].name)},[]);const c=o.useCallback(e=>{const t=(e%to.length+to.length)%to.length;a(t),u.current=t,n?.(t,to[t].name)},[n]);return s.useImperativeHandle(r,()=>({nextScene:()=>c(u.current+1),prevScene:()=>c(u.current-1),randomScene:()=>c(Math.floor(Math.random()*to.length)),loadSceneByIndex:c,getSceneNames:()=>to.map(e=>e.name),getCurrentIndex:()=>u.current}),[c]),e.jsxDEV(he,{gl:{antialias:!0,alpha:!0,toneMapping:fe,toneMappingExposure:1.5},camera:{position:[0,2,6],fov:60,near:.1,far:100},style:{width:"100%",height:"100%"},children:[e.jsxDEV("color",{attach:"background",args:["#000000"]},void 0,!1,{fileName:"/Users/spot/Code/DEViLBOX/src/components/vj/ThreeCanvas.tsx",lineNumber:105,columnNumber:9},void 0),e.jsxDEV("ambientLight",{intensity:.15},void 0,!1,{fileName:"/Users/spot/Code/DEViLBOX/src/components/vj/ThreeCanvas.tsx",lineNumber:106,columnNumber:9},void 0),e.jsxDEV(o.Suspense,{fallback:null,children:[e.jsxDEV(no,{sceneIdx:i},void 0,!1,{fileName:"/Users/spot/Code/DEViLBOX/src/components/vj/ThreeCanvas.tsx",lineNumber:108,columnNumber:11},void 0),e.jsxDEV(ro,{},void 0,!1,{fileName:"/Users/spot/Code/DEViLBOX/src/components/vj/ThreeCanvas.tsx",lineNumber:109,columnNumber:11},void 0)]},void 0,!0,{fileName:"/Users/spot/Code/DEViLBOX/src/components/vj/ThreeCanvas.tsx",lineNumber:107,columnNumber:9},void 0)]},void 0,!0,{fileName:"/Users/spot/Code/DEViLBOX/src/components/vj/ThreeCanvas.tsx",lineNumber:100,columnNumber:7},void 0)});io.displayName="ThreeCanvas";const oo=s.lazy(()=>t(()=>import("./ProjectMCanvas-NshNQJSi.js"),__vite__mapDeps([6,7,1,8,9,10,11,12])).then(e=>({default:e.ProjectMCanvas})));let so=null,ao=null,uo=null;const co=s.forwardRef(({onReady:n,onPresetChange:r},i)=>{const c=o.useRef(null),l=o.useRef(null),h=o.useRef(null),f=o.useRef(0),p=o.useRef([]),d=o.useRef({}),m=o.useRef(0),[v,g]=o.useState(!1);o.useEffect(()=>{let e=!1;const i=c.current;if(!i)return;const o=requestAnimationFrame(()=>{e||async function(){try{const{butterchurn:o,presetMap:s,presetNames:c}=await async function(){if(so&&ao)return{butterchurn:so,presetMap:ao,presetNames:uo};const[e,n,r,i,o,s]=await Promise.all([t(()=>import("./butterchurn-3HiArFCr.js").then(e=>e.b),__vite__mapDeps([13,1])),t(()=>import("./butterchurnPresets.min-PxHmGQ2o.js").then(e=>e.b),__vite__mapDeps([0,1])),t(()=>import("./butterchurnPresetsExtra.min-_dM_8pan.js").then(e=>e.b),__vite__mapDeps([2,1])),t(()=>import("./butterchurnPresetsExtra2.min-B_0laeXG.js").then(e=>e.b),__vite__mapDeps([3,1])),t(()=>import("./butterchurnPresetsMD1.min-BxPUNh2X.js").then(e=>e.b),__vite__mapDeps([4,1])),t(()=>import("./butterchurnPresetsNonMinimal.min-Bkg1LL3W.js").then(e=>e.b),__vite__mapDeps([5,1]))]);so=e.default||e;const a={};for(const t of[n,r,i,o,s]){const e=t.default||t,n="function"==typeof e.getPresets?e.getPresets():e;Object.assign(a,n)}return ao=a,uo=Object.keys(a).sort(),{butterchurn:so,presetMap:a,presetNames:uo}}();if(e||!i)return;const f=Math.max(i.clientWidth,320),v=Math.max(i.clientHeight,240),y=Math.round(f*devicePixelRatio),x=Math.round(v*devicePixelRatio);i.width=y,i.height=x;const b=a().rawContext,E=o.createVisualizer(b,i,{width:y,height:x,pixelRatio:devicePixelRatio}),w=u(),N=w.output?.input||w._gainNode||w.input;N&&E.connectAudio(N),p.current=c,d.current=s;const S=Math.floor(Math.random()*c.length);E.loadPreset(s[c[S]],0),m.current=S,l.current=E,g(!0),n?.(c.length),r?.(S,c[S]);const T=new ge;T.enable(),h.current=T}catch(o){}}()});return()=>{e=!0,cancelAnimationFrame(o)}},[]),o.useEffect(()=>{if(!v)return;const e=()=>{l.current?.render(),h.current?.update(),f.current=requestAnimationFrame(e)};return f.current=requestAnimationFrame(e),()=>cancelAnimationFrame(f.current)},[v]),o.useEffect(()=>{const e=c.current;if(!e||!l.current)return;const t=()=>{const t=Math.round(Math.max(e.clientWidth,320)*devicePixelRatio),n=Math.round(Math.max(e.clientHeight,240)*devicePixelRatio);e.width=t,e.height=n,l.current?.setRendererSize(t,n)};t();const n=new ResizeObserver(t);return n.observe(e),()=>n.disconnect()},[v]),o.useEffect(()=>()=>{h.current?.disable(),cancelAnimationFrame(f.current)},[]);const y=o.useCallback((e,t=2)=>{if(!l.current)return;const n=p.current,i=d.current;if(0===n.length)return;const o=n[e],s=i[o];s&&(l.current.loadPreset(s,t),m.current=e,r?.(e,o))},[r]),x=o.useCallback((e,t=2)=>{if(!l.current)return;const n=d.current[e];if(n){const i=p.current.indexOf(e);l.current.loadPreset(n,t),m.current=i>=0?i:m.current,r?.(m.current,e)}},[r]);return s.useImperativeHandle(i,()=>({nextPreset:()=>{const e=p.current;0!==e.length&&y((m.current+1)%e.length)},randomPreset:()=>{const e=p.current;0!==e.length&&y(Math.floor(Math.random()*e.length))},loadPresetByIndex:(e,t)=>y(e,t),loadPresetByName:(e,t)=>x(e,t),getPresetNames:()=>p.current,getCurrentIndex:()=>m.current}),[y,x]),e.jsxDEV(e.Fragment,{children:[e.jsxDEV("canvas",{ref:c,className:"w-full h-full block",style:{imageRendering:"auto"}},void 0,!1,{fileName:"/Users/spot/Code/DEViLBOX/src/components/vj/VJView.tsx",lineNumber:243,columnNumber:9},void 0),!v&&e.jsxDEV("div",{className:"absolute inset-0 flex items-center justify-center bg-black",children:e.jsxDEV("div",{className:"text-white/60 font-mono text-sm",children:"Loading Milkdrop visualizer..."},void 0,!1,{fileName:"/Users/spot/Code/DEViLBOX/src/components/vj/VJView.tsx",lineNumber:250,columnNumber:13},void 0)},void 0,!1,{fileName:"/Users/spot/Code/DEViLBOX/src/components/vj/VJView.tsx",lineNumber:249,columnNumber:11},void 0)]},void 0,!0,{fileName:"/Users/spot/Code/DEViLBOX/src/components/vj/VJView.tsx",lineNumber:242,columnNumber:7},void 0)});co.displayName="VJCanvas";const lo=({currentName:t,currentIdx:i,totalPresets:s,autoAdvance:a,isPopout:u,activeLayer:c,onNext:l,onRandom:h,onToggleAutoAdvance:f,onPopOut:E,onToggleBrowser:w,onSwitchLayer:N,onFullscreen:S,isFullscreen:T,browserOpen:M})=>{const[A,D]=o.useState(!0),_=o.useRef(void 0),O=o.useCallback(()=>{D(!0),_.current&&clearTimeout(_.current),_.current=setTimeout(()=>D(!1),3e3)},[]);return e.jsxDEV("div",{className:"absolute inset-0 pointer-events-none z-10",onMouseMove:O,onMouseLeave:()=>D(!1),style:{pointerEvents:"none"},children:e.jsxDEV("div",{className:"absolute inset-0 transition-opacity duration-500 "+(A?"opacity-100":"opacity-0"),children:[e.jsxDEV("div",{className:"absolute top-0 left-0 right-0 pointer-events-auto bg-gradient-to-b from-black/70 to-transparent p-4",children:e.jsxDEV("div",{className:"flex items-center justify-between",children:[e.jsxDEV("div",{className:"flex items-center gap-2 flex-1 mr-4 min-w-0",children:[e.jsxDEV("select",{value:"vj",onChange:e=>{const t=e.target.value;if("vj"!==t){if("dj"!==t){const{decks:t}=n.getState();if((t.A.isPlaying||t.B.isPlaying||t.C.isPlaying)&&!window.confirm("Audio is playing. Switch view? This will stop DJ playback."))return void(e.target.value="vj")}r.getState().setActiveView(t)}},className:"px-2 py-0.5 text-[10px] font-bold tracking-widest uppercase bg-white/10 text-white border border-white/20 rounded hover:bg-white/20 transition-colors cursor-pointer flex-shrink-0",title:"Switch view",children:[e.jsxDEV("option",{value:"tracker",children:"Tracker"},void 0,!1,{fileName:"/Users/spot/Code/DEViLBOX/src/components/vj/VJView.tsx",lineNumber:346,columnNumber:17},void 0),e.jsxDEV("option",{value:"grid",children:"Grid"},void 0,!1,{fileName:"/Users/spot/Code/DEViLBOX/src/components/vj/VJView.tsx",lineNumber:347,columnNumber:17},void 0),e.jsxDEV("option",{value:"pianoroll",children:"Piano Roll"},void 0,!1,{fileName:"/Users/spot/Code/DEViLBOX/src/components/vj/VJView.tsx",lineNumber:348,columnNumber:17},void 0),e.jsxDEV("option",{value:"tb303",children:"TB-303"},void 0,!1,{fileName:"/Users/spot/Code/DEViLBOX/src/components/vj/VJView.tsx",lineNumber:349,columnNumber:17},void 0),e.jsxDEV("option",{value:"arrangement",children:"Arrangement"},void 0,!1,{fileName:"/Users/spot/Code/DEViLBOX/src/components/vj/VJView.tsx",lineNumber:350,columnNumber:17},void 0),e.jsxDEV("option",{value:"dj",children:"DJ Mixer"},void 0,!1,{fileName:"/Users/spot/Code/DEViLBOX/src/components/vj/VJView.tsx",lineNumber:351,columnNumber:17},void 0),e.jsxDEV("option",{value:"drumpad",children:"Drum Pads"},void 0,!1,{fileName:"/Users/spot/Code/DEViLBOX/src/components/vj/VJView.tsx",lineNumber:352,columnNumber:17},void 0),e.jsxDEV("option",{value:"vj",children:"VJ View"},void 0,!1,{fileName:"/Users/spot/Code/DEViLBOX/src/components/vj/VJView.tsx",lineNumber:353,columnNumber:17},void 0)]},void 0,!0,{fileName:"/Users/spot/Code/DEViLBOX/src/components/vj/VJView.tsx",lineNumber:326,columnNumber:15},void 0),N&&e.jsxDEV("div",{className:"flex items-center gap-1 flex-shrink-0",children:[e.jsxDEV("button",{onClick:()=>N("milkdrop"),className:"px-2 py-0.5 text-[10px] rounded transition-colors "+("milkdrop"===c?"bg-accent/60 text-white":"bg-white/10 text-white/50 hover:text-white/80"),children:"Milkdrop"},void 0,!1,{fileName:"/Users/spot/Code/DEViLBOX/src/components/vj/VJView.tsx",lineNumber:357,columnNumber:19},void 0),e.jsxDEV("button",{onClick:()=>N("isf"),className:"px-2 py-0.5 text-[10px] rounded transition-colors "+("isf"===c?"bg-accent/60 text-white":"bg-white/10 text-white/50 hover:text-white/80"),children:"ISF"},void 0,!1,{fileName:"/Users/spot/Code/DEViLBOX/src/components/vj/VJView.tsx",lineNumber:365,columnNumber:19},void 0),e.jsxDEV("button",{onClick:()=>N("three"),className:"px-2 py-0.5 text-[10px] rounded transition-colors "+("three"===c?"bg-accent/60 text-white":"bg-white/10 text-white/50 hover:text-white/80"),children:"3D"},void 0,!1,{fileName:"/Users/spot/Code/DEViLBOX/src/components/vj/VJView.tsx",lineNumber:373,columnNumber:19},void 0),e.jsxDEV("button",{onClick:()=>N("projectm"),className:"px-2 py-0.5 text-[10px] rounded transition-colors "+("projectm"===c?"bg-accent/60 text-white":"bg-white/10 text-white/50 hover:text-white/80"),children:"projectM"},void 0,!1,{fileName:"/Users/spot/Code/DEViLBOX/src/components/vj/VJView.tsx",lineNumber:381,columnNumber:19},void 0)]},void 0,!0,{fileName:"/Users/spot/Code/DEViLBOX/src/components/vj/VJView.tsx",lineNumber:356,columnNumber:17},void 0),e.jsxDEV("div",{className:"text-white/90 text-sm font-mono truncate",children:t},void 0,!1,{fileName:"/Users/spot/Code/DEViLBOX/src/components/vj/VJView.tsx",lineNumber:391,columnNumber:15},void 0)]},void 0,!0,{fileName:"/Users/spot/Code/DEViLBOX/src/components/vj/VJView.tsx",lineNumber:324,columnNumber:13},void 0),e.jsxDEV("div",{className:"text-white/50 text-xs font-mono",children:s>0?`${i+1} / ${s}`:"—"},void 0,!1,{fileName:"/Users/spot/Code/DEViLBOX/src/components/vj/VJView.tsx",lineNumber:395,columnNumber:13},void 0)]},void 0,!0,{fileName:"/Users/spot/Code/DEViLBOX/src/components/vj/VJView.tsx",lineNumber:323,columnNumber:11},void 0)},void 0,!1,{fileName:"/Users/spot/Code/DEViLBOX/src/components/vj/VJView.tsx",lineNumber:322,columnNumber:9},void 0),e.jsxDEV("div",{className:"absolute bottom-0 left-0 right-0 pointer-events-auto bg-gradient-to-t from-black/70 to-transparent p-4",children:e.jsxDEV("div",{className:"flex items-center justify-center gap-3",children:[e.jsxDEV("button",{onClick:h,className:"p-2 rounded-full bg-white/10 hover:bg-white/20 text-white transition-colors",title:"Random preset",children:e.jsxDEV(p,{size:18},void 0,!1,{fileName:"/Users/spot/Code/DEViLBOX/src/components/vj/VJView.tsx",lineNumber:409,columnNumber:15},void 0)},void 0,!1,{fileName:"/Users/spot/Code/DEViLBOX/src/components/vj/VJView.tsx",lineNumber:404,columnNumber:13},void 0),e.jsxDEV("button",{onClick:f,className:"p-2 rounded-full transition-colors text-white "+(a?"bg-green-600/50 hover:bg-green-600/70":"bg-white/10 hover:bg-white/20"),title:a?"Pause auto-advance":"Resume auto-advance",children:a?e.jsxDEV(d,{size:18},void 0,!1,{fileName:"/Users/spot/Code/DEViLBOX/src/components/vj/VJView.tsx",lineNumber:419,columnNumber:30},void 0):e.jsxDEV(m,{size:18},void 0,!1,{fileName:"/Users/spot/Code/DEViLBOX/src/components/vj/VJView.tsx",lineNumber:419,columnNumber:52},void 0)},void 0,!1,{fileName:"/Users/spot/Code/DEViLBOX/src/components/vj/VJView.tsx",lineNumber:412,columnNumber:13},void 0),e.jsxDEV("button",{onClick:l,className:"p-2 rounded-full bg-white/10 hover:bg-white/20 text-white transition-colors",title:"Next preset",children:e.jsxDEV(v,{size:18},void 0,!1,{fileName:"/Users/spot/Code/DEViLBOX/src/components/vj/VJView.tsx",lineNumber:427,columnNumber:15},void 0)},void 0,!1,{fileName:"/Users/spot/Code/DEViLBOX/src/components/vj/VJView.tsx",lineNumber:422,columnNumber:13},void 0),w&&e.jsxDEV("button",{onClick:w,className:"p-2 rounded-full transition-colors text-white "+(M?"bg-accent/50 hover:bg-accent/70":"bg-white/10 hover:bg-white/20"),title:"Browse presets",children:e.jsxDEV(g,{size:18},void 0,!1,{fileName:"/Users/spot/Code/DEViLBOX/src/components/vj/VJView.tsx",lineNumber:438,columnNumber:17},void 0)},void 0,!1,{fileName:"/Users/spot/Code/DEViLBOX/src/components/vj/VJView.tsx",lineNumber:431,columnNumber:15},void 0),!u&&E&&e.jsxDEV("button",{onClick:E,className:"p-2 rounded-full bg-white/10 hover:bg-white/20 text-white transition-colors",title:"Pop out to second screen",children:e.jsxDEV(y,{size:18},void 0,!1,{fileName:"/Users/spot/Code/DEViLBOX/src/components/vj/VJView.tsx",lineNumber:448,columnNumber:17},void 0)},void 0,!1,{fileName:"/Users/spot/Code/DEViLBOX/src/components/vj/VJView.tsx",lineNumber:443,columnNumber:15},void 0),S&&e.jsxDEV("button",{onClick:S,className:"p-2 rounded-full bg-white/10 hover:bg-white/20 text-white transition-colors",title:T?"Exit fullscreen":"Fullscreen",children:T?e.jsxDEV(x,{size:18},void 0,!1,{fileName:"/Users/spot/Code/DEViLBOX/src/components/vj/VJView.tsx",lineNumber:458,columnNumber:33},void 0):e.jsxDEV(b,{size:18},void 0,!1,{fileName:"/Users/spot/Code/DEViLBOX/src/components/vj/VJView.tsx",lineNumber:458,columnNumber:58},void 0)},void 0,!1,{fileName:"/Users/spot/Code/DEViLBOX/src/components/vj/VJView.tsx",lineNumber:453,columnNumber:15},void 0)]},void 0,!0,{fileName:"/Users/spot/Code/DEViLBOX/src/components/vj/VJView.tsx",lineNumber:403,columnNumber:11},void 0)},void 0,!1,{fileName:"/Users/spot/Code/DEViLBOX/src/components/vj/VJView.tsx",lineNumber:402,columnNumber:9},void 0)]},void 0,!0,{fileName:"/Users/spot/Code/DEViLBOX/src/components/vj/VJView.tsx",lineNumber:316,columnNumber:7},void 0)},void 0,!1,{fileName:"/Users/spot/Code/DEViLBOX/src/components/vj/VJView.tsx",lineNumber:309,columnNumber:5},void 0)},ho=({isPopout:t=!1})=>{const n=o.useRef(null),a=o.useRef(null),u=o.useRef(null),c=o.useRef(null),[l,h]=o.useState("milkdrop"),[f,p]=o.useState("Loading..."),[d,m]=o.useState(0),[v,g]=o.useState(0),[y,x]=o.useState(!0),[b,E]=o.useState(!1),w=o.useRef(void 0),N=o.useRef(null),[S,T]=o.useState(!1),M=o.useRef(null),A=o.useRef(null),D=o.useRef(0);o.useEffect(()=>{const e=new ge;e.enable(),M.current=e;const t=A.current;if(!t)return;const n=t.getContext("2d");if(!n)return;const r=()=>{const i=e.update(),o=t.width,s=t.height;n.fillStyle="rgba(0,0,0,0.7)",n.fillRect(0,0,o,s);const a=[{label:"SUB",val:i.subEnergy,color:"#f44"},{label:"BASS",val:i.bassEnergy,color:"#f80"},{label:"MID",val:i.midEnergy,color:"#ff0"},{label:"HIGH",val:i.highEnergy,color:"#0f8"},{label:"RMS",val:i.rms,color:"#08f"},{label:"PEAK",val:i.peak,color:"#f0f"}],u=(o-8)/a.length;n.font="9px monospace",n.textAlign="center";for(let e=0;e<a.length;e++){const t=4+e*u,r=Math.min(1,a[e].val)*(s-14);n.fillStyle=a[e].color,n.fillRect(t+1,s-2-r,u-2,r),n.fillStyle="#fff",n.fillText(a[e].label,t+u/2,10)}i.beat&&(n.fillStyle="#fff",n.fillRect(0,0,4,s)),D.current=requestAnimationFrame(r)};return D.current=requestAnimationFrame(r),()=>{cancelAnimationFrame(D.current),e.disable()}},[]);const _=o.useCallback(()=>{const e=N.current;e&&(document.fullscreenElement?document.exitFullscreen():e.requestFullscreen().catch(()=>{}))},[]);o.useEffect(()=>{const e=()=>T(!!document.fullscreenElement);return document.addEventListener("fullscreenchange",e),()=>document.removeEventListener("fullscreenchange",e)},[]);const[O,P]=o.useState(""),[C,B]=o.useState(0),[R,U]=o.useState(0),[I,j]=o.useState(""),[V,F]=o.useState(0),[k,L]=o.useState(0),[z,H]=o.useState(""),[X,G]=o.useState(0),[W,J]=o.useState(0),Y="milkdrop"===l?f:"isf"===l?O:"projectm"===l?z:I,$="milkdrop"===l?d:"isf"===l?C:"projectm"===l?X:V,q="milkdrop"===l?v:"isf"===l?R:"projectm"===l?W:k,Z=o.useCallback((e,t)=>{m(e),p(t)},[]),K=o.useCallback(e=>{g(e)},[]);o.useEffect(()=>{if(!y)return;if(0===("milkdrop"===l?v:"isf"===l?R:"projectm"===l?W:k))return;const e=()=>{"milkdrop"===l?n.current?.nextPreset():"isf"===l?a.current?.nextPreset():"projectm"===l?c.current?.nextPreset():u.current?.nextScene(),w.current=setTimeout(e,15e3+15e3*Math.random())};return w.current=setTimeout(e,15e3+15e3*Math.random()),()=>{w.current&&clearTimeout(w.current)}},[y,v,R,k,W,l]);const Q=o.useCallback(()=>{const e=r.getState();e.vjPoppedOut?i("DEViLBOX — VJ"):e.setVJPoppedOut(!0)},[]),ee=o.useCallback((e,t)=>{n.current?.loadPresetByName(e,1.5),h("milkdrop")},[]),te=o.useCallback(()=>{"milkdrop"===l?n.current?.nextPreset():"isf"===l?a.current?.nextPreset():"projectm"===l?c.current?.nextPreset():u.current?.nextScene()},[l]),ne=o.useCallback(()=>{"milkdrop"===l?n.current?.randomPreset():"isf"===l?a.current?.randomPreset():"projectm"===l?c.current?.randomPreset():u.current?.randomScene()},[l]);return e.jsxDEV("div",{ref:N,className:"relative w-full h-full bg-black overflow-hidden",children:[e.jsxDEV("div",{className:"absolute inset-0 "+("milkdrop"===l?"":"hidden"),children:e.jsxDEV(co,{ref:n,onReady:K,onPresetChange:Z},void 0,!1,{fileName:"/Users/spot/Code/DEViLBOX/src/components/vj/VJView.tsx",lineNumber:637,columnNumber:9},void 0)},void 0,!1,{fileName:"/Users/spot/Code/DEViLBOX/src/components/vj/VJView.tsx",lineNumber:636,columnNumber:7},void 0),e.jsxDEV("div",{className:"absolute inset-0 "+("isf"===l?"":"hidden"),children:e.jsxDEV(zr,{ref:a,onReady:e=>U(e),onPresetChange:(e,t)=>{B(e),P(t)}},void 0,!1,{fileName:"/Users/spot/Code/DEViLBOX/src/components/vj/VJView.tsx",lineNumber:645,columnNumber:9},void 0)},void 0,!1,{fileName:"/Users/spot/Code/DEViLBOX/src/components/vj/VJView.tsx",lineNumber:644,columnNumber:7},void 0),e.jsxDEV("div",{className:"absolute inset-0 "+("three"===l?"":"hidden"),children:e.jsxDEV(io,{ref:u,onReady:e=>L(e),onSceneChange:(e,t)=>{F(e),j(t)}},void 0,!1,{fileName:"/Users/spot/Code/DEViLBOX/src/components/vj/VJView.tsx",lineNumber:653,columnNumber:9},void 0)},void 0,!1,{fileName:"/Users/spot/Code/DEViLBOX/src/components/vj/VJView.tsx",lineNumber:652,columnNumber:7},void 0),e.jsxDEV("div",{className:"absolute inset-0 "+("projectm"===l?"":"hidden"),children:e.jsxDEV(s.Suspense,{fallback:e.jsxDEV("div",{className:"w-full h-full bg-black flex items-center justify-center",children:e.jsxDEV("span",{className:"text-white/50 font-mono text-sm",children:"Loading projectM..."},void 0,!1,{fileName:"/Users/spot/Code/DEViLBOX/src/components/vj/VJView.tsx",lineNumber:661,columnNumber:108},void 0)},void 0,!1,{fileName:"/Users/spot/Code/DEViLBOX/src/components/vj/VJView.tsx",lineNumber:661,columnNumber:35},void 0),children:e.jsxDEV(oo,{ref:c,onReady:e=>J(e),onPresetChange:(e,t)=>{G(e),H(t)}},void 0,!1,{fileName:"/Users/spot/Code/DEViLBOX/src/components/vj/VJView.tsx",lineNumber:662,columnNumber:11},void 0)},void 0,!1,{fileName:"/Users/spot/Code/DEViLBOX/src/components/vj/VJView.tsx",lineNumber:661,columnNumber:9},void 0)},void 0,!1,{fileName:"/Users/spot/Code/DEViLBOX/src/components/vj/VJView.tsx",lineNumber:660,columnNumber:7},void 0),e.jsxDEV("canvas",{ref:A,width:180,height:60,className:"absolute bottom-16 right-2 z-50 rounded",style:{imageRendering:"pixelated"}},void 0,!1,{fileName:"/Users/spot/Code/DEViLBOX/src/components/vj/VJView.tsx",lineNumber:670,columnNumber:7},void 0),e.jsxDEV(lo,{currentName:Y,currentIdx:$,totalPresets:q,autoAdvance:y,isPopout:t,activeLayer:l,onNext:te,onRandom:ne,onToggleAutoAdvance:()=>x(e=>!e),onPopOut:Q,onToggleBrowser:()=>E(e=>!e),onSwitchLayer:h,onFullscreen:_,isFullscreen:S,browserOpen:b},void 0,!1,{fileName:"/Users/spot/Code/DEViLBOX/src/components/vj/VJView.tsx",lineNumber:677,columnNumber:7},void 0),"milkdrop"===l&&e.jsxDEV(Te,{isOpen:b,onClose:()=>E(!1),onSelectPreset:ee,currentPresetIdx:d},void 0,!1,{fileName:"/Users/spot/Code/DEViLBOX/src/components/vj/VJView.tsx",lineNumber:695,columnNumber:9},void 0)]},void 0,!0,{fileName:"/Users/spot/Code/DEViLBOX/src/components/vj/VJView.tsx",lineNumber:634,columnNumber:5},void 0)},fo=Object.freeze(Object.defineProperty({__proto__:null,VJCanvas:co,VJControls:lo,VJView:ho},Symbol.toStringTag,{value:"Module"}));export{ge as A,ho as V,fo as a};
