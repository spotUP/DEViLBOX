import{aB as t}from"./index-zx6LJBPK.js";import"./vendor-react-DkDaD07v.js";import"./vendor-utils-XMmR-oGw.js";import"./vendor-tone-CADp_hfL.js";import"./vendor-ui-uomqNFY-.js";const n=new TextDecoder("iso-8859-1");function e(t,n){return t.length<n+4?"":String.fromCharCode(t[n],t[n+1],t[n+2],t[n+3])}function r(t,n){return 65535&(t[n]<<8|t[n+1])}function o(t,n){return(t[n]<<24|t[n+1]<<16|t[n+2]<<8|t[n+3])>>>0}function i(t,e,r){let o=e;for(;o<e+r&&0!==t[o];)o++;return n.decode(t.subarray(e,o)).trim()}function s(n,s,a,f){const c=new Uint8Array(n),u=s.split("/").pop()??s;let l=u.replace(/^(mm4|mm8|sdata)\./i,"")||u;const m=c.length>=12&&"FORM"===e(c,0)?function(t){const n=new Map;let r=12;const i=t.length;for(;r+8<=i;){const s=e(t,r),a=o(t,r+4),f=r+8;if(f+a>i)break;n.has(s)||n.set(s,{offset:f,size:a}),r=f+a,1&r&&r++}return n}(c):new Map,h=m.get("SDAT");if(h&&h.size>=26){const t=h.offset;if(21317===r(c,t+4)){const n=i(c,t+6,20);n.length>0&&(l=n)}}const p=m.get("INAM"),M=p?function(t,n){const e=new Map;if(n.size<4)return e;const o=r(t,n.offset),s=r(t,n.offset+2);if(0===o||s>=o)return e;const a=o-s,f=n.offset+4,c=Math.floor((n.size-4)/o);for(let r=0;r<c&&r<64;r++){const c=f+r*o;if(c+o>n.offset+n.size)break;const u=i(t,c+s,a);if(!u)continue;const l=u.lastIndexOf("/"),m=l>=0?u.slice(l+1):u;m.length>=2&&e.set(r,m)}return e}(c,p):new Map,d=[],g=m.get("PINS")??m.get("INST");if(g&&g.size>=8){const n=g.offset+g.size;let o=g.offset,i=26;o+8<=n&&"SEI1"===e(c,o)&&"XX"===function(t,n){return t.length<n+2?"":String.fromCharCode(t[n],t[n+1])}(c,o+4)&&(i=r(c,o+6),o+=8),i=Math.min(i,64);const s=o+8*i+4;if(s<=n){let e=s;for(let s=0;s<i;s++){const i=o+8*s;if(i+8>n)break;const a=r(c,i+0),f=r(c,i+2),u=r(c,i+4),l=r(c,i+6);if(0===a)continue;const m=e+a;if(m>n)break;const h=c.slice(e,m);e=m;const p=f>0&&l>0,g=p?u:0,w=p?u+2*l:h.length;d.push(t(s+1,M.get(s)??`Sample ${s+1}`,h,64,8363,g,w))}}}const w=Array.from({length:64},()=>({note:0,instrument:0,volume:0,effTyp:0,eff:0,effTyp2:0,eff2:0}));return{name:`${l} [${f}]`,format:"MOD",patterns:[{id:"pattern-0",name:"Pattern 0",length:64,channels:Array.from({length:a},(t,n)=>({id:`channel-${n}`,name:`Channel ${n+1}`,muted:!1,solo:!1,collapsed:!1,volume:100,pan:4===a?0===n||3===n?-50:50:Math.round(50*(n/(a-1)*2-1)),instrumentId:null,color:null,rows:w})),importMetadata:{sourceFormat:"MOD",sourceFile:s,importedAt:(new Date).toISOString(),originalChannelCount:a,originalPatternCount:1,originalInstrumentCount:d.length}}],instruments:d,songPositions:[0],songLength:1,restartPosition:0,numChannels:a,initialSpeed:6,initialBPM:125,linearPeriods:!1}}function a(t){return((t.split("/").pop()??t).split("\\").pop()??t).toLowerCase()}function f(t,n){const r=t instanceof Uint8Array?t:new Uint8Array(t),o=n?a(n):"";if(r.length>=12&&"FORM"===e(r,0)){const t=e(r,8);if("MMV4"===t)return!0;if("MMV8"===t&&o.endsWith(".mm4"))return!0}return!!n&&(o.startsWith("mm4.")||o.startsWith("sdata."))}function c(t,n){if(!f(t,n))throw new Error("Not a Music Maker 4V module");return s(t,n,4,"Music Maker 4V")}function u(t,n){const r=t instanceof Uint8Array?t:new Uint8Array(t),o=n?a(n):"";return r.length>=12&&"FORM"===e(r,0)&&"MMV8"===e(r,8)?!o.endsWith(".mm4"):!!n&&o.startsWith("mm8.")}function l(t,n){if(!u(t,n))throw new Error("Not a Music Maker 8V module");return s(t,n,8,"Music Maker 8V")}export{f as isMusicMaker4VFormat,u as isMusicMaker8VFormat,c as parseMusicMaker4VFile,l as parseMusicMaker8VFile};
