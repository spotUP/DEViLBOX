import{aU as t}from"./index-zx6LJBPK.js";import"./vendor-react-DkDaD07v.js";import"./vendor-utils-XMmR-oGw.js";import"./vendor-tone-CADp_hfL.js";import"./vendor-ui-uomqNFY-.js";const s=128,i=64,h=16;class e{A=0;F=0;B=0;C=0;D=0;E=0;H=0;L=0;IX=0;IY=0;A2=0;F2=0;B2=0;C2=0;D2=0;E2=0;H2=0;L2=0;I=0;R=0;SP=65535;PC=0;IFF2=!1;mem;constructor(t){this.mem=t}reset(t,s=65535){this.PC=65535&t,this.SP=65535&s,this.A=0,this.F=0,this.B=0,this.C=0,this.D=0,this.E=0,this.H=0,this.L=0,this.IX=0,this.IY=0,this.I=0,this.R=0,this.IFF2=!1}getA(){return this.A}getB(){return this.B}getC(){return this.C}getD(){return this.D}getE(){return this.E}getH(){return this.H}getL(){return this.L}getPC(){return this.PC}getSP(){return this.SP}getAF(){return this.A<<8|this.F}getBC(){return this.B<<8|this.C}getDE(){return this.D<<8|this.E}getHL(){return this.H<<8|this.L}getIX(){return this.IX}getIY(){return this.IY}setA(t){this.A=255&t}setF(t){this.F=255&t}setB(t){this.B=255&t}setC(t){this.C=255&t}setD(t){this.D=255&t}setE(t){this.E=255&t}setH(t){this.H=255&t}setL(t){this.L=255&t}setAF(t){this.A=t>>8&255,this.F=255&t}setBC(t){this.B=t>>8&255,this.C=255&t}setDE(t){this.D=t>>8&255,this.E=255&t}setHL(t){this.H=t>>8&255,this.L=255&t}setIX(t){this.IX=65535&t}setIY(t){this.IY=65535&t}setPC(t){this.PC=65535&t}setSP(t){this.SP=65535&t}rd(t){return 255&this.mem.read(65535&t)}wr(t,s){this.mem.write(65535&t,255&s)}rd16(t){return this.rd(t)|this.rd(t+1)<<8}wr16(t,s){this.wr(t,255&s),this.wr(t+1,s>>8&255)}fetch(){const t=this.rd(this.PC);return this.PC=this.PC+1&65535,t}fetch16(){return this.fetch()|this.fetch()<<8}signedByte(t){return t<128?t:t-256}push8(t){this.SP=this.SP-1&65535,this.wr(this.SP,255&t)}pop8(){const t=this.rd(this.SP);return this.SP=this.SP+1&65535,t}push16(t){this.push8(t>>8&255),this.push8(255&t)}pop16(){return this.pop8()|this.pop8()<<8}setFlags_NZ(t){this.F=1&this.F|(0===t?i:0)|t&s}setFlags_Add(t,e,r){const c=255&r,n=!!((t^~e)&(t^r)&128);this.F=c&s|(0===c?i:0)|(t^e^r)&h|(n?4:0)|(r>255?1:0)}setFlags_Sub(t,e,r){const c=255&r,n=!!((t^e)&(t^r)&128);this.F=c&s|(0===c?i:0)|(t^e^r)&h|(n?4:0)|2|(r<0||r>255?1:0)}setFlags_Logic(t,h){let e=t^t>>4;e^=e>>2,e^=e>>1,e=1&~e,this.F=t&s|(0===t?i:0)|h|(e?4:0)}getReg8(t){switch(t){case 0:return this.B;case 1:return this.C;case 2:return this.D;case 3:return this.E;case 4:return this.H;case 5:return this.L;case 6:return this.rd(this.H<<8|this.L);case 7:return this.A;default:return 0}}setReg8(t,s){const i=255&s;switch(t){case 0:this.B=i;break;case 1:this.C=i;break;case 2:this.D=i;break;case 3:this.E=i;break;case 4:this.H=i;break;case 5:this.L=i;break;case 6:this.wr(this.H<<8|this.L,i);break;case 7:this.A=i}}aluA(t,s){const i=this.A;switch(7&t){case 0:{const t=i+s;this.setFlags_Add(i,s,t),this.A=255&t;break}case 1:{const t=i+s+(1&this.F?1:0);this.setFlags_Add(i,s,t),this.A=255&t;break}case 2:{const t=i-s;this.setFlags_Sub(i,s,t),this.A=255&t;break}case 3:{const t=1&this.F?1:0,h=i-s-t;this.setFlags_Sub(i,s+t,h),this.A=255&h;break}case 4:this.A=i&s&255,this.setFlags_Logic(this.A,h);break;case 5:this.A=255&(i^s),this.setFlags_Logic(this.A,0);break;case 6:this.A=255&(i|s),this.setFlags_Logic(this.A,0);break;case 7:{const t=i-s;this.setFlags_Sub(i,s,t);break}}}addHL(t){const s=this.H<<8|this.L,i=s+t;this.F=196&this.F|(s^t^i)&h|(i>65535?1:0),this.H=i>>8&255,this.L=255&i}execCB(t){const i=7&t,e=this.getReg8(i);let r;switch(t>>3){case 0:return r=255&(e<<1|e>>7),this.setFlags_Logic(r,0),this.F=-2&this.F|e>>7,this.setReg8(i,r),6===i?15:8;case 1:return r=255&(e>>1|e<<7),this.setFlags_Logic(r,0),this.F=-2&this.F|1&e,this.setReg8(i,r),6===i?15:8;case 2:return r=255&(e<<1|(1&this.F?1:0)),this.setFlags_Logic(r,0),this.F=-2&this.F|e>>7,this.setReg8(i,r),6===i?15:8;case 3:return r=255&(e>>1|(1&this.F?1:0)<<7),this.setFlags_Logic(r,0),this.F=-2&this.F|1&e,this.setReg8(i,r),6===i?15:8;case 4:return r=e<<1&255,this.setFlags_Logic(r,0),this.F=-2&this.F|e>>7,this.setReg8(i,r),6===i?15:8;case 5:return r=255&(e>>1|128&e),this.setFlags_Logic(r,0),this.F=-2&this.F|1&e,this.setReg8(i,r),6===i?15:8;case 6:return r=e<<1&255|1,this.setFlags_Logic(r,0),this.F=-2&this.F|e>>7,this.setReg8(i,r),6===i?15:8;case 7:return r=e>>1&255,this.setFlags_Logic(r,0),this.F=-2&this.F|1&e,this.setReg8(i,r),6===i?15:8;default:{const r=t>>3&7,c=t>>6;if(1===c){const t=e&1<<r;return this.F=1&this.F|(0===t?68:0)|h|t&s,6===i?12:8}return 2===c?(this.setReg8(i,e&~(1<<r)),6===i?15:8):(this.setReg8(i,e|1<<r),6===i?15:8)}}}execED(t){switch(t){case 64:case 72:case 80:case 88:case 96:case 104:case 112:case 120:{const s=this.C|this.B<<8,i=this.mem.inPort?255&this.mem.inPort(s):255;this.setFlags_Logic(i,0);const h=t>>3&7;return 6!==h&&this.setReg8(h,i),12}case 65:case 73:case 81:case 89:case 97:case 105:case 113:case 121:{const s=this.C|this.B<<8,i=t>>3&7,h=6===i?0:this.getReg8(i);return this.mem.outPort&&this.mem.outPort(s,h),12}case 66:{const t=this.getBC(),s=this.H<<8|this.L,i=1&this.F?1:0,h=s-t-i;return this.setFlags_Sub(s,t+i,h),this.H=h>>8&255,this.L=255&h,15}case 82:{const t=this.getDE(),s=this.H<<8|this.L,i=1&this.F?1:0,h=s-t-i;return this.setFlags_Sub(s,t+i,h),this.H=h>>8&255,this.L=255&h,15}case 98:{const t=this.H<<8|this.L,s=1&this.F?1:0,i=t-t-s;return this.setFlags_Sub(t,t+s,i),this.H=i>>8&255,this.L=255&i,15}case 114:{const t=this.SP,s=this.H<<8|this.L,i=1&this.F?1:0,h=s-t-i;return this.setFlags_Sub(s,t+i,h),this.H=h>>8&255,this.L=255&h,15}case 74:{const t=this.getBC(),s=this.H<<8|this.L,i=s+t+(1&this.F?1:0);return this.setFlags_Add(s,t,i),this.H=i>>8&255,this.L=255&i,15}case 90:{const t=this.getDE(),s=this.H<<8|this.L,i=s+t+(1&this.F?1:0);return this.setFlags_Add(s,t,i),this.H=i>>8&255,this.L=255&i,15}case 106:{const t=this.H<<8|this.L,s=t+t+(1&this.F?1:0);return this.setFlags_Add(t,t,s),this.H=s>>8&255,this.L=255&s,15}case 122:{const t=this.SP,s=this.H<<8|this.L,i=s+t+(1&this.F?1:0);return this.setFlags_Add(s,t,i),this.H=i>>8&255,this.L=255&i,15}case 67:{const t=this.fetch16();return this.wr16(t,this.B<<8|this.C),20}case 75:{const t=this.fetch16(),s=this.rd16(t);return this.B=s>>8&255,this.C=255&s,20}case 83:{const t=this.fetch16();return this.wr16(t,this.D<<8|this.E),20}case 91:{const t=this.fetch16(),s=this.rd16(t);return this.D=s>>8&255,this.E=255&s,20}case 99:{const t=this.fetch16();return this.wr16(t,this.H<<8|this.L),20}case 107:{const t=this.fetch16(),s=this.rd16(t);return this.H=s>>8&255,this.L=255&s,20}case 115:{const t=this.fetch16();return this.wr16(t,this.SP),20}case 123:{const t=this.fetch16();return this.SP=this.rd16(t),20}case 71:return this.I=this.A,9;case 79:return this.R=this.A,9;case 87:return this.A=this.I,this.setFlags_NZ(this.A),this.IFF2?this.F|=4:this.F&=-5,9;case 95:return this.A=255&this.R,this.setFlags_NZ(this.A),this.IFF2?this.F|=4:this.F&=-5,9;case 68:case 76:case 84:case 92:case 100:case 108:case 116:case 124:{const t=this.A,s=0-t;return this.setFlags_Sub(0,t,s),this.A=255&s,8}case 69:case 85:case 101:case 117:case 77:case 93:case 109:case 125:return this.PC=this.pop16(),14;case 111:{const t=this.H<<8|this.L,s=this.rd(t),i=255&(s<<4|15&this.A);return this.A=240&this.A|s>>4,this.wr(t,i),this.setFlags_Logic(this.A,0),18}case 103:{const t=this.H<<8|this.L,s=this.rd(t),i=255&(this.A<<4|s>>4);return this.A=240&this.A|15&s,this.wr(t,i),this.setFlags_Logic(this.A,0),18}case 176:{let t=0;for(;;){const s=this.H<<8|this.L,i=this.D<<8|this.E,h=this.B<<8|this.C;this.wr(i,this.rd(s));const e=s+1&65535,r=i+1&65535,c=h-1&65535;if(this.H=e>>8&255,this.L=255&e,this.D=r>>8&255,this.E=255&r,this.B=c>>8&255,this.C=255&c,t+=21,0===c)break}return this.F&=-23,t}case 184:{let t=0;for(;;){const s=this.H<<8|this.L,i=this.D<<8|this.E,h=this.B<<8|this.C;this.wr(i,this.rd(s));const e=s-1&65535,r=i-1&65535,c=h-1&65535;if(this.H=e>>8&255,this.L=255&e,this.D=r>>8&255,this.E=255&r,this.B=c>>8&255,this.C=255&c,t+=21,0===c)break}return this.F&=-23,t}case 177:{let t=0;for(;;){const s=this.H<<8|this.L,i=this.B<<8|this.C,h=this.rd(s),e=this.A-h,r=s+1&65535,c=i-1&65535;if(this.H=r>>8&255,this.L=255&r,this.B=c>>8&255,this.C=255&c,t+=21,!(255&e)||0===c)break}return t}case 185:{let t=0;for(;;){const s=this.H<<8|this.L,i=this.B<<8|this.C,h=this.rd(s),e=this.A-h,r=s-1&65535,c=i-1&65535;if(this.H=r>>8&255,this.L=255&r,this.B=c>>8&255,this.C=255&c,t+=21,!(255&e)||0===c)break}return t}case 178:case 186:case 179:case 187:return 21;default:return 8}}execDDFD(t){const i=221===t,e=()=>i?this.IX:this.IY,r=t=>{i?this.IX=65535&t:this.IY=65535&t},c=this.fetch();if(33===c)return r(this.fetch16()),14;if(34===c){const t=this.fetch16();return this.wr16(t,e()),20}if(42===c){const t=this.fetch16();return r(this.rd16(t)),20}if(249===c)return this.SP=e(),10;if(229===c)return this.push16(e()),15;if(225===c)return r(this.pop16()),14;if(227===c){const t=this.rd16(this.SP);return this.wr16(this.SP,e()),r(t),23}if(233===c)return this.PC=e(),8;if(35===c)return r(e()+1&65535),10;if(43===c)return r(e()-1&65535),10;if(9===c){const t=e()+(this.B<<8|this.C);return this.F=196&this.F|(t>65535?1:0),r(65535&t),15}if(25===c){const t=e()+(this.D<<8|this.E);return this.F=196&this.F|(t>65535?1:0),r(65535&t),15}if(41===c){const t=e()+e();return this.F=196&this.F|(t>65535?1:0),r(65535&t),15}if(57===c){const t=e()+this.SP;return this.F=196&this.F|(t>65535?1:0),r(65535&t),15}if(52===c){const t=this.signedByte(this.fetch()),s=e()+t&65535,i=this.rd(s)+1&255;return this.wr(s,i),this.setFlags_NZ(i),23}if(53===c){const t=this.signedByte(this.fetch()),s=e()+t&65535,i=this.rd(s)-1&255;return this.wr(s,i),this.setFlags_NZ(i),23}if(54===c){const t=this.signedByte(this.fetch()),s=this.fetch();return this.wr(e()+t&65535,s),19}if(70==(199&c)&&c>>3!=6){const t=c>>3&7,s=this.signedByte(this.fetch()),i=this.rd(e()+s&65535);return this.setReg8(t,i),19}if(112==(248&c)&&118!==c){const t=7&c,s=this.signedByte(this.fetch());return this.wr(e()+s&65535,this.getReg8(t)),19}if(134==(199&c)){const t=this.signedByte(this.fetch()),s=this.rd(e()+t&65535);return this.aluA(c>>3,s),19}if(203===c){const t=this.signedByte(this.fetch()),i=this.fetch(),r=e()+t&65535,c=this.rd(r),n=7&i,a=i>>3&7,u=i>>6;if(1===u){const t=c&1<<a;return this.F=1&this.F|(0===t?68:0)|h|t&s,20}if(2===u){const t=c&~(1<<a);return this.wr(r,t),6!==n&&this.setReg8(n,t),23}if(3===u){const t=c|1<<a;return this.wr(r,t),6!==n&&this.setReg8(n,t),23}{const t=this.H,s=this.L;this.H=r>>8&255,this.L=255&r;const h=this.execCB(6|i);return 6!==n&&this.setReg8(n,this.rd(r)),this.H=t,this.L=s,h+8}}return 8}step(){const t=this.fetch();switch(t){case 0:case 118:case 64:case 73:case 82:case 91:case 100:case 109:case 127:default:return 4;case 6:return this.B=this.fetch(),7;case 14:return this.C=this.fetch(),7;case 22:return this.D=this.fetch(),7;case 30:return this.E=this.fetch(),7;case 38:return this.H=this.fetch(),7;case 46:return this.L=this.fetch(),7;case 62:return this.A=this.fetch(),7;case 1:{const t=this.fetch16();return this.B=t>>8&255,this.C=255&t,10}case 17:{const t=this.fetch16();return this.D=t>>8&255,this.E=255&t,10}case 33:{const t=this.fetch16();return this.H=t>>8&255,this.L=255&t,10}case 49:return this.SP=this.fetch16(),10;case 42:{const t=this.fetch16(),s=this.rd16(t);return this.H=s>>8&255,this.L=255&s,16}case 34:{const t=this.fetch16();return this.wr16(t,this.H<<8|this.L),16}case 10:return this.A=this.rd(this.B<<8|this.C),7;case 26:return this.A=this.rd(this.D<<8|this.E),7;case 58:return this.A=this.rd(this.fetch16()),13;case 2:return this.wr(this.B<<8|this.C,this.A),7;case 18:return this.wr(this.D<<8|this.E,this.A),7;case 50:return this.wr(this.fetch16(),this.A),13;case 249:return this.SP=this.H<<8|this.L,6;case 65:return this.B=this.C,4;case 66:return this.B=this.D,4;case 67:return this.B=this.E,4;case 68:return this.B=this.H,4;case 69:return this.B=this.L,4;case 70:return this.B=this.rd(this.H<<8|this.L),7;case 71:return this.B=this.A,4;case 72:return this.C=this.B,4;case 74:return this.C=this.D,4;case 75:return this.C=this.E,4;case 76:return this.C=this.H,4;case 77:return this.C=this.L,4;case 78:return this.C=this.rd(this.H<<8|this.L),7;case 79:return this.C=this.A,4;case 80:return this.D=this.B,4;case 81:return this.D=this.C,4;case 83:return this.D=this.E,4;case 84:return this.D=this.H,4;case 85:return this.D=this.L,4;case 86:return this.D=this.rd(this.H<<8|this.L),7;case 87:return this.D=this.A,4;case 88:return this.E=this.B,4;case 89:return this.E=this.C,4;case 90:return this.E=this.D,4;case 92:return this.E=this.H,4;case 93:return this.E=this.L,4;case 94:return this.E=this.rd(this.H<<8|this.L),7;case 95:return this.E=this.A,4;case 96:return this.H=this.B,4;case 97:return this.H=this.C,4;case 98:return this.H=this.D,4;case 99:return this.H=this.E,4;case 101:return this.H=this.L,4;case 102:return this.H=this.rd(this.H<<8|this.L),7;case 103:return this.H=this.A,4;case 104:return this.L=this.B,4;case 105:return this.L=this.C,4;case 106:return this.L=this.D,4;case 107:return this.L=this.E,4;case 108:return this.L=this.H,4;case 110:return this.L=this.rd(this.H<<8|this.L),7;case 111:return this.L=this.A,4;case 112:return this.wr(this.H<<8|this.L,this.B),7;case 113:return this.wr(this.H<<8|this.L,this.C),7;case 114:return this.wr(this.H<<8|this.L,this.D),7;case 115:return this.wr(this.H<<8|this.L,this.E),7;case 116:return this.wr(this.H<<8|this.L,this.H),7;case 117:return this.wr(this.H<<8|this.L,this.L),7;case 119:return this.wr(this.H<<8|this.L,this.A),7;case 120:return this.A=this.B,4;case 121:return this.A=this.C,4;case 122:return this.A=this.D,4;case 123:return this.A=this.E,4;case 124:return this.A=this.H,4;case 125:return this.A=this.L,4;case 126:return this.A=this.rd(this.H<<8|this.L),7;case 128:case 129:case 130:case 131:case 132:case 133:case 135:case 136:case 137:case 138:case 139:case 140:case 141:case 143:case 144:case 145:case 146:case 147:case 148:case 149:case 151:case 152:case 153:case 154:case 155:case 156:case 157:case 159:case 160:case 161:case 162:case 163:case 164:case 165:case 167:case 168:case 169:case 170:case 171:case 172:case 173:case 175:case 176:case 177:case 178:case 179:case 180:case 181:case 183:case 184:case 185:case 186:case 187:case 188:case 189:case 191:return this.aluA(t>>3,this.getReg8(7&t)),6==(7&t)?7:4;case 134:case 142:case 150:case 158:case 166:case 174:case 182:case 190:return this.aluA(t>>3,this.rd(this.H<<8|this.L)),7;case 198:return this.aluA(0,this.fetch()),7;case 206:return this.aluA(1,this.fetch()),7;case 214:return this.aluA(2,this.fetch()),7;case 222:return this.aluA(3,this.fetch()),7;case 230:return this.aluA(4,this.fetch()),7;case 238:return this.aluA(5,this.fetch()),7;case 246:return this.aluA(6,this.fetch()),7;case 254:return this.aluA(7,this.fetch()),7;case 4:{const t=this.B+1&255;return this.B=t,this.setFlags_NZ(t),4}case 12:{const t=this.C+1&255;return this.C=t,this.setFlags_NZ(t),4}case 20:{const t=this.D+1&255;return this.D=t,this.setFlags_NZ(t),4}case 28:{const t=this.E+1&255;return this.E=t,this.setFlags_NZ(t),4}case 36:{const t=this.H+1&255;return this.H=t,this.setFlags_NZ(t),4}case 44:{const t=this.L+1&255;return this.L=t,this.setFlags_NZ(t),4}case 52:{const t=this.H<<8|this.L,s=this.rd(t)+1&255;return this.wr(t,s),this.setFlags_NZ(s),11}case 60:{const t=this.A+1&255;return this.A=t,this.setFlags_NZ(t),4}case 5:{const t=this.B-1&255;return this.B=t,this.setFlags_NZ(t),this.F|=2,4}case 13:{const t=this.C-1&255;return this.C=t,this.setFlags_NZ(t),this.F|=2,4}case 21:{const t=this.D-1&255;return this.D=t,this.setFlags_NZ(t),this.F|=2,4}case 29:{const t=this.E-1&255;return this.E=t,this.setFlags_NZ(t),this.F|=2,4}case 37:{const t=this.H-1&255;return this.H=t,this.setFlags_NZ(t),this.F|=2,4}case 45:{const t=this.L-1&255;return this.L=t,this.setFlags_NZ(t),this.F|=2,4}case 53:{const t=this.H<<8|this.L,s=this.rd(t)-1&255;return this.wr(t,s),this.setFlags_NZ(s),this.F|=2,11}case 61:{const t=this.A-1&255;return this.A=t,this.setFlags_NZ(t),this.F|=2,4}case 3:{const t=1+(this.B<<8|this.C);return this.B=t>>8&255,this.C=255&t,6}case 19:{const t=1+(this.D<<8|this.E);return this.D=t>>8&255,this.E=255&t,6}case 35:{const t=1+(this.H<<8|this.L);return this.H=t>>8&255,this.L=255&t,6}case 51:return this.SP=this.SP+1&65535,6;case 11:{const t=(this.B<<8|this.C)-1;return this.B=t>>8&255,this.C=255&t,6}case 27:{const t=(this.D<<8|this.E)-1;return this.D=t>>8&255,this.E=255&t,6}case 43:{const t=(this.H<<8|this.L)-1;return this.H=t>>8&255,this.L=255&t,6}case 59:return this.SP=this.SP-1&65535,6;case 9:return this.addHL(this.B<<8|this.C),11;case 25:return this.addHL(this.D<<8|this.E),11;case 41:return this.addHL(this.H<<8|this.L),11;case 57:return this.addHL(this.SP),11;case 7:{const t=this.A>>7&1;return this.A=255&(this.A<<1|t),this.F=196&this.F|t,4}case 15:{const t=1&this.A;return this.A=255&(this.A>>1|t<<7),this.F=196&this.F|t,4}case 23:{const t=1&this.F,s=this.A>>7&1;return this.A=255&(this.A<<1|t),this.F=196&this.F|s,4}case 31:{const t=(1&this.F)<<7,s=1&this.A;return this.A=255&(this.A>>1|t),this.F=196&this.F|s,4}case 39:{let t=this.A;const s=!!(2&this.F),i=!!(1&this.F),e=0!==(this.F&h);return s?((e||(15&t)>9)&&(t-=6),(i||this.A>153)&&(t-=96)):((e||(15&t)>9)&&(t+=6),(i||t>153)&&(t+=96,this.F|=1)),this.A=255&t,this.setFlags_NZ(this.A),4}case 47:return this.A^=255,this.F|=18,4;case 55:return this.F=196&this.F|1,4;case 63:{const t=1&this.F;return this.F=196&this.F|(t?h:0)|(t?0:1),4}case 197:return this.push16(this.B<<8|this.C),11;case 213:return this.push16(this.D<<8|this.E),11;case 229:return this.push16(this.H<<8|this.L),11;case 245:return this.push16(this.A<<8|this.F),11;case 193:{const t=this.pop16();return this.B=t>>8&255,this.C=255&t,10}case 209:{const t=this.pop16();return this.D=t>>8&255,this.E=255&t,10}case 225:{const t=this.pop16();return this.H=t>>8&255,this.L=255&t,10}case 241:{const t=this.pop16();return this.A=t>>8&255,this.F=255&t,10}case 8:{const t=this.A,s=this.F;return this.A=this.A2,this.F=this.F2,this.A2=t,this.F2=s,4}case 217:{let t;return t=this.B,this.B=this.B2,this.B2=t,t=this.C,this.C=this.C2,this.C2=t,t=this.D,this.D=this.D2,this.D2=t,t=this.E,this.E=this.E2,this.E2=t,t=this.H,this.H=this.H2,this.H2=t,t=this.L,this.L=this.L2,this.L2=t,4}case 235:{const t=this.D,s=this.E;return this.D=this.H,this.E=this.L,this.H=t,this.L=s,4}case 227:{const t=this.rd(this.SP),s=this.rd(this.SP+1&65535);return this.wr(this.SP,this.L),this.wr(this.SP+1&65535,this.H),this.H=s,this.L=t,19}case 195:return this.PC=this.fetch16(),10;case 194:{const t=this.fetch16();return this.F&i||(this.PC=t),10}case 202:{const t=this.fetch16();return this.F&i&&(this.PC=t),10}case 210:{const t=this.fetch16();return 1&this.F||(this.PC=t),10}case 218:{const t=this.fetch16();return 1&this.F&&(this.PC=t),10}case 226:{const t=this.fetch16();return 4&this.F||(this.PC=t),10}case 234:{const t=this.fetch16();return 4&this.F&&(this.PC=t),10}case 242:{const t=this.fetch16();return this.F&s||(this.PC=t),10}case 250:{const t=this.fetch16();return this.F&s&&(this.PC=t),10}case 233:return this.PC=this.H<<8|this.L,4;case 24:{const t=this.signedByte(this.fetch());return this.PC=this.PC+t&65535,12}case 32:{const t=this.signedByte(this.fetch());return this.F&i||(this.PC=this.PC+t&65535),7}case 40:{const t=this.signedByte(this.fetch());return this.F&i&&(this.PC=this.PC+t&65535),7}case 48:{const t=this.signedByte(this.fetch());return 1&this.F||(this.PC=this.PC+t&65535),7}case 56:{const t=this.signedByte(this.fetch());return 1&this.F&&(this.PC=this.PC+t&65535),7}case 16:{const t=this.signedByte(this.fetch());return this.B=this.B-1&255,0!==this.B?(this.PC=this.PC+t&65535,13):8}case 205:{const t=this.fetch16();return this.push16(this.PC),this.PC=t,17}case 196:{const t=this.fetch16();return this.F&i?10:(this.push16(this.PC),this.PC=t,17)}case 204:{const t=this.fetch16();return this.F&i?(this.push16(this.PC),this.PC=t,17):10}case 212:{const t=this.fetch16();return 1&this.F?10:(this.push16(this.PC),this.PC=t,17)}case 220:{const t=this.fetch16();return 1&this.F?(this.push16(this.PC),this.PC=t,17):10}case 228:{const t=this.fetch16();return 4&this.F?10:(this.push16(this.PC),this.PC=t,17)}case 236:{const t=this.fetch16();return 4&this.F?(this.push16(this.PC),this.PC=t,17):10}case 244:{const t=this.fetch16();return this.F&s?10:(this.push16(this.PC),this.PC=t,17)}case 252:{const t=this.fetch16();return this.F&s?(this.push16(this.PC),this.PC=t,17):10}case 201:return this.PC=this.pop16(),10;case 192:return this.F&i?5:(this.PC=this.pop16(),11);case 200:return this.F&i?(this.PC=this.pop16(),11):5;case 208:return 1&this.F?5:(this.PC=this.pop16(),11);case 216:return 1&this.F?(this.PC=this.pop16(),11):5;case 224:return 4&this.F?5:(this.PC=this.pop16(),11);case 232:return 4&this.F?(this.PC=this.pop16(),11):5;case 240:return this.F&s?5:(this.PC=this.pop16(),11);case 248:return this.F&s?(this.PC=this.pop16(),11):5;case 199:return this.push16(this.PC),this.PC=0,11;case 207:return this.push16(this.PC),this.PC=8,11;case 215:return this.push16(this.PC),this.PC=16,11;case 223:return this.push16(this.PC),this.PC=24,11;case 231:return this.push16(this.PC),this.PC=32,11;case 239:return this.push16(this.PC),this.PC=40,11;case 247:return this.push16(this.PC),this.PC=48,11;case 255:return this.push16(this.PC),this.PC=56,11;case 219:{const t=this.fetch();return this.A=this.mem.inPort?255&this.mem.inPort(t):255,11}case 211:{const t=this.fetch();return this.mem.outPort&&this.mem.outPort(t,this.A),11}case 251:return this.IFF2=!0,4;case 243:return this.IFF2=!1,4;case 203:return this.execCB(this.fetch());case 237:return this.execED(this.fetch());case 221:return this.execDDFD(221);case 253:return this.execDDFD(253)}}callSubroutine(t,s=2e5){const i=this.SP;this.push16(65535),this.PC=65535&t;let h=0;for(;h<s&&(h+=this.step(),!(this.SP>=i)););}}function r(){return{note:0,instrument:0,volume:0,effTyp:0,eff:0,effTyp2:0,eff2:0}}function c(t,s){if(s+2>t.length)return"";const i=new DataView(t.buffer,t.byteOffset,t.byteLength).getInt16(s,!1);if(0===i)return"";const h=s+i;if(h<0||h>=t.length)return"";let e="",r=h;for(;r<t.length&&0!==t[r];)e+=String.fromCharCode(t[r++]);return e.trim()}function n(t){if(t<=0)return 0;const s=1773400/(16*t);if(s<20||s>2e4)return 0;const i=Math.round(12*Math.log2(s/440)+69);return i>=1&&i<=96?i:0}function a(t){const s=new Uint8Array(t);return!(s.length<8)&&"ZXAYEMUL"===String.fromCharCode(s[0],s[1],s[2],s[3],s[4],s[5],s[6],s[7])}async function u(s,i){if(!a(s))throw new Error("Not a valid AY file");const h=new Uint8Array(s),u=1===h[8],o=(h[18]??0)+1,F=c(h,14),f=c(h,16),g=u?"YM":"AY",l=Array.from({length:3},(s,i)=>({id:i+1,name:`${g} ${String.fromCharCode(65+i)}`,type:"synth",synthType:"FurnaceAY",furnace:{...t,chipType:6,ops:2},effects:[],volume:0,pan:0})),d=f||i.replace(/\.ay$/i,"");let C;try{const t=function(t,s){const i=new DataView(t.buffer,t.byteOffset,t.byteLength),h=s+2+i.getInt16(s+2,!1);if(h<0||h+10>t.length)throw new Error(`AY song data block out of range: dataOff=${h}`);const e=i.getUint16(h+2,!1),r=i.getUint16(h+4,!1),c=i.getUint16(h+6,!1);let n=h+10;const a=[];for(;n+4<=t.length;){const s=i.getUint16(n,!1),h=i.getUint16(n+2,!1);if(0===s&&0===h)break;const e=0===h?65536:h;n+=4;const r=Math.min(n+e,t.length),c=t.slice(n,r);a.push({addr:s,data:c}),n+=e}return{initAddr:e,intrAddr:r,stackAddr:c,memBlocks:a}}(h,20);if(0===t.initAddr||0===t.intrAddr)throw new Error("AY init/interrupt address is zero — cannot emulate");if(0===t.memBlocks.length)throw new Error("AY file has no memory blocks");const s=function(t){const s=t.stackAddr>0&&t.stackAddr<=65535?t.stackAddr:61440,i=new Uint8Array(65536);for(const e of t.memBlocks){const t=Math.min(e.data.length,65536-e.addr);i.set(e.data.subarray(0,t),e.addr)}function h(s){return t.memBlocks.some(t=>s>=t.addr&&s<t.addr+t.data.length)}if(!h(t.initAddr)||!h(t.intrAddr))return[];const r=new Uint8Array(16);let c=0;const n=new e({read:t=>i[65535&t],write:(t,s)=>{i[65535&t]=255&s},outPort:(t,s)=>{const i=65535&t;65533===i?c=15&s:49149===i&&(r[c]=255&s)}});n.reset(t.initAddr,s),n.callSubroutine(t.initAddr);const a=[];for(let e=0;e<300;e++)n.callSubroutine(t.intrAddr),a.push(new Uint8Array(r));return a}(t);C=function(t){const s=Math.max(1,Math.ceil(t.length/256)),i=Math.min(256,Math.ceil(t.length/s)),h={id:"p0",name:"Pattern 1",length:i,channels:Array.from({length:3},(t,s)=>({id:`ch${s}`,name:`AY ${String.fromCharCode(65+s)}`,muted:!1,solo:!1,collapsed:!1,volume:100,pan:0,instrumentId:null,color:null,rows:Array.from({length:i},r)}))},e=[0,0,0],c=[-1,-1,-1];for(let r=0;r<i;r++){const i=t[Math.min(r*s,t.length-1)],a=i[7]??255;for(let t=0;t<3;t++){const s=i[2*t]??0,u=(15&(i[2*t+1]??0))<<8|s,o=15&(i[8+t]??0),F=!(a>>t&1)&&o>0&&u>0?n(u):0,f=h.channels[t].rows[r];F!==e[t]&&(f.note=F>0?F:e[t]>0?97:0,F>0&&(f.instrument=1),e[t]=F),o!==c[t]&&(f.volume=o>0?Math.round(o/15*64):0,c[t]=o)}}return h}(s)}catch{A=3,C={id:"p0",name:"Pattern 1",length:16,channels:Array.from({length:A},(t,s)=>({id:`ch${s}`,name:`AY ${String.fromCharCode(65+s)}`,muted:!1,solo:!1,collapsed:!1,volume:100,pan:0,instrumentId:null,color:null,rows:Array.from({length:16},r)}))}}var A;return{name:d+(F?` — ${F}`:""),format:"AY",patterns:[C],instruments:l,songPositions:[0],songLength:o>1?o:1,restartPosition:0,numChannels:3,initialSpeed:6,initialBPM:125}}export{a as isAYFormat,u as parseAYFile};
