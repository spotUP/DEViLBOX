# Delta Music 2.0

**Status:** NATIVE_SAMPLER — parser extracts PCM and synthesis waveform instruments
**Parser:** `src/lib/import/formats/DeltaMusic2Parser.ts`
**Extensions:** `dm2`, UADE eagleplayer
**Replayer source:** `docs/formats/Replayers/DeltaMusic/`
**Reference files:** `Reference Music/Delta Music/`

---

## Overview

Delta Music 2.0 is an Amiga synthesizer/tracker format. Unlike Delta Music 1.0 (magic
`ALL `) which has a traditional header layout, version 2.0 begins with 878 bytes of
embedded 68k player code followed by internal channel/global structures — the actual
song data doesn't start until offset 0xBC6 where the magic `.FNL` appears.

Key characteristics:
- **4 voices** with independent loop positions
- **PCM samples** (8-bit signed, with loop)
- **Synthesis waveforms** (256-byte waveforms, first is noise generated by the player)
- **Volume/vibrato tables** in 3-byte block format (increment, level, sustain)
- **Arpeggio tables** (16 bytes each, up to 64 tables)
- **Pitch bend** per instrument

---

## File Layout

```
Offset   Size        Description
-------  ----------  -----------
0x000    878 (0x36E) Embedded player code (68k machine code — skip for parsing)
0x36E    60 (0x3C)   Internal channel 1 structure (runtime state, not song data)
0x3AA    80 (0x50)   Internal channel 2 structure
0x3FA    80          Internal channel 3 structure
0x44A    80          Internal channel 4 structure
0x49A    80          Sound-effect channel 1 (copy of channel 1 for SFX)
0x4EA    80          Sound-effect channel 2
0x53A    80          Sound-effect channel 3
0x58A    78 (0x4E)   Sound-effect channel 4
0x5D8    170 (0xAA)  Period table (85 × 2-byte Amiga period values)
0x682    58 (0x3A)   Internal global variables
0xBC6    4           Magic: ".FNL" (0x2E 0x46 0x4E 0x4C)
0xBCA    1024 (0x400) Arpeggio tables (64 tables × 16 bytes each)
0xFCA    2           Track 1 loop position
0xFCC    2           Track 1 length in words (T1L)
0xFCE    2           Track 2 loop position
0xFD0    2           Track 2 length in words (T2L)
0xFD2    2           Track 3 loop position
0xFD4    2           Track 3 length in words (T3L)
0xFD6    2           Track 4 loop position
0xFD8    2           Track 4 length in words (T4L)
0xFDA    T1L         Track 1 data (pairs: block number + transpose)
         T2L         Track 2 data
         T3L         Track 3 data
         T4L         Track 4 data
         4           Block data length in bytes (BL)
         BL          Block data
         254 (0xFE)  Offset to instruments section (relative value?)
         2           Instrument data length (IL)
         IL          Instrument data
         4           Waveforms length (WL)
         WL          Waveform data (256 bytes each; first = noise waveform)
         64          Unknown (40 bytes + padding)
         32          Sample start offsets (8 samples × 4 bytes each)
         ?           Sample PCM data
```

---

## Track Data

Each track is a flat sequence of 2-byte pairs:

```
Byte 0: Block number (index into block data)
Byte 1: Transpose value (signed, added to all notes in this block)
```

Tracks end when the loop position is reached; the loop position specifies how many
bytes from the track start to rewind to.

---

## Block Data

Each block is 64 bytes = 16 rows × 4 bytes per row (single channel).

### Block Row Format (4 bytes)

```
Byte 0: AAAAAAAA — Note value (0 = rest; note + transpose = actual note)
Byte 1: BBBBBBBB — Instrument number (1-based; 0 = no change)
Byte 2: CCCCCCCC — Effect number
Byte 3: DDDDDDDD — Effect argument
```

---

## Instrument Data (variable; shared IL block)

Each instrument is approximately 88 bytes:

```
Offset  Size  Description
------  ----  -----------
0x00    2     Sample length in words (for PCM mode)
0x02    2     Loop start in words
0x04    2     Loop length in words (1 = no loop)
0x06    45    Volume table (15 × 3-byte blocks):
              Block: [increment/decrement (signed), level target, sustain ticks]
0x33    45    Vibrato table (15 × 3-byte blocks):
              Block: [increment/decrement, delay, sustain ticks]
0x60    2     Pitch bend value (signed, added to period each tick)
0x62    1     Is sample (0xFF = PCM sample, 0x00 = synthesis waveform)
0x63    1     Sample number (index into sample offsets table)
0x64    72    Arpeggio table / waveform synthesis table (48 bytes + 24 padding)
```

**Instrument type (offset 0x62):**
- `0xFF` → PCM sample instrument → use `'Sampler' as const`
- `0x00` → Synthesis waveform → base waveform is from the WL block, period-driven

---

## Sample PCM Extraction

8 sample slots. Each sample's start in the file is given by the 4-byte offset array
at `0x20 bytes before end of waveforms + start of samples`.

```typescript
// From DeltaMusic2Parser.ts constants:
const PAL_CLOCK = 3546895;
const REFERENCE_NOTE = 37;        // Amiga period 856 = middle A
const SYNTH_BASE_RATE = 2072;     // Hz for synthesis waveforms
const PCM_BASE_RATE = 8287;       // Hz for PCM sample instruments
```

PCM data is 8-bit signed big-endian (standard Amiga Paula format).

---

## Arpeggio Tables

64 tables × 16 bytes each, starting at 0xBCA. Each byte is an unsigned arpeggio
value. The instrument's arpeggio table field selects which table to use.

---

## Waveforms

Located in the WL block. Each waveform is 256 bytes of 8-bit signed PCM.
The first waveform (index 0) is a noise waveform generated by the player at startup
using a linear-feedback shift register — not stored in the file.

Synthesis instruments reference a waveform number for their base timbre.

---

## Reference Implementations

- **Replayer:** `docs/formats/Replayers/DeltaMusic/`
- **NostalgicPlayer spec:** `docs/formats/Delta Music 2.0.txt`
- **Parser source:** `src/lib/import/formats/DeltaMusic2Parser.ts` (fully implemented)

---

## Implementation Notes

**Current status:** NATIVE_SAMPLER — `DeltaMusic2Parser.ts` is fully implemented.

PCM instruments emit `'Sampler' as const` with `PCM_BASE_RATE = 8287 Hz`.
Synthesis instruments also emit `'Sampler' as const` with `SYNTH_BASE_RATE = 2072 Hz`,
using the waveform data as a looping PCM buffer (approximate synthesis).

For fully accurate synthesis, the volume/vibrato table 3-byte block format and pitch
bend would need a WASM engine rather than the static-waveform Sampler approximation.
